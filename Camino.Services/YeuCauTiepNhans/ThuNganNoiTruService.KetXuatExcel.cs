using System;
using System.Collections.Generic;
using System.Drawing;
using System.Drawing.Text;
using System.IO;
using System.Linq;
using System.Linq.Dynamic.Core;
using System.Text;
using System.Threading.Tasks;
using Camino.Core.Data;
using Camino.Core.DependencyInjection.Attributes;
using Camino.Core.Domain;
using Camino.Core.Domain.Entities.BenhNhans;
using Camino.Core.Domain.Entities.CongTyBaoHiemTuNhans;
using Camino.Core.Domain.Entities.DonThuocThanhToans;
using Camino.Core.Domain.Entities.ICDs;
using Camino.Core.Domain.Entities.Users;
using Camino.Core.Domain.Entities.YeuCauKhamBenhs;
using Camino.Core.Domain.Entities.YeuCauTiepNhans;
using Camino.Core.Domain.Entities.YeuCauTiepNhanTheBHYTs;
using Camino.Core.Domain.ValueObject;
using Camino.Core.Domain.ValueObject.CauHinh;
using Camino.Core.Domain.ValueObject.DanhSachBenhNhanChoThuNgan;
using Camino.Core.Domain.ValueObject.Grid;
using Camino.Core.Domain.ValueObject.YeuCauTiepNhans;
using Camino.Core.Helpers;
using Camino.Data;
using Camino.Services.BenhNhans;
using Camino.Services.CauHinh;
using Camino.Services.Helpers;
using Camino.Services.Localization;
using Microsoft.EntityFrameworkCore;
using Newtonsoft.Json;
using OfficeOpenXml;
using OfficeOpenXml.Style;
using static Camino.Core.Domain.Enums;

namespace Camino.Services.YeuCauTiepNhans
{
    [ScopedDependency(ServiceType = typeof(IThuNganNoiTruService))]
    public partial class ThuNganNoiTruService : YeuCauTiepNhanBaseService, IThuNganNoiTruService
    {

        #region Bảng kê chưa quyêt toán

        public byte[] XuatBangKeCoBHYTChuaQuyetToan(long yeuCauTiepNhanId)
        {
            var danhSachChiPhi = GetTatCaDichVuKhamChuaBenh(yeuCauTiepNhanId).Result.Where(o => !o.Soluong.AlmostEqual(0) && o.KhongTinhPhi != true && o.DuocHuongBHYT && o.MucHuongBaoHiem > 0).ToList();
            if (danhSachChiPhi.Count() == 0)
            {
                return null;
            }

            var yeuCauTiepNhan = BaseRepository.GetById(yeuCauTiepNhanId,
                x => x.Include(o => o.NoiTruBenhAn).ThenInclude(o => o.ChuyenDenBenhVien)
                    .Include(o => o.NoiTruBenhAn).ThenInclude(o => o.KhoaPhongNhapVien)
                    .Include(o => o.NoiTruBenhAn).ThenInclude(o => o.ChanDoanChinhRaVienICD)
                    .Include(o => o.YeuCauTiepNhanTheBHYTs)
                    .Include(o => o.YeuCauNhapVien).ThenInclude(o => o.YeuCauKhamBenh).ThenInclude(o => o.YeuCauTiepNhan)
                    .Include(o => o.BenhNhan)
                    .Include(o => o.PhuongXa)
                    .Include(o => o.QuanHuyen)
                    .Include(o => o.TinhThanh)
                    .Include(o => o.NoiTruBenhAn).ThenInclude(o => o.NoiTruPhieuDieuTris).ThenInclude(o => o.NoiTruThamKhamChanDoanKemTheos).ThenInclude(c => c.ICD)
                    .Include(o => o.NoiTruBenhAn).ThenInclude(o => o.NoiTruPhieuDieuTris).ThenInclude(c => c.ChanDoanChinhICD)
                    .Include(o => o.NoiChuyen).Include(o => o.NoiTruBenhAn).ThenInclude(o => o.NoiTruKhoaPhongDieuTris).ThenInclude(c => c.KhoaPhongChuyenDen));

            if (yeuCauTiepNhan == null)
                return null;

            var benhVien = new Core.Domain.Entities.BenhVien.BenhVien();

            string maBHYT = string.Empty;
            string bHYTTuNgay = string.Empty;
            string bHYTDenNgay = string.Empty;
            string mucHuong = string.Empty;
            string NoiDKKCBBanDau = string.Empty;
            string MaKCBBanDau = string.Empty;


            string maICDKemTheo = string.Empty;
            string tenICDKemTheo = string.Empty;


            string chuanDoanXacDinhSanKhoa = string.Empty;
            string maICD10 = string.Empty;

            if (yeuCauTiepNhan.NoiTruBenhAn != null && (yeuCauTiepNhan.NoiTruBenhAn.LoaiBenhAn == LoaiBenhAn.SanKhoaMo || yeuCauTiepNhan.NoiTruBenhAn.LoaiBenhAn == LoaiBenhAn.SanKhoaThuong))
            {
                if (yeuCauTiepNhan.NoiTruBenhAn?.NoiTruPhieuDieuTris.Count() > 0)
                {
                    var phieuDieuTri = yeuCauTiepNhan.NoiTruBenhAn?.NoiTruPhieuDieuTris.OrderByDescending(c => c.NgayDieuTri).FirstOrDefault();

                    var icdKemTheoIds = phieuDieuTri.NoiTruThamKhamChanDoanKemTheos.Select(c => c.ICD.Ma);
                    var tenICDKemTheos = phieuDieuTri.NoiTruThamKhamChanDoanKemTheos.Select(c => c.GhiChu);

                    maICDKemTheo = string.Join(", ", icdKemTheoIds);
                    tenICDKemTheo = string.Join(", ", tenICDKemTheos);


                    maICD10 = phieuDieuTri.ChanDoanChinhICD?.Ma;
                    chuanDoanXacDinhSanKhoa = phieuDieuTri.ChanDoanChinhGhiChu;
                }
            }
            else
            {
                if (!string.IsNullOrEmpty(yeuCauTiepNhan.NoiTruBenhAn?.DanhSachChanDoanKemTheoRaVienICDId))
                {
                    var maICDKemTheos = new List<string>();

                    var icdKemTheoIds = yeuCauTiepNhan.NoiTruBenhAn?.DanhSachChanDoanKemTheoRaVienICDId.Split(Constants.ICDSeparator);
                    var tenICDKemTheos = yeuCauTiepNhan.NoiTruBenhAn?.DanhSachChanDoanKemTheoRaVienGhiChu?.Split(Constants.ICDSeparator);

                    if (icdKemTheoIds.Length > 0)
                    {
                        foreach (var icdKemTheoId in icdKemTheoIds)
                        {
                            var icdKemTheo = _icdRepository.TableNoTracking.FirstOrDefault(o => o.Id == long.Parse(icdKemTheoId));
                            if (icdKemTheo != null)
                            {
                                maICDKemTheos.Add(icdKemTheo.Ma);
                            }
                        }
                    }

                    maICDKemTheo = string.Join(", ", maICDKemTheos);
                    tenICDKemTheo = string.Join(", ", tenICDKemTheos);
                }
            }

            YeuCauTiepNhanTheBHYT theBHYT = null;
            if (yeuCauTiepNhan.CoBHYT == true && yeuCauTiepNhan.YeuCauTiepNhanTheBHYTs.Any())
            {
                theBHYT = yeuCauTiepNhan.YeuCauTiepNhanTheBHYTs.First();
                if (!String.IsNullOrEmpty(theBHYT.MaDKBD))
                {
                    benhVien = _benhVienRepository.TableNoTracking.FirstOrDefault(p => p.Ma.Equals(theBHYT.MaDKBD));
                }
                maBHYT = theBHYT.MaSoThe;
                bHYTTuNgay = theBHYT.NgayHieuLuc.ApplyFormatDate();
                bHYTDenNgay = theBHYT.NgayHetHan?.ApplyFormatDate();
                mucHuong = theBHYT.MucHuong.ToString() + "%";
                NoiDKKCBBanDau = benhVien != null ? benhVien?.Ten : "Chưa xác định";
                MaKCBBanDau = theBHYT.MaDKBD;
            }
            else
            {
                maBHYT = "";
                bHYTTuNgay = "";
                bHYTDenNgay = "";
                mucHuong = "0%";
                NoiDKKCBBanDau = "Chưa xác định";
                MaKCBBanDau = "Chưa xác định";
            }

            var dsChiPhiBangKe = new List<BangKeKhamBenhCoBHYTVo>();
            var dateItemChiPhis = string.Empty;
            int indexItem = 1;


            using (var stream = new MemoryStream())
            {
                using (var xlPackage = new ExcelPackage(stream))
                {

                    var worksheet = xlPackage.Workbook.Worksheets.Add("BẢNG KÊ CHI PHÍ ĐIỀU TRỊ NỘI TRÚ 3");

                    // set row
                    worksheet.Row(9).Height = 24.5;
                    worksheet.DefaultRowHeight = 16;

                    //SET chiều rộng cho từng cột tương ứng
                    worksheet.Column(1).Width = 10;
                    worksheet.Column(2).Width = 25;
                    worksheet.Column(3).Width = 15;
                    worksheet.Column(4).Width = 15;
                    worksheet.Column(5).Width = 15;
                    worksheet.Column(6).Width = 15;
                    worksheet.Column(7).Width = 15;
                    worksheet.Column(8).Width = 15;
                    worksheet.Column(9).Width = 15;
                    worksheet.Column(10).Width = 15;
                    worksheet.Column(11).Width = 15;
                    worksheet.Column(12).Width = 15;
                    worksheet.Column(13).Width = 15;
                    worksheet.Column(14).Width = 15;

                    worksheet.DefaultColWidth = 7;

                    using (var range = worksheet.Cells["A1:C1"])
                    {
                        range.Worksheet.Cells["A1:C1"].Merge = true;
                        range.Worksheet.Cells["A1:C1"].Value = "CƠ SỞ KHÁM CHỮA BỆNH : BỆNH VIỆN ĐKQT BẮC HÀ";
                        range.Worksheet.Cells["A1:C1"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A1:C1"].Style.VerticalAlignment = ExcelVerticalAlignment.Bottom;
                        range.Worksheet.Cells["A1:C1"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A1:C1"].Style.Font.Color.SetColor(Color.Black);
                    }


                    var khoaPhong = yeuCauTiepNhan.NoiTruBenhAn?.NoiTruKhoaPhongDieuTris.OrderByDescending(c => c.ThoiDiemVaoKhoa).Select(c => c.KhoaPhongChuyenDen).FirstOrDefault();
                    var chuyenKhoa = GetChuyenKhoa(khoaPhong?.Id); //BVHD-3792 

                    using (var range = worksheet.Cells["A2:C2"])
                    {
                        range.Worksheet.Cells["A2:C2"].Merge = true;
                        range.Worksheet.Cells["A2:C2"].Value = "Khoa: " + khoaPhong?.Ten;
                        range.Worksheet.Cells["A2:C2"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A2:C2"].Style.VerticalAlignment = ExcelVerticalAlignment.Bottom;
                        range.Worksheet.Cells["A2:C2"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A2:C2"].Style.Font.Color.SetColor(Color.Black);
                        range.Worksheet.Cells["A2:C2"].Style.Font.Bold = true;
                    }

                    using (var range = worksheet.Cells["A3:C3"])
                    {
                        range.Worksheet.Cells["A3:C3"].Merge = true;
                        range.Worksheet.Cells["A3:C3"].Value = "Mã khoa: " + chuyenKhoa?.Ma;
                        range.Worksheet.Cells["A3:C3"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A3:C3"].Style.VerticalAlignment = ExcelVerticalAlignment.Bottom;
                        range.Worksheet.Cells["A3:C3"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A3:C3"].Style.Font.Color.SetColor(Color.Black);
                        range.Worksheet.Cells["A3:C3"].Style.Font.Bold = true;
                    }

                    using (var range = worksheet.Cells["L1:N1"])
                    {
                        range.Worksheet.Cells["L1:N1"].Merge = true;
                        range.Worksheet.Cells["L1:N1"].Value = "Mẫu số : 01/KBCB ";
                        range.Worksheet.Cells["L1:N1"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                        range.Worksheet.Cells["L1:N1"].Style.VerticalAlignment = ExcelVerticalAlignment.Bottom;
                        range.Worksheet.Cells["L1:N1"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["L1:N1"].Style.Font.Color.SetColor(Color.Black);
                        range.Worksheet.Cells["L1:N1"].Style.Font.Bold = true;
                    }

                    using (var range = worksheet.Cells["L2:N2"])
                    {
                        range.Worksheet.Cells["L2:N2"].Merge = true;
                        range.Worksheet.Cells["L2:N2"].Value = "Mã số người bệnh: " + yeuCauTiepNhan.BenhNhan.MaBN;
                        range.Worksheet.Cells["L2:N2"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                        range.Worksheet.Cells["L2:N2"].Style.VerticalAlignment = ExcelVerticalAlignment.Bottom;
                        range.Worksheet.Cells["L2:N2"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["L2:N2"].Style.Font.Color.SetColor(Color.Black);
                        range.Worksheet.Cells["L2:N2"].Style.Font.Bold = true;
                    }

                    using (var range = worksheet.Cells["L3:N3"])
                    {
                        range.Worksheet.Cells["L3:N3"].Merge = true;
                        range.Worksheet.Cells["L3:N3"].Value = "Số khám bệnh:" + yeuCauTiepNhan.MaYeuCauTiepNhan;
                        range.Worksheet.Cells["L3:N3"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                        range.Worksheet.Cells["L3:N3"].Style.VerticalAlignment = ExcelVerticalAlignment.Bottom;
                        range.Worksheet.Cells["L3:N3"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["L3:N3"].Style.Font.Color.SetColor(Color.Black);
                        range.Worksheet.Cells["L3:N3"].Style.Font.Bold = true;
                    }

                    using (var range = worksheet.Cells["L4:N4"])
                    {
                        range.Worksheet.Cells["L4:N4"].Merge = true;
                        range.Worksheet.Cells["L4:N4"].Value = "Số bệnh án: " + yeuCauTiepNhan.NoiTruBenhAn?.SoBenhAn;
                        range.Worksheet.Cells["L4:N4"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                        range.Worksheet.Cells["L4:N4"].Style.VerticalAlignment = ExcelVerticalAlignment.Bottom;
                        range.Worksheet.Cells["L4:N4"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["L4:N4"].Style.Font.Color.SetColor(Color.Black);
                        range.Worksheet.Cells["L4:N4"].Style.Font.Bold = true;
                    }

                    using (var range = worksheet.Cells["A5:N6"])
                    {
                        range.Worksheet.Cells["A5:N6"].Merge = true;
                        range.Worksheet.Cells["A5:N6"].Value = "BẢNG KÊ CHI PHÍ ĐIỀU TRỊ NỘI TRÚ 3";
                        range.Worksheet.Cells["A5:N6"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        range.Worksheet.Cells["A5:N6"].Style.VerticalAlignment = ExcelVerticalAlignment.Bottom;
                        range.Worksheet.Cells["A5:N6"].Style.Font.SetFromFont(new Font("Times New Roman", 18));
                        range.Worksheet.Cells["A5:N6"].Style.Font.Color.SetColor(Color.Black);
                        range.Worksheet.Cells["A5:N6"].Style.Font.Bold = true;
                    }

                    using (var range = worksheet.Cells["A7:N7"])
                    {
                        range.Worksheet.Cells["A7:N7"].Merge = true;
                        range.Worksheet.Cells["A7:N7"].Value = "I.Hành chính";
                        range.Worksheet.Cells["A7:N7"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A7:N7"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A7:N7"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A7:N7"].Style.Font.Color.SetColor(Color.Black);
                        range.Worksheet.Cells["A7:N7"].Style.Font.Bold = true;
                    }

                    using (var range = worksheet.Cells["A8:F8"])
                    {
                        range.Worksheet.Cells["A8:F8"].Merge = true;

                        range.Worksheet.Cells["A8:F8"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["A8:F8"].RichText.Add("(1) Họ tên người bệnh: ");
                        var value = range.Worksheet.Cells["A8:F8"].RichText.Add(yeuCauTiepNhan.HoTen);
                        value.Bold = true;

                        range.Worksheet.Cells["A8:F8"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A8:F8"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A8:F8"].Style.Font.SetFromFont(new Font("Times New Roman", 11));


                        range.Worksheet.Cells["A8:F8"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["G8:J8"])
                    {
                        range.Worksheet.Cells["G8:J8"].Merge = true;
                        range.Worksheet.Cells["G8:J8"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["G8:J8"].RichText.Add("Ngày,tháng,năm sinh: ");
                        var value = range.Worksheet.Cells["G8:J8"].RichText.Add(DateHelper.DOBFormat(yeuCauTiepNhan.NgaySinh, yeuCauTiepNhan.ThangSinh, yeuCauTiepNhan.NamSinh));
                        value.Bold = true;

                        range.Worksheet.Cells["G8:J8"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["G8:J8"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["G8:J8"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["G8:J8"].Style.Font.Color.SetColor(Color.Black);
                    }

                    var gioitinh = yeuCauTiepNhan.GioiTinh != null ? yeuCauTiepNhan.GioiTinh.GetDescription() : "";
                    using (var range = worksheet.Cells["K8:N8"])
                    {
                        range.Worksheet.Cells["K8:N8"].Merge = true;

                        range.Worksheet.Cells["K8:N8"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["K8:N8"].RichText.Add("Giới tính: ");
                        var value = range.Worksheet.Cells["K8:N8"].RichText.Add(gioitinh);
                        value.Bold = true;

                        range.Worksheet.Cells["K8:N8"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["K8:N8"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["K8:N8"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["K8:N8"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["A9:F9"])
                    {
                        range.Worksheet.Cells["A9:F9"].Merge = true;

                        range.Worksheet.Cells["A9:F9"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["A9:F9"].RichText.Add("(2)Địa chỉ hiện tại: ");
                        var value = range.Worksheet.Cells["A9:F9"].RichText.Add(yeuCauTiepNhan.DiaChiDayDu);
                        value.Bold = true;

                        range.Worksheet.Cells["A9:F9"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A9:F9"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A9:F9"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A9:F9"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["G9:J9"])
                    {
                        range.Worksheet.Cells["G9:J9"].Merge = true;

                        range.Worksheet.Cells["G9:J9"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["G9:J9"].RichText.Add("(3)Mã khu vực(K1/K2/K3): ");
                        var value = range.Worksheet.Cells["G9:J9"].RichText.Add(yeuCauTiepNhan.BHYTMaKhuVuc);
                        value.Bold = true;

                        range.Worksheet.Cells["G9:J9"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["G9:J9"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["G9:J9"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["G9:J9"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["A10:F10"])
                    {
                        range.Worksheet.Cells["A10:F10"].Merge = true;
                        range.Worksheet.Cells["A10:F10"].Style.WrapText = true;

                        var title = range.Worksheet.Cells["A10:F10"].RichText.Add("(4)Mã thẻ BHYT: ");
                        var value = range.Worksheet.Cells["A10:F10"].RichText.Add(maBHYT);
                        value.Bold = true;

                        range.Worksheet.Cells["A10:F10"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A10:F10"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A10:F10"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A10:F10"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["G10:J10"])
                    {
                        range.Worksheet.Cells["G10:J10"].Merge = true;
                        range.Worksheet.Cells["G10:J10"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["G10:J10"].RichText.Add("Giá trị từ: ");
                        var valuebHYTTuNgay = range.Worksheet.Cells["G10:J10"].RichText.Add(bHYTTuNgay);
                        valuebHYTTuNgay.Bold = true;

                        var den = range.Worksheet.Cells["G10:J10"].RichText.Add(" đến: ");
                        den.Bold = false;
                        var valuebHYTDenNgay = range.Worksheet.Cells["G10:J10"].RichText.Add(bHYTDenNgay);
                        valuebHYTDenNgay.Bold = true;


                        range.Worksheet.Cells["G10:J10"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["G10:J10"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["G10:J10"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["G10:J10"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["A11:F11"])
                    {
                        range.Worksheet.Cells["A11:F11"].Merge = true;

                        range.Worksheet.Cells["A11:F11"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["A11:F11"].RichText.Add("(5)Nơi ĐK KCB ban đầu: ");
                        var valueNoiDKKCBBanDau = range.Worksheet.Cells["A11:F11"].RichText.Add(NoiDKKCBBanDau);
                        valueNoiDKKCBBanDau.Bold = true;

                        range.Worksheet.Cells["A11:F11"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A11:F11"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A11:F11"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A11:F11"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["G11:J11"])
                    {
                        range.Worksheet.Cells["G11:J11"].Merge = true;
                        range.Worksheet.Cells["G11:J11"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["G11:J11"].RichText.Add("(6)Mã: ");
                        var valueMaKCBBanDau = range.Worksheet.Cells["G11:J11"].RichText.Add(MaKCBBanDau);
                        valueMaKCBBanDau.Bold = true;

                        range.Worksheet.Cells["G11:J11"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["G11:J11"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["G11:J11"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["G11:J11"].Style.Font.Color.SetColor(Color.Black);
                    }


                    using (var range = worksheet.Cells["A12:F12"])
                    {
                        range.Worksheet.Cells["A12:F12"].Merge = true;

                        range.Worksheet.Cells["A12:F12"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["A12:F12"].RichText.Add("(7)Đến Khám: ");
                        var value = range.Worksheet.Cells["A12:F12"].RichText.Add(yeuCauTiepNhan.ThoiDiemTiepNhan.ApplyFormatGioPhutNgay());
                        value.Bold = true;

                        range.Worksheet.Cells["A12:F12"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A12:F12"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A12:F12"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A12:F12"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["A13:F13"])
                    {
                        range.Worksheet.Cells["A13:F13"].Merge = true;

                        range.Worksheet.Cells["A13:F13"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["A13:F13"].RichText.Add("(8)Điều trị ngoại trú/nội trú từ: ");
                        var value = range.Worksheet.Cells["A13:F13"].RichText.Add(yeuCauTiepNhan.NoiTruBenhAn?.ThoiDiemNhapVien.ApplyFormatGioPhutNgay());
                        value.Bold = true;

                        range.Worksheet.Cells["A13:F13"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A13:F13"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A13:F13"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A13:F13"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["A14:F14"])
                    {
                        range.Worksheet.Cells["A14:F14"].Merge = true;
                        range.Worksheet.Cells["A14:F14"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["A14:F14"].RichText.Add("(9)Kết thúc khám/điều trị: ");
                        var value = range.Worksheet.Cells["A14:F14"].RichText.Add(yeuCauTiepNhan.NoiTruBenhAn?.ThoiDiemRaVien?.ApplyFormatGioPhutNgay());
                        value.Bold = true;


                        range.Worksheet.Cells["A14:F14"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A14:F14"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A14:F14"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A14:F14"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["G14:J14"])
                    {
                        range.Worksheet.Cells["G14:J14"].Merge = true;
                        range.Worksheet.Cells["G14:J14"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["G14:J14"].RichText.Add("Tổng số ngày điều trị: ");
                        var value = range.Worksheet.Cells["G14:J14"].RichText.Add(NoiTruBenhAnHelper.TinhSoNgayDieuTri(yeuCauTiepNhan.NoiTruBenhAn)?.ToString() ?? string.Empty);
                        value.Bold = true;

                        range.Worksheet.Cells["G14:J14"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["G14:J14"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["G14:J14"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["G14:J14"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["K14:N14"])
                    {
                        range.Worksheet.Cells["K14:N14"].Merge = true;

                        range.Worksheet.Cells["K14:N14"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["K14:N14"].RichText.Add("(10)Tình trạng ra viện: ");
                        var value = range.Worksheet.Cells["K14:N14"].RichText.Add((yeuCauTiepNhan.NoiTruBenhAn?.TinhTrangRaVien == EnumTinhTrangRaVien.RaVien && (yeuCauTiepNhan.NoiTruBenhAn?.KetQuaDieuTri == EnumKetQuaDieuTri.Do || yeuCauTiepNhan.NoiTruBenhAn?.KetQuaDieuTri == EnumKetQuaDieuTri.Khoi) ? 1 : 2).ToString());
                        value.Bold = true;


                        range.Worksheet.Cells["K14:N14"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["K14:N14"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["K14:N14"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["K14:N14"].Style.Font.Color.SetColor(Color.Black);
                    }

                    //=================================15=================================
                    var coCapCuu = yeuCauTiepNhan.LyDoVaoVien == Enums.EnumLyDoVaoVien.CapCuu ? "X" : string.Empty;
                    var coDungTuyen = yeuCauTiepNhan.LyDoVaoVien == Enums.EnumLyDoVaoVien.DungTuyen ? "X" : string.Empty;
                    var coThongTuyen = yeuCauTiepNhan.LyDoVaoVien == Enums.EnumLyDoVaoVien.ThongTuyen ? "X" : string.Empty;
                    var coTraiTuyen = yeuCauTiepNhan.LyDoVaoVien == Enums.EnumLyDoVaoVien.TraiTuyen ? "X" : string.Empty;

                    using (var range = worksheet.Cells["A15:C15"])
                    {
                        range.Worksheet.Cells["A15:C15"].Merge = true;

                        range.Worksheet.Cells["A15:C15"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["A15:C15"].RichText.Add("(11) Cấp cứu: ");
                        var value = range.Worksheet.Cells["A15:C15"].RichText.Add(coCapCuu);
                        value.Bold = true;

                        range.Worksheet.Cells["A15:C15"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A15:C15"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A15:C15"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A15:C15"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["D15:F15"])
                    {
                        range.Worksheet.Cells["D15:F15"].Merge = true;
                        range.Worksheet.Cells["D15:F15"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["D15:F15"].RichText.Add("(12) Đúng tuyến: ");
                        var value = range.Worksheet.Cells["D15:F15"].RichText.Add(coDungTuyen);
                        value.Bold = true;

                        range.Worksheet.Cells["D15:F15"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["D15:F15"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["D15:F15"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["D15:F15"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["G15:J15"])
                    {
                        range.Worksheet.Cells["G15:J15"].Merge = true;
                        range.Worksheet.Cells["G15:J15"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["G15:J15"].RichText.Add("Nơi chuyến đến: ");
                        var value = range.Worksheet.Cells["G15:J15"].RichText.Add(yeuCauTiepNhan.NoiChuyen?.Ten);
                        value.Bold = true;
                        range.Worksheet.Cells["G15:J15"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["G15:J15"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["G15:J15"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["G15:J15"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["K15:N15"])
                    {
                        range.Worksheet.Cells["K15:N15"].Merge = true;
                        range.Worksheet.Cells["K15:N15"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["K15:N15"].RichText.Add("Nơi chuyển đi: ");
                        var value = range.Worksheet.Cells["K15:N15"].RichText.Add(yeuCauTiepNhan.NoiTruBenhAn?.ChuyenDenBenhVien?.Ten);
                        value.Bold = true;
                        range.Worksheet.Cells["K15:N15"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["K15:N15"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["K15:N15"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["K15:N15"].Style.Font.Color.SetColor(Color.Black);
                    }

                    //=================================16=================================
                    using (var range = worksheet.Cells["A16:C16"])
                    {
                        range.Worksheet.Cells["A16:C16"].Merge = true;
                        range.Worksheet.Cells["A16:C16"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["A16:C16"].RichText.Add("(13)Thông tuyến: ");
                        var value = range.Worksheet.Cells["A16:C16"].RichText.Add(coThongTuyen);
                        value.Bold = true;
                        range.Worksheet.Cells["A16:C16"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A16:C16"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A16:C16"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A16:C16"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["D16:F16"])
                    {
                        range.Worksheet.Cells["D16:F16"].Merge = true;
                        range.Worksheet.Cells["D16:F16"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["D16:F16"].RichText.Add("(14)Trái tuyến: ");
                        var value = range.Worksheet.Cells["D16:F16"].RichText.Add(coTraiTuyen);
                        value.Bold = true;

                        range.Worksheet.Cells["D16:F16"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["D16:F16"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["D16:F16"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["D16:F16"].Style.Font.Color.SetColor(Color.Black);
                    }

                    //================================= 17 =================================

                    var chuanDoanXacDinhStr = yeuCauTiepNhan.NoiTruBenhAn?.LoaiBenhAn == LoaiBenhAn.SanKhoaMo || yeuCauTiepNhan.NoiTruBenhAn?.LoaiBenhAn == LoaiBenhAn.SanKhoaThuong
                                                             ? chuanDoanXacDinhSanKhoa : yeuCauTiepNhan.NoiTruBenhAn?.ChanDoanChinhRaVienGhiChu;


                    var iCD10 = yeuCauTiepNhan.NoiTruBenhAn?.LoaiBenhAn == LoaiBenhAn.SanKhoaMo || yeuCauTiepNhan.NoiTruBenhAn?.LoaiBenhAn == LoaiBenhAn.SanKhoaThuong
                                                               ? maICD10 : yeuCauTiepNhan.NoiTruBenhAn?.ChanDoanChinhRaVienICD?.Ma;


                    using (var range = worksheet.Cells["A17:F17"])
                    {
                        range.Worksheet.Cells["A17:F17"].Merge = true;
                        range.Worksheet.Cells["A17:F17"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["A17:F17"].RichText.Add("(15)Chẩn đoán xác định: ");
                        var value = range.Worksheet.Cells["A17:F17"].RichText.Add(chuanDoanXacDinhStr);
                        value.Bold = true;

                        range.Worksheet.Cells["A17:F17"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A17:F17"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A17:F17"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A17:F17"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["G17:N17"])
                    {
                        range.Worksheet.Cells["G17:N17"].Merge = true;

                        range.Worksheet.Cells["G17:N17"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["G17:N17"].RichText.Add("(17) Mã bệnh: ");
                        var value = range.Worksheet.Cells["G17:N17"].RichText.Add(iCD10);
                        value.Bold = true;


                        range.Worksheet.Cells["G17:N17"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["G17:N17"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["G17:N17"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["G17:N17"].Style.Font.Color.SetColor(Color.Black);
                    }

                    //================================= 18 =================================

                    using (var range = worksheet.Cells["A18:F18"])
                    {
                        range.Worksheet.Cells["A18:F18"].Merge = true;
                        range.Worksheet.Cells["A18:F18"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["A18:F18"].RichText.Add("(18)Bệnh kèm theo: ");
                        var value = range.Worksheet.Cells["A18:F18"].RichText.Add(tenICDKemTheo);
                        value.Bold = true;


                        range.Worksheet.Cells["A18:F18"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A18:F18"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A18:F18"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A18:F18"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["G18:N18"])
                    {
                        range.Worksheet.Cells["G18:N18"].Merge = true;
                        range.Worksheet.Cells["G18:N18"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["G18:N18"].RichText.Add("(18)Mã bệnh kèm theo: ");
                        var value = range.Worksheet.Cells["G18:N18"].RichText.Add(maICDKemTheo);
                        value.Bold = true;


                        range.Worksheet.Cells["G18:N18"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["G18:N18"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["G18:N18"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["G18:N18"].Style.Font.Color.SetColor(Color.Black);
                    }

                    //================================= 19 =================================

                    using (var range = worksheet.Cells["A19:F19"])
                    {
                        range.Worksheet.Cells["A19:F19"].Merge = true;
                        range.Worksheet.Cells["A19:F19"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["A19:F19"].RichText.Add("(19)Thời điểm đủ 05 năm liên tục từ ngày: ");
                        var value = range.Worksheet.Cells["A19:F19"].RichText.Add(yeuCauTiepNhan.BHYTNgayDu5Nam?.ApplyFormatDate());
                        value.Bold = true;


                        range.Worksheet.Cells["A19:F19"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A19:F19"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A19:F19"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A19:F19"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["G19:N19"])
                    {
                        range.Worksheet.Cells["G19:N19"].Merge = true;
                        range.Worksheet.Cells["G19:N19"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["G19:N19"].RichText.Add("(20)Miễn cùng chi trả trong năm từ ngày: ");
                        var value = range.Worksheet.Cells["G19:N19"].RichText.Add(yeuCauTiepNhan.BHYTNgayDuocMienCungChiTra?.ApplyFormatDate());
                        value.Bold = true;

                        range.Worksheet.Cells["G19:N19"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["G19:N19"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["G19:N19"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["G19:N19"].Style.Font.Color.SetColor(Color.Black);
                    }

                    //================================= 20 =================================

                    using (var range = worksheet.Cells["A20:N20"])
                    {
                        range.Worksheet.Cells["A20:N20"].Merge = true;
                        range.Worksheet.Cells["A20:N20"].Value = "II. Phần Chi phí khám bệnh, chữa bệnh";
                        range.Worksheet.Cells["A20:N20"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A20:N20"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A20:N20"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A20:N20"].Style.Font.Color.SetColor(Color.Black);
                        range.Worksheet.Cells["A20:N20"].Style.Font.Bold = true;
                    }

                    int index = 21;

                    var groupChiPhiTheoThe = danhSachChiPhi.GroupBy(o => o.MaSoTheBHYT);

                    if (groupChiPhiTheoThe.Count() > 2 ||
                        (groupChiPhiTheoThe.All(o => o.Key != string.Empty) && groupChiPhiTheoThe.Count() > 1))
                    {
                        var groupNgayPhatSinhTheoThe = groupChiPhiTheoThe.Where(o => o.Key != string.Empty).Select(o => new { o.Key, o.OrderBy(j => j.NgayPhatSinh).First().NgayPhatSinh }).OrderBy(o => o.NgayPhatSinh).ToArray();
                        for (int i = 0; i < groupNgayPhatSinhTheoThe.Count(); i++)
                        {
                            var ngayPhatSinhTheoThe = groupNgayPhatSinhTheoThe[i];
                            var theBHYTChiTra = yeuCauTiepNhan.YeuCauTiepNhanTheBHYTs.First(o => o.MaSoThe == ngayPhatSinhTheoThe.Key);
                            var chiPhis = groupChiPhiTheoThe.FirstOrDefault(o => o.Key == ngayPhatSinhTheoThe.Key).ToList();
                            DateTime? ngayPhatSinhTiepTheo = i < groupNgayPhatSinhTheoThe.Count() - 1
                                ? groupNgayPhatSinhTheoThe[i + 1].NgayPhatSinh
                                : null;
                            chiPhis.AddRange(groupChiPhiTheoThe.FirstOrDefault(o => o.Key == string.Empty).Where(j => (i == 0 || j.NgayPhatSinh >= ngayPhatSinhTheoThe.NgayPhatSinh) && (ngayPhatSinhTiepTheo != null && j.NgayPhatSinh < ngayPhatSinhTiepTheo)).ToList());
                            var mucHuongPT = theBHYTChiTra != null && theBHYTChiTra?.MucHuong > 0 ? theBHYTChiTra?.MucHuong + "%" : string.Empty;


                            using (var range = worksheet.Cells["A" + index + ":C" + index])
                            {
                                range.Worksheet.Cells["A" + index + ":C" + index].Merge = true;
                                range.Worksheet.Cells["A" + index + ":C" + index].Style.WrapText = true;
                                var title = range.Worksheet.Cells["A" + index + ":C" + index].RichText.Add("Mã thẻ BHYT: ");
                                var value = range.Worksheet.Cells["A" + index + ":C" + index].RichText.Add(theBHYTChiTra.MaSoThe);
                                value.Bold = true;

                                range.Worksheet.Cells["A" + index + ":C" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                range.Worksheet.Cells["A" + index + ":C" + index].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                                range.Worksheet.Cells["A" + index + ":C" + index].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                                range.Worksheet.Cells["A" + index + ":C" + index].Style.Font.Color.SetColor(Color.Black);
                            }

                            using (var range = worksheet.Cells["D" + index + ":F" + index])
                            {
                                range.Worksheet.Cells["D" + index + ":F" + index].Merge = true;
                                range.Worksheet.Cells["D" + index + ":F" + index].Style.WrapText = true;
                                var title = range.Worksheet.Cells["D" + index + ":F" + index].RichText.Add("Giá trị từ: ");
                                var valuebHYTTuNgay = range.Worksheet.Cells["D" + index + ":F" + index].RichText.Add(theBHYTChiTra.NgayHieuLuc.ApplyFormatDate());
                                valuebHYTTuNgay.Bold = true;

                                var den = range.Worksheet.Cells["D" + index + ":F" + index].RichText.Add(" đến: ");
                                den.Bold = false;
                                var valuebHYTDenNgay = range.Worksheet.Cells["D" + index + ":F" + index].RichText.Add(theBHYTChiTra?.NgayHetHan?.ApplyFormatDate());
                                valuebHYTDenNgay.Bold = true;

                                range.Worksheet.Cells["D" + index + ":F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                range.Worksheet.Cells["D" + index + ":F" + index].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                                range.Worksheet.Cells["D" + index + ":F" + index].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                                range.Worksheet.Cells["D" + index + ":F" + index].Style.Font.Color.SetColor(Color.Black);
                            }

                            using (var range = worksheet.Cells["G" + index + ":J" + index])
                            {
                                range.Worksheet.Cells["G" + index + ":J" + index].Merge = true;
                                range.Worksheet.Cells["G" + index + ":J" + index].Style.WrapText = true;
                                var title = range.Worksheet.Cells["G" + index + ":J" + index].RichText.Add("Mức hưởng: ");
                                var value = range.Worksheet.Cells["G" + index + ":J" + index].RichText.Add(mucHuongPT);
                                value.Bold = true;


                                range.Worksheet.Cells["G" + index + ":J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                range.Worksheet.Cells["G" + index + ":J" + index].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                                range.Worksheet.Cells["G" + index + ":J" + index].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                                range.Worksheet.Cells["G" + index + ":J" + index].Style.Font.Color.SetColor(Color.Black);
                            }

                            index++;

                            var indexTableFirst = index;
                            var indexTableLast = index + 1;

                            using (var range = worksheet.Cells["A" + indexTableFirst + ":N" + indexTableLast])
                            {
                                range.Worksheet.Cells["A" + indexTableFirst + ":N" + indexTableLast].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                                range.Worksheet.Cells["A" + indexTableFirst + ":N" + indexTableLast].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                                range.Worksheet.Cells["A" + indexTableFirst + ":N" + indexTableLast].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                range.Worksheet.Cells["A" + indexTableFirst + ":N" + indexTableLast].Style.Font.Color.SetColor(Color.Black);
                                range.Worksheet.Cells["A" + indexTableFirst + ":N" + indexTableLast].Style.Font.Bold = true;
                                range.Worksheet.Cells["A" + indexTableFirst + ":N" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);

                                range.Worksheet.Cells["A" + indexTableFirst + ":A" + indexTableLast].Merge = true;
                                range.Worksheet.Cells["A" + indexTableFirst + ":A" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["A" + indexTableFirst + ":A" + indexTableLast].Value = "STT";

                                range.Worksheet.Cells["B" + indexTableFirst + ":B" + indexTableLast].Merge = true;
                                range.Worksheet.Cells["B" + indexTableFirst + ":B" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["B" + indexTableFirst + ":B" + indexTableLast].Value = "Nội dung";

                                range.Worksheet.Cells["C" + indexTableFirst + ":C" + indexTableLast].Merge = true;
                                range.Worksheet.Cells["C" + indexTableFirst + ":C" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["C" + indexTableFirst + ":C" + indexTableLast].Value = "Đơn vị tính";

                                range.Worksheet.Cells["D" + indexTableFirst + ":D" + indexTableLast].Merge = true;
                                range.Worksheet.Cells["D" + indexTableFirst + ":D" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["D" + indexTableFirst + ":D" + indexTableLast].Value = "Số lượng";

                                range.Worksheet.Cells["E" + indexTableFirst + ":E" + indexTableLast].Merge = true;
                                range.Worksheet.Cells["E" + indexTableFirst + ":E" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["E" + indexTableFirst + ":E" + indexTableLast].Value = "Đơn giá BV(đồng)";

                                range.Worksheet.Cells["F" + indexTableFirst + ":F" + indexTableLast].Merge = true;
                                range.Worksheet.Cells["F" + indexTableFirst + ":F" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["F" + indexTableFirst + ":F" + indexTableLast].Value = "Đơn giá BH(đồng)";

                                range.Worksheet.Cells["G" + indexTableFirst + ":G" + indexTableLast].Merge = true;
                                range.Worksheet.Cells["G" + indexTableFirst + ":G" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["G" + indexTableFirst + ":G" + indexTableLast].Value = "Tỉ lệ thanh toán theo dịch vụ (%)";

                                range.Worksheet.Cells["H" + indexTableFirst + ":H" + indexTableLast].Merge = true;
                                range.Worksheet.Cells["H" + indexTableFirst + ":H" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["H" + indexTableFirst + ":H" + indexTableLast].Value = "Thành tiền BV (đồng)";

                                range.Worksheet.Cells["I" + indexTableFirst + ":I" + indexTableLast].Merge = true;
                                range.Worksheet.Cells["I" + indexTableFirst + ":I" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["I" + indexTableFirst + ":I" + indexTableLast].Value = "Tỷ lệ thanh toán BHYT (%)";

                                range.Worksheet.Cells["J" + indexTableFirst + ":J" + indexTableLast].Merge = true;
                                range.Worksheet.Cells["J" + indexTableFirst + ":J" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["J" + indexTableFirst + ":J" + indexTableLast].Value = "Thành tiền BH(đồng)";

                                range.Worksheet.Cells["K" + indexTableFirst + ":N" + indexTableFirst].Merge = true;
                                range.Worksheet.Cells["K" + indexTableFirst + ":N" + indexTableFirst].Value = "Nguồn thanh toán (đồng)";

                                range.Worksheet.Cells["K" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["K" + indexTableLast].Value = "Quỹ BHYT";

                                range.Worksheet.Cells["L" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["L" + indexTableLast].Value = "Người bệnh cùng chi trả (đồng)";

                                range.Worksheet.Cells["M" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["M" + indexTableLast].Value = "Khác (đồng)";

                                range.Worksheet.Cells["N" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["N" + indexTableLast].Value = "Người bệnh tự trả(đồng)";
                            }

                            index = indexTableLast + 1;

                            var dsChiPhiBangKeTheoThe = new List<BangKeKhamBenhCoBHYTVo>();
                            foreach (var chiPhi in chiPhis.Where(c => c.NhomChiPhiBangKe != NhomChiPhiBangKe.GoiVatTu).GroupBy(c => new { c.NhomChiPhiBangKe, c.TenDichVu, c.DonViTinh, c.DuocHuongBHYT, c.DonGia, c.DonGiaBHYT, c.MucHuongBaoHiem, c.TiLeBaoHiemThanhToan }).OrderByDescending(o => o.Key.DuocHuongBHYT))
                            {
                                dsChiPhiBangKeTheoThe.Add(new BangKeKhamBenhCoBHYTVo
                                {
                                    Nhom = chiPhi.Key.NhomChiPhiBangKe,
                                    Id = chiPhi.FirstOrDefault().Id,
                                    NoiDung = chiPhi.Key.TenDichVu,
                                    DonViTinh = chiPhi.Key.DonViTinh,
                                    SoLuong = (decimal)chiPhi.Sum(c => c.Soluong),
                                    DuocHuongBaoHiem = chiPhi.Key.DuocHuongBHYT,
                                    DonGiaBH = chiPhi.Key.DonGiaBHYT,
                                    DonGiaTheoBV = chiPhi.Key.DonGia,
                                    MucHuongBaoHiem = chiPhi.Key.MucHuongBaoHiem,
                                    TiLeThanhToanTheoDV = chiPhi.Key.TiLeBaoHiemThanhToan,
                                    BaoHiemChiTra = true
                                });
                            }

                            foreach (var chiPhi in chiPhis.Where(c => c.NhomChiPhiBangKe == NhomChiPhiBangKe.GoiVatTu).OrderByDescending(o => o.DuocHuongBHYT))
                            {
                                dsChiPhiBangKeTheoThe.Add(new BangKeKhamBenhCoBHYTVo
                                {
                                    Nhom = chiPhi.NhomChiPhiBangKe,
                                    Id = chiPhi.Id,
                                    NoiDung = chiPhi.TenDichVu,
                                    DonViTinh = chiPhi.DonViTinh,
                                    SoLuong = (decimal)chiPhi.Soluong,
                                    DuocHuongBaoHiem = chiPhi.DuocHuongBHYT,
                                    DonGiaBH = chiPhi.DonGiaBHYT,
                                    DonGiaTheoBV = chiPhi.DonGia,
                                    MucHuongBaoHiem = chiPhi.MucHuongBaoHiem,
                                    TiLeThanhToanTheoDV = chiPhi.TiLeBaoHiemThanhToan,
                                    BaoHiemChiTra = true
                                });
                            }
                            dsChiPhiBangKe.AddRange(dsChiPhiBangKeTheoThe);
                            var groupChiPhiBangKes = dsChiPhiBangKeTheoThe.GroupBy(x => x.Nhom).OrderBy(o => (int)o.Key * (o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay || o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriNoiTru ? 1 : 10));
                            if (!groupChiPhiBangKes.Any())
                            {
                                return null;
                            }
                            foreach (var groupChiPhiBangKe in groupChiPhiBangKes)
                            {
                                if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay)
                                {

                                    worksheet.Cells["A" + index + ":N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["A" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                    worksheet.Cells["A" + index + ":N" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                    worksheet.Cells["A" + index + ":N" + index].Merge = true;
                                    worksheet.Cells["A" + index + ":N" + index].Value = "2. Ngày giường:";
                                    worksheet.Cells["A" + index + ":N" + index].Style.Font.Bold = true;

                                    index++;

                                    worksheet.Cells["A" + index + ":G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["A" + index + ":G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                    worksheet.Cells["A" + index + ":G" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                    worksheet.Cells["A" + index + ":G" + index].Merge = true;
                                    worksheet.Cells["A" + index + ":G" + index].Value = "2.1." + groupChiPhiBangKe.Key.GetDescription();
                                    worksheet.Cells["A" + index + ":G" + index].Style.Font.Bold = true;

                                    worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["H" + index].Style.Font.Bold = true;
                                    worksheet.Cells["H" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBV);

                                    worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["J" + index].Style.Font.Bold = true;
                                    worksheet.Cells["J" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBH);

                                    worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["K" + index].Style.Font.Bold = true;
                                    worksheet.Cells["K" + index].Value = groupChiPhiBangKe.Sum(o => o.QuyBHYT);

                                    worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["L" + index].Style.Font.Bold = true;
                                    worksheet.Cells["L" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra);

                                    worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["M" + index].Style.Font.Bold = true;
                                    worksheet.Cells["M" + index].Value = groupChiPhiBangKe.Sum(o => o.Khac);

                                    worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["N" + index].Style.Font.Bold = true;
                                    worksheet.Cells["N" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra);

                                    index++;
                                }
                                else if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.NgayGiuongDieuTriNoiTru)
                                {
                                    if (!groupChiPhiBangKes.Any(o => o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay))
                                    {
                                        worksheet.Cells["A" + index + ":N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["A" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                        worksheet.Cells["A" + index + ":N" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                        worksheet.Cells["A" + index + ":N" + index].Merge = true;
                                        worksheet.Cells["A" + index + ":N" + index].Value = "2. Ngày giường:";
                                        worksheet.Cells["A" + index + ":N" + index].Style.Font.Bold = true;

                                    }

                                    index++;

                                    worksheet.Cells["A" + index + ":G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["A" + index + ":G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                    worksheet.Cells["A" + index + ":G" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                    worksheet.Cells["A" + index + ":G" + index].Merge = true;
                                    worksheet.Cells["A" + index + ":G" + index].Value = "2.2." + groupChiPhiBangKe.Key.GetDescription();
                                    worksheet.Cells["A" + index + ":G" + index].Style.Font.Bold = true;

                                    worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["H" + index].Style.Font.Bold = true;
                                    worksheet.Cells["H" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBV);

                                    worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["J" + index].Style.Font.Bold = true;
                                    worksheet.Cells["J" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBH);

                                    worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["K" + index].Style.Font.Bold = true;
                                    worksheet.Cells["K" + index].Value = groupChiPhiBangKe.Sum(o => o.QuyBHYT);

                                    worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["L" + index].Style.Font.Bold = true;
                                    worksheet.Cells["L" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra);

                                    worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["M" + index].Style.Font.Bold = true;
                                    worksheet.Cells["M" + index].Value = groupChiPhiBangKe.Sum(o => o.Khac);

                                    worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["N" + index].Style.Font.Bold = true;
                                    worksheet.Cells["N" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra);

                                    index++;
                                }
                                else
                                {
                                    worksheet.Cells["A" + index + ":G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["A" + index + ":G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                    worksheet.Cells["A" + index + ":G" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                    worksheet.Cells["A" + index + ":G" + index].Merge = true;
                                    worksheet.Cells["A" + index + ":G" + index].Value = (int)groupChiPhiBangKe.Key + "." + groupChiPhiBangKe.Key.GetDescription();
                                    worksheet.Cells["A" + index + ":G" + index].Style.Font.Bold = true;

                                    worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["H" + index].Style.Font.Bold = true;
                                    worksheet.Cells["H" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBV);

                                    worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["J" + index].Style.Font.Bold = true;
                                    worksheet.Cells["J" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBH);

                                    worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["K" + index].Style.Font.Bold = true;
                                    worksheet.Cells["K" + index].Value = groupChiPhiBangKe.Sum(o => o.QuyBHYT);

                                    worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["L" + index].Style.Font.Bold = true;
                                    worksheet.Cells["L" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra);

                                    worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["M" + index].Style.Font.Bold = true;
                                    worksheet.Cells["M" + index].Value = groupChiPhiBangKe.Sum(o => o.Khac);

                                    worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["N" + index].Style.Font.Bold = true;
                                    worksheet.Cells["N" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra);

                                    index++;
                                }
                                if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.GoiVatTu)
                                {
                                    var groupGoiVatTus = groupChiPhiBangKe.ToList().GroupBy(o => o.SoGoiVatTu.GetValueOrDefault()).OrderBy(o => o.Key);
                                    int sttGoiVatTu = 1;
                                    foreach (var groupGoiVatTu in groupGoiVatTus)
                                    {
                                        worksheet.Cells["A" + index + ":G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["A" + index + ":G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                        worksheet.Cells["A" + index + ":G" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                        worksheet.Cells["A" + index + ":G" + index].Value = "10." + sttGoiVatTu + ". " + groupChiPhiBangKe.Key.GetDescription() + " " + sttGoiVatTu;
                                        worksheet.Cells["A" + index + ":G" + index].Style.Font.Bold = true;
                                        worksheet.Cells["A" + index + ":G" + index].Merge = true;

                                        worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["H" + index].Style.Font.Bold = true;
                                        worksheet.Cells["H" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBV);

                                        worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["J" + index].Style.Font.Bold = true;
                                        worksheet.Cells["J" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBH);

                                        worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["K" + index].Style.Font.Bold = true;
                                        worksheet.Cells["K" + index].Value = groupChiPhiBangKe.Sum(o => o.QuyBHYT);

                                        worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["L" + index].Style.Font.Bold = true;
                                        worksheet.Cells["L" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra);

                                        worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["M" + index].Style.Font.Bold = true;
                                        worksheet.Cells["M" + index].Value = groupChiPhiBangKe.Sum(o => o.Khac);

                                        worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["N" + index].Style.Font.Bold = true;
                                        worksheet.Cells["N" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra);

                                        index++;

                                        foreach (var chiPhiBangKe in groupGoiVatTu)
                                        {
                                            worksheet.Cells["A" + index + ":N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["A" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                            worksheet.Cells["A" + index + ":N" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));

                                            worksheet.Cells["A" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["A" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                            worksheet.Cells["A" + index].Value = indexItem;

                                            worksheet.Cells["B" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["B" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                            worksheet.Cells["B" + index].Value = chiPhiBangKe.NoiDung;

                                            worksheet.Cells["C" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["C" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                            worksheet.Cells["C" + index].Value = chiPhiBangKe.DonViTinh;

                                            worksheet.Cells["D" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["D" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                            worksheet.Cells["D" + index].Value = chiPhiBangKe.SoLuong;

                                            worksheet.Cells["E" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["E" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                            worksheet.Cells["E" + index].Style.Numberformat.Format = "#,##0.00";
                                            worksheet.Cells["E" + index].Value = chiPhiBangKe.DonGiaBV;

                                            worksheet.Cells["F" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["F" + index].Style.Numberformat.Format = "#,##0.00";
                                            worksheet.Cells["F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                            worksheet.Cells["F" + index].Value = chiPhiBangKe.DonGiaBH;

                                            worksheet.Cells["G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                            worksheet.Cells["G" + index].Style.Numberformat.Format = "#,##0.00";
                                            worksheet.Cells["G" + index].Value = chiPhiBangKe.TiLeThanhToanTheoDV;

                                            worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                            worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                            worksheet.Cells["H" + index].Value = chiPhiBangKe.ThanhTienBV;

                                            worksheet.Cells["I" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["I" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                            worksheet.Cells["I" + index].Value = Convert.ToDouble(chiPhiBangKe.MucHuongBaoHiem > 0 ? 100 : 0).ApplyFormatMoneyToDouble();


                                            worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                            worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                            worksheet.Cells["J" + index].Value = chiPhiBangKe.ThanhTienBH;


                                            worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                            worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                            worksheet.Cells["K" + index].Value = chiPhiBangKe.QuyBHYT;


                                            worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                            worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                            worksheet.Cells["L" + index].Value = chiPhiBangKe.NguoiBenhCungChiTra;


                                            worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                            worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                            worksheet.Cells["M" + index].Value = chiPhiBangKe.Khac;


                                            worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                            worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                            worksheet.Cells["N" + index].Value = chiPhiBangKe.NguoiBenhTuTra;

                                            indexItem++;
                                            index++;
                                        }
                                    }
                                }
                                else
                                {
                                    foreach (var chiPhiBangKe in groupChiPhiBangKe)
                                    {
                                        worksheet.Cells["A" + index + ":N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["A" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                        worksheet.Cells["A" + index + ":N" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));

                                        worksheet.Cells["A" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["A" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                        worksheet.Cells["A" + index].Value = indexItem;

                                        worksheet.Cells["B" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["B" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                        worksheet.Cells["B" + index].Value = chiPhiBangKe.NoiDung;

                                        worksheet.Cells["C" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["C" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                        worksheet.Cells["C" + index].Value = chiPhiBangKe.DonViTinh;

                                        worksheet.Cells["D" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["D" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                        worksheet.Cells["D" + index].Value = chiPhiBangKe.SoLuong;

                                        worksheet.Cells["E" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["E" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["E" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["E" + index].Value = chiPhiBangKe.DonGiaBV;

                                        worksheet.Cells["F" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["F" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["F" + index].Value = chiPhiBangKe.DonGiaBH;

                                        worksheet.Cells["G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["G" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["G" + index].Value = chiPhiBangKe.TiLeThanhToanTheoDV;

                                        worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["H" + index].Value = chiPhiBangKe.ThanhTienBV;

                                        worksheet.Cells["I" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["I" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["I" + index].Value = Convert.ToDouble(chiPhiBangKe.MucHuongBaoHiem > 0 ? 100 : 0).ApplyFormatMoneyToDouble();


                                        worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["J" + index].Value = chiPhiBangKe.ThanhTienBH;


                                        worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["K" + index].Value = chiPhiBangKe.QuyBHYT;


                                        worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["L" + index].Value = chiPhiBangKe.NguoiBenhCungChiTra;


                                        worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["M" + index].Value = chiPhiBangKe.Khac;


                                        worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["N" + index].Value = chiPhiBangKe.NguoiBenhTuTra;

                                        indexItem++;
                                        index++;
                                    }
                                }

                            }

                            worksheet.Cells["A" + index + ":G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["A" + index + ":G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                            worksheet.Cells["A" + index + ":G" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                            worksheet.Cells["A" + index + ":G" + index].Merge = true;
                            worksheet.Cells["A" + index + ":G" + index].Value = "Tổng cộng";
                            worksheet.Cells["A" + index + ":G" + index].Style.Font.Bold = true;

                            worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                            worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                            worksheet.Cells["H" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.ThanhTienBV)).Sum();

                            worksheet.Cells["I" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["I" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;

                            worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                            worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                            worksheet.Cells["J" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.ThanhTienBH)).Sum();

                            worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                            worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                            worksheet.Cells["K" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.QuyBHYT)).Sum();

                            worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                            worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                            worksheet.Cells["L" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.NguoiBenhCungChiTra)).Sum();

                            worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                            worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                            worksheet.Cells["M" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.Khac)).Sum();

                            worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                            worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                            worksheet.Cells["N" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.NguoiBenhTuTra)).Sum();

                            index++;

                            worksheet.Cells["A" + index + ":N" + index].Merge = true;
                            worksheet.Cells["A" + index + ":N" + index].Value = "Tổng chi phí lần khám bệnh/cả đợt điều trị: " + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble() + " đồng";
                            worksheet.Cells["A" + index + ":N" + index].Style.Font.Bold = true;

                            index++;

                            worksheet.Cells["A" + index + ":N" + index].Merge = true;
                            worksheet.Cells["A" + index + ":N" + index].Value = "(Viết bằng chữ: " + NumberHelper.ChuyenSoRaText(Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBH))) + ")";

                            index++;

                            worksheet.Cells["A" + index + ":N" + index].Merge = true;
                            worksheet.Cells["A" + index + ":N" + index].Value = "Trong đó , số tiền do:";
                            worksheet.Cells["A" + index + ":N" + index].Style.Font.Bold = true;

                            index++;
                            worksheet.Cells["A" + index + ":N" + index].Merge = true;
                            worksheet.Cells["A" + index + ":N" + index].Value = "- Quỹ BHYT thanh toán: " + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble();

                            index++;
                            worksheet.Cells["A" + index + ":N" + index].Merge = true;
                            worksheet.Cells["A" + index + ":N" + index].Value = "- Người bệnh trả trong đó: " + (Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)) + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhTuTra))).ApplyFormatMoneyToDouble();

                            index++;
                            worksheet.Cells["A" + index + ":N" + index].Merge = true;
                            worksheet.Cells["A" + index + ":N" + index].Value = "+ Cùng chi trả trong phạm vi BHYT: " + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble(true);

                            index++;
                            worksheet.Cells["A" + index + ":N" + index].Merge = true;
                            worksheet.Cells["A" + index + ":N" + index].Value = "+ Các khoản phải trả khác: " + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true);

                            index++;
                            worksheet.Cells["A" + index + ":N" + index].Merge = true;
                            worksheet.Cells["A" + index + ":N" + index].Value = "+ Nguồn khác: " + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble(true);


                            index = index + 2;

                            worksheet.Cells["D" + index + ":F" + index].Style.Font.SetFromFont(new Font("Times New Roman", 12));
                            worksheet.Cells["D" + index + ":F" + index].Merge = true;
                            worksheet.Cells["D" + index + ":F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                            worksheet.Cells["D" + index + ":F" + index].Style.VerticalAlignment = ExcelVerticalAlignment.Top;
                            worksheet.Cells["D" + index + ":F" + index].Value = $"Ngày {DateTime.Now.Day} tháng {DateTime.Now.Month} năm {DateTime.Now.Year}";

                            worksheet.Cells["G" + index + ":I" + index].Style.Font.SetFromFont(new Font("Times New Roman", 12));
                            worksheet.Cells["G" + index + ":I" + index].Merge = true;
                            worksheet.Cells["G" + index + ":I" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                            worksheet.Cells["G" + index + ":I" + index].Style.VerticalAlignment = ExcelVerticalAlignment.Top;
                            worksheet.Cells["G" + index + ":I" + index].Value = $"Ngày {DateTime.Now.Day} tháng {DateTime.Now.Month} năm {DateTime.Now.Year}";

                            worksheet.Cells["J" + index + ":N" + index].Style.Font.Bold = true;
                            worksheet.Cells["J" + index + ":N" + index].Merge = true;
                            worksheet.Cells["J" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                            worksheet.Cells["J" + index + ":N" + index].Value = "XÁC NHẬN CỦA NGƯỜI BỆNH ";

                            index++;

                            worksheet.Cells["A" + index + ":C" + index].Style.Font.Bold = true;
                            worksheet.Cells["A" + index + ":C" + index].Merge = true;
                            worksheet.Cells["A" + index + ":C" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                            worksheet.Cells["A" + index + ":C" + index].Value = "NGƯỜI LẬP BẢNG KÊ";

                            worksheet.Cells["D" + index + ":F" + index].Style.Font.Bold = true;
                            worksheet.Cells["D" + index + ":F" + index].Merge = true;
                            worksheet.Cells["D" + index + ":F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                            worksheet.Cells["D" + index + ":F" + index].Value = "KẾ TOÁN VIỆN PHÍ";

                            worksheet.Cells["G" + index + ":I" + index].Style.Font.Bold = true;
                            worksheet.Cells["G" + index + ":I" + index].Merge = true;
                            worksheet.Cells["G" + index + ":I" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                            worksheet.Cells["G" + index + ":I" + index].Value = "GIÁM ĐỊNH BHYT";

                            worksheet.Cells["J" + index + ":N" + index].Style.Font.Bold = true;
                            worksheet.Cells["J" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                            worksheet.Cells["J" + index + ":N" + index].Merge = true;
                            worksheet.Cells["J" + index + ":N" + index].Value = "(Ký , Ghi rõ họ tên)";

                            index++;

                            worksheet.Cells["A" + index + ":C" + index].Style.Font.Bold = true;
                            worksheet.Cells["A" + index + ":C" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                            worksheet.Cells["A" + index + ":C" + index].Merge = true;
                            worksheet.Cells["A" + index + ":C" + index].Value = "(Ký , Ghi rõ họ tên)";


                            worksheet.Cells["D" + index + ":F" + index].Style.Font.Bold = true;
                            worksheet.Cells["D" + index + ":F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                            worksheet.Cells["D" + index + ":F" + index].Merge = true;
                            worksheet.Cells["D" + index + ":F" + index].Value = "(Ký , Ghi rõ họ tên)";

                            worksheet.Cells["G" + index + ":I" + index].Style.Font.Bold = true;
                            worksheet.Cells["G" + index + ":I" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                            worksheet.Cells["G" + index + ":I" + index].Merge = true;
                            worksheet.Cells["G" + index + ":I" + index].Value = "(Ký , Ghi rõ họ tên)";

                            worksheet.Cells["J" + index + ":N" + index].Style.Font.Bold = true;
                            worksheet.Cells["J" + index + ":N" + index].Merge = true;
                            worksheet.Cells["J" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                            worksheet.Cells["J" + index + ":N" + index].Value = "(Tôi đã nhận...phim...Xquang / CT / MRI)";

                            xlPackage.Save();
                        }
                    }
                    else
                    {
                        YeuCauTiepNhanTheBHYT theBHYTChiTra = null;
                        var maSoThe = groupChiPhiTheoThe.Where(o => o.Key != string.Empty).FirstOrDefault()?.Key;
                        if (!string.IsNullOrEmpty(maSoThe))
                        {
                            theBHYTChiTra = yeuCauTiepNhan.YeuCauTiepNhanTheBHYTs.First(o => o.MaSoThe == maSoThe);
                        }

                        var chiPhis = groupChiPhiTheoThe.SelectMany(o => o).ToList();
                        var mucHuongPT = theBHYTChiTra != null && theBHYTChiTra?.MucHuong > 0 ? theBHYTChiTra?.MucHuong + "%" : string.Empty;

                        using (var range = worksheet.Cells["A21:C21"])
                        {
                            range.Worksheet.Cells["A21:C21"].Merge = true;
                            range.Worksheet.Cells["A21:C21"].Style.WrapText = true;
                            var title = range.Worksheet.Cells["A21:C21"].RichText.Add("Mã thẻ BHYT: ");
                            var value = range.Worksheet.Cells["A21:C21"].RichText.Add(maBHYT);
                            value.Bold = true;

                            range.Worksheet.Cells["A21:C21"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                            range.Worksheet.Cells["A21:C21"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                            range.Worksheet.Cells["A21:C21"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                            range.Worksheet.Cells["A21:C21"].Style.Font.Color.SetColor(Color.Black);
                        }
                        using (var range = worksheet.Cells["A21:N21"])
                        {
                            range.Worksheet.Cells["D" + index + ":F" + index].Merge = true;
                            range.Worksheet.Cells["D" + index + ":F" + index].Style.WrapText = true;
                            var title = range.Worksheet.Cells["D" + index + ":F" + index].RichText.Add("Giá trị từ: ");
                            var valuebHYTTuNgay = range.Worksheet.Cells["D" + index + ":F" + index].RichText.Add(bHYTTuNgay);
                            valuebHYTTuNgay.Bold = true;

                            var den = range.Worksheet.Cells["D" + index + ":F" + index].RichText.Add(" đến: ");
                            den.Bold = false;
                            var valuebHYTDenNgay = range.Worksheet.Cells["D" + index + ":F" + index].RichText.Add(bHYTDenNgay);
                            valuebHYTDenNgay.Bold = true;

                            range.Worksheet.Cells["D" + index + ":F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                            range.Worksheet.Cells["D" + index + ":F" + index].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                            range.Worksheet.Cells["D" + index + ":F" + index].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                            range.Worksheet.Cells["D" + index + ":F" + index].Style.Font.Color.SetColor(Color.Black);
                        }
                        using (var range = worksheet.Cells["G21:J21"])
                        {
                            range.Worksheet.Cells["G21:J21"].Merge = true;
                            range.Worksheet.Cells["G21:J21"].Style.WrapText = true;
                            var title = range.Worksheet.Cells["G21:J21"].RichText.Add("Mức hưởng: ");
                            var value = range.Worksheet.Cells["G21:J21"].RichText.Add(mucHuong);
                            value.Bold = true;


                            range.Worksheet.Cells["G21:J21"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                            range.Worksheet.Cells["G21:J21"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                            range.Worksheet.Cells["G21:J21"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                            range.Worksheet.Cells["G21:J21"].Style.Font.Color.SetColor(Color.Black);
                        }
                        using (var range = worksheet.Cells["A22:N23"])
                        {
                            range.Worksheet.Cells["A22:N23"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                            range.Worksheet.Cells["A22:N23"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                            range.Worksheet.Cells["A22:N23"].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                            range.Worksheet.Cells["A22:N23"].Style.Font.Color.SetColor(Color.Black);
                            range.Worksheet.Cells["A22:N23"].Style.Font.Bold = true;
                            range.Worksheet.Cells["A22:N23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);

                            range.Worksheet.Cells["A22:A23"].Merge = true;
                            range.Worksheet.Cells["A22:A23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["A22:A23"].Value = "STT";

                            range.Worksheet.Cells["B22:B23"].Merge = true;
                            range.Worksheet.Cells["B22:B23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["B22:B23"].Value = "Nội dung";

                            range.Worksheet.Cells["C22:C23"].Merge = true;
                            range.Worksheet.Cells["C22:C23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["C22:C23"].Value = "Đơn vị tính";

                            range.Worksheet.Cells["D22:D23"].Merge = true;
                            range.Worksheet.Cells["D22:D23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["D22:D23"].Value = "Số lượng";

                            range.Worksheet.Cells["E22:E23"].Merge = true;
                            range.Worksheet.Cells["E22:E23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["E22:E23"].Value = "Đơn giá BV(đồng)";

                            range.Worksheet.Cells["F22:F23"].Merge = true;
                            range.Worksheet.Cells["F22:F23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["F22:F23"].Value = "Đơn giá BH(đồng)";

                            range.Worksheet.Cells["G22:G23"].Merge = true;
                            range.Worksheet.Cells["G22:G23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["G22:G23"].Value = "Tỉ lệ thanh toán theo dịch vụ (%)";

                            range.Worksheet.Cells["H22:H23"].Merge = true;
                            range.Worksheet.Cells["H22:H23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["H22:H23"].Value = "Thành tiền BV (đồng)";

                            range.Worksheet.Cells["I22:I23"].Merge = true;
                            range.Worksheet.Cells["I22:I23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["I22:I23"].Value = "Tỷ lệ thanh toán BHYT (%)";

                            range.Worksheet.Cells["J22:J23"].Merge = true;
                            range.Worksheet.Cells["J22:J23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["J22:J23"].Value = "Thành tiền BH(đồng)";

                            range.Worksheet.Cells["K22:N22"].Merge = true;
                            range.Worksheet.Cells["K22:N22"].Value = "Nguồn thanh toán (đồng)";

                            range.Worksheet.Cells["K23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["K23"].Value = "Quỹ BHYT";

                            range.Worksheet.Cells["L23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["L23"].Value = "Người bệnh cùng chi trả (đồng)";

                            range.Worksheet.Cells["M23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["M23"].Value = "Khác (đồng)";

                            range.Worksheet.Cells["N23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["N23"].Value = "Người bệnh tự trả(đồng)";
                        }


                        index = index + 3;

                        foreach (var chiPhi in chiPhis.Where(c => c.NhomChiPhiBangKe != NhomChiPhiBangKe.GoiVatTu).GroupBy(c => new { c.NhomChiPhiBangKe, c.TenDichVu, c.DonViTinh, c.DuocHuongBHYT, c.DonGia, c.DonGiaBHYT, c.MucHuongBaoHiem, c.TiLeBaoHiemThanhToan }).OrderByDescending(o => o.Key.DuocHuongBHYT))
                        {
                            dsChiPhiBangKe.Add(new BangKeKhamBenhCoBHYTVo
                            {
                                Nhom = chiPhi.Key.NhomChiPhiBangKe,
                                Id = chiPhi.FirstOrDefault().Id,
                                NoiDung = chiPhi.Key.TenDichVu,
                                DonViTinh = chiPhi.Key.DonViTinh,
                                SoLuong = (decimal)chiPhi.Sum(c => c.Soluong),
                                DuocHuongBaoHiem = chiPhi.Key.DuocHuongBHYT,
                                DonGiaBH = chiPhi.Key.DonGiaBHYT,
                                DonGiaTheoBV = chiPhi.Key.DonGia,
                                MucHuongBaoHiem = chiPhi.Key.MucHuongBaoHiem,
                                TiLeThanhToanTheoDV = chiPhi.Key.TiLeBaoHiemThanhToan,
                                BaoHiemChiTra = true
                            });
                        }

                        foreach (var chiPhi in chiPhis.Where(c => c.NhomChiPhiBangKe == NhomChiPhiBangKe.GoiVatTu).OrderByDescending(o => o.DuocHuongBHYT))
                        {
                            dsChiPhiBangKe.Add(new BangKeKhamBenhCoBHYTVo
                            {
                                Nhom = chiPhi.NhomChiPhiBangKe,
                                Id = chiPhi.Id,
                                NoiDung = chiPhi.TenDichVu,
                                DonViTinh = chiPhi.DonViTinh,
                                SoLuong = (decimal)chiPhi.Soluong,
                                DuocHuongBaoHiem = chiPhi.DuocHuongBHYT,
                                DonGiaBH = chiPhi.DonGiaBHYT,
                                DonGiaTheoBV = chiPhi.DonGia,
                                MucHuongBaoHiem = chiPhi.MucHuongBaoHiem,
                                TiLeThanhToanTheoDV = chiPhi.TiLeBaoHiemThanhToan,
                                BaoHiemChiTra = true
                            });
                        }
                        var groupChiPhiBangKes = dsChiPhiBangKe.GroupBy(x => x.Nhom).OrderBy(o => (int)o.Key * (o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay || o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriNoiTru ? 1 : 10));
                        foreach (var groupChiPhiBangKe in groupChiPhiBangKes)
                        {
                            if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay)
                            {

                                worksheet.Cells["A" + index + ":N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["A" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                worksheet.Cells["A" + index + ":N" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                worksheet.Cells["A" + index + ":N" + index].Merge = true;
                                worksheet.Cells["A" + index + ":N" + index].Value = "2. Ngày giường:";
                                worksheet.Cells["A" + index + ":N" + index].Style.Font.Bold = true;

                                index++;

                                worksheet.Cells["A" + index + ":G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["A" + index + ":G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                worksheet.Cells["A" + index + ":G" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                worksheet.Cells["A" + index + ":G" + index].Merge = true;
                                worksheet.Cells["A" + index + ":G" + index].Value = "2.1." + groupChiPhiBangKe.Key.GetDescription();
                                worksheet.Cells["A" + index + ":G" + index].Style.Font.Bold = true;

                                worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["H" + index].Style.Font.Bold = true;
                                worksheet.Cells["H" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBV);

                                worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["J" + index].Style.Font.Bold = true;
                                worksheet.Cells["J" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBH);

                                worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["K" + index].Style.Font.Bold = true;
                                worksheet.Cells["K" + index].Value = groupChiPhiBangKe.Sum(o => o.QuyBHYT);

                                worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["L" + index].Style.Font.Bold = true;
                                worksheet.Cells["L" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra);

                                worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["M" + index].Style.Font.Bold = true;
                                worksheet.Cells["M" + index].Value = groupChiPhiBangKe.Sum(o => o.Khac);

                                worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["N" + index].Style.Font.Bold = true;
                                worksheet.Cells["N" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra);

                                index++;
                            }
                            else if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.NgayGiuongDieuTriNoiTru)
                            {
                                if (!groupChiPhiBangKes.Any(o => o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay))
                                {
                                    worksheet.Cells["A" + index + ":N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["A" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                    worksheet.Cells["A" + index + ":N" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                    worksheet.Cells["A" + index + ":N" + index].Merge = true;
                                    worksheet.Cells["A" + index + ":N" + index].Value = "2. Ngày giường:";
                                    worksheet.Cells["A" + index + ":N" + index].Style.Font.Bold = true;

                                }

                                index++;

                                worksheet.Cells["A" + index + ":G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["A" + index + ":G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                worksheet.Cells["A" + index + ":G" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                worksheet.Cells["A" + index + ":G" + index].Merge = true;
                                worksheet.Cells["A" + index + ":G" + index].Value = "2.2." + groupChiPhiBangKe.Key.GetDescription();
                                worksheet.Cells["A" + index + ":G" + index].Style.Font.Bold = true;

                                worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["H" + index].Style.Font.Bold = true;
                                worksheet.Cells["H" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBV);

                                worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["J" + index].Style.Font.Bold = true;
                                worksheet.Cells["J" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBH);

                                worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["K" + index].Style.Font.Bold = true;
                                worksheet.Cells["K" + index].Value = groupChiPhiBangKe.Sum(o => o.QuyBHYT);

                                worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["L" + index].Style.Font.Bold = true;
                                worksheet.Cells["L" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra);

                                worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["M" + index].Style.Font.Bold = true;
                                worksheet.Cells["M" + index].Value = groupChiPhiBangKe.Sum(o => o.Khac);

                                worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["N" + index].Style.Font.Bold = true;
                                worksheet.Cells["N" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra);

                                index++;
                            }
                            else
                            {
                                worksheet.Cells["A" + index + ":G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["A" + index + ":G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                worksheet.Cells["A" + index + ":G" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                worksheet.Cells["A" + index + ":G" + index].Merge = true;
                                worksheet.Cells["A" + index + ":G" + index].Value = (int)groupChiPhiBangKe.Key + "." + groupChiPhiBangKe.Key.GetDescription();
                                worksheet.Cells["A" + index + ":G" + index].Style.Font.Bold = true;

                                worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["H" + index].Style.Font.Bold = true;
                                worksheet.Cells["H" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBV);

                                worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["J" + index].Style.Font.Bold = true;
                                worksheet.Cells["J" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBH);

                                worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["K" + index].Style.Font.Bold = true;
                                worksheet.Cells["K" + index].Value = groupChiPhiBangKe.Sum(o => o.QuyBHYT);

                                worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["L" + index].Style.Font.Bold = true;
                                worksheet.Cells["L" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra);

                                worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["M" + index].Style.Font.Bold = true;
                                worksheet.Cells["M" + index].Value = groupChiPhiBangKe.Sum(o => o.Khac);

                                worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["N" + index].Style.Font.Bold = true;
                                worksheet.Cells["N" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra);

                                index++;
                            }
                            if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.GoiVatTu)
                            {
                                var groupGoiVatTus = groupChiPhiBangKe.ToList().GroupBy(o => o.SoGoiVatTu.GetValueOrDefault()).OrderBy(o => o.Key);
                                int sttGoiVatTu = 1;
                                foreach (var groupGoiVatTu in groupGoiVatTus)
                                {
                                    worksheet.Cells["A" + index + ":G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["A" + index + ":G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                    worksheet.Cells["A" + index + ":G" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                    worksheet.Cells["A" + index + ":G" + index].Value = "10." + sttGoiVatTu + ". " + groupChiPhiBangKe.Key.GetDescription() + " " + sttGoiVatTu;
                                    worksheet.Cells["A" + index + ":G" + index].Style.Font.Bold = true;
                                    worksheet.Cells["A" + index + ":G" + index].Merge = true;

                                    worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["H" + index].Style.Font.Bold = true;
                                    worksheet.Cells["H" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBV);

                                    worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["J" + index].Style.Font.Bold = true;
                                    worksheet.Cells["J" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBH);

                                    worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["K" + index].Style.Font.Bold = true;
                                    worksheet.Cells["K" + index].Value = groupChiPhiBangKe.Sum(o => o.QuyBHYT);

                                    worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["L" + index].Style.Font.Bold = true;
                                    worksheet.Cells["L" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra);

                                    worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["M" + index].Style.Font.Bold = true;
                                    worksheet.Cells["M" + index].Value = groupChiPhiBangKe.Sum(o => o.Khac);

                                    worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["N" + index].Style.Font.Bold = true;
                                    worksheet.Cells["N" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra);
                                    index++;
                                    foreach (var chiPhiBangKe in groupGoiVatTu)
                                    {
                                        worksheet.Cells["A" + index + ":N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["A" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                        worksheet.Cells["A" + index + ":N" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));

                                        worksheet.Cells["A" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["A" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                        worksheet.Cells["A" + index].Value = indexItem;

                                        worksheet.Cells["B" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["B" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                        worksheet.Cells["B" + index].Value = chiPhiBangKe.NoiDung;

                                        worksheet.Cells["C" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["C" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                        worksheet.Cells["C" + index].Value = chiPhiBangKe.DonViTinh;

                                        worksheet.Cells["D" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["D" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                        worksheet.Cells["D" + index].Value = chiPhiBangKe.SoLuong;

                                        worksheet.Cells["E" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["E" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["E" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["E" + index].Value = chiPhiBangKe.DonGiaBV;

                                        worksheet.Cells["F" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["F" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["F" + index].Value = chiPhiBangKe.DonGiaBH;

                                        worksheet.Cells["G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["G" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["G" + index].Value = chiPhiBangKe.TiLeThanhToanTheoDV;

                                        worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["H" + index].Value = chiPhiBangKe.ThanhTienBV;

                                        worksheet.Cells["I" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["I" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["I" + index].Value = Convert.ToDouble(chiPhiBangKe.MucHuongBaoHiem > 0 ? 100 : 0).ApplyFormatMoneyToDouble();


                                        worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["J" + index].Value = chiPhiBangKe.ThanhTienBH;


                                        worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["K" + index].Value = chiPhiBangKe.QuyBHYT;


                                        worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["L" + index].Value = chiPhiBangKe.NguoiBenhCungChiTra;


                                        worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["M" + index].Value = chiPhiBangKe.Khac;


                                        worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["N" + index].Value = chiPhiBangKe.NguoiBenhTuTra;

                                        indexItem++;
                                        index++;
                                    }
                                }
                            }
                            else
                            {
                                foreach (var chiPhiBangKe in groupChiPhiBangKe)
                                {
                                    worksheet.Cells["A" + index + ":N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["A" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                    worksheet.Cells["A" + index + ":N" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));

                                    worksheet.Cells["A" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["A" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                    worksheet.Cells["A" + index].Value = indexItem;

                                    worksheet.Cells["B" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["B" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                    worksheet.Cells["B" + index].Value = chiPhiBangKe.NoiDung;

                                    worksheet.Cells["C" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["C" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                    worksheet.Cells["C" + index].Value = chiPhiBangKe.DonViTinh;

                                    worksheet.Cells["D" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["D" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                    worksheet.Cells["D" + index].Value = chiPhiBangKe.SoLuong;

                                    worksheet.Cells["E" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["E" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["E" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["E" + index].Value = chiPhiBangKe.DonGiaBV;

                                    worksheet.Cells["F" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["F" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["F" + index].Value = chiPhiBangKe.DonGiaBH;

                                    worksheet.Cells["G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["G" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["G" + index].Value = chiPhiBangKe.TiLeThanhToanTheoDV;

                                    worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["H" + index].Value = chiPhiBangKe.ThanhTienBV;

                                    worksheet.Cells["I" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["I" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["I" + index].Value = Convert.ToDouble(chiPhiBangKe.MucHuongBaoHiem > 0 ? 100 : 0).ApplyFormatMoneyToDouble();


                                    worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["J" + index].Value = chiPhiBangKe.ThanhTienBH;


                                    worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["K" + index].Value = chiPhiBangKe.QuyBHYT;


                                    worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["L" + index].Value = chiPhiBangKe.NguoiBenhCungChiTra;


                                    worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["M" + index].Value = chiPhiBangKe.Khac;


                                    worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["N" + index].Value = chiPhiBangKe.NguoiBenhTuTra;

                                    indexItem++;
                                    index++;
                                }
                            }

                        }

                        worksheet.Cells["A" + index + ":G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        worksheet.Cells["A" + index + ":G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        worksheet.Cells["A" + index + ":G" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                        worksheet.Cells["A" + index + ":G" + index].Merge = true;
                        worksheet.Cells["A" + index + ":G" + index].Value = "Tổng cộng";
                        worksheet.Cells["A" + index + ":G" + index].Style.Font.Bold = true;

                        worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                        worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                        worksheet.Cells["H" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.ThanhTienBV)).Sum();

                        worksheet.Cells["I" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        worksheet.Cells["I" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;

                        worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                        worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                        worksheet.Cells["J" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.ThanhTienBH)).Sum();

                        worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                        worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                        worksheet.Cells["K" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.QuyBHYT)).Sum();

                        worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                        worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                        worksheet.Cells["L" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.NguoiBenhCungChiTra)).Sum();

                        worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                        worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                        worksheet.Cells["M" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.Khac)).Sum();

                        worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                        worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                        worksheet.Cells["N" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.NguoiBenhTuTra)).Sum();

                        index++;

                        worksheet.Cells["A" + index + ":N" + index].Merge = true;
                        worksheet.Cells["A" + index + ":N" + index].Value = "Tổng chi phí lần khám bệnh/cả đợt điều trị: " + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble() + " đồng";
                        worksheet.Cells["A" + index + ":N" + index].Style.Font.Bold = true;

                        index++;

                        worksheet.Cells["A" + index + ":N" + index].Merge = true;
                        worksheet.Cells["A" + index + ":N" + index].Value = "(Viết bằng chữ: " + NumberHelper.ChuyenSoRaText(Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBH))) + ")";

                        index++;

                        worksheet.Cells["A" + index + ":N" + index].Merge = true;
                        worksheet.Cells["A" + index + ":N" + index].Value = "Trong đó , số tiền do:";
                        worksheet.Cells["A" + index + ":N" + index].Style.Font.Bold = true;

                        index++;
                        worksheet.Cells["A" + index + ":N" + index].Merge = true;
                        worksheet.Cells["A" + index + ":N" + index].Value = "- Quỹ BHYT thanh toán: " + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble();

                        index++;
                        worksheet.Cells["A" + index + ":N" + index].Merge = true;
                        worksheet.Cells["A" + index + ":N" + index].Value = "- Người bệnh trả trong đó: " + (Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)) + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhTuTra))).ApplyFormatMoneyToDouble();

                        index++;
                        worksheet.Cells["A" + index + ":N" + index].Merge = true;
                        worksheet.Cells["A" + index + ":N" + index].Value = "+ Cùng chi trả trong phạm vi BHYT: " + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble(true);

                        index++;
                        worksheet.Cells["A" + index + ":N" + index].Merge = true;
                        worksheet.Cells["A" + index + ":N" + index].Value = "+ Các khoản phải trả khác: " + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true);

                        index++;
                        worksheet.Cells["A" + index + ":N" + index].Merge = true;
                        worksheet.Cells["A" + index + ":N" + index].Value = "+ Nguồn khác: " + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble(true);


                        index = index + 2;

                        worksheet.Cells["D" + index + ":F" + index].Style.Font.SetFromFont(new Font("Times New Roman", 12));
                        worksheet.Cells["D" + index + ":F" + index].Merge = true;
                        worksheet.Cells["D" + index + ":F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        worksheet.Cells["D" + index + ":F" + index].Style.VerticalAlignment = ExcelVerticalAlignment.Top;
                        worksheet.Cells["D" + index + ":F" + index].Value = $"Ngày {DateTime.Now.Day} tháng {DateTime.Now.Month} năm {DateTime.Now.Year}";

                        worksheet.Cells["G" + index + ":I" + index].Style.Font.SetFromFont(new Font("Times New Roman", 12));
                        worksheet.Cells["G" + index + ":I" + index].Merge = true;
                        worksheet.Cells["G" + index + ":I" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        worksheet.Cells["G" + index + ":I" + index].Style.VerticalAlignment = ExcelVerticalAlignment.Top;
                        worksheet.Cells["G" + index + ":I" + index].Value = $"Ngày {DateTime.Now.Day} tháng {DateTime.Now.Month} năm {DateTime.Now.Year}";

                        worksheet.Cells["J" + index + ":N" + index].Style.Font.Bold = true;
                        worksheet.Cells["J" + index + ":N" + index].Merge = true;
                        worksheet.Cells["J" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        worksheet.Cells["J" + index + ":N" + index].Value = "XÁC NHẬN CỦA NGƯỜI BỆNH ";

                        index++;

                        worksheet.Cells["A" + index + ":C" + index].Style.Font.Bold = true;
                        worksheet.Cells["A" + index + ":C" + index].Merge = true;
                        worksheet.Cells["A" + index + ":C" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        worksheet.Cells["A" + index + ":C" + index].Value = "NGƯỜI LẬP BẢNG KÊ";

                        worksheet.Cells["D" + index + ":F" + index].Style.Font.Bold = true;
                        worksheet.Cells["D" + index + ":F" + index].Merge = true;
                        worksheet.Cells["D" + index + ":F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        worksheet.Cells["D" + index + ":F" + index].Value = "KẾ TOÁN VIỆN PHÍ";

                        worksheet.Cells["G" + index + ":I" + index].Style.Font.Bold = true;
                        worksheet.Cells["G" + index + ":I" + index].Merge = true;
                        worksheet.Cells["G" + index + ":I" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        worksheet.Cells["G" + index + ":I" + index].Value = "GIÁM ĐỊNH BHYT";

                        worksheet.Cells["J" + index + ":N" + index].Style.Font.Bold = true;
                        worksheet.Cells["J" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        worksheet.Cells["J" + index + ":N" + index].Merge = true;
                        worksheet.Cells["J" + index + ":N" + index].Value = "(Ký , Ghi rõ họ tên)";

                        index++;

                        worksheet.Cells["A" + index + ":C" + index].Style.Font.Bold = true;
                        worksheet.Cells["A" + index + ":C" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        worksheet.Cells["A" + index + ":C" + index].Merge = true;
                        worksheet.Cells["A" + index + ":C" + index].Value = "(Ký , Ghi rõ họ tên)";


                        worksheet.Cells["D" + index + ":F" + index].Style.Font.Bold = true;
                        worksheet.Cells["D" + index + ":F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        worksheet.Cells["D" + index + ":F" + index].Merge = true;
                        worksheet.Cells["D" + index + ":F" + index].Value = "(Ký , Ghi rõ họ tên)";

                        worksheet.Cells["G" + index + ":I" + index].Style.Font.Bold = true;
                        worksheet.Cells["G" + index + ":I" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        worksheet.Cells["G" + index + ":I" + index].Merge = true;
                        worksheet.Cells["G" + index + ":I" + index].Value = "(Ký , Ghi rõ họ tên)";

                        worksheet.Cells["J" + index + ":N" + index].Style.Font.Bold = true;
                        worksheet.Cells["J" + index + ":N" + index].Merge = true;
                        worksheet.Cells["J" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        worksheet.Cells["J" + index + ":N" + index].Value = "(Tôi đã nhận...phim...Xquang / CT / MRI)";

                        xlPackage.Save();

                    }
                }

                return stream.ToArray();
            }
        }

        public byte[] XuatBangKeChuaQuyetToan(long yeuCauTiepNhanId)
        {
            var danhSachChiPhi = GetTatCaDichVuKhamChuaBenh(yeuCauTiepNhanId).Result.Where(o => !o.Soluong.AlmostEqual(0) && o.YeuCauGoiDichVuId == null).ToList();
            if (danhSachChiPhi.Count == 0)
            {
                return null;
            }
            var yeuCauTiepNhan = BaseRepository.GetById(yeuCauTiepNhanId,
                x => x.Include(o => o.NoiTruBenhAn).ThenInclude(o => o.ChuyenDenBenhVien)
                    .Include(o => o.NoiTruBenhAn).ThenInclude(o => o.KhoaPhongNhapVien)
                    .Include(o => o.NoiTruBenhAn).ThenInclude(o => o.ChanDoanChinhRaVienICD)
                    .Include(o => o.YeuCauTiepNhanTheBHYTs)
                    .Include(o => o.YeuCauNhapVien).ThenInclude(o => o.YeuCauKhamBenh).ThenInclude(o => o.YeuCauTiepNhan)
                    .Include(o => o.BenhNhan)
                    .Include(o => o.PhuongXa)
                    .Include(o => o.QuanHuyen)
                    .Include(o => o.TinhThanh)
                    .Include(o => o.NoiTruBenhAn).ThenInclude(o => o.NoiTruPhieuDieuTris).ThenInclude(o => o.NoiTruThamKhamChanDoanKemTheos).ThenInclude(c => c.ICD)
                    .Include(o => o.NoiTruBenhAn).ThenInclude(o => o.NoiTruPhieuDieuTris).ThenInclude(c => c.ChanDoanChinhICD)
                    .Include(o => o.NoiChuyen).Include(o => o.NoiTruBenhAn).ThenInclude(o => o.NoiTruKhoaPhongDieuTris).ThenInclude(c => c.KhoaPhongChuyenDen));

            var benhVien = new Core.Domain.Entities.BenhVien.BenhVien();

            string maBHYT = string.Empty;
            string bHYTTuNgay = string.Empty;
            string bHYTDenNgay = string.Empty;
            string mucHuong = string.Empty;
            string NoiDKKCBBanDau = string.Empty;
            string MaKCBBanDau = string.Empty;


            string maICDKemTheo = string.Empty;
            string tenICDKemTheo = string.Empty;
            string chuanDoanXacDinhSanKhoa = string.Empty;
            string maICD10 = string.Empty;

            if (yeuCauTiepNhan.NoiTruBenhAn != null && (yeuCauTiepNhan.NoiTruBenhAn.LoaiBenhAn == LoaiBenhAn.SanKhoaMo || yeuCauTiepNhan.NoiTruBenhAn.LoaiBenhAn == LoaiBenhAn.SanKhoaThuong))
            {
                if (yeuCauTiepNhan.NoiTruBenhAn?.NoiTruPhieuDieuTris.Count() > 0)
                {
                    var phieuDieuTri = yeuCauTiepNhan.NoiTruBenhAn?.NoiTruPhieuDieuTris.OrderByDescending(c => c.NgayDieuTri).FirstOrDefault();

                    var icdKemTheoIds = phieuDieuTri.NoiTruThamKhamChanDoanKemTheos.Select(c => c.ICD.Ma);
                    var tenICDKemTheos = phieuDieuTri.NoiTruThamKhamChanDoanKemTheos.Select(c => c.GhiChu);

                    maICDKemTheo = string.Join(", ", icdKemTheoIds);
                    tenICDKemTheo = string.Join(", ", tenICDKemTheos);

                    maICD10 = phieuDieuTri.ChanDoanChinhICD?.Ma;
                    chuanDoanXacDinhSanKhoa = phieuDieuTri.ChanDoanChinhGhiChu;
                }
            }
            else
            {
                if (!string.IsNullOrEmpty(yeuCauTiepNhan.NoiTruBenhAn?.DanhSachChanDoanKemTheoRaVienICDId))
                {
                    var maICDKemTheos = new List<string>();

                    var icdKemTheoIds = yeuCauTiepNhan.NoiTruBenhAn?.DanhSachChanDoanKemTheoRaVienICDId.Split(Constants.ICDSeparator);
                    var tenICDKemTheos = yeuCauTiepNhan.NoiTruBenhAn?.DanhSachChanDoanKemTheoRaVienGhiChu?.Split(Constants.ICDSeparator);

                    if (icdKemTheoIds.Length > 0)
                    {
                        foreach (var icdKemTheoId in icdKemTheoIds)
                        {
                            var icdKemTheo = _icdRepository.TableNoTracking.FirstOrDefault(o => o.Id == long.Parse(icdKemTheoId));
                            if (icdKemTheo != null)
                            {
                                maICDKemTheos.Add(icdKemTheo.Ma);
                            }
                        }
                    }

                    maICDKemTheo = string.Join(", ", maICDKemTheos);
                    tenICDKemTheo = string.Join(", ", tenICDKemTheos);
                }
            }

            YeuCauTiepNhanTheBHYT theBHYT = null;
            if (yeuCauTiepNhan.CoBHYT == true && yeuCauTiepNhan.YeuCauTiepNhanTheBHYTs.Any())
            {
                theBHYT = yeuCauTiepNhan.YeuCauTiepNhanTheBHYTs.First();
                if (!String.IsNullOrEmpty(theBHYT.MaDKBD))
                {
                    benhVien = _benhVienRepository.TableNoTracking.FirstOrDefault(p => p.Ma.Equals(theBHYT.MaDKBD));
                }
                maBHYT = theBHYT.MaSoThe;
                bHYTTuNgay = theBHYT.NgayHieuLuc.ApplyFormatDate();
                bHYTDenNgay = theBHYT.NgayHetHan?.ApplyFormatDate();
                mucHuong = theBHYT.MucHuong.ToString() + "%";
                NoiDKKCBBanDau = benhVien != null ? benhVien?.Ten : "Chưa xác định";
                MaKCBBanDau = theBHYT.MaDKBD;
            }
            else
            {
                maBHYT = "";
                bHYTTuNgay = "";
                bHYTDenNgay = "";
                mucHuong = "0%";
                NoiDKKCBBanDau = "Chưa xác định";
                MaKCBBanDau = "Chưa xác định";
            }

            var dsChiPhiBangKe = new List<BangKeKhamBenhBenhVienVo>();
            var dateItemChiPhis = string.Empty;
            int indexItem = 1;

            using (var stream = new MemoryStream())
            {
                using (var xlPackage = new ExcelPackage(stream))
                {

                    var worksheet = xlPackage.Workbook.Worksheets.Add("BẢNG KÊ CHI PHÍ ĐIỀU TRỊ NỘI TRÚ 3");

                    // set row
                    worksheet.Row(9).Height = 24.5;
                    worksheet.DefaultRowHeight = 16;

                    //SET chiều rộng cho từng cột tương ứng
                    worksheet.Column(1).Width = 10;
                    worksheet.Column(2).Width = 25;
                    worksheet.Column(3).Width = 15;
                    worksheet.Column(4).Width = 15;
                    worksheet.Column(5).Width = 15;
                    worksheet.Column(6).Width = 15;
                    worksheet.Column(7).Width = 15;
                    worksheet.Column(8).Width = 15;
                    worksheet.Column(9).Width = 15;
                    worksheet.Column(10).Width = 15;
                    worksheet.Column(11).Width = 15;
                    worksheet.Column(12).Width = 15;
                    worksheet.Column(13).Width = 15;
                    worksheet.Column(14).Width = 15;

                    worksheet.DefaultColWidth = 7;

                    using (var range = worksheet.Cells["A1:C1"])
                    {
                        range.Worksheet.Cells["A1:C1"].Merge = true;
                        range.Worksheet.Cells["A1:C1"].Value = "CƠ SỞ KHÁM CHỮA BỆNH : BỆNH VIỆN ĐKQT BẮC HÀ";
                        range.Worksheet.Cells["A1:C1"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A1:C1"].Style.VerticalAlignment = ExcelVerticalAlignment.Bottom;
                        range.Worksheet.Cells["A1:C1"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A1:C1"].Style.Font.Color.SetColor(Color.Black);
                    }


                    var khoaPhong = yeuCauTiepNhan.NoiTruBenhAn?.NoiTruKhoaPhongDieuTris.OrderByDescending(c => c.ThoiDiemVaoKhoa).Select(c => c.KhoaPhongChuyenDen).FirstOrDefault();
                    var chuyenKhoa = GetChuyenKhoa(khoaPhong?.Id); //BVHD-3792 
                    using (var range = worksheet.Cells["A2:C2"])
                    {
                        range.Worksheet.Cells["A2:C2"].Merge = true;
                        range.Worksheet.Cells["A2:C2"].Value = "Khoa: " + khoaPhong?.Ten;
                        range.Worksheet.Cells["A2:C2"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A2:C2"].Style.VerticalAlignment = ExcelVerticalAlignment.Bottom;
                        range.Worksheet.Cells["A2:C2"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A2:C2"].Style.Font.Color.SetColor(Color.Black);
                        range.Worksheet.Cells["A2:C2"].Style.Font.Bold = true;
                    }

                    using (var range = worksheet.Cells["A3:C3"])
                    {
                        range.Worksheet.Cells["A3:C3"].Merge = true;
                        range.Worksheet.Cells["A3:C3"].Value = "Mã khoa: " + chuyenKhoa?.Ma;
                        range.Worksheet.Cells["A3:C3"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A3:C3"].Style.VerticalAlignment = ExcelVerticalAlignment.Bottom;
                        range.Worksheet.Cells["A3:C3"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A3:C3"].Style.Font.Color.SetColor(Color.Black);
                        range.Worksheet.Cells["A3:C3"].Style.Font.Bold = true;
                    }

                    using (var range = worksheet.Cells["L1:N1"])
                    {
                        range.Worksheet.Cells["L1:N1"].Merge = true;
                        range.Worksheet.Cells["L1:N1"].Value = "Mẫu số : 01/KBCB ";
                        range.Worksheet.Cells["L1:N1"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                        range.Worksheet.Cells["L1:N1"].Style.VerticalAlignment = ExcelVerticalAlignment.Bottom;
                        range.Worksheet.Cells["L1:N1"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["L1:N1"].Style.Font.Color.SetColor(Color.Black);
                        range.Worksheet.Cells["L1:N1"].Style.Font.Bold = true;
                    }

                    using (var range = worksheet.Cells["L2:N2"])
                    {
                        range.Worksheet.Cells["L2:N2"].Merge = true;
                        range.Worksheet.Cells["L2:N2"].Value = "Mã số người bệnh: " + yeuCauTiepNhan.BenhNhan.MaBN;
                        range.Worksheet.Cells["L2:N2"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                        range.Worksheet.Cells["L2:N2"].Style.VerticalAlignment = ExcelVerticalAlignment.Bottom;
                        range.Worksheet.Cells["L2:N2"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["L2:N2"].Style.Font.Color.SetColor(Color.Black);
                        range.Worksheet.Cells["L2:N2"].Style.Font.Bold = true;
                    }

                    using (var range = worksheet.Cells["L3:N3"])
                    {
                        range.Worksheet.Cells["L3:N3"].Merge = true;
                        range.Worksheet.Cells["L3:N3"].Value = "Số khám bệnh:" + yeuCauTiepNhan.MaYeuCauTiepNhan;
                        range.Worksheet.Cells["L3:N3"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                        range.Worksheet.Cells["L3:N3"].Style.VerticalAlignment = ExcelVerticalAlignment.Bottom;
                        range.Worksheet.Cells["L3:N3"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["L3:N3"].Style.Font.Color.SetColor(Color.Black);
                        range.Worksheet.Cells["L3:N3"].Style.Font.Bold = true;
                    }

                    using (var range = worksheet.Cells["L4:N4"])
                    {
                        range.Worksheet.Cells["L4:N4"].Merge = true;
                        range.Worksheet.Cells["L4:N4"].Value = "Số bệnh án: " + yeuCauTiepNhan.NoiTruBenhAn?.SoBenhAn;
                        range.Worksheet.Cells["L4:N4"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                        range.Worksheet.Cells["L4:N4"].Style.VerticalAlignment = ExcelVerticalAlignment.Bottom;
                        range.Worksheet.Cells["L4:N4"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["L4:N4"].Style.Font.Color.SetColor(Color.Black);
                        range.Worksheet.Cells["L4:N4"].Style.Font.Bold = true;
                    }

                    using (var range = worksheet.Cells["A5:N6"])
                    {
                        range.Worksheet.Cells["A5:N6"].Merge = true;
                        range.Worksheet.Cells["A5:N6"].Value = "BẢNG KÊ CHI PHÍ ĐIỀU TRỊ NỘI TRÚ 3";
                        range.Worksheet.Cells["A5:N6"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        range.Worksheet.Cells["A5:N6"].Style.VerticalAlignment = ExcelVerticalAlignment.Bottom;
                        range.Worksheet.Cells["A5:N6"].Style.Font.SetFromFont(new Font("Times New Roman", 18));
                        range.Worksheet.Cells["A5:N6"].Style.Font.Color.SetColor(Color.Black);
                        range.Worksheet.Cells["A5:N6"].Style.Font.Bold = true;
                    }

                    using (var range = worksheet.Cells["A7:N7"])
                    {
                        range.Worksheet.Cells["A7:N7"].Merge = true;
                        range.Worksheet.Cells["A7:N7"].Value = "I.Hành chính";
                        range.Worksheet.Cells["A7:N7"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A7:N7"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A7:N7"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A7:N7"].Style.Font.Color.SetColor(Color.Black);
                        range.Worksheet.Cells["A7:N7"].Style.Font.Bold = true;
                    }

                    using (var range = worksheet.Cells["A8:F8"])
                    {
                        range.Worksheet.Cells["A8:F8"].Merge = true;

                        range.Worksheet.Cells["A8:F8"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["A8:F8"].RichText.Add("(1) Họ tên người bệnh: ");
                        var value = range.Worksheet.Cells["A8:F8"].RichText.Add(yeuCauTiepNhan.HoTen);
                        value.Bold = true;

                        range.Worksheet.Cells["A8:F8"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A8:F8"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A8:F8"].Style.Font.SetFromFont(new Font("Times New Roman", 11));


                        range.Worksheet.Cells["A8:F8"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["G8:J8"])
                    {
                        range.Worksheet.Cells["G8:J8"].Merge = true;
                        range.Worksheet.Cells["G8:J8"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["G8:J8"].RichText.Add("Ngày,tháng,năm sinh: ");
                        var value = range.Worksheet.Cells["G8:J8"].RichText.Add(DateHelper.DOBFormat(yeuCauTiepNhan.NgaySinh, yeuCauTiepNhan.ThangSinh, yeuCauTiepNhan.NamSinh));
                        value.Bold = true;

                        range.Worksheet.Cells["G8:J8"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["G8:J8"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["G8:J8"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["G8:J8"].Style.Font.Color.SetColor(Color.Black);
                    }

                    var gioitinh = yeuCauTiepNhan.GioiTinh != null ? yeuCauTiepNhan.GioiTinh.GetDescription() : "";
                    using (var range = worksheet.Cells["K8:N8"])
                    {
                        range.Worksheet.Cells["K8:N8"].Merge = true;

                        range.Worksheet.Cells["K8:N8"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["K8:N8"].RichText.Add("Giới tính: ");
                        var value = range.Worksheet.Cells["K8:N8"].RichText.Add(gioitinh);
                        value.Bold = true;

                        range.Worksheet.Cells["K8:N8"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["K8:N8"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["K8:N8"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["K8:N8"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["A9:F9"])
                    {
                        range.Worksheet.Cells["A9:F9"].Merge = true;

                        range.Worksheet.Cells["A9:F9"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["A9:F9"].RichText.Add("(2)Địa chỉ hiện tại: ");
                        var value = range.Worksheet.Cells["A9:F9"].RichText.Add(yeuCauTiepNhan.DiaChiDayDu);
                        value.Bold = true;

                        range.Worksheet.Cells["A9:F9"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A9:F9"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A9:F9"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A9:F9"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["G9:J9"])
                    {
                        range.Worksheet.Cells["G9:J9"].Merge = true;

                        range.Worksheet.Cells["G9:J9"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["G9:J9"].RichText.Add("(3)Mã khu vực(K1/K2/K3): ");
                        var value = range.Worksheet.Cells["G9:J9"].RichText.Add(yeuCauTiepNhan.BHYTMaKhuVuc);
                        value.Bold = true;

                        range.Worksheet.Cells["G9:J9"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["G9:J9"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["G9:J9"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["G9:J9"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["A10:F10"])
                    {
                        range.Worksheet.Cells["A10:F10"].Merge = true;
                        range.Worksheet.Cells["A10:F10"].Style.WrapText = true;

                        var title = range.Worksheet.Cells["A10:F10"].RichText.Add("(4)Mã thẻ BHYT: ");
                        var value = range.Worksheet.Cells["A10:F10"].RichText.Add(maBHYT);
                        value.Bold = true;

                        range.Worksheet.Cells["A10:F10"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A10:F10"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A10:F10"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A10:F10"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["G10:J10"])
                    {
                        range.Worksheet.Cells["G10:J10"].Merge = true;
                        range.Worksheet.Cells["G10:J10"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["G10:J10"].RichText.Add("Giá trị từ: ");
                        var valuebHYTTuNgay = range.Worksheet.Cells["G10:J10"].RichText.Add(bHYTTuNgay);
                        valuebHYTTuNgay.Bold = true;

                        var den = range.Worksheet.Cells["G10:J10"].RichText.Add(" đến: ");
                        den.Bold = false;
                        var valuebHYTDenNgay = range.Worksheet.Cells["G10:J10"].RichText.Add(bHYTDenNgay);
                        valuebHYTDenNgay.Bold = true;


                        range.Worksheet.Cells["G10:J10"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["G10:J10"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["G10:J10"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["G10:J10"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["A11:F11"])
                    {
                        range.Worksheet.Cells["A11:F11"].Merge = true;

                        range.Worksheet.Cells["A11:F11"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["A11:F11"].RichText.Add("(5)Nơi ĐK KCB ban đầu: ");
                        var valueNoiDKKCBBanDau = range.Worksheet.Cells["A11:F11"].RichText.Add(NoiDKKCBBanDau);
                        valueNoiDKKCBBanDau.Bold = true;

                        range.Worksheet.Cells["A11:F11"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A11:F11"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A11:F11"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A11:F11"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["G11:J11"])
                    {
                        range.Worksheet.Cells["G11:J11"].Merge = true;
                        range.Worksheet.Cells["G11:J11"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["G11:J11"].RichText.Add("(6)Mã: ");
                        var valueMaKCBBanDau = range.Worksheet.Cells["G11:J11"].RichText.Add(MaKCBBanDau);
                        valueMaKCBBanDau.Bold = true;

                        range.Worksheet.Cells["G11:J11"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["G11:J11"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["G11:J11"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["G11:J11"].Style.Font.Color.SetColor(Color.Black);
                    }


                    using (var range = worksheet.Cells["A12:F12"])
                    {
                        range.Worksheet.Cells["A12:F12"].Merge = true;

                        range.Worksheet.Cells["A12:F12"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["A12:F12"].RichText.Add("(7)Đến Khám: ");
                        var value = range.Worksheet.Cells["A12:F12"].RichText.Add(yeuCauTiepNhan.ThoiDiemTiepNhan.ApplyFormatGioPhutNgay());
                        value.Bold = true;

                        range.Worksheet.Cells["A12:F12"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A12:F12"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A12:F12"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A12:F12"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["A13:F13"])
                    {
                        range.Worksheet.Cells["A13:F13"].Merge = true;

                        range.Worksheet.Cells["A13:F13"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["A13:F13"].RichText.Add("(8)Điều trị ngoại trú/nội trú từ: ");
                        var value = range.Worksheet.Cells["A13:F13"].RichText.Add(yeuCauTiepNhan.NoiTruBenhAn?.ThoiDiemNhapVien.ApplyFormatGioPhutNgay());
                        value.Bold = true;

                        range.Worksheet.Cells["A13:F13"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A13:F13"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A13:F13"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A13:F13"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["A14:F14"])
                    {
                        range.Worksheet.Cells["A14:F14"].Merge = true;
                        range.Worksheet.Cells["A14:F14"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["A14:F14"].RichText.Add("(9)Kết thúc khám/điều trị: ");
                        var value = range.Worksheet.Cells["A14:F14"].RichText.Add(yeuCauTiepNhan.NoiTruBenhAn?.ThoiDiemRaVien?.ApplyFormatGioPhutNgay());
                        value.Bold = true;


                        range.Worksheet.Cells["A14:F14"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A14:F14"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A14:F14"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A14:F14"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["G14:J14"])
                    {
                        range.Worksheet.Cells["G14:J14"].Merge = true;
                        range.Worksheet.Cells["G14:J14"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["G14:J14"].RichText.Add("Tổng số ngày điều trị: ");
                        var value = range.Worksheet.Cells["G14:J14"].RichText.Add(NoiTruBenhAnHelper.TinhSoNgayDieuTri(yeuCauTiepNhan.NoiTruBenhAn)?.ToString() ?? string.Empty);
                        value.Bold = true;

                        range.Worksheet.Cells["G14:J14"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["G14:J14"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["G14:J14"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["G14:J14"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["K14:N14"])
                    {
                        range.Worksheet.Cells["K14:N14"].Merge = true;

                        range.Worksheet.Cells["K14:N14"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["K14:N14"].RichText.Add("(10)Tình trạng ra viện: ");
                        var value = range.Worksheet.Cells["K14:N14"].RichText.Add((yeuCauTiepNhan.NoiTruBenhAn?.TinhTrangRaVien == EnumTinhTrangRaVien.RaVien && (yeuCauTiepNhan.NoiTruBenhAn?.KetQuaDieuTri == EnumKetQuaDieuTri.Do || yeuCauTiepNhan.NoiTruBenhAn?.KetQuaDieuTri == EnumKetQuaDieuTri.Khoi) ? 1 : 2).ToString());
                        value.Bold = true;


                        range.Worksheet.Cells["K14:N14"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["K14:N14"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["K14:N14"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["K14:N14"].Style.Font.Color.SetColor(Color.Black);
                    }

                    //=================================15=================================
                    var coCapCuu = yeuCauTiepNhan.LyDoVaoVien == Enums.EnumLyDoVaoVien.CapCuu ? "X" : string.Empty;
                    var coDungTuyen = yeuCauTiepNhan.LyDoVaoVien == Enums.EnumLyDoVaoVien.DungTuyen ? "X" : string.Empty;
                    var coThongTuyen = yeuCauTiepNhan.LyDoVaoVien == Enums.EnumLyDoVaoVien.ThongTuyen ? "X" : string.Empty;
                    var coTraiTuyen = yeuCauTiepNhan.LyDoVaoVien == Enums.EnumLyDoVaoVien.TraiTuyen ? "X" : string.Empty;

                    using (var range = worksheet.Cells["A15:C15"])
                    {
                        range.Worksheet.Cells["A15:C15"].Merge = true;

                        range.Worksheet.Cells["A15:C15"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["A15:C15"].RichText.Add("(11) Cấp cứu: ");
                        var value = range.Worksheet.Cells["A15:C15"].RichText.Add(coCapCuu);
                        value.Bold = true;

                        range.Worksheet.Cells["A15:C15"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A15:C15"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A15:C15"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A15:C15"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["D15:F15"])
                    {
                        range.Worksheet.Cells["D15:F15"].Merge = true;
                        range.Worksheet.Cells["D15:F15"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["D15:F15"].RichText.Add("(12) Đúng tuyến: ");
                        var value = range.Worksheet.Cells["D15:F15"].RichText.Add(coDungTuyen);
                        value.Bold = true;

                        range.Worksheet.Cells["D15:F15"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["D15:F15"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["D15:F15"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["D15:F15"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["G15:J15"])
                    {
                        range.Worksheet.Cells["G15:J15"].Merge = true;
                        range.Worksheet.Cells["G15:J15"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["G15:J15"].RichText.Add("Nơi chuyến đến: ");
                        var value = range.Worksheet.Cells["G15:J15"].RichText.Add(yeuCauTiepNhan.NoiChuyen?.Ten);
                        value.Bold = true;
                        range.Worksheet.Cells["G15:J15"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["G15:J15"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["G15:J15"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["G15:J15"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["K15:N15"])
                    {
                        range.Worksheet.Cells["K15:N15"].Merge = true;
                        range.Worksheet.Cells["K15:N15"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["K15:N15"].RichText.Add("Nơi chuyển đi: ");
                        var value = range.Worksheet.Cells["K15:N15"].RichText.Add(yeuCauTiepNhan.NoiTruBenhAn?.ChuyenDenBenhVien?.Ten);
                        value.Bold = true;
                        range.Worksheet.Cells["K15:N15"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["K15:N15"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["K15:N15"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["K15:N15"].Style.Font.Color.SetColor(Color.Black);
                    }

                    //=================================16=================================
                    using (var range = worksheet.Cells["A16:C16"])
                    {
                        range.Worksheet.Cells["A16:C16"].Merge = true;
                        range.Worksheet.Cells["A16:C16"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["A16:C16"].RichText.Add("(13)Thông tuyến: ");
                        var value = range.Worksheet.Cells["A16:C16"].RichText.Add(coThongTuyen);
                        value.Bold = true;
                        range.Worksheet.Cells["A16:C16"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A16:C16"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A16:C16"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A16:C16"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["D16:F16"])
                    {
                        range.Worksheet.Cells["D16:F16"].Merge = true;
                        range.Worksheet.Cells["D16:F16"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["D16:F16"].RichText.Add("(14)Trái tuyến: ");
                        var value = range.Worksheet.Cells["D16:F16"].RichText.Add(coTraiTuyen);
                        value.Bold = true;

                        range.Worksheet.Cells["D16:F16"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["D16:F16"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["D16:F16"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["D16:F16"].Style.Font.Color.SetColor(Color.Black);
                    }

                    //================================= 17 =================================

                    var chuanDoanXacDinhStr = yeuCauTiepNhan.NoiTruBenhAn?.LoaiBenhAn == LoaiBenhAn.SanKhoaMo || yeuCauTiepNhan.NoiTruBenhAn?.LoaiBenhAn == LoaiBenhAn.SanKhoaThuong
                                                             ? chuanDoanXacDinhSanKhoa : yeuCauTiepNhan.NoiTruBenhAn?.ChanDoanChinhRaVienGhiChu;


                    var iCD10 = yeuCauTiepNhan.NoiTruBenhAn?.LoaiBenhAn == LoaiBenhAn.SanKhoaMo || yeuCauTiepNhan.NoiTruBenhAn?.LoaiBenhAn == LoaiBenhAn.SanKhoaThuong
                                                               ? maICD10 : yeuCauTiepNhan.NoiTruBenhAn?.ChanDoanChinhRaVienICD?.Ma;


                    using (var range = worksheet.Cells["A17:F17"])
                    {
                        range.Worksheet.Cells["A17:F17"].Merge = true;
                        range.Worksheet.Cells["A17:F17"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["A17:F17"].RichText.Add("(15)Chẩn đoán xác định: ");
                        var value = range.Worksheet.Cells["A17:F17"].RichText.Add(chuanDoanXacDinhStr);
                        value.Bold = true;

                        range.Worksheet.Cells["A17:F17"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A17:F17"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A17:F17"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A17:F17"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["G17:N17"])
                    {
                        range.Worksheet.Cells["G17:N17"].Merge = true;

                        range.Worksheet.Cells["G17:N17"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["G17:N17"].RichText.Add("(17) Mã bệnh: ");
                        var value = range.Worksheet.Cells["G17:N17"].RichText.Add(iCD10);
                        value.Bold = true;


                        range.Worksheet.Cells["G17:N17"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["G17:N17"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["G17:N17"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["G17:N17"].Style.Font.Color.SetColor(Color.Black);
                    }

                    //================================= 18 =================================

                    using (var range = worksheet.Cells["A18:F18"])
                    {
                        range.Worksheet.Cells["A18:F18"].Merge = true;
                        range.Worksheet.Cells["A18:F18"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["A18:F18"].RichText.Add("(18)Bệnh kèm theo: ");
                        var value = range.Worksheet.Cells["A18:F18"].RichText.Add(tenICDKemTheo);
                        value.Bold = true;


                        range.Worksheet.Cells["A18:F18"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A18:F18"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A18:F18"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A18:F18"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["G18:N18"])
                    {
                        range.Worksheet.Cells["G18:N18"].Merge = true;
                        range.Worksheet.Cells["G18:N18"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["G18:N18"].RichText.Add("(18)Mã bệnh kèm theo: ");
                        var value = range.Worksheet.Cells["G18:N18"].RichText.Add(maICDKemTheo);
                        value.Bold = true;


                        range.Worksheet.Cells["G18:N18"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["G18:N18"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["G18:N18"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["G18:N18"].Style.Font.Color.SetColor(Color.Black);
                    }

                    //================================= 19 =================================

                    using (var range = worksheet.Cells["A19:F19"])
                    {
                        range.Worksheet.Cells["A19:F19"].Merge = true;
                        range.Worksheet.Cells["A19:F19"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["A19:F19"].RichText.Add("(19)Thời điểm đủ 05 năm liên tục từ ngày: ");
                        var value = range.Worksheet.Cells["A19:F19"].RichText.Add(yeuCauTiepNhan.BHYTNgayDu5Nam?.ApplyFormatDate());
                        value.Bold = true;


                        range.Worksheet.Cells["A19:F19"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A19:F19"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A19:F19"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A19:F19"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["G19:N19"])
                    {
                        range.Worksheet.Cells["G19:N19"].Merge = true;
                        range.Worksheet.Cells["G19:N19"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["G19:N19"].RichText.Add("(20)Miễn cùng chi trả trong năm từ ngày: ");
                        var value = range.Worksheet.Cells["G19:N19"].RichText.Add(yeuCauTiepNhan.BHYTNgayDuocMienCungChiTra?.ApplyFormatDate());
                        value.Bold = true;

                        range.Worksheet.Cells["G19:N19"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["G19:N19"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["G19:N19"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["G19:N19"].Style.Font.Color.SetColor(Color.Black);
                    }

                    //================================= 20 =================================

                    using (var range = worksheet.Cells["A20:N20"])
                    {
                        range.Worksheet.Cells["A20:N20"].Merge = true;
                        range.Worksheet.Cells["A20:N20"].Value = "II. Phần Chi phí khám bệnh, chữa bệnh";
                        range.Worksheet.Cells["A20:N20"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A20:N20"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A20:N20"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A20:N20"].Style.Font.Color.SetColor(Color.Black);
                        range.Worksheet.Cells["A20:N20"].Style.Font.Bold = true;
                    }

                    int index = 21;

                    var groupChiPhiTheoThe = danhSachChiPhi.GroupBy(o => o.MaSoTheBHYT);
                    if (groupChiPhiTheoThe.Count() > 2 ||
                        (groupChiPhiTheoThe.All(o => o.Key != string.Empty) && groupChiPhiTheoThe.Count() > 1))
                    {
                        var groupNgayPhatSinhTheoThe = groupChiPhiTheoThe.Where(o => o.Key != string.Empty).Select(o => new { o.Key, o.OrderBy(j => j.NgayPhatSinh).First().NgayPhatSinh }).OrderBy(o => o.NgayPhatSinh).ToArray();
                        for (int i = 0; i < groupNgayPhatSinhTheoThe.Count(); i++)
                        {
                            var ngayPhatSinhTheoThe = groupNgayPhatSinhTheoThe[i];
                            var theBHYTChiTra = yeuCauTiepNhan.YeuCauTiepNhanTheBHYTs.First(o => o.MaSoThe == ngayPhatSinhTheoThe.Key);
                            var chiPhis = groupChiPhiTheoThe.FirstOrDefault(o => o.Key == ngayPhatSinhTheoThe.Key).ToList();
                            DateTime? ngayPhatSinhTiepTheo = i < groupNgayPhatSinhTheoThe.Count() - 1
                                ? groupNgayPhatSinhTheoThe[i + 1].NgayPhatSinh
                                : null;
                            chiPhis.AddRange(groupChiPhiTheoThe.FirstOrDefault(o => o.Key == string.Empty).Where(j => (i == 0 || j.NgayPhatSinh >= ngayPhatSinhTheoThe.NgayPhatSinh) && (ngayPhatSinhTiepTheo != null && j.NgayPhatSinh < ngayPhatSinhTiepTheo)).ToList());
                            var mucHuongPT = theBHYTChiTra != null && theBHYTChiTra.MucHuong > 0 ? theBHYTChiTra?.MucHuong + "%" : string.Empty;

                            using (var range = worksheet.Cells["A" + index + ":C" + index])
                            {
                                range.Worksheet.Cells["A" + index + ":C" + index].Merge = true;
                                range.Worksheet.Cells["A" + index + ":C" + index].Style.WrapText = true;
                                var title = range.Worksheet.Cells["A" + index + ":C" + index].RichText.Add("Mã thẻ BHYT: ");
                                var value = range.Worksheet.Cells["A" + index + ":C" + index].RichText.Add(theBHYTChiTra.MaSoThe);
                                value.Bold = true;

                                range.Worksheet.Cells["A" + index + ":C" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                range.Worksheet.Cells["A" + index + ":C" + index].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                                range.Worksheet.Cells["A" + index + ":C" + index].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                                range.Worksheet.Cells["A" + index + ":C" + index].Style.Font.Color.SetColor(Color.Black);
                            }

                            using (var range = worksheet.Cells["D" + index + ":F" + index])
                            {
                                range.Worksheet.Cells["D" + index + ":F" + index].Merge = true;
                                range.Worksheet.Cells["D" + index + ":F" + index].Style.WrapText = true;
                                var title = range.Worksheet.Cells["D" + index + ":F" + index].RichText.Add("Giá trị từ: ");
                                var valuebHYTTuNgay = range.Worksheet.Cells["D" + index + ":F" + index].RichText.Add(theBHYTChiTra.NgayHieuLuc.ApplyFormatDate());
                                valuebHYTTuNgay.Bold = true;

                                var den = range.Worksheet.Cells["D" + index + ":F" + index].RichText.Add(" đến: ");
                                den.Bold = false;
                                var valuebHYTDenNgay = range.Worksheet.Cells["D" + index + ":F" + index].RichText.Add(theBHYTChiTra?.NgayHetHan?.ApplyFormatDate());
                                valuebHYTDenNgay.Bold = true;

                                range.Worksheet.Cells["D" + index + ":F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                range.Worksheet.Cells["D" + index + ":F" + index].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                                range.Worksheet.Cells["D" + index + ":F" + index].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                                range.Worksheet.Cells["D" + index + ":F" + index].Style.Font.Color.SetColor(Color.Black);
                            }

                            using (var range = worksheet.Cells["G" + index + ":J" + index])
                            {
                                range.Worksheet.Cells["G" + index + ":J" + index].Merge = true;
                                range.Worksheet.Cells["G" + index + ":J" + index].Style.WrapText = true;
                                var title = range.Worksheet.Cells["G" + index + ":J" + index].RichText.Add("Mức hưởng: ");
                                var value = range.Worksheet.Cells["G" + index + ":J" + index].RichText.Add(mucHuongPT);
                                value.Bold = true;


                                range.Worksheet.Cells["G" + index + ":J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                range.Worksheet.Cells["G" + index + ":J" + index].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                                range.Worksheet.Cells["G" + index + ":J" + index].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                                range.Worksheet.Cells["G" + index + ":J" + index].Style.Font.Color.SetColor(Color.Black);
                            }

                            index++;

                            var indexTableFirst = index;
                            var indexTableLast = index + 1;

                            using (var range = worksheet.Cells["A" + indexTableFirst + ":N" + indexTableLast])
                            {
                                range.Worksheet.Cells["A" + indexTableFirst + ":N" + indexTableLast].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                                range.Worksheet.Cells["A" + indexTableFirst + ":N" + indexTableLast].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                                range.Worksheet.Cells["A" + indexTableFirst + ":N" + indexTableLast].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                range.Worksheet.Cells["A" + indexTableFirst + ":N" + indexTableLast].Style.Font.Color.SetColor(Color.Black);
                                range.Worksheet.Cells["A" + indexTableFirst + ":N" + indexTableLast].Style.Font.Bold = true;
                                range.Worksheet.Cells["A" + indexTableFirst + ":N" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);

                                range.Worksheet.Cells["A" + indexTableFirst + ":A" + indexTableLast].Merge = true;
                                range.Worksheet.Cells["A" + indexTableFirst + ":A" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["A" + indexTableFirst + ":A" + indexTableLast].Value = "STT";

                                range.Worksheet.Cells["B" + indexTableFirst + ":B" + indexTableLast].Merge = true;
                                range.Worksheet.Cells["B" + indexTableFirst + ":B" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["B" + indexTableFirst + ":B" + indexTableLast].Value = "Nội dung";

                                range.Worksheet.Cells["C" + indexTableFirst + ":C" + indexTableLast].Merge = true;
                                range.Worksheet.Cells["C" + indexTableFirst + ":C" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["C" + indexTableFirst + ":C" + indexTableLast].Value = "Đơn vị tính";

                                range.Worksheet.Cells["D" + indexTableFirst + ":D" + indexTableLast].Merge = true;
                                range.Worksheet.Cells["D" + indexTableFirst + ":D" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["D" + indexTableFirst + ":D" + indexTableLast].Value = "Số lượng";

                                range.Worksheet.Cells["E" + indexTableFirst + ":E" + indexTableLast].Merge = true;
                                range.Worksheet.Cells["E" + indexTableFirst + ":E" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["E" + indexTableFirst + ":E" + indexTableLast].Value = "Đơn giá BV(đồng)";

                                range.Worksheet.Cells["F" + indexTableFirst + ":F" + indexTableLast].Merge = true;
                                range.Worksheet.Cells["F" + indexTableFirst + ":F" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["F" + indexTableFirst + ":F" + indexTableLast].Value = "Đơn giá BH(đồng)";

                                range.Worksheet.Cells["G" + indexTableFirst + ":G" + indexTableLast].Merge = true;
                                range.Worksheet.Cells["G" + indexTableFirst + ":G" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["G" + indexTableFirst + ":G" + indexTableLast].Value = "Tỉ lệ thanh toán theo dịch vụ (%)";

                                range.Worksheet.Cells["H" + indexTableFirst + ":H" + indexTableLast].Merge = true;
                                range.Worksheet.Cells["H" + indexTableFirst + ":H" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["H" + indexTableFirst + ":H" + indexTableLast].Value = "Thành tiền BV (đồng)";

                                range.Worksheet.Cells["I" + indexTableFirst + ":I" + indexTableLast].Merge = true;
                                range.Worksheet.Cells["I" + indexTableFirst + ":I" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["I" + indexTableFirst + ":I" + indexTableLast].Value = "Tỷ lệ thanh toán BHYT (%)";

                                range.Worksheet.Cells["J" + indexTableFirst + ":J" + indexTableLast].Merge = true;
                                range.Worksheet.Cells["J" + indexTableFirst + ":J" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["J" + indexTableFirst + ":J" + indexTableLast].Value = "Thành tiền BH(đồng)";

                                range.Worksheet.Cells["K" + indexTableFirst + ":N" + indexTableFirst].Merge = true;
                                range.Worksheet.Cells["K" + indexTableFirst + ":N" + indexTableFirst].Value = "Nguồn thanh toán (đồng)";

                                range.Worksheet.Cells["K" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["K" + indexTableLast].Value = "Quỹ BHYT";

                                range.Worksheet.Cells["L" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["L" + indexTableLast].Value = "Người bệnh cùng chi trả (đồng)";

                                range.Worksheet.Cells["M" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["M" + indexTableLast].Value = "Khác (đồng)";

                                range.Worksheet.Cells["N" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["N" + indexTableLast].Value = "Người bệnh tự trả(đồng)";
                            }

                            index = indexTableLast + 1;


                            var dsChiPhiBangKeTheoThe = new List<BangKeKhamBenhBenhVienVo>();

                            foreach (var chiPhi in chiPhis.Where(c => c.NhomChiPhiBangKe != NhomChiPhiBangKe.GoiVatTu && c.YeuCauGoiDichVuId == null).GroupBy(c => new { c.DonGia, c.SoTienMG, KhongTinhPhi = c.KhongTinhPhi.GetValueOrDefault(), c.NhomChiPhiBangKe, c.TenDichVu, c.DonViTinh, c.DuocHuongBHYT, c.DonGiaBHYT, c.MucHuongBaoHiem, c.TiLeBaoHiemThanhToan }).OrderByDescending(o => o.Key.DuocHuongBHYT))
                            {
                                var chiphiBangKe = new BangKeKhamBenhBenhVienVo
                                {
                                    Nhom = chiPhi.Key.NhomChiPhiBangKe,
                                    Id = chiPhi.FirstOrDefault().Id,
                                    NoiDung = chiPhi.Key.TenDichVu,
                                    DonViTinh = chiPhi.Key.DonViTinh,
                                    SoLuong = (decimal)chiPhi.Sum(c => c.Soluong),
                                    DuocHuongBaoHiem = chiPhi.Key.DuocHuongBHYT,
                                    DonGiaBH = chiPhi.Key.DuocHuongBHYT ? chiPhi.Key.DonGiaBHYT : 0,
                                    MucHuongBaoHiem = chiPhi.Key.MucHuongBaoHiem,
                                    TiLeThanhToanTheoDV = chiPhi.Key.TiLeBaoHiemThanhToan,
                                    BaoHiemChiTra = true,
                                    DonGiaBV = chiPhi.Key.DonGia
                                };
                                if (chiPhi.Key.KhongTinhPhi == true)
                                {
                                    chiphiBangKe.Khac = chiPhi.Key.MucHuongBaoHiem > 0
                                        ? (chiphiBangKe.ThanhTienBV.GetValueOrDefault() - chiphiBangKe.ThanhTienBH.GetValueOrDefault())
                                        : chiphiBangKe.ThanhTienBV.GetValueOrDefault();
                                }
                                else
                                {
                                    chiphiBangKe.Khac = chiPhi.Sum(c => c.SoTienMG);
                                }
                                dsChiPhiBangKeTheoThe.Add(chiphiBangKe);
                            }

                            foreach (var chiPhi in chiPhis.Where(c => !(c.NhomChiPhiBangKe != NhomChiPhiBangKe.GoiVatTu && c.YeuCauGoiDichVuId == null)))
                            {
                                var chiphiBangKe = new BangKeKhamBenhBenhVienVo
                                {
                                    Nhom = chiPhi.NhomChiPhiBangKe,
                                    Id = chiPhi.Id,
                                    NoiDung = chiPhi.TenDichVu,
                                    DonViTinh = chiPhi.DonViTinh,
                                    SoLuong = (decimal)chiPhi.Soluong,
                                    DuocHuongBaoHiem = chiPhi.DuocHuongBHYT,
                                    DonGiaBH = chiPhi.DuocHuongBHYT ? chiPhi.DonGiaBHYT : 0,
                                    MucHuongBaoHiem = chiPhi.MucHuongBaoHiem,
                                    TiLeThanhToanTheoDV = chiPhi.TiLeBaoHiemThanhToan,
                                    BaoHiemChiTra = true,
                                    DonGiaBV = chiPhi.DonGia
                                };
                                if (chiPhi.KhongTinhPhi == true || chiPhi.YeuCauGoiDichVuId != null)
                                {
                                    chiphiBangKe.Khac = chiPhi.MucHuongBaoHiem > 0
                                        ? (chiphiBangKe.ThanhTienBV.GetValueOrDefault() - chiphiBangKe.ThanhTienBH.GetValueOrDefault())
                                        : chiphiBangKe.ThanhTienBV.GetValueOrDefault();
                                }
                                else
                                {
                                    chiphiBangKe.Khac = chiPhi.SoTienMG;
                                }
                                dsChiPhiBangKeTheoThe.Add(chiphiBangKe);
                            }
                            dsChiPhiBangKe.AddRange(dsChiPhiBangKeTheoThe);
                            var groupChiPhiBangKes = dsChiPhiBangKeTheoThe.GroupBy(x => x.Nhom).OrderBy(o => (int)o.Key * (o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay || o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriNoiTru ? 1 : 10));
                            foreach (var groupChiPhiBangKe in groupChiPhiBangKes)
                            {
                                if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay)
                                {

                                    worksheet.Cells["A" + index + ":N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["A" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                    worksheet.Cells["A" + index + ":N" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                    worksheet.Cells["A" + index + ":N" + index].Merge = true;
                                    worksheet.Cells["A" + index + ":N" + index].Value = "2. Ngày giường:";
                                    worksheet.Cells["A" + index + ":N" + index].Style.Font.Bold = true;

                                    index++;

                                    worksheet.Cells["A" + index + ":G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["A" + index + ":G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                    worksheet.Cells["A" + index + ":G" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                    worksheet.Cells["A" + index + ":G" + index].Merge = true;
                                    worksheet.Cells["A" + index + ":G" + index].Value = "2.1." + groupChiPhiBangKe.Key.GetDescription();
                                    worksheet.Cells["A" + index + ":G" + index].Style.Font.Bold = true;

                                    worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["H" + index].Style.Font.Bold = true;
                                    worksheet.Cells["H" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBV);

                                    worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["J" + index].Style.Font.Bold = true;
                                    worksheet.Cells["J" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBH);

                                    worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["K" + index].Style.Font.Bold = true;
                                    worksheet.Cells["K" + index].Value = groupChiPhiBangKe.Sum(o => o.QuyBHYT);

                                    worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["L" + index].Style.Font.Bold = true;
                                    worksheet.Cells["L" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra);

                                    worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["M" + index].Style.Font.Bold = true;
                                    worksheet.Cells["M" + index].Value = groupChiPhiBangKe.Sum(o => o.Khac);

                                    worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["N" + index].Style.Font.Bold = true;
                                    worksheet.Cells["N" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra);

                                    index++;
                                }
                                else if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.NgayGiuongDieuTriNoiTru)
                                {
                                    if (!groupChiPhiBangKes.Any(o => o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay))
                                    {
                                        worksheet.Cells["A" + index + ":N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["A" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                        worksheet.Cells["A" + index + ":N" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                        worksheet.Cells["A" + index + ":N" + index].Merge = true;
                                        worksheet.Cells["A" + index + ":N" + index].Value = "2. Ngày giường:";
                                        worksheet.Cells["A" + index + ":N" + index].Style.Font.Bold = true;

                                    }
                                    index++;

                                    worksheet.Cells["A" + index + ":G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["A" + index + ":G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                    worksheet.Cells["A" + index + ":G" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                    worksheet.Cells["A" + index + ":G" + index].Merge = true;
                                    worksheet.Cells["A" + index + ":G" + index].Value = "2.2." + groupChiPhiBangKe.Key.GetDescription();
                                    worksheet.Cells["A" + index + ":G" + index].Style.Font.Bold = true;

                                    worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["H" + index].Style.Font.Bold = true;
                                    worksheet.Cells["H" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBV);

                                    worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["J" + index].Style.Font.Bold = true;
                                    worksheet.Cells["J" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBH);

                                    worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["K" + index].Style.Font.Bold = true;
                                    worksheet.Cells["K" + index].Value = groupChiPhiBangKe.Sum(o => o.QuyBHYT);

                                    worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["L" + index].Style.Font.Bold = true;
                                    worksheet.Cells["L" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra);

                                    worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["M" + index].Style.Font.Bold = true;
                                    worksheet.Cells["M" + index].Value = groupChiPhiBangKe.Sum(o => o.Khac);

                                    worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["N" + index].Style.Font.Bold = true;
                                    worksheet.Cells["N" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra);

                                    index++;
                                }
                                else
                                {
                                    worksheet.Cells["A" + index + ":G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["A" + index + ":G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                    worksheet.Cells["A" + index + ":G" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                    worksheet.Cells["A" + index + ":G" + index].Merge = true;
                                    worksheet.Cells["A" + index + ":G" + index].Value = (int)groupChiPhiBangKe.Key + "." + groupChiPhiBangKe.Key.GetDescription();
                                    worksheet.Cells["A" + index + ":G" + index].Style.Font.Bold = true;

                                    worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["H" + index].Style.Font.Bold = true;
                                    worksheet.Cells["H" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBV);

                                    worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["J" + index].Style.Font.Bold = true;
                                    worksheet.Cells["J" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBH);

                                    worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["K" + index].Style.Font.Bold = true;
                                    worksheet.Cells["K" + index].Value = groupChiPhiBangKe.Sum(o => o.QuyBHYT);

                                    worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["L" + index].Style.Font.Bold = true;
                                    worksheet.Cells["L" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra);

                                    worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["M" + index].Style.Font.Bold = true;
                                    worksheet.Cells["M" + index].Value = groupChiPhiBangKe.Sum(o => o.Khac);

                                    worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["N" + index].Style.Font.Bold = true;
                                    worksheet.Cells["N" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra);

                                    index++;
                                }
                                if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.GoiVatTu)
                                {
                                    var groupGoiVatTus = groupChiPhiBangKe.ToList().GroupBy(o => o.SoGoiVatTu.GetValueOrDefault()).OrderBy(o => o.Key);
                                    int sttGoiVatTu = 1;
                                    foreach (var groupGoiVatTu in groupGoiVatTus)
                                    {
                                        worksheet.Cells["A" + index + ":G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["A" + index + ":G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                        worksheet.Cells["A" + index + ":G" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                        worksheet.Cells["A" + index + ":G" + index].Value = "10." + sttGoiVatTu + ". " + groupChiPhiBangKe.Key.GetDescription() + " " + sttGoiVatTu;
                                        worksheet.Cells["A" + index + ":G" + index].Style.Font.Bold = true;
                                        worksheet.Cells["A" + index + ":G" + index].Merge = true;

                                        worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["H" + index].Style.Font.Bold = true;
                                        worksheet.Cells["H" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBV);

                                        worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["J" + index].Style.Font.Bold = true;
                                        worksheet.Cells["J" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBH);

                                        worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["K" + index].Style.Font.Bold = true;
                                        worksheet.Cells["K" + index].Value = groupChiPhiBangKe.Sum(o => o.QuyBHYT);

                                        worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["L" + index].Style.Font.Bold = true;
                                        worksheet.Cells["L" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra);

                                        worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["M" + index].Style.Font.Bold = true;
                                        worksheet.Cells["M" + index].Value = groupChiPhiBangKe.Sum(o => o.Khac);

                                        worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["N" + index].Style.Font.Bold = true;
                                        worksheet.Cells["N" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra);

                                        index++;

                                        foreach (var chiPhiBangKe in groupGoiVatTu)
                                        {
                                            worksheet.Cells["A" + index + ":N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["A" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                            worksheet.Cells["A" + index + ":N" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));

                                            worksheet.Cells["A" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["A" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                            worksheet.Cells["A" + index].Value = indexItem;

                                            worksheet.Cells["B" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["B" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                            worksheet.Cells["B" + index].Value = chiPhiBangKe.NoiDung;

                                            worksheet.Cells["C" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["C" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                            worksheet.Cells["C" + index].Value = chiPhiBangKe.DonViTinh;

                                            worksheet.Cells["D" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["D" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                            worksheet.Cells["D" + index].Value = chiPhiBangKe.SoLuong;

                                            worksheet.Cells["E" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["E" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                            worksheet.Cells["E" + index].Style.Numberformat.Format = "#,##0.00";
                                            worksheet.Cells["E" + index].Value = chiPhiBangKe.DonGiaBV;

                                            worksheet.Cells["F" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["F" + index].Style.Numberformat.Format = "#,##0.00";
                                            worksheet.Cells["F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                            worksheet.Cells["F" + index].Value = chiPhiBangKe.DonGiaBH;

                                            worksheet.Cells["G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                            worksheet.Cells["G" + index].Style.Numberformat.Format = "#,##0.00";
                                            worksheet.Cells["G" + index].Value = chiPhiBangKe.TiLeThanhToanTheoDV;

                                            worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                            worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                            worksheet.Cells["H" + index].Value = chiPhiBangKe.ThanhTienBV;

                                            worksheet.Cells["I" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["I" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                            worksheet.Cells["I" + index].Value = Convert.ToDouble(chiPhiBangKe.MucHuongBaoHiem > 0 ? 100 : 0).ApplyFormatMoneyToDouble();


                                            worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                            worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                            worksheet.Cells["J" + index].Value = chiPhiBangKe.ThanhTienBH;


                                            worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                            worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                            worksheet.Cells["K" + index].Value = chiPhiBangKe.QuyBHYT;


                                            worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                            worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                            worksheet.Cells["L" + index].Value = chiPhiBangKe.NguoiBenhCungChiTra;


                                            worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                            worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                            worksheet.Cells["M" + index].Value = chiPhiBangKe.Khac;


                                            worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                            worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                            worksheet.Cells["N" + index].Value = chiPhiBangKe.NguoiBenhTuTra;

                                            indexItem++;
                                            index++;
                                        }
                                    }
                                }
                                else
                                {
                                    foreach (var chiPhiBangKe in groupChiPhiBangKe)
                                    {
                                        worksheet.Cells["A" + index + ":N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["A" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                        worksheet.Cells["A" + index + ":N" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));

                                        worksheet.Cells["A" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["A" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                        worksheet.Cells["A" + index].Value = indexItem;

                                        worksheet.Cells["B" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["B" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                        worksheet.Cells["B" + index].Value = chiPhiBangKe.NoiDung;

                                        worksheet.Cells["C" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["C" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                        worksheet.Cells["C" + index].Value = chiPhiBangKe.DonViTinh;

                                        worksheet.Cells["D" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["D" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                        worksheet.Cells["D" + index].Value = chiPhiBangKe.SoLuong;

                                        worksheet.Cells["E" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["E" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["E" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["E" + index].Value = chiPhiBangKe.DonGiaBV;

                                        worksheet.Cells["F" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["F" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["F" + index].Value = chiPhiBangKe.DonGiaBH;

                                        worksheet.Cells["G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["G" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["G" + index].Value = chiPhiBangKe.TiLeThanhToanTheoDV;

                                        worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["H" + index].Value = chiPhiBangKe.ThanhTienBV;

                                        worksheet.Cells["I" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["I" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["I" + index].Value = Convert.ToDouble(chiPhiBangKe.MucHuongBaoHiem > 0 ? 100 : 0).ApplyFormatMoneyToDouble();


                                        worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["J" + index].Value = chiPhiBangKe.ThanhTienBH;


                                        worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["K" + index].Value = chiPhiBangKe.QuyBHYT;


                                        worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["L" + index].Value = chiPhiBangKe.NguoiBenhCungChiTra;


                                        worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["M" + index].Value = chiPhiBangKe.Khac;


                                        worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["N" + index].Value = chiPhiBangKe.NguoiBenhTuTra;

                                        indexItem++;
                                        index++;
                                    }
                                }

                            }
                            worksheet.Cells["A" + index + ":G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["A" + index + ":G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                            worksheet.Cells["A" + index + ":G" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                            worksheet.Cells["A" + index + ":G" + index].Merge = true;
                            worksheet.Cells["A" + index + ":G" + index].Value = "Tổng cộng";
                            worksheet.Cells["A" + index + ":G" + index].Style.Font.Bold = true;

                            worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                            worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                            worksheet.Cells["H" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.ThanhTienBV)).Sum();

                            worksheet.Cells["I" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["I" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;

                            worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                            worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                            worksheet.Cells["J" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.ThanhTienBH)).Sum();

                            worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                            worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                            worksheet.Cells["K" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.QuyBHYT)).Sum();

                            worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                            worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                            worksheet.Cells["L" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.NguoiBenhCungChiTra)).Sum();

                            worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                            worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                            worksheet.Cells["M" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.Khac)).Sum();

                            worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                            worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                            worksheet.Cells["N" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.NguoiBenhTuTra)).Sum();

                            index++;

                            worksheet.Cells["A" + index + ":N" + index].Merge = true;
                            worksheet.Cells["A" + index + ":N" + index].Value = "Tổng chi phí lần khám bệnh/cả đợt điều trị: " + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + " đồng";
                            worksheet.Cells["A" + index + ":N" + index].Style.Font.Bold = true;

                            index++;

                            worksheet.Cells["A" + index + ":N" + index].Merge = true;
                            worksheet.Cells["A" + index + ":N" + index].Value = "(Viết bằng chữ: " + NumberHelper.ChuyenSoRaText(Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBV))) + ")";

                            index++;

                            worksheet.Cells["A" + index + ":N" + index].Merge = true;
                            worksheet.Cells["A" + index + ":N" + index].Value = "Trong đó , số tiền do:";
                            worksheet.Cells["A" + index + ":N" + index].Style.Font.Bold = true;

                            index++;
                            worksheet.Cells["A" + index + ":N" + index].Merge = true;
                            worksheet.Cells["A" + index + ":N" + index].Value = "- Quỹ BHYT thanh toán: " + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble();

                            index++;
                            worksheet.Cells["A" + index + ":N" + index].Merge = true;
                            worksheet.Cells["A" + index + ":N" + index].Value = "- Người bệnh trả trong đó: " + (Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)) + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhTuTra))).ApplyFormatMoneyToDouble();

                            index++;
                            worksheet.Cells["A" + index + ":N" + index].Merge = true;
                            worksheet.Cells["A" + index + ":N" + index].Value = "+ Cùng chi trả trong phạm vi BHYT: " + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble(true);

                            index++;
                            worksheet.Cells["A" + index + ":N" + index].Merge = true;
                            worksheet.Cells["A" + index + ":N" + index].Value = "+ Các khoản phải trả khác: " + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true);

                            index++;
                            worksheet.Cells["A" + index + ":N" + index].Merge = true;
                            worksheet.Cells["A" + index + ":N" + index].Value = "+ Nguồn khác: " + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble(true);


                            index = index + 2;

                            worksheet.Cells["D" + index + ":F" + index].Style.Font.SetFromFont(new Font("Times New Roman", 12));
                            worksheet.Cells["D" + index + ":F" + index].Merge = true;
                            worksheet.Cells["D" + index + ":F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                            worksheet.Cells["D" + index + ":F" + index].Style.VerticalAlignment = ExcelVerticalAlignment.Top;
                            worksheet.Cells["D" + index + ":F" + index].Value = $"Ngày {DateTime.Now.Day} tháng {DateTime.Now.Month} năm {DateTime.Now.Year}";

                            worksheet.Cells["G" + index + ":I" + index].Style.Font.SetFromFont(new Font("Times New Roman", 12));
                            worksheet.Cells["G" + index + ":I" + index].Merge = true;
                            worksheet.Cells["G" + index + ":I" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                            worksheet.Cells["G" + index + ":I" + index].Style.VerticalAlignment = ExcelVerticalAlignment.Top;
                            worksheet.Cells["G" + index + ":I" + index].Value = $"Ngày {DateTime.Now.Day} tháng {DateTime.Now.Month} năm {DateTime.Now.Year}";

                            worksheet.Cells["J" + index + ":N" + index].Style.Font.Bold = true;
                            worksheet.Cells["J" + index + ":N" + index].Merge = true;
                            worksheet.Cells["J" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                            worksheet.Cells["J" + index + ":N" + index].Value = "XÁC NHẬN CỦA NGƯỜI BỆNH ";

                            index++;

                            worksheet.Cells["A" + index + ":C" + index].Style.Font.Bold = true;
                            worksheet.Cells["A" + index + ":C" + index].Merge = true;
                            worksheet.Cells["A" + index + ":C" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                            worksheet.Cells["A" + index + ":C" + index].Value = "NGƯỜI LẬP BẢNG KÊ";

                            worksheet.Cells["D" + index + ":F" + index].Style.Font.Bold = true;
                            worksheet.Cells["D" + index + ":F" + index].Merge = true;
                            worksheet.Cells["D" + index + ":F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                            worksheet.Cells["D" + index + ":F" + index].Value = "KẾ TOÁN VIỆN PHÍ";

                            worksheet.Cells["G" + index + ":I" + index].Style.Font.Bold = true;
                            worksheet.Cells["G" + index + ":I" + index].Merge = true;
                            worksheet.Cells["G" + index + ":I" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                            worksheet.Cells["G" + index + ":I" + index].Value = "GIÁM ĐỊNH BHYT";

                            worksheet.Cells["J" + index + ":N" + index].Style.Font.Bold = true;
                            worksheet.Cells["J" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                            worksheet.Cells["J" + index + ":N" + index].Merge = true;
                            worksheet.Cells["J" + index + ":N" + index].Value = "(Ký , Ghi rõ họ tên)";

                            index++;

                            worksheet.Cells["A" + index + ":C" + index].Style.Font.Bold = true;
                            worksheet.Cells["A" + index + ":C" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                            worksheet.Cells["A" + index + ":C" + index].Merge = true;
                            worksheet.Cells["A" + index + ":C" + index].Value = "(Ký , Ghi rõ họ tên)";


                            worksheet.Cells["D" + index + ":F" + index].Style.Font.Bold = true;
                            worksheet.Cells["D" + index + ":F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                            worksheet.Cells["D" + index + ":F" + index].Merge = true;
                            worksheet.Cells["D" + index + ":F" + index].Value = "(Ký , Ghi rõ họ tên)";

                            worksheet.Cells["G" + index + ":I" + index].Style.Font.Bold = true;
                            worksheet.Cells["G" + index + ":I" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                            worksheet.Cells["G" + index + ":I" + index].Merge = true;
                            worksheet.Cells["G" + index + ":I" + index].Value = "(Ký , Ghi rõ họ tên)";

                            worksheet.Cells["J" + index + ":N" + index].Style.Font.Bold = true;
                            worksheet.Cells["J" + index + ":N" + index].Merge = true;
                            worksheet.Cells["J" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                            worksheet.Cells["J" + index + ":N" + index].Value = "(Tôi đã nhận...phim...Xquang / CT / MRI)";

                            xlPackage.Save();
                        }
                    }
                    else
                    {
                        YeuCauTiepNhanTheBHYT theBHYTChiTra = null;
                        var maSoThe = groupChiPhiTheoThe.Where(o => o.Key != string.Empty).FirstOrDefault()?.Key;
                        if (!string.IsNullOrEmpty(maSoThe))
                        {
                            theBHYTChiTra = yeuCauTiepNhan.YeuCauTiepNhanTheBHYTs.First(o => o.MaSoThe == maSoThe);
                        }

                        var chiPhis = groupChiPhiTheoThe.SelectMany(o => o).ToList();
                        var mucHuongPT = theBHYTChiTra != null && theBHYTChiTra?.MucHuong > 0 ? theBHYTChiTra?.MucHuong + "%" : string.Empty;

                        using (var range = worksheet.Cells["A21:C21"])
                        {
                            range.Worksheet.Cells["A21:C21"].Merge = true;
                            range.Worksheet.Cells["A21:C21"].Style.WrapText = true;
                            var title = range.Worksheet.Cells["A21:C21"].RichText.Add("Mã thẻ BHYT: ");
                            var value = range.Worksheet.Cells["A21:C21"].RichText.Add(maBHYT);
                            value.Bold = true;

                            range.Worksheet.Cells["A21:C21"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                            range.Worksheet.Cells["A21:C21"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                            range.Worksheet.Cells["A21:C21"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                            range.Worksheet.Cells["A21:C21"].Style.Font.Color.SetColor(Color.Black);
                        }
                        using (var range = worksheet.Cells["A21:N21"])
                        {
                            range.Worksheet.Cells["D" + index + ":F" + index].Merge = true;
                            range.Worksheet.Cells["D" + index + ":F" + index].Style.WrapText = true;
                            var title = range.Worksheet.Cells["D" + index + ":F" + index].RichText.Add("Giá trị từ: ");
                            var valuebHYTTuNgay = range.Worksheet.Cells["D" + index + ":F" + index].RichText.Add(bHYTTuNgay);
                            valuebHYTTuNgay.Bold = true;

                            var den = range.Worksheet.Cells["D" + index + ":F" + index].RichText.Add(" đến: ");
                            den.Bold = false;
                            var valuebHYTDenNgay = range.Worksheet.Cells["D" + index + ":F" + index].RichText.Add(bHYTDenNgay);
                            valuebHYTDenNgay.Bold = true;

                            range.Worksheet.Cells["D" + index + ":F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                            range.Worksheet.Cells["D" + index + ":F" + index].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                            range.Worksheet.Cells["D" + index + ":F" + index].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                            range.Worksheet.Cells["D" + index + ":F" + index].Style.Font.Color.SetColor(Color.Black);
                        }
                        using (var range = worksheet.Cells["G21:J21"])
                        {
                            range.Worksheet.Cells["G21:J21"].Merge = true;
                            range.Worksheet.Cells["G21:J21"].Style.WrapText = true;
                            var title = range.Worksheet.Cells["G21:J21"].RichText.Add("Mức hưởng: ");
                            var value = range.Worksheet.Cells["G21:J21"].RichText.Add(mucHuong);
                            value.Bold = true;


                            range.Worksheet.Cells["G21:J21"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                            range.Worksheet.Cells["G21:J21"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                            range.Worksheet.Cells["G21:J21"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                            range.Worksheet.Cells["G21:J21"].Style.Font.Color.SetColor(Color.Black);
                        }
                        using (var range = worksheet.Cells["A22:N23"])
                        {
                            range.Worksheet.Cells["A22:N23"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                            range.Worksheet.Cells["A22:N23"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                            range.Worksheet.Cells["A22:N23"].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                            range.Worksheet.Cells["A22:N23"].Style.Font.Color.SetColor(Color.Black);
                            range.Worksheet.Cells["A22:N23"].Style.Font.Bold = true;
                            range.Worksheet.Cells["A22:N23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);

                            range.Worksheet.Cells["A22:A23"].Merge = true;
                            range.Worksheet.Cells["A22:A23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["A22:A23"].Value = "STT";

                            range.Worksheet.Cells["B22:B23"].Merge = true;
                            range.Worksheet.Cells["B22:B23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["B22:B23"].Value = "Nội dung";

                            range.Worksheet.Cells["C22:C23"].Merge = true;
                            range.Worksheet.Cells["C22:C23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["C22:C23"].Value = "Đơn vị tính";

                            range.Worksheet.Cells["D22:D23"].Merge = true;
                            range.Worksheet.Cells["D22:D23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["D22:D23"].Value = "Số lượng";

                            range.Worksheet.Cells["E22:E23"].Merge = true;
                            range.Worksheet.Cells["E22:E23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["E22:E23"].Value = "Đơn giá BV(đồng)";

                            range.Worksheet.Cells["F22:F23"].Merge = true;
                            range.Worksheet.Cells["F22:F23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["F22:F23"].Value = "Đơn giá BH(đồng)";

                            range.Worksheet.Cells["G22:G23"].Merge = true;
                            range.Worksheet.Cells["G22:G23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["G22:G23"].Value = "Tỉ lệ thanh toán theo dịch vụ (%)";

                            range.Worksheet.Cells["H22:H23"].Merge = true;
                            range.Worksheet.Cells["H22:H23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["H22:H23"].Value = "Thành tiền BV (đồng)";

                            range.Worksheet.Cells["I22:I23"].Merge = true;
                            range.Worksheet.Cells["I22:I23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["I22:I23"].Value = "Tỷ lệ thanh toán BHYT (%)";

                            range.Worksheet.Cells["J22:J23"].Merge = true;
                            range.Worksheet.Cells["J22:J23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["J22:J23"].Value = "Thành tiền BH(đồng)";

                            range.Worksheet.Cells["K22:N22"].Merge = true;
                            range.Worksheet.Cells["K22:N22"].Value = "Nguồn thanh toán (đồng)";

                            range.Worksheet.Cells["K23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["K23"].Value = "Quỹ BHYT";

                            range.Worksheet.Cells["L23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["L23"].Value = "Người bệnh cùng chi trả (đồng)";

                            range.Worksheet.Cells["M23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["M23"].Value = "Khác (đồng)";

                            range.Worksheet.Cells["N23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["N23"].Value = "Người bệnh tự trả(đồng)";
                        }


                        index = index + 3;


                        foreach (var chiPhi in chiPhis.Where(c => c.NhomChiPhiBangKe != NhomChiPhiBangKe.GoiVatTu && c.YeuCauGoiDichVuId == null).GroupBy(c => new { c.DonGia, c.SoTienMG, KhongTinhPhi = c.KhongTinhPhi.GetValueOrDefault(), c.NhomChiPhiBangKe, c.TenDichVu, c.DonViTinh, c.DuocHuongBHYT, c.DonGiaBHYT, c.MucHuongBaoHiem, c.TiLeBaoHiemThanhToan }).OrderByDescending(o => o.Key.DuocHuongBHYT))
                        {
                            var chiphiBangKe = new BangKeKhamBenhBenhVienVo
                            {
                                Nhom = chiPhi.Key.NhomChiPhiBangKe,
                                Id = chiPhi.FirstOrDefault().Id,
                                NoiDung = chiPhi.Key.TenDichVu,
                                DonViTinh = chiPhi.Key.DonViTinh,
                                SoLuong = (decimal)chiPhi.Sum(c => c.Soluong),
                                DuocHuongBaoHiem = chiPhi.Key.DuocHuongBHYT,
                                DonGiaBH = chiPhi.Key.DuocHuongBHYT ? chiPhi.Key.DonGiaBHYT : 0,
                                MucHuongBaoHiem = chiPhi.Key.MucHuongBaoHiem,
                                TiLeThanhToanTheoDV = chiPhi.Key.TiLeBaoHiemThanhToan,
                                BaoHiemChiTra = true,
                                DonGiaBV = chiPhi.Key.DonGia
                            };
                            if (chiPhi.Key.KhongTinhPhi == true)
                            {
                                chiphiBangKe.Khac = chiPhi.Key.MucHuongBaoHiem > 0
                                    ? (chiphiBangKe.ThanhTienBV.GetValueOrDefault() - chiphiBangKe.ThanhTienBH.GetValueOrDefault())
                                    : chiphiBangKe.ThanhTienBV.GetValueOrDefault();
                            }
                            else
                            {
                                chiphiBangKe.Khac = chiPhi.Sum(c => c.SoTienMG);
                            }
                            dsChiPhiBangKe.Add(chiphiBangKe);
                        }

                        foreach (var chiPhi in chiPhis.Where(c => !(c.NhomChiPhiBangKe != NhomChiPhiBangKe.GoiVatTu && c.YeuCauGoiDichVuId == null)))
                        {
                            var chiphiBangKe = new BangKeKhamBenhBenhVienVo
                            {
                                Nhom = chiPhi.NhomChiPhiBangKe,
                                Id = chiPhi.Id,
                                NoiDung = chiPhi.TenDichVu,
                                DonViTinh = chiPhi.DonViTinh,
                                SoLuong = (decimal)chiPhi.Soluong,
                                DuocHuongBaoHiem = chiPhi.DuocHuongBHYT,
                                DonGiaBH = chiPhi.DuocHuongBHYT ? chiPhi.DonGiaBHYT : 0,
                                MucHuongBaoHiem = chiPhi.MucHuongBaoHiem,
                                TiLeThanhToanTheoDV = chiPhi.TiLeBaoHiemThanhToan,
                                BaoHiemChiTra = true,
                                DonGiaBV = chiPhi.DonGia
                            };
                            if (chiPhi.KhongTinhPhi == true || chiPhi.YeuCauGoiDichVuId != null)
                            {
                                chiphiBangKe.Khac = chiPhi.MucHuongBaoHiem > 0
                                    ? (chiphiBangKe.ThanhTienBV.GetValueOrDefault() - chiphiBangKe.ThanhTienBH.GetValueOrDefault())
                                    : chiphiBangKe.ThanhTienBV.GetValueOrDefault();
                            }
                            else
                            {
                                chiphiBangKe.Khac = chiPhi.SoTienMG;
                            }
                            dsChiPhiBangKe.Add(chiphiBangKe);
                        }

                        var groupChiPhiBangKes = dsChiPhiBangKe.GroupBy(x => x.Nhom).OrderBy(o => (int)o.Key * (o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay || o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriNoiTru ? 1 : 10));
                        if (!groupChiPhiBangKes.Any())
                        {
                            return null;
                        }
                        foreach (var groupChiPhiBangKe in groupChiPhiBangKes)
                        {
                            if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay)
                            {

                                worksheet.Cells["A" + index + ":N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["A" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                worksheet.Cells["A" + index + ":N" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                worksheet.Cells["A" + index + ":N" + index].Merge = true;
                                worksheet.Cells["A" + index + ":N" + index].Value = "2. Ngày giường:";
                                worksheet.Cells["A" + index + ":N" + index].Style.Font.Bold = true;

                                index++;

                                worksheet.Cells["A" + index + ":G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["A" + index + ":G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                worksheet.Cells["A" + index + ":G" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                worksheet.Cells["A" + index + ":G" + index].Merge = true;
                                worksheet.Cells["A" + index + ":G" + index].Value = "2.1." + groupChiPhiBangKe.Key.GetDescription();
                                worksheet.Cells["A" + index + ":G" + index].Style.Font.Bold = true;

                                worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["H" + index].Style.Font.Bold = true;
                                worksheet.Cells["H" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBV);

                                worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["J" + index].Style.Font.Bold = true;
                                worksheet.Cells["J" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBH);

                                worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["K" + index].Style.Font.Bold = true;
                                worksheet.Cells["K" + index].Value = groupChiPhiBangKe.Sum(o => o.QuyBHYT);

                                worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["L" + index].Style.Font.Bold = true;
                                worksheet.Cells["L" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra);

                                worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["M" + index].Style.Font.Bold = true;
                                worksheet.Cells["M" + index].Value = groupChiPhiBangKe.Sum(o => o.Khac);

                                worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["N" + index].Style.Font.Bold = true;
                                worksheet.Cells["N" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra);

                                index++;
                            }
                            else if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.NgayGiuongDieuTriNoiTru)
                            {
                                if (!groupChiPhiBangKes.Any(o => o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay))
                                {
                                    worksheet.Cells["A" + index + ":N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["A" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                    worksheet.Cells["A" + index + ":N" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                    worksheet.Cells["A" + index + ":N" + index].Merge = true;
                                    worksheet.Cells["A" + index + ":N" + index].Value = "2. Ngày giường:";
                                    worksheet.Cells["A" + index + ":N" + index].Style.Font.Bold = true;

                                }
                                index++;
                                worksheet.Cells["A" + index + ":G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["A" + index + ":G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                worksheet.Cells["A" + index + ":G" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                worksheet.Cells["A" + index + ":G" + index].Merge = true;
                                worksheet.Cells["A" + index + ":G" + index].Value = "2.2." + groupChiPhiBangKe.Key.GetDescription();
                                worksheet.Cells["A" + index + ":G" + index].Style.Font.Bold = true;

                                worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["H" + index].Style.Font.Bold = true;
                                worksheet.Cells["H" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBV);

                                worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["J" + index].Style.Font.Bold = true;
                                worksheet.Cells["J" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBH);

                                worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["K" + index].Style.Font.Bold = true;
                                worksheet.Cells["K" + index].Value = groupChiPhiBangKe.Sum(o => o.QuyBHYT);

                                worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["L" + index].Style.Font.Bold = true;
                                worksheet.Cells["L" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra);

                                worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["M" + index].Style.Font.Bold = true;
                                worksheet.Cells["M" + index].Value = groupChiPhiBangKe.Sum(o => o.Khac);

                                worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["N" + index].Style.Font.Bold = true;
                                worksheet.Cells["N" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra);

                                index++;
                            }
                            else
                            {
                                worksheet.Cells["A" + index + ":G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["A" + index + ":G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                worksheet.Cells["A" + index + ":G" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                worksheet.Cells["A" + index + ":G" + index].Merge = true;
                                worksheet.Cells["A" + index + ":G" + index].Value = (int)groupChiPhiBangKe.Key + "." + groupChiPhiBangKe.Key.GetDescription();
                                worksheet.Cells["A" + index + ":G" + index].Style.Font.Bold = true;

                                worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["H" + index].Style.Font.Bold = true;
                                worksheet.Cells["H" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBV);

                                worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["J" + index].Style.Font.Bold = true;
                                worksheet.Cells["J" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBH);

                                worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["K" + index].Style.Font.Bold = true;
                                worksheet.Cells["K" + index].Value = groupChiPhiBangKe.Sum(o => o.QuyBHYT);

                                worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["L" + index].Style.Font.Bold = true;
                                worksheet.Cells["L" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra);

                                worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["M" + index].Style.Font.Bold = true;
                                worksheet.Cells["M" + index].Value = groupChiPhiBangKe.Sum(o => o.Khac);

                                worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["N" + index].Style.Font.Bold = true;
                                worksheet.Cells["N" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra);

                                index++;
                            }
                            if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.GoiVatTu)
                            {
                                var groupGoiVatTus = groupChiPhiBangKe.ToList().GroupBy(o => o.SoGoiVatTu.GetValueOrDefault()).OrderBy(o => o.Key);
                                int sttGoiVatTu = 1;
                                foreach (var groupGoiVatTu in groupGoiVatTus)
                                {
                                    worksheet.Cells["A" + index + ":G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["A" + index + ":G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                    worksheet.Cells["A" + index + ":G" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                    worksheet.Cells["A" + index + ":G" + index].Value = "10." + sttGoiVatTu + ". " + groupChiPhiBangKe.Key.GetDescription() + " " + sttGoiVatTu;
                                    worksheet.Cells["A" + index + ":G" + index].Style.Font.Bold = true;
                                    worksheet.Cells["A" + index + ":G" + index].Merge = true;

                                    worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["H" + index].Style.Font.Bold = true;
                                    worksheet.Cells["H" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBV);

                                    worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["J" + index].Style.Font.Bold = true;
                                    worksheet.Cells["J" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBH);

                                    worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["K" + index].Style.Font.Bold = true;
                                    worksheet.Cells["K" + index].Value = groupChiPhiBangKe.Sum(o => o.QuyBHYT);

                                    worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["L" + index].Style.Font.Bold = true;
                                    worksheet.Cells["L" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra);

                                    worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["M" + index].Style.Font.Bold = true;
                                    worksheet.Cells["M" + index].Value = groupChiPhiBangKe.Sum(o => o.Khac);

                                    worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["N" + index].Style.Font.Bold = true;
                                    worksheet.Cells["N" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra);

                                    index++;

                                    foreach (var chiPhiBangKe in groupGoiVatTu)
                                    {
                                        worksheet.Cells["A" + index + ":N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["A" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                        worksheet.Cells["A" + index + ":N" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));

                                        worksheet.Cells["A" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["A" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                        worksheet.Cells["A" + index].Value = indexItem;

                                        worksheet.Cells["B" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["B" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                        worksheet.Cells["B" + index].Value = chiPhiBangKe.NoiDung;

                                        worksheet.Cells["C" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["C" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                        worksheet.Cells["C" + index].Value = chiPhiBangKe.DonViTinh;

                                        worksheet.Cells["D" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["D" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                        worksheet.Cells["D" + index].Value = chiPhiBangKe.SoLuong;

                                        worksheet.Cells["E" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["E" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["E" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["E" + index].Value = chiPhiBangKe.DonGiaBV;

                                        worksheet.Cells["F" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["F" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["F" + index].Value = chiPhiBangKe.DonGiaBH;

                                        worksheet.Cells["G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["G" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["G" + index].Value = chiPhiBangKe.TiLeThanhToanTheoDV;

                                        worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["H" + index].Value = chiPhiBangKe.ThanhTienBV;

                                        worksheet.Cells["I" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["I" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["I" + index].Value = Convert.ToDouble(chiPhiBangKe.MucHuongBaoHiem > 0 ? 100 : 0).ApplyFormatMoneyToDouble();


                                        worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["J" + index].Value = chiPhiBangKe.ThanhTienBH;


                                        worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["K" + index].Value = chiPhiBangKe.QuyBHYT;


                                        worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["L" + index].Value = chiPhiBangKe.NguoiBenhCungChiTra;


                                        worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["M" + index].Value = chiPhiBangKe.Khac;


                                        worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["N" + index].Value = chiPhiBangKe.NguoiBenhTuTra;

                                        indexItem++;
                                        index++;
                                    }
                                }
                            }
                            else
                            {

                                foreach (var chiPhiBangKe in groupChiPhiBangKe)
                                {
                                    worksheet.Cells["A" + index + ":N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["A" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                    worksheet.Cells["A" + index + ":N" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));

                                    worksheet.Cells["A" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["A" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                    worksheet.Cells["A" + index].Value = indexItem;

                                    worksheet.Cells["B" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["B" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                    worksheet.Cells["B" + index].Value = chiPhiBangKe.NoiDung;

                                    worksheet.Cells["C" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["C" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                    worksheet.Cells["C" + index].Value = chiPhiBangKe.DonViTinh;

                                    worksheet.Cells["D" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["D" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                    worksheet.Cells["D" + index].Value = chiPhiBangKe.SoLuong;

                                    worksheet.Cells["E" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["E" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["E" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["E" + index].Value = chiPhiBangKe.DonGiaBV;

                                    worksheet.Cells["F" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["F" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["F" + index].Value = chiPhiBangKe.DonGiaBH;

                                    worksheet.Cells["G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["G" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["G" + index].Value = chiPhiBangKe.TiLeThanhToanTheoDV;

                                    worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["H" + index].Value = chiPhiBangKe.ThanhTienBV;

                                    worksheet.Cells["I" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["I" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["I" + index].Value = Convert.ToDouble(chiPhiBangKe.MucHuongBaoHiem > 0 ? 100 : 0).ApplyFormatMoneyToDouble();


                                    worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["J" + index].Value = chiPhiBangKe.ThanhTienBH;


                                    worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["K" + index].Value = chiPhiBangKe.QuyBHYT;


                                    worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["L" + index].Value = chiPhiBangKe.NguoiBenhCungChiTra;


                                    worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["M" + index].Value = chiPhiBangKe.Khac;


                                    worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["N" + index].Value = chiPhiBangKe.NguoiBenhTuTra;

                                    indexItem++;
                                    index++;
                                }
                            }

                        }
                        worksheet.Cells["A" + index + ":G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        worksheet.Cells["A" + index + ":G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        worksheet.Cells["A" + index + ":G" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                        worksheet.Cells["A" + index + ":G" + index].Merge = true;
                        worksheet.Cells["A" + index + ":G" + index].Value = "Tổng cộng";
                        worksheet.Cells["A" + index + ":G" + index].Style.Font.Bold = true;

                        worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                        worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                        worksheet.Cells["H" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.ThanhTienBV)).Sum();

                        worksheet.Cells["I" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        worksheet.Cells["I" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;

                        worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                        worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                        worksheet.Cells["J" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.ThanhTienBH)).Sum();

                        worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                        worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                        worksheet.Cells["K" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.QuyBHYT)).Sum();

                        worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                        worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                        worksheet.Cells["L" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.NguoiBenhCungChiTra)).Sum();

                        worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                        worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                        worksheet.Cells["M" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.Khac)).Sum();

                        worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                        worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                        worksheet.Cells["N" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.NguoiBenhTuTra)).Sum();

                        index++;

                        worksheet.Cells["A" + index + ":N" + index].Merge = true;
                        worksheet.Cells["A" + index + ":N" + index].Value = "Tổng chi phí lần khám bệnh/cả đợt điều trị: " + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + " đồng";
                        worksheet.Cells["A" + index + ":N" + index].Style.Font.Bold = true;

                        index++;

                        worksheet.Cells["A" + index + ":N" + index].Merge = true;
                        worksheet.Cells["A" + index + ":N" + index].Value = "(Viết bằng chữ: " + NumberHelper.ChuyenSoRaText(Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBV))) + ")";

                        index++;

                        worksheet.Cells["A" + index + ":N" + index].Merge = true;
                        worksheet.Cells["A" + index + ":N" + index].Value = "Trong đó , số tiền do:";
                        worksheet.Cells["A" + index + ":N" + index].Style.Font.Bold = true;

                        index++;
                        worksheet.Cells["A" + index + ":N" + index].Merge = true;
                        worksheet.Cells["A" + index + ":N" + index].Value = "- Quỹ BHYT thanh toán: " + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble();

                        index++;
                        worksheet.Cells["A" + index + ":N" + index].Merge = true;
                        worksheet.Cells["A" + index + ":N" + index].Value = "- Người bệnh trả trong đó: " + (Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)) + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhTuTra))).ApplyFormatMoneyToDouble();

                        index++;
                        worksheet.Cells["A" + index + ":N" + index].Merge = true;
                        worksheet.Cells["A" + index + ":N" + index].Value = "+ Cùng chi trả trong phạm vi BHYT: " + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble(true);

                        index++;
                        worksheet.Cells["A" + index + ":N" + index].Merge = true;
                        worksheet.Cells["A" + index + ":N" + index].Value = "+ Các khoản phải trả khác: " + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true);

                        index++;
                        worksheet.Cells["A" + index + ":N" + index].Merge = true;
                        worksheet.Cells["A" + index + ":N" + index].Value = "+ Nguồn khác: " + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble(true);


                        index = index + 2;

                        worksheet.Cells["D" + index + ":F" + index].Style.Font.SetFromFont(new Font("Times New Roman", 12));
                        worksheet.Cells["D" + index + ":F" + index].Merge = true;
                        worksheet.Cells["D" + index + ":F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        worksheet.Cells["D" + index + ":F" + index].Style.VerticalAlignment = ExcelVerticalAlignment.Top;
                        worksheet.Cells["D" + index + ":F" + index].Value = $"Ngày {DateTime.Now.Day} tháng {DateTime.Now.Month} năm {DateTime.Now.Year}";

                        worksheet.Cells["G" + index + ":I" + index].Style.Font.SetFromFont(new Font("Times New Roman", 12));
                        worksheet.Cells["G" + index + ":I" + index].Merge = true;
                        worksheet.Cells["G" + index + ":I" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        worksheet.Cells["G" + index + ":I" + index].Style.VerticalAlignment = ExcelVerticalAlignment.Top;
                        worksheet.Cells["G" + index + ":I" + index].Value = $"Ngày {DateTime.Now.Day} tháng {DateTime.Now.Month} năm {DateTime.Now.Year}";

                        worksheet.Cells["J" + index + ":N" + index].Style.Font.Bold = true;
                        worksheet.Cells["J" + index + ":N" + index].Merge = true;
                        worksheet.Cells["J" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        worksheet.Cells["J" + index + ":N" + index].Value = "XÁC NHẬN CỦA NGƯỜI BỆNH ";

                        index++;

                        worksheet.Cells["A" + index + ":C" + index].Style.Font.Bold = true;
                        worksheet.Cells["A" + index + ":C" + index].Merge = true;
                        worksheet.Cells["A" + index + ":C" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        worksheet.Cells["A" + index + ":C" + index].Value = "NGƯỜI LẬP BẢNG KÊ";

                        worksheet.Cells["D" + index + ":F" + index].Style.Font.Bold = true;
                        worksheet.Cells["D" + index + ":F" + index].Merge = true;
                        worksheet.Cells["D" + index + ":F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        worksheet.Cells["D" + index + ":F" + index].Value = "KẾ TOÁN VIỆN PHÍ";

                        worksheet.Cells["G" + index + ":I" + index].Style.Font.Bold = true;
                        worksheet.Cells["G" + index + ":I" + index].Merge = true;
                        worksheet.Cells["G" + index + ":I" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        worksheet.Cells["G" + index + ":I" + index].Value = "GIÁM ĐỊNH BHYT";

                        worksheet.Cells["J" + index + ":N" + index].Style.Font.Bold = true;
                        worksheet.Cells["J" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        worksheet.Cells["J" + index + ":N" + index].Merge = true;
                        worksheet.Cells["J" + index + ":N" + index].Value = "(Ký , Ghi rõ họ tên)";

                        index++;

                        worksheet.Cells["A" + index + ":C" + index].Style.Font.Bold = true;
                        worksheet.Cells["A" + index + ":C" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        worksheet.Cells["A" + index + ":C" + index].Merge = true;
                        worksheet.Cells["A" + index + ":C" + index].Value = "(Ký , Ghi rõ họ tên)";


                        worksheet.Cells["D" + index + ":F" + index].Style.Font.Bold = true;
                        worksheet.Cells["D" + index + ":F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        worksheet.Cells["D" + index + ":F" + index].Merge = true;
                        worksheet.Cells["D" + index + ":F" + index].Value = "(Ký , Ghi rõ họ tên)";

                        worksheet.Cells["G" + index + ":I" + index].Style.Font.Bold = true;
                        worksheet.Cells["G" + index + ":I" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        worksheet.Cells["G" + index + ":I" + index].Merge = true;
                        worksheet.Cells["G" + index + ":I" + index].Value = "(Ký , Ghi rõ họ tên)";

                        worksheet.Cells["J" + index + ":N" + index].Style.Font.Bold = true;
                        worksheet.Cells["J" + index + ":N" + index].Merge = true;
                        worksheet.Cells["J" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        worksheet.Cells["J" + index + ":N" + index].Value = "(Tôi đã nhận...phim...Xquang / CT / MRI)";

                        xlPackage.Save();
                    }
                }

                return stream.ToArray();
            }
        }

        public byte[] XuatBangKeChuaQuyetToanTrongGoiDv(long yeuCauTiepNhanId)
        {
            var danhSachChiPhi = GetTatCaDichVuKhamChuaBenh(yeuCauTiepNhanId).Result.Where(o => !o.Soluong.AlmostEqual(0) && o.YeuCauGoiDichVuId != null).ToList();
            if (danhSachChiPhi.Count == 0)
            {
                return null;
            }
            var yeuCauTiepNhan = BaseRepository.GetById(yeuCauTiepNhanId,
                x => x.Include(o => o.NoiTruBenhAn).ThenInclude(o => o.ChuyenDenBenhVien)
                    .Include(o => o.NoiTruBenhAn).ThenInclude(o => o.KhoaPhongNhapVien)
                    .Include(o => o.NoiTruBenhAn).ThenInclude(o => o.ChanDoanChinhRaVienICD)
                    .Include(o => o.YeuCauTiepNhanTheBHYTs)
                    .Include(o => o.YeuCauNhapVien).ThenInclude(o => o.YeuCauKhamBenh).ThenInclude(o => o.YeuCauTiepNhan)
                    .Include(o => o.BenhNhan)
                    .Include(o => o.PhuongXa)
                    .Include(o => o.QuanHuyen)
                    .Include(o => o.TinhThanh)
                    .Include(o => o.NoiTruBenhAn).ThenInclude(o => o.NoiTruPhieuDieuTris).ThenInclude(c => c.ChanDoanChinhICD)
                    .Include(o => o.NoiTruBenhAn).ThenInclude(o => o.NoiTruPhieuDieuTris).ThenInclude(o => o.NoiTruThamKhamChanDoanKemTheos).ThenInclude(c => c.ICD)
                    .Include(o => o.NoiChuyen).Include(o => o.NoiTruBenhAn).ThenInclude(o => o.NoiTruKhoaPhongDieuTris).ThenInclude(c => c.KhoaPhongChuyenDen));

            var benhVien = new Core.Domain.Entities.BenhVien.BenhVien();
            string maBHYT = string.Empty;
            string bHYTTuNgay = string.Empty;
            string bHYTDenNgay = string.Empty;
            string mucHuong = string.Empty;
            string NoiDKKCBBanDau = string.Empty;
            string MaKCBBanDau = string.Empty;


            string maICDKemTheo = string.Empty;
            string tenICDKemTheo = string.Empty;
            string chuanDoanXacDinhSanKhoa = string.Empty;
            string maICD10 = string.Empty;

            if (yeuCauTiepNhan.NoiTruBenhAn != null && (yeuCauTiepNhan.NoiTruBenhAn.LoaiBenhAn == LoaiBenhAn.SanKhoaMo || yeuCauTiepNhan.NoiTruBenhAn.LoaiBenhAn == LoaiBenhAn.SanKhoaThuong))
            {
                if (yeuCauTiepNhan.NoiTruBenhAn?.NoiTruPhieuDieuTris.Count() > 0)
                {
                    var phieuDieuTri = yeuCauTiepNhan.NoiTruBenhAn?.NoiTruPhieuDieuTris.OrderByDescending(c => c.NgayDieuTri).FirstOrDefault();

                    var icdKemTheoIds = phieuDieuTri.NoiTruThamKhamChanDoanKemTheos.Select(c => c.ICD.Ma);
                    var tenICDKemTheos = phieuDieuTri.NoiTruThamKhamChanDoanKemTheos.Select(c => c.GhiChu);

                    maICDKemTheo = string.Join(", ", icdKemTheoIds);
                    tenICDKemTheo = string.Join(", ", tenICDKemTheos);

                    maICD10 = phieuDieuTri.ChanDoanChinhICD?.Ma;
                    chuanDoanXacDinhSanKhoa = phieuDieuTri.ChanDoanChinhGhiChu;
                }
            }
            else
            {
                if (!string.IsNullOrEmpty(yeuCauTiepNhan.NoiTruBenhAn?.DanhSachChanDoanKemTheoRaVienICDId))
                {
                    var maICDKemTheos = new List<string>();

                    var icdKemTheoIds = yeuCauTiepNhan.NoiTruBenhAn?.DanhSachChanDoanKemTheoRaVienICDId.Split(Constants.ICDSeparator);
                    var tenICDKemTheos = yeuCauTiepNhan.NoiTruBenhAn?.DanhSachChanDoanKemTheoRaVienGhiChu?.Split(Constants.ICDSeparator);

                    if (icdKemTheoIds.Length > 0)
                    {
                        foreach (var icdKemTheoId in icdKemTheoIds)
                        {
                            var icdKemTheo = _icdRepository.TableNoTracking.FirstOrDefault(o => o.Id == long.Parse(icdKemTheoId));
                            if (icdKemTheo != null)
                            {
                                maICDKemTheos.Add(icdKemTheo.Ma);
                            }
                        }
                    }

                    maICDKemTheo = string.Join(", ", maICDKemTheos);
                    tenICDKemTheo = string.Join(", ", tenICDKemTheos);
                }
            }



            YeuCauTiepNhanTheBHYT theBHYT = null;
            if (yeuCauTiepNhan.CoBHYT == true && yeuCauTiepNhan.YeuCauTiepNhanTheBHYTs.Any())
            {
                theBHYT = yeuCauTiepNhan.YeuCauTiepNhanTheBHYTs.First();
                if (!String.IsNullOrEmpty(theBHYT.MaDKBD))
                {
                    benhVien = _benhVienRepository.TableNoTracking.FirstOrDefault(p => p.Ma.Equals(theBHYT.MaDKBD));
                }
                maBHYT = theBHYT.MaSoThe;
                bHYTTuNgay = theBHYT.NgayHieuLuc.ApplyFormatDate();
                bHYTDenNgay = theBHYT.NgayHetHan?.ApplyFormatDate();
                mucHuong = theBHYT.MucHuong.ToString() + "%";
                NoiDKKCBBanDau = benhVien != null ? benhVien?.Ten : "Chưa xác định";
                MaKCBBanDau = theBHYT.MaDKBD;
            }
            else
            {
                maBHYT = "";
                bHYTTuNgay = "";
                bHYTDenNgay = "";
                mucHuong = "0%";
                NoiDKKCBBanDau = "Chưa xác định";
                MaKCBBanDau = "Chưa xác định";
            }

            var dsChiPhiBangKe = new List<BangKeKhamBenhBenhVienVo>();
            var dateItemChiPhis = string.Empty;
            int indexItem = 1;

            using (var stream = new MemoryStream())
            {
                using (var xlPackage = new ExcelPackage(stream))
                {

                    var worksheet = xlPackage.Workbook.Worksheets.Add("BẢNG KÊ CHI PHÍ ĐIỀU TRỊ NỘI TRÚ 3");

                    // set row
                    worksheet.Row(9).Height = 24.5;
                    worksheet.DefaultRowHeight = 16;

                    //SET chiều rộng cho từng cột tương ứng
                    worksheet.Column(1).Width = 10;
                    worksheet.Column(2).Width = 25;
                    worksheet.Column(3).Width = 15;
                    worksheet.Column(4).Width = 15;
                    worksheet.Column(5).Width = 15;
                    worksheet.Column(6).Width = 15;
                    worksheet.Column(7).Width = 15;
                    worksheet.Column(8).Width = 15;
                    worksheet.Column(9).Width = 15;
                    worksheet.Column(10).Width = 15;
                    worksheet.Column(11).Width = 15;
                    worksheet.Column(12).Width = 15;
                    worksheet.Column(13).Width = 15;
                    worksheet.Column(14).Width = 15;

                    worksheet.DefaultColWidth = 7;

                    using (var range = worksheet.Cells["A1:C1"])
                    {
                        range.Worksheet.Cells["A1:C1"].Merge = true;
                        range.Worksheet.Cells["A1:C1"].Value = "CƠ SỞ KHÁM CHỮA BỆNH : BỆNH VIỆN ĐKQT BẮC HÀ";
                        range.Worksheet.Cells["A1:C1"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A1:C1"].Style.VerticalAlignment = ExcelVerticalAlignment.Bottom;
                        range.Worksheet.Cells["A1:C1"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A1:C1"].Style.Font.Color.SetColor(Color.Black);
                    }


                    var khoaPhong = yeuCauTiepNhan.NoiTruBenhAn?.NoiTruKhoaPhongDieuTris.OrderByDescending(c => c.ThoiDiemVaoKhoa).Select(c => c.KhoaPhongChuyenDen).FirstOrDefault();
                    var chuyenKhoa = GetChuyenKhoa(khoaPhong?.Id); //BVHD-3792 

                    using (var range = worksheet.Cells["A2:C2"])
                    {
                        range.Worksheet.Cells["A2:C2"].Merge = true;
                        range.Worksheet.Cells["A2:C2"].Value = "Khoa: " + khoaPhong?.Ten;
                        range.Worksheet.Cells["A2:C2"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A2:C2"].Style.VerticalAlignment = ExcelVerticalAlignment.Bottom;
                        range.Worksheet.Cells["A2:C2"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A2:C2"].Style.Font.Color.SetColor(Color.Black);
                        range.Worksheet.Cells["A2:C2"].Style.Font.Bold = true;
                    }

                    using (var range = worksheet.Cells["A3:C3"])
                    {
                        range.Worksheet.Cells["A3:C3"].Merge = true;
                        range.Worksheet.Cells["A3:C3"].Value = "Mã khoa: " + chuyenKhoa?.Ma;
                        range.Worksheet.Cells["A3:C3"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A3:C3"].Style.VerticalAlignment = ExcelVerticalAlignment.Bottom;
                        range.Worksheet.Cells["A3:C3"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A3:C3"].Style.Font.Color.SetColor(Color.Black);
                        range.Worksheet.Cells["A3:C3"].Style.Font.Bold = true;
                    }

                    using (var range = worksheet.Cells["L1:N1"])
                    {
                        range.Worksheet.Cells["L1:N1"].Merge = true;
                        range.Worksheet.Cells["L1:N1"].Value = "Mẫu số : 01/KBCB ";
                        range.Worksheet.Cells["L1:N1"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                        range.Worksheet.Cells["L1:N1"].Style.VerticalAlignment = ExcelVerticalAlignment.Bottom;
                        range.Worksheet.Cells["L1:N1"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["L1:N1"].Style.Font.Color.SetColor(Color.Black);
                        range.Worksheet.Cells["L1:N1"].Style.Font.Bold = true;
                    }

                    using (var range = worksheet.Cells["L2:N2"])
                    {
                        range.Worksheet.Cells["L2:N2"].Merge = true;
                        range.Worksheet.Cells["L2:N2"].Value = "Mã số người bệnh: " + yeuCauTiepNhan.BenhNhan.MaBN;
                        range.Worksheet.Cells["L2:N2"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                        range.Worksheet.Cells["L2:N2"].Style.VerticalAlignment = ExcelVerticalAlignment.Bottom;
                        range.Worksheet.Cells["L2:N2"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["L2:N2"].Style.Font.Color.SetColor(Color.Black);
                        range.Worksheet.Cells["L2:N2"].Style.Font.Bold = true;
                    }

                    using (var range = worksheet.Cells["L3:N3"])
                    {
                        range.Worksheet.Cells["L3:N3"].Merge = true;
                        range.Worksheet.Cells["L3:N3"].Value = "Số khám bệnh:" + yeuCauTiepNhan.MaYeuCauTiepNhan;
                        range.Worksheet.Cells["L3:N3"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                        range.Worksheet.Cells["L3:N3"].Style.VerticalAlignment = ExcelVerticalAlignment.Bottom;
                        range.Worksheet.Cells["L3:N3"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["L3:N3"].Style.Font.Color.SetColor(Color.Black);
                        range.Worksheet.Cells["L3:N3"].Style.Font.Bold = true;
                    }

                    using (var range = worksheet.Cells["L4:N4"])
                    {
                        range.Worksheet.Cells["L4:N4"].Merge = true;
                        range.Worksheet.Cells["L4:N4"].Value = "Số bệnh án: " + yeuCauTiepNhan.NoiTruBenhAn?.SoBenhAn;
                        range.Worksheet.Cells["L4:N4"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                        range.Worksheet.Cells["L4:N4"].Style.VerticalAlignment = ExcelVerticalAlignment.Bottom;
                        range.Worksheet.Cells["L4:N4"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["L4:N4"].Style.Font.Color.SetColor(Color.Black);
                        range.Worksheet.Cells["L4:N4"].Style.Font.Bold = true;
                    }

                    using (var range = worksheet.Cells["A5:N6"])
                    {
                        range.Worksheet.Cells["A5:N6"].Merge = true;
                        range.Worksheet.Cells["A5:N6"].Value = "BẢNG KÊ CHI PHÍ ĐIỀU TRỊ NỘI TRÚ 3";
                        range.Worksheet.Cells["A5:N6"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        range.Worksheet.Cells["A5:N6"].Style.VerticalAlignment = ExcelVerticalAlignment.Bottom;
                        range.Worksheet.Cells["A5:N6"].Style.Font.SetFromFont(new Font("Times New Roman", 18));
                        range.Worksheet.Cells["A5:N6"].Style.Font.Color.SetColor(Color.Black);
                        range.Worksheet.Cells["A5:N6"].Style.Font.Bold = true;
                    }

                    using (var range = worksheet.Cells["A7:N7"])
                    {
                        range.Worksheet.Cells["A7:N7"].Merge = true;
                        range.Worksheet.Cells["A7:N7"].Value = "I.Hành chính";
                        range.Worksheet.Cells["A7:N7"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A7:N7"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A7:N7"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A7:N7"].Style.Font.Color.SetColor(Color.Black);
                        range.Worksheet.Cells["A7:N7"].Style.Font.Bold = true;
                    }

                    using (var range = worksheet.Cells["A8:F8"])
                    {
                        range.Worksheet.Cells["A8:F8"].Merge = true;

                        range.Worksheet.Cells["A8:F8"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["A8:F8"].RichText.Add("(1) Họ tên người bệnh: ");
                        var value = range.Worksheet.Cells["A8:F8"].RichText.Add(yeuCauTiepNhan.HoTen);
                        value.Bold = true;

                        range.Worksheet.Cells["A8:F8"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A8:F8"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A8:F8"].Style.Font.SetFromFont(new Font("Times New Roman", 11));


                        range.Worksheet.Cells["A8:F8"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["G8:J8"])
                    {
                        range.Worksheet.Cells["G8:J8"].Merge = true;
                        range.Worksheet.Cells["G8:J8"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["G8:J8"].RichText.Add("Ngày,tháng,năm sinh: ");
                        var value = range.Worksheet.Cells["G8:J8"].RichText.Add(DateHelper.DOBFormat(yeuCauTiepNhan.NgaySinh, yeuCauTiepNhan.ThangSinh, yeuCauTiepNhan.NamSinh));
                        value.Bold = true;

                        range.Worksheet.Cells["G8:J8"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["G8:J8"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["G8:J8"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["G8:J8"].Style.Font.Color.SetColor(Color.Black);
                    }

                    var gioitinh = yeuCauTiepNhan.GioiTinh != null ? yeuCauTiepNhan.GioiTinh.GetDescription() : "";
                    using (var range = worksheet.Cells["K8:N8"])
                    {
                        range.Worksheet.Cells["K8:N8"].Merge = true;

                        range.Worksheet.Cells["K8:N8"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["K8:N8"].RichText.Add("Giới tính: ");
                        var value = range.Worksheet.Cells["K8:N8"].RichText.Add(gioitinh);
                        value.Bold = true;

                        range.Worksheet.Cells["K8:N8"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["K8:N8"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["K8:N8"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["K8:N8"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["A9:F9"])
                    {
                        range.Worksheet.Cells["A9:F9"].Merge = true;

                        range.Worksheet.Cells["A9:F9"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["A9:F9"].RichText.Add("(2)Địa chỉ hiện tại: ");
                        var value = range.Worksheet.Cells["A9:F9"].RichText.Add(yeuCauTiepNhan.DiaChiDayDu);
                        value.Bold = true;

                        range.Worksheet.Cells["A9:F9"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A9:F9"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A9:F9"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A9:F9"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["G9:J9"])
                    {
                        range.Worksheet.Cells["G9:J9"].Merge = true;

                        range.Worksheet.Cells["G9:J9"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["G9:J9"].RichText.Add("(3)Mã khu vực(K1/K2/K3): ");
                        var value = range.Worksheet.Cells["G9:J9"].RichText.Add(yeuCauTiepNhan.BHYTMaKhuVuc);
                        value.Bold = true;

                        range.Worksheet.Cells["G9:J9"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["G9:J9"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["G9:J9"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["G9:J9"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["A10:F10"])
                    {
                        range.Worksheet.Cells["A10:F10"].Merge = true;
                        range.Worksheet.Cells["A10:F10"].Style.WrapText = true;

                        var title = range.Worksheet.Cells["A10:F10"].RichText.Add("(4)Mã thẻ BHYT: ");
                        var value = range.Worksheet.Cells["A10:F10"].RichText.Add(maBHYT);
                        value.Bold = true;

                        range.Worksheet.Cells["A10:F10"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A10:F10"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A10:F10"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A10:F10"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["G10:J10"])
                    {
                        range.Worksheet.Cells["G10:J10"].Merge = true;
                        range.Worksheet.Cells["G10:J10"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["G10:J10"].RichText.Add("Giá trị từ: ");
                        var valuebHYTTuNgay = range.Worksheet.Cells["G10:J10"].RichText.Add(bHYTTuNgay);
                        valuebHYTTuNgay.Bold = true;

                        var den = range.Worksheet.Cells["G10:J10"].RichText.Add(" đến: ");
                        den.Bold = false;
                        var valuebHYTDenNgay = range.Worksheet.Cells["G10:J10"].RichText.Add(bHYTDenNgay);
                        valuebHYTDenNgay.Bold = true;


                        range.Worksheet.Cells["G10:J10"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["G10:J10"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["G10:J10"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["G10:J10"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["A11:F11"])
                    {
                        range.Worksheet.Cells["A11:F11"].Merge = true;

                        range.Worksheet.Cells["A11:F11"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["A11:F11"].RichText.Add("(5)Nơi ĐK KCB ban đầu: ");
                        var valueNoiDKKCBBanDau = range.Worksheet.Cells["A11:F11"].RichText.Add(NoiDKKCBBanDau);
                        valueNoiDKKCBBanDau.Bold = true;

                        range.Worksheet.Cells["A11:F11"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A11:F11"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A11:F11"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A11:F11"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["G11:J11"])
                    {
                        range.Worksheet.Cells["G11:J11"].Merge = true;
                        range.Worksheet.Cells["G11:J11"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["G11:J11"].RichText.Add("(6)Mã: ");
                        var valueMaKCBBanDau = range.Worksheet.Cells["G11:J11"].RichText.Add(MaKCBBanDau);
                        valueMaKCBBanDau.Bold = true;

                        range.Worksheet.Cells["G11:J11"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["G11:J11"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["G11:J11"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["G11:J11"].Style.Font.Color.SetColor(Color.Black);
                    }


                    using (var range = worksheet.Cells["A12:F12"])
                    {
                        range.Worksheet.Cells["A12:F12"].Merge = true;

                        range.Worksheet.Cells["A12:F12"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["A12:F12"].RichText.Add("(7)Đến Khám: ");
                        var value = range.Worksheet.Cells["A12:F12"].RichText.Add(yeuCauTiepNhan.ThoiDiemTiepNhan.ApplyFormatGioPhutNgay());
                        value.Bold = true;

                        range.Worksheet.Cells["A12:F12"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A12:F12"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A12:F12"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A12:F12"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["A13:F13"])
                    {
                        range.Worksheet.Cells["A13:F13"].Merge = true;

                        range.Worksheet.Cells["A13:F13"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["A13:F13"].RichText.Add("(8)Điều trị ngoại trú/nội trú từ: ");
                        var value = range.Worksheet.Cells["A13:F13"].RichText.Add(yeuCauTiepNhan.NoiTruBenhAn?.ThoiDiemNhapVien.ApplyFormatGioPhutNgay());
                        value.Bold = true;

                        range.Worksheet.Cells["A13:F13"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A13:F13"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A13:F13"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A13:F13"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["A14:F14"])
                    {
                        range.Worksheet.Cells["A14:F14"].Merge = true;
                        range.Worksheet.Cells["A14:F14"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["A14:F14"].RichText.Add("(9)Kết thúc khám/điều trị: ");
                        var value = range.Worksheet.Cells["A14:F14"].RichText.Add(yeuCauTiepNhan.NoiTruBenhAn?.ThoiDiemRaVien?.ApplyFormatGioPhutNgay());
                        value.Bold = true;


                        range.Worksheet.Cells["A14:F14"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A14:F14"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A14:F14"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A14:F14"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["G14:J14"])
                    {
                        range.Worksheet.Cells["G14:J14"].Merge = true;
                        range.Worksheet.Cells["G14:J14"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["G14:J14"].RichText.Add("Tổng số ngày điều trị: ");
                        var value = range.Worksheet.Cells["G14:J14"].RichText.Add(NoiTruBenhAnHelper.TinhSoNgayDieuTri(yeuCauTiepNhan.NoiTruBenhAn)?.ToString() ?? string.Empty);
                        value.Bold = true;

                        range.Worksheet.Cells["G14:J14"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["G14:J14"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["G14:J14"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["G14:J14"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["K14:N14"])
                    {
                        range.Worksheet.Cells["K14:N14"].Merge = true;

                        range.Worksheet.Cells["K14:N14"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["K14:N14"].RichText.Add("(10)Tình trạng ra viện: ");
                        var value = range.Worksheet.Cells["K14:N14"].RichText.Add((yeuCauTiepNhan.NoiTruBenhAn?.TinhTrangRaVien == EnumTinhTrangRaVien.RaVien && (yeuCauTiepNhan.NoiTruBenhAn?.KetQuaDieuTri == EnumKetQuaDieuTri.Do || yeuCauTiepNhan.NoiTruBenhAn?.KetQuaDieuTri == EnumKetQuaDieuTri.Khoi) ? 1 : 2).ToString());
                        value.Bold = true;


                        range.Worksheet.Cells["K14:N14"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["K14:N14"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["K14:N14"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["K14:N14"].Style.Font.Color.SetColor(Color.Black);
                    }

                    //=================================15=================================
                    var coCapCuu = yeuCauTiepNhan.LyDoVaoVien == Enums.EnumLyDoVaoVien.CapCuu ? "X" : string.Empty;
                    var coDungTuyen = yeuCauTiepNhan.LyDoVaoVien == Enums.EnumLyDoVaoVien.DungTuyen ? "X" : string.Empty;
                    var coThongTuyen = yeuCauTiepNhan.LyDoVaoVien == Enums.EnumLyDoVaoVien.ThongTuyen ? "X" : string.Empty;
                    var coTraiTuyen = yeuCauTiepNhan.LyDoVaoVien == Enums.EnumLyDoVaoVien.TraiTuyen ? "X" : string.Empty;

                    using (var range = worksheet.Cells["A15:C15"])
                    {
                        range.Worksheet.Cells["A15:C15"].Merge = true;

                        range.Worksheet.Cells["A15:C15"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["A15:C15"].RichText.Add("(11) Cấp cứu: ");
                        var value = range.Worksheet.Cells["A15:C15"].RichText.Add(coCapCuu);
                        value.Bold = true;

                        range.Worksheet.Cells["A15:C15"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A15:C15"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A15:C15"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A15:C15"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["D15:F15"])
                    {
                        range.Worksheet.Cells["D15:F15"].Merge = true;
                        range.Worksheet.Cells["D15:F15"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["D15:F15"].RichText.Add("(12) Đúng tuyến: ");
                        var value = range.Worksheet.Cells["D15:F15"].RichText.Add(coDungTuyen);
                        value.Bold = true;

                        range.Worksheet.Cells["D15:F15"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["D15:F15"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["D15:F15"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["D15:F15"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["G15:J15"])
                    {
                        range.Worksheet.Cells["G15:J15"].Merge = true;
                        range.Worksheet.Cells["G15:J15"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["G15:J15"].RichText.Add("Nơi chuyến đến: ");
                        var value = range.Worksheet.Cells["G15:J15"].RichText.Add(yeuCauTiepNhan.NoiChuyen?.Ten);
                        value.Bold = true;
                        range.Worksheet.Cells["G15:J15"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["G15:J15"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["G15:J15"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["G15:J15"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["K15:N15"])
                    {
                        range.Worksheet.Cells["K15:N15"].Merge = true;
                        range.Worksheet.Cells["K15:N15"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["K15:N15"].RichText.Add("Nơi chuyển đi: ");
                        var value = range.Worksheet.Cells["K15:N15"].RichText.Add(yeuCauTiepNhan.NoiTruBenhAn?.ChuyenDenBenhVien?.Ten);
                        value.Bold = true;
                        range.Worksheet.Cells["K15:N15"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["K15:N15"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["K15:N15"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["K15:N15"].Style.Font.Color.SetColor(Color.Black);
                    }

                    //=================================16=================================
                    using (var range = worksheet.Cells["A16:C16"])
                    {
                        range.Worksheet.Cells["A16:C16"].Merge = true;
                        range.Worksheet.Cells["A16:C16"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["A16:C16"].RichText.Add("(13)Thông tuyến: ");
                        var value = range.Worksheet.Cells["A16:C16"].RichText.Add(coThongTuyen);
                        value.Bold = true;
                        range.Worksheet.Cells["A16:C16"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A16:C16"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A16:C16"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A16:C16"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["D16:F16"])
                    {
                        range.Worksheet.Cells["D16:F16"].Merge = true;
                        range.Worksheet.Cells["D16:F16"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["D16:F16"].RichText.Add("(14)Trái tuyến: ");
                        var value = range.Worksheet.Cells["D16:F16"].RichText.Add(coTraiTuyen);
                        value.Bold = true;

                        range.Worksheet.Cells["D16:F16"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["D16:F16"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["D16:F16"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["D16:F16"].Style.Font.Color.SetColor(Color.Black);
                    }

                    //================================= 17 =================================

                    var chuanDoanXacDinhStr = yeuCauTiepNhan.NoiTruBenhAn?.LoaiBenhAn == LoaiBenhAn.SanKhoaMo || yeuCauTiepNhan.NoiTruBenhAn?.LoaiBenhAn == LoaiBenhAn.SanKhoaThuong
                                                             ? chuanDoanXacDinhSanKhoa : yeuCauTiepNhan.NoiTruBenhAn?.ChanDoanChinhRaVienGhiChu;


                    var iCD10 = yeuCauTiepNhan.NoiTruBenhAn?.LoaiBenhAn == LoaiBenhAn.SanKhoaMo || yeuCauTiepNhan.NoiTruBenhAn?.LoaiBenhAn == LoaiBenhAn.SanKhoaThuong
                                                               ? maICD10 : yeuCauTiepNhan.NoiTruBenhAn?.ChanDoanChinhRaVienICD?.Ma;


                    using (var range = worksheet.Cells["A17:F17"])
                    {
                        range.Worksheet.Cells["A17:F17"].Merge = true;
                        range.Worksheet.Cells["A17:F17"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["A17:F17"].RichText.Add("(15)Chẩn đoán xác định: ");
                        var value = range.Worksheet.Cells["A17:F17"].RichText.Add(chuanDoanXacDinhStr);
                        value.Bold = true;

                        range.Worksheet.Cells["A17:F17"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A17:F17"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A17:F17"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A17:F17"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["G17:N17"])
                    {
                        range.Worksheet.Cells["G17:N17"].Merge = true;

                        range.Worksheet.Cells["G17:N17"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["G17:N17"].RichText.Add("(17) Mã bệnh: ");
                        var value = range.Worksheet.Cells["G17:N17"].RichText.Add(iCD10);
                        value.Bold = true;


                        range.Worksheet.Cells["G17:N17"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["G17:N17"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["G17:N17"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["G17:N17"].Style.Font.Color.SetColor(Color.Black);
                    }

                    //================================= 18 =================================

                    using (var range = worksheet.Cells["A18:F18"])
                    {
                        range.Worksheet.Cells["A18:F18"].Merge = true;
                        range.Worksheet.Cells["A18:F18"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["A18:F18"].RichText.Add("(18)Bệnh kèm theo: ");
                        var value = range.Worksheet.Cells["A18:F18"].RichText.Add(tenICDKemTheo);
                        value.Bold = true;


                        range.Worksheet.Cells["A18:F18"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A18:F18"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A18:F18"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A18:F18"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["G18:N18"])
                    {
                        range.Worksheet.Cells["G18:N18"].Merge = true;
                        range.Worksheet.Cells["G18:N18"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["G18:N18"].RichText.Add("(18)Mã bệnh kèm theo: ");
                        var value = range.Worksheet.Cells["G18:N18"].RichText.Add(maICDKemTheo);
                        value.Bold = true;


                        range.Worksheet.Cells["G18:N18"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["G18:N18"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["G18:N18"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["G18:N18"].Style.Font.Color.SetColor(Color.Black);
                    }

                    //================================= 19 =================================

                    using (var range = worksheet.Cells["A19:F19"])
                    {
                        range.Worksheet.Cells["A19:F19"].Merge = true;
                        range.Worksheet.Cells["A19:F19"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["A19:F19"].RichText.Add("(19)Thời điểm đủ 05 năm liên tục từ ngày: ");
                        var value = range.Worksheet.Cells["A19:F19"].RichText.Add(yeuCauTiepNhan.BHYTNgayDu5Nam?.ApplyFormatDate());
                        value.Bold = true;


                        range.Worksheet.Cells["A19:F19"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A19:F19"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A19:F19"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A19:F19"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["G19:N19"])
                    {
                        range.Worksheet.Cells["G19:N19"].Merge = true;
                        range.Worksheet.Cells["G19:N19"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["G19:N19"].RichText.Add("(20)Miễn cùng chi trả trong năm từ ngày: ");
                        var value = range.Worksheet.Cells["G19:N19"].RichText.Add(yeuCauTiepNhan.BHYTNgayDuocMienCungChiTra?.ApplyFormatDate());
                        value.Bold = true;

                        range.Worksheet.Cells["G19:N19"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["G19:N19"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["G19:N19"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["G19:N19"].Style.Font.Color.SetColor(Color.Black);
                    }

                    //================================= 20 =================================

                    using (var range = worksheet.Cells["A20:N20"])
                    {
                        range.Worksheet.Cells["A20:N20"].Merge = true;
                        range.Worksheet.Cells["A20:N20"].Value = "II. Phần Chi phí khám bệnh, chữa bệnh";
                        range.Worksheet.Cells["A20:N20"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A20:N20"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A20:N20"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A20:N20"].Style.Font.Color.SetColor(Color.Black);
                        range.Worksheet.Cells["A20:N20"].Style.Font.Bold = true;
                    }

                    int index = 21;


                    var groupChiPhiTheoThe = danhSachChiPhi.GroupBy(o => o.MaSoTheBHYT);
                    if (groupChiPhiTheoThe.Count() > 2 ||
                        (groupChiPhiTheoThe.All(o => o.Key != string.Empty) && groupChiPhiTheoThe.Count() > 1))
                    {
                        var groupNgayPhatSinhTheoThe = groupChiPhiTheoThe.Where(o => o.Key != string.Empty).Select(o => new { o.Key, o.OrderBy(j => j.NgayPhatSinh).First().NgayPhatSinh }).OrderBy(o => o.NgayPhatSinh).ToArray();
                        for (int i = 0; i < groupNgayPhatSinhTheoThe.Count(); i++)
                        {
                            var ngayPhatSinhTheoThe = groupNgayPhatSinhTheoThe[i];
                            var theBHYTChiTra = yeuCauTiepNhan.YeuCauTiepNhanTheBHYTs.First(o => o.MaSoThe == ngayPhatSinhTheoThe.Key);
                            var chiPhis = groupChiPhiTheoThe.FirstOrDefault(o => o.Key == ngayPhatSinhTheoThe.Key).ToList();
                            DateTime? ngayPhatSinhTiepTheo = i < groupNgayPhatSinhTheoThe.Count() - 1
                                ? groupNgayPhatSinhTheoThe[i + 1].NgayPhatSinh
                                : null;
                            chiPhis.AddRange(groupChiPhiTheoThe.FirstOrDefault(o => o.Key == string.Empty).Where(j => (i == 0 || j.NgayPhatSinh >= ngayPhatSinhTheoThe.NgayPhatSinh) && (ngayPhatSinhTiepTheo != null && j.NgayPhatSinh < ngayPhatSinhTiepTheo)).ToList());
                            var mucHuongPT = theBHYTChiTra != null && theBHYTChiTra.MucHuong > 0 ? theBHYTChiTra?.MucHuong + "%" : string.Empty;

                            using (var range = worksheet.Cells["A" + index + ":C" + index])
                            {
                                range.Worksheet.Cells["A" + index + ":C" + index].Merge = true;
                                range.Worksheet.Cells["A" + index + ":C" + index].Style.WrapText = true;
                                var title = range.Worksheet.Cells["A" + index + ":C" + index].RichText.Add("Mã thẻ BHYT: ");
                                var value = range.Worksheet.Cells["A" + index + ":C" + index].RichText.Add(theBHYTChiTra.MaSoThe);
                                value.Bold = true;

                                range.Worksheet.Cells["A" + index + ":C" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                range.Worksheet.Cells["A" + index + ":C" + index].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                                range.Worksheet.Cells["A" + index + ":C" + index].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                                range.Worksheet.Cells["A" + index + ":C" + index].Style.Font.Color.SetColor(Color.Black);
                            }

                            using (var range = worksheet.Cells["D" + index + ":F" + index])
                            {
                                range.Worksheet.Cells["D" + index + ":F" + index].Merge = true;
                                range.Worksheet.Cells["D" + index + ":F" + index].Style.WrapText = true;
                                var title = range.Worksheet.Cells["D" + index + ":F" + index].RichText.Add("Giá trị từ: ");
                                var valuebHYTTuNgay = range.Worksheet.Cells["D" + index + ":F" + index].RichText.Add(theBHYTChiTra.NgayHieuLuc.ApplyFormatDate());
                                valuebHYTTuNgay.Bold = true;

                                var den = range.Worksheet.Cells["D" + index + ":F" + index].RichText.Add(" đến: ");
                                den.Bold = false;
                                var valuebHYTDenNgay = range.Worksheet.Cells["D" + index + ":F" + index].RichText.Add(theBHYTChiTra?.NgayHetHan?.ApplyFormatDate());
                                valuebHYTDenNgay.Bold = true;

                                range.Worksheet.Cells["D" + index + ":F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                range.Worksheet.Cells["D" + index + ":F" + index].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                                range.Worksheet.Cells["D" + index + ":F" + index].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                                range.Worksheet.Cells["D" + index + ":F" + index].Style.Font.Color.SetColor(Color.Black);
                            }

                            using (var range = worksheet.Cells["G" + index + ":J" + index])
                            {
                                range.Worksheet.Cells["G" + index + ":J" + index].Merge = true;
                                range.Worksheet.Cells["G" + index + ":J" + index].Style.WrapText = true;
                                var title = range.Worksheet.Cells["G" + index + ":J" + index].RichText.Add("Mức hưởng: ");
                                var value = range.Worksheet.Cells["G" + index + ":J" + index].RichText.Add(mucHuongPT);
                                value.Bold = true;


                                range.Worksheet.Cells["G" + index + ":J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                range.Worksheet.Cells["G" + index + ":J" + index].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                                range.Worksheet.Cells["G" + index + ":J" + index].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                                range.Worksheet.Cells["G" + index + ":J" + index].Style.Font.Color.SetColor(Color.Black);
                            }

                            index++;

                            var indexTableFirst = index;
                            var indexTableLast = index + 1;

                            using (var range = worksheet.Cells["A" + indexTableFirst + ":N" + indexTableLast])
                            {
                                range.Worksheet.Cells["A" + indexTableFirst + ":N" + indexTableLast].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                                range.Worksheet.Cells["A" + indexTableFirst + ":N" + indexTableLast].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                                range.Worksheet.Cells["A" + indexTableFirst + ":N" + indexTableLast].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                range.Worksheet.Cells["A" + indexTableFirst + ":N" + indexTableLast].Style.Font.Color.SetColor(Color.Black);
                                range.Worksheet.Cells["A" + indexTableFirst + ":N" + indexTableLast].Style.Font.Bold = true;
                                range.Worksheet.Cells["A" + indexTableFirst + ":N" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);

                                range.Worksheet.Cells["A" + indexTableFirst + ":A" + indexTableLast].Merge = true;
                                range.Worksheet.Cells["A" + indexTableFirst + ":A" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["A" + indexTableFirst + ":A" + indexTableLast].Value = "STT";

                                range.Worksheet.Cells["B" + indexTableFirst + ":B" + indexTableLast].Merge = true;
                                range.Worksheet.Cells["B" + indexTableFirst + ":B" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["B" + indexTableFirst + ":B" + indexTableLast].Value = "Nội dung";

                                range.Worksheet.Cells["C" + indexTableFirst + ":C" + indexTableLast].Merge = true;
                                range.Worksheet.Cells["C" + indexTableFirst + ":C" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["C" + indexTableFirst + ":C" + indexTableLast].Value = "Đơn vị tính";

                                range.Worksheet.Cells["D" + indexTableFirst + ":D" + indexTableLast].Merge = true;
                                range.Worksheet.Cells["D" + indexTableFirst + ":D" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["D" + indexTableFirst + ":D" + indexTableLast].Value = "Số lượng";

                                range.Worksheet.Cells["E" + indexTableFirst + ":E" + indexTableLast].Merge = true;
                                range.Worksheet.Cells["E" + indexTableFirst + ":E" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["E" + indexTableFirst + ":E" + indexTableLast].Value = "Đơn giá BV(đồng)";

                                range.Worksheet.Cells["F" + indexTableFirst + ":F" + indexTableLast].Merge = true;
                                range.Worksheet.Cells["F" + indexTableFirst + ":F" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["F" + indexTableFirst + ":F" + indexTableLast].Value = "Đơn giá BH(đồng)";

                                range.Worksheet.Cells["G" + indexTableFirst + ":G" + indexTableLast].Merge = true;
                                range.Worksheet.Cells["G" + indexTableFirst + ":G" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["G" + indexTableFirst + ":G" + indexTableLast].Value = "Tỉ lệ thanh toán theo dịch vụ (%)";

                                range.Worksheet.Cells["H" + indexTableFirst + ":H" + indexTableLast].Merge = true;
                                range.Worksheet.Cells["H" + indexTableFirst + ":H" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["H" + indexTableFirst + ":H" + indexTableLast].Value = "Thành tiền BV (đồng)";

                                range.Worksheet.Cells["I" + indexTableFirst + ":I" + indexTableLast].Merge = true;
                                range.Worksheet.Cells["I" + indexTableFirst + ":I" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["I" + indexTableFirst + ":I" + indexTableLast].Value = "Tỷ lệ thanh toán BHYT (%)";

                                range.Worksheet.Cells["J" + indexTableFirst + ":J" + indexTableLast].Merge = true;
                                range.Worksheet.Cells["J" + indexTableFirst + ":J" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["J" + indexTableFirst + ":J" + indexTableLast].Value = "Thành tiền BH(đồng)";

                                range.Worksheet.Cells["K" + indexTableFirst + ":N" + indexTableFirst].Merge = true;
                                range.Worksheet.Cells["K" + indexTableFirst + ":N" + indexTableFirst].Value = "Nguồn thanh toán (đồng)";

                                range.Worksheet.Cells["K" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["K" + indexTableLast].Value = "Quỹ BHYT";

                                range.Worksheet.Cells["L" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["L" + indexTableLast].Value = "Người bệnh cùng chi trả (đồng)";

                                range.Worksheet.Cells["M" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["M" + indexTableLast].Value = "Khác (đồng)";

                                range.Worksheet.Cells["N" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["N" + indexTableLast].Value = "Người bệnh tự trả(đồng)";
                            }

                            index = indexTableLast + 1;


                            var dsChiPhiBangKeTheoThe = new List<BangKeKhamBenhBenhVienVo>();

                            foreach (var chiPhi in chiPhis.Where(c => c.NhomChiPhiBangKe != NhomChiPhiBangKe.GoiVatTu && c.YeuCauGoiDichVuId == null).GroupBy(c => new { c.DonGia, c.SoTienMG, KhongTinhPhi = c.KhongTinhPhi.GetValueOrDefault(), c.NhomChiPhiBangKe, c.TenDichVu, c.DonViTinh, c.DuocHuongBHYT, c.DonGiaBHYT, c.MucHuongBaoHiem, c.TiLeBaoHiemThanhToan }).OrderByDescending(o => o.Key.DuocHuongBHYT))
                            {
                                var chiphiBangKe = new BangKeKhamBenhBenhVienVo
                                {
                                    Nhom = chiPhi.Key.NhomChiPhiBangKe,
                                    Id = chiPhi.FirstOrDefault().Id,
                                    NoiDung = chiPhi.Key.TenDichVu,
                                    DonViTinh = chiPhi.Key.DonViTinh,
                                    SoLuong = (decimal)chiPhi.Sum(c => c.Soluong),
                                    DuocHuongBaoHiem = chiPhi.Key.DuocHuongBHYT,
                                    DonGiaBH = chiPhi.Key.DuocHuongBHYT ? chiPhi.Key.DonGiaBHYT : 0,
                                    MucHuongBaoHiem = chiPhi.Key.MucHuongBaoHiem,
                                    TiLeThanhToanTheoDV = chiPhi.Key.TiLeBaoHiemThanhToan,
                                    BaoHiemChiTra = true,
                                    DonGiaBV = chiPhi.Key.DonGia
                                };
                                if (chiPhi.Key.KhongTinhPhi == true)
                                {
                                    chiphiBangKe.Khac = chiPhi.Key.MucHuongBaoHiem > 0
                                        ? (chiphiBangKe.ThanhTienBV.GetValueOrDefault() - chiphiBangKe.ThanhTienBH.GetValueOrDefault())
                                        : chiphiBangKe.ThanhTienBV.GetValueOrDefault();
                                }
                                else
                                {
                                    chiphiBangKe.Khac = chiPhi.Sum(c => c.SoTienMG);
                                }
                                dsChiPhiBangKeTheoThe.Add(chiphiBangKe);
                            }

                            foreach (var chiPhi in chiPhis.Where(c => !(c.NhomChiPhiBangKe != NhomChiPhiBangKe.GoiVatTu && c.YeuCauGoiDichVuId == null)))
                            {
                                var chiphiBangKe = new BangKeKhamBenhBenhVienVo
                                {
                                    Nhom = chiPhi.NhomChiPhiBangKe,
                                    Id = chiPhi.Id,
                                    NoiDung = chiPhi.TenDichVu,
                                    DonViTinh = chiPhi.DonViTinh,
                                    SoLuong = (decimal)chiPhi.Soluong,
                                    DuocHuongBaoHiem = chiPhi.DuocHuongBHYT,
                                    DonGiaBH = chiPhi.DuocHuongBHYT ? chiPhi.DonGiaBHYT : 0,
                                    MucHuongBaoHiem = chiPhi.MucHuongBaoHiem,
                                    TiLeThanhToanTheoDV = chiPhi.TiLeBaoHiemThanhToan,
                                    BaoHiemChiTra = true,
                                    DonGiaBV = chiPhi.DonGia
                                };
                                if (chiPhi.KhongTinhPhi == true || chiPhi.YeuCauGoiDichVuId != null)
                                {
                                    chiphiBangKe.Khac = chiPhi.MucHuongBaoHiem > 0
                                        ? (chiphiBangKe.ThanhTienBV.GetValueOrDefault() - chiphiBangKe.ThanhTienBH.GetValueOrDefault())
                                        : chiphiBangKe.ThanhTienBV.GetValueOrDefault();
                                }
                                else
                                {
                                    chiphiBangKe.Khac = chiPhi.SoTienMG;
                                }
                                dsChiPhiBangKeTheoThe.Add(chiphiBangKe);
                            }
                            dsChiPhiBangKe.AddRange(dsChiPhiBangKeTheoThe);
                            var groupChiPhiBangKes = dsChiPhiBangKeTheoThe.GroupBy(x => x.Nhom).OrderBy(o => (int)o.Key * (o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay || o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriNoiTru ? 1 : 10));
                            if (!groupChiPhiBangKes.Any())
                            {
                                return null;
                            }
                            foreach (var groupChiPhiBangKe in groupChiPhiBangKes)
                            {
                                if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay)
                                {

                                    worksheet.Cells["A" + index + ":N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["A" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                    worksheet.Cells["A" + index + ":N" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                    worksheet.Cells["A" + index + ":N" + index].Merge = true;
                                    worksheet.Cells["A" + index + ":N" + index].Value = "2. Ngày giường:";
                                    worksheet.Cells["A" + index + ":N" + index].Style.Font.Bold = true;

                                    index++;

                                    worksheet.Cells["A" + index + ":G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["A" + index + ":G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                    worksheet.Cells["A" + index + ":G" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                    worksheet.Cells["A" + index + ":G" + index].Merge = true;
                                    worksheet.Cells["A" + index + ":G" + index].Value = "2.1." + groupChiPhiBangKe.Key.GetDescription();
                                    worksheet.Cells["A" + index + ":G" + index].Style.Font.Bold = true;

                                    worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["H" + index].Style.Font.Bold = true;
                                    worksheet.Cells["H" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBV);

                                    worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["J" + index].Style.Font.Bold = true;
                                    worksheet.Cells["J" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBH);

                                    worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["K" + index].Style.Font.Bold = true;
                                    worksheet.Cells["K" + index].Value = groupChiPhiBangKe.Sum(o => o.QuyBHYT);

                                    worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["L" + index].Style.Font.Bold = true;
                                    worksheet.Cells["L" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra);

                                    worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["M" + index].Style.Font.Bold = true;
                                    worksheet.Cells["M" + index].Value = groupChiPhiBangKe.Sum(o => o.Khac);

                                    worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["N" + index].Style.Font.Bold = true;
                                    worksheet.Cells["N" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra);

                                    index++;
                                }
                                else if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.NgayGiuongDieuTriNoiTru)
                                {
                                    if (!groupChiPhiBangKes.Any(o => o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay))
                                    {
                                        worksheet.Cells["A" + index + ":N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["A" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                        worksheet.Cells["A" + index + ":N" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                        worksheet.Cells["A" + index + ":N" + index].Merge = true;
                                        worksheet.Cells["A" + index + ":N" + index].Value = "2. Ngày giường:";
                                        worksheet.Cells["A" + index + ":N" + index].Style.Font.Bold = true;

                                    }
                                    index++;

                                    worksheet.Cells["A" + index + ":G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["A" + index + ":G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                    worksheet.Cells["A" + index + ":G" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                    worksheet.Cells["A" + index + ":G" + index].Merge = true;
                                    worksheet.Cells["A" + index + ":G" + index].Value = "2.2." + groupChiPhiBangKe.Key.GetDescription();
                                    worksheet.Cells["A" + index + ":G" + index].Style.Font.Bold = true;

                                    worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["H" + index].Style.Font.Bold = true;
                                    worksheet.Cells["H" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBV);

                                    worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["J" + index].Style.Font.Bold = true;
                                    worksheet.Cells["J" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBH);

                                    worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["K" + index].Style.Font.Bold = true;
                                    worksheet.Cells["K" + index].Value = groupChiPhiBangKe.Sum(o => o.QuyBHYT);

                                    worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["L" + index].Style.Font.Bold = true;
                                    worksheet.Cells["L" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra);

                                    worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["M" + index].Style.Font.Bold = true;
                                    worksheet.Cells["M" + index].Value = groupChiPhiBangKe.Sum(o => o.Khac);

                                    worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["N" + index].Style.Font.Bold = true;
                                    worksheet.Cells["N" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra);

                                    index++;
                                }
                                else
                                {
                                    worksheet.Cells["A" + index + ":G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["A" + index + ":G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                    worksheet.Cells["A" + index + ":G" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                    worksheet.Cells["A" + index + ":G" + index].Merge = true;
                                    worksheet.Cells["A" + index + ":G" + index].Value = (int)groupChiPhiBangKe.Key + "." + groupChiPhiBangKe.Key.GetDescription();
                                    worksheet.Cells["A" + index + ":G" + index].Style.Font.Bold = true;

                                    worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["H" + index].Style.Font.Bold = true;
                                    worksheet.Cells["H" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBV);

                                    worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["J" + index].Style.Font.Bold = true;
                                    worksheet.Cells["J" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBH);

                                    worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["K" + index].Style.Font.Bold = true;
                                    worksheet.Cells["K" + index].Value = groupChiPhiBangKe.Sum(o => o.QuyBHYT);

                                    worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["L" + index].Style.Font.Bold = true;
                                    worksheet.Cells["L" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra);

                                    worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["M" + index].Style.Font.Bold = true;
                                    worksheet.Cells["M" + index].Value = groupChiPhiBangKe.Sum(o => o.Khac);

                                    worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["N" + index].Style.Font.Bold = true;
                                    worksheet.Cells["N" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra);

                                    index++;
                                }
                                if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.GoiVatTu)
                                {
                                    var groupGoiVatTus = groupChiPhiBangKe.ToList().GroupBy(o => o.SoGoiVatTu.GetValueOrDefault()).OrderBy(o => o.Key);
                                    int sttGoiVatTu = 1;
                                    foreach (var groupGoiVatTu in groupGoiVatTus)
                                    {
                                        worksheet.Cells["A" + index + ":G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["A" + index + ":G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                        worksheet.Cells["A" + index + ":G" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                        worksheet.Cells["A" + index + ":G" + index].Value = "10." + sttGoiVatTu + ". " + groupChiPhiBangKe.Key.GetDescription() + " " + sttGoiVatTu;
                                        worksheet.Cells["A" + index + ":G" + index].Style.Font.Bold = true;
                                        worksheet.Cells["A" + index + ":G" + index].Merge = true;

                                        worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["H" + index].Style.Font.Bold = true;
                                        worksheet.Cells["H" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBV);

                                        worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["J" + index].Style.Font.Bold = true;
                                        worksheet.Cells["J" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBH);

                                        worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["K" + index].Style.Font.Bold = true;
                                        worksheet.Cells["K" + index].Value = groupChiPhiBangKe.Sum(o => o.QuyBHYT);

                                        worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["L" + index].Style.Font.Bold = true;
                                        worksheet.Cells["L" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra);

                                        worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["M" + index].Style.Font.Bold = true;
                                        worksheet.Cells["M" + index].Value = groupChiPhiBangKe.Sum(o => o.Khac);

                                        worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["N" + index].Style.Font.Bold = true;
                                        worksheet.Cells["N" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra);

                                        index++;

                                        foreach (var chiPhiBangKe in groupGoiVatTu)
                                        {
                                            worksheet.Cells["A" + index + ":N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["A" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                            worksheet.Cells["A" + index + ":N" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));

                                            worksheet.Cells["A" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["A" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                            worksheet.Cells["A" + index].Value = indexItem;

                                            worksheet.Cells["B" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["B" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                            worksheet.Cells["B" + index].Value = chiPhiBangKe.NoiDung;

                                            worksheet.Cells["C" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["C" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                            worksheet.Cells["C" + index].Value = chiPhiBangKe.DonViTinh;

                                            worksheet.Cells["D" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["D" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                            worksheet.Cells["D" + index].Value = chiPhiBangKe.SoLuong;

                                            worksheet.Cells["E" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["E" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                            worksheet.Cells["E" + index].Style.Numberformat.Format = "#,##0.00";
                                            worksheet.Cells["E" + index].Value = chiPhiBangKe.DonGiaBV;

                                            worksheet.Cells["F" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["F" + index].Style.Numberformat.Format = "#,##0.00";
                                            worksheet.Cells["F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                            worksheet.Cells["F" + index].Value = chiPhiBangKe.DonGiaBH;

                                            worksheet.Cells["G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                            worksheet.Cells["G" + index].Style.Numberformat.Format = "#,##0.00";
                                            worksheet.Cells["G" + index].Value = chiPhiBangKe.TiLeThanhToanTheoDV;

                                            worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                            worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                            worksheet.Cells["H" + index].Value = chiPhiBangKe.ThanhTienBV;

                                            worksheet.Cells["I" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["I" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                            worksheet.Cells["I" + index].Value = Convert.ToDouble(chiPhiBangKe.MucHuongBaoHiem > 0 ? 100 : 0).ApplyFormatMoneyToDouble();


                                            worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                            worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                            worksheet.Cells["J" + index].Value = chiPhiBangKe.ThanhTienBH;


                                            worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                            worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                            worksheet.Cells["K" + index].Value = chiPhiBangKe.QuyBHYT;


                                            worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                            worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                            worksheet.Cells["L" + index].Value = chiPhiBangKe.NguoiBenhCungChiTra;


                                            worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                            worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                            worksheet.Cells["M" + index].Value = chiPhiBangKe.Khac;


                                            worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                            worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                            worksheet.Cells["N" + index].Value = chiPhiBangKe.NguoiBenhTuTra;

                                            indexItem++;
                                            index++;
                                        }
                                    }
                                }
                                else
                                {
                                    foreach (var chiPhiBangKe in groupChiPhiBangKe)
                                    {
                                        worksheet.Cells["A" + index + ":N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["A" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                        worksheet.Cells["A" + index + ":N" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));

                                        worksheet.Cells["A" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["A" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                        worksheet.Cells["A" + index].Value = indexItem;

                                        worksheet.Cells["B" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["B" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                        worksheet.Cells["B" + index].Value = chiPhiBangKe.NoiDung;

                                        worksheet.Cells["C" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["C" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                        worksheet.Cells["C" + index].Value = chiPhiBangKe.DonViTinh;

                                        worksheet.Cells["D" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["D" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                        worksheet.Cells["D" + index].Value = chiPhiBangKe.SoLuong;

                                        worksheet.Cells["E" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["E" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["E" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["E" + index].Value = chiPhiBangKe.DonGiaBV;

                                        worksheet.Cells["F" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["F" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["F" + index].Value = chiPhiBangKe.DonGiaBH;

                                        worksheet.Cells["G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["G" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["G" + index].Value = chiPhiBangKe.TiLeThanhToanTheoDV;

                                        worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["H" + index].Value = chiPhiBangKe.ThanhTienBV;

                                        worksheet.Cells["I" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["I" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["I" + index].Value = Convert.ToDouble(chiPhiBangKe.MucHuongBaoHiem > 0 ? 100 : 0).ApplyFormatMoneyToDouble();


                                        worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["J" + index].Value = chiPhiBangKe.ThanhTienBH;


                                        worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["K" + index].Value = chiPhiBangKe.QuyBHYT;


                                        worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["L" + index].Value = chiPhiBangKe.NguoiBenhCungChiTra;


                                        worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["M" + index].Value = chiPhiBangKe.Khac;


                                        worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["N" + index].Value = chiPhiBangKe.NguoiBenhTuTra;

                                        indexItem++;
                                        index++;
                                    }
                                }

                            }

                            worksheet.Cells["A" + index + ":G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["A" + index + ":G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                            worksheet.Cells["A" + index + ":G" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                            worksheet.Cells["A" + index + ":G" + index].Merge = true;
                            worksheet.Cells["A" + index + ":G" + index].Value = "Tổng cộng";
                            worksheet.Cells["A" + index + ":G" + index].Style.Font.Bold = true;

                            worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                            worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                            worksheet.Cells["H" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.ThanhTienBV)).Sum();

                            worksheet.Cells["I" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["I" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;

                            worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                            worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                            worksheet.Cells["J" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.ThanhTienBH)).Sum();

                            worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                            worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                            worksheet.Cells["K" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.QuyBHYT)).Sum();

                            worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                            worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                            worksheet.Cells["L" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.NguoiBenhCungChiTra)).Sum();

                            worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                            worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                            worksheet.Cells["M" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.Khac)).Sum();

                            worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                            worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                            worksheet.Cells["N" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.NguoiBenhTuTra)).Sum();

                            index++;

                            worksheet.Cells["A" + index + ":N" + index].Merge = true;
                            worksheet.Cells["A" + index + ":N" + index].Value = "Tổng chi phí lần khám bệnh/cả đợt điều trị: " + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + " đồng";
                            worksheet.Cells["A" + index + ":N" + index].Style.Font.Bold = true;

                            index++;

                            worksheet.Cells["A" + index + ":N" + index].Merge = true;
                            worksheet.Cells["A" + index + ":N" + index].Value = "(Viết bằng chữ: " + NumberHelper.ChuyenSoRaText(Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBV))) + ")";

                            index++;

                            worksheet.Cells["A" + index + ":N" + index].Merge = true;
                            worksheet.Cells["A" + index + ":N" + index].Value = "Trong đó , số tiền do:";
                            worksheet.Cells["A" + index + ":N" + index].Style.Font.Bold = true;

                            index++;
                            worksheet.Cells["A" + index + ":N" + index].Merge = true;
                            worksheet.Cells["A" + index + ":N" + index].Value = "- Quỹ BHYT thanh toán: " + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble();

                            index++;
                            worksheet.Cells["A" + index + ":N" + index].Merge = true;
                            worksheet.Cells["A" + index + ":N" + index].Value = "- Người bệnh trả trong đó: " + (Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)) + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhTuTra))).ApplyFormatMoneyToDouble();

                            index++;
                            worksheet.Cells["A" + index + ":N" + index].Merge = true;
                            worksheet.Cells["A" + index + ":N" + index].Value = "+ Cùng chi trả trong phạm vi BHYT: " + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble(true);

                            index++;
                            worksheet.Cells["A" + index + ":N" + index].Merge = true;
                            worksheet.Cells["A" + index + ":N" + index].Value = "+ Các khoản phải trả khác: " + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true);

                            index++;
                            worksheet.Cells["A" + index + ":N" + index].Merge = true;
                            worksheet.Cells["A" + index + ":N" + index].Value = "+ Nguồn khác: " + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble(true);


                            index = index + 2;

                            worksheet.Cells["D" + index + ":F" + index].Style.Font.SetFromFont(new Font("Times New Roman", 12));
                            worksheet.Cells["D" + index + ":F" + index].Merge = true;
                            worksheet.Cells["D" + index + ":F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                            worksheet.Cells["D" + index + ":F" + index].Style.VerticalAlignment = ExcelVerticalAlignment.Top;
                            worksheet.Cells["D" + index + ":F" + index].Value = $"Ngày {DateTime.Now.Day} tháng {DateTime.Now.Month} năm {DateTime.Now.Year}";

                            worksheet.Cells["G" + index + ":I" + index].Style.Font.SetFromFont(new Font("Times New Roman", 12));
                            worksheet.Cells["G" + index + ":I" + index].Merge = true;
                            worksheet.Cells["G" + index + ":I" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                            worksheet.Cells["G" + index + ":I" + index].Style.VerticalAlignment = ExcelVerticalAlignment.Top;
                            worksheet.Cells["G" + index + ":I" + index].Value = $"Ngày {DateTime.Now.Day} tháng {DateTime.Now.Month} năm {DateTime.Now.Year}";

                            worksheet.Cells["J" + index + ":N" + index].Style.Font.Bold = true;
                            worksheet.Cells["J" + index + ":N" + index].Merge = true;
                            worksheet.Cells["J" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                            worksheet.Cells["J" + index + ":N" + index].Value = "XÁC NHẬN CỦA NGƯỜI BỆNH ";

                            index++;

                            worksheet.Cells["A" + index + ":C" + index].Style.Font.Bold = true;
                            worksheet.Cells["A" + index + ":C" + index].Merge = true;
                            worksheet.Cells["A" + index + ":C" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                            worksheet.Cells["A" + index + ":C" + index].Value = "NGƯỜI LẬP BẢNG KÊ";

                            worksheet.Cells["D" + index + ":F" + index].Style.Font.Bold = true;
                            worksheet.Cells["D" + index + ":F" + index].Merge = true;
                            worksheet.Cells["D" + index + ":F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                            worksheet.Cells["D" + index + ":F" + index].Value = "KẾ TOÁN VIỆN PHÍ";

                            worksheet.Cells["G" + index + ":I" + index].Style.Font.Bold = true;
                            worksheet.Cells["G" + index + ":I" + index].Merge = true;
                            worksheet.Cells["G" + index + ":I" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                            worksheet.Cells["G" + index + ":I" + index].Value = "GIÁM ĐỊNH BHYT";

                            worksheet.Cells["J" + index + ":N" + index].Style.Font.Bold = true;
                            worksheet.Cells["J" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                            worksheet.Cells["J" + index + ":N" + index].Merge = true;
                            worksheet.Cells["J" + index + ":N" + index].Value = "(Ký , Ghi rõ họ tên)";

                            index++;

                            worksheet.Cells["A" + index + ":C" + index].Style.Font.Bold = true;
                            worksheet.Cells["A" + index + ":C" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                            worksheet.Cells["A" + index + ":C" + index].Merge = true;
                            worksheet.Cells["A" + index + ":C" + index].Value = "(Ký , Ghi rõ họ tên)";


                            worksheet.Cells["D" + index + ":F" + index].Style.Font.Bold = true;
                            worksheet.Cells["D" + index + ":F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                            worksheet.Cells["D" + index + ":F" + index].Merge = true;
                            worksheet.Cells["D" + index + ":F" + index].Value = "(Ký , Ghi rõ họ tên)";

                            worksheet.Cells["G" + index + ":I" + index].Style.Font.Bold = true;
                            worksheet.Cells["G" + index + ":I" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                            worksheet.Cells["G" + index + ":I" + index].Merge = true;
                            worksheet.Cells["G" + index + ":I" + index].Value = "(Ký , Ghi rõ họ tên)";

                            worksheet.Cells["J" + index + ":N" + index].Style.Font.Bold = true;
                            worksheet.Cells["J" + index + ":N" + index].Merge = true;
                            worksheet.Cells["J" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                            worksheet.Cells["J" + index + ":N" + index].Value = "(Tôi đã nhận...phim...Xquang / CT / MRI)";

                            xlPackage.Save();
                        }
                    }
                    else
                    {
                        YeuCauTiepNhanTheBHYT theBHYTChiTra = null;
                        var maSoThe = groupChiPhiTheoThe.Where(o => o.Key != string.Empty).FirstOrDefault()?.Key;
                        if (!string.IsNullOrEmpty(maSoThe))
                        {
                            theBHYTChiTra = yeuCauTiepNhan.YeuCauTiepNhanTheBHYTs.First(o => o.MaSoThe == maSoThe);
                        }

                        var chiPhis = groupChiPhiTheoThe.SelectMany(o => o).ToList();
                        var mucHuongPT = theBHYTChiTra != null && theBHYTChiTra?.MucHuong > 0 ? theBHYTChiTra?.MucHuong + "%" : string.Empty;


                        using (var range = worksheet.Cells["A21:C21"])
                        {
                            range.Worksheet.Cells["A21:C21"].Merge = true;
                            range.Worksheet.Cells["A21:C21"].Style.WrapText = true;
                            var title = range.Worksheet.Cells["A21:C21"].RichText.Add("Mã thẻ BHYT: ");
                            var value = range.Worksheet.Cells["A21:C21"].RichText.Add(maBHYT);
                            value.Bold = true;

                            range.Worksheet.Cells["A21:C21"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                            range.Worksheet.Cells["A21:C21"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                            range.Worksheet.Cells["A21:C21"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                            range.Worksheet.Cells["A21:C21"].Style.Font.Color.SetColor(Color.Black);
                        }
                        using (var range = worksheet.Cells["A21:N21"])
                        {
                            range.Worksheet.Cells["D" + index + ":F" + index].Merge = true;
                            range.Worksheet.Cells["D" + index + ":F" + index].Style.WrapText = true;
                            var title = range.Worksheet.Cells["D" + index + ":F" + index].RichText.Add("Giá trị từ: ");
                            var valuebHYTTuNgay = range.Worksheet.Cells["D" + index + ":F" + index].RichText.Add(bHYTTuNgay);
                            valuebHYTTuNgay.Bold = true;

                            var den = range.Worksheet.Cells["D" + index + ":F" + index].RichText.Add(" đến: ");
                            den.Bold = false;
                            var valuebHYTDenNgay = range.Worksheet.Cells["D" + index + ":F" + index].RichText.Add(bHYTDenNgay);
                            valuebHYTDenNgay.Bold = true;

                            range.Worksheet.Cells["D" + index + ":F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                            range.Worksheet.Cells["D" + index + ":F" + index].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                            range.Worksheet.Cells["D" + index + ":F" + index].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                            range.Worksheet.Cells["D" + index + ":F" + index].Style.Font.Color.SetColor(Color.Black);
                        }
                        using (var range = worksheet.Cells["G21:J21"])
                        {
                            range.Worksheet.Cells["G21:J21"].Merge = true;
                            range.Worksheet.Cells["G21:J21"].Style.WrapText = true;
                            var title = range.Worksheet.Cells["G21:J21"].RichText.Add("Mức hưởng: ");
                            var value = range.Worksheet.Cells["G21:J21"].RichText.Add(mucHuong);
                            value.Bold = true;


                            range.Worksheet.Cells["G21:J21"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                            range.Worksheet.Cells["G21:J21"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                            range.Worksheet.Cells["G21:J21"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                            range.Worksheet.Cells["G21:J21"].Style.Font.Color.SetColor(Color.Black);
                        }
                        using (var range = worksheet.Cells["A22:N23"])
                        {
                            range.Worksheet.Cells["A22:N23"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                            range.Worksheet.Cells["A22:N23"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                            range.Worksheet.Cells["A22:N23"].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                            range.Worksheet.Cells["A22:N23"].Style.Font.Color.SetColor(Color.Black);
                            range.Worksheet.Cells["A22:N23"].Style.Font.Bold = true;
                            range.Worksheet.Cells["A22:N23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);

                            range.Worksheet.Cells["A22:A23"].Merge = true;
                            range.Worksheet.Cells["A22:A23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["A22:A23"].Value = "STT";

                            range.Worksheet.Cells["B22:B23"].Merge = true;
                            range.Worksheet.Cells["B22:B23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["B22:B23"].Value = "Nội dung";

                            range.Worksheet.Cells["C22:C23"].Merge = true;
                            range.Worksheet.Cells["C22:C23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["C22:C23"].Value = "Đơn vị tính";

                            range.Worksheet.Cells["D22:D23"].Merge = true;
                            range.Worksheet.Cells["D22:D23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["D22:D23"].Value = "Số lượng";

                            range.Worksheet.Cells["E22:E23"].Merge = true;
                            range.Worksheet.Cells["E22:E23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["E22:E23"].Value = "Đơn giá BV(đồng)";

                            range.Worksheet.Cells["F22:F23"].Merge = true;
                            range.Worksheet.Cells["F22:F23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["F22:F23"].Value = "Đơn giá BH(đồng)";

                            range.Worksheet.Cells["G22:G23"].Merge = true;
                            range.Worksheet.Cells["G22:G23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["G22:G23"].Value = "Tỉ lệ thanh toán theo dịch vụ (%)";

                            range.Worksheet.Cells["H22:H23"].Merge = true;
                            range.Worksheet.Cells["H22:H23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["H22:H23"].Value = "Thành tiền BV (đồng)";

                            range.Worksheet.Cells["I22:I23"].Merge = true;
                            range.Worksheet.Cells["I22:I23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["I22:I23"].Value = "Tỷ lệ thanh toán BHYT (%)";

                            range.Worksheet.Cells["J22:J23"].Merge = true;
                            range.Worksheet.Cells["J22:J23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["J22:J23"].Value = "Thành tiền BH(đồng)";

                            range.Worksheet.Cells["K22:N22"].Merge = true;
                            range.Worksheet.Cells["K22:N22"].Value = "Nguồn thanh toán (đồng)";

                            range.Worksheet.Cells["K23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["K23"].Value = "Quỹ BHYT";

                            range.Worksheet.Cells["L23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["L23"].Value = "Người bệnh cùng chi trả (đồng)";

                            range.Worksheet.Cells["M23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["M23"].Value = "Khác (đồng)";

                            range.Worksheet.Cells["N23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["N23"].Value = "Người bệnh tự trả(đồng)";
                        }


                        index = index + 3;

                        foreach (var chiPhi in chiPhis.Where(c => c.NhomChiPhiBangKe != NhomChiPhiBangKe.GoiVatTu && c.YeuCauGoiDichVuId == null).GroupBy(c => new { c.DonGia, c.SoTienMG, KhongTinhPhi = c.KhongTinhPhi.GetValueOrDefault(), c.NhomChiPhiBangKe, c.TenDichVu, c.DonViTinh, c.DuocHuongBHYT, c.DonGiaBHYT, c.MucHuongBaoHiem, c.TiLeBaoHiemThanhToan }).OrderByDescending(o => o.Key.DuocHuongBHYT))
                        {
                            var chiphiBangKe = new BangKeKhamBenhBenhVienVo
                            {
                                Nhom = chiPhi.Key.NhomChiPhiBangKe,
                                Id = chiPhi.FirstOrDefault().Id,
                                NoiDung = chiPhi.Key.TenDichVu,
                                DonViTinh = chiPhi.Key.DonViTinh,
                                SoLuong = (decimal)chiPhi.Sum(c => c.Soluong),
                                DuocHuongBaoHiem = chiPhi.Key.DuocHuongBHYT,
                                DonGiaBH = chiPhi.Key.DuocHuongBHYT ? chiPhi.Key.DonGiaBHYT : 0,
                                MucHuongBaoHiem = chiPhi.Key.MucHuongBaoHiem,
                                TiLeThanhToanTheoDV = chiPhi.Key.TiLeBaoHiemThanhToan,
                                BaoHiemChiTra = true,
                                DonGiaBV = chiPhi.Key.DonGia
                            };
                            if (chiPhi.Key.KhongTinhPhi == true)
                            {
                                chiphiBangKe.Khac = chiPhi.Key.MucHuongBaoHiem > 0
                                    ? (chiphiBangKe.ThanhTienBV.GetValueOrDefault() - chiphiBangKe.ThanhTienBH.GetValueOrDefault())
                                    : chiphiBangKe.ThanhTienBV.GetValueOrDefault();
                            }
                            else
                            {
                                chiphiBangKe.Khac = chiPhi.Sum(c => c.SoTienMG);
                            }
                            dsChiPhiBangKe.Add(chiphiBangKe);
                        }
                        foreach (var chiPhi in chiPhis.Where(c => !(c.NhomChiPhiBangKe != NhomChiPhiBangKe.GoiVatTu && c.YeuCauGoiDichVuId == null)))
                        {
                            var chiphiBangKe = new BangKeKhamBenhBenhVienVo
                            {
                                Nhom = chiPhi.NhomChiPhiBangKe,
                                Id = chiPhi.Id,
                                NoiDung = chiPhi.TenDichVu,
                                DonViTinh = chiPhi.DonViTinh,
                                SoLuong = (decimal)chiPhi.Soluong,
                                DuocHuongBaoHiem = chiPhi.DuocHuongBHYT,
                                DonGiaBH = chiPhi.DuocHuongBHYT ? chiPhi.DonGiaBHYT : 0,
                                MucHuongBaoHiem = chiPhi.MucHuongBaoHiem,
                                TiLeThanhToanTheoDV = chiPhi.TiLeBaoHiemThanhToan,
                                BaoHiemChiTra = true,
                                DonGiaBV = chiPhi.DonGia
                            };
                            if (chiPhi.KhongTinhPhi == true || chiPhi.YeuCauGoiDichVuId != null)
                            {
                                chiphiBangKe.Khac = chiPhi.MucHuongBaoHiem > 0
                                    ? (chiphiBangKe.ThanhTienBV.GetValueOrDefault() - chiphiBangKe.ThanhTienBH.GetValueOrDefault())
                                    : chiphiBangKe.ThanhTienBV.GetValueOrDefault();
                            }
                            else
                            {
                                chiphiBangKe.Khac = chiPhi.SoTienMG;
                            }
                            dsChiPhiBangKe.Add(chiphiBangKe);
                        }
                        var groupChiPhiBangKes = dsChiPhiBangKe.GroupBy(x => x.Nhom).OrderBy(o => (int)o.Key * (o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay || o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriNoiTru ? 1 : 10));
                        if (!groupChiPhiBangKes.Any())
                        {
                            return null;
                        }
                        foreach (var groupChiPhiBangKe in groupChiPhiBangKes)
                        {
                            if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay)
                            {

                                worksheet.Cells["A" + index + ":N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["A" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                worksheet.Cells["A" + index + ":N" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                worksheet.Cells["A" + index + ":N" + index].Merge = true;
                                worksheet.Cells["A" + index + ":N" + index].Value = "2. Ngày giường:";
                                worksheet.Cells["A" + index + ":N" + index].Style.Font.Bold = true;

                                index++;

                                worksheet.Cells["A" + index + ":G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["A" + index + ":G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                worksheet.Cells["A" + index + ":G" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                worksheet.Cells["A" + index + ":G" + index].Merge = true;
                                worksheet.Cells["A" + index + ":G" + index].Value = "2.1." + groupChiPhiBangKe.Key.GetDescription();
                                worksheet.Cells["A" + index + ":G" + index].Style.Font.Bold = true;

                                worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["H" + index].Style.Font.Bold = true;
                                worksheet.Cells["H" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBV);

                                worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["J" + index].Style.Font.Bold = true;
                                worksheet.Cells["J" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBH);

                                worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["K" + index].Style.Font.Bold = true;
                                worksheet.Cells["K" + index].Value = groupChiPhiBangKe.Sum(o => o.QuyBHYT);

                                worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["L" + index].Style.Font.Bold = true;
                                worksheet.Cells["L" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra);

                                worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["M" + index].Style.Font.Bold = true;
                                worksheet.Cells["M" + index].Value = groupChiPhiBangKe.Sum(o => o.Khac);

                                worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["N" + index].Style.Font.Bold = true;
                                worksheet.Cells["N" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra);

                                index++;
                            }
                            else if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.NgayGiuongDieuTriNoiTru)
                            {
                                if (!groupChiPhiBangKes.Any(o => o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay))
                                {
                                    worksheet.Cells["A" + index + ":N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["A" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                    worksheet.Cells["A" + index + ":N" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                    worksheet.Cells["A" + index + ":H" + index].Merge = true;
                                    worksheet.Cells["A" + index + ":N" + index].Value = "2. Ngày giường:";
                                    worksheet.Cells["A" + index + ":N" + index].Style.Font.Bold = true;

                                }

                                index++;
                                worksheet.Cells["A" + index + ":G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["A" + index + ":G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                worksheet.Cells["A" + index + ":G" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                worksheet.Cells["A" + index + ":G" + index].Merge = true;
                                worksheet.Cells["A" + index + ":G" + index].Value = "2.2." + groupChiPhiBangKe.Key.GetDescription();
                                worksheet.Cells["A" + index + ":G" + index].Style.Font.Bold = true;

                                worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["H" + index].Style.Font.Bold = true;
                                worksheet.Cells["H" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBV);

                                worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["J" + index].Style.Font.Bold = true;
                                worksheet.Cells["J" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBH);

                                worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["K" + index].Style.Font.Bold = true;
                                worksheet.Cells["K" + index].Value = groupChiPhiBangKe.Sum(o => o.QuyBHYT);

                                worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["L" + index].Style.Font.Bold = true;
                                worksheet.Cells["L" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra);

                                worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["M" + index].Style.Font.Bold = true;
                                worksheet.Cells["M" + index].Value = groupChiPhiBangKe.Sum(o => o.Khac);

                                worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["N" + index].Style.Font.Bold = true;
                                worksheet.Cells["N" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra);

                                index++;
                            }
                            else
                            {
                                worksheet.Cells["A" + index + ":G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["A" + index + ":G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                worksheet.Cells["A" + index + ":G" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                worksheet.Cells["A" + index + ":G" + index].Merge = true;
                                worksheet.Cells["A" + index + ":G" + index].Value = (int)groupChiPhiBangKe.Key + "." + groupChiPhiBangKe.Key.GetDescription();
                                worksheet.Cells["A" + index + ":G" + index].Style.Font.Bold = true;

                                worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["H" + index].Style.Font.Bold = true;
                                worksheet.Cells["H" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBV);

                                worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["J" + index].Style.Font.Bold = true;
                                worksheet.Cells["J" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBH);

                                worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["K" + index].Style.Font.Bold = true;
                                worksheet.Cells["K" + index].Value = groupChiPhiBangKe.Sum(o => o.QuyBHYT);

                                worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["L" + index].Style.Font.Bold = true;
                                worksheet.Cells["L" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra);

                                worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["M" + index].Style.Font.Bold = true;
                                worksheet.Cells["M" + index].Value = groupChiPhiBangKe.Sum(o => o.Khac);

                                worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["N" + index].Style.Font.Bold = true;
                                worksheet.Cells["N" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra);

                                index++;
                            }
                            if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.GoiVatTu)
                            {
                                var groupGoiVatTus = groupChiPhiBangKe.ToList().GroupBy(o => o.SoGoiVatTu.GetValueOrDefault()).OrderBy(o => o.Key);
                                int sttGoiVatTu = 1;
                                foreach (var groupGoiVatTu in groupGoiVatTus)
                                {
                                    worksheet.Cells["A" + index + ":G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["A" + index + ":G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                    worksheet.Cells["A" + index + ":G" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                    worksheet.Cells["A" + index + ":G" + index].Value = "10." + sttGoiVatTu + ". " + groupChiPhiBangKe.Key.GetDescription() + " " + sttGoiVatTu;
                                    worksheet.Cells["A" + index + ":G" + index].Style.Font.Bold = true;
                                    worksheet.Cells["A" + index + ":G" + index].Merge = true;

                                    worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["H" + index].Style.Font.Bold = true;
                                    worksheet.Cells["H" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBV);

                                    worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["J" + index].Style.Font.Bold = true;
                                    worksheet.Cells["J" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBH);

                                    worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["K" + index].Style.Font.Bold = true;
                                    worksheet.Cells["K" + index].Value = groupChiPhiBangKe.Sum(o => o.QuyBHYT);

                                    worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["L" + index].Style.Font.Bold = true;
                                    worksheet.Cells["L" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra);

                                    worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["M" + index].Style.Font.Bold = true;
                                    worksheet.Cells["M" + index].Value = groupChiPhiBangKe.Sum(o => o.Khac);

                                    worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["N" + index].Style.Font.Bold = true;
                                    worksheet.Cells["N" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra);

                                    index++;

                                    foreach (var chiPhiBangKe in groupGoiVatTu)
                                    {
                                        worksheet.Cells["A" + index + ":N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["A" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                        worksheet.Cells["A" + index + ":N" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));

                                        worksheet.Cells["A" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["A" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                        worksheet.Cells["A" + index].Value = indexItem;

                                        worksheet.Cells["B" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["B" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                        worksheet.Cells["B" + index].Value = chiPhiBangKe.NoiDung;

                                        worksheet.Cells["C" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["C" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                        worksheet.Cells["C" + index].Value = chiPhiBangKe.DonViTinh;

                                        worksheet.Cells["D" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["D" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                        worksheet.Cells["D" + index].Value = chiPhiBangKe.SoLuong;

                                        worksheet.Cells["E" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["E" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["E" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["E" + index].Value = chiPhiBangKe.DonGiaBV;

                                        worksheet.Cells["F" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["F" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["F" + index].Value = chiPhiBangKe.DonGiaBH;

                                        worksheet.Cells["G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["G" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["G" + index].Value = chiPhiBangKe.TiLeThanhToanTheoDV;

                                        worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["H" + index].Value = chiPhiBangKe.ThanhTienBV;

                                        worksheet.Cells["I" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["I" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["I" + index].Value = Convert.ToDouble(chiPhiBangKe.MucHuongBaoHiem > 0 ? 100 : 0).ApplyFormatMoneyToDouble();


                                        worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["J" + index].Value = chiPhiBangKe.ThanhTienBH;


                                        worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["K" + index].Value = chiPhiBangKe.QuyBHYT;


                                        worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["L" + index].Value = chiPhiBangKe.NguoiBenhCungChiTra;


                                        worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["M" + index].Value = chiPhiBangKe.Khac;


                                        worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["N" + index].Value = chiPhiBangKe.NguoiBenhTuTra;

                                        indexItem++;
                                        index++;
                                    }
                                }
                            }
                            else
                            {
                                foreach (var chiPhiBangKe in groupChiPhiBangKe)
                                {
                                    worksheet.Cells["A" + index + ":N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["A" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                    worksheet.Cells["A" + index + ":N" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));

                                    worksheet.Cells["A" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["A" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                    worksheet.Cells["A" + index].Value = indexItem;

                                    worksheet.Cells["B" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["B" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                    worksheet.Cells["B" + index].Value = chiPhiBangKe.NoiDung;

                                    worksheet.Cells["C" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["C" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                    worksheet.Cells["C" + index].Value = chiPhiBangKe.DonViTinh;

                                    worksheet.Cells["D" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["D" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                    worksheet.Cells["D" + index].Value = chiPhiBangKe.SoLuong;

                                    worksheet.Cells["E" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["E" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["E" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["E" + index].Value = chiPhiBangKe.DonGiaBV;

                                    worksheet.Cells["F" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["F" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["F" + index].Value = chiPhiBangKe.DonGiaBH;

                                    worksheet.Cells["G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["G" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["G" + index].Value = chiPhiBangKe.TiLeThanhToanTheoDV;

                                    worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["H" + index].Value = chiPhiBangKe.ThanhTienBV;

                                    worksheet.Cells["I" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["I" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["I" + index].Value = Convert.ToDouble(chiPhiBangKe.MucHuongBaoHiem > 0 ? 100 : 0).ApplyFormatMoneyToDouble();


                                    worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["J" + index].Value = chiPhiBangKe.ThanhTienBH;


                                    worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["K" + index].Value = chiPhiBangKe.QuyBHYT;


                                    worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["L" + index].Value = chiPhiBangKe.NguoiBenhCungChiTra;


                                    worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["M" + index].Value = chiPhiBangKe.Khac;


                                    worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["N" + index].Value = chiPhiBangKe.NguoiBenhTuTra;

                                    indexItem++;
                                    index++;
                                }
                            }

                        }

                        worksheet.Cells["A" + index + ":G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        worksheet.Cells["A" + index + ":G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        worksheet.Cells["A" + index + ":G" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                        worksheet.Cells["A" + index + ":G" + index].Merge = true;
                        worksheet.Cells["A" + index + ":G" + index].Value = "Tổng cộng";
                        worksheet.Cells["A" + index + ":G" + index].Style.Font.Bold = true;

                        worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                        worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                        worksheet.Cells["H" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.ThanhTienBV)).Sum();

                        worksheet.Cells["I" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        worksheet.Cells["I" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;

                        worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                        worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                        worksheet.Cells["J" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.ThanhTienBH)).Sum();

                        worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                        worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                        worksheet.Cells["K" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.QuyBHYT)).Sum();

                        worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                        worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                        worksheet.Cells["L" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.NguoiBenhCungChiTra)).Sum();

                        worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                        worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                        worksheet.Cells["M" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.Khac)).Sum();

                        worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                        worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                        worksheet.Cells["N" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.NguoiBenhTuTra)).Sum();

                        index++;

                        worksheet.Cells["A" + index + ":N" + index].Merge = true;
                        worksheet.Cells["A" + index + ":N" + index].Value = "Tổng chi phí lần khám bệnh/cả đợt điều trị: " + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + " đồng";
                        worksheet.Cells["A" + index + ":N" + index].Style.Font.Bold = true;

                        index++;

                        worksheet.Cells["A" + index + ":N" + index].Merge = true;
                        worksheet.Cells["A" + index + ":N" + index].Value = "(Viết bằng chữ: " + NumberHelper.ChuyenSoRaText(Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBV))) + ")";

                        index++;

                        worksheet.Cells["A" + index + ":N" + index].Merge = true;
                        worksheet.Cells["A" + index + ":N" + index].Value = "Trong đó , số tiền do:";
                        worksheet.Cells["A" + index + ":N" + index].Style.Font.Bold = true;

                        index++;
                        worksheet.Cells["A" + index + ":N" + index].Merge = true;
                        worksheet.Cells["A" + index + ":N" + index].Value = "- Quỹ BHYT thanh toán: " + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble();

                        index++;
                        worksheet.Cells["A" + index + ":N" + index].Merge = true;
                        worksheet.Cells["A" + index + ":N" + index].Value = "- Người bệnh trả trong đó: " + (Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)) + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhTuTra))).ApplyFormatMoneyToDouble();

                        index++;
                        worksheet.Cells["A" + index + ":N" + index].Merge = true;
                        worksheet.Cells["A" + index + ":N" + index].Value = "+ Cùng chi trả trong phạm vi BHYT: " + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble(true);

                        index++;
                        worksheet.Cells["A" + index + ":N" + index].Merge = true;
                        worksheet.Cells["A" + index + ":N" + index].Value = "+ Các khoản phải trả khác: " + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true);

                        index++;
                        worksheet.Cells["A" + index + ":N" + index].Merge = true;
                        worksheet.Cells["A" + index + ":N" + index].Value = "+ Nguồn khác: " + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble(true);


                        index = index + 2;

                        worksheet.Cells["D" + index + ":F" + index].Style.Font.SetFromFont(new Font("Times New Roman", 12));
                        worksheet.Cells["D" + index + ":F" + index].Merge = true;
                        worksheet.Cells["D" + index + ":F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        worksheet.Cells["D" + index + ":F" + index].Style.VerticalAlignment = ExcelVerticalAlignment.Top;
                        worksheet.Cells["D" + index + ":F" + index].Value = $"Ngày {DateTime.Now.Day} tháng {DateTime.Now.Month} năm {DateTime.Now.Year}";

                        worksheet.Cells["G" + index + ":I" + index].Style.Font.SetFromFont(new Font("Times New Roman", 12));
                        worksheet.Cells["G" + index + ":I" + index].Merge = true;
                        worksheet.Cells["G" + index + ":I" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        worksheet.Cells["G" + index + ":I" + index].Style.VerticalAlignment = ExcelVerticalAlignment.Top;
                        worksheet.Cells["G" + index + ":I" + index].Value = $"Ngày {DateTime.Now.Day} tháng {DateTime.Now.Month} năm {DateTime.Now.Year}";

                        worksheet.Cells["J" + index + ":N" + index].Style.Font.Bold = true;
                        worksheet.Cells["J" + index + ":N" + index].Merge = true;
                        worksheet.Cells["J" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        worksheet.Cells["J" + index + ":N" + index].Value = "XÁC NHẬN CỦA NGƯỜI BỆNH ";

                        index++;

                        worksheet.Cells["A" + index + ":C" + index].Style.Font.Bold = true;
                        worksheet.Cells["A" + index + ":C" + index].Merge = true;
                        worksheet.Cells["A" + index + ":C" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        worksheet.Cells["A" + index + ":C" + index].Value = "NGƯỜI LẬP BẢNG KÊ";

                        worksheet.Cells["D" + index + ":F" + index].Style.Font.Bold = true;
                        worksheet.Cells["D" + index + ":F" + index].Merge = true;
                        worksheet.Cells["D" + index + ":F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        worksheet.Cells["D" + index + ":F" + index].Value = "KẾ TOÁN VIỆN PHÍ";

                        worksheet.Cells["G" + index + ":I" + index].Style.Font.Bold = true;
                        worksheet.Cells["G" + index + ":I" + index].Merge = true;
                        worksheet.Cells["G" + index + ":I" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        worksheet.Cells["G" + index + ":I" + index].Value = "GIÁM ĐỊNH BHYT";

                        worksheet.Cells["J" + index + ":N" + index].Style.Font.Bold = true;
                        worksheet.Cells["J" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        worksheet.Cells["J" + index + ":N" + index].Merge = true;
                        worksheet.Cells["J" + index + ":N" + index].Value = "(Ký , Ghi rõ họ tên)";

                        index++;

                        worksheet.Cells["A" + index + ":C" + index].Style.Font.Bold = true;
                        worksheet.Cells["A" + index + ":C" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        worksheet.Cells["A" + index + ":C" + index].Merge = true;
                        worksheet.Cells["A" + index + ":C" + index].Value = "(Ký , Ghi rõ họ tên)";


                        worksheet.Cells["D" + index + ":F" + index].Style.Font.Bold = true;
                        worksheet.Cells["D" + index + ":F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        worksheet.Cells["D" + index + ":F" + index].Merge = true;
                        worksheet.Cells["D" + index + ":F" + index].Value = "(Ký , Ghi rõ họ tên)";

                        worksheet.Cells["G" + index + ":I" + index].Style.Font.Bold = true;
                        worksheet.Cells["G" + index + ":I" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        worksheet.Cells["G" + index + ":I" + index].Merge = true;
                        worksheet.Cells["G" + index + ":I" + index].Value = "(Ký , Ghi rõ họ tên)";

                        worksheet.Cells["J" + index + ":N" + index].Style.Font.Bold = true;
                        worksheet.Cells["J" + index + ":N" + index].Merge = true;
                        worksheet.Cells["J" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        worksheet.Cells["J" + index + ":N" + index].Value = "(Tôi đã nhận...phim...Xquang / CT / MRI)";

                        xlPackage.Save();

                    }


                }
                return stream.ToArray();
            }
        }

        #endregion

        #region Bảng kê chờ thu

        public byte[] XuatBangKeNoiTruChoThu(ThuPhiKhamChuaBenhNoiTruVo model)
        {
            var yeuCauTiepNhanId = model.Id;
            var danhSachTatCaChiPhi = GetTatCaDichVuKhamChuaBenh(yeuCauTiepNhanId).Result.Where(o => !o.Soluong.AlmostEqual(0));
            //chỉ lấy những dịch vụ chưa thu tiền
            var danhSachChiPhi = danhSachTatCaChiPhi.Where(o => o.YeuCauGoiDichVuId == null && o.TrangThaiThanhToan != TrangThaiThanhToan.DaThanhToan).ToList();
            //if (danhSachChiPhi.Count == 0)
            //{
            //    return string.Empty;
            //}
            //tinh miễn giảm theo FE
            var dsChiPhiDaChon = model.DanhSachChiPhiKhamChuaBenhDaChons;
            foreach (var chiPhiKhamChuaBenhVo in dsChiPhiDaChon)
            {
                //var chiphi = dsChiPhi.FirstOrDefault(o => o.LoaiNhom == chiPhiKhamChuaBenhVo.LoaiNhom && o.Id == chiPhiKhamChuaBenhVo.Id);
                //if (chiphi == null || !chiphi.ThanhTien.AlmostEqual(chiPhiKhamChuaBenhVo.ThanhTien) || !chiphi.BHYTThanhToan.AlmostEqual(chiPhiKhamChuaBenhVo.BHYTThanhToan) || chiPhiKhamChuaBenhVo.TongCongNo > chiPhiKhamChuaBenhVo.ThanhTien - chiPhiKhamChuaBenhVo.BHYTThanhToan)
                //{
                //    return new KetQuaThuPhiKhamChuaBenhNoiTruVaQuyetToanDichVuTrongGoiVo { Error = "Thông tin dịch vụ thanh toán không hợp lệ, vui lòng tải lại trang" };
                //}
                var soTienTruocMienGiam = chiPhiKhamChuaBenhVo.ThanhTien - chiPhiKhamChuaBenhVo.BHYTThanhToan;

                decimal soTienMienGiamTheoDv = 0;

                foreach (var mienGiamTheoTiLe in chiPhiKhamChuaBenhVo.DanhSachMienGiamVos.Where(o => o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoTiLe))
                {
                    mienGiamTheoTiLe.SoTien = Math.Round((soTienTruocMienGiam * mienGiamTheoTiLe.TiLe.GetValueOrDefault() / 100), 2, MidpointRounding.AwayFromZero);
                    soTienMienGiamTheoDv += mienGiamTheoTiLe.SoTien;
                }
                foreach (var mienGiamTheoTiLe in chiPhiKhamChuaBenhVo.DanhSachMienGiamVos.Where(o => o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoSoTien))
                {
                    soTienMienGiamTheoDv += mienGiamTheoTiLe.SoTien;
                }
                //if (soTienMienGiamTheoDv > chiPhiKhamChuaBenhVo.ThanhTien)
                //{
                //    return new KetQuaThuPhiKhamChuaBenhNoiTruVaQuyetToanDichVuTrongGoiVo { Error = "Thông tin dịch vụ thanh toán không hợp lệ, vui lòng tải lại trang" };
                //}
                chiPhiKhamChuaBenhVo.SoTienMG = soTienMienGiamTheoDv;
            }
            foreach (var chiPhiKhamChuaBenhNoiTruVo in danhSachChiPhi)
            {
                var chiPhiDaChon = dsChiPhiDaChon.FirstOrDefault(o => o.LoaiNhom == chiPhiKhamChuaBenhNoiTruVo.LoaiNhom && o.Id == chiPhiKhamChuaBenhNoiTruVo.Id);
                if (chiPhiDaChon != null)
                {
                    chiPhiKhamChuaBenhNoiTruVo.SoTienMG = chiPhiDaChon.SoTienMG;
                }
                else
                {

                }
            }

            var yeuCauTiepNhan = BaseRepository.GetById(yeuCauTiepNhanId,
                x => x.Include(o => o.NoiTruBenhAn).ThenInclude(o => o.ChuyenDenBenhVien)
                    .Include(o => o.NoiTruBenhAn).ThenInclude(o => o.KhoaPhongNhapVien)
                    .Include(o => o.NoiTruBenhAn).ThenInclude(o => o.ChanDoanChinhRaVienICD)
                    .Include(o => o.YeuCauTiepNhanTheBHYTs)
                    .Include(o => o.YeuCauNhapVien).ThenInclude(o => o.YeuCauKhamBenh).ThenInclude(o => o.YeuCauTiepNhan)
                    .Include(o => o.BenhNhan)
                    .Include(o => o.PhuongXa)
                    .Include(o => o.QuanHuyen)
                    .Include(o => o.TinhThanh)
                    .Include(o => o.NoiTruBenhAn).ThenInclude(o => o.NoiTruPhieuDieuTris).ThenInclude(o => o.NoiTruThamKhamChanDoanKemTheos).ThenInclude(c => c.ICD)
                    .Include(o => o.NoiTruBenhAn).ThenInclude(o => o.NoiTruPhieuDieuTris).ThenInclude(c => c.ChanDoanChinhICD)
                    .Include(o => o.NoiChuyen).Include(o => o.NoiTruBenhAn).ThenInclude(o => o.NoiTruKhoaPhongDieuTris).ThenInclude(c => c.KhoaPhongChuyenDen));

            var result = _templateRepository.TableNoTracking.FirstOrDefault(x => x.Name.Equals("BangKeNoiTruChoThu"));

            var benhVien = new Core.Domain.Entities.BenhVien.BenhVien();

            string maBHYT = string.Empty;
            string bHYTTuNgay = string.Empty;
            string bHYTDenNgay = string.Empty;
            string mucHuong = string.Empty;
            string NoiDKKCBBanDau = string.Empty;
            string MaKCBBanDau = string.Empty;


            string maICDKemTheo = string.Empty;
            string tenICDKemTheo = string.Empty;

            string chuanDoanXacDinhSanKhoa = string.Empty;
            string maICD10 = string.Empty;

            if (yeuCauTiepNhan.NoiTruBenhAn != null && (yeuCauTiepNhan.NoiTruBenhAn.LoaiBenhAn == LoaiBenhAn.SanKhoaMo || yeuCauTiepNhan.NoiTruBenhAn.LoaiBenhAn == LoaiBenhAn.SanKhoaThuong))
            {
                if (yeuCauTiepNhan.NoiTruBenhAn?.NoiTruPhieuDieuTris.Count() > 0)
                {
                    var phieuDieuTri = yeuCauTiepNhan.NoiTruBenhAn?.NoiTruPhieuDieuTris.OrderByDescending(c => c.NgayDieuTri).FirstOrDefault();

                    var icdKemTheoIds = phieuDieuTri.NoiTruThamKhamChanDoanKemTheos.Select(c => c.ICD.Ma);
                    var tenICDKemTheos = phieuDieuTri.NoiTruThamKhamChanDoanKemTheos.Select(c => c.GhiChu);

                    maICDKemTheo = string.Join(", ", icdKemTheoIds);
                    tenICDKemTheo = string.Join(", ", tenICDKemTheos);

                    maICD10 = phieuDieuTri.ChanDoanChinhICD?.Ma;
                    chuanDoanXacDinhSanKhoa = phieuDieuTri.ChanDoanChinhGhiChu;
                }
            }
            else
            {
                if (!string.IsNullOrEmpty(yeuCauTiepNhan.NoiTruBenhAn?.DanhSachChanDoanKemTheoRaVienICDId))
                {
                    var maICDKemTheos = new List<string>();

                    var icdKemTheoIds = yeuCauTiepNhan.NoiTruBenhAn?.DanhSachChanDoanKemTheoRaVienICDId.Split(Constants.ICDSeparator);
                    var tenICDKemTheos = yeuCauTiepNhan.NoiTruBenhAn?.DanhSachChanDoanKemTheoRaVienGhiChu?.Split(Constants.ICDSeparator);

                    if (icdKemTheoIds.Length > 0)
                    {
                        foreach (var icdKemTheoId in icdKemTheoIds)
                        {
                            var icdKemTheo = _icdRepository.TableNoTracking.FirstOrDefault(o => o.Id == long.Parse(icdKemTheoId));
                            if (icdKemTheo != null)
                            {
                                maICDKemTheos.Add(icdKemTheo.Ma);
                            }
                        }
                    }

                    maICDKemTheo = string.Join(", ", maICDKemTheos);
                    tenICDKemTheo = string.Join(", ", tenICDKemTheos);
                }
            }


            YeuCauTiepNhanTheBHYT theBHYT = null;
            if (yeuCauTiepNhan.CoBHYT == true && yeuCauTiepNhan.YeuCauTiepNhanTheBHYTs.Any())
            {
                theBHYT = yeuCauTiepNhan.YeuCauTiepNhanTheBHYTs.First();
                if (!String.IsNullOrEmpty(theBHYT.MaDKBD))
                {
                    benhVien = _benhVienRepository.TableNoTracking.FirstOrDefault(p => p.Ma.Equals(theBHYT.MaDKBD));
                }
                maBHYT = theBHYT.MaSoThe;
                bHYTTuNgay = theBHYT.NgayHieuLuc.ApplyFormatDate();
                bHYTDenNgay = theBHYT.NgayHetHan?.ApplyFormatDate();
                mucHuong = theBHYT.MucHuong.ToString() + "%";
                NoiDKKCBBanDau = benhVien != null ? benhVien?.Ten : "Chưa xác định";
                MaKCBBanDau = theBHYT.MaDKBD;
            }
            else
            {
                maBHYT = "";
                bHYTTuNgay = "";
                bHYTDenNgay = "";
                mucHuong = "0%";
                NoiDKKCBBanDau = "Chưa xác định";
                MaKCBBanDau = "Chưa xác định";
            }

            var dsChiPhiBangKe = new List<BangKeKhamBenhBenhVienVo>();
            var dateItemChiPhis = string.Empty;
            int indexItem = 1;

            using (var stream = new MemoryStream())
            {
                using (var xlPackage = new ExcelPackage(stream))
                {

                    var worksheet = xlPackage.Workbook.Worksheets.Add("BẢNG KÊ CHI PHÍ KHÁM CHỮA BỆNH CHỜ THU");

                    // set row
                    worksheet.Row(9).Height = 24.5;
                    worksheet.DefaultRowHeight = 16;

                    //SET chiều rộng cho từng cột tương ứng
                    worksheet.Column(1).Width = 10;
                    worksheet.Column(2).Width = 25;
                    worksheet.Column(3).Width = 15;
                    worksheet.Column(4).Width = 15;
                    worksheet.Column(5).Width = 15;
                    worksheet.Column(6).Width = 15;
                    worksheet.Column(7).Width = 15;
                    worksheet.Column(8).Width = 15;
                    worksheet.Column(9).Width = 15;
                    worksheet.Column(10).Width = 15;
                    worksheet.Column(11).Width = 15;
                    worksheet.Column(12).Width = 15;
                    worksheet.Column(13).Width = 15;
                    worksheet.Column(14).Width = 15;

                    worksheet.DefaultColWidth = 7;

                    using (var range = worksheet.Cells["A1:C1"])
                    {
                        range.Worksheet.Cells["A1:C1"].Merge = true;
                        range.Worksheet.Cells["A1:C1"].Value = "CƠ SỞ KHÁM CHỮA BỆNH : BỆNH VIỆN ĐKQT BẮC HÀ";
                        range.Worksheet.Cells["A1:C1"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A1:C1"].Style.VerticalAlignment = ExcelVerticalAlignment.Bottom;
                        range.Worksheet.Cells["A1:C1"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A1:C1"].Style.Font.Color.SetColor(Color.Black);
                    }                   

                    using (var range = worksheet.Cells["L1:N1"])
                    {
                        range.Worksheet.Cells["L1:N1"].Merge = true;
                        range.Worksheet.Cells["L1:N1"].Value = "Mẫu số : 01/KBCB ";
                        range.Worksheet.Cells["L1:N1"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                        range.Worksheet.Cells["L1:N1"].Style.VerticalAlignment = ExcelVerticalAlignment.Bottom;
                        range.Worksheet.Cells["L1:N1"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["L1:N1"].Style.Font.Color.SetColor(Color.Black);
                        range.Worksheet.Cells["L1:N1"].Style.Font.Bold = true;
                    }

                    using (var range = worksheet.Cells["L2:N2"])
                    {
                        range.Worksheet.Cells["L2:N2"].Merge = true;
                        range.Worksheet.Cells["L2:N2"].Value = "Mã số người bệnh: " + yeuCauTiepNhan.BenhNhan.MaBN;
                        range.Worksheet.Cells["L2:N2"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                        range.Worksheet.Cells["L2:N2"].Style.VerticalAlignment = ExcelVerticalAlignment.Bottom;
                        range.Worksheet.Cells["L2:N2"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["L2:N2"].Style.Font.Color.SetColor(Color.Black);
                        range.Worksheet.Cells["L2:N2"].Style.Font.Bold = true;
                    }

                    using (var range = worksheet.Cells["L3:N3"])
                    {
                        range.Worksheet.Cells["L3:N3"].Merge = true;
                        range.Worksheet.Cells["L3:N3"].Value = "Số khám bệnh:" + yeuCauTiepNhan.MaYeuCauTiepNhan;
                        range.Worksheet.Cells["L3:N3"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                        range.Worksheet.Cells["L3:N3"].Style.VerticalAlignment = ExcelVerticalAlignment.Bottom;
                        range.Worksheet.Cells["L3:N3"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["L3:N3"].Style.Font.Color.SetColor(Color.Black);
                        range.Worksheet.Cells["L3:N3"].Style.Font.Bold = true;
                    }

                    using (var range = worksheet.Cells["A4:N5"])
                    {
                        range.Worksheet.Cells["A4:N5"].Merge = true;
                        range.Worksheet.Cells["A4:N5"].Value = "BẢNG KÊ CHI PHÍ KHÁM CHỮA BỆNH CHỜ THU";
                        range.Worksheet.Cells["A4:N5"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        range.Worksheet.Cells["A4:N5"].Style.VerticalAlignment = ExcelVerticalAlignment.Bottom;
                        range.Worksheet.Cells["A4:N5"].Style.Font.SetFromFont(new Font("Times New Roman", 18));
                        range.Worksheet.Cells["A4:N5"].Style.Font.Color.SetColor(Color.Black);
                        range.Worksheet.Cells["A4:N5"].Style.Font.Bold = true;
                    }

                    using (var range = worksheet.Cells["A6:N6"])
                    {
                        range.Worksheet.Cells["A6:N6"].Merge = true;
                        range.Worksheet.Cells["A6:N6"].Value = "I.Hành chính";
                        range.Worksheet.Cells["A6:N6"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A6:N6"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A6:N6"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A6:N6"].Style.Font.Color.SetColor(Color.Black);
                        range.Worksheet.Cells["A6:N6"].Style.Font.Bold = true;
                    }

                    using (var range = worksheet.Cells["A7:F7"])
                    {
                        range.Worksheet.Cells["A7:F7"].Merge = true;

                        range.Worksheet.Cells["A7:F7"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["A7:F7"].RichText.Add("(1) Họ tên người bệnh: ");
                        var value = range.Worksheet.Cells["A7:F7"].RichText.Add(yeuCauTiepNhan.HoTen);
                        value.Bold = true;

                        range.Worksheet.Cells["A7:F7"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A7:F7"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A7:F7"].Style.Font.SetFromFont(new Font("Times New Roman", 11));


                        range.Worksheet.Cells["A7:F7"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["G7:J7"])
                    {
                        range.Worksheet.Cells["G7:J7"].Merge = true;
                        range.Worksheet.Cells["G7:J7"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["G7:J7"].RichText.Add("Ngày,tháng,năm sinh: ");
                        var value = range.Worksheet.Cells["G7:J7"].RichText.Add(DateHelper.DOBFormat(yeuCauTiepNhan.NgaySinh, yeuCauTiepNhan.ThangSinh, yeuCauTiepNhan.NamSinh));
                        value.Bold = true;

                        range.Worksheet.Cells["G7:J7"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["G7:J7"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["G7:J7"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["G7:J7"].Style.Font.Color.SetColor(Color.Black);
                    }

                    var gioitinh = yeuCauTiepNhan.GioiTinh != null ? yeuCauTiepNhan.GioiTinh.GetDescription() : "";
                    using (var range = worksheet.Cells["K7:N7"])
                    {
                        range.Worksheet.Cells["K7:N7"].Merge = true;

                        range.Worksheet.Cells["K7:N7"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["K7:N7"].RichText.Add("Giới tính: ");
                        var value = range.Worksheet.Cells["K7:N7"].RichText.Add(gioitinh);
                        value.Bold = true;

                        range.Worksheet.Cells["K7:N7"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["K7:N7"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["K7:N7"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["K7:N7"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["A8:F8"])
                    {
                        range.Worksheet.Cells["A8:F8"].Merge = true;

                        range.Worksheet.Cells["A8:F8"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["A8:F8"].RichText.Add("(2)Địa chỉ hiện tại: ");
                        var value = range.Worksheet.Cells["A8:F8"].RichText.Add(yeuCauTiepNhan.DiaChiDayDu);
                        value.Bold = true;

                        range.Worksheet.Cells["A8:F8"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A8:F8"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A8:F8"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A8:F8"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["G8:J8"])
                    {
                        range.Worksheet.Cells["G8:J8"].Merge = true;

                        range.Worksheet.Cells["G8:J8"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["G8:J8"].RichText.Add("(3)Mã khu vực(K1/K2/K3): ");
                        var value = range.Worksheet.Cells["G8:J8"].RichText.Add(yeuCauTiepNhan.BHYTMaKhuVuc);
                        value.Bold = true;

                        range.Worksheet.Cells["G8:J8"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["G8:J8"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["G8:J8"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["G8:J8"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["A9:F9"])
                    {
                        range.Worksheet.Cells["A9:F9"].Merge = true;
                        range.Worksheet.Cells["A9:F9"].Style.WrapText = true;

                        var title = range.Worksheet.Cells["A9:F9"].RichText.Add("(4)Mã thẻ BHYT: ");
                        var value = range.Worksheet.Cells["A9:F9"].RichText.Add(maBHYT);
                        value.Bold = true;

                        range.Worksheet.Cells["A9:F9"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A9:F9"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A9:F9"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A9:F9"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["G9:J9"])
                    {
                        range.Worksheet.Cells["G9:J9"].Merge = true;
                        range.Worksheet.Cells["G9:J9"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["G9:J9"].RichText.Add("Giá trị từ: ");
                        var valuebHYTTuNgay = range.Worksheet.Cells["G9:J9"].RichText.Add(bHYTTuNgay);
                        valuebHYTTuNgay.Bold = true;

                        var den = range.Worksheet.Cells["G9:J9"].RichText.Add(" đến: ");
                        den.Bold = false;
                        var valuebHYTDenNgay = range.Worksheet.Cells["G9:J9"].RichText.Add(bHYTDenNgay);
                        valuebHYTDenNgay.Bold = true;


                        range.Worksheet.Cells["G9:J9"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["G9:J9"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["G9:J9"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["G9:J9"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["A10:F10"])
                    {
                        range.Worksheet.Cells["A10:F10"].Merge = true;

                        range.Worksheet.Cells["A10:F10"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["A10:F10"].RichText.Add("(5)Nơi ĐK KCB ban đầu: ");
                        var valueNoiDKKCBBanDau = range.Worksheet.Cells["A10:F10"].RichText.Add(NoiDKKCBBanDau);
                        valueNoiDKKCBBanDau.Bold = true;

                        range.Worksheet.Cells["A10:F10"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A10:F10"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A10:F10"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A10:F10"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["G10:J10"])
                    {
                        range.Worksheet.Cells["G10:J10"].Merge = true;
                        range.Worksheet.Cells["G10:J10"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["G10:J10"].RichText.Add("(6)Mã: ");
                        var valueMaKCBBanDau = range.Worksheet.Cells["G10:J10"].RichText.Add(MaKCBBanDau);
                        valueMaKCBBanDau.Bold = true;

                        range.Worksheet.Cells["G10:J10"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["G10:J10"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["G10:J10"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["G10:J10"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["A11:F11"])
                    {
                        range.Worksheet.Cells["A11:F11"].Merge = true;

                        range.Worksheet.Cells["A11:F11"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["A11:F11"].RichText.Add("(7)Đến Khám: ");
                        var value = range.Worksheet.Cells["A11:F11"].RichText.Add(yeuCauTiepNhan.ThoiDiemTiepNhan.ApplyFormatGioPhutNgay());
                        value.Bold = true;

                        range.Worksheet.Cells["A11:F11"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A11:F11"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A11:F11"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A11:F11"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["A12:F12"])
                    {
                        range.Worksheet.Cells["A12:F12"].Merge = true;

                        range.Worksheet.Cells["A12:F12"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["A12:F12"].RichText.Add("(8)Điều trị ngoại trú/nội trú từ: ");
                        var value = range.Worksheet.Cells["A12:F12"].RichText.Add(string.Empty);
                        value.Bold = true;

                        range.Worksheet.Cells["A12:F12"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A12:F12"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A12:F12"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A12:F12"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["A13:F13"])
                    {
                        range.Worksheet.Cells["A13:F13"].Merge = true;
                        range.Worksheet.Cells["A13:F13"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["A13:F13"].RichText.Add("(9)Kết thúc khám/điều trị: ");
                        var value = range.Worksheet.Cells["A13:F13"].RichText.Add(yeuCauTiepNhan.NoiTruBenhAn?.ThoiDiemRaVien?.ApplyFormatGioPhutNgay());
                        value.Bold = true;


                        range.Worksheet.Cells["A13:F13"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A13:F13"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A13:F13"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A13:F13"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["G13:J13"])
                    {
                        range.Worksheet.Cells["G13:J13"].Merge = true;
                        range.Worksheet.Cells["G13:J13"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["G13:J13"].RichText.Add("Tổng số ngày điều trị: ");
                        var value = range.Worksheet.Cells["G13:J13"].RichText.Add(NoiTruBenhAnHelper.TinhSoNgayDieuTri(yeuCauTiepNhan.NoiTruBenhAn)?.ToString() ?? string.Empty);
                        value.Bold = true;

                        range.Worksheet.Cells["G13:J13"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["G13:J13"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["G13:J13"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["G13:J13"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["K13:N13"])
                    {
                        range.Worksheet.Cells["K13:N13"].Merge = true;

                        range.Worksheet.Cells["K13:N13"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["K13:N13"].RichText.Add("(10)Tình trạng ra viện: ");
                        var value = range.Worksheet.Cells["K13:N13"].RichText.Add((yeuCauTiepNhan.NoiTruBenhAn?.TinhTrangRaVien == EnumTinhTrangRaVien.RaVien && (yeuCauTiepNhan.NoiTruBenhAn?.KetQuaDieuTri == EnumKetQuaDieuTri.Do || yeuCauTiepNhan.NoiTruBenhAn?.KetQuaDieuTri == EnumKetQuaDieuTri.Khoi) ? 1 : 2).ToString());
                        value.Bold = true;


                        range.Worksheet.Cells["K13:N13"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["K13:N13"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["K13:N13"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["K13:N13"].Style.Font.Color.SetColor(Color.Black);
                    }

                    //=================================14=================================
                    var coCapCuu = yeuCauTiepNhan.LyDoVaoVien == Enums.EnumLyDoVaoVien.CapCuu ? "X" : string.Empty;
                    var coDungTuyen = yeuCauTiepNhan.LyDoVaoVien == Enums.EnumLyDoVaoVien.DungTuyen ? "X" : string.Empty;
                    var coThongTuyen = yeuCauTiepNhan.LyDoVaoVien == Enums.EnumLyDoVaoVien.ThongTuyen ? "X" : string.Empty;
                    var coTraiTuyen = yeuCauTiepNhan.LyDoVaoVien == Enums.EnumLyDoVaoVien.TraiTuyen ? "X" : string.Empty;

                    using (var range = worksheet.Cells["A14:C14"])
                    {
                        range.Worksheet.Cells["A14:C14"].Merge = true;

                        range.Worksheet.Cells["A14:C14"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["A14:C14"].RichText.Add("(11) Cấp cứu: ");
                        var value = range.Worksheet.Cells["A14:C14"].RichText.Add(coCapCuu);
                        value.Bold = true;

                        range.Worksheet.Cells["A14:C14"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A14:C14"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A14:C14"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A14:C14"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["D14:F14"])
                    {
                        range.Worksheet.Cells["D14:F14"].Merge = true;
                        range.Worksheet.Cells["D14:F14"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["D14:F14"].RichText.Add("(12) Đúng tuyến: ");
                        var value = range.Worksheet.Cells["D14:F14"].RichText.Add(coDungTuyen);
                        value.Bold = true;

                        range.Worksheet.Cells["D14:F14"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["D14:F14"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["D14:F14"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["D14:F14"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["G14:J14"])
                    {
                        range.Worksheet.Cells["G14:J14"].Merge = true;
                        range.Worksheet.Cells["G14:J14"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["G14:J14"].RichText.Add("Nơi chuyến đến: ");
                        var value = range.Worksheet.Cells["G14:J14"].RichText.Add(yeuCauTiepNhan.NoiChuyen?.Ten);
                        value.Bold = true;
                        range.Worksheet.Cells["G14:J14"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["G14:J14"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["G14:J14"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["G14:J14"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["K14:N14"])
                    {
                        range.Worksheet.Cells["K14:N14"].Merge = true;
                        range.Worksheet.Cells["K14:N14"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["K14:N14"].RichText.Add("Nơi chuyển đi: ");
                        var value = range.Worksheet.Cells["K14:N14"].RichText.Add(yeuCauTiepNhan.NoiTruBenhAn?.ChuyenDenBenhVien?.Ten);
                        value.Bold = true;
                        range.Worksheet.Cells["K14:N14"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["K14:N14"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["K14:N14"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["K14:N14"].Style.Font.Color.SetColor(Color.Black);
                    }

                    //=================================15=================================
                    using (var range = worksheet.Cells["A15:C15"])
                    {
                        range.Worksheet.Cells["A15:C15"].Merge = true;
                        range.Worksheet.Cells["A15:C15"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["A15:C15"].RichText.Add("(13)Thông tuyến: ");
                        var value = range.Worksheet.Cells["A15:C15"].RichText.Add(coThongTuyen);
                        value.Bold = true;
                        range.Worksheet.Cells["A15:C15"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A15:C15"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A15:C15"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A15:C15"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["D15:F15"])
                    {
                        range.Worksheet.Cells["D15:F15"].Merge = true;
                        range.Worksheet.Cells["D15:F15"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["D15:F15"].RichText.Add("(14)Trái tuyến: ");
                        var value = range.Worksheet.Cells["D15:F15"].RichText.Add(coTraiTuyen);
                        value.Bold = true;

                        range.Worksheet.Cells["D15:F15"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["D15:F15"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["D15:F15"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["D15:F15"].Style.Font.Color.SetColor(Color.Black);
                    }


                    //================================= 16 =================================

                    var chuanDoanXacDinhStr = yeuCauTiepNhan.NoiTruBenhAn?.LoaiBenhAn == LoaiBenhAn.SanKhoaMo || yeuCauTiepNhan.NoiTruBenhAn?.LoaiBenhAn == LoaiBenhAn.SanKhoaThuong
                                                            ? chuanDoanXacDinhSanKhoa : yeuCauTiepNhan.NoiTruBenhAn?.ChanDoanChinhRaVienGhiChu;


                    var iCD10 = yeuCauTiepNhan.NoiTruBenhAn?.LoaiBenhAn == LoaiBenhAn.SanKhoaMo || yeuCauTiepNhan.NoiTruBenhAn?.LoaiBenhAn == LoaiBenhAn.SanKhoaThuong
                                                               ? maICD10 : yeuCauTiepNhan.NoiTruBenhAn?.ChanDoanChinhRaVienICD?.Ma;


                    using (var range = worksheet.Cells["A16:F16"])
                    {
                        range.Worksheet.Cells["A16:F16"].Merge = true;
                        range.Worksheet.Cells["A16:F16"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["A16:F16"].RichText.Add("(15)Chẩn đoán xác định: ");
                        var value = range.Worksheet.Cells["A16:F16"].RichText.Add(chuanDoanXacDinhStr);
                        value.Bold = true;

                        range.Worksheet.Cells["A16:F16"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A16:F16"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A16:F16"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A16:F16"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["G16:N16"])
                    {
                        range.Worksheet.Cells["G16:N16"].Merge = true;

                        range.Worksheet.Cells["G16:N16"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["G16:N16"].RichText.Add("(16) Mã bệnh: ");
                        var value = range.Worksheet.Cells["G16:N16"].RichText.Add(iCD10);
                        value.Bold = true;


                        range.Worksheet.Cells["G16:N16"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["G16:N16"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["G16:N16"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["G16:N16"].Style.Font.Color.SetColor(Color.Black);
                    }

                    //================================= 17 =================================

                    using (var range = worksheet.Cells["A17:F17"])
                    {
                        range.Worksheet.Cells["A17:F17"].Merge = true;
                        range.Worksheet.Cells["A17:F17"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["A17:F17"].RichText.Add("(17)Bệnh kèm theo: ");
                        var value = range.Worksheet.Cells["A17:F17"].RichText.Add(tenICDKemTheo);
                        value.Bold = true;


                        range.Worksheet.Cells["A17:F17"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A17:F17"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A17:F17"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A17:F17"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["G17:N17"])
                    {
                        range.Worksheet.Cells["G17:N17"].Merge = true;
                        range.Worksheet.Cells["G17:N17"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["G17:N17"].RichText.Add("(18)Mã bệnh kèm theo: ");
                        var value = range.Worksheet.Cells["G17:N17"].RichText.Add(maICDKemTheo);
                        value.Bold = true;


                        range.Worksheet.Cells["G17:N17"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["G17:N17"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["G17:N17"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["G17:N17"].Style.Font.Color.SetColor(Color.Black);
                    }

                    //================================= 18 =================================

                    using (var range = worksheet.Cells["A18:F18"])
                    {
                        range.Worksheet.Cells["A18:F18"].Merge = true;
                        range.Worksheet.Cells["A18:F18"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["A18:F18"].RichText.Add("(19)Thời điểm đủ 05 năm liên tục từ ngày: ");
                        var value = range.Worksheet.Cells["A18:F18"].RichText.Add(yeuCauTiepNhan.BHYTNgayDu5Nam?.ApplyFormatDate());
                        value.Bold = true;


                        range.Worksheet.Cells["A18:F18"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A18:F18"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A18:F18"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A18:F18"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["G18:N18"])
                    {
                        range.Worksheet.Cells["G18:N18"].Merge = true;
                        range.Worksheet.Cells["G18:N18"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["G18:N18"].RichText.Add("(21)Miễn cùng chi trả trong năm từ ngày: ");
                        var value = range.Worksheet.Cells["G18:N18"].RichText.Add(yeuCauTiepNhan.BHYTNgayDuocMienCungChiTra?.ApplyFormatDate());
                        value.Bold = true;

                        range.Worksheet.Cells["G18:N18"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["G18:N18"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["G18:N18"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["G18:N18"].Style.Font.Color.SetColor(Color.Black);
                    }

                    //================================= 19 =================================

                    using (var range = worksheet.Cells["A19:N19"])
                    {
                        range.Worksheet.Cells["A19:N19"].Merge = true;
                        range.Worksheet.Cells["A19:N19"].Value = "II. Phần Chi phí khám bệnh, chữa bệnh";
                        range.Worksheet.Cells["A19:N19"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A19:N19"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A19:N19"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A19:N19"].Style.Font.Color.SetColor(Color.Black);
                        range.Worksheet.Cells["A19:N19"].Style.Font.Bold = true;
                    }                  
                    
                    int index = 20;

                    var groupChiPhiTheoThe = danhSachChiPhi.GroupBy(o => o.MaSoTheBHYT);
                    if (groupChiPhiTheoThe.Count() > 2 ||
                        (groupChiPhiTheoThe.All(o => o.Key != string.Empty) && groupChiPhiTheoThe.Count() > 1))
                    {
                        var groupNgayPhatSinhTheoThe = groupChiPhiTheoThe.Where(o => o.Key != string.Empty).Select(o => new { o.Key, o.OrderBy(j => j.NgayPhatSinh).First().NgayPhatSinh }).OrderBy(o => o.NgayPhatSinh).ToArray();
                        for (int i = 0; i < groupNgayPhatSinhTheoThe.Count(); i++)
                        {
                            var ngayPhatSinhTheoThe = groupNgayPhatSinhTheoThe[i];
                            var theBHYTChiTra = yeuCauTiepNhan.YeuCauTiepNhanTheBHYTs.First(o => o.MaSoThe == ngayPhatSinhTheoThe.Key);
                            var chiPhis = groupChiPhiTheoThe.FirstOrDefault(o => o.Key == ngayPhatSinhTheoThe.Key).ToList();
                            DateTime? ngayPhatSinhTiepTheo = i < groupNgayPhatSinhTheoThe.Count() - 1
                                ? groupNgayPhatSinhTheoThe[i + 1].NgayPhatSinh
                                : null;
                            chiPhis.AddRange(groupChiPhiTheoThe.FirstOrDefault(o => o.Key == string.Empty).Where(j => (i == 0 || j.NgayPhatSinh >= ngayPhatSinhTheoThe.NgayPhatSinh) && (ngayPhatSinhTiepTheo != null && j.NgayPhatSinh < ngayPhatSinhTiepTheo)).ToList());
                            var mucHuongPT = theBHYTChiTra != null && theBHYTChiTra.MucHuong > 0 ? theBHYTChiTra?.MucHuong + "%" : string.Empty;

                            using (var range = worksheet.Cells["A" + index + ":C" + index])
                            {
                                range.Worksheet.Cells["A" + index + ":C" + index].Merge = true;
                                range.Worksheet.Cells["A" + index + ":C" + index].Style.WrapText = true;
                                var title = range.Worksheet.Cells["A" + index + ":C" + index].RichText.Add("Mã thẻ BHYT: ");
                                var value = range.Worksheet.Cells["A" + index + ":C" + index].RichText.Add(theBHYTChiTra.MaSoThe);
                                value.Bold = true;

                                range.Worksheet.Cells["A" + index + ":C" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                range.Worksheet.Cells["A" + index + ":C" + index].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                                range.Worksheet.Cells["A" + index + ":C" + index].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                                range.Worksheet.Cells["A" + index + ":C" + index].Style.Font.Color.SetColor(Color.Black);
                            }

                            using (var range = worksheet.Cells["D" + index + ":F" + index])
                            {
                                range.Worksheet.Cells["D" + index + ":F" + index].Merge = true;
                                range.Worksheet.Cells["D" + index + ":F" + index].Style.WrapText = true;
                                var title = range.Worksheet.Cells["D" + index + ":F" + index].RichText.Add("Giá trị từ: ");
                                var valuebHYTTuNgay = range.Worksheet.Cells["D" + index + ":F" + index].RichText.Add(theBHYTChiTra.NgayHieuLuc.ApplyFormatDate());
                                valuebHYTTuNgay.Bold = true;

                                var den = range.Worksheet.Cells["D" + index + ":F" + index].RichText.Add(" đến: ");
                                den.Bold = false;
                                var valuebHYTDenNgay = range.Worksheet.Cells["D" + index + ":F" + index].RichText.Add(theBHYTChiTra?.NgayHetHan?.ApplyFormatDate());
                                valuebHYTDenNgay.Bold = true;

                                range.Worksheet.Cells["D" + index + ":F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                range.Worksheet.Cells["D" + index + ":F" + index].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                                range.Worksheet.Cells["D" + index + ":F" + index].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                                range.Worksheet.Cells["D" + index + ":F" + index].Style.Font.Color.SetColor(Color.Black);
                            }

                            using (var range = worksheet.Cells["G" + index + ":J" + index])
                            {
                                range.Worksheet.Cells["G" + index + ":J" + index].Merge = true;
                                range.Worksheet.Cells["G" + index + ":J" + index].Style.WrapText = true;
                                var title = range.Worksheet.Cells["G" + index + ":J" + index].RichText.Add("Mức hưởng: ");
                                var value = range.Worksheet.Cells["G" + index + ":J" + index].RichText.Add(mucHuongPT);
                                value.Bold = true;


                                range.Worksheet.Cells["G" + index + ":J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                range.Worksheet.Cells["G" + index + ":J" + index].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                                range.Worksheet.Cells["G" + index + ":J" + index].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                                range.Worksheet.Cells["G" + index + ":J" + index].Style.Font.Color.SetColor(Color.Black);
                            }

                            index++;

                            var indexTableFirst = index;
                            var indexTableLast = index + 1;

                            using (var range = worksheet.Cells["A" + indexTableFirst + ":N" + indexTableLast])
                            {
                                range.Worksheet.Cells["A" + indexTableFirst + ":N" + indexTableLast].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                                range.Worksheet.Cells["A" + indexTableFirst + ":N" + indexTableLast].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                                range.Worksheet.Cells["A" + indexTableFirst + ":N" + indexTableLast].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                range.Worksheet.Cells["A" + indexTableFirst + ":N" + indexTableLast].Style.Font.Color.SetColor(Color.Black);
                                range.Worksheet.Cells["A" + indexTableFirst + ":N" + indexTableLast].Style.Font.Bold = true;
                                range.Worksheet.Cells["A" + indexTableFirst + ":N" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);

                                range.Worksheet.Cells["A" + indexTableFirst + ":A" + indexTableLast].Merge = true;
                                range.Worksheet.Cells["A" + indexTableFirst + ":A" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["A" + indexTableFirst + ":A" + indexTableLast].Value = "STT";

                                range.Worksheet.Cells["B" + indexTableFirst + ":B" + indexTableLast].Merge = true;
                                range.Worksheet.Cells["B" + indexTableFirst + ":B" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["B" + indexTableFirst + ":B" + indexTableLast].Value = "Nội dung";

                                range.Worksheet.Cells["C" + indexTableFirst + ":C" + indexTableLast].Merge = true;
                                range.Worksheet.Cells["C" + indexTableFirst + ":C" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["C" + indexTableFirst + ":C" + indexTableLast].Value = "Đơn vị tính";

                                range.Worksheet.Cells["D" + indexTableFirst + ":D" + indexTableLast].Merge = true;
                                range.Worksheet.Cells["D" + indexTableFirst + ":D" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["D" + indexTableFirst + ":D" + indexTableLast].Value = "Số lượng";

                                range.Worksheet.Cells["E" + indexTableFirst + ":E" + indexTableLast].Merge = true;
                                range.Worksheet.Cells["E" + indexTableFirst + ":E" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["E" + indexTableFirst + ":E" + indexTableLast].Value = "Đơn giá BV(đồng)";

                                range.Worksheet.Cells["F" + indexTableFirst + ":F" + indexTableLast].Merge = true;
                                range.Worksheet.Cells["F" + indexTableFirst + ":F" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["F" + indexTableFirst + ":F" + indexTableLast].Value = "Đơn giá BH(đồng)";

                                range.Worksheet.Cells["G" + indexTableFirst + ":G" + indexTableLast].Merge = true;
                                range.Worksheet.Cells["G" + indexTableFirst + ":G" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["G" + indexTableFirst + ":G" + indexTableLast].Value = "Tỉ lệ thanh toán theo dịch vụ (%)";

                                range.Worksheet.Cells["H" + indexTableFirst + ":H" + indexTableLast].Merge = true;
                                range.Worksheet.Cells["H" + indexTableFirst + ":H" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["H" + indexTableFirst + ":H" + indexTableLast].Value = "Thành tiền BV (đồng)";

                                range.Worksheet.Cells["I" + indexTableFirst + ":I" + indexTableLast].Merge = true;
                                range.Worksheet.Cells["I" + indexTableFirst + ":I" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["I" + indexTableFirst + ":I" + indexTableLast].Value = "Tỷ lệ thanh toán BHYT (%)";

                                range.Worksheet.Cells["J" + indexTableFirst + ":J" + indexTableLast].Merge = true;
                                range.Worksheet.Cells["J" + indexTableFirst + ":J" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["J" + indexTableFirst + ":J" + indexTableLast].Value = "Thành tiền BH(đồng)";

                                range.Worksheet.Cells["K" + indexTableFirst + ":N" + indexTableFirst].Merge = true;
                                range.Worksheet.Cells["K" + indexTableFirst + ":N" + indexTableFirst].Value = "Nguồn thanh toán (đồng)";

                                range.Worksheet.Cells["K" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["K" + indexTableLast].Value = "Quỹ BHYT";

                                range.Worksheet.Cells["L" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["L" + indexTableLast].Value = "Người bệnh cùng chi trả (đồng)";

                                range.Worksheet.Cells["M" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["M" + indexTableLast].Value = "Khác (đồng)";

                                range.Worksheet.Cells["N" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["N" + indexTableLast].Value = "Người bệnh tự trả(đồng)";
                            }

                            index = indexTableLast + 1;

                            var dsChiPhiBangKeTheoThe = new List<BangKeKhamBenhBenhVienVo>();

                            foreach (var chiPhi in chiPhis.Where(c => c.NhomChiPhiBangKe != NhomChiPhiBangKe.GoiVatTu && c.YeuCauGoiDichVuId == null).GroupBy(c => new { c.DonGia, c.SoTienMG, KhongTinhPhi = c.KhongTinhPhi.GetValueOrDefault(), c.NhomChiPhiBangKe, c.TenDichVu, c.DonViTinh, c.DuocHuongBHYT, c.DonGiaBHYT, c.MucHuongBaoHiem, c.TiLeBaoHiemThanhToan }).OrderByDescending(o => o.Key.DuocHuongBHYT))
                            {
                                var chiphiBangKe = new BangKeKhamBenhBenhVienVo
                                {
                                    Nhom = chiPhi.Key.NhomChiPhiBangKe,
                                    Id = chiPhi.FirstOrDefault().Id,
                                    NoiDung = chiPhi.Key.TenDichVu,
                                    DonViTinh = chiPhi.Key.DonViTinh,
                                    SoLuong = (decimal)chiPhi.Sum(c => c.Soluong),
                                    DuocHuongBaoHiem = chiPhi.Key.DuocHuongBHYT,
                                    DonGiaBH = chiPhi.Key.DuocHuongBHYT ? chiPhi.Key.DonGiaBHYT : 0,
                                    MucHuongBaoHiem = chiPhi.Key.MucHuongBaoHiem,
                                    TiLeThanhToanTheoDV = chiPhi.Key.TiLeBaoHiemThanhToan,
                                    BaoHiemChiTra = true,
                                    DonGiaBV = chiPhi.Key.DonGia
                                };
                                if (chiPhi.Key.KhongTinhPhi == true)
                                {
                                    chiphiBangKe.Khac = chiPhi.Key.MucHuongBaoHiem > 0
                                        ? (chiphiBangKe.ThanhTienBV.GetValueOrDefault() - chiphiBangKe.ThanhTienBH.GetValueOrDefault())
                                        : chiphiBangKe.ThanhTienBV.GetValueOrDefault();
                                }
                                else
                                {
                                    chiphiBangKe.Khac = chiPhi.Sum(c => c.SoTienMG);
                                }
                                dsChiPhiBangKeTheoThe.Add(chiphiBangKe);
                            }

                            foreach (var chiPhi in chiPhis.Where(c => !(c.NhomChiPhiBangKe != NhomChiPhiBangKe.GoiVatTu && c.YeuCauGoiDichVuId == null)))
                            {
                                var chiphiBangKe = new BangKeKhamBenhBenhVienVo
                                {
                                    Nhom = chiPhi.NhomChiPhiBangKe,
                                    Id = chiPhi.Id,
                                    NoiDung = chiPhi.TenDichVu,
                                    DonViTinh = chiPhi.DonViTinh,
                                    SoLuong = (decimal)chiPhi.Soluong,
                                    DuocHuongBaoHiem = chiPhi.DuocHuongBHYT,
                                    DonGiaBH = chiPhi.DuocHuongBHYT ? chiPhi.DonGiaBHYT : 0,
                                    MucHuongBaoHiem = chiPhi.MucHuongBaoHiem,
                                    TiLeThanhToanTheoDV = chiPhi.TiLeBaoHiemThanhToan,
                                    BaoHiemChiTra = true,
                                    DonGiaBV = chiPhi.DonGia
                                };
                                if (chiPhi.KhongTinhPhi == true || chiPhi.YeuCauGoiDichVuId != null)
                                {
                                    chiphiBangKe.Khac = chiPhi.MucHuongBaoHiem > 0
                                        ? (chiphiBangKe.ThanhTienBV.GetValueOrDefault() - chiphiBangKe.ThanhTienBH.GetValueOrDefault())
                                        : chiphiBangKe.ThanhTienBV.GetValueOrDefault();
                                }
                                else
                                {
                                    chiphiBangKe.Khac = chiPhi.SoTienMG;
                                }
                                dsChiPhiBangKeTheoThe.Add(chiphiBangKe);
                            }
                            //Update BACHA-458
                            //Trường hợp NB có miễn giảm 100% tiền giường chỉ hiển thị tại cột khác
                            //Riêng cột NB cùng chi trả và NB tự trả là 0đ
                            //foreach (var chiphi in dsChiPhiBangKeTheoThe.Where(o => o.Nhom == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay ||
                            //                                                        o.Nhom == NhomChiPhiBangKe.NgayGiuongDieuTriNoiTru))
                            //{
                            //    if (chiphi.QuyBHYT > 0 && chiphi.Khac.GetValueOrDefault().SoTienTuongDuong(chiphi.ThanhTienBV.GetValueOrDefault() - chiphi.QuyBHYT))
                            //    {
                            //        chiphi.Khac = chiphi.ThanhTienBV;
                            //    }
                            //}

                            dsChiPhiBangKe.AddRange(dsChiPhiBangKeTheoThe);
                            var groupChiPhiBangKes = dsChiPhiBangKeTheoThe.GroupBy(x => x.Nhom).OrderBy(o => (int)o.Key * (o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay || o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriNoiTru ? 1 : 10));
                            if (!groupChiPhiBangKes.Any())
                            {
                                return null;
                            }
                            foreach (var groupChiPhiBangKe in groupChiPhiBangKes)
                            {
                                if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay)
                                {

                                    worksheet.Cells["A" + index + ":N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["A" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                    worksheet.Cells["A" + index + ":N" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                    worksheet.Cells["A" + index + ":N" + index].Merge = true;
                                    worksheet.Cells["A" + index + ":N" + index].Value = "2. Ngày giường:";
                                    worksheet.Cells["A" + index + ":N" + index].Style.Font.Bold = true;

                                    index++;

                                    worksheet.Cells["A" + index + ":G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["A" + index + ":G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                    worksheet.Cells["A" + index + ":G" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                    worksheet.Cells["A" + index + ":G" + index].Merge = true;
                                    worksheet.Cells["A" + index + ":G" + index].Value = "2.1." + groupChiPhiBangKe.Key.GetDescription();
                                    worksheet.Cells["A" + index + ":G" + index].Style.Font.Bold = true;

                                    worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["H" + index].Style.Font.Bold = true;
                                    worksheet.Cells["H" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBV);

                                    worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["J" + index].Style.Font.Bold = true;
                                    worksheet.Cells["J" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBH);

                                    worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["K" + index].Style.Font.Bold = true;
                                    worksheet.Cells["K" + index].Value = groupChiPhiBangKe.Sum(o => o.QuyBHYT);

                                    worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["L" + index].Style.Font.Bold = true;
                                    worksheet.Cells["L" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra);

                                    worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["M" + index].Style.Font.Bold = true;
                                    worksheet.Cells["M" + index].Value = groupChiPhiBangKe.Sum(o => o.Khac);

                                    worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["N" + index].Style.Font.Bold = true;
                                    worksheet.Cells["N" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra);

                                    index++;
                                }
                                else if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.NgayGiuongDieuTriNoiTru)
                                {
                                    if (!groupChiPhiBangKes.Any(o => o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay))
                                    {
                                        worksheet.Cells["A" + index + ":N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["A" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                        worksheet.Cells["A" + index + ":N" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                        worksheet.Cells["A" + index + ":N" + index].Merge = true;
                                        worksheet.Cells["A" + index + ":N" + index].Value = "2. Ngày giường:";
                                        worksheet.Cells["A" + index + ":N" + index].Style.Font.Bold = true;

                                    }
                                    index++;

                                    worksheet.Cells["A" + index + ":G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["A" + index + ":G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                    worksheet.Cells["A" + index + ":G" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                    worksheet.Cells["A" + index + ":G" + index].Merge = true;
                                    worksheet.Cells["A" + index + ":G" + index].Value = "2.2." + groupChiPhiBangKe.Key.GetDescription();
                                    worksheet.Cells["A" + index + ":G" + index].Style.Font.Bold = true;

                                    worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["H" + index].Style.Font.Bold = true;
                                    worksheet.Cells["H" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBV);

                                    worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["J" + index].Style.Font.Bold = true;
                                    worksheet.Cells["J" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBH);

                                    worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["K" + index].Style.Font.Bold = true;
                                    worksheet.Cells["K" + index].Value = groupChiPhiBangKe.Sum(o => o.QuyBHYT);

                                    worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["L" + index].Style.Font.Bold = true;
                                    worksheet.Cells["L" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra);

                                    worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["M" + index].Style.Font.Bold = true;
                                    worksheet.Cells["M" + index].Value = groupChiPhiBangKe.Sum(o => o.Khac);

                                    worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["N" + index].Style.Font.Bold = true;
                                    worksheet.Cells["N" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra);

                                    index++;
                                }
                                else
                                {
                                    worksheet.Cells["A" + index + ":G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["A" + index + ":G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                    worksheet.Cells["A" + index + ":G" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                    worksheet.Cells["A" + index + ":G" + index].Merge = true;
                                    worksheet.Cells["A" + index + ":G" + index].Value = (int)groupChiPhiBangKe.Key + "." + groupChiPhiBangKe.Key.GetDescription();
                                    worksheet.Cells["A" + index + ":G" + index].Style.Font.Bold = true;

                                    worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["H" + index].Style.Font.Bold = true;
                                    worksheet.Cells["H" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBV);

                                    worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["J" + index].Style.Font.Bold = true;
                                    worksheet.Cells["J" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBH);

                                    worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["K" + index].Style.Font.Bold = true;
                                    worksheet.Cells["K" + index].Value = groupChiPhiBangKe.Sum(o => o.QuyBHYT);

                                    worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["L" + index].Style.Font.Bold = true;
                                    worksheet.Cells["L" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra);

                                    worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["M" + index].Style.Font.Bold = true;
                                    worksheet.Cells["M" + index].Value = groupChiPhiBangKe.Sum(o => o.Khac);

                                    worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["N" + index].Style.Font.Bold = true;
                                    worksheet.Cells["N" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra);

                                    index++;
                                }
                                if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.GoiVatTu)
                                {
                                    var groupGoiVatTus = groupChiPhiBangKe.ToList().GroupBy(o => o.SoGoiVatTu.GetValueOrDefault()).OrderBy(o => o.Key);
                                    int sttGoiVatTu = 1;
                                    foreach (var groupGoiVatTu in groupGoiVatTus)
                                    {
                                        worksheet.Cells["A" + index + ":G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["A" + index + ":G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                        worksheet.Cells["A" + index + ":G" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                        worksheet.Cells["A" + index + ":G" + index].Value = "10." + sttGoiVatTu + ". " + groupChiPhiBangKe.Key.GetDescription() + " " + sttGoiVatTu;
                                        worksheet.Cells["A" + index + ":G" + index].Style.Font.Bold = true;
                                        worksheet.Cells["A" + index + ":G" + index].Merge = true;

                                        worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["H" + index].Style.Font.Bold = true;
                                        worksheet.Cells["H" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBV);

                                        worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["J" + index].Style.Font.Bold = true;
                                        worksheet.Cells["J" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBH);

                                        worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["K" + index].Style.Font.Bold = true;
                                        worksheet.Cells["K" + index].Value = groupChiPhiBangKe.Sum(o => o.QuyBHYT);

                                        worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["L" + index].Style.Font.Bold = true;
                                        worksheet.Cells["L" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra);

                                        worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["M" + index].Style.Font.Bold = true;
                                        worksheet.Cells["M" + index].Value = groupChiPhiBangKe.Sum(o => o.Khac);

                                        worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["N" + index].Style.Font.Bold = true;
                                        worksheet.Cells["N" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra);

                                        index++;
                                        foreach (var chiPhiBangKe in groupGoiVatTu)
                                        {
                                            worksheet.Cells["A" + index + ":N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["A" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                            worksheet.Cells["A" + index + ":N" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));

                                            worksheet.Cells["A" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["A" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                            worksheet.Cells["A" + index].Value = indexItem;

                                            worksheet.Cells["B" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["B" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                            worksheet.Cells["B" + index].Value = chiPhiBangKe.NoiDung;

                                            worksheet.Cells["C" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["C" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                            worksheet.Cells["C" + index].Value = chiPhiBangKe.DonViTinh;

                                            worksheet.Cells["D" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["D" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                            worksheet.Cells["D" + index].Value = chiPhiBangKe.SoLuong;

                                            worksheet.Cells["E" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["E" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                            worksheet.Cells["E" + index].Style.Numberformat.Format = "#,##0.00";
                                            worksheet.Cells["E" + index].Value = chiPhiBangKe.DonGiaBV;

                                            worksheet.Cells["F" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["F" + index].Style.Numberformat.Format = "#,##0.00";
                                            worksheet.Cells["F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                            worksheet.Cells["F" + index].Value = chiPhiBangKe.DonGiaBH;

                                            worksheet.Cells["G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                            worksheet.Cells["G" + index].Style.Numberformat.Format = "#,##0.00";
                                            worksheet.Cells["G" + index].Value = chiPhiBangKe.TiLeThanhToanTheoDV;

                                            worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                            worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                            worksheet.Cells["H" + index].Value = chiPhiBangKe.ThanhTienBV;

                                            worksheet.Cells["I" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["I" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                            worksheet.Cells["I" + index].Value = Convert.ToDouble(chiPhiBangKe.MucHuongBaoHiem > 0 ? 100 : 0).ApplyFormatMoneyToDouble();


                                            worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                            worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                            worksheet.Cells["J" + index].Value = chiPhiBangKe.ThanhTienBH;


                                            worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                            worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                            worksheet.Cells["K" + index].Value = chiPhiBangKe.QuyBHYT;


                                            worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                            worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                            worksheet.Cells["L" + index].Value = chiPhiBangKe.NguoiBenhCungChiTra;


                                            worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                            worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                            worksheet.Cells["M" + index].Value = chiPhiBangKe.Khac;


                                            worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                            worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                            worksheet.Cells["N" + index].Value = chiPhiBangKe.NguoiBenhTuTra;

                                            indexItem++;
                                            index++;
                                        }
                                    }
                                }
                                else
                                {
                                    foreach (var chiPhiBangKe in groupChiPhiBangKe)
                                    {
                                        worksheet.Cells["A" + index + ":N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["A" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                        worksheet.Cells["A" + index + ":N" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));

                                        worksheet.Cells["A" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["A" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                        worksheet.Cells["A" + index].Value = indexItem;

                                        worksheet.Cells["B" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["B" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                        worksheet.Cells["B" + index].Value = chiPhiBangKe.NoiDung;

                                        worksheet.Cells["C" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["C" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                        worksheet.Cells["C" + index].Value = chiPhiBangKe.DonViTinh;

                                        worksheet.Cells["D" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["D" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                        worksheet.Cells["D" + index].Value = chiPhiBangKe.SoLuong;

                                        worksheet.Cells["E" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["E" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["E" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["E" + index].Value = chiPhiBangKe.DonGiaBV;

                                        worksheet.Cells["F" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["F" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["F" + index].Value = chiPhiBangKe.DonGiaBH;

                                        worksheet.Cells["G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["G" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["G" + index].Value = chiPhiBangKe.TiLeThanhToanTheoDV;

                                        worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["H" + index].Value = chiPhiBangKe.ThanhTienBV;

                                        worksheet.Cells["I" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["I" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["I" + index].Value = Convert.ToDouble(chiPhiBangKe.MucHuongBaoHiem > 0 ? 100 : 0).ApplyFormatMoneyToDouble();


                                        worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["J" + index].Value = chiPhiBangKe.ThanhTienBH;


                                        worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["K" + index].Value = chiPhiBangKe.QuyBHYT;


                                        worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["L" + index].Value = chiPhiBangKe.NguoiBenhCungChiTra;


                                        worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["M" + index].Value = chiPhiBangKe.Khac;


                                        worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["N" + index].Value = chiPhiBangKe.NguoiBenhTuTra;

                                        indexItem++;
                                        index++;
                                    }
                                }

                            }



                            worksheet.Cells["A" + index + ":G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["A" + index + ":G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                            worksheet.Cells["A" + index + ":G" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                            worksheet.Cells["A" + index + ":G" + index].Merge = true;
                            worksheet.Cells["A" + index + ":G" + index].Value = "Tổng cộng";
                            worksheet.Cells["A" + index + ":G" + index].Style.Font.Bold = true;

                            worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                            worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                            worksheet.Cells["H" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.ThanhTienBV)).Sum();


                            worksheet.Cells["I" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["I" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;

                            worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                            worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                            worksheet.Cells["J" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.ThanhTienBH)).Sum();

                            worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                            worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                            worksheet.Cells["K" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.QuyBHYT)).Sum();

                            worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                            worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                            worksheet.Cells["L" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.NguoiBenhCungChiTra)).Sum();

                            worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                            worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                            worksheet.Cells["M" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.Khac)).Sum();

                            worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                            worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                            worksheet.Cells["N" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.NguoiBenhTuTra)).Sum();

                            index++;

                            worksheet.Cells["A" + index + ":N" + index].Merge = true;
                            worksheet.Cells["A" + index + ":N" + index].Value = "Tổng chi phí lần khám bệnh/cả đợt điều trị: " + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + " đồng";
                            worksheet.Cells["A" + index + ":N" + index].Style.Font.Bold = true;

                            index++;

                            worksheet.Cells["A" + index + ":N" + index].Merge = true;
                            worksheet.Cells["A" + index + ":N" + index].Value = "(Viết bằng chữ: " + NumberHelper.ChuyenSoRaText(Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBV))) + ")";

                            index++;

                            worksheet.Cells["A" + index + ":N" + index].Merge = true;
                            worksheet.Cells["A" + index + ":N" + index].Value = "Trong đó , số tiền do:";
                            worksheet.Cells["A" + index + ":N" + index].Style.Font.Bold = true;

                            index++;
                            worksheet.Cells["A" + index + ":N" + index].Merge = true;
                            worksheet.Cells["A" + index + ":N" + index].Value = "- Quỹ BHYT thanh toán: " + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble();

                            var tongBHTN = Convert.ToDouble(danhSachTatCaChiPhi.Where(o => o.TrangThaiThanhToan != Enums.TrangThaiThanhToan.DaThanhToan).Sum(o => o.TongCongNo));
                            if (tongBHTN != 0)
                            {
                                index++;
                                worksheet.Cells["A" + index + ":N" + index].Merge = true;
                                worksheet.Cells["A" + index + ":N" + index].Value = "- BHTN bảo lãnh: " + Convert.ToDouble(tongBHTN).ApplyFormatMoneyToDouble();
                            }

                            index++;
                            var tongTamUng = GetSoTienDaTamUngAsync(yeuCauTiepNhanId).Result;
                            worksheet.Cells["A" + index + ":N" + index].Merge = true;
                            worksheet.Cells["A" + index + ":N" + index].Value = "- Tổng tạm ứng: " + Convert.ToDouble(tongTamUng).ApplyFormatMoneyToDouble();


                            index++;
                            worksheet.Cells["A" + index + ":N" + index].Merge = true;
                            worksheet.Cells["A" + index + ":N" + index].Value = "+ Nguồn khác: " + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble(true);


                            var tongQuyBHYTThanhToan = Convert.ToDouble(danhSachTatCaChiPhi.Where(o => o.TrangThaiThanhToan != TrangThaiThanhToan.DaThanhToan && o.KiemTraBHYTXacNhan).Sum(o => o.BHYTThanhToan));
                            var soTienCanThu = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBV)) - Convert.ToDouble(tongTamUng) - tongQuyBHYTThanhToan - tongBHTN - Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.Khac));
                            string soTienNBTuTraHoacTraLaiBN = soTienCanThu < 0 ? $"- Phải trả lại NB: {(soTienCanThu * (-1)).ApplyFormatMoneyToDouble()}" : $"- Người bệnh tự trả: {(soTienCanThu).ApplyFormatMoneyToDouble()}";

                            index++;

                            worksheet.Cells["A" + index + ":N" + index].Merge = true;
                            worksheet.Cells["A" + index + ":N" + index].Value = soTienNBTuTraHoacTraLaiBN;


                            index = index + 2;

                            worksheet.Cells["G" + index + ":N" + index].Style.Font.Bold = true;
                            worksheet.Cells["G" + index + ":N" + index].Merge = true;
                            worksheet.Cells["G" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                            worksheet.Cells["G" + index + ":N" + index].Value = "XÁC NHẬN CỦA NGƯỜI BỆNH ";

                            index++;

                            worksheet.Cells["A" + index + ":F" + index].Style.Font.Bold = true;
                            worksheet.Cells["A" + index + ":F" + index].Merge = true;
                            worksheet.Cells["A" + index + ":F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                            worksheet.Cells["A" + index + ":F" + index].Value = "NGƯỜI LẬP BẢNG KÊ";


                            worksheet.Cells["G" + index + ":N" + index].Style.Font.Bold = true;
                            worksheet.Cells["G" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                            worksheet.Cells["G" + index + ":N" + index].Merge = true;
                            worksheet.Cells["G" + index + ":N" + index].Value = "(Ký , Ghi rõ họ tên)";

                            index++;

                            worksheet.Cells["A" + index + ":F" + index].Style.Font.Bold = true;
                            worksheet.Cells["A" + index + ":F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                            worksheet.Cells["A" + index + ":F" + index].Merge = true;
                            worksheet.Cells["A" + index + ":F" + index].Value = "(Ký , Ghi rõ họ tên)";


                            worksheet.Cells["G" + index + ":N" + index].Style.Font.Bold = true;
                            worksheet.Cells["G" + index + ":N" + index].Merge = true;
                            worksheet.Cells["G" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                            worksheet.Cells["G" + index + ":N" + index].Value = "(Tôi đã nhận...phim...Xquang / CT / MRI)";

                            //xlPackage.Save();
                        }
                    }
                    else
                    {
                        YeuCauTiepNhanTheBHYT theBHYTChiTra = null;
                        var maSoThe = groupChiPhiTheoThe.Where(o => o.Key != string.Empty).FirstOrDefault()?.Key;
                        if (!string.IsNullOrEmpty(maSoThe))
                        {
                            theBHYTChiTra = yeuCauTiepNhan.YeuCauTiepNhanTheBHYTs.First(o => o.MaSoThe == maSoThe);
                        }

                        var chiPhis = groupChiPhiTheoThe.SelectMany(o => o).ToList();
                        var mucHuongPT = theBHYTChiTra != null && theBHYTChiTra?.MucHuong > 0 ? theBHYTChiTra?.MucHuong + "%" : string.Empty;

                        //================================= 20 =========================================
                        using (var range = worksheet.Cells["A20:C20"])
                        {
                            range.Worksheet.Cells["A20:C20"].Merge = true;
                            range.Worksheet.Cells["A20:C20"].Style.WrapText = true;
                            var title = range.Worksheet.Cells["A20:C20"].RichText.Add("Mã thẻ BHYT: ");
                            var value = range.Worksheet.Cells["A20:C20"].RichText.Add(theBHYTChiTra?.MaSoThe);
                            value.Bold = true;

                            range.Worksheet.Cells["A20:C20"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                            range.Worksheet.Cells["A20:C20"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                            range.Worksheet.Cells["A20:C20"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                            range.Worksheet.Cells["A20:C20"].Style.Font.Color.SetColor(Color.Black);
                        }
                        using (var range = worksheet.Cells["D20:F20"])
                        {
                            range.Worksheet.Cells["D20:F20"].Merge = true;
                            range.Worksheet.Cells["D20:F20"].Style.WrapText = true;
                            var title = range.Worksheet.Cells["D20:F20"].RichText.Add("Giá trị từ: ");
                            var valuebHYTTuNgay = range.Worksheet.Cells["D20:F20"].RichText.Add(theBHYTChiTra?.NgayHieuLuc.ApplyFormatDate());
                            valuebHYTTuNgay.Bold = true;

                            var den = range.Worksheet.Cells["D20:F20"].RichText.Add(" đến: ");
                            den.Bold = false;
                            var valuebHYTDenNgay = range.Worksheet.Cells["D20:F20"].RichText.Add(theBHYTChiTra?.NgayHetHan?.ApplyFormatDate());
                            valuebHYTDenNgay.Bold = true;

                            range.Worksheet.Cells["D20:F20"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                            range.Worksheet.Cells["D20:F20"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                            range.Worksheet.Cells["D20:F20"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                            range.Worksheet.Cells["D20:F20"].Style.Font.Color.SetColor(Color.Black);
                        }
                        using (var range = worksheet.Cells["G20:J20"])
                        {
                            range.Worksheet.Cells["G20:J20"].Merge = true;
                            range.Worksheet.Cells["G20:J20"].Style.WrapText = true;
                            var title = range.Worksheet.Cells["G20:J20"].RichText.Add("Mức hưởng: ");
                            var value = range.Worksheet.Cells["G20:J20"].RichText.Add(mucHuongPT);
                            value.Bold = true;


                            range.Worksheet.Cells["G20:J20"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                            range.Worksheet.Cells["G20:J20"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                            range.Worksheet.Cells["G20:J20"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                            range.Worksheet.Cells["G20:J20"].Style.Font.Color.SetColor(Color.Black);
                        }

                        using (var range = worksheet.Cells["A21:N22"])
                        {
                            range.Worksheet.Cells["A21:N22"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                            range.Worksheet.Cells["A21:N22"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                            range.Worksheet.Cells["A21:N22"].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                            range.Worksheet.Cells["A21:N22"].Style.Font.Color.SetColor(Color.Black);
                            range.Worksheet.Cells["A21:N22"].Style.Font.Bold = true;
                            range.Worksheet.Cells["A21:N22"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);

                            range.Worksheet.Cells["A21:A22"].Merge = true;
                            range.Worksheet.Cells["A21:A22"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["A21:A22"].Value = "STT";

                            range.Worksheet.Cells["B21:B22"].Merge = true;
                            range.Worksheet.Cells["B21:B22"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["B21:B22"].Value = "Nội dung";

                            range.Worksheet.Cells["C21:C22"].Merge = true;
                            range.Worksheet.Cells["C21:C22"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["C21:C22"].Value = "Đơn vị tính";

                            range.Worksheet.Cells["D21:D22"].Merge = true;
                            range.Worksheet.Cells["D21:D22"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["D21:D22"].Value = "Số lượng";

                            range.Worksheet.Cells["E21:E22"].Merge = true;
                            range.Worksheet.Cells["E21:E22"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["E21:E22"].Value = "Đơn giá BV(đồng)";

                            range.Worksheet.Cells["F21:F22"].Merge = true;
                            range.Worksheet.Cells["F21:F22"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["F21:F22"].Value = "Đơn giá BH(đồng)";

                            range.Worksheet.Cells["G21:G22"].Merge = true;
                            range.Worksheet.Cells["G21:G22"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["G21:G22"].Value = "Tỉ lệ thanh toán theo dịch vụ (%)";

                            range.Worksheet.Cells["H21:H22"].Merge = true;
                            range.Worksheet.Cells["H21:H22"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["H21:H22"].Value = "Thành tiền BV (đồng)";

                            range.Worksheet.Cells["I21:I22"].Merge = true;
                            range.Worksheet.Cells["I21:I22"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["I21:I22"].Value = "Tỷ lệ thanh toán BHYT (%)";

                            range.Worksheet.Cells["J21:J22"].Merge = true;
                            range.Worksheet.Cells["J21:J22"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["J21:J22"].Value = "Thành tiền BH(đồng)";

                            range.Worksheet.Cells["K21:N21"].Merge = true;
                            range.Worksheet.Cells["K21:N21"].Value = "Nguồn thanh toán (đồng)";

                            range.Worksheet.Cells["K22"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["K22"].Value = "Quỹ BHYT";

                            range.Worksheet.Cells["L22"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["L22"].Value = "Người bệnh cùng chi trả (đồng)";

                            range.Worksheet.Cells["M22"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["M22"].Value = "Khác (đồng)";

                            range.Worksheet.Cells["N22"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["N22"].Value = "Người bệnh tự trả(đồng)";
                        }
                        index = index + 3;

                        foreach (var chiPhi in chiPhis.Where(c => c.NhomChiPhiBangKe != NhomChiPhiBangKe.GoiVatTu && c.YeuCauGoiDichVuId == null).GroupBy(c => new { c.DonGia, c.SoTienMG, KhongTinhPhi = c.KhongTinhPhi.GetValueOrDefault(), c.NhomChiPhiBangKe, c.TenDichVu, c.DonViTinh, c.DuocHuongBHYT, c.DonGiaBHYT, c.MucHuongBaoHiem, c.TiLeBaoHiemThanhToan }).OrderByDescending(o => o.Key.DuocHuongBHYT))
                        {
                            var chiphiBangKe = new BangKeKhamBenhBenhVienVo
                            {
                                Nhom = chiPhi.Key.NhomChiPhiBangKe,
                                Id = chiPhi.FirstOrDefault().Id,
                                NoiDung = chiPhi.Key.TenDichVu,
                                DonViTinh = chiPhi.Key.DonViTinh,
                                SoLuong = (decimal)chiPhi.Sum(c => c.Soluong),
                                DuocHuongBaoHiem = chiPhi.Key.DuocHuongBHYT,
                                DonGiaBH = chiPhi.Key.DuocHuongBHYT ? chiPhi.Key.DonGiaBHYT : 0,
                                MucHuongBaoHiem = chiPhi.Key.MucHuongBaoHiem,
                                TiLeThanhToanTheoDV = chiPhi.Key.TiLeBaoHiemThanhToan,
                                BaoHiemChiTra = true,
                                DonGiaBV = chiPhi.Key.DonGia
                            };
                            if (chiPhi.Key.KhongTinhPhi == true)
                            {
                                chiphiBangKe.Khac = chiPhi.Key.MucHuongBaoHiem > 0
                                    ? (chiphiBangKe.ThanhTienBV.GetValueOrDefault() - chiphiBangKe.ThanhTienBH.GetValueOrDefault())
                                    : chiphiBangKe.ThanhTienBV.GetValueOrDefault();
                            }
                            else
                            {
                                chiphiBangKe.Khac = chiPhi.Sum(c => c.SoTienMG);
                            }
                            dsChiPhiBangKe.Add(chiphiBangKe);
                        }

                        foreach (var chiPhi in chiPhis.Where(c => !(c.NhomChiPhiBangKe != NhomChiPhiBangKe.GoiVatTu && c.YeuCauGoiDichVuId == null)))
                        {
                            var chiphiBangKe = new BangKeKhamBenhBenhVienVo
                            {
                                Nhom = chiPhi.NhomChiPhiBangKe,
                                Id = chiPhi.Id,
                                NoiDung = chiPhi.TenDichVu,
                                DonViTinh = chiPhi.DonViTinh,
                                SoLuong = (decimal)chiPhi.Soluong,
                                DuocHuongBaoHiem = chiPhi.DuocHuongBHYT,
                                DonGiaBH = chiPhi.DuocHuongBHYT ? chiPhi.DonGiaBHYT : 0,
                                MucHuongBaoHiem = chiPhi.MucHuongBaoHiem,
                                TiLeThanhToanTheoDV = chiPhi.TiLeBaoHiemThanhToan,
                                BaoHiemChiTra = true,
                                DonGiaBV = chiPhi.DonGia
                            };
                            if (chiPhi.KhongTinhPhi == true || chiPhi.YeuCauGoiDichVuId != null)
                            {
                                chiphiBangKe.Khac = chiPhi.MucHuongBaoHiem > 0
                                    ? (chiphiBangKe.ThanhTienBV.GetValueOrDefault() - chiphiBangKe.ThanhTienBH.GetValueOrDefault())
                                    : chiphiBangKe.ThanhTienBV.GetValueOrDefault();
                            }
                            else
                            {
                                chiphiBangKe.Khac = chiPhi.SoTienMG;
                            }
                            dsChiPhiBangKe.Add(chiphiBangKe);
                        }

                        //Update BACHA-458
                        //Trường hợp NB có miễn giảm 100% tiền giường chỉ hiển thị tại cột khác
                        //Riêng cột NB cùng chi trả và NB tự trả là 0đ
                        //foreach (var chiphi in dsChiPhiBangKe.Where(o => o.Nhom == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay ||
                        //                                                 o.Nhom == NhomChiPhiBangKe.NgayGiuongDieuTriNoiTru))
                        //{
                        //    if (chiphi.QuyBHYT > 0 && chiphi.Khac.GetValueOrDefault().SoTienTuongDuong(chiphi.ThanhTienBV.GetValueOrDefault() - chiphi.QuyBHYT))
                        //    {
                        //        chiphi.Khac = chiphi.ThanhTienBV;
                        //    }
                        //}

                        var groupChiPhiBangKes = dsChiPhiBangKe.GroupBy(x => x.Nhom).OrderBy(o => (int)o.Key * (o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay || o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriNoiTru ? 1 : 10));
                        if (!groupChiPhiBangKes.Any())
                        {
                            return null;
                        }
                        foreach (var groupChiPhiBangKe in groupChiPhiBangKes)
                        {
                            if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay)
                            {

                                worksheet.Cells["A" + index + ":N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["A" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                worksheet.Cells["A" + index + ":N" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                worksheet.Cells["A" + index + ":N" + index].Merge = true;
                                worksheet.Cells["A" + index + ":N" + index].Value = "2. Ngày giường:";
                                worksheet.Cells["A" + index + ":N" + index].Style.Font.Bold = true;

                                index++;

                                worksheet.Cells["A" + index + ":G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["A" + index + ":G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                worksheet.Cells["A" + index + ":G" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                worksheet.Cells["A" + index + ":G" + index].Merge = true;
                                worksheet.Cells["A" + index + ":G" + index].Value = "2.1." + groupChiPhiBangKe.Key.GetDescription();
                                worksheet.Cells["A" + index + ":G" + index].Style.Font.Bold = true;

                                worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["H" + index].Style.Font.Bold = true;
                                worksheet.Cells["H" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBV);

                                worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["J" + index].Style.Font.Bold = true;
                                worksheet.Cells["J" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBH);

                                worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["K" + index].Style.Font.Bold = true;
                                worksheet.Cells["K" + index].Value = groupChiPhiBangKe.Sum(o => o.QuyBHYT);

                                worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["L" + index].Style.Font.Bold = true;
                                worksheet.Cells["L" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra);

                                worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["M" + index].Style.Font.Bold = true;
                                worksheet.Cells["M" + index].Value = groupChiPhiBangKe.Sum(o => o.Khac);

                                worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["N" + index].Style.Font.Bold = true;
                                worksheet.Cells["N" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra);

                                index++;
                            }
                            else if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.NgayGiuongDieuTriNoiTru)
                            {
                                if (!groupChiPhiBangKes.Any(o => o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay))
                                {
                                    worksheet.Cells["A" + index + ":N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["A" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                    worksheet.Cells["A" + index + ":N" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                    worksheet.Cells["A" + index + ":N" + index].Merge = true;
                                    worksheet.Cells["A" + index + ":N" + index].Value = "2. Ngày giường:";
                                    worksheet.Cells["A" + index + ":N" + index].Style.Font.Bold = true;

                                }
                                index++;
                                worksheet.Cells["A" + index + ":G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["A" + index + ":G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                worksheet.Cells["A" + index + ":G" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                worksheet.Cells["A" + index + ":G" + index].Merge = true;
                                worksheet.Cells["A" + index + ":G" + index].Value = "2.2." + groupChiPhiBangKe.Key.GetDescription();
                                worksheet.Cells["A" + index + ":G" + index].Style.Font.Bold = true;

                                worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["H" + index].Style.Font.Bold = true;
                                worksheet.Cells["H" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBV);

                                worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["J" + index].Style.Font.Bold = true;
                                worksheet.Cells["J" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBH);

                                worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["K" + index].Style.Font.Bold = true;
                                worksheet.Cells["K" + index].Value = groupChiPhiBangKe.Sum(o => o.QuyBHYT);

                                worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["L" + index].Style.Font.Bold = true;
                                worksheet.Cells["L" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra);

                                worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["M" + index].Style.Font.Bold = true;
                                worksheet.Cells["M" + index].Value = groupChiPhiBangKe.Sum(o => o.Khac);

                                worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["N" + index].Style.Font.Bold = true;
                                worksheet.Cells["N" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra);

                                index++;
                            }
                            else
                            {
                                worksheet.Cells["A" + index + ":G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["A" + index + ":G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                worksheet.Cells["A" + index + ":G" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                worksheet.Cells["A" + index + ":G" + index].Merge = true;
                                worksheet.Cells["A" + index + ":G" + index].Value = (int)groupChiPhiBangKe.Key + "." + groupChiPhiBangKe.Key.GetDescription();
                                worksheet.Cells["A" + index + ":G" + index].Style.Font.Bold = true;

                                worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["H" + index].Style.Font.Bold = true;
                                worksheet.Cells["H" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBV);

                                worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["J" + index].Style.Font.Bold = true;
                                worksheet.Cells["J" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBH);

                                worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["K" + index].Style.Font.Bold = true;
                                worksheet.Cells["K" + index].Value = groupChiPhiBangKe.Sum(o => o.QuyBHYT);

                                worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["L" + index].Style.Font.Bold = true;
                                worksheet.Cells["L" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra);

                                worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["M" + index].Style.Font.Bold = true;
                                worksheet.Cells["M" + index].Value = groupChiPhiBangKe.Sum(o => o.Khac);

                                worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["N" + index].Style.Font.Bold = true;
                                worksheet.Cells["N" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra);

                                index++;
                            }
                            if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.GoiVatTu)
                            {
                                var groupGoiVatTus = groupChiPhiBangKe.ToList().GroupBy(o => o.SoGoiVatTu.GetValueOrDefault()).OrderBy(o => o.Key);
                                int sttGoiVatTu = 1;
                                foreach (var groupGoiVatTu in groupGoiVatTus)
                                {
                                    worksheet.Cells["A" + index + ":G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["A" + index + ":G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                    worksheet.Cells["A" + index + ":G" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                    worksheet.Cells["A" + index + ":G" + index].Value = "10." + sttGoiVatTu + ". " + groupChiPhiBangKe.Key.GetDescription() + " " + sttGoiVatTu;
                                    worksheet.Cells["A" + index + ":G" + index].Style.Font.Bold = true;
                                    worksheet.Cells["A" + index + ":G" + index].Merge = true;

                                    worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["H" + index].Style.Font.Bold = true;
                                    worksheet.Cells["H" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBV);

                                    worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["J" + index].Style.Font.Bold = true;
                                    worksheet.Cells["J" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBH);

                                    worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["K" + index].Style.Font.Bold = true;
                                    worksheet.Cells["K" + index].Value = groupChiPhiBangKe.Sum(o => o.QuyBHYT);

                                    worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["L" + index].Style.Font.Bold = true;
                                    worksheet.Cells["L" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra);

                                    worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["M" + index].Style.Font.Bold = true;
                                    worksheet.Cells["M" + index].Value = groupChiPhiBangKe.Sum(o => o.Khac);

                                    worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["N" + index].Style.Font.Bold = true;
                                    worksheet.Cells["N" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra);

                                    index++;
                                    foreach (var chiPhiBangKe in groupGoiVatTu)
                                    {
                                        worksheet.Cells["A" + index + ":N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["A" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                        worksheet.Cells["A" + index + ":N" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));

                                        worksheet.Cells["A" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["A" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                        worksheet.Cells["A" + index].Value = indexItem;

                                        worksheet.Cells["B" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["B" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                        worksheet.Cells["B" + index].Value = chiPhiBangKe.NoiDung;

                                        worksheet.Cells["C" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["C" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                        worksheet.Cells["C" + index].Value = chiPhiBangKe.DonViTinh;

                                        worksheet.Cells["D" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["D" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                        worksheet.Cells["D" + index].Value = chiPhiBangKe.SoLuong;

                                        worksheet.Cells["E" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["E" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["E" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["E" + index].Value = chiPhiBangKe.DonGiaBV;

                                        worksheet.Cells["F" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["F" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["F" + index].Value = chiPhiBangKe.DonGiaBH;

                                        worksheet.Cells["G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["G" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["G" + index].Value = chiPhiBangKe.TiLeThanhToanTheoDV;

                                        worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["H" + index].Value = chiPhiBangKe.ThanhTienBV;

                                        worksheet.Cells["I" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["I" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["I" + index].Value = Convert.ToDouble(chiPhiBangKe.MucHuongBaoHiem > 0 ? 100 : 0).ApplyFormatMoneyToDouble();


                                        worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["J" + index].Value = chiPhiBangKe.ThanhTienBH;


                                        worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["K" + index].Value = chiPhiBangKe.QuyBHYT;


                                        worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["L" + index].Value = chiPhiBangKe.NguoiBenhCungChiTra;


                                        worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["M" + index].Value = chiPhiBangKe.Khac;


                                        worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["N" + index].Value = chiPhiBangKe.NguoiBenhTuTra;

                                        indexItem++;
                                        index++;
                                    }
                                }
                            }
                            else
                            {

                                foreach (var chiPhiBangKe in groupChiPhiBangKe)
                                {
                                    worksheet.Cells["A" + index + ":N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["A" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                    worksheet.Cells["A" + index + ":N" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));

                                    worksheet.Cells["A" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["A" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                    worksheet.Cells["A" + index].Value = indexItem;

                                    worksheet.Cells["B" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["B" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                    worksheet.Cells["B" + index].Value = chiPhiBangKe.NoiDung;

                                    worksheet.Cells["C" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["C" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                    worksheet.Cells["C" + index].Value = chiPhiBangKe.DonViTinh;

                                    worksheet.Cells["D" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["D" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                    worksheet.Cells["D" + index].Value = chiPhiBangKe.SoLuong;

                                    worksheet.Cells["E" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["E" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["E" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["E" + index].Value = chiPhiBangKe.DonGiaBV;

                                    worksheet.Cells["F" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["F" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["F" + index].Value = chiPhiBangKe.DonGiaBH;

                                    worksheet.Cells["G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["G" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["G" + index].Value = chiPhiBangKe.TiLeThanhToanTheoDV;

                                    worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["H" + index].Value = chiPhiBangKe.ThanhTienBV;

                                    worksheet.Cells["I" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["I" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["I" + index].Value = Convert.ToDouble(chiPhiBangKe.MucHuongBaoHiem > 0 ? 100 : 0).ApplyFormatMoneyToDouble();


                                    worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["J" + index].Value = chiPhiBangKe.ThanhTienBH;


                                    worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["K" + index].Value = chiPhiBangKe.QuyBHYT;


                                    worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["L" + index].Value = chiPhiBangKe.NguoiBenhCungChiTra;


                                    worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["M" + index].Value = chiPhiBangKe.Khac;


                                    worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["N" + index].Value = chiPhiBangKe.NguoiBenhTuTra;

                                    indexItem++;
                                    index++;
                                }
                            }

                        }


                        worksheet.Cells["A" + index + ":G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        worksheet.Cells["A" + index + ":G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        worksheet.Cells["A" + index + ":G" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                        worksheet.Cells["A" + index + ":G" + index].Merge = true;
                        worksheet.Cells["A" + index + ":G" + index].Value = "Tổng cộng";
                        worksheet.Cells["A" + index + ":G" + index].Style.Font.Bold = true;

                        worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                        worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                        worksheet.Cells["H" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.ThanhTienBV)).Sum();


                        worksheet.Cells["I" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        worksheet.Cells["I" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;

                        worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                        worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                        worksheet.Cells["J" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.ThanhTienBH)).Sum();

                        worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                        worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                        worksheet.Cells["K" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.QuyBHYT)).Sum();

                        worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                        worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                        worksheet.Cells["L" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.NguoiBenhCungChiTra)).Sum();

                        worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                        worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                        worksheet.Cells["M" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.Khac)).Sum();

                        worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                        worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                        worksheet.Cells["N" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.NguoiBenhTuTra)).Sum();

                        index++;

                        worksheet.Cells["A" + index + ":N" + index].Merge = true;
                        worksheet.Cells["A" + index + ":N" + index].Value = "Tổng chi phí lần khám bệnh/cả đợt điều trị: " + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + " đồng";
                        worksheet.Cells["A" + index + ":N" + index].Style.Font.Bold = true;

                        index++;

                        worksheet.Cells["A" + index + ":N" + index].Merge = true;
                        worksheet.Cells["A" + index + ":N" + index].Value = "(Viết bằng chữ: " + NumberHelper.ChuyenSoRaText(Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBV))) + ")";

                        index++;

                        worksheet.Cells["A" + index + ":N" + index].Merge = true;
                        worksheet.Cells["A" + index + ":N" + index].Value = "Trong đó , số tiền do:";
                        worksheet.Cells["A" + index + ":N" + index].Style.Font.Bold = true;

                        index++;
                        worksheet.Cells["A" + index + ":N" + index].Merge = true;
                        worksheet.Cells["A" + index + ":N" + index].Value = "- Quỹ BHYT thanh toán: " + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble();

                        var tongBHTN = Convert.ToDouble(danhSachTatCaChiPhi.Where(o => o.TrangThaiThanhToan != Enums.TrangThaiThanhToan.DaThanhToan).Sum(o => o.TongCongNo));
                        if (tongBHTN != 0)
                        {
                            index++;
                            worksheet.Cells["A" + index + ":N" + index].Merge = true;
                            worksheet.Cells["A" + index + ":N" + index].Value = "- BHTN bảo lãnh: " + Convert.ToDouble(tongBHTN).ApplyFormatMoneyToDouble();
                        }

                        index++;
                        var tongTamUng = GetSoTienDaTamUngAsync(yeuCauTiepNhanId).Result;
                        worksheet.Cells["A" + index + ":N" + index].Merge = true;
                        worksheet.Cells["A" + index + ":N" + index].Value = "- Tổng tạm ứng: " + Convert.ToDouble(tongTamUng).ApplyFormatMoneyToDouble();


                        index++;
                        worksheet.Cells["A" + index + ":N" + index].Merge = true;
                        worksheet.Cells["A" + index + ":N" + index].Value = "+ Nguồn khác: " + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble(true);

                       
                        var tongQuyBHYTThanhToan = Convert.ToDouble(danhSachTatCaChiPhi.Where(o => o.TrangThaiThanhToan != TrangThaiThanhToan.DaThanhToan && o.KiemTraBHYTXacNhan).Sum(o => o.BHYTThanhToan));
                        var soTienCanThu = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBV)) - Convert.ToDouble(tongTamUng) - tongQuyBHYTThanhToan - tongBHTN - Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.Khac));
                        string soTienNBTuTraHoacTraLaiBN = soTienCanThu < 0 ? $"- Phải trả lại NB: {(soTienCanThu * (-1)).ApplyFormatMoneyToDouble()}" : $"- Người bệnh tự trả: {(soTienCanThu).ApplyFormatMoneyToDouble()}";

                        index++;

                        worksheet.Cells["A" + index + ":N" + index].Merge = true;
                        worksheet.Cells["A" + index + ":N" + index].Value = soTienNBTuTraHoacTraLaiBN;


                        index = index + 2;

                        worksheet.Cells["G" + index + ":N" + index].Style.Font.Bold = true;
                        worksheet.Cells["G" + index + ":N" + index].Merge = true;
                        worksheet.Cells["G" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        worksheet.Cells["G" + index + ":N" + index].Value = "XÁC NHẬN CỦA NGƯỜI BỆNH ";

                        index++;

                        worksheet.Cells["A" + index + ":F" + index].Style.Font.Bold = true;
                        worksheet.Cells["A" + index + ":F" + index].Merge = true;
                        worksheet.Cells["A" + index + ":F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        worksheet.Cells["A" + index + ":F" + index].Value = "NGƯỜI LẬP BẢNG KÊ";


                        worksheet.Cells["G" + index + ":N" + index].Style.Font.Bold = true;
                        worksheet.Cells["G" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        worksheet.Cells["G" + index + ":N" + index].Merge = true;
                        worksheet.Cells["G" + index + ":N" + index].Value = "(Ký , Ghi rõ họ tên)";

                        index++;

                        worksheet.Cells["A" + index + ":F" + index].Style.Font.Bold = true;
                        worksheet.Cells["A" + index + ":F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        worksheet.Cells["A" + index + ":F" + index].Merge = true;
                        worksheet.Cells["A" + index + ":F" + index].Value = "(Ký , Ghi rõ họ tên)";


                        worksheet.Cells["G" + index + ":N" + index].Style.Font.Bold = true;
                        worksheet.Cells["G" + index + ":N" + index].Merge = true;
                        worksheet.Cells["G" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        worksheet.Cells["G" + index + ":N" + index].Value = "(Tôi đã nhận...phim...Xquang / CT / MRI)";

                        //xlPackage.Save();

                    }


                    if (danhSachTatCaChiPhi != null && danhSachTatCaChiPhi.Any(o => o.YeuCauGoiDichVuId != null))
                    {
                        var worksheetNgoaiGoi = xlPackage.Workbook.Worksheets.Add("BẢNG KÊ CHI PHÍ NGOÀI GÓI");
                        LoadBangKeNgoaiGoiChuaQuyetToan(worksheetNgoaiGoi, yeuCauTiepNhan, danhSachTatCaChiPhi.ToList());
                    }
                    xlPackage.Save();
                }

                return stream.ToArray();
            }
        }

        public byte[] XuatBangKeNoiTruChoThuTrongGoi(QuyetToanDichVuTrongGoiVo model)
        {
            var yeuCauTiepNhanId = model.Id;
            var danhSachTatCaChiPhi = GetTatCaDichVuKhamChuaBenh(yeuCauTiepNhanId).Result.Where(o => !o.Soluong.AlmostEqual(0));
            //chỉ lấy những dịch vụ chưa thu tiền
            var danhSachChiPhi = danhSachTatCaChiPhi.Where(o => o.YeuCauGoiDichVuId != null && o.TrangThaiThanhToan != TrangThaiThanhToan.DaThanhToan).ToList();


            var yeuCauTiepNhan = BaseRepository.GetById(yeuCauTiepNhanId,
                x => x.Include(o => o.NoiTruBenhAn).ThenInclude(o => o.ChuyenDenBenhVien)
                    .Include(o => o.NoiTruBenhAn).ThenInclude(o => o.KhoaPhongNhapVien)
                    .Include(o => o.NoiTruBenhAn).ThenInclude(o => o.ChanDoanChinhRaVienICD)
                    .Include(o => o.YeuCauTiepNhanTheBHYTs)
                    .Include(o => o.YeuCauNhapVien).ThenInclude(o => o.YeuCauKhamBenh).ThenInclude(o => o.YeuCauTiepNhan)
                    .Include(o => o.BenhNhan)
                    .Include(o => o.PhuongXa)
                    .Include(o => o.QuanHuyen)
                    .Include(o => o.TinhThanh)
                    .Include(o => o.NoiTruBenhAn).ThenInclude(o => o.NoiTruPhieuDieuTris).ThenInclude(o => o.NoiTruThamKhamChanDoanKemTheos).ThenInclude(c => c.ICD)
                    .Include(o => o.NoiTruBenhAn).ThenInclude(o => o.NoiTruPhieuDieuTris).ThenInclude(c => c.ChanDoanChinhICD)
                    .Include(o => o.NoiChuyen).Include(o => o.NoiTruBenhAn).ThenInclude(o => o.NoiTruKhoaPhongDieuTris).ThenInclude(c => c.KhoaPhongChuyenDen));

           
            var benhVien = new Core.Domain.Entities.BenhVien.BenhVien();

            string maBHYT = string.Empty;
            string bHYTTuNgay = string.Empty;
            string bHYTDenNgay = string.Empty;
            string mucHuong = string.Empty;
            string NoiDKKCBBanDau = string.Empty;
            string MaKCBBanDau = string.Empty;


            string maICDKemTheo = string.Empty;
            string tenICDKemTheo = string.Empty;

            string chuanDoanXacDinhSanKhoa = string.Empty;
            string maICD10 = string.Empty;

            if (yeuCauTiepNhan.NoiTruBenhAn != null && (yeuCauTiepNhan.NoiTruBenhAn.LoaiBenhAn == LoaiBenhAn.SanKhoaMo || yeuCauTiepNhan.NoiTruBenhAn.LoaiBenhAn == LoaiBenhAn.SanKhoaThuong))
            {
                if (yeuCauTiepNhan.NoiTruBenhAn?.NoiTruPhieuDieuTris.Count() > 0)
                {
                    var phieuDieuTri = yeuCauTiepNhan.NoiTruBenhAn?.NoiTruPhieuDieuTris.OrderByDescending(c => c.NgayDieuTri).FirstOrDefault();

                    var icdKemTheoIds = phieuDieuTri.NoiTruThamKhamChanDoanKemTheos.Select(c => c.ICD.Ma);
                    var tenICDKemTheos = phieuDieuTri.NoiTruThamKhamChanDoanKemTheos.Select(c => c.GhiChu);

                    maICDKemTheo = string.Join(", ", icdKemTheoIds);
                    tenICDKemTheo = string.Join(", ", tenICDKemTheos);

                    maICD10 = phieuDieuTri.ChanDoanChinhICD?.Ma;
                    chuanDoanXacDinhSanKhoa = phieuDieuTri.ChanDoanChinhGhiChu;
                }
            }
            else
            {
                if (!string.IsNullOrEmpty(yeuCauTiepNhan.NoiTruBenhAn?.DanhSachChanDoanKemTheoRaVienICDId))
                {
                    var maICDKemTheos = new List<string>();

                    var icdKemTheoIds = yeuCauTiepNhan.NoiTruBenhAn?.DanhSachChanDoanKemTheoRaVienICDId.Split(Constants.ICDSeparator);
                    var tenICDKemTheos = yeuCauTiepNhan.NoiTruBenhAn?.DanhSachChanDoanKemTheoRaVienGhiChu?.Split(Constants.ICDSeparator);

                    if (icdKemTheoIds.Length > 0)
                    {
                        foreach (var icdKemTheoId in icdKemTheoIds)
                        {
                            var icdKemTheo = _icdRepository.TableNoTracking.FirstOrDefault(o => o.Id == long.Parse(icdKemTheoId));
                            if (icdKemTheo != null)
                            {
                                maICDKemTheos.Add(icdKemTheo.Ma);
                            }

                            //if (long.TryParse(yeuCauTiepNhan.NoiTruBenhAn?.DanhSachChanDoanKemTheoRaVienICDId.Split(Constants.ICDSeparator).First(), out var icdKemTheoId))
                            //{
                            //    var icdKemTheo = _icdRepository.TableNoTracking.FirstOrDefault(o => o.Id == icdKemTheoId);
                            //    if (icdKemTheo != null)
                            //    {
                            //        maICDKemTheo = icdKemTheo.Ma;
                            //        tenICDKemTheo = yeuCauTiepNhan.NoiTruBenhAn?.DanhSachChanDoanKemTheoRaVienGhiChu?.Split(Constants.ICDSeparator).First();
                            //    }
                            //}
                        }
                    }

                    maICDKemTheo = string.Join(", ", maICDKemTheos);
                    tenICDKemTheo = string.Join(", ", tenICDKemTheos);
                }
            }

            YeuCauTiepNhanTheBHYT theBHYT = null;
            if (yeuCauTiepNhan.CoBHYT == true && yeuCauTiepNhan.YeuCauTiepNhanTheBHYTs.Any())
            {
                theBHYT = yeuCauTiepNhan.YeuCauTiepNhanTheBHYTs.First();
                if (!String.IsNullOrEmpty(theBHYT.MaDKBD))
                {
                    benhVien = _benhVienRepository.TableNoTracking.FirstOrDefault(p => p.Ma.Equals(theBHYT.MaDKBD));
                }
                maBHYT = theBHYT.MaSoThe;
                bHYTTuNgay = theBHYT.NgayHieuLuc.ApplyFormatDate();
                bHYTDenNgay = theBHYT.NgayHetHan?.ApplyFormatDate();
                mucHuong = theBHYT.MucHuong.ToString() + "%";
                NoiDKKCBBanDau = benhVien != null ? benhVien?.Ten : "Chưa xác định";
                MaKCBBanDau = theBHYT.MaDKBD;
            }
            else
            {
                maBHYT = "";
                bHYTTuNgay = "";
                bHYTDenNgay = "";
                mucHuong = "0%";
                NoiDKKCBBanDau = "Chưa xác định";
                MaKCBBanDau = "Chưa xác định";
            }

            var dsChiPhiBangKe = new List<BangKeKhamBenhBenhVienVo>();
            var dateItemChiPhis = string.Empty;
            int indexItem = 1;

            using (var stream = new MemoryStream())
            {
                using (var xlPackage = new ExcelPackage(stream))
                {

                    var worksheet = xlPackage.Workbook.Worksheets.Add("BẢNG KÊ CHI PHÍ KHÁM CHỮA BỆNH CHỜ THU");

                    // set row
                    worksheet.Row(9).Height = 24.5;
                    worksheet.DefaultRowHeight = 16;

                    //SET chiều rộng cho từng cột tương ứng
                    worksheet.Column(1).Width = 10;
                    worksheet.Column(2).Width = 25;
                    worksheet.Column(3).Width = 15;
                    worksheet.Column(4).Width = 15;
                    worksheet.Column(5).Width = 15;
                    worksheet.Column(6).Width = 15;
                    worksheet.Column(7).Width = 15;
                    worksheet.Column(8).Width = 15;
                    worksheet.Column(9).Width = 15;
                    worksheet.Column(10).Width = 15;
                    worksheet.Column(11).Width = 15;
                    worksheet.Column(12).Width = 15;
                    worksheet.Column(13).Width = 15;
                    worksheet.Column(14).Width = 15;

                    worksheet.DefaultColWidth = 7;

                    using (var range = worksheet.Cells["A1:C1"])
                    {
                        range.Worksheet.Cells["A1:C1"].Merge = true;
                        range.Worksheet.Cells["A1:C1"].Value = "CƠ SỞ KHÁM CHỮA BỆNH : BỆNH VIỆN ĐKQT BẮC HÀ";
                        range.Worksheet.Cells["A1:C1"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A1:C1"].Style.VerticalAlignment = ExcelVerticalAlignment.Bottom;
                        range.Worksheet.Cells["A1:C1"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A1:C1"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["L1:N1"])
                    {
                        range.Worksheet.Cells["L1:N1"].Merge = true;
                        range.Worksheet.Cells["L1:N1"].Value = "Mẫu số : 01/KBCB ";
                        range.Worksheet.Cells["L1:N1"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                        range.Worksheet.Cells["L1:N1"].Style.VerticalAlignment = ExcelVerticalAlignment.Bottom;
                        range.Worksheet.Cells["L1:N1"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["L1:N1"].Style.Font.Color.SetColor(Color.Black);
                        range.Worksheet.Cells["L1:N1"].Style.Font.Bold = true;
                    }

                    using (var range = worksheet.Cells["L2:N2"])
                    {
                        range.Worksheet.Cells["L2:N2"].Merge = true;
                        range.Worksheet.Cells["L2:N2"].Value = "Mã số người bệnh: " + yeuCauTiepNhan.BenhNhan.MaBN;
                        range.Worksheet.Cells["L2:N2"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                        range.Worksheet.Cells["L2:N2"].Style.VerticalAlignment = ExcelVerticalAlignment.Bottom;
                        range.Worksheet.Cells["L2:N2"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["L2:N2"].Style.Font.Color.SetColor(Color.Black);
                        range.Worksheet.Cells["L2:N2"].Style.Font.Bold = true;
                    }

                    using (var range = worksheet.Cells["L3:N3"])
                    {
                        range.Worksheet.Cells["L3:N3"].Merge = true;
                        range.Worksheet.Cells["L3:N3"].Value = "Số khám bệnh:" + yeuCauTiepNhan.MaYeuCauTiepNhan;
                        range.Worksheet.Cells["L3:N3"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                        range.Worksheet.Cells["L3:N3"].Style.VerticalAlignment = ExcelVerticalAlignment.Bottom;
                        range.Worksheet.Cells["L3:N3"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["L3:N3"].Style.Font.Color.SetColor(Color.Black);
                        range.Worksheet.Cells["L3:N3"].Style.Font.Bold = true;
                    }

                    using (var range = worksheet.Cells["A4:N5"])
                    {
                        range.Worksheet.Cells["A4:N5"].Merge = true;
                        range.Worksheet.Cells["A4:N5"].Value = "BẢNG KÊ CHI PHÍ KHÁM CHỮA BỆNH CHỜ THU";
                        range.Worksheet.Cells["A4:N5"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        range.Worksheet.Cells["A4:N5"].Style.VerticalAlignment = ExcelVerticalAlignment.Bottom;
                        range.Worksheet.Cells["A4:N5"].Style.Font.SetFromFont(new Font("Times New Roman", 18));
                        range.Worksheet.Cells["A4:N5"].Style.Font.Color.SetColor(Color.Black);
                        range.Worksheet.Cells["A4:N5"].Style.Font.Bold = true;
                    }

                    using (var range = worksheet.Cells["A6:N6"])
                    {
                        range.Worksheet.Cells["A6:N6"].Merge = true;
                        range.Worksheet.Cells["A6:N6"].Value = "I.Hành chính";
                        range.Worksheet.Cells["A6:N6"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A6:N6"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A6:N6"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A6:N6"].Style.Font.Color.SetColor(Color.Black);
                        range.Worksheet.Cells["A6:N6"].Style.Font.Bold = true;
                    }

                    using (var range = worksheet.Cells["A7:F7"])
                    {
                        range.Worksheet.Cells["A7:F7"].Merge = true;

                        range.Worksheet.Cells["A7:F7"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["A7:F7"].RichText.Add("(1) Họ tên người bệnh: ");
                        var value = range.Worksheet.Cells["A7:F7"].RichText.Add(yeuCauTiepNhan.HoTen);
                        value.Bold = true;

                        range.Worksheet.Cells["A7:F7"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A7:F7"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A7:F7"].Style.Font.SetFromFont(new Font("Times New Roman", 11));


                        range.Worksheet.Cells["A7:F7"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["G7:J7"])
                    {
                        range.Worksheet.Cells["G7:J7"].Merge = true;
                        range.Worksheet.Cells["G7:J7"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["G7:J7"].RichText.Add("Ngày,tháng,năm sinh: ");
                        var value = range.Worksheet.Cells["G7:J7"].RichText.Add(DateHelper.DOBFormat(yeuCauTiepNhan.NgaySinh, yeuCauTiepNhan.ThangSinh, yeuCauTiepNhan.NamSinh));
                        value.Bold = true;

                        range.Worksheet.Cells["G7:J7"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["G7:J7"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["G7:J7"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["G7:J7"].Style.Font.Color.SetColor(Color.Black);
                    }

                    var gioitinh = yeuCauTiepNhan.GioiTinh != null ? yeuCauTiepNhan.GioiTinh.GetDescription() : "";
                    using (var range = worksheet.Cells["K7:N7"])
                    {
                        range.Worksheet.Cells["K7:N7"].Merge = true;

                        range.Worksheet.Cells["K7:N7"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["K7:N7"].RichText.Add("Giới tính: ");
                        var value = range.Worksheet.Cells["K7:N7"].RichText.Add(gioitinh);
                        value.Bold = true;

                        range.Worksheet.Cells["K7:N7"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["K7:N7"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["K7:N7"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["K7:N7"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["A8:F8"])
                    {
                        range.Worksheet.Cells["A8:F8"].Merge = true;

                        range.Worksheet.Cells["A8:F8"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["A8:F8"].RichText.Add("(2)Địa chỉ hiện tại: ");
                        var value = range.Worksheet.Cells["A8:F8"].RichText.Add(yeuCauTiepNhan.DiaChiDayDu);
                        value.Bold = true;

                        range.Worksheet.Cells["A8:F8"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A8:F8"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A8:F8"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A8:F8"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["G8:J8"])
                    {
                        range.Worksheet.Cells["G8:J8"].Merge = true;

                        range.Worksheet.Cells["G8:J8"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["G8:J8"].RichText.Add("(3)Mã khu vực(K1/K2/K3): ");
                        var value = range.Worksheet.Cells["G8:J8"].RichText.Add(yeuCauTiepNhan.BHYTMaKhuVuc);
                        value.Bold = true;

                        range.Worksheet.Cells["G8:J8"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["G8:J8"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["G8:J8"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["G8:J8"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["A9:F9"])
                    {
                        range.Worksheet.Cells["A9:F9"].Merge = true;
                        range.Worksheet.Cells["A9:F9"].Style.WrapText = true;

                        var title = range.Worksheet.Cells["A9:F9"].RichText.Add("(4)Mã thẻ BHYT: ");
                        var value = range.Worksheet.Cells["A9:F9"].RichText.Add(maBHYT);
                        value.Bold = true;

                        range.Worksheet.Cells["A9:F9"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A9:F9"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A9:F9"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A9:F9"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["G9:J9"])
                    {
                        range.Worksheet.Cells["G9:J9"].Merge = true;
                        range.Worksheet.Cells["G9:J9"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["G9:J9"].RichText.Add("Giá trị từ: ");
                        var valuebHYTTuNgay = range.Worksheet.Cells["G9:J9"].RichText.Add(bHYTTuNgay);
                        valuebHYTTuNgay.Bold = true;

                        var den = range.Worksheet.Cells["G9:J9"].RichText.Add(" đến: ");
                        den.Bold = false;
                        var valuebHYTDenNgay = range.Worksheet.Cells["G9:J9"].RichText.Add(bHYTDenNgay);
                        valuebHYTDenNgay.Bold = true;


                        range.Worksheet.Cells["G9:J9"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["G9:J9"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["G9:J9"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["G9:J9"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["A10:F10"])
                    {
                        range.Worksheet.Cells["A10:F10"].Merge = true;

                        range.Worksheet.Cells["A10:F10"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["A10:F10"].RichText.Add("(5)Nơi ĐK KCB ban đầu: ");
                        var valueNoiDKKCBBanDau = range.Worksheet.Cells["A10:F10"].RichText.Add(NoiDKKCBBanDau);
                        valueNoiDKKCBBanDau.Bold = true;

                        range.Worksheet.Cells["A10:F10"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A10:F10"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A10:F10"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A10:F10"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["G10:J10"])
                    {
                        range.Worksheet.Cells["G10:J10"].Merge = true;
                        range.Worksheet.Cells["G10:J10"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["G10:J10"].RichText.Add("(6)Mã: ");
                        var valueMaKCBBanDau = range.Worksheet.Cells["G10:J10"].RichText.Add(MaKCBBanDau);
                        valueMaKCBBanDau.Bold = true;

                        range.Worksheet.Cells["G10:J10"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["G10:J10"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["G10:J10"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["G10:J10"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["A11:F11"])
                    {
                        range.Worksheet.Cells["A11:F11"].Merge = true;

                        range.Worksheet.Cells["A11:F11"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["A11:F11"].RichText.Add("(7)Đến Khám: ");
                        var value = range.Worksheet.Cells["A11:F11"].RichText.Add(yeuCauTiepNhan.ThoiDiemTiepNhan.ApplyFormatGioPhutNgay());
                        value.Bold = true;

                        range.Worksheet.Cells["A11:F11"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A11:F11"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A11:F11"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A11:F11"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["A12:F12"])
                    {
                        range.Worksheet.Cells["A12:F12"].Merge = true;

                        range.Worksheet.Cells["A12:F12"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["A12:F12"].RichText.Add("(8)Điều trị ngoại trú/nội trú từ: ");
                        var value = range.Worksheet.Cells["A12:F12"].RichText.Add(yeuCauTiepNhan.NoiTruBenhAn?.ThoiDiemNhapVien.ApplyFormatGioPhutNgay());
                        value.Bold = true;

                        range.Worksheet.Cells["A12:F12"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A12:F12"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A12:F12"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A12:F12"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["A13:F13"])
                    {
                        range.Worksheet.Cells["A13:F13"].Merge = true;
                        range.Worksheet.Cells["A13:F13"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["A13:F13"].RichText.Add("(9)Kết thúc khám/điều trị: ");
                        var value = range.Worksheet.Cells["A13:F13"].RichText.Add(yeuCauTiepNhan.NoiTruBenhAn?.ThoiDiemRaVien?.ApplyFormatGioPhutNgay());
                        value.Bold = true;


                        range.Worksheet.Cells["A13:F13"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A13:F13"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A13:F13"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A13:F13"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["G13:J13"])
                    {
                        range.Worksheet.Cells["G13:J13"].Merge = true;
                        range.Worksheet.Cells["G13:J13"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["G13:J13"].RichText.Add("Tổng số ngày điều trị: ");
                        var value = range.Worksheet.Cells["G13:J13"].RichText.Add(NoiTruBenhAnHelper.TinhSoNgayDieuTri(yeuCauTiepNhan.NoiTruBenhAn)?.ToString() ?? string.Empty);
                        value.Bold = true;

                        range.Worksheet.Cells["G13:J13"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["G13:J13"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["G13:J13"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["G13:J13"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["K13:N13"])
                    {
                        range.Worksheet.Cells["K13:N13"].Merge = true;

                        range.Worksheet.Cells["K13:N13"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["K13:N13"].RichText.Add("(10)Tình trạng ra viện: ");
                        var value = range.Worksheet.Cells["K13:N13"].RichText.Add((yeuCauTiepNhan.NoiTruBenhAn?.TinhTrangRaVien == EnumTinhTrangRaVien.RaVien && (yeuCauTiepNhan.NoiTruBenhAn?.KetQuaDieuTri == EnumKetQuaDieuTri.Do || yeuCauTiepNhan.NoiTruBenhAn?.KetQuaDieuTri == EnumKetQuaDieuTri.Khoi) ? 1 : 2).ToString());
                        value.Bold = true;


                        range.Worksheet.Cells["K13:N13"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["K13:N13"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["K13:N13"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["K13:N13"].Style.Font.Color.SetColor(Color.Black);
                    }

                    //=================================14=================================
                    var coCapCuu = yeuCauTiepNhan.LyDoVaoVien == Enums.EnumLyDoVaoVien.CapCuu ? "X" : string.Empty;
                    var coDungTuyen = yeuCauTiepNhan.LyDoVaoVien == Enums.EnumLyDoVaoVien.DungTuyen ? "X" : string.Empty;
                    var coThongTuyen = yeuCauTiepNhan.LyDoVaoVien == Enums.EnumLyDoVaoVien.ThongTuyen ? "X" : string.Empty;
                    var coTraiTuyen = yeuCauTiepNhan.LyDoVaoVien == Enums.EnumLyDoVaoVien.TraiTuyen ? "X" : string.Empty;

                    using (var range = worksheet.Cells["A14:C14"])
                    {
                        range.Worksheet.Cells["A14:C14"].Merge = true;

                        range.Worksheet.Cells["A14:C14"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["A14:C14"].RichText.Add("(11) Cấp cứu: ");
                        var value = range.Worksheet.Cells["A14:C14"].RichText.Add(coCapCuu);
                        value.Bold = true;

                        range.Worksheet.Cells["A14:C14"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A14:C14"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A14:C14"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A14:C14"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["D14:F14"])
                    {
                        range.Worksheet.Cells["D14:F14"].Merge = true;
                        range.Worksheet.Cells["D14:F14"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["D14:F14"].RichText.Add("(12) Đúng tuyến: ");
                        var value = range.Worksheet.Cells["D14:F14"].RichText.Add(coDungTuyen);
                        value.Bold = true;

                        range.Worksheet.Cells["D14:F14"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["D14:F14"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["D14:F14"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["D14:F14"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["G14:J14"])
                    {
                        range.Worksheet.Cells["G14:J14"].Merge = true;
                        range.Worksheet.Cells["G14:J14"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["G14:J14"].RichText.Add("Nơi chuyến đến: ");
                        var value = range.Worksheet.Cells["G14:J14"].RichText.Add(yeuCauTiepNhan.NoiChuyen?.Ten);
                        value.Bold = true;
                        range.Worksheet.Cells["G14:J14"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["G14:J14"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["G14:J14"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["G14:J14"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["K14:N14"])
                    {
                        range.Worksheet.Cells["K14:N14"].Merge = true;
                        range.Worksheet.Cells["K14:N14"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["K14:N14"].RichText.Add("Nơi chuyển đi: ");
                        var value = range.Worksheet.Cells["K14:N14"].RichText.Add(yeuCauTiepNhan.NoiTruBenhAn?.ChuyenDenBenhVien?.Ten);
                        value.Bold = true;
                        range.Worksheet.Cells["K14:N14"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["K14:N14"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["K14:N14"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["K14:N14"].Style.Font.Color.SetColor(Color.Black);
                    }

                    //=================================15=================================
                    using (var range = worksheet.Cells["A15:C15"])
                    {
                        range.Worksheet.Cells["A15:C15"].Merge = true;
                        range.Worksheet.Cells["A15:C15"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["A15:C15"].RichText.Add("(13)Thông tuyến: ");
                        var value = range.Worksheet.Cells["A15:C15"].RichText.Add(coThongTuyen);
                        value.Bold = true;
                        range.Worksheet.Cells["A15:C15"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A15:C15"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A15:C15"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A15:C15"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["D15:F15"])
                    {
                        range.Worksheet.Cells["D15:F15"].Merge = true;
                        range.Worksheet.Cells["D15:F15"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["D15:F15"].RichText.Add("(14)Trái tuyến: ");
                        var value = range.Worksheet.Cells["D15:F15"].RichText.Add(coTraiTuyen);
                        value.Bold = true;

                        range.Worksheet.Cells["D15:F15"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["D15:F15"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["D15:F15"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["D15:F15"].Style.Font.Color.SetColor(Color.Black);
                    }


                    //================================= 16 =================================

                    var chuanDoanXacDinhStr = yeuCauTiepNhan.NoiTruBenhAn?.LoaiBenhAn == LoaiBenhAn.SanKhoaMo || yeuCauTiepNhan.NoiTruBenhAn?.LoaiBenhAn == LoaiBenhAn.SanKhoaThuong
                                                            ? chuanDoanXacDinhSanKhoa : yeuCauTiepNhan.NoiTruBenhAn?.ChanDoanChinhRaVienGhiChu;


                    var iCD10 = yeuCauTiepNhan.NoiTruBenhAn?.LoaiBenhAn == LoaiBenhAn.SanKhoaMo || yeuCauTiepNhan.NoiTruBenhAn?.LoaiBenhAn == LoaiBenhAn.SanKhoaThuong
                                                               ? maICD10 : yeuCauTiepNhan.NoiTruBenhAn?.ChanDoanChinhRaVienICD?.Ma;


                    using (var range = worksheet.Cells["A16:F16"])
                    {
                        range.Worksheet.Cells["A16:F16"].Merge = true;
                        range.Worksheet.Cells["A16:F16"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["A16:F16"].RichText.Add("(15)Chẩn đoán xác định: ");
                        var value = range.Worksheet.Cells["A16:F16"].RichText.Add(chuanDoanXacDinhStr);
                        value.Bold = true;

                        range.Worksheet.Cells["A16:F16"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A16:F16"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A16:F16"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A16:F16"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["G16:N16"])
                    {
                        range.Worksheet.Cells["G16:N16"].Merge = true;

                        range.Worksheet.Cells["G16:N16"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["G16:N16"].RichText.Add("(16) Mã bệnh: ");
                        var value = range.Worksheet.Cells["G16:N16"].RichText.Add(iCD10);
                        value.Bold = true;


                        range.Worksheet.Cells["G16:N16"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["G16:N16"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["G16:N16"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["G16:N16"].Style.Font.Color.SetColor(Color.Black);
                    }

                    //================================= 17 =================================

                    using (var range = worksheet.Cells["A17:F17"])
                    {
                        range.Worksheet.Cells["A17:F17"].Merge = true;
                        range.Worksheet.Cells["A17:F17"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["A17:F17"].RichText.Add("(17)Bệnh kèm theo: ");
                        var value = range.Worksheet.Cells["A17:F17"].RichText.Add(tenICDKemTheo);
                        value.Bold = true;


                        range.Worksheet.Cells["A17:F17"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A17:F17"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A17:F17"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A17:F17"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["G17:N17"])
                    {
                        range.Worksheet.Cells["G17:N17"].Merge = true;
                        range.Worksheet.Cells["G17:N17"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["G17:N17"].RichText.Add("(18)Mã bệnh kèm theo: ");
                        var value = range.Worksheet.Cells["G17:N17"].RichText.Add(maICDKemTheo);
                        value.Bold = true;


                        range.Worksheet.Cells["G17:N17"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["G17:N17"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["G17:N17"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["G17:N17"].Style.Font.Color.SetColor(Color.Black);
                    }

                    //================================= 18 =================================

                    using (var range = worksheet.Cells["A18:F18"])
                    {
                        range.Worksheet.Cells["A18:F18"].Merge = true;
                        range.Worksheet.Cells["A18:F18"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["A18:F18"].RichText.Add("(19)Thời điểm đủ 05 năm liên tục từ ngày: ");
                        var value = range.Worksheet.Cells["A18:F18"].RichText.Add(yeuCauTiepNhan.BHYTNgayDu5Nam?.ApplyFormatDate());
                        value.Bold = true;


                        range.Worksheet.Cells["A18:F18"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A18:F18"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A18:F18"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A18:F18"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["G18:N18"])
                    {
                        range.Worksheet.Cells["G18:N18"].Merge = true;
                        range.Worksheet.Cells["G18:N18"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["G18:N18"].RichText.Add("(21)Miễn cùng chi trả trong năm từ ngày: ");
                        var value = range.Worksheet.Cells["G18:N18"].RichText.Add(yeuCauTiepNhan.BHYTNgayDuocMienCungChiTra?.ApplyFormatDate());
                        value.Bold = true;

                        range.Worksheet.Cells["G18:N18"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["G18:N18"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["G18:N18"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["G18:N18"].Style.Font.Color.SetColor(Color.Black);
                    }

                    //================================= 19 =================================

                    using (var range = worksheet.Cells["A19:N19"])
                    {
                        range.Worksheet.Cells["A19:N19"].Merge = true;
                        range.Worksheet.Cells["A19:N19"].Value = "II. Phần Chi phí khám bệnh, chữa bệnh";
                        range.Worksheet.Cells["A19:N19"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A19:N19"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A19:N19"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A19:N19"].Style.Font.Color.SetColor(Color.Black);
                        range.Worksheet.Cells["A19:N19"].Style.Font.Bold = true;
                    }

                    int index = 20;

                    var groupChiPhiTheoThe = danhSachChiPhi.GroupBy(o => o.MaSoTheBHYT);
                    if (groupChiPhiTheoThe.Count() > 2 ||
                        (groupChiPhiTheoThe.All(o => o.Key != string.Empty) && groupChiPhiTheoThe.Count() > 1))
                    {
                        var groupNgayPhatSinhTheoThe = groupChiPhiTheoThe.Where(o => o.Key != string.Empty).Select(o => new { o.Key, o.OrderBy(j => j.NgayPhatSinh).First().NgayPhatSinh }).OrderBy(o => o.NgayPhatSinh).ToArray();
                        for (int i = 0; i < groupNgayPhatSinhTheoThe.Count(); i++)
                        {
                            var ngayPhatSinhTheoThe = groupNgayPhatSinhTheoThe[i];
                            var theBHYTChiTra = yeuCauTiepNhan.YeuCauTiepNhanTheBHYTs.First(o => o.MaSoThe == ngayPhatSinhTheoThe.Key);
                            var chiPhis = groupChiPhiTheoThe.FirstOrDefault(o => o.Key == ngayPhatSinhTheoThe.Key).ToList();
                            DateTime? ngayPhatSinhTiepTheo = i < groupNgayPhatSinhTheoThe.Count() - 1
                                ? groupNgayPhatSinhTheoThe[i + 1].NgayPhatSinh
                                : null;
                            chiPhis.AddRange(groupChiPhiTheoThe.FirstOrDefault(o => o.Key == string.Empty).Where(j => (i == 0 || j.NgayPhatSinh >= ngayPhatSinhTheoThe.NgayPhatSinh) && (ngayPhatSinhTiepTheo != null && j.NgayPhatSinh < ngayPhatSinhTiepTheo)).ToList());
                            var mucHuongPT = theBHYTChiTra != null && theBHYTChiTra.MucHuong > 0 ? theBHYTChiTra?.MucHuong + "%" : string.Empty;

                            using (var range = worksheet.Cells["A" + index + ":C" + index])
                            {
                                range.Worksheet.Cells["A" + index + ":C" + index].Merge = true;
                                range.Worksheet.Cells["A" + index + ":C" + index].Style.WrapText = true;
                                var title = range.Worksheet.Cells["A" + index + ":C" + index].RichText.Add("Mã thẻ BHYT: ");
                                var value = range.Worksheet.Cells["A" + index + ":C" + index].RichText.Add(theBHYTChiTra.MaSoThe);
                                value.Bold = true;

                                range.Worksheet.Cells["A" + index + ":C" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                range.Worksheet.Cells["A" + index + ":C" + index].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                                range.Worksheet.Cells["A" + index + ":C" + index].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                                range.Worksheet.Cells["A" + index + ":C" + index].Style.Font.Color.SetColor(Color.Black);
                            }

                            using (var range = worksheet.Cells["D" + index + ":F" + index])
                            {
                                range.Worksheet.Cells["D" + index + ":F" + index].Merge = true;
                                range.Worksheet.Cells["D" + index + ":F" + index].Style.WrapText = true;
                                var title = range.Worksheet.Cells["D" + index + ":F" + index].RichText.Add("Giá trị từ: ");
                                var valuebHYTTuNgay = range.Worksheet.Cells["D" + index + ":F" + index].RichText.Add(theBHYTChiTra.NgayHieuLuc.ApplyFormatDate());
                                valuebHYTTuNgay.Bold = true;

                                var den = range.Worksheet.Cells["D" + index + ":F" + index].RichText.Add(" đến: ");
                                den.Bold = false;
                                var valuebHYTDenNgay = range.Worksheet.Cells["D" + index + ":F" + index].RichText.Add(theBHYTChiTra?.NgayHetHan?.ApplyFormatDate());
                                valuebHYTDenNgay.Bold = true;

                                range.Worksheet.Cells["D" + index + ":F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                range.Worksheet.Cells["D" + index + ":F" + index].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                                range.Worksheet.Cells["D" + index + ":F" + index].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                                range.Worksheet.Cells["D" + index + ":F" + index].Style.Font.Color.SetColor(Color.Black);
                            }

                            using (var range = worksheet.Cells["G" + index + ":J" + index])
                            {
                                range.Worksheet.Cells["G" + index + ":J" + index].Merge = true;
                                range.Worksheet.Cells["G" + index + ":J" + index].Style.WrapText = true;
                                var title = range.Worksheet.Cells["G" + index + ":J" + index].RichText.Add("Mức hưởng: ");
                                var value = range.Worksheet.Cells["G" + index + ":J" + index].RichText.Add(mucHuongPT);
                                value.Bold = true;


                                range.Worksheet.Cells["G" + index + ":J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                range.Worksheet.Cells["G" + index + ":J" + index].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                                range.Worksheet.Cells["G" + index + ":J" + index].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                                range.Worksheet.Cells["G" + index + ":J" + index].Style.Font.Color.SetColor(Color.Black);
                            }

                            index++;

                            var indexTableFirst = index;
                            var indexTableLast = index + 1;

                            using (var range = worksheet.Cells["A" + indexTableFirst + ":N" + indexTableLast])
                            {
                                range.Worksheet.Cells["A" + indexTableFirst + ":N" + indexTableLast].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                                range.Worksheet.Cells["A" + indexTableFirst + ":N" + indexTableLast].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                                range.Worksheet.Cells["A" + indexTableFirst + ":N" + indexTableLast].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                range.Worksheet.Cells["A" + indexTableFirst + ":N" + indexTableLast].Style.Font.Color.SetColor(Color.Black);
                                range.Worksheet.Cells["A" + indexTableFirst + ":N" + indexTableLast].Style.Font.Bold = true;
                                range.Worksheet.Cells["A" + indexTableFirst + ":N" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);

                                range.Worksheet.Cells["A" + indexTableFirst + ":A" + indexTableLast].Merge = true;
                                range.Worksheet.Cells["A" + indexTableFirst + ":A" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["A" + indexTableFirst + ":A" + indexTableLast].Value = "STT";

                                range.Worksheet.Cells["B" + indexTableFirst + ":B" + indexTableLast].Merge = true;
                                range.Worksheet.Cells["B" + indexTableFirst + ":B" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["B" + indexTableFirst + ":B" + indexTableLast].Value = "Nội dung";

                                range.Worksheet.Cells["C" + indexTableFirst + ":C" + indexTableLast].Merge = true;
                                range.Worksheet.Cells["C" + indexTableFirst + ":C" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["C" + indexTableFirst + ":C" + indexTableLast].Value = "Đơn vị tính";

                                range.Worksheet.Cells["D" + indexTableFirst + ":D" + indexTableLast].Merge = true;
                                range.Worksheet.Cells["D" + indexTableFirst + ":D" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["D" + indexTableFirst + ":D" + indexTableLast].Value = "Số lượng";

                                range.Worksheet.Cells["E" + indexTableFirst + ":E" + indexTableLast].Merge = true;
                                range.Worksheet.Cells["E" + indexTableFirst + ":E" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["E" + indexTableFirst + ":E" + indexTableLast].Value = "Đơn giá BV(đồng)";

                                range.Worksheet.Cells["F" + indexTableFirst + ":F" + indexTableLast].Merge = true;
                                range.Worksheet.Cells["F" + indexTableFirst + ":F" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["F" + indexTableFirst + ":F" + indexTableLast].Value = "Đơn giá BH(đồng)";

                                range.Worksheet.Cells["G" + indexTableFirst + ":G" + indexTableLast].Merge = true;
                                range.Worksheet.Cells["G" + indexTableFirst + ":G" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["G" + indexTableFirst + ":G" + indexTableLast].Value = "Tỉ lệ thanh toán theo dịch vụ (%)";

                                range.Worksheet.Cells["H" + indexTableFirst + ":H" + indexTableLast].Merge = true;
                                range.Worksheet.Cells["H" + indexTableFirst + ":H" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["H" + indexTableFirst + ":H" + indexTableLast].Value = "Thành tiền BV (đồng)";

                                range.Worksheet.Cells["I" + indexTableFirst + ":I" + indexTableLast].Merge = true;
                                range.Worksheet.Cells["I" + indexTableFirst + ":I" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["I" + indexTableFirst + ":I" + indexTableLast].Value = "Tỷ lệ thanh toán BHYT (%)";

                                range.Worksheet.Cells["J" + indexTableFirst + ":J" + indexTableLast].Merge = true;
                                range.Worksheet.Cells["J" + indexTableFirst + ":J" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["J" + indexTableFirst + ":J" + indexTableLast].Value = "Thành tiền BH(đồng)";

                                range.Worksheet.Cells["K" + indexTableFirst + ":N" + indexTableFirst].Merge = true;
                                range.Worksheet.Cells["K" + indexTableFirst + ":N" + indexTableFirst].Value = "Nguồn thanh toán (đồng)";

                                range.Worksheet.Cells["K" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["K" + indexTableLast].Value = "Quỹ BHYT";

                                range.Worksheet.Cells["L" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["L" + indexTableLast].Value = "Người bệnh cùng chi trả (đồng)";

                                range.Worksheet.Cells["M" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["M" + indexTableLast].Value = "Khác (đồng)";

                                range.Worksheet.Cells["N" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["N" + indexTableLast].Value = "Người bệnh tự trả(đồng)";
                            }

                            index = indexTableLast + 1;

                            var dsChiPhiBangKeTheoThe = new List<BangKeKhamBenhBenhVienVo>();

                            foreach (var chiPhi in chiPhis.Where(c => c.NhomChiPhiBangKe != NhomChiPhiBangKe.GoiVatTu && c.YeuCauGoiDichVuId == null).GroupBy(c => new { c.DonGia, c.SoTienMG, KhongTinhPhi = c.KhongTinhPhi.GetValueOrDefault(), c.NhomChiPhiBangKe, c.TenDichVu, c.DonViTinh, c.DuocHuongBHYT, c.DonGiaBHYT, c.MucHuongBaoHiem, c.TiLeBaoHiemThanhToan }).OrderByDescending(o => o.Key.DuocHuongBHYT))
                            {
                                var chiphiBangKe = new BangKeKhamBenhBenhVienVo
                                {
                                    Nhom = chiPhi.Key.NhomChiPhiBangKe,
                                    Id = chiPhi.FirstOrDefault().Id,
                                    NoiDung = chiPhi.Key.TenDichVu,
                                    DonViTinh = chiPhi.Key.DonViTinh,
                                    SoLuong = (decimal)chiPhi.Sum(c => c.Soluong),
                                    DuocHuongBaoHiem = chiPhi.Key.DuocHuongBHYT,
                                    DonGiaBH = chiPhi.Key.DuocHuongBHYT ? chiPhi.Key.DonGiaBHYT : 0,
                                    MucHuongBaoHiem = chiPhi.Key.MucHuongBaoHiem,
                                    TiLeThanhToanTheoDV = chiPhi.Key.TiLeBaoHiemThanhToan,
                                    BaoHiemChiTra = true,
                                    DonGiaBV = chiPhi.Key.DonGia
                                };
                                if (chiPhi.Key.KhongTinhPhi == true)
                                {
                                    chiphiBangKe.Khac = chiPhi.Key.MucHuongBaoHiem > 0
                                        ? (chiphiBangKe.ThanhTienBV.GetValueOrDefault() - chiphiBangKe.ThanhTienBH.GetValueOrDefault())
                                        : chiphiBangKe.ThanhTienBV.GetValueOrDefault();
                                }
                                else
                                {
                                    chiphiBangKe.Khac = chiPhi.Sum(c => c.SoTienMG);
                                }
                                dsChiPhiBangKeTheoThe.Add(chiphiBangKe);
                            }

                            foreach (var chiPhi in chiPhis.Where(c => !(c.NhomChiPhiBangKe != NhomChiPhiBangKe.GoiVatTu && c.YeuCauGoiDichVuId == null)))
                            {
                                var chiphiBangKe = new BangKeKhamBenhBenhVienVo
                                {
                                    Nhom = chiPhi.NhomChiPhiBangKe,
                                    Id = chiPhi.Id,
                                    NoiDung = chiPhi.TenDichVu,
                                    DonViTinh = chiPhi.DonViTinh,
                                    SoLuong = (decimal)chiPhi.Soluong,
                                    DuocHuongBaoHiem = chiPhi.DuocHuongBHYT,
                                    DonGiaBH = chiPhi.DuocHuongBHYT ? chiPhi.DonGiaBHYT : 0,
                                    MucHuongBaoHiem = chiPhi.MucHuongBaoHiem,
                                    TiLeThanhToanTheoDV = chiPhi.TiLeBaoHiemThanhToan,
                                    BaoHiemChiTra = true,
                                    DonGiaBV = chiPhi.DonGia
                                };
                                if (chiPhi.KhongTinhPhi == true || chiPhi.YeuCauGoiDichVuId != null)
                                {
                                    chiphiBangKe.Khac = chiPhi.MucHuongBaoHiem > 0
                                        ? (chiphiBangKe.ThanhTienBV.GetValueOrDefault() - chiphiBangKe.ThanhTienBH.GetValueOrDefault())
                                        : chiphiBangKe.ThanhTienBV.GetValueOrDefault();
                                }
                                else
                                {
                                    chiphiBangKe.Khac = chiPhi.SoTienMG;
                                }
                                dsChiPhiBangKeTheoThe.Add(chiphiBangKe);
                            }
                            //Update BACHA-458
                            //Trường hợp NB có miễn giảm 100% tiền giường chỉ hiển thị tại cột khác
                            //Riêng cột NB cùng chi trả và NB tự trả là 0đ
                            //foreach (var chiphi in dsChiPhiBangKeTheoThe.Where(o => o.Nhom == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay ||
                            //                                                        o.Nhom == NhomChiPhiBangKe.NgayGiuongDieuTriNoiTru))
                            //{
                            //    if (chiphi.QuyBHYT > 0 && chiphi.Khac.GetValueOrDefault().SoTienTuongDuong(chiphi.ThanhTienBV.GetValueOrDefault() - chiphi.QuyBHYT))
                            //    {
                            //        chiphi.Khac = chiphi.ThanhTienBV;
                            //    }
                            //}

                            dsChiPhiBangKe.AddRange(dsChiPhiBangKeTheoThe);
                            var groupChiPhiBangKes = dsChiPhiBangKeTheoThe.GroupBy(x => x.Nhom).OrderBy(o => (int)o.Key * (o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay || o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriNoiTru ? 1 : 10));
                            if (!groupChiPhiBangKes.Any())
                            {
                                return null;
                            }
                            foreach (var groupChiPhiBangKe in groupChiPhiBangKes)
                            {
                                if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay)
                                {

                                    worksheet.Cells["A" + index + ":N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["A" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                    worksheet.Cells["A" + index + ":N" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                    worksheet.Cells["A" + index + ":N" + index].Merge = true;
                                    worksheet.Cells["A" + index + ":N" + index].Value = "2. Ngày giường:";
                                    worksheet.Cells["A" + index + ":N" + index].Style.Font.Bold = true;

                                    index++;

                                    worksheet.Cells["A" + index + ":G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["A" + index + ":G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                    worksheet.Cells["A" + index + ":G" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                    worksheet.Cells["A" + index + ":G" + index].Merge = true;
                                    worksheet.Cells["A" + index + ":G" + index].Value = "2.1." + groupChiPhiBangKe.Key.GetDescription();
                                    worksheet.Cells["A" + index + ":G" + index].Style.Font.Bold = true;

                                    worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["H" + index].Style.Font.Bold = true;
                                    worksheet.Cells["H" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBV);

                                    worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["J" + index].Style.Font.Bold = true;
                                    worksheet.Cells["J" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBH);

                                    worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["K" + index].Style.Font.Bold = true;
                                    worksheet.Cells["K" + index].Value = groupChiPhiBangKe.Sum(o => o.QuyBHYT);

                                    worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["L" + index].Style.Font.Bold = true;
                                    worksheet.Cells["L" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra);

                                    worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["M" + index].Style.Font.Bold = true;
                                    worksheet.Cells["M" + index].Value = groupChiPhiBangKe.Sum(o => o.Khac);

                                    worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["N" + index].Style.Font.Bold = true;
                                    worksheet.Cells["N" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra);

                                    index++;
                                }
                                else if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.NgayGiuongDieuTriNoiTru)
                                {
                                    if (!groupChiPhiBangKes.Any(o => o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay))
                                    {
                                        worksheet.Cells["A" + index + ":N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["A" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                        worksheet.Cells["A" + index + ":N" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                        worksheet.Cells["A" + index + ":N" + index].Merge = true;
                                        worksheet.Cells["A" + index + ":N" + index].Value = "2. Ngày giường:";
                                        worksheet.Cells["A" + index + ":N" + index].Style.Font.Bold = true;

                                    }
                                    index++;

                                    worksheet.Cells["A" + index + ":G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["A" + index + ":G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                    worksheet.Cells["A" + index + ":G" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                    worksheet.Cells["A" + index + ":G" + index].Merge = true;
                                    worksheet.Cells["A" + index + ":G" + index].Value = "2.2." + groupChiPhiBangKe.Key.GetDescription();
                                    worksheet.Cells["A" + index + ":G" + index].Style.Font.Bold = true;

                                    worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["H" + index].Style.Font.Bold = true;
                                    worksheet.Cells["H" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBV);

                                    worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["J" + index].Style.Font.Bold = true;
                                    worksheet.Cells["J" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBH);

                                    worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["K" + index].Style.Font.Bold = true;
                                    worksheet.Cells["K" + index].Value = groupChiPhiBangKe.Sum(o => o.QuyBHYT);

                                    worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["L" + index].Style.Font.Bold = true;
                                    worksheet.Cells["L" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra);

                                    worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["M" + index].Style.Font.Bold = true;
                                    worksheet.Cells["M" + index].Value = groupChiPhiBangKe.Sum(o => o.Khac);

                                    worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["N" + index].Style.Font.Bold = true;
                                    worksheet.Cells["N" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra);

                                    index++;
                                }
                                else
                                {
                                    worksheet.Cells["A" + index + ":G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["A" + index + ":G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                    worksheet.Cells["A" + index + ":G" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                    worksheet.Cells["A" + index + ":G" + index].Merge = true;
                                    worksheet.Cells["A" + index + ":G" + index].Value = (int)groupChiPhiBangKe.Key + "." + groupChiPhiBangKe.Key.GetDescription();
                                    worksheet.Cells["A" + index + ":G" + index].Style.Font.Bold = true;

                                    worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["H" + index].Style.Font.Bold = true;
                                    worksheet.Cells["H" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBV);

                                    worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["J" + index].Style.Font.Bold = true;
                                    worksheet.Cells["J" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBH);

                                    worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["K" + index].Style.Font.Bold = true;
                                    worksheet.Cells["K" + index].Value = groupChiPhiBangKe.Sum(o => o.QuyBHYT);

                                    worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["L" + index].Style.Font.Bold = true;
                                    worksheet.Cells["L" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra);

                                    worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["M" + index].Style.Font.Bold = true;
                                    worksheet.Cells["M" + index].Value = groupChiPhiBangKe.Sum(o => o.Khac);

                                    worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["N" + index].Style.Font.Bold = true;
                                    worksheet.Cells["N" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra);

                                    index++;
                                }
                                if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.GoiVatTu)
                                {
                                    var groupGoiVatTus = groupChiPhiBangKe.ToList().GroupBy(o => o.SoGoiVatTu.GetValueOrDefault()).OrderBy(o => o.Key);
                                    int sttGoiVatTu = 1;
                                    foreach (var groupGoiVatTu in groupGoiVatTus)
                                    {
                                        worksheet.Cells["A" + index + ":G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["A" + index + ":G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                        worksheet.Cells["A" + index + ":G" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                        worksheet.Cells["A" + index + ":G" + index].Value = "10." + sttGoiVatTu + ". " + groupChiPhiBangKe.Key.GetDescription() + " " + sttGoiVatTu;
                                        worksheet.Cells["A" + index + ":G" + index].Style.Font.Bold = true;
                                        worksheet.Cells["A" + index + ":G" + index].Merge = true;

                                        worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["H" + index].Style.Font.Bold = true;
                                        worksheet.Cells["H" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBV);

                                        worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["J" + index].Style.Font.Bold = true;
                                        worksheet.Cells["J" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBH);

                                        worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["K" + index].Style.Font.Bold = true;
                                        worksheet.Cells["K" + index].Value = groupChiPhiBangKe.Sum(o => o.QuyBHYT);

                                        worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["L" + index].Style.Font.Bold = true;
                                        worksheet.Cells["L" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra);

                                        worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["M" + index].Style.Font.Bold = true;
                                        worksheet.Cells["M" + index].Value = groupChiPhiBangKe.Sum(o => o.Khac);

                                        worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["N" + index].Style.Font.Bold = true;
                                        worksheet.Cells["N" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra);

                                        index++;
                                        foreach (var chiPhiBangKe in groupGoiVatTu)
                                        {
                                            worksheet.Cells["A" + index + ":N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["A" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                            worksheet.Cells["A" + index + ":N" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));

                                            worksheet.Cells["A" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["A" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                            worksheet.Cells["A" + index].Value = indexItem;

                                            worksheet.Cells["B" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["B" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                            worksheet.Cells["B" + index].Value = chiPhiBangKe.NoiDung;

                                            worksheet.Cells["C" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["C" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                            worksheet.Cells["C" + index].Value = chiPhiBangKe.DonViTinh;

                                            worksheet.Cells["D" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["D" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                            worksheet.Cells["D" + index].Value = chiPhiBangKe.SoLuong;

                                            worksheet.Cells["E" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["E" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                            worksheet.Cells["E" + index].Style.Numberformat.Format = "#,##0.00";
                                            worksheet.Cells["E" + index].Value = chiPhiBangKe.DonGiaBV;

                                            worksheet.Cells["F" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["F" + index].Style.Numberformat.Format = "#,##0.00";
                                            worksheet.Cells["F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                            worksheet.Cells["F" + index].Value = chiPhiBangKe.DonGiaBH;

                                            worksheet.Cells["G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                            worksheet.Cells["G" + index].Style.Numberformat.Format = "#,##0.00";
                                            worksheet.Cells["G" + index].Value = chiPhiBangKe.TiLeThanhToanTheoDV;

                                            worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                            worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                            worksheet.Cells["H" + index].Value = chiPhiBangKe.ThanhTienBV;

                                            worksheet.Cells["I" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["I" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                            worksheet.Cells["I" + index].Value = Convert.ToDouble(chiPhiBangKe.MucHuongBaoHiem > 0 ? 100 : 0).ApplyFormatMoneyToDouble();


                                            worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                            worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                            worksheet.Cells["J" + index].Value = chiPhiBangKe.ThanhTienBH;


                                            worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                            worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                            worksheet.Cells["K" + index].Value = chiPhiBangKe.QuyBHYT;


                                            worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                            worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                            worksheet.Cells["L" + index].Value = chiPhiBangKe.NguoiBenhCungChiTra;


                                            worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                            worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                            worksheet.Cells["M" + index].Value = chiPhiBangKe.Khac;


                                            worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                            worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                            worksheet.Cells["N" + index].Value = chiPhiBangKe.NguoiBenhTuTra;

                                            indexItem++;
                                            index++;
                                        }
                                    }
                                }
                                else
                                {
                                    foreach (var chiPhiBangKe in groupChiPhiBangKe)
                                    {
                                        worksheet.Cells["A" + index + ":N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["A" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                        worksheet.Cells["A" + index + ":N" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));

                                        worksheet.Cells["A" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["A" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                        worksheet.Cells["A" + index].Value = indexItem;

                                        worksheet.Cells["B" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["B" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                        worksheet.Cells["B" + index].Value = chiPhiBangKe.NoiDung;

                                        worksheet.Cells["C" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["C" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                        worksheet.Cells["C" + index].Value = chiPhiBangKe.DonViTinh;

                                        worksheet.Cells["D" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["D" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                        worksheet.Cells["D" + index].Value = chiPhiBangKe.SoLuong;

                                        worksheet.Cells["E" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["E" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["E" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["E" + index].Value = chiPhiBangKe.DonGiaBV;

                                        worksheet.Cells["F" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["F" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["F" + index].Value = chiPhiBangKe.DonGiaBH;

                                        worksheet.Cells["G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["G" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["G" + index].Value = chiPhiBangKe.TiLeThanhToanTheoDV;

                                        worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["H" + index].Value = chiPhiBangKe.ThanhTienBV;

                                        worksheet.Cells["I" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["I" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["I" + index].Value = Convert.ToDouble(chiPhiBangKe.MucHuongBaoHiem > 0 ? 100 : 0).ApplyFormatMoneyToDouble();


                                        worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["J" + index].Value = chiPhiBangKe.ThanhTienBH;


                                        worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["K" + index].Value = chiPhiBangKe.QuyBHYT;


                                        worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["L" + index].Value = chiPhiBangKe.NguoiBenhCungChiTra;


                                        worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["M" + index].Value = chiPhiBangKe.Khac;


                                        worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["N" + index].Value = chiPhiBangKe.NguoiBenhTuTra;

                                        indexItem++;
                                        index++;
                                    }
                                }

                            }



                            worksheet.Cells["A" + index + ":G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["A" + index + ":G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                            worksheet.Cells["A" + index + ":G" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                            worksheet.Cells["A" + index + ":G" + index].Merge = true;
                            worksheet.Cells["A" + index + ":G" + index].Value = "Tổng cộng";
                            worksheet.Cells["A" + index + ":G" + index].Style.Font.Bold = true;

                            worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                            worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                            worksheet.Cells["H" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.ThanhTienBV)).Sum();


                            worksheet.Cells["I" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["I" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;

                            worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                            worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                            worksheet.Cells["J" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.ThanhTienBH)).Sum();

                            worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                            worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                            worksheet.Cells["K" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.QuyBHYT)).Sum();

                            worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                            worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                            worksheet.Cells["L" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.NguoiBenhCungChiTra)).Sum();

                            worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                            worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                            worksheet.Cells["M" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.Khac)).Sum();

                            worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                            worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                            worksheet.Cells["N" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.NguoiBenhTuTra)).Sum();

                            index++;

                            worksheet.Cells["A" + index + ":N" + index].Merge = true;
                            worksheet.Cells["A" + index + ":N" + index].Value = "Tổng chi phí lần khám bệnh/cả đợt điều trị: " + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + " đồng";
                            worksheet.Cells["A" + index + ":N" + index].Style.Font.Bold = true;

                            index++;

                            worksheet.Cells["A" + index + ":N" + index].Merge = true;
                            worksheet.Cells["A" + index + ":N" + index].Value = "(Viết bằng chữ: " + NumberHelper.ChuyenSoRaText(Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBV))) + ")";

                            index++;

                            worksheet.Cells["A" + index + ":N" + index].Merge = true;
                            worksheet.Cells["A" + index + ":N" + index].Value = "Trong đó , số tiền do:";
                            worksheet.Cells["A" + index + ":N" + index].Style.Font.Bold = true;

                            index++;
                            worksheet.Cells["A" + index + ":N" + index].Merge = true;
                            worksheet.Cells["A" + index + ":N" + index].Value = "- Quỹ BHYT thanh toán: " + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble();

                            var tongBHTN = Convert.ToDouble(danhSachTatCaChiPhi.Where(o => o.TrangThaiThanhToan != Enums.TrangThaiThanhToan.DaThanhToan).Sum(o => o.TongCongNo));
                            if (tongBHTN != 0)
                            {
                                index++;
                                worksheet.Cells["A" + index + ":N" + index].Merge = true;
                                worksheet.Cells["A" + index + ":N" + index].Value = "- BHTN bảo lãnh: " + Convert.ToDouble(tongBHTN).ApplyFormatMoneyToDouble();
                            }

                            index++;
                            var tongTamUng = GetSoTienDaTamUngAsync(yeuCauTiepNhanId).Result;
                            worksheet.Cells["A" + index + ":N" + index].Merge = true;
                            worksheet.Cells["A" + index + ":N" + index].Value = "- Tổng tạm ứng: " + Convert.ToDouble(tongTamUng).ApplyFormatMoneyToDouble();


                            index++;
                            worksheet.Cells["A" + index + ":N" + index].Merge = true;
                            worksheet.Cells["A" + index + ":N" + index].Value = "+ Nguồn khác: " + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble(true);


                            var tongQuyBHYTThanhToan = Convert.ToDouble(danhSachTatCaChiPhi.Where(o => o.TrangThaiThanhToan != TrangThaiThanhToan.DaThanhToan && o.KiemTraBHYTXacNhan).Sum(o => o.BHYTThanhToan));
                            var soTienCanThu = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBV)) - Convert.ToDouble(tongTamUng) - tongQuyBHYTThanhToan - tongBHTN - Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.Khac));
                            string soTienNBTuTraHoacTraLaiBN = soTienCanThu < 0 ? $"- Phải trả lại NB: {(soTienCanThu * (-1)).ApplyFormatMoneyToDouble()}" : $"- Người bệnh tự trả: {(soTienCanThu).ApplyFormatMoneyToDouble()}";

                            index++;

                            worksheet.Cells["A" + index + ":N" + index].Merge = true;
                            worksheet.Cells["A" + index + ":N" + index].Value = soTienNBTuTraHoacTraLaiBN;


                            index = index + 2;

                            worksheet.Cells["G" + index + ":N" + index].Style.Font.Bold = true;
                            worksheet.Cells["G" + index + ":N" + index].Merge = true;
                            worksheet.Cells["G" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                            worksheet.Cells["G" + index + ":N" + index].Value = "XÁC NHẬN CỦA NGƯỜI BỆNH ";

                            index++;

                            worksheet.Cells["A" + index + ":F" + index].Style.Font.Bold = true;
                            worksheet.Cells["A" + index + ":F" + index].Merge = true;
                            worksheet.Cells["A" + index + ":F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                            worksheet.Cells["A" + index + ":F" + index].Value = "NGƯỜI LẬP BẢNG KÊ";


                            worksheet.Cells["G" + index + ":N" + index].Style.Font.Bold = true;
                            worksheet.Cells["G" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                            worksheet.Cells["G" + index + ":N" + index].Merge = true;
                            worksheet.Cells["G" + index + ":N" + index].Value = "(Ký , Ghi rõ họ tên)";

                            index++;

                            worksheet.Cells["A" + index + ":F" + index].Style.Font.Bold = true;
                            worksheet.Cells["A" + index + ":F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                            worksheet.Cells["A" + index + ":F" + index].Merge = true;
                            worksheet.Cells["A" + index + ":F" + index].Value = "(Ký , Ghi rõ họ tên)";


                            worksheet.Cells["G" + index + ":N" + index].Style.Font.Bold = true;
                            worksheet.Cells["G" + index + ":N" + index].Merge = true;
                            worksheet.Cells["G" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                            worksheet.Cells["G" + index + ":N" + index].Value = "(Tôi đã nhận...phim...Xquang / CT / MRI)";

                            xlPackage.Save();
                        }
                    }
                    else
                    {
                        YeuCauTiepNhanTheBHYT theBHYTChiTra = null;
                        var maSoThe = groupChiPhiTheoThe.Where(o => o.Key != string.Empty).FirstOrDefault()?.Key;
                        if (!string.IsNullOrEmpty(maSoThe))
                        {
                            theBHYTChiTra = yeuCauTiepNhan.YeuCauTiepNhanTheBHYTs.First(o => o.MaSoThe == maSoThe);
                        }

                        var chiPhis = groupChiPhiTheoThe.SelectMany(o => o).ToList();
                        var mucHuongPT = theBHYTChiTra != null && theBHYTChiTra?.MucHuong > 0 ? theBHYTChiTra?.MucHuong + "%" : string.Empty;

                        //================================= 20 =========================================
                        using (var range = worksheet.Cells["A20:C20"])
                        {
                            range.Worksheet.Cells["A20:C20"].Merge = true;
                            range.Worksheet.Cells["A20:C20"].Style.WrapText = true;
                            var title = range.Worksheet.Cells["A20:C20"].RichText.Add("Mã thẻ BHYT: ");
                            var value = range.Worksheet.Cells["A20:C20"].RichText.Add(theBHYTChiTra?.MaSoThe);
                            value.Bold = true;

                            range.Worksheet.Cells["A20:C20"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                            range.Worksheet.Cells["A20:C20"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                            range.Worksheet.Cells["A20:C20"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                            range.Worksheet.Cells["A20:C20"].Style.Font.Color.SetColor(Color.Black);
                        }
                        using (var range = worksheet.Cells["D20:F20"])
                        {
                            range.Worksheet.Cells["D20:F20"].Merge = true;
                            range.Worksheet.Cells["D20:F20"].Style.WrapText = true;
                            var title = range.Worksheet.Cells["D20:F20"].RichText.Add("Giá trị từ: ");
                            var valuebHYTTuNgay = range.Worksheet.Cells["D20:F20"].RichText.Add(theBHYTChiTra?.NgayHieuLuc.ApplyFormatDate());
                            valuebHYTTuNgay.Bold = true;

                            var den = range.Worksheet.Cells["D20:F20"].RichText.Add(" đến: ");
                            den.Bold = false;
                            var valuebHYTDenNgay = range.Worksheet.Cells["D20:F20"].RichText.Add(theBHYTChiTra?.NgayHetHan?.ApplyFormatDate());
                            valuebHYTDenNgay.Bold = true;

                            range.Worksheet.Cells["D20:F20"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                            range.Worksheet.Cells["D20:F20"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                            range.Worksheet.Cells["D20:F20"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                            range.Worksheet.Cells["D20:F20"].Style.Font.Color.SetColor(Color.Black);
                        }
                        using (var range = worksheet.Cells["G20:J20"])
                        {
                            range.Worksheet.Cells["G20:J20"].Merge = true;
                            range.Worksheet.Cells["G20:J20"].Style.WrapText = true;
                            var title = range.Worksheet.Cells["G20:J20"].RichText.Add("Mức hưởng: ");
                            var value = range.Worksheet.Cells["G20:J20"].RichText.Add(mucHuongPT);
                            value.Bold = true;


                            range.Worksheet.Cells["G20:J20"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                            range.Worksheet.Cells["G20:J20"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                            range.Worksheet.Cells["G20:J20"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                            range.Worksheet.Cells["G20:J20"].Style.Font.Color.SetColor(Color.Black);
                        }

                        using (var range = worksheet.Cells["A21:N22"])
                        {
                            range.Worksheet.Cells["A21:N22"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                            range.Worksheet.Cells["A21:N22"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                            range.Worksheet.Cells["A21:N22"].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                            range.Worksheet.Cells["A21:N22"].Style.Font.Color.SetColor(Color.Black);
                            range.Worksheet.Cells["A21:N22"].Style.Font.Bold = true;
                            range.Worksheet.Cells["A21:N22"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);

                            range.Worksheet.Cells["A21:A22"].Merge = true;
                            range.Worksheet.Cells["A21:A22"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["A21:A22"].Value = "STT";

                            range.Worksheet.Cells["B21:B22"].Merge = true;
                            range.Worksheet.Cells["B21:B22"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["B21:B22"].Value = "Nội dung";

                            range.Worksheet.Cells["C21:C22"].Merge = true;
                            range.Worksheet.Cells["C21:C22"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["C21:C22"].Value = "Đơn vị tính";

                            range.Worksheet.Cells["D21:D22"].Merge = true;
                            range.Worksheet.Cells["D21:D22"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["D21:D22"].Value = "Số lượng";

                            range.Worksheet.Cells["E21:E22"].Merge = true;
                            range.Worksheet.Cells["E21:E22"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["E21:E22"].Value = "Đơn giá BV(đồng)";

                            range.Worksheet.Cells["F21:F22"].Merge = true;
                            range.Worksheet.Cells["F21:F22"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["F21:F22"].Value = "Đơn giá BH(đồng)";

                            range.Worksheet.Cells["G21:G22"].Merge = true;
                            range.Worksheet.Cells["G21:G22"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["G21:G22"].Value = "Tỉ lệ thanh toán theo dịch vụ (%)";

                            range.Worksheet.Cells["H21:H22"].Merge = true;
                            range.Worksheet.Cells["H21:H22"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["H21:H22"].Value = "Thành tiền BV (đồng)";

                            range.Worksheet.Cells["I21:I22"].Merge = true;
                            range.Worksheet.Cells["I21:I22"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["I21:I22"].Value = "Tỷ lệ thanh toán BHYT (%)";

                            range.Worksheet.Cells["J21:J22"].Merge = true;
                            range.Worksheet.Cells["J21:J22"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["J21:J22"].Value = "Thành tiền BH(đồng)";

                            range.Worksheet.Cells["K21:N21"].Merge = true;
                            range.Worksheet.Cells["K21:N21"].Value = "Nguồn thanh toán (đồng)";

                            range.Worksheet.Cells["K22"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["K22"].Value = "Quỹ BHYT";

                            range.Worksheet.Cells["L22"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["L22"].Value = "Người bệnh cùng chi trả (đồng)";

                            range.Worksheet.Cells["M22"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["M22"].Value = "Khác (đồng)";

                            range.Worksheet.Cells["N22"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["N22"].Value = "Người bệnh tự trả(đồng)";
                        }
                        index = index + 3;

                        foreach (var chiPhi in chiPhis.Where(c => c.NhomChiPhiBangKe != NhomChiPhiBangKe.GoiVatTu && c.YeuCauGoiDichVuId == null).GroupBy(c => new { c.DonGia, c.SoTienMG, KhongTinhPhi = c.KhongTinhPhi.GetValueOrDefault(), c.NhomChiPhiBangKe, c.TenDichVu, c.DonViTinh, c.DuocHuongBHYT, c.DonGiaBHYT, c.MucHuongBaoHiem, c.TiLeBaoHiemThanhToan }).OrderByDescending(o => o.Key.DuocHuongBHYT))
                        {
                            var chiphiBangKe = new BangKeKhamBenhBenhVienVo
                            {
                                Nhom = chiPhi.Key.NhomChiPhiBangKe,
                                Id = chiPhi.FirstOrDefault().Id,
                                NoiDung = chiPhi.Key.TenDichVu,
                                DonViTinh = chiPhi.Key.DonViTinh,
                                SoLuong = (decimal)chiPhi.Sum(c => c.Soluong),
                                DuocHuongBaoHiem = chiPhi.Key.DuocHuongBHYT,
                                DonGiaBH = chiPhi.Key.DuocHuongBHYT ? chiPhi.Key.DonGiaBHYT : 0,
                                MucHuongBaoHiem = chiPhi.Key.MucHuongBaoHiem,
                                TiLeThanhToanTheoDV = chiPhi.Key.TiLeBaoHiemThanhToan,
                                BaoHiemChiTra = true,
                                DonGiaBV = chiPhi.Key.DonGia
                            };
                            if (chiPhi.Key.KhongTinhPhi == true)
                            {
                                chiphiBangKe.Khac = chiPhi.Key.MucHuongBaoHiem > 0
                                    ? (chiphiBangKe.ThanhTienBV.GetValueOrDefault() - chiphiBangKe.ThanhTienBH.GetValueOrDefault())
                                    : chiphiBangKe.ThanhTienBV.GetValueOrDefault();
                            }
                            else
                            {
                                chiphiBangKe.Khac = chiPhi.Sum(c => c.SoTienMG);
                            }
                            dsChiPhiBangKe.Add(chiphiBangKe);
                        }

                        foreach (var chiPhi in chiPhis.Where(c => !(c.NhomChiPhiBangKe != NhomChiPhiBangKe.GoiVatTu && c.YeuCauGoiDichVuId == null)))
                        {
                            var chiphiBangKe = new BangKeKhamBenhBenhVienVo
                            {
                                Nhom = chiPhi.NhomChiPhiBangKe,
                                Id = chiPhi.Id,
                                NoiDung = chiPhi.TenDichVu,
                                DonViTinh = chiPhi.DonViTinh,
                                SoLuong = (decimal)chiPhi.Soluong,
                                DuocHuongBaoHiem = chiPhi.DuocHuongBHYT,
                                DonGiaBH = chiPhi.DuocHuongBHYT ? chiPhi.DonGiaBHYT : 0,
                                MucHuongBaoHiem = chiPhi.MucHuongBaoHiem,
                                TiLeThanhToanTheoDV = chiPhi.TiLeBaoHiemThanhToan,
                                BaoHiemChiTra = true,
                                DonGiaBV = chiPhi.DonGia
                            };
                            if (chiPhi.KhongTinhPhi == true || chiPhi.YeuCauGoiDichVuId != null)
                            {
                                chiphiBangKe.Khac = chiPhi.MucHuongBaoHiem > 0
                                    ? (chiphiBangKe.ThanhTienBV.GetValueOrDefault() - chiphiBangKe.ThanhTienBH.GetValueOrDefault())
                                    : chiphiBangKe.ThanhTienBV.GetValueOrDefault();
                            }
                            else
                            {
                                chiphiBangKe.Khac = chiPhi.SoTienMG;
                            }
                            dsChiPhiBangKe.Add(chiphiBangKe);
                        }

                        //Update BACHA-458
                        //Trường hợp NB có miễn giảm 100% tiền giường chỉ hiển thị tại cột khác
                        //Riêng cột NB cùng chi trả và NB tự trả là 0đ
                        //foreach (var chiphi in dsChiPhiBangKe.Where(o => o.Nhom == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay ||
                        //                                                 o.Nhom == NhomChiPhiBangKe.NgayGiuongDieuTriNoiTru))
                        //{
                        //    if (chiphi.QuyBHYT > 0 && chiphi.Khac.GetValueOrDefault().SoTienTuongDuong(chiphi.ThanhTienBV.GetValueOrDefault() - chiphi.QuyBHYT))
                        //    {
                        //        chiphi.Khac = chiphi.ThanhTienBV;
                        //    }
                        //}

                        var groupChiPhiBangKes = dsChiPhiBangKe.GroupBy(x => x.Nhom).OrderBy(o => (int)o.Key * (o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay || o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriNoiTru ? 1 : 10));
                        if (!groupChiPhiBangKes.Any())
                        {
                            return null;
                        }
                        foreach (var groupChiPhiBangKe in groupChiPhiBangKes)
                        {
                            if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay)
                            {

                                worksheet.Cells["A" + index + ":N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["A" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                worksheet.Cells["A" + index + ":N" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                worksheet.Cells["A" + index + ":N" + index].Merge = true;
                                worksheet.Cells["A" + index + ":N" + index].Value = "2. Ngày giường:";
                                worksheet.Cells["A" + index + ":N" + index].Style.Font.Bold = true;

                                index++;

                                worksheet.Cells["A" + index + ":G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["A" + index + ":G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                worksheet.Cells["A" + index + ":G" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                worksheet.Cells["A" + index + ":G" + index].Merge = true;
                                worksheet.Cells["A" + index + ":G" + index].Value = "2.1." + groupChiPhiBangKe.Key.GetDescription();
                                worksheet.Cells["A" + index + ":G" + index].Style.Font.Bold = true;

                                worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["H" + index].Style.Font.Bold = true;
                                worksheet.Cells["H" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBV);

                                worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["J" + index].Style.Font.Bold = true;
                                worksheet.Cells["J" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBH);

                                worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["K" + index].Style.Font.Bold = true;
                                worksheet.Cells["K" + index].Value = groupChiPhiBangKe.Sum(o => o.QuyBHYT);

                                worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["L" + index].Style.Font.Bold = true;
                                worksheet.Cells["L" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra);

                                worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["M" + index].Style.Font.Bold = true;
                                worksheet.Cells["M" + index].Value = groupChiPhiBangKe.Sum(o => o.Khac);

                                worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["N" + index].Style.Font.Bold = true;
                                worksheet.Cells["N" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra);

                                index++;
                            }
                            else if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.NgayGiuongDieuTriNoiTru)
                            {
                                if (!groupChiPhiBangKes.Any(o => o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay))
                                {
                                    worksheet.Cells["A" + index + ":N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["A" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                    worksheet.Cells["A" + index + ":N" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                    worksheet.Cells["A" + index + ":N" + index].Merge = true;
                                    worksheet.Cells["A" + index + ":N" + index].Value = "2. Ngày giường:";
                                    worksheet.Cells["A" + index + ":N" + index].Style.Font.Bold = true;

                                }
                                index++;
                                worksheet.Cells["A" + index + ":G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["A" + index + ":G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                worksheet.Cells["A" + index + ":G" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                worksheet.Cells["A" + index + ":G" + index].Merge = true;
                                worksheet.Cells["A" + index + ":G" + index].Value = "2.2." + groupChiPhiBangKe.Key.GetDescription();
                                worksheet.Cells["A" + index + ":G" + index].Style.Font.Bold = true;

                                worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["H" + index].Style.Font.Bold = true;
                                worksheet.Cells["H" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBV);

                                worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["J" + index].Style.Font.Bold = true;
                                worksheet.Cells["J" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBH);

                                worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["K" + index].Style.Font.Bold = true;
                                worksheet.Cells["K" + index].Value = groupChiPhiBangKe.Sum(o => o.QuyBHYT);

                                worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["L" + index].Style.Font.Bold = true;
                                worksheet.Cells["L" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra);

                                worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["M" + index].Style.Font.Bold = true;
                                worksheet.Cells["M" + index].Value = groupChiPhiBangKe.Sum(o => o.Khac);

                                worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["N" + index].Style.Font.Bold = true;
                                worksheet.Cells["N" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra);

                                index++;
                            }
                            else
                            {
                                worksheet.Cells["A" + index + ":G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["A" + index + ":G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                worksheet.Cells["A" + index + ":G" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                worksheet.Cells["A" + index + ":G" + index].Merge = true;
                                worksheet.Cells["A" + index + ":G" + index].Value = (int)groupChiPhiBangKe.Key + "." + groupChiPhiBangKe.Key.GetDescription();
                                worksheet.Cells["A" + index + ":G" + index].Style.Font.Bold = true;

                                worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["H" + index].Style.Font.Bold = true;
                                worksheet.Cells["H" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBV);

                                worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["J" + index].Style.Font.Bold = true;
                                worksheet.Cells["J" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBH);

                                worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["K" + index].Style.Font.Bold = true;
                                worksheet.Cells["K" + index].Value = groupChiPhiBangKe.Sum(o => o.QuyBHYT);

                                worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["L" + index].Style.Font.Bold = true;
                                worksheet.Cells["L" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra);

                                worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["M" + index].Style.Font.Bold = true;
                                worksheet.Cells["M" + index].Value = groupChiPhiBangKe.Sum(o => o.Khac);

                                worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["N" + index].Style.Font.Bold = true;
                                worksheet.Cells["N" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra);

                                index++;
                            }
                            if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.GoiVatTu)
                            {
                                var groupGoiVatTus = groupChiPhiBangKe.ToList().GroupBy(o => o.SoGoiVatTu.GetValueOrDefault()).OrderBy(o => o.Key);
                                int sttGoiVatTu = 1;
                                foreach (var groupGoiVatTu in groupGoiVatTus)
                                {
                                    worksheet.Cells["A" + index + ":G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["A" + index + ":G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                    worksheet.Cells["A" + index + ":G" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                    worksheet.Cells["A" + index + ":G" + index].Value = "10." + sttGoiVatTu + ". " + groupChiPhiBangKe.Key.GetDescription() + " " + sttGoiVatTu;
                                    worksheet.Cells["A" + index + ":G" + index].Style.Font.Bold = true;
                                    worksheet.Cells["A" + index + ":G" + index].Merge = true;

                                    worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["H" + index].Style.Font.Bold = true;
                                    worksheet.Cells["H" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBV);

                                    worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["J" + index].Style.Font.Bold = true;
                                    worksheet.Cells["J" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBH);

                                    worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["K" + index].Style.Font.Bold = true;
                                    worksheet.Cells["K" + index].Value = groupChiPhiBangKe.Sum(o => o.QuyBHYT);

                                    worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["L" + index].Style.Font.Bold = true;
                                    worksheet.Cells["L" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra);

                                    worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["M" + index].Style.Font.Bold = true;
                                    worksheet.Cells["M" + index].Value = groupChiPhiBangKe.Sum(o => o.Khac);

                                    worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["N" + index].Style.Font.Bold = true;
                                    worksheet.Cells["N" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra);

                                    index++;
                                    foreach (var chiPhiBangKe in groupGoiVatTu)
                                    {
                                        worksheet.Cells["A" + index + ":N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["A" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                        worksheet.Cells["A" + index + ":N" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));

                                        worksheet.Cells["A" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["A" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                        worksheet.Cells["A" + index].Value = indexItem;

                                        worksheet.Cells["B" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["B" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                        worksheet.Cells["B" + index].Value = chiPhiBangKe.NoiDung;

                                        worksheet.Cells["C" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["C" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                        worksheet.Cells["C" + index].Value = chiPhiBangKe.DonViTinh;

                                        worksheet.Cells["D" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["D" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                        worksheet.Cells["D" + index].Value = chiPhiBangKe.SoLuong;

                                        worksheet.Cells["E" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["E" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["E" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["E" + index].Value = chiPhiBangKe.DonGiaBV;

                                        worksheet.Cells["F" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["F" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["F" + index].Value = chiPhiBangKe.DonGiaBH;

                                        worksheet.Cells["G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["G" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["G" + index].Value = chiPhiBangKe.TiLeThanhToanTheoDV;

                                        worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["H" + index].Value = chiPhiBangKe.ThanhTienBV;

                                        worksheet.Cells["I" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["I" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["I" + index].Value = Convert.ToDouble(chiPhiBangKe.MucHuongBaoHiem > 0 ? 100 : 0).ApplyFormatMoneyToDouble();


                                        worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["J" + index].Value = chiPhiBangKe.ThanhTienBH;


                                        worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["K" + index].Value = chiPhiBangKe.QuyBHYT;


                                        worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["L" + index].Value = chiPhiBangKe.NguoiBenhCungChiTra;


                                        worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["M" + index].Value = chiPhiBangKe.Khac;


                                        worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["N" + index].Value = chiPhiBangKe.NguoiBenhTuTra;

                                        indexItem++;
                                        index++;
                                    }
                                }
                            }
                            else
                            {

                                foreach (var chiPhiBangKe in groupChiPhiBangKe)
                                {
                                    worksheet.Cells["A" + index + ":N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["A" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                    worksheet.Cells["A" + index + ":N" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));

                                    worksheet.Cells["A" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["A" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                    worksheet.Cells["A" + index].Value = indexItem;

                                    worksheet.Cells["B" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["B" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                    worksheet.Cells["B" + index].Value = chiPhiBangKe.NoiDung;

                                    worksheet.Cells["C" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["C" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                    worksheet.Cells["C" + index].Value = chiPhiBangKe.DonViTinh;

                                    worksheet.Cells["D" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["D" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                    worksheet.Cells["D" + index].Value = chiPhiBangKe.SoLuong;

                                    worksheet.Cells["E" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["E" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["E" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["E" + index].Value = chiPhiBangKe.DonGiaBV;

                                    worksheet.Cells["F" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["F" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["F" + index].Value = chiPhiBangKe.DonGiaBH;

                                    worksheet.Cells["G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["G" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["G" + index].Value = chiPhiBangKe.TiLeThanhToanTheoDV;

                                    worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["H" + index].Value = chiPhiBangKe.ThanhTienBV;

                                    worksheet.Cells["I" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["I" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["I" + index].Value = Convert.ToDouble(chiPhiBangKe.MucHuongBaoHiem > 0 ? 100 : 0).ApplyFormatMoneyToDouble();


                                    worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["J" + index].Value = chiPhiBangKe.ThanhTienBH;


                                    worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["K" + index].Value = chiPhiBangKe.QuyBHYT;


                                    worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["L" + index].Value = chiPhiBangKe.NguoiBenhCungChiTra;


                                    worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["M" + index].Value = chiPhiBangKe.Khac;


                                    worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["N" + index].Value = chiPhiBangKe.NguoiBenhTuTra;

                                    indexItem++;
                                    index++;
                                }
                            }

                        }


                        worksheet.Cells["A" + index + ":G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        worksheet.Cells["A" + index + ":G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        worksheet.Cells["A" + index + ":G" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                        worksheet.Cells["A" + index + ":G" + index].Merge = true;
                        worksheet.Cells["A" + index + ":G" + index].Value = "Tổng cộng";
                        worksheet.Cells["A" + index + ":G" + index].Style.Font.Bold = true;

                        worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                        worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                        worksheet.Cells["H" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.ThanhTienBV)).Sum();


                        worksheet.Cells["I" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        worksheet.Cells["I" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;

                        worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                        worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                        worksheet.Cells["J" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.ThanhTienBH)).Sum();

                        worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                        worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                        worksheet.Cells["K" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.QuyBHYT)).Sum();

                        worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                        worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                        worksheet.Cells["L" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.NguoiBenhCungChiTra)).Sum();

                        worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                        worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                        worksheet.Cells["M" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.Khac)).Sum();

                        worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                        worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                        worksheet.Cells["N" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.NguoiBenhTuTra)).Sum();

                        index++;

                        worksheet.Cells["A" + index + ":N" + index].Merge = true;
                        worksheet.Cells["A" + index + ":N" + index].Value = "Tổng chi phí lần khám bệnh/cả đợt điều trị: " + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + " đồng";
                        worksheet.Cells["A" + index + ":N" + index].Style.Font.Bold = true;

                        index++;

                        worksheet.Cells["A" + index + ":N" + index].Merge = true;
                        worksheet.Cells["A" + index + ":N" + index].Value = "(Viết bằng chữ: " + NumberHelper.ChuyenSoRaText(Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBV))) + ")";

                        index++;

                        worksheet.Cells["A" + index + ":N" + index].Merge = true;
                        worksheet.Cells["A" + index + ":N" + index].Value = "Trong đó , số tiền do:";
                        worksheet.Cells["A" + index + ":N" + index].Style.Font.Bold = true;

                        index++;
                        worksheet.Cells["A" + index + ":N" + index].Merge = true;
                        worksheet.Cells["A" + index + ":N" + index].Value = "- Quỹ BHYT thanh toán: " + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble();

                        var tongBHTN = Convert.ToDouble(danhSachTatCaChiPhi.Where(o => o.TrangThaiThanhToan != Enums.TrangThaiThanhToan.DaThanhToan).Sum(o => o.TongCongNo));
                        if (tongBHTN != 0)
                        {
                            index++;
                            worksheet.Cells["A" + index + ":N" + index].Merge = true;
                            worksheet.Cells["A" + index + ":N" + index].Value = "- BHTN bảo lãnh: " + Convert.ToDouble(tongBHTN).ApplyFormatMoneyToDouble();
                        }

                        index++;
                        var tongTamUng = GetSoTienDaTamUngAsync(yeuCauTiepNhanId).Result;
                        worksheet.Cells["A" + index + ":N" + index].Merge = true;
                        worksheet.Cells["A" + index + ":N" + index].Value = "- Tổng tạm ứng: " + Convert.ToDouble(tongTamUng).ApplyFormatMoneyToDouble();


                        index++;
                        worksheet.Cells["A" + index + ":N" + index].Merge = true;
                        worksheet.Cells["A" + index + ":N" + index].Value = "+ Nguồn khác: " + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble(true);


                        var tongQuyBHYTThanhToan = Convert.ToDouble(danhSachTatCaChiPhi.Where(o => o.TrangThaiThanhToan != TrangThaiThanhToan.DaThanhToan && o.KiemTraBHYTXacNhan).Sum(o => o.BHYTThanhToan));
                        var soTienCanThu = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBV)) - Convert.ToDouble(tongTamUng) - tongQuyBHYTThanhToan - tongBHTN - Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.Khac));
                        string soTienNBTuTraHoacTraLaiBN = soTienCanThu < 0 ? $"- Phải trả lại NB: {(soTienCanThu * (-1)).ApplyFormatMoneyToDouble()}" : $"- Người bệnh tự trả: {(soTienCanThu).ApplyFormatMoneyToDouble()}";

                        index++;

                        worksheet.Cells["A" + index + ":N" + index].Merge = true;
                        worksheet.Cells["A" + index + ":N" + index].Value = soTienNBTuTraHoacTraLaiBN;


                        index = index + 2;

                        worksheet.Cells["G" + index + ":N" + index].Style.Font.Bold = true;
                        worksheet.Cells["G" + index + ":N" + index].Merge = true;
                        worksheet.Cells["G" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        worksheet.Cells["G" + index + ":N" + index].Value = "XÁC NHẬN CỦA NGƯỜI BỆNH ";

                        index++;

                        worksheet.Cells["A" + index + ":F" + index].Style.Font.Bold = true;
                        worksheet.Cells["A" + index + ":F" + index].Merge = true;
                        worksheet.Cells["A" + index + ":F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        worksheet.Cells["A" + index + ":F" + index].Value = "NGƯỜI LẬP BẢNG KÊ";


                        worksheet.Cells["G" + index + ":N" + index].Style.Font.Bold = true;
                        worksheet.Cells["G" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        worksheet.Cells["G" + index + ":N" + index].Merge = true;
                        worksheet.Cells["G" + index + ":N" + index].Value = "(Ký , Ghi rõ họ tên)";

                        index++;

                        worksheet.Cells["A" + index + ":F" + index].Style.Font.Bold = true;
                        worksheet.Cells["A" + index + ":F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        worksheet.Cells["A" + index + ":F" + index].Merge = true;
                        worksheet.Cells["A" + index + ":F" + index].Value = "(Ký , Ghi rõ họ tên)";


                        worksheet.Cells["G" + index + ":N" + index].Style.Font.Bold = true;
                        worksheet.Cells["G" + index + ":N" + index].Merge = true;
                        worksheet.Cells["G" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        worksheet.Cells["G" + index + ":N" + index].Value = "(Tôi đã nhận...phim...Xquang / CT / MRI)";

                        xlPackage.Save();

                    }
                }

                return stream.ToArray();
            }
        }
        //BVHD-3938 Thêm bảng kê ngoài gói
        public void LoadBangKeNgoaiGoiChuaQuyetToan(ExcelWorksheet worksheet, YeuCauTiepNhan yeuCauTiepNhan, List<ChiPhiKhamChuaBenhNoiTruVo> danhSachTatCaChiPhi)
        {
            var danhSachChiPhi = danhSachTatCaChiPhi.Where(o => o.YeuCauGoiDichVuId == null && o.TrangThaiThanhToan != TrangThaiThanhToan.DaThanhToan).ToList();
            if (danhSachChiPhi.Count == 0)
            {
                return;
            }
            //var yeuCauTiepNhan = BaseRepository.GetById(yeuCauTiepNhanId,
            //    x => x.Include(o => o.NoiTruBenhAn).ThenInclude(o => o.ChuyenDenBenhVien)
            //        .Include(o => o.NoiTruBenhAn).ThenInclude(o => o.KhoaPhongNhapVien)
            //        .Include(o => o.NoiTruBenhAn).ThenInclude(o => o.ChanDoanChinhRaVienICD)
            //        .Include(o => o.YeuCauTiepNhanTheBHYTs)
            //        .Include(o => o.YeuCauNhapVien).ThenInclude(o => o.YeuCauKhamBenh).ThenInclude(o => o.YeuCauTiepNhan)
            //        .Include(o => o.BenhNhan)
            //        .Include(o => o.PhuongXa)
            //        .Include(o => o.QuanHuyen)
            //        .Include(o => o.TinhThanh)
            //        .Include(o => o.NoiTruBenhAn).ThenInclude(o => o.NoiTruPhieuDieuTris).ThenInclude(o => o.NoiTruThamKhamChanDoanKemTheos).ThenInclude(c => c.ICD)
            //        .Include(o => o.NoiTruBenhAn).ThenInclude(o => o.NoiTruPhieuDieuTris).ThenInclude(c => c.ChanDoanChinhICD)
            //        .Include(o => o.NoiChuyen).Include(o => o.NoiTruBenhAn).ThenInclude(o => o.NoiTruKhoaPhongDieuTris).ThenInclude(c => c.KhoaPhongChuyenDen));

            var benhVien = new Core.Domain.Entities.BenhVien.BenhVien();

            string maBHYT = string.Empty;
            string bHYTTuNgay = string.Empty;
            string bHYTDenNgay = string.Empty;
            string mucHuong = string.Empty;
            string NoiDKKCBBanDau = string.Empty;
            string MaKCBBanDau = string.Empty;


            string maICDKemTheo = string.Empty;
            string tenICDKemTheo = string.Empty;
            string chuanDoanXacDinhSanKhoa = string.Empty;
            string maICD10 = string.Empty;

            if (yeuCauTiepNhan.NoiTruBenhAn != null && (yeuCauTiepNhan.NoiTruBenhAn.LoaiBenhAn == LoaiBenhAn.SanKhoaMo || yeuCauTiepNhan.NoiTruBenhAn.LoaiBenhAn == LoaiBenhAn.SanKhoaThuong))
            {
                if (yeuCauTiepNhan.NoiTruBenhAn?.NoiTruPhieuDieuTris.Count() > 0)
                {
                    var phieuDieuTri = yeuCauTiepNhan.NoiTruBenhAn?.NoiTruPhieuDieuTris.OrderByDescending(c => c.NgayDieuTri).FirstOrDefault();

                    var icdKemTheoIds = phieuDieuTri.NoiTruThamKhamChanDoanKemTheos.Select(c => c.ICD.Ma);
                    var tenICDKemTheos = phieuDieuTri.NoiTruThamKhamChanDoanKemTheos.Select(c => c.GhiChu);

                    maICDKemTheo = string.Join(", ", icdKemTheoIds);
                    tenICDKemTheo = string.Join(", ", tenICDKemTheos);

                    maICD10 = phieuDieuTri.ChanDoanChinhICD?.Ma;
                    chuanDoanXacDinhSanKhoa = phieuDieuTri.ChanDoanChinhGhiChu;
                }
            }
            else
            {
                if (!string.IsNullOrEmpty(yeuCauTiepNhan.NoiTruBenhAn?.DanhSachChanDoanKemTheoRaVienICDId))
                {
                    var maICDKemTheos = new List<string>();

                    var icdKemTheoIds = yeuCauTiepNhan.NoiTruBenhAn?.DanhSachChanDoanKemTheoRaVienICDId.Split(Constants.ICDSeparator);
                    var tenICDKemTheos = yeuCauTiepNhan.NoiTruBenhAn?.DanhSachChanDoanKemTheoRaVienGhiChu?.Split(Constants.ICDSeparator);

                    if (icdKemTheoIds.Length > 0)
                    {
                        foreach (var icdKemTheoId in icdKemTheoIds)
                        {
                            var icdKemTheo = _icdRepository.TableNoTracking.FirstOrDefault(o => o.Id == long.Parse(icdKemTheoId));
                            if (icdKemTheo != null)
                            {
                                maICDKemTheos.Add(icdKemTheo.Ma);
                            }
                        }
                    }

                    maICDKemTheo = string.Join(", ", maICDKemTheos);
                    tenICDKemTheo = string.Join(", ", tenICDKemTheos);
                }
            }

            YeuCauTiepNhanTheBHYT theBHYT = null;
            if (yeuCauTiepNhan.CoBHYT == true && yeuCauTiepNhan.YeuCauTiepNhanTheBHYTs.Any())
            {
                theBHYT = yeuCauTiepNhan.YeuCauTiepNhanTheBHYTs.First();
                if (!String.IsNullOrEmpty(theBHYT.MaDKBD))
                {
                    benhVien = _benhVienRepository.TableNoTracking.FirstOrDefault(p => p.Ma.Equals(theBHYT.MaDKBD));
                }
                maBHYT = theBHYT.MaSoThe;
                bHYTTuNgay = theBHYT.NgayHieuLuc.ApplyFormatDate();
                bHYTDenNgay = theBHYT.NgayHetHan?.ApplyFormatDate();
                mucHuong = theBHYT.MucHuong.ToString() + "%";
                NoiDKKCBBanDau = benhVien != null ? benhVien?.Ten : "Chưa xác định";
                MaKCBBanDau = theBHYT.MaDKBD;
            }
            else
            {
                maBHYT = "";
                bHYTTuNgay = "";
                bHYTDenNgay = "";
                mucHuong = "0%";
                NoiDKKCBBanDau = "Chưa xác định";
                MaKCBBanDau = "Chưa xác định";
            }

            var dsChiPhiBangKe = new List<BangKeKhamBenhBenhVienVo>();
            var dateItemChiPhis = string.Empty;
            int indexItem = 1;
            //var worksheet = xlPackage.Workbook.Worksheets.Add("BẢNG KÊ CHI PHÍ ĐIỀU TRỊ NỘI TRÚ 3");
            //var worksheet = new ExcelWorksheet();
            // set row
            worksheet.Row(9).Height = 24.5;
            worksheet.DefaultRowHeight = 16;

            //SET chiều rộng cho từng cột tương ứng
            worksheet.Column(1).Width = 10;
            worksheet.Column(2).Width = 25;
            worksheet.Column(3).Width = 15;
            worksheet.Column(4).Width = 15;
            worksheet.Column(5).Width = 15;
            worksheet.Column(6).Width = 15;
            worksheet.Column(7).Width = 15;
            worksheet.Column(8).Width = 15;
            worksheet.Column(9).Width = 15;
            worksheet.Column(10).Width = 15;
            worksheet.Column(11).Width = 15;
            worksheet.Column(12).Width = 15;
            worksheet.Column(13).Width = 15;
            worksheet.Column(14).Width = 15;

            worksheet.DefaultColWidth = 7;

            using (var range = worksheet.Cells["A1:C1"])
            {
                range.Worksheet.Cells["A1:C1"].Merge = true;
                range.Worksheet.Cells["A1:C1"].Value = "CƠ SỞ KHÁM CHỮA BỆNH : BỆNH VIỆN ĐKQT BẮC HÀ";
                range.Worksheet.Cells["A1:C1"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                range.Worksheet.Cells["A1:C1"].Style.VerticalAlignment = ExcelVerticalAlignment.Bottom;
                range.Worksheet.Cells["A1:C1"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                range.Worksheet.Cells["A1:C1"].Style.Font.Color.SetColor(Color.Black);
                range.Worksheet.Cells["A1:C1"].Style.Font.Bold = true;
            }


            var khoaPhong = yeuCauTiepNhan.NoiTruBenhAn?.NoiTruKhoaPhongDieuTris.OrderByDescending(c => c.ThoiDiemVaoKhoa).Select(c => c.KhoaPhongChuyenDen).FirstOrDefault();
            var chuyenKhoa = GetChuyenKhoa(khoaPhong?.Id); //BVHD-3792 
            using (var range = worksheet.Cells["A2:C2"])
            {
                range.Worksheet.Cells["A2:C2"].Merge = true;
                range.Worksheet.Cells["A2:C2"].Value = "Khoa: " + khoaPhong?.Ten;
                range.Worksheet.Cells["A2:C2"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                range.Worksheet.Cells["A2:C2"].Style.VerticalAlignment = ExcelVerticalAlignment.Bottom;
                range.Worksheet.Cells["A2:C2"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                range.Worksheet.Cells["A2:C2"].Style.Font.Color.SetColor(Color.Black);
                range.Worksheet.Cells["A2:C2"].Style.Font.Bold = true;
            }

            using (var range = worksheet.Cells["A3:C3"])
            {
                range.Worksheet.Cells["A3:C3"].Merge = true;
                range.Worksheet.Cells["A3:C3"].Value = "Mã khoa: " + chuyenKhoa?.Ma;
                range.Worksheet.Cells["A3:C3"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                range.Worksheet.Cells["A3:C3"].Style.VerticalAlignment = ExcelVerticalAlignment.Bottom;
                range.Worksheet.Cells["A3:C3"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                range.Worksheet.Cells["A3:C3"].Style.Font.Color.SetColor(Color.Black);
                range.Worksheet.Cells["A3:C3"].Style.Font.Bold = true;
            }

            using (var range = worksheet.Cells["L1:N1"])
            {
                range.Worksheet.Cells["L1:N1"].Merge = true;
                range.Worksheet.Cells["L1:N1"].Value = "Mẫu số : 01/KBCB ";
                range.Worksheet.Cells["L1:N1"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                range.Worksheet.Cells["L1:N1"].Style.VerticalAlignment = ExcelVerticalAlignment.Bottom;
                range.Worksheet.Cells["L1:N1"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                range.Worksheet.Cells["L1:N1"].Style.Font.Color.SetColor(Color.Black);
                range.Worksheet.Cells["L1:N1"].Style.Font.Bold = true;
            }

            using (var range = worksheet.Cells["L2:N2"])
            {
                range.Worksheet.Cells["L2:N2"].Merge = true;
                range.Worksheet.Cells["L2:N2"].Value = "Mã số người bệnh: " + yeuCauTiepNhan.BenhNhan.MaBN;
                range.Worksheet.Cells["L2:N2"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                range.Worksheet.Cells["L2:N2"].Style.VerticalAlignment = ExcelVerticalAlignment.Bottom;
                range.Worksheet.Cells["L2:N2"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                range.Worksheet.Cells["L2:N2"].Style.Font.Color.SetColor(Color.Black);
                range.Worksheet.Cells["L2:N2"].Style.Font.Bold = true;
            }

            using (var range = worksheet.Cells["L3:N3"])
            {
                range.Worksheet.Cells["L3:N3"].Merge = true;
                range.Worksheet.Cells["L3:N3"].Value = "Số khám bệnh:" + yeuCauTiepNhan.MaYeuCauTiepNhan;
                range.Worksheet.Cells["L3:N3"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                range.Worksheet.Cells["L3:N3"].Style.VerticalAlignment = ExcelVerticalAlignment.Bottom;
                range.Worksheet.Cells["L3:N3"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                range.Worksheet.Cells["L3:N3"].Style.Font.Color.SetColor(Color.Black);
                range.Worksheet.Cells["L3:N3"].Style.Font.Bold = true;
            }

            using (var range = worksheet.Cells["L4:N4"])
            {
                range.Worksheet.Cells["L4:N4"].Merge = true;
                range.Worksheet.Cells["L4:N4"].Value = "Số bệnh án: " + yeuCauTiepNhan.NoiTruBenhAn?.SoBenhAn;
                range.Worksheet.Cells["L4:N4"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                range.Worksheet.Cells["L4:N4"].Style.VerticalAlignment = ExcelVerticalAlignment.Bottom;
                range.Worksheet.Cells["L4:N4"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                range.Worksheet.Cells["L4:N4"].Style.Font.Color.SetColor(Color.Black);
                range.Worksheet.Cells["L4:N4"].Style.Font.Bold = true;
            }

            using (var range = worksheet.Cells["A5:N6"])
            {
                range.Worksheet.Cells["A5:N6"].Merge = true;
                range.Worksheet.Cells["A5:N6"].Value = "BẢNG KÊ CHI PHÍ ĐIỀU TRỊ NỘI TRÚ (Ngoài gói)";
                range.Worksheet.Cells["A5:N6"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                range.Worksheet.Cells["A5:N6"].Style.VerticalAlignment = ExcelVerticalAlignment.Bottom;
                range.Worksheet.Cells["A5:N6"].Style.Font.SetFromFont(new Font("Times New Roman", 18));
                range.Worksheet.Cells["A5:N6"].Style.Font.Color.SetColor(Color.Black);
                range.Worksheet.Cells["A5:N6"].Style.Font.Bold = true;
            }

            using (var range = worksheet.Cells["A7:N7"])
            {
                range.Worksheet.Cells["A7:N7"].Merge = true;
                range.Worksheet.Cells["A7:N7"].Value = "I.Hành chính";
                range.Worksheet.Cells["A7:N7"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                range.Worksheet.Cells["A7:N7"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                range.Worksheet.Cells["A7:N7"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                range.Worksheet.Cells["A7:N7"].Style.Font.Color.SetColor(Color.Black);
                range.Worksheet.Cells["A7:N7"].Style.Font.Bold = true;
            }

            using (var range = worksheet.Cells["A8:F8"])
            {
                range.Worksheet.Cells["A8:F8"].Merge = true;

                range.Worksheet.Cells["A8:F8"].Style.WrapText = true;
                var title = range.Worksheet.Cells["A8:F8"].RichText.Add("(1) Họ tên người bệnh: ");
                var value = range.Worksheet.Cells["A8:F8"].RichText.Add(yeuCauTiepNhan.HoTen);
                value.Bold = true;

                range.Worksheet.Cells["A8:F8"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                range.Worksheet.Cells["A8:F8"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                range.Worksheet.Cells["A8:F8"].Style.Font.SetFromFont(new Font("Times New Roman", 11));


                range.Worksheet.Cells["A8:F8"].Style.Font.Color.SetColor(Color.Black);
            }

            using (var range = worksheet.Cells["G8:J8"])
            {
                range.Worksheet.Cells["G8:J8"].Merge = true;
                range.Worksheet.Cells["G8:J8"].Style.WrapText = true;
                var title = range.Worksheet.Cells["G8:J8"].RichText.Add("Ngày,tháng,năm sinh: ");
                var value = range.Worksheet.Cells["G8:J8"].RichText.Add(DateHelper.DOBFormat(yeuCauTiepNhan.NgaySinh, yeuCauTiepNhan.ThangSinh, yeuCauTiepNhan.NamSinh));
                value.Bold = true;

                range.Worksheet.Cells["G8:J8"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                range.Worksheet.Cells["G8:J8"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                range.Worksheet.Cells["G8:J8"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                range.Worksheet.Cells["G8:J8"].Style.Font.Color.SetColor(Color.Black);
            }

            var gioitinh = yeuCauTiepNhan.GioiTinh != null ? yeuCauTiepNhan.GioiTinh.GetDescription() : "";
            using (var range = worksheet.Cells["K8:N8"])
            {
                range.Worksheet.Cells["K8:N8"].Merge = true;

                range.Worksheet.Cells["K8:N8"].Style.WrapText = true;
                var title = range.Worksheet.Cells["K8:N8"].RichText.Add("Giới tính: ");
                var value = range.Worksheet.Cells["K8:N8"].RichText.Add(gioitinh);
                value.Bold = true;

                range.Worksheet.Cells["K8:N8"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                range.Worksheet.Cells["K8:N8"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                range.Worksheet.Cells["K8:N8"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                range.Worksheet.Cells["K8:N8"].Style.Font.Color.SetColor(Color.Black);
            }

            using (var range = worksheet.Cells["A9:F9"])
            {
                range.Worksheet.Cells["A9:F9"].Merge = true;

                range.Worksheet.Cells["A9:F9"].Style.WrapText = true;
                var title = range.Worksheet.Cells["A9:F9"].RichText.Add("(2)Địa chỉ hiện tại: ");
                var value = range.Worksheet.Cells["A9:F9"].RichText.Add(yeuCauTiepNhan.DiaChiDayDu);
                value.Bold = true;

                range.Worksheet.Cells["A9:F9"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                range.Worksheet.Cells["A9:F9"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                range.Worksheet.Cells["A9:F9"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                range.Worksheet.Cells["A9:F9"].Style.Font.Color.SetColor(Color.Black);
            }

            using (var range = worksheet.Cells["G9:J9"])
            {
                range.Worksheet.Cells["G9:J9"].Merge = true;

                range.Worksheet.Cells["G9:J9"].Style.WrapText = true;
                var title = range.Worksheet.Cells["G9:J9"].RichText.Add("(3)Mã khu vực(K1/K2/K3): ");
                var value = range.Worksheet.Cells["G9:J9"].RichText.Add(yeuCauTiepNhan.BHYTMaKhuVuc);
                value.Bold = true;

                range.Worksheet.Cells["G9:J9"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                range.Worksheet.Cells["G9:J9"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                range.Worksheet.Cells["G9:J9"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                range.Worksheet.Cells["G9:J9"].Style.Font.Color.SetColor(Color.Black);
            }

            using (var range = worksheet.Cells["A10:F10"])
            {
                range.Worksheet.Cells["A10:F10"].Merge = true;
                range.Worksheet.Cells["A10:F10"].Style.WrapText = true;

                var title = range.Worksheet.Cells["A10:F10"].RichText.Add("(4)Mã thẻ BHYT: ");
                var value = range.Worksheet.Cells["A10:F10"].RichText.Add(maBHYT);
                value.Bold = true;

                range.Worksheet.Cells["A10:F10"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                range.Worksheet.Cells["A10:F10"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                range.Worksheet.Cells["A10:F10"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                range.Worksheet.Cells["A10:F10"].Style.Font.Color.SetColor(Color.Black);
            }

            using (var range = worksheet.Cells["G10:J10"])
            {
                range.Worksheet.Cells["G10:J10"].Merge = true;
                range.Worksheet.Cells["G10:J10"].Style.WrapText = true;
                var title = range.Worksheet.Cells["G10:J10"].RichText.Add("Giá trị từ: ");
                var valuebHYTTuNgay = range.Worksheet.Cells["G10:J10"].RichText.Add(bHYTTuNgay);
                valuebHYTTuNgay.Bold = true;

                var den = range.Worksheet.Cells["G10:J10"].RichText.Add(" đến: ");
                den.Bold = false;
                var valuebHYTDenNgay = range.Worksheet.Cells["G10:J10"].RichText.Add(bHYTDenNgay);
                valuebHYTDenNgay.Bold = true;


                range.Worksheet.Cells["G10:J10"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                range.Worksheet.Cells["G10:J10"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                range.Worksheet.Cells["G10:J10"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                range.Worksheet.Cells["G10:J10"].Style.Font.Color.SetColor(Color.Black);
            }

            using (var range = worksheet.Cells["A11:F11"])
            {
                range.Worksheet.Cells["A11:F11"].Merge = true;

                range.Worksheet.Cells["A11:F11"].Style.WrapText = true;
                var title = range.Worksheet.Cells["A11:F11"].RichText.Add("(5)Nơi ĐK KCB ban đầu: ");
                var valueNoiDKKCBBanDau = range.Worksheet.Cells["A11:F11"].RichText.Add(NoiDKKCBBanDau);
                valueNoiDKKCBBanDau.Bold = true;

                range.Worksheet.Cells["A11:F11"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                range.Worksheet.Cells["A11:F11"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                range.Worksheet.Cells["A11:F11"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                range.Worksheet.Cells["A11:F11"].Style.Font.Color.SetColor(Color.Black);
            }

            using (var range = worksheet.Cells["G11:J11"])
            {
                range.Worksheet.Cells["G11:J11"].Merge = true;
                range.Worksheet.Cells["G11:J11"].Style.WrapText = true;
                var title = range.Worksheet.Cells["G11:J11"].RichText.Add("(6)Mã: ");
                var valueMaKCBBanDau = range.Worksheet.Cells["G11:J11"].RichText.Add(MaKCBBanDau);
                valueMaKCBBanDau.Bold = true;

                range.Worksheet.Cells["G11:J11"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                range.Worksheet.Cells["G11:J11"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                range.Worksheet.Cells["G11:J11"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                range.Worksheet.Cells["G11:J11"].Style.Font.Color.SetColor(Color.Black);
            }


            using (var range = worksheet.Cells["A12:F12"])
            {
                range.Worksheet.Cells["A12:F12"].Merge = true;

                range.Worksheet.Cells["A12:F12"].Style.WrapText = true;
                var title = range.Worksheet.Cells["A12:F12"].RichText.Add("(7)Đến Khám: ");
                var value = range.Worksheet.Cells["A12:F12"].RichText.Add(yeuCauTiepNhan.ThoiDiemTiepNhan.ApplyFormatGioPhutNgay());
                value.Bold = true;

                range.Worksheet.Cells["A12:F12"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                range.Worksheet.Cells["A12:F12"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                range.Worksheet.Cells["A12:F12"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                range.Worksheet.Cells["A12:F12"].Style.Font.Color.SetColor(Color.Black);
            }

            using (var range = worksheet.Cells["A13:F13"])
            {
                range.Worksheet.Cells["A13:F13"].Merge = true;

                range.Worksheet.Cells["A13:F13"].Style.WrapText = true;
                var title = range.Worksheet.Cells["A13:F13"].RichText.Add("(8)Điều trị ngoại trú/nội trú từ: ");
                var value = range.Worksheet.Cells["A13:F13"].RichText.Add(yeuCauTiepNhan.NoiTruBenhAn?.ThoiDiemNhapVien.ApplyFormatGioPhutNgay());
                value.Bold = true;

                range.Worksheet.Cells["A13:F13"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                range.Worksheet.Cells["A13:F13"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                range.Worksheet.Cells["A13:F13"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                range.Worksheet.Cells["A13:F13"].Style.Font.Color.SetColor(Color.Black);
            }

            using (var range = worksheet.Cells["A14:F14"])
            {
                range.Worksheet.Cells["A14:F14"].Merge = true;
                range.Worksheet.Cells["A14:F14"].Style.WrapText = true;
                var title = range.Worksheet.Cells["A14:F14"].RichText.Add("(9)Kết thúc khám/điều trị: ");
                var value = range.Worksheet.Cells["A14:F14"].RichText.Add(yeuCauTiepNhan.NoiTruBenhAn?.ThoiDiemRaVien?.ApplyFormatGioPhutNgay());
                value.Bold = true;


                range.Worksheet.Cells["A14:F14"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                range.Worksheet.Cells["A14:F14"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                range.Worksheet.Cells["A14:F14"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                range.Worksheet.Cells["A14:F14"].Style.Font.Color.SetColor(Color.Black);
            }

            using (var range = worksheet.Cells["G14:J14"])
            {
                range.Worksheet.Cells["G14:J14"].Merge = true;
                range.Worksheet.Cells["G14:J14"].Style.WrapText = true;
                var title = range.Worksheet.Cells["G14:J14"].RichText.Add("Tổng số ngày điều trị: ");
                var value = range.Worksheet.Cells["G14:J14"].RichText.Add(NoiTruBenhAnHelper.TinhSoNgayDieuTri(yeuCauTiepNhan.NoiTruBenhAn)?.ToString() ?? string.Empty);
                value.Bold = true;

                range.Worksheet.Cells["G14:J14"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                range.Worksheet.Cells["G14:J14"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                range.Worksheet.Cells["G14:J14"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                range.Worksheet.Cells["G14:J14"].Style.Font.Color.SetColor(Color.Black);
            }

            using (var range = worksheet.Cells["K14:N14"])
            {
                range.Worksheet.Cells["K14:N14"].Merge = true;

                range.Worksheet.Cells["K14:N14"].Style.WrapText = true;
                var title = range.Worksheet.Cells["K14:N14"].RichText.Add("(10)Tình trạng ra viện: ");
                var value = range.Worksheet.Cells["K14:N14"].RichText.Add((yeuCauTiepNhan.NoiTruBenhAn?.TinhTrangRaVien == EnumTinhTrangRaVien.RaVien && (yeuCauTiepNhan.NoiTruBenhAn?.KetQuaDieuTri == EnumKetQuaDieuTri.Do || yeuCauTiepNhan.NoiTruBenhAn?.KetQuaDieuTri == EnumKetQuaDieuTri.Khoi) ? 1 : 2).ToString());
                value.Bold = true;


                range.Worksheet.Cells["K14:N14"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                range.Worksheet.Cells["K14:N14"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                range.Worksheet.Cells["K14:N14"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                range.Worksheet.Cells["K14:N14"].Style.Font.Color.SetColor(Color.Black);
            }

            //=================================15=================================
            var coCapCuu = yeuCauTiepNhan.LyDoVaoVien == Enums.EnumLyDoVaoVien.CapCuu ? "X" : string.Empty;
            var coDungTuyen = yeuCauTiepNhan.LyDoVaoVien == Enums.EnumLyDoVaoVien.DungTuyen ? "X" : string.Empty;
            var coThongTuyen = yeuCauTiepNhan.LyDoVaoVien == Enums.EnumLyDoVaoVien.ThongTuyen ? "X" : string.Empty;
            var coTraiTuyen = yeuCauTiepNhan.LyDoVaoVien == Enums.EnumLyDoVaoVien.TraiTuyen ? "X" : string.Empty;

            using (var range = worksheet.Cells["A15:C15"])
            {
                range.Worksheet.Cells["A15:C15"].Merge = true;

                range.Worksheet.Cells["A15:C15"].Style.WrapText = true;
                var title = range.Worksheet.Cells["A15:C15"].RichText.Add("(11) Cấp cứu: ");
                var value = range.Worksheet.Cells["A15:C15"].RichText.Add(coCapCuu);
                value.Bold = true;

                range.Worksheet.Cells["A15:C15"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                range.Worksheet.Cells["A15:C15"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                range.Worksheet.Cells["A15:C15"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                range.Worksheet.Cells["A15:C15"].Style.Font.Color.SetColor(Color.Black);
            }

            using (var range = worksheet.Cells["D15:F15"])
            {
                range.Worksheet.Cells["D15:F15"].Merge = true;
                range.Worksheet.Cells["D15:F15"].Style.WrapText = true;
                var title = range.Worksheet.Cells["D15:F15"].RichText.Add("(12) Đúng tuyến: ");
                var value = range.Worksheet.Cells["D15:F15"].RichText.Add(coDungTuyen);
                value.Bold = true;

                range.Worksheet.Cells["D15:F15"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                range.Worksheet.Cells["D15:F15"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                range.Worksheet.Cells["D15:F15"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                range.Worksheet.Cells["D15:F15"].Style.Font.Color.SetColor(Color.Black);
            }

            using (var range = worksheet.Cells["G15:J15"])
            {
                range.Worksheet.Cells["G15:J15"].Merge = true;
                range.Worksheet.Cells["G15:J15"].Style.WrapText = true;
                var title = range.Worksheet.Cells["G15:J15"].RichText.Add("Nơi chuyến đến: ");
                var value = range.Worksheet.Cells["G15:J15"].RichText.Add(yeuCauTiepNhan.NoiChuyen?.Ten);
                value.Bold = true;
                range.Worksheet.Cells["G15:J15"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                range.Worksheet.Cells["G15:J15"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                range.Worksheet.Cells["G15:J15"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                range.Worksheet.Cells["G15:J15"].Style.Font.Color.SetColor(Color.Black);
            }

            using (var range = worksheet.Cells["K15:N15"])
            {
                range.Worksheet.Cells["K15:N15"].Merge = true;
                range.Worksheet.Cells["K15:N15"].Style.WrapText = true;
                var title = range.Worksheet.Cells["K15:N15"].RichText.Add("Nơi chuyển đi: ");
                var value = range.Worksheet.Cells["K15:N15"].RichText.Add(yeuCauTiepNhan.NoiTruBenhAn?.ChuyenDenBenhVien?.Ten);
                value.Bold = true;
                range.Worksheet.Cells["K15:N15"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                range.Worksheet.Cells["K15:N15"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                range.Worksheet.Cells["K15:N15"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                range.Worksheet.Cells["K15:N15"].Style.Font.Color.SetColor(Color.Black);
            }

            //=================================16=================================
            using (var range = worksheet.Cells["A16:C16"])
            {
                range.Worksheet.Cells["A16:C16"].Merge = true;
                range.Worksheet.Cells["A16:C16"].Style.WrapText = true;
                var title = range.Worksheet.Cells["A16:C16"].RichText.Add("(13)Thông tuyến: ");
                var value = range.Worksheet.Cells["A16:C16"].RichText.Add(coThongTuyen);
                value.Bold = true;
                range.Worksheet.Cells["A16:C16"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                range.Worksheet.Cells["A16:C16"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                range.Worksheet.Cells["A16:C16"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                range.Worksheet.Cells["A16:C16"].Style.Font.Color.SetColor(Color.Black);
            }

            using (var range = worksheet.Cells["D16:F16"])
            {
                range.Worksheet.Cells["D16:F16"].Merge = true;
                range.Worksheet.Cells["D16:F16"].Style.WrapText = true;
                var title = range.Worksheet.Cells["D16:F16"].RichText.Add("(14)Trái tuyến: ");
                var value = range.Worksheet.Cells["D16:F16"].RichText.Add(coTraiTuyen);
                value.Bold = true;

                range.Worksheet.Cells["D16:F16"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                range.Worksheet.Cells["D16:F16"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                range.Worksheet.Cells["D16:F16"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                range.Worksheet.Cells["D16:F16"].Style.Font.Color.SetColor(Color.Black);
            }

            //================================= 17 =================================

            var chuanDoanXacDinhStr = yeuCauTiepNhan.NoiTruBenhAn?.LoaiBenhAn == LoaiBenhAn.SanKhoaMo || yeuCauTiepNhan.NoiTruBenhAn?.LoaiBenhAn == LoaiBenhAn.SanKhoaThuong
                                                     ? chuanDoanXacDinhSanKhoa : yeuCauTiepNhan.NoiTruBenhAn?.ChanDoanChinhRaVienGhiChu;


            var iCD10 = yeuCauTiepNhan.NoiTruBenhAn?.LoaiBenhAn == LoaiBenhAn.SanKhoaMo || yeuCauTiepNhan.NoiTruBenhAn?.LoaiBenhAn == LoaiBenhAn.SanKhoaThuong
                                                       ? maICD10 : yeuCauTiepNhan.NoiTruBenhAn?.ChanDoanChinhRaVienICD?.Ma;


            using (var range = worksheet.Cells["A17:F17"])
            {
                range.Worksheet.Cells["A17:F17"].Merge = true;
                range.Worksheet.Cells["A17:F17"].Style.WrapText = true;
                var title = range.Worksheet.Cells["A17:F17"].RichText.Add("(15)Chẩn đoán xác định: ");
                var value = range.Worksheet.Cells["A17:F17"].RichText.Add(chuanDoanXacDinhStr);
                value.Bold = true;

                range.Worksheet.Cells["A17:F17"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                range.Worksheet.Cells["A17:F17"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                range.Worksheet.Cells["A17:F17"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                range.Worksheet.Cells["A17:F17"].Style.Font.Color.SetColor(Color.Black);
            }

            using (var range = worksheet.Cells["G17:N17"])
            {
                range.Worksheet.Cells["G17:N17"].Merge = true;

                range.Worksheet.Cells["G17:N17"].Style.WrapText = true;
                var title = range.Worksheet.Cells["G17:N17"].RichText.Add("(17) Mã bệnh: ");
                var value = range.Worksheet.Cells["G17:N17"].RichText.Add(iCD10);
                value.Bold = true;


                range.Worksheet.Cells["G17:N17"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                range.Worksheet.Cells["G17:N17"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                range.Worksheet.Cells["G17:N17"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                range.Worksheet.Cells["G17:N17"].Style.Font.Color.SetColor(Color.Black);
            }

            //================================= 18 =================================

            using (var range = worksheet.Cells["A18:F18"])
            {
                range.Worksheet.Cells["A18:F18"].Merge = true;
                range.Worksheet.Cells["A18:F18"].Style.WrapText = true;
                var title = range.Worksheet.Cells["A18:F18"].RichText.Add("(18)Bệnh kèm theo: ");
                var value = range.Worksheet.Cells["A18:F18"].RichText.Add(tenICDKemTheo);
                value.Bold = true;


                range.Worksheet.Cells["A18:F18"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                range.Worksheet.Cells["A18:F18"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                range.Worksheet.Cells["A18:F18"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                range.Worksheet.Cells["A18:F18"].Style.Font.Color.SetColor(Color.Black);
            }

            using (var range = worksheet.Cells["G18:N18"])
            {
                range.Worksheet.Cells["G18:N18"].Merge = true;
                range.Worksheet.Cells["G18:N18"].Style.WrapText = true;
                var title = range.Worksheet.Cells["G18:N18"].RichText.Add("(18)Mã bệnh kèm theo: ");
                var value = range.Worksheet.Cells["G18:N18"].RichText.Add(maICDKemTheo);
                value.Bold = true;


                range.Worksheet.Cells["G18:N18"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                range.Worksheet.Cells["G18:N18"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                range.Worksheet.Cells["G18:N18"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                range.Worksheet.Cells["G18:N18"].Style.Font.Color.SetColor(Color.Black);
            }

            //================================= 19 =================================

            using (var range = worksheet.Cells["A19:F19"])
            {
                range.Worksheet.Cells["A19:F19"].Merge = true;
                range.Worksheet.Cells["A19:F19"].Style.WrapText = true;
                var title = range.Worksheet.Cells["A19:F19"].RichText.Add("(19)Thời điểm đủ 05 năm liên tục từ ngày: ");
                var value = range.Worksheet.Cells["A19:F19"].RichText.Add(yeuCauTiepNhan.BHYTNgayDu5Nam?.ApplyFormatDate());
                value.Bold = true;


                range.Worksheet.Cells["A19:F19"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                range.Worksheet.Cells["A19:F19"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                range.Worksheet.Cells["A19:F19"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                range.Worksheet.Cells["A19:F19"].Style.Font.Color.SetColor(Color.Black);
            }

            using (var range = worksheet.Cells["G19:N19"])
            {
                range.Worksheet.Cells["G19:N19"].Merge = true;
                range.Worksheet.Cells["G19:N19"].Style.WrapText = true;
                var title = range.Worksheet.Cells["G19:N19"].RichText.Add("(20)Miễn cùng chi trả trong năm từ ngày: ");
                var value = range.Worksheet.Cells["G19:N19"].RichText.Add(yeuCauTiepNhan.BHYTNgayDuocMienCungChiTra?.ApplyFormatDate());
                value.Bold = true;

                range.Worksheet.Cells["G19:N19"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                range.Worksheet.Cells["G19:N19"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                range.Worksheet.Cells["G19:N19"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                range.Worksheet.Cells["G19:N19"].Style.Font.Color.SetColor(Color.Black);
            }

            //================================= 20 =================================

            using (var range = worksheet.Cells["A20:N20"])
            {
                range.Worksheet.Cells["A20:N20"].Merge = true;
                range.Worksheet.Cells["A20:N20"].Value = "II. Phần Chi phí khám bệnh, chữa bệnh";
                range.Worksheet.Cells["A20:N20"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                range.Worksheet.Cells["A20:N20"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                range.Worksheet.Cells["A20:N20"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                range.Worksheet.Cells["A20:N20"].Style.Font.Color.SetColor(Color.Black);
                range.Worksheet.Cells["A20:N20"].Style.Font.Bold = true;
            }

            int index = 21;

            var groupChiPhiTheoThe = danhSachChiPhi.GroupBy(o => o.MaSoTheBHYT);
            if (groupChiPhiTheoThe.Count() > 2 ||
                (groupChiPhiTheoThe.All(o => o.Key != string.Empty) && groupChiPhiTheoThe.Count() > 1))
            {
                var groupNgayPhatSinhTheoThe = groupChiPhiTheoThe.Where(o => o.Key != string.Empty).Select(o => new { o.Key, o.OrderBy(j => j.NgayPhatSinh).First().NgayPhatSinh }).OrderBy(o => o.NgayPhatSinh).ToArray();
                for (int i = 0; i < groupNgayPhatSinhTheoThe.Count(); i++)
                {
                    var ngayPhatSinhTheoThe = groupNgayPhatSinhTheoThe[i];
                    var theBHYTChiTra = yeuCauTiepNhan.YeuCauTiepNhanTheBHYTs.First(o => o.MaSoThe == ngayPhatSinhTheoThe.Key);
                    var chiPhis = groupChiPhiTheoThe.FirstOrDefault(o => o.Key == ngayPhatSinhTheoThe.Key).ToList();
                    DateTime? ngayPhatSinhTiepTheo = i < groupNgayPhatSinhTheoThe.Count() - 1
                        ? groupNgayPhatSinhTheoThe[i + 1].NgayPhatSinh
                        : null;
                    chiPhis.AddRange(groupChiPhiTheoThe.FirstOrDefault(o => o.Key == string.Empty).Where(j => (i == 0 || j.NgayPhatSinh >= ngayPhatSinhTheoThe.NgayPhatSinh) && (ngayPhatSinhTiepTheo != null && j.NgayPhatSinh < ngayPhatSinhTiepTheo)).ToList());
                    var mucHuongPT = theBHYTChiTra != null && theBHYTChiTra.MucHuong > 0 ? theBHYTChiTra?.MucHuong + "%" : string.Empty;

                    using (var range = worksheet.Cells["A" + index + ":C" + index])
                    {
                        range.Worksheet.Cells["A" + index + ":C" + index].Merge = true;
                        range.Worksheet.Cells["A" + index + ":C" + index].Style.WrapText = true;
                        var title = range.Worksheet.Cells["A" + index + ":C" + index].RichText.Add("Mã thẻ BHYT: ");
                        var value = range.Worksheet.Cells["A" + index + ":C" + index].RichText.Add(theBHYTChiTra.MaSoThe);
                        value.Bold = true;

                        range.Worksheet.Cells["A" + index + ":C" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A" + index + ":C" + index].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A" + index + ":C" + index].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A" + index + ":C" + index].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["D" + index + ":F" + index])
                    {
                        range.Worksheet.Cells["D" + index + ":F" + index].Merge = true;
                        range.Worksheet.Cells["D" + index + ":F" + index].Style.WrapText = true;
                        var title = range.Worksheet.Cells["D" + index + ":F" + index].RichText.Add("Giá trị từ: ");
                        var valuebHYTTuNgay = range.Worksheet.Cells["D" + index + ":F" + index].RichText.Add(theBHYTChiTra.NgayHieuLuc.ApplyFormatDate());
                        valuebHYTTuNgay.Bold = true;

                        var den = range.Worksheet.Cells["D" + index + ":F" + index].RichText.Add(" đến: ");
                        den.Bold = false;
                        var valuebHYTDenNgay = range.Worksheet.Cells["D" + index + ":F" + index].RichText.Add(theBHYTChiTra?.NgayHetHan?.ApplyFormatDate());
                        valuebHYTDenNgay.Bold = true;

                        range.Worksheet.Cells["D" + index + ":F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["D" + index + ":F" + index].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["D" + index + ":F" + index].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["D" + index + ":F" + index].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["G" + index + ":J" + index])
                    {
                        range.Worksheet.Cells["G" + index + ":J" + index].Merge = true;
                        range.Worksheet.Cells["G" + index + ":J" + index].Style.WrapText = true;
                        var title = range.Worksheet.Cells["G" + index + ":J" + index].RichText.Add("Mức hưởng: ");
                        var value = range.Worksheet.Cells["G" + index + ":J" + index].RichText.Add(mucHuongPT);
                        value.Bold = true;


                        range.Worksheet.Cells["G" + index + ":J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["G" + index + ":J" + index].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["G" + index + ":J" + index].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["G" + index + ":J" + index].Style.Font.Color.SetColor(Color.Black);
                    }

                    index++;

                    var indexTableFirst = index;
                    var indexTableLast = index + 1;

                    using (var range = worksheet.Cells["A" + indexTableFirst + ":N" + indexTableLast])
                    {
                        range.Worksheet.Cells["A" + indexTableFirst + ":N" + indexTableLast].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        range.Worksheet.Cells["A" + indexTableFirst + ":N" + indexTableLast].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A" + indexTableFirst + ":N" + indexTableLast].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                        range.Worksheet.Cells["A" + indexTableFirst + ":N" + indexTableLast].Style.Font.Color.SetColor(Color.Black);
                        range.Worksheet.Cells["A" + indexTableFirst + ":N" + indexTableLast].Style.Font.Bold = true;
                        range.Worksheet.Cells["A" + indexTableFirst + ":N" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);

                        range.Worksheet.Cells["A" + indexTableFirst + ":A" + indexTableLast].Merge = true;
                        range.Worksheet.Cells["A" + indexTableFirst + ":A" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        range.Worksheet.Cells["A" + indexTableFirst + ":A" + indexTableLast].Value = "STT";

                        range.Worksheet.Cells["B" + indexTableFirst + ":B" + indexTableLast].Merge = true;
                        range.Worksheet.Cells["B" + indexTableFirst + ":B" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        range.Worksheet.Cells["B" + indexTableFirst + ":B" + indexTableLast].Value = "Nội dung";

                        range.Worksheet.Cells["C" + indexTableFirst + ":C" + indexTableLast].Merge = true;
                        range.Worksheet.Cells["C" + indexTableFirst + ":C" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        range.Worksheet.Cells["C" + indexTableFirst + ":C" + indexTableLast].Value = "Đơn vị tính";

                        range.Worksheet.Cells["D" + indexTableFirst + ":D" + indexTableLast].Merge = true;
                        range.Worksheet.Cells["D" + indexTableFirst + ":D" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        range.Worksheet.Cells["D" + indexTableFirst + ":D" + indexTableLast].Value = "Số lượng";

                        range.Worksheet.Cells["E" + indexTableFirst + ":E" + indexTableLast].Merge = true;
                        range.Worksheet.Cells["E" + indexTableFirst + ":E" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        range.Worksheet.Cells["E" + indexTableFirst + ":E" + indexTableLast].Value = "Đơn giá BV(đồng)";

                        range.Worksheet.Cells["F" + indexTableFirst + ":F" + indexTableLast].Merge = true;
                        range.Worksheet.Cells["F" + indexTableFirst + ":F" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        range.Worksheet.Cells["F" + indexTableFirst + ":F" + indexTableLast].Value = "Đơn giá BH(đồng)";

                        range.Worksheet.Cells["G" + indexTableFirst + ":G" + indexTableLast].Merge = true;
                        range.Worksheet.Cells["G" + indexTableFirst + ":G" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        range.Worksheet.Cells["G" + indexTableFirst + ":G" + indexTableLast].Value = "Tỉ lệ thanh toán theo dịch vụ (%)";

                        range.Worksheet.Cells["H" + indexTableFirst + ":H" + indexTableLast].Merge = true;
                        range.Worksheet.Cells["H" + indexTableFirst + ":H" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        range.Worksheet.Cells["H" + indexTableFirst + ":H" + indexTableLast].Value = "Thành tiền BV (đồng)";

                        range.Worksheet.Cells["I" + indexTableFirst + ":I" + indexTableLast].Merge = true;
                        range.Worksheet.Cells["I" + indexTableFirst + ":I" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        range.Worksheet.Cells["I" + indexTableFirst + ":I" + indexTableLast].Value = "Tỷ lệ thanh toán BHYT (%)";

                        range.Worksheet.Cells["J" + indexTableFirst + ":J" + indexTableLast].Merge = true;
                        range.Worksheet.Cells["J" + indexTableFirst + ":J" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        range.Worksheet.Cells["J" + indexTableFirst + ":J" + indexTableLast].Value = "Thành tiền BH(đồng)";

                        range.Worksheet.Cells["K" + indexTableFirst + ":N" + indexTableFirst].Merge = true;
                        range.Worksheet.Cells["K" + indexTableFirst + ":N" + indexTableFirst].Value = "Nguồn thanh toán (đồng)";

                        range.Worksheet.Cells["K" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        range.Worksheet.Cells["K" + indexTableLast].Value = "Quỹ BHYT";

                        range.Worksheet.Cells["L" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        range.Worksheet.Cells["L" + indexTableLast].Value = "Người bệnh cùng chi trả (đồng)";

                        range.Worksheet.Cells["M" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        range.Worksheet.Cells["M" + indexTableLast].Value = "Khác (đồng)";

                        range.Worksheet.Cells["N" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        range.Worksheet.Cells["N" + indexTableLast].Value = "Người bệnh tự trả(đồng)";
                    }

                    index = indexTableLast + 1;


                    var dsChiPhiBangKeTheoThe = new List<BangKeKhamBenhBenhVienVo>();

                    foreach (var chiPhi in chiPhis.Where(c => c.NhomChiPhiBangKe != NhomChiPhiBangKe.GoiVatTu && c.YeuCauGoiDichVuId == null).GroupBy(c => new { c.DonGia, c.SoTienMG, KhongTinhPhi = c.KhongTinhPhi.GetValueOrDefault(), c.NhomChiPhiBangKe, c.TenDichVu, c.DonViTinh, c.DuocHuongBHYT, c.DonGiaBHYT, c.MucHuongBaoHiem, c.TiLeBaoHiemThanhToan }).OrderByDescending(o => o.Key.DuocHuongBHYT))
                    {
                        var chiphiBangKe = new BangKeKhamBenhBenhVienVo
                        {
                            Nhom = chiPhi.Key.NhomChiPhiBangKe,
                            Id = chiPhi.FirstOrDefault().Id,
                            NoiDung = chiPhi.Key.TenDichVu,
                            DonViTinh = chiPhi.Key.DonViTinh,
                            SoLuong = (decimal)chiPhi.Sum(c => c.Soluong),
                            DuocHuongBaoHiem = chiPhi.Key.DuocHuongBHYT,
                            //BẢNG KÊ CHI TIẾT ĐIỀU TRỊ NỘI TRÚ (Ngoài gói) DonGiaBH mặc định = 0
                            DonGiaBH = 0,
                            MucHuongBaoHiem = 0,
                            TiLeThanhToanTheoDV = 0,
                            BaoHiemChiTra = true,
                            DonGiaBV = chiPhi.Key.DonGia
                        };
                        if (chiPhi.Key.KhongTinhPhi == true)
                        {
                            chiphiBangKe.Khac = chiPhi.Key.MucHuongBaoHiem > 0
                                ? (chiphiBangKe.ThanhTienBV.GetValueOrDefault() - chiphiBangKe.ThanhTienBH.GetValueOrDefault())
                                : chiphiBangKe.ThanhTienBV.GetValueOrDefault();
                        }
                        else
                        {
                            chiphiBangKe.Khac = chiPhi.Sum(c => c.SoTienMG);
                        }
                        dsChiPhiBangKeTheoThe.Add(chiphiBangKe);
                    }

                    foreach (var chiPhi in chiPhis.Where(c => !(c.NhomChiPhiBangKe != NhomChiPhiBangKe.GoiVatTu && c.YeuCauGoiDichVuId == null)))
                    {
                        var chiphiBangKe = new BangKeKhamBenhBenhVienVo
                        {
                            Nhom = chiPhi.NhomChiPhiBangKe,
                            Id = chiPhi.Id,
                            NoiDung = chiPhi.TenDichVu,
                            DonViTinh = chiPhi.DonViTinh,
                            SoLuong = (decimal)chiPhi.Soluong,
                            DuocHuongBaoHiem = chiPhi.DuocHuongBHYT,
                            //BẢNG KÊ CHI TIẾT ĐIỀU TRỊ NỘI TRÚ (Ngoài gói) DonGiaBH mặc định = 0
                            DonGiaBH = 0,
                            MucHuongBaoHiem = 0,
                            TiLeThanhToanTheoDV = 0,
                            BaoHiemChiTra = true,
                            DonGiaBV = chiPhi.DonGia
                        };
                        if (chiPhi.KhongTinhPhi == true || chiPhi.YeuCauGoiDichVuId != null)
                        {
                            chiphiBangKe.Khac = chiPhi.MucHuongBaoHiem > 0
                                ? (chiphiBangKe.ThanhTienBV.GetValueOrDefault() - chiphiBangKe.ThanhTienBH.GetValueOrDefault())
                                : chiphiBangKe.ThanhTienBV.GetValueOrDefault();
                        }
                        else
                        {
                            chiphiBangKe.Khac = chiPhi.SoTienMG;
                        }
                        dsChiPhiBangKeTheoThe.Add(chiphiBangKe);
                    }
                    dsChiPhiBangKe.AddRange(dsChiPhiBangKeTheoThe);
                    var groupChiPhiBangKes = dsChiPhiBangKeTheoThe.GroupBy(x => x.Nhom).OrderBy(o => (int)o.Key * (o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay || o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriNoiTru ? 1 : 10));
                    foreach (var groupChiPhiBangKe in groupChiPhiBangKes)
                    {
                        if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay)
                        {

                            worksheet.Cells["A" + index + ":N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["A" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                            worksheet.Cells["A" + index + ":N" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                            worksheet.Cells["A" + index + ":N" + index].Merge = true;
                            worksheet.Cells["A" + index + ":N" + index].Value = "2. Ngày giường:";
                            worksheet.Cells["A" + index + ":N" + index].Style.Font.Bold = true;

                            index++;

                            worksheet.Cells["A" + index + ":G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["A" + index + ":G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                            worksheet.Cells["A" + index + ":G" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                            worksheet.Cells["A" + index + ":G" + index].Merge = true;
                            worksheet.Cells["A" + index + ":G" + index].Value = "2.1." + groupChiPhiBangKe.Key.GetDescription();
                            worksheet.Cells["A" + index + ":G" + index].Style.Font.Bold = true;

                            worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                            worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                            worksheet.Cells["H" + index].Style.Font.Bold = true;
                            worksheet.Cells["H" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBV);

                            worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                            worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                            worksheet.Cells["J" + index].Style.Font.Bold = true;
                            worksheet.Cells["J" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBH);

                            worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                            worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                            worksheet.Cells["K" + index].Style.Font.Bold = true;
                            worksheet.Cells["K" + index].Value = groupChiPhiBangKe.Sum(o => o.QuyBHYT);

                            worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                            worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                            worksheet.Cells["L" + index].Style.Font.Bold = true;
                            worksheet.Cells["L" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra);

                            worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                            worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                            worksheet.Cells["M" + index].Style.Font.Bold = true;
                            worksheet.Cells["M" + index].Value = groupChiPhiBangKe.Sum(o => o.Khac);

                            worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                            worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                            worksheet.Cells["N" + index].Style.Font.Bold = true;
                            worksheet.Cells["N" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra);

                            index++;
                        }
                        else if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.NgayGiuongDieuTriNoiTru)
                        {
                            if (!groupChiPhiBangKes.Any(o => o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay))
                            {
                                worksheet.Cells["A" + index + ":N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["A" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                worksheet.Cells["A" + index + ":N" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                worksheet.Cells["A" + index + ":N" + index].Merge = true;
                                worksheet.Cells["A" + index + ":N" + index].Value = "2. Ngày giường:";
                                worksheet.Cells["A" + index + ":N" + index].Style.Font.Bold = true;

                            }
                            index++;

                            worksheet.Cells["A" + index + ":G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["A" + index + ":G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                            worksheet.Cells["A" + index + ":G" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                            worksheet.Cells["A" + index + ":G" + index].Merge = true;
                            worksheet.Cells["A" + index + ":G" + index].Value = "2.2." + groupChiPhiBangKe.Key.GetDescription();
                            worksheet.Cells["A" + index + ":G" + index].Style.Font.Bold = true;

                            worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                            worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                            worksheet.Cells["H" + index].Style.Font.Bold = true;
                            worksheet.Cells["H" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBV);

                            worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                            worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                            worksheet.Cells["J" + index].Style.Font.Bold = true;
                            worksheet.Cells["J" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBH);

                            worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                            worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                            worksheet.Cells["K" + index].Style.Font.Bold = true;
                            worksheet.Cells["K" + index].Value = groupChiPhiBangKe.Sum(o => o.QuyBHYT);

                            worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                            worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                            worksheet.Cells["L" + index].Style.Font.Bold = true;
                            worksheet.Cells["L" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra);

                            worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                            worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                            worksheet.Cells["M" + index].Style.Font.Bold = true;
                            worksheet.Cells["M" + index].Value = groupChiPhiBangKe.Sum(o => o.Khac);

                            worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                            worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                            worksheet.Cells["N" + index].Style.Font.Bold = true;
                            worksheet.Cells["N" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra);

                            index++;
                        }
                        else
                        {
                            worksheet.Cells["A" + index + ":G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["A" + index + ":G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                            worksheet.Cells["A" + index + ":G" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                            worksheet.Cells["A" + index + ":G" + index].Merge = true;
                            worksheet.Cells["A" + index + ":G" + index].Value = (int)groupChiPhiBangKe.Key + "." + groupChiPhiBangKe.Key.GetDescription();
                            worksheet.Cells["A" + index + ":G" + index].Style.Font.Bold = true;

                            worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                            worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                            worksheet.Cells["H" + index].Style.Font.Bold = true;
                            worksheet.Cells["H" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBV);

                            worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                            worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                            worksheet.Cells["J" + index].Style.Font.Bold = true;
                            worksheet.Cells["J" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBH);

                            worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                            worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                            worksheet.Cells["K" + index].Style.Font.Bold = true;
                            worksheet.Cells["K" + index].Value = groupChiPhiBangKe.Sum(o => o.QuyBHYT);

                            worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                            worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                            worksheet.Cells["L" + index].Style.Font.Bold = true;
                            worksheet.Cells["L" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra);

                            worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                            worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                            worksheet.Cells["M" + index].Style.Font.Bold = true;
                            worksheet.Cells["M" + index].Value = groupChiPhiBangKe.Sum(o => o.Khac);

                            worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                            worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                            worksheet.Cells["N" + index].Style.Font.Bold = true;
                            worksheet.Cells["N" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra);

                            index++;
                        }
                        if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.GoiVatTu)
                        {
                            var groupGoiVatTus = groupChiPhiBangKe.ToList().GroupBy(o => o.SoGoiVatTu.GetValueOrDefault()).OrderBy(o => o.Key);
                            int sttGoiVatTu = 1;
                            foreach (var groupGoiVatTu in groupGoiVatTus)
                            {
                                worksheet.Cells["A" + index + ":G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["A" + index + ":G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                worksheet.Cells["A" + index + ":G" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                worksheet.Cells["A" + index + ":G" + index].Value = "10." + sttGoiVatTu + ". " + groupChiPhiBangKe.Key.GetDescription() + " " + sttGoiVatTu;
                                worksheet.Cells["A" + index + ":G" + index].Style.Font.Bold = true;
                                worksheet.Cells["A" + index + ":G" + index].Merge = true;

                                worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["H" + index].Style.Font.Bold = true;
                                worksheet.Cells["H" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBV);

                                worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["J" + index].Style.Font.Bold = true;
                                worksheet.Cells["J" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBH);

                                worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["K" + index].Style.Font.Bold = true;
                                worksheet.Cells["K" + index].Value = groupChiPhiBangKe.Sum(o => o.QuyBHYT);

                                worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["L" + index].Style.Font.Bold = true;
                                worksheet.Cells["L" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra);

                                worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["M" + index].Style.Font.Bold = true;
                                worksheet.Cells["M" + index].Value = groupChiPhiBangKe.Sum(o => o.Khac);

                                worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["N" + index].Style.Font.Bold = true;
                                worksheet.Cells["N" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra);

                                index++;

                                foreach (var chiPhiBangKe in groupGoiVatTu)
                                {
                                    worksheet.Cells["A" + index + ":N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["A" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                    worksheet.Cells["A" + index + ":N" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));

                                    worksheet.Cells["A" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["A" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                    worksheet.Cells["A" + index].Value = indexItem;

                                    worksheet.Cells["B" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["B" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                    worksheet.Cells["B" + index].Value = chiPhiBangKe.NoiDung;

                                    worksheet.Cells["C" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["C" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                    worksheet.Cells["C" + index].Value = chiPhiBangKe.DonViTinh;

                                    worksheet.Cells["D" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["D" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                    worksheet.Cells["D" + index].Value = chiPhiBangKe.SoLuong;

                                    worksheet.Cells["E" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["E" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["E" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["E" + index].Value = chiPhiBangKe.DonGiaBV;

                                    worksheet.Cells["F" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["F" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["F" + index].Value = chiPhiBangKe.DonGiaBH;

                                    worksheet.Cells["G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["G" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["G" + index].Value = chiPhiBangKe.TiLeThanhToanTheoDV;

                                    worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["H" + index].Value = chiPhiBangKe.ThanhTienBV;

                                    worksheet.Cells["I" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["I" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["I" + index].Value = Convert.ToDouble(chiPhiBangKe.MucHuongBaoHiem > 0 ? 100 : 0).ApplyFormatMoneyToDouble();


                                    worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["J" + index].Value = chiPhiBangKe.ThanhTienBH;


                                    worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["K" + index].Value = chiPhiBangKe.QuyBHYT;


                                    worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["L" + index].Value = chiPhiBangKe.NguoiBenhCungChiTra;


                                    worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["M" + index].Value = chiPhiBangKe.Khac;


                                    worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["N" + index].Value = chiPhiBangKe.NguoiBenhTuTra;

                                    indexItem++;
                                    index++;
                                }
                            }
                        }
                        else
                        {
                            foreach (var chiPhiBangKe in groupChiPhiBangKe)
                            {
                                worksheet.Cells["A" + index + ":N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["A" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                worksheet.Cells["A" + index + ":N" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));

                                worksheet.Cells["A" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["A" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                worksheet.Cells["A" + index].Value = indexItem;

                                worksheet.Cells["B" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["B" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                worksheet.Cells["B" + index].Value = chiPhiBangKe.NoiDung;

                                worksheet.Cells["C" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["C" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                worksheet.Cells["C" + index].Value = chiPhiBangKe.DonViTinh;

                                worksheet.Cells["D" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["D" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                worksheet.Cells["D" + index].Value = chiPhiBangKe.SoLuong;

                                worksheet.Cells["E" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["E" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["E" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["E" + index].Value = chiPhiBangKe.DonGiaBV;

                                worksheet.Cells["F" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["F" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["F" + index].Value = chiPhiBangKe.DonGiaBH;

                                worksheet.Cells["G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["G" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["G" + index].Value = chiPhiBangKe.TiLeThanhToanTheoDV;

                                worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["H" + index].Value = chiPhiBangKe.ThanhTienBV;

                                worksheet.Cells["I" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["I" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["I" + index].Value = Convert.ToDouble(chiPhiBangKe.MucHuongBaoHiem > 0 ? 100 : 0).ApplyFormatMoneyToDouble();


                                worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["J" + index].Value = chiPhiBangKe.ThanhTienBH;


                                worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["K" + index].Value = chiPhiBangKe.QuyBHYT;


                                worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["L" + index].Value = chiPhiBangKe.NguoiBenhCungChiTra;


                                worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["M" + index].Value = chiPhiBangKe.Khac;


                                worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["N" + index].Value = chiPhiBangKe.NguoiBenhTuTra;

                                indexItem++;
                                index++;
                            }
                        }

                    }
                    worksheet.Cells["A" + index + ":G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                    worksheet.Cells["A" + index + ":G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                    worksheet.Cells["A" + index + ":G" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                    worksheet.Cells["A" + index + ":G" + index].Merge = true;
                    worksheet.Cells["A" + index + ":G" + index].Value = "Tổng cộng";
                    worksheet.Cells["A" + index + ":G" + index].Style.Font.Bold = true;

                    worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                    worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                    worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                    worksheet.Cells["H" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.ThanhTienBV)).Sum();

                    worksheet.Cells["I" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                    worksheet.Cells["I" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;

                    worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                    worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                    worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                    worksheet.Cells["J" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.ThanhTienBH)).Sum();

                    worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                    worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                    worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                    worksheet.Cells["K" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.QuyBHYT)).Sum();

                    worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                    worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                    worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                    worksheet.Cells["L" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.NguoiBenhCungChiTra)).Sum();

                    worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                    worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                    worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                    worksheet.Cells["M" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.Khac)).Sum();

                    worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                    worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                    worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                    worksheet.Cells["N" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.NguoiBenhTuTra)).Sum();

                    index++;

                    worksheet.Cells["A" + index + ":N" + index].Merge = true;
                    worksheet.Cells["A" + index + ":N" + index].Value = "Tổng chi phí lần khám bệnh/cả đợt điều trị: " + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + " đồng";
                    worksheet.Cells["A" + index + ":N" + index].Style.Font.Bold = true;

                    index++;

                    worksheet.Cells["A" + index + ":N" + index].Merge = true;
                    worksheet.Cells["A" + index + ":N" + index].Value = "(Viết bằng chữ: " + NumberHelper.ChuyenSoRaText(Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBV))) + ")";

                    index++;

                    worksheet.Cells["A" + index + ":N" + index].Merge = true;
                    worksheet.Cells["A" + index + ":N" + index].Value = "Trong đó , số tiền do:";
                    worksheet.Cells["A" + index + ":N" + index].Style.Font.Bold = true;

                    index++;
                    worksheet.Cells["A" + index + ":N" + index].Merge = true;
                    worksheet.Cells["A" + index + ":N" + index].Value = "- Quỹ BHYT thanh toán: " + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble();

                    index++;
                    worksheet.Cells["A" + index + ":N" + index].Merge = true;
                    worksheet.Cells["A" + index + ":N" + index].Value = "- Người bệnh trả trong đó: " + (Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)) + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhTuTra))).ApplyFormatMoneyToDouble();

                    index++;
                    worksheet.Cells["A" + index + ":N" + index].Merge = true;
                    worksheet.Cells["A" + index + ":N" + index].Value = "+ Cùng chi trả trong phạm vi BHYT: " + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble(true);

                    index++;
                    worksheet.Cells["A" + index + ":N" + index].Merge = true;
                    worksheet.Cells["A" + index + ":N" + index].Value = "+ Các khoản phải trả khác: " + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true);

                    index++;
                    worksheet.Cells["A" + index + ":N" + index].Merge = true;
                    worksheet.Cells["A" + index + ":N" + index].Value = "+ Nguồn khác: " + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble(true);


                    index = index + 2;

                    //worksheet.Cells["D" + index + ":F" + index].Style.Font.SetFromFont(new Font("Times New Roman", 12));
                    //worksheet.Cells["D" + index + ":F" + index].Merge = true;
                    //worksheet.Cells["D" + index + ":F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                    //worksheet.Cells["D" + index + ":F" + index].Style.VerticalAlignment = ExcelVerticalAlignment.Top;
                    //worksheet.Cells["D" + index + ":F" + index].Value = $"Ngày {DateTime.Now.Day} tháng {DateTime.Now.Month} năm {DateTime.Now.Year}";

                    //worksheet.Cells["G" + index + ":I" + index].Style.Font.SetFromFont(new Font("Times New Roman", 12));
                    //worksheet.Cells["G" + index + ":I" + index].Merge = true;
                    //worksheet.Cells["G" + index + ":I" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                    //worksheet.Cells["G" + index + ":I" + index].Style.VerticalAlignment = ExcelVerticalAlignment.Top;
                    //worksheet.Cells["G" + index + ":I" + index].Value = $"Ngày {DateTime.Now.Day} tháng {DateTime.Now.Month} năm {DateTime.Now.Year}";

                    //worksheet.Cells["J" + index + ":N" + index].Style.Font.Bold = true;
                    //worksheet.Cells["J" + index + ":N" + index].Merge = true;
                    //worksheet.Cells["J" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                    //worksheet.Cells["J" + index + ":N" + index].Value = "XÁC NHẬN CỦA NGƯỜI BỆNH ";

                    worksheet.Cells["J" + index + ":N" + index].Style.Font.SetFromFont(new Font("Times New Roman", 12));
                    worksheet.Cells["J" + index + ":N" + index].Style.Font.Italic = true;
                    worksheet.Cells["J" + index + ":N" + index].Merge = true;
                    worksheet.Cells["J" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                    worksheet.Cells["J" + index + ":N" + index].Style.VerticalAlignment = ExcelVerticalAlignment.Top;
                    worksheet.Cells["J" + index + ":N" + index].Value = $"Ngày {DateTime.Now.Day} tháng {DateTime.Now.Month} năm {DateTime.Now.Year}";

                    index++;

                    //worksheet.Cells["A" + index + ":C" + index].Style.Font.Bold = true;
                    //worksheet.Cells["A" + index + ":C" + index].Merge = true;
                    //worksheet.Cells["A" + index + ":C" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                    //worksheet.Cells["A" + index + ":C" + index].Value = "NGƯỜI LẬP BẢNG KÊ";

                    //worksheet.Cells["D" + index + ":F" + index].Style.Font.Bold = true;
                    //worksheet.Cells["D" + index + ":F" + index].Merge = true;
                    //worksheet.Cells["D" + index + ":F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                    //worksheet.Cells["D" + index + ":F" + index].Value = "KẾ TOÁN VIỆN PHÍ";

                    //worksheet.Cells["G" + index + ":I" + index].Style.Font.Bold = true;
                    //worksheet.Cells["G" + index + ":I" + index].Merge = true;
                    //worksheet.Cells["G" + index + ":I" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                    //worksheet.Cells["G" + index + ":I" + index].Value = "GIÁM ĐỊNH BHYT";

                    //worksheet.Cells["J" + index + ":N" + index].Style.Font.Bold = true;
                    //worksheet.Cells["J" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                    //worksheet.Cells["J" + index + ":N" + index].Merge = true;
                    //worksheet.Cells["J" + index + ":N" + index].Value = "(Ký , Ghi rõ họ tên)";

                    worksheet.Cells["A" + index + ":C" + index].Style.Font.SetFromFont(new Font("Times New Roman", 12));
                    worksheet.Cells["A" + index + ":C" + index].Style.Font.Bold = true;
                    worksheet.Cells["A" + index + ":C" + index].Merge = true;
                    worksheet.Cells["A" + index + ":C" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                    worksheet.Cells["A" + index + ":C" + index].Value = "NGƯỜI LẬP BẢNG KÊ";

                    worksheet.Cells["E" + index + ":H" + index].Style.Font.SetFromFont(new Font("Times New Roman", 12));
                    worksheet.Cells["E" + index + ":H" + index].Style.Font.Bold = true;
                    worksheet.Cells["E" + index + ":H" + index].Merge = true;
                    worksheet.Cells["E" + index + ":H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                    worksheet.Cells["E" + index + ":H" + index].Value = "KẾ TOÁN VIỆN PHÍ";

                    worksheet.Cells["J" + index + ":N" + index].Style.Font.SetFromFont(new Font("Times New Roman", 12));
                    worksheet.Cells["J" + index + ":N" + index].Style.Font.Bold = true;
                    worksheet.Cells["J" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                    worksheet.Cells["J" + index + ":N" + index].Merge = true;
                    worksheet.Cells["J" + index + ":N" + index].Value = "XÁC NHẬN CỦA NGƯỜI BỆNH";

                    index++;

                    //worksheet.Cells["A" + index + ":C" + index].Style.Font.Bold = true;
                    //worksheet.Cells["A" + index + ":C" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                    //worksheet.Cells["A" + index + ":C" + index].Merge = true;
                    //worksheet.Cells["A" + index + ":C" + index].Value = "(Ký, Ghi rõ họ tên)";


                    //worksheet.Cells["D" + index + ":F" + index].Style.Font.Bold = true;
                    //worksheet.Cells["D" + index + ":F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                    //worksheet.Cells["D" + index + ":F" + index].Merge = true;
                    //worksheet.Cells["D" + index + ":F" + index].Value = "(Ký, Ghi rõ họ tên)";

                    //worksheet.Cells["G" + index + ":I" + index].Style.Font.Bold = true;
                    //worksheet.Cells["G" + index + ":I" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                    //worksheet.Cells["G" + index + ":I" + index].Merge = true;
                    //worksheet.Cells["G" + index + ":I" + index].Value = "(Ký, Ghi rõ họ tên)";

                    //worksheet.Cells["J" + index + ":N" + index].Style.Font.Bold = true;
                    //worksheet.Cells["J" + index + ":N" + index].Merge = true;
                    //worksheet.Cells["J" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                    //worksheet.Cells["J" + index + ":N" + index].Value = "(Tôi đã nhận...phim...Xquang / CT / MRI)";

                    worksheet.Cells["A" + index + ":C" + index].Style.Font.SetFromFont(new Font("Times New Roman", 12));
                    worksheet.Cells["A" + index + ":C" + index].Style.Font.Italic = true;
                    worksheet.Cells["A" + index + ":C" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                    worksheet.Cells["A" + index + ":C" + index].Merge = true;
                    worksheet.Cells["A" + index + ":C" + index].Value = "(Ký, Ghi rõ họ tên)";


                    worksheet.Cells["E" + index + ":H" + index].Style.Font.SetFromFont(new Font("Times New Roman", 12));
                    worksheet.Cells["E" + index + ":H" + index].Style.Font.Italic = true;
                    worksheet.Cells["E" + index + ":H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                    worksheet.Cells["E" + index + ":H" + index].Merge = true;
                    worksheet.Cells["E" + index + ":H" + index].Value = "(Ký, Ghi rõ họ tên)";

                    worksheet.Cells["J" + index + ":N" + index].Style.Font.SetFromFont(new Font("Times New Roman", 12));
                    worksheet.Cells["J" + index + ":N" + index].Style.Font.Italic = true;
                    worksheet.Cells["J" + index + ":N" + index].Merge = true;
                    worksheet.Cells["J" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                    worksheet.Cells["J" + index + ":N" + index].Value = "(Ký, Ghi rõ họ tên)";
                }
            }
            else
            {
                YeuCauTiepNhanTheBHYT theBHYTChiTra = null;
                var maSoThe = groupChiPhiTheoThe.Where(o => o.Key != string.Empty).FirstOrDefault()?.Key;
                if (!string.IsNullOrEmpty(maSoThe))
                {
                    theBHYTChiTra = yeuCauTiepNhan.YeuCauTiepNhanTheBHYTs.First(o => o.MaSoThe == maSoThe);
                }

                var chiPhis = groupChiPhiTheoThe.SelectMany(o => o).ToList();
                var mucHuongPT = theBHYTChiTra != null && theBHYTChiTra?.MucHuong > 0 ? theBHYTChiTra?.MucHuong + "%" : string.Empty;

                using (var range = worksheet.Cells["A21:C21"])
                {
                    range.Worksheet.Cells["A21:C21"].Merge = true;
                    range.Worksheet.Cells["A21:C21"].Style.WrapText = true;
                    var title = range.Worksheet.Cells["A21:C21"].RichText.Add("Mã thẻ BHYT: ");
                    var value = range.Worksheet.Cells["A21:C21"].RichText.Add(theBHYTChiTra?.MaSoThe);
                    value.Bold = true;

                    range.Worksheet.Cells["A21:C21"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                    range.Worksheet.Cells["A21:C21"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                    range.Worksheet.Cells["A21:C21"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                    range.Worksheet.Cells["A21:C21"].Style.Font.Color.SetColor(Color.Black);
                }
                using (var range = worksheet.Cells["A21:N21"])
                {
                    range.Worksheet.Cells["D" + index + ":F" + index].Merge = true;
                    range.Worksheet.Cells["D" + index + ":F" + index].Style.WrapText = true;
                    var title = range.Worksheet.Cells["D" + index + ":F" + index].RichText.Add("Giá trị từ: ");
                    var valuebHYTTuNgay = range.Worksheet.Cells["D" + index + ":F" + index].RichText.Add(theBHYTChiTra?.NgayHieuLuc.ApplyFormatDate());
                    valuebHYTTuNgay.Bold = true;

                    var den = range.Worksheet.Cells["D" + index + ":F" + index].RichText.Add(" đến: ");
                    den.Bold = false;
                    var valuebHYTDenNgay = range.Worksheet.Cells["D" + index + ":F" + index].RichText.Add(theBHYTChiTra?.NgayHetHan?.ApplyFormatDate());
                    valuebHYTDenNgay.Bold = true;

                    range.Worksheet.Cells["D" + index + ":F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                    range.Worksheet.Cells["D" + index + ":F" + index].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                    range.Worksheet.Cells["D" + index + ":F" + index].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                    range.Worksheet.Cells["D" + index + ":F" + index].Style.Font.Color.SetColor(Color.Black);
                }
                using (var range = worksheet.Cells["G21:J21"])
                {
                    range.Worksheet.Cells["G21:J21"].Merge = true;
                    range.Worksheet.Cells["G21:J21"].Style.WrapText = true;
                    var title = range.Worksheet.Cells["G21:J21"].RichText.Add("Mức hưởng: ");
                    var value = range.Worksheet.Cells["G21:J21"].RichText.Add(mucHuongPT);
                    value.Bold = true;


                    range.Worksheet.Cells["G21:J21"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                    range.Worksheet.Cells["G21:J21"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                    range.Worksheet.Cells["G21:J21"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                    range.Worksheet.Cells["G21:J21"].Style.Font.Color.SetColor(Color.Black);
                }
                using (var range = worksheet.Cells["A22:N23"])
                {
                    range.Worksheet.Cells["A22:N23"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                    range.Worksheet.Cells["A22:N23"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                    range.Worksheet.Cells["A22:N23"].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                    range.Worksheet.Cells["A22:N23"].Style.Font.Color.SetColor(Color.Black);
                    range.Worksheet.Cells["A22:N23"].Style.Font.Bold = true;
                    range.Worksheet.Cells["A22:N23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);

                    range.Worksheet.Cells["A22:A23"].Merge = true;
                    range.Worksheet.Cells["A22:A23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                    range.Worksheet.Cells["A22:A23"].Value = "STT";

                    range.Worksheet.Cells["B22:B23"].Merge = true;
                    range.Worksheet.Cells["B22:B23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                    range.Worksheet.Cells["B22:B23"].Value = "Nội dung";

                    range.Worksheet.Cells["C22:C23"].Merge = true;
                    range.Worksheet.Cells["C22:C23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                    range.Worksheet.Cells["C22:C23"].Value = "Đơn vị tính";

                    range.Worksheet.Cells["D22:D23"].Merge = true;
                    range.Worksheet.Cells["D22:D23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                    range.Worksheet.Cells["D22:D23"].Value = "Số lượng";

                    range.Worksheet.Cells["E22:E23"].Merge = true;
                    range.Worksheet.Cells["E22:E23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                    range.Worksheet.Cells["E22:E23"].Value = "Đơn giá BV(đồng)";

                    range.Worksheet.Cells["F22:F23"].Merge = true;
                    range.Worksheet.Cells["F22:F23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                    range.Worksheet.Cells["F22:F23"].Value = "Đơn giá BH(đồng)";

                    range.Worksheet.Cells["G22:G23"].Merge = true;
                    range.Worksheet.Cells["G22:G23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                    range.Worksheet.Cells["G22:G23"].Value = "Tỉ lệ thanh toán theo dịch vụ (%)";

                    range.Worksheet.Cells["H22:H23"].Merge = true;
                    range.Worksheet.Cells["H22:H23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                    range.Worksheet.Cells["H22:H23"].Value = "Thành tiền BV (đồng)";

                    range.Worksheet.Cells["I22:I23"].Merge = true;
                    range.Worksheet.Cells["I22:I23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                    range.Worksheet.Cells["I22:I23"].Value = "Tỷ lệ thanh toán BHYT (%)";

                    range.Worksheet.Cells["J22:J23"].Merge = true;
                    range.Worksheet.Cells["J22:J23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                    range.Worksheet.Cells["J22:J23"].Value = "Thành tiền BH(đồng)";

                    range.Worksheet.Cells["K22:N22"].Merge = true;
                    range.Worksheet.Cells["K22:N22"].Value = "Nguồn thanh toán (đồng)";

                    range.Worksheet.Cells["K23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                    range.Worksheet.Cells["K23"].Value = "Quỹ BHYT";

                    range.Worksheet.Cells["L23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                    range.Worksheet.Cells["L23"].Value = "Người bệnh cùng chi trả (đồng)";

                    range.Worksheet.Cells["M23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                    range.Worksheet.Cells["M23"].Value = "Khác (đồng)";

                    range.Worksheet.Cells["N23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                    range.Worksheet.Cells["N23"].Value = "Người bệnh tự trả(đồng)";
                }


                index = index + 3;


                foreach (var chiPhi in chiPhis.Where(c => c.NhomChiPhiBangKe != NhomChiPhiBangKe.GoiVatTu && c.YeuCauGoiDichVuId == null).GroupBy(c => new { c.DonGia, c.SoTienMG, KhongTinhPhi = c.KhongTinhPhi.GetValueOrDefault(), c.NhomChiPhiBangKe, c.TenDichVu, c.DonViTinh, c.DuocHuongBHYT, c.DonGiaBHYT, c.MucHuongBaoHiem, c.TiLeBaoHiemThanhToan }).OrderByDescending(o => o.Key.DuocHuongBHYT))
                {
                    var chiphiBangKe = new BangKeKhamBenhBenhVienVo
                    {
                        Nhom = chiPhi.Key.NhomChiPhiBangKe,
                        Id = chiPhi.FirstOrDefault().Id,
                        NoiDung = chiPhi.Key.TenDichVu,
                        DonViTinh = chiPhi.Key.DonViTinh,
                        SoLuong = (decimal)chiPhi.Sum(c => c.Soluong),
                        DuocHuongBaoHiem = chiPhi.Key.DuocHuongBHYT,
                        //BẢNG KÊ CHI TIẾT ĐIỀU TRỊ NỘI TRÚ (Ngoài gói) DonGiaBH mặc định = 0
                        DonGiaBH = 0,
                        MucHuongBaoHiem = 0,
                        TiLeThanhToanTheoDV = 0,
                        BaoHiemChiTra = true,
                        DonGiaBV = chiPhi.Key.DonGia
                    };
                    if (chiPhi.Key.KhongTinhPhi == true)
                    {
                        chiphiBangKe.Khac = chiPhi.Key.MucHuongBaoHiem > 0
                            ? (chiphiBangKe.ThanhTienBV.GetValueOrDefault() - chiphiBangKe.ThanhTienBH.GetValueOrDefault())
                            : chiphiBangKe.ThanhTienBV.GetValueOrDefault();
                    }
                    else
                    {
                        chiphiBangKe.Khac = chiPhi.Sum(c => c.SoTienMG);
                    }
                    dsChiPhiBangKe.Add(chiphiBangKe);
                }

                foreach (var chiPhi in chiPhis.Where(c => !(c.NhomChiPhiBangKe != NhomChiPhiBangKe.GoiVatTu && c.YeuCauGoiDichVuId == null)))
                {
                    var chiphiBangKe = new BangKeKhamBenhBenhVienVo
                    {
                        Nhom = chiPhi.NhomChiPhiBangKe,
                        Id = chiPhi.Id,
                        NoiDung = chiPhi.TenDichVu,
                        DonViTinh = chiPhi.DonViTinh,
                        SoLuong = (decimal)chiPhi.Soluong,
                        DuocHuongBaoHiem = chiPhi.DuocHuongBHYT,
                        //BẢNG KÊ CHI TIẾT ĐIỀU TRỊ NỘI TRÚ (Ngoài gói) DonGiaBH mặc định = 0
                        DonGiaBH = 0,
                        MucHuongBaoHiem = 0,
                        TiLeThanhToanTheoDV = 0,
                        BaoHiemChiTra = true,
                        DonGiaBV = chiPhi.DonGia
                    };
                    if (chiPhi.KhongTinhPhi == true || chiPhi.YeuCauGoiDichVuId != null)
                    {
                        chiphiBangKe.Khac = chiPhi.MucHuongBaoHiem > 0
                            ? (chiphiBangKe.ThanhTienBV.GetValueOrDefault() - chiphiBangKe.ThanhTienBH.GetValueOrDefault())
                            : chiphiBangKe.ThanhTienBV.GetValueOrDefault();
                    }
                    else
                    {
                        chiphiBangKe.Khac = chiPhi.SoTienMG;
                    }
                    dsChiPhiBangKe.Add(chiphiBangKe);
                }

                var groupChiPhiBangKes = dsChiPhiBangKe.GroupBy(x => x.Nhom).OrderBy(o => (int)o.Key * (o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay || o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriNoiTru ? 1 : 10));
                if (!groupChiPhiBangKes.Any())
                {
                    return;
                }
                foreach (var groupChiPhiBangKe in groupChiPhiBangKes)
                {
                    if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay)
                    {

                        worksheet.Cells["A" + index + ":N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        worksheet.Cells["A" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        worksheet.Cells["A" + index + ":N" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                        worksheet.Cells["A" + index + ":N" + index].Merge = true;
                        worksheet.Cells["A" + index + ":N" + index].Value = "2. Ngày giường:";
                        worksheet.Cells["A" + index + ":N" + index].Style.Font.Bold = true;

                        index++;

                        worksheet.Cells["A" + index + ":G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        worksheet.Cells["A" + index + ":G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        worksheet.Cells["A" + index + ":G" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                        worksheet.Cells["A" + index + ":G" + index].Merge = true;
                        worksheet.Cells["A" + index + ":G" + index].Value = "2.1." + groupChiPhiBangKe.Key.GetDescription();
                        worksheet.Cells["A" + index + ":G" + index].Style.Font.Bold = true;

                        worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                        worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                        worksheet.Cells["H" + index].Style.Font.Bold = true;
                        worksheet.Cells["H" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBV);

                        worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                        worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                        worksheet.Cells["J" + index].Style.Font.Bold = true;
                        worksheet.Cells["J" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBH);

                        worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                        worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                        worksheet.Cells["K" + index].Style.Font.Bold = true;
                        worksheet.Cells["K" + index].Value = groupChiPhiBangKe.Sum(o => o.QuyBHYT);

                        worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                        worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                        worksheet.Cells["L" + index].Style.Font.Bold = true;
                        worksheet.Cells["L" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra);

                        worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                        worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                        worksheet.Cells["M" + index].Style.Font.Bold = true;
                        worksheet.Cells["M" + index].Value = groupChiPhiBangKe.Sum(o => o.Khac);

                        worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                        worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                        worksheet.Cells["N" + index].Style.Font.Bold = true;
                        worksheet.Cells["N" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra);

                        index++;
                    }
                    else if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.NgayGiuongDieuTriNoiTru)
                    {
                        if (!groupChiPhiBangKes.Any(o => o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay))
                        {
                            worksheet.Cells["A" + index + ":N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["A" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                            worksheet.Cells["A" + index + ":N" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                            worksheet.Cells["A" + index + ":N" + index].Merge = true;
                            worksheet.Cells["A" + index + ":N" + index].Value = "2. Ngày giường:";
                            worksheet.Cells["A" + index + ":N" + index].Style.Font.Bold = true;

                        }
                        index++;
                        worksheet.Cells["A" + index + ":G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        worksheet.Cells["A" + index + ":G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        worksheet.Cells["A" + index + ":G" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                        worksheet.Cells["A" + index + ":G" + index].Merge = true;
                        worksheet.Cells["A" + index + ":G" + index].Value = "2.2." + groupChiPhiBangKe.Key.GetDescription();
                        worksheet.Cells["A" + index + ":G" + index].Style.Font.Bold = true;

                        worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                        worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                        worksheet.Cells["H" + index].Style.Font.Bold = true;
                        worksheet.Cells["H" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBV);

                        worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                        worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                        worksheet.Cells["J" + index].Style.Font.Bold = true;
                        worksheet.Cells["J" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBH);

                        worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                        worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                        worksheet.Cells["K" + index].Style.Font.Bold = true;
                        worksheet.Cells["K" + index].Value = groupChiPhiBangKe.Sum(o => o.QuyBHYT);

                        worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                        worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                        worksheet.Cells["L" + index].Style.Font.Bold = true;
                        worksheet.Cells["L" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra);

                        worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                        worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                        worksheet.Cells["M" + index].Style.Font.Bold = true;
                        worksheet.Cells["M" + index].Value = groupChiPhiBangKe.Sum(o => o.Khac);

                        worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                        worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                        worksheet.Cells["N" + index].Style.Font.Bold = true;
                        worksheet.Cells["N" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra);

                        index++;
                    }
                    else
                    {
                        worksheet.Cells["A" + index + ":G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        worksheet.Cells["A" + index + ":G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        worksheet.Cells["A" + index + ":G" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                        worksheet.Cells["A" + index + ":G" + index].Merge = true;
                        worksheet.Cells["A" + index + ":G" + index].Value = (int)groupChiPhiBangKe.Key + "." + groupChiPhiBangKe.Key.GetDescription();
                        worksheet.Cells["A" + index + ":G" + index].Style.Font.Bold = true;

                        worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                        worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                        worksheet.Cells["H" + index].Style.Font.Bold = true;
                        worksheet.Cells["H" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBV);

                        worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                        worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                        worksheet.Cells["J" + index].Style.Font.Bold = true;
                        worksheet.Cells["J" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBH);

                        worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                        worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                        worksheet.Cells["K" + index].Style.Font.Bold = true;
                        worksheet.Cells["K" + index].Value = groupChiPhiBangKe.Sum(o => o.QuyBHYT);

                        worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                        worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                        worksheet.Cells["L" + index].Style.Font.Bold = true;
                        worksheet.Cells["L" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra);

                        worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                        worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                        worksheet.Cells["M" + index].Style.Font.Bold = true;
                        worksheet.Cells["M" + index].Value = groupChiPhiBangKe.Sum(o => o.Khac);

                        worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                        worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                        worksheet.Cells["N" + index].Style.Font.Bold = true;
                        worksheet.Cells["N" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra);

                        index++;
                    }
                    if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.GoiVatTu)
                    {
                        var groupGoiVatTus = groupChiPhiBangKe.ToList().GroupBy(o => o.SoGoiVatTu.GetValueOrDefault()).OrderBy(o => o.Key);
                        int sttGoiVatTu = 1;
                        foreach (var groupGoiVatTu in groupGoiVatTus)
                        {
                            worksheet.Cells["A" + index + ":G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["A" + index + ":G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                            worksheet.Cells["A" + index + ":G" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                            worksheet.Cells["A" + index + ":G" + index].Value = "10." + sttGoiVatTu + ". " + groupChiPhiBangKe.Key.GetDescription() + " " + sttGoiVatTu;
                            worksheet.Cells["A" + index + ":G" + index].Style.Font.Bold = true;
                            worksheet.Cells["A" + index + ":G" + index].Merge = true;

                            worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                            worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                            worksheet.Cells["H" + index].Style.Font.Bold = true;
                            worksheet.Cells["H" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBV);

                            worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                            worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                            worksheet.Cells["J" + index].Style.Font.Bold = true;
                            worksheet.Cells["J" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBH);

                            worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                            worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                            worksheet.Cells["K" + index].Style.Font.Bold = true;
                            worksheet.Cells["K" + index].Value = groupChiPhiBangKe.Sum(o => o.QuyBHYT);

                            worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                            worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                            worksheet.Cells["L" + index].Style.Font.Bold = true;
                            worksheet.Cells["L" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra);

                            worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                            worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                            worksheet.Cells["M" + index].Style.Font.Bold = true;
                            worksheet.Cells["M" + index].Value = groupChiPhiBangKe.Sum(o => o.Khac);

                            worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                            worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                            worksheet.Cells["N" + index].Style.Font.Bold = true;
                            worksheet.Cells["N" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra);

                            index++;

                            foreach (var chiPhiBangKe in groupGoiVatTu)
                            {
                                worksheet.Cells["A" + index + ":N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["A" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                worksheet.Cells["A" + index + ":N" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));

                                worksheet.Cells["A" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["A" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                worksheet.Cells["A" + index].Value = indexItem;

                                worksheet.Cells["B" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["B" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                worksheet.Cells["B" + index].Value = chiPhiBangKe.NoiDung;

                                worksheet.Cells["C" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["C" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                worksheet.Cells["C" + index].Value = chiPhiBangKe.DonViTinh;

                                worksheet.Cells["D" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["D" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                worksheet.Cells["D" + index].Value = chiPhiBangKe.SoLuong;

                                worksheet.Cells["E" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["E" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["E" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["E" + index].Value = chiPhiBangKe.DonGiaBV;

                                worksheet.Cells["F" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["F" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["F" + index].Value = chiPhiBangKe.DonGiaBH;

                                worksheet.Cells["G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["G" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["G" + index].Value = chiPhiBangKe.TiLeThanhToanTheoDV;

                                worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["H" + index].Value = chiPhiBangKe.ThanhTienBV;

                                worksheet.Cells["I" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["I" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["I" + index].Value = Convert.ToDouble(chiPhiBangKe.MucHuongBaoHiem > 0 ? 100 : 0).ApplyFormatMoneyToDouble();


                                worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["J" + index].Value = chiPhiBangKe.ThanhTienBH;


                                worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["K" + index].Value = chiPhiBangKe.QuyBHYT;


                                worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["L" + index].Value = chiPhiBangKe.NguoiBenhCungChiTra;


                                worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["M" + index].Value = chiPhiBangKe.Khac;


                                worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["N" + index].Value = chiPhiBangKe.NguoiBenhTuTra;

                                indexItem++;
                                index++;
                            }
                        }
                    }
                    else
                    {

                        foreach (var chiPhiBangKe in groupChiPhiBangKe)
                        {
                            worksheet.Cells["A" + index + ":N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["A" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                            worksheet.Cells["A" + index + ":N" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));

                            worksheet.Cells["A" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["A" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                            worksheet.Cells["A" + index].Value = indexItem;

                            worksheet.Cells["B" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["B" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                            worksheet.Cells["B" + index].Value = chiPhiBangKe.NoiDung;

                            worksheet.Cells["C" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["C" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                            worksheet.Cells["C" + index].Value = chiPhiBangKe.DonViTinh;

                            worksheet.Cells["D" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["D" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                            worksheet.Cells["D" + index].Value = chiPhiBangKe.SoLuong;

                            worksheet.Cells["E" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["E" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                            worksheet.Cells["E" + index].Style.Numberformat.Format = "#,##0.00";
                            worksheet.Cells["E" + index].Value = chiPhiBangKe.DonGiaBV;

                            worksheet.Cells["F" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["F" + index].Style.Numberformat.Format = "#,##0.00";
                            worksheet.Cells["F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                            worksheet.Cells["F" + index].Value = chiPhiBangKe.DonGiaBH;

                            worksheet.Cells["G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                            worksheet.Cells["G" + index].Style.Numberformat.Format = "#,##0.00";
                            worksheet.Cells["G" + index].Value = chiPhiBangKe.TiLeThanhToanTheoDV;

                            worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                            worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                            worksheet.Cells["H" + index].Value = chiPhiBangKe.ThanhTienBV;

                            worksheet.Cells["I" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["I" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                            worksheet.Cells["I" + index].Value = Convert.ToDouble(chiPhiBangKe.MucHuongBaoHiem > 0 ? 100 : 0).ApplyFormatMoneyToDouble();


                            worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                            worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                            worksheet.Cells["J" + index].Value = chiPhiBangKe.ThanhTienBH;


                            worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                            worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                            worksheet.Cells["K" + index].Value = chiPhiBangKe.QuyBHYT;


                            worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                            worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                            worksheet.Cells["L" + index].Value = chiPhiBangKe.NguoiBenhCungChiTra;


                            worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                            worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                            worksheet.Cells["M" + index].Value = chiPhiBangKe.Khac;


                            worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                            worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                            worksheet.Cells["N" + index].Value = chiPhiBangKe.NguoiBenhTuTra;

                            indexItem++;
                            index++;
                        }
                    }

                }
                worksheet.Cells["A" + index + ":G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                worksheet.Cells["A" + index + ":G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                worksheet.Cells["A" + index + ":G" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                worksheet.Cells["A" + index + ":G" + index].Merge = true;
                worksheet.Cells["A" + index + ":G" + index].Value = "Tổng cộng";
                worksheet.Cells["A" + index + ":G" + index].Style.Font.Bold = true;

                worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                worksheet.Cells["H" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.ThanhTienBV)).Sum();

                worksheet.Cells["I" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                worksheet.Cells["I" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;

                worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                worksheet.Cells["J" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.ThanhTienBH)).Sum();

                worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                worksheet.Cells["K" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.QuyBHYT)).Sum();

                worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                worksheet.Cells["L" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.NguoiBenhCungChiTra)).Sum();

                worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                worksheet.Cells["M" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.Khac)).Sum();

                worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                worksheet.Cells["N" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.NguoiBenhTuTra)).Sum();

                index++;

                worksheet.Cells["A" + index + ":N" + index].Merge = true;
                worksheet.Cells["A" + index + ":N" + index].Value = "Tổng chi phí lần khám bệnh/cả đợt điều trị: " + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + " đồng";
                worksheet.Cells["A" + index + ":N" + index].Style.Font.Bold = true;

                index++;

                worksheet.Cells["A" + index + ":N" + index].Merge = true;
                worksheet.Cells["A" + index + ":N" + index].Value = "(Viết bằng chữ: " + NumberHelper.ChuyenSoRaText(Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBV))) + ")";

                index++;

                worksheet.Cells["A" + index + ":N" + index].Merge = true;
                worksheet.Cells["A" + index + ":N" + index].Value = "Trong đó , số tiền do:";
                worksheet.Cells["A" + index + ":N" + index].Style.Font.Bold = true;

                index++;
                worksheet.Cells["A" + index + ":N" + index].Merge = true;
                worksheet.Cells["A" + index + ":N" + index].Value = "- Quỹ BHYT thanh toán: " + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble();

                index++;
                worksheet.Cells["A" + index + ":N" + index].Merge = true;
                worksheet.Cells["A" + index + ":N" + index].Value = "- Người bệnh trả trong đó: " + (Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)) + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhTuTra))).ApplyFormatMoneyToDouble();

                index++;
                worksheet.Cells["A" + index + ":N" + index].Merge = true;
                worksheet.Cells["A" + index + ":N" + index].Value = "+ Cùng chi trả trong phạm vi BHYT: " + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble(true);

                index++;
                worksheet.Cells["A" + index + ":N" + index].Merge = true;
                worksheet.Cells["A" + index + ":N" + index].Value = "+ Các khoản phải trả khác: " + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true);

                index++;
                worksheet.Cells["A" + index + ":N" + index].Merge = true;
                worksheet.Cells["A" + index + ":N" + index].Value = "+ Nguồn khác: " + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble(true);


                index = index + 2;
                //worksheet.Cells["D" + index + ":F" + index].Style.Font.SetFromFont(new Font("Times New Roman", 12));
                //worksheet.Cells["D" + index + ":F" + index].Merge = true;
                //worksheet.Cells["D" + index + ":F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                //worksheet.Cells["D" + index + ":F" + index].Style.VerticalAlignment = ExcelVerticalAlignment.Top;
                //worksheet.Cells["D" + index + ":F" + index].Value = $"Ngày {DateTime.Now.Day} tháng {DateTime.Now.Month} năm {DateTime.Now.Year}";

                //worksheet.Cells["G" + index + ":I" + index].Style.Font.SetFromFont(new Font("Times New Roman", 12));
                //worksheet.Cells["G" + index + ":I" + index].Merge = true;
                //worksheet.Cells["G" + index + ":I" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                //worksheet.Cells["G" + index + ":I" + index].Style.VerticalAlignment = ExcelVerticalAlignment.Top;
                //worksheet.Cells["G" + index + ":I" + index].Value = $"Ngày {DateTime.Now.Day} tháng {DateTime.Now.Month} năm {DateTime.Now.Year}";

                //worksheet.Cells["J" + index + ":N" + index].Style.Font.Bold = true;
                //worksheet.Cells["J" + index + ":N" + index].Merge = true;
                //worksheet.Cells["J" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                //worksheet.Cells["J" + index + ":N" + index].Value = "XÁC NHẬN CỦA NGƯỜI BỆNH ";

                worksheet.Cells["J" + index + ":N" + index].Style.Font.SetFromFont(new Font("Times New Roman", 12));
                worksheet.Cells["J" + index + ":N" + index].Style.Font.Italic = true;
                worksheet.Cells["J" + index + ":N" + index].Merge = true;
                worksheet.Cells["J" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                worksheet.Cells["J" + index + ":N" + index].Style.VerticalAlignment = ExcelVerticalAlignment.Top;
                worksheet.Cells["J" + index + ":N" + index].Value = $"Ngày {DateTime.Now.Day} tháng {DateTime.Now.Month} năm {DateTime.Now.Year}";

                index++;

                //worksheet.Cells["A" + index + ":C" + index].Style.Font.Bold = true;
                //worksheet.Cells["A" + index + ":C" + index].Merge = true;
                //worksheet.Cells["A" + index + ":C" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                //worksheet.Cells["A" + index + ":C" + index].Value = "NGƯỜI LẬP BẢNG KÊ";

                //worksheet.Cells["D" + index + ":F" + index].Style.Font.Bold = true;
                //worksheet.Cells["D" + index + ":F" + index].Merge = true;
                //worksheet.Cells["D" + index + ":F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                //worksheet.Cells["D" + index + ":F" + index].Value = "KẾ TOÁN VIỆN PHÍ";

                //worksheet.Cells["G" + index + ":I" + index].Style.Font.Bold = true;
                //worksheet.Cells["G" + index + ":I" + index].Merge = true;
                //worksheet.Cells["G" + index + ":I" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                //worksheet.Cells["G" + index + ":I" + index].Value = "GIÁM ĐỊNH BHYT";

                //worksheet.Cells["J" + index + ":N" + index].Style.Font.Bold = true;
                //worksheet.Cells["J" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                //worksheet.Cells["J" + index + ":N" + index].Merge = true;
                //worksheet.Cells["J" + index + ":N" + index].Value = "(Ký , Ghi rõ họ tên)";

                worksheet.Cells["A" + index + ":C" + index].Style.Font.SetFromFont(new Font("Times New Roman", 12));
                worksheet.Cells["A" + index + ":C" + index].Style.Font.Bold = true;
                worksheet.Cells["A" + index + ":C" + index].Merge = true;
                worksheet.Cells["A" + index + ":C" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                worksheet.Cells["A" + index + ":C" + index].Value = "NGƯỜI LẬP BẢNG KÊ";

                worksheet.Cells["E" + index + ":H" + index].Style.Font.SetFromFont(new Font("Times New Roman", 12));
                worksheet.Cells["E" + index + ":H" + index].Style.Font.Bold = true;
                worksheet.Cells["E" + index + ":H" + index].Merge = true;
                worksheet.Cells["E" + index + ":H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                worksheet.Cells["E" + index + ":H" + index].Value = "KẾ TOÁN VIỆN PHÍ";

                worksheet.Cells["J" + index + ":N" + index].Style.Font.SetFromFont(new Font("Times New Roman", 12));
                worksheet.Cells["J" + index + ":N" + index].Style.Font.Bold = true;
                worksheet.Cells["J" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                worksheet.Cells["J" + index + ":N" + index].Merge = true;
                worksheet.Cells["J" + index + ":N" + index].Value = "XÁC NHẬN CỦA NGƯỜI BỆNH";

                index++;

                //worksheet.Cells["A" + index + ":C" + index].Style.Font.Bold = true;
                //worksheet.Cells["A" + index + ":C" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                //worksheet.Cells["A" + index + ":C" + index].Merge = true;
                //worksheet.Cells["A" + index + ":C" + index].Value = "(Ký, Ghi rõ họ tên)";


                //worksheet.Cells["D" + index + ":F" + index].Style.Font.Bold = true;
                //worksheet.Cells["D" + index + ":F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                //worksheet.Cells["D" + index + ":F" + index].Merge = true;
                //worksheet.Cells["D" + index + ":F" + index].Value = "(Ký, Ghi rõ họ tên)";

                //worksheet.Cells["G" + index + ":I" + index].Style.Font.Bold = true;
                //worksheet.Cells["G" + index + ":I" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                //worksheet.Cells["G" + index + ":I" + index].Merge = true;
                //worksheet.Cells["G" + index + ":I" + index].Value = "(Ký, Ghi rõ họ tên)";

                //worksheet.Cells["J" + index + ":N" + index].Style.Font.Bold = true;
                //worksheet.Cells["J" + index + ":N" + index].Merge = true;
                //worksheet.Cells["J" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                //worksheet.Cells["J" + index + ":N" + index].Value = "(Tôi đã nhận...phim...Xquang / CT / MRI)";

                worksheet.Cells["A" + index + ":C" + index].Style.Font.SetFromFont(new Font("Times New Roman", 12));
                worksheet.Cells["A" + index + ":C" + index].Style.Font.Italic = true;
                worksheet.Cells["A" + index + ":C" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                worksheet.Cells["A" + index + ":C" + index].Merge = true;
                worksheet.Cells["A" + index + ":C" + index].Value = "(Ký, Ghi rõ họ tên)";


                worksheet.Cells["E" + index + ":H" + index].Style.Font.SetFromFont(new Font("Times New Roman", 12));
                worksheet.Cells["E" + index + ":H" + index].Style.Font.Italic = true;
                worksheet.Cells["E" + index + ":H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                worksheet.Cells["E" + index + ":H" + index].Merge = true;
                worksheet.Cells["E" + index + ":H" + index].Value = "(Ký, Ghi rõ họ tên)";

                worksheet.Cells["J" + index + ":N" + index].Style.Font.SetFromFont(new Font("Times New Roman", 12));
                worksheet.Cells["J" + index + ":N" + index].Style.Font.Italic = true;
                worksheet.Cells["J" + index + ":N" + index].Merge = true;
                worksheet.Cells["J" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                worksheet.Cells["J" + index + ":N" + index].Value = "(Ký, Ghi rõ họ tên)";
            }
        }

        #endregion

        #region Bảng kê đã thu

        public byte[] XuatBangKeCoBHYT(long taiKhoanThuId)
        {
            var taiKhoanBenhNhanThu = _taiKhoanBenhNhanThuRepository.TableNoTracking.Where(c => c.Id == taiKhoanThuId && c.LoaiThuTienBenhNhan == Enums.LoaiThuTienBenhNhan.ThuTheoChiPhi)
                                                                                    .Include(o => o.YeuCauTiepNhan).ThenInclude(o => o.NoiTruBenhAn).ThenInclude(o => o.ChuyenDenBenhVien)
                                                                                    .Include(o => o.YeuCauTiepNhan).ThenInclude(o => o.NoiTruBenhAn).ThenInclude(o => o.KhoaPhongNhapVien)
                                                                                    .Include(o => o.YeuCauTiepNhan).ThenInclude(o => o.NoiTruBenhAn).ThenInclude(o => o.ChanDoanChinhRaVienICD)
                                                                                    .Include(o => o.YeuCauTiepNhan).ThenInclude(o => o.YeuCauTiepNhanTheBHYTs)
                                                                                    .Include(o => o.YeuCauTiepNhan).ThenInclude(o => o.YeuCauNhapVien).ThenInclude(o => o.YeuCauKhamBenh).ThenInclude(o => o.YeuCauTiepNhan)
                                                                                    .Include(cc => cc.YeuCauTiepNhan)
                                                                                    .ThenInclude(xx => xx.BenhNhan)
                                                                                    .Include(cc => cc.YeuCauTiepNhan)
                                                                                    .ThenInclude(xx => xx.YeuCauKhamBenhs)
                                                                                    .ThenInclude(o => o.YeuCauKhamBenhChuanDoans)
                                                                                    .ThenInclude(o => o.ChuanDoan)
                                                                                    .Include(cc => cc.YeuCauTiepNhan).ThenInclude(cc => cc.PhuongXa)
                                                                                    .Include(cc => cc.YeuCauTiepNhan)
                                                                                    .ThenInclude(cc => cc.QuanHuyen)
                                                                                    .Include(cc => cc.YeuCauTiepNhan)
                                                                                    .ThenInclude(cc => cc.TinhThanh)
                                                                                    .Include(cc => cc.YeuCauTiepNhan).ThenInclude(cc => cc.NoiChuyen)
                                                                                    .Include(o => o.YeuCauTiepNhan).ThenInclude(o => o.NoiTruBenhAn).ThenInclude(o => o.NoiTruPhieuDieuTris).ThenInclude(c => c.ChanDoanChinhICD)
                                                                                    .Include(o => o.YeuCauTiepNhan).ThenInclude(o => o.NoiTruBenhAn).ThenInclude(o => o.NoiTruPhieuDieuTris).ThenInclude(o => o.NoiTruThamKhamChanDoanKemTheos).ThenInclude(c => c.ICD)
                                                                                    .Include(o => o.YeuCauTiepNhan).ThenInclude(o => o.NoiTruBenhAn).ThenInclude(o => o.NoiTruKhoaPhongDieuTris).ThenInclude(c => c.KhoaPhongChuyenDen).FirstOrDefault();

            var yeuCauTiepNhan = taiKhoanBenhNhanThu.YeuCauTiepNhan;

            var danhSachChiPhi = GetTatCaDichVuKhamChuaBenh(yeuCauTiepNhan.Id).Result.Where(o => !o.Soluong.AlmostEqual(0) && o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.DaThanhToan && o.KhongTinhPhi != true && o.DuocHuongBHYT && o.MucHuongBaoHiem > 0).ToList();

            if (danhSachChiPhi.Count() == 0)
            {
                return null;
            }

            var query = taiKhoanBenhNhanThu?.YeuCauTiepNhan;           
            if (yeuCauTiepNhan == null)
                return null;

            var benhVien = new Core.Domain.Entities.BenhVien.BenhVien();

            string maBHYT = string.Empty;
            string bHYTTuNgay = string.Empty;
            string bHYTDenNgay = string.Empty;
            string mucHuong = string.Empty;
            string NoiDKKCBBanDau = string.Empty;
            string MaKCBBanDau = string.Empty;


            string maICDKemTheo = string.Empty;
            string tenICDKemTheo = string.Empty;


            string chuanDoanXacDinhSanKhoa = string.Empty;
            string maICD10 = string.Empty;

            if (yeuCauTiepNhan.NoiTruBenhAn != null && (yeuCauTiepNhan.NoiTruBenhAn.LoaiBenhAn == LoaiBenhAn.SanKhoaMo || yeuCauTiepNhan.NoiTruBenhAn.LoaiBenhAn == LoaiBenhAn.SanKhoaThuong))
            {
                if (yeuCauTiepNhan.NoiTruBenhAn?.NoiTruPhieuDieuTris.Count() > 0)
                {
                    var phieuDieuTri = yeuCauTiepNhan.NoiTruBenhAn?.NoiTruPhieuDieuTris.OrderByDescending(c => c.NgayDieuTri).FirstOrDefault();

                    var icdKemTheoIds = phieuDieuTri.NoiTruThamKhamChanDoanKemTheos.Select(c => c.ICD.Ma);
                    var tenICDKemTheos = phieuDieuTri.NoiTruThamKhamChanDoanKemTheos.Select(c => c.GhiChu);

                    maICDKemTheo = string.Join(", ", icdKemTheoIds);
                    tenICDKemTheo = string.Join(", ", tenICDKemTheos);


                    maICD10 = phieuDieuTri.ChanDoanChinhICD?.Ma;
                    chuanDoanXacDinhSanKhoa = phieuDieuTri.ChanDoanChinhGhiChu;
                }
            }
            else
            {
                if (!string.IsNullOrEmpty(yeuCauTiepNhan.NoiTruBenhAn?.DanhSachChanDoanKemTheoRaVienICDId))
                {
                    var maICDKemTheos = new List<string>();

                    var icdKemTheoIds = yeuCauTiepNhan.NoiTruBenhAn?.DanhSachChanDoanKemTheoRaVienICDId.Split(Constants.ICDSeparator);
                    var tenICDKemTheos = yeuCauTiepNhan.NoiTruBenhAn?.DanhSachChanDoanKemTheoRaVienGhiChu?.Split(Constants.ICDSeparator);

                    if (icdKemTheoIds.Length > 0)
                    {
                        foreach (var icdKemTheoId in icdKemTheoIds)
                        {
                            var icdKemTheo = _icdRepository.TableNoTracking.FirstOrDefault(o => o.Id == long.Parse(icdKemTheoId));
                            if (icdKemTheo != null)
                            {
                                maICDKemTheos.Add(icdKemTheo.Ma);
                            }                           
                        }
                    }

                    maICDKemTheo = string.Join(", ", maICDKemTheos);
                    tenICDKemTheo = string.Join(", ", tenICDKemTheos);
                }
            }

            YeuCauTiepNhanTheBHYT theBHYT = null;
            if (yeuCauTiepNhan.CoBHYT == true && yeuCauTiepNhan.YeuCauTiepNhanTheBHYTs.Any())
            {
                theBHYT = yeuCauTiepNhan.YeuCauTiepNhanTheBHYTs.First();
                if (!String.IsNullOrEmpty(theBHYT.MaDKBD))
                {
                    benhVien = _benhVienRepository.TableNoTracking.FirstOrDefault(p => p.Ma.Equals(theBHYT.MaDKBD));
                }
                maBHYT = theBHYT.MaSoThe;
                bHYTTuNgay = theBHYT.NgayHieuLuc.ApplyFormatDate();
                bHYTDenNgay = theBHYT.NgayHetHan?.ApplyFormatDate();
                mucHuong = theBHYT.MucHuong.ToString() + "%";
                NoiDKKCBBanDau = benhVien != null ? benhVien?.Ten : "Chưa xác định";
                MaKCBBanDau = theBHYT.MaDKBD;
            }
            else
            {
                maBHYT = "";
                bHYTTuNgay = "";
                bHYTDenNgay = "";
                mucHuong = "0%";
                NoiDKKCBBanDau = "Chưa xác định";
                MaKCBBanDau = "Chưa xác định";
            }

            //var thongTinPhieuThus = GetThongTinPhieuThu(taiKhoanThuId, LoaiPhieuThuChiThuNgan.ThuTheoChiPhi);
            //if (thongTinPhieuThus.ChiPhiKhamChuaBenhNoiTruVos.Where(o => o.KhongTinhPhi != true && o.DuocHuongBHYT && o.MucHuongBaoHiem > 0).Count() == 0)
            //{
            //    return string.Empty;
            //}
            var dsChiPhiBangKe = new List<BangKeKhamBenhCoBHYTVo>();
            var dateItemChiPhis = string.Empty;
            int indexItem = 1;

            using (var stream = new MemoryStream())
            {
                using (var xlPackage = new ExcelPackage(stream))
                {

                    var worksheet = xlPackage.Workbook.Worksheets.Add("BẢNG KÊ CHI PHÍ ĐIỀU TRỊ NỘI TRÚ 3");

                    // set row
                    worksheet.Row(9).Height = 24.5;
                    worksheet.DefaultRowHeight = 16;

                    //SET chiều rộng cho từng cột tương ứng
                    worksheet.Column(1).Width = 10;
                    worksheet.Column(2).Width = 25;
                    worksheet.Column(3).Width = 15;
                    worksheet.Column(4).Width = 15;
                    worksheet.Column(5).Width = 15;
                    worksheet.Column(6).Width = 15;
                    worksheet.Column(7).Width = 15;
                    worksheet.Column(8).Width = 15;
                    worksheet.Column(9).Width = 15;
                    worksheet.Column(10).Width = 15;
                    worksheet.Column(11).Width = 15;
                    worksheet.Column(12).Width = 15;
                    worksheet.Column(13).Width = 15;
                    worksheet.Column(14).Width = 15;

                    worksheet.DefaultColWidth = 7;

                    using (var range = worksheet.Cells["A1:C1"])
                    {
                        range.Worksheet.Cells["A1:C1"].Merge = true;
                        range.Worksheet.Cells["A1:C1"].Value = "CƠ SỞ KHÁM CHỮA BỆNH : BỆNH VIỆN ĐKQT BẮC HÀ";
                        range.Worksheet.Cells["A1:C1"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A1:C1"].Style.VerticalAlignment = ExcelVerticalAlignment.Bottom;
                        range.Worksheet.Cells["A1:C1"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A1:C1"].Style.Font.Color.SetColor(Color.Black);
                    }


                    var khoaPhong = yeuCauTiepNhan.NoiTruBenhAn?.NoiTruKhoaPhongDieuTris.OrderByDescending(c => c.ThoiDiemVaoKhoa).Select(c => c.KhoaPhongChuyenDen).FirstOrDefault();
                    var chuyenKhoa = GetChuyenKhoa(khoaPhong?.Id); //BVHD-3792 

                    using (var range = worksheet.Cells["A2:C2"])
                    {
                        range.Worksheet.Cells["A2:C2"].Merge = true;
                        range.Worksheet.Cells["A2:C2"].Value = "Khoa: " + khoaPhong?.Ten;
                        range.Worksheet.Cells["A2:C2"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A2:C2"].Style.VerticalAlignment = ExcelVerticalAlignment.Bottom;
                        range.Worksheet.Cells["A2:C2"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A2:C2"].Style.Font.Color.SetColor(Color.Black);
                        range.Worksheet.Cells["A2:C2"].Style.Font.Bold = true;
                    }

                    using (var range = worksheet.Cells["A3:C3"])
                    {
                        range.Worksheet.Cells["A3:C3"].Merge = true;
                        range.Worksheet.Cells["A3:C3"].Value = "Mã khoa: " + chuyenKhoa.Ma;
                        range.Worksheet.Cells["A3:C3"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A3:C3"].Style.VerticalAlignment = ExcelVerticalAlignment.Bottom;
                        range.Worksheet.Cells["A3:C3"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A3:C3"].Style.Font.Color.SetColor(Color.Black);
                        range.Worksheet.Cells["A3:C3"].Style.Font.Bold = true;
                    }

                    using (var range = worksheet.Cells["L1:N1"])
                    {
                        range.Worksheet.Cells["L1:N1"].Merge = true;
                        range.Worksheet.Cells["L1:N1"].Value = "Mẫu số : 01/KBCB ";
                        range.Worksheet.Cells["L1:N1"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                        range.Worksheet.Cells["L1:N1"].Style.VerticalAlignment = ExcelVerticalAlignment.Bottom;
                        range.Worksheet.Cells["L1:N1"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["L1:N1"].Style.Font.Color.SetColor(Color.Black);
                        range.Worksheet.Cells["L1:N1"].Style.Font.Bold = true;
                    }

                    using (var range = worksheet.Cells["L2:N2"])
                    {
                        range.Worksheet.Cells["L2:N2"].Merge = true;
                        range.Worksheet.Cells["L2:N2"].Value = "Mã số người bệnh: " + yeuCauTiepNhan.BenhNhan.MaBN;
                        range.Worksheet.Cells["L2:N2"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                        range.Worksheet.Cells["L2:N2"].Style.VerticalAlignment = ExcelVerticalAlignment.Bottom;
                        range.Worksheet.Cells["L2:N2"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["L2:N2"].Style.Font.Color.SetColor(Color.Black);
                        range.Worksheet.Cells["L2:N2"].Style.Font.Bold = true;
                    }

                    using (var range = worksheet.Cells["L3:N3"])
                    {
                        range.Worksheet.Cells["L3:N3"].Merge = true;
                        range.Worksheet.Cells["L3:N3"].Value = "Số khám bệnh:" + yeuCauTiepNhan.MaYeuCauTiepNhan;
                        range.Worksheet.Cells["L3:N3"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                        range.Worksheet.Cells["L3:N3"].Style.VerticalAlignment = ExcelVerticalAlignment.Bottom;
                        range.Worksheet.Cells["L3:N3"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["L3:N3"].Style.Font.Color.SetColor(Color.Black);
                        range.Worksheet.Cells["L3:N3"].Style.Font.Bold = true;
                    }

                    using (var range = worksheet.Cells["L4:N4"])
                    {
                        range.Worksheet.Cells["L4:N4"].Merge = true;
                        range.Worksheet.Cells["L4:N4"].Value = "Số bệnh án: " + yeuCauTiepNhan.NoiTruBenhAn?.SoBenhAn;
                        range.Worksheet.Cells["L4:N4"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                        range.Worksheet.Cells["L4:N4"].Style.VerticalAlignment = ExcelVerticalAlignment.Bottom;
                        range.Worksheet.Cells["L4:N4"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["L4:N4"].Style.Font.Color.SetColor(Color.Black);
                        range.Worksheet.Cells["L4:N4"].Style.Font.Bold = true;
                    }

                    using (var range = worksheet.Cells["A5:N6"])
                    {
                        range.Worksheet.Cells["A5:N6"].Merge = true;
                        range.Worksheet.Cells["A5:N6"].Value = "BẢNG KÊ CHI PHÍ ĐIỀU TRỊ NỘI TRÚ 3";
                        range.Worksheet.Cells["A5:N6"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        range.Worksheet.Cells["A5:N6"].Style.VerticalAlignment = ExcelVerticalAlignment.Bottom;
                        range.Worksheet.Cells["A5:N6"].Style.Font.SetFromFont(new Font("Times New Roman", 18));
                        range.Worksheet.Cells["A5:N6"].Style.Font.Color.SetColor(Color.Black);
                        range.Worksheet.Cells["A5:N6"].Style.Font.Bold = true;
                    }

                    using (var range = worksheet.Cells["A7:N7"])
                    {
                        range.Worksheet.Cells["A7:N7"].Merge = true;
                        range.Worksheet.Cells["A7:N7"].Value = "I.Hành chính";
                        range.Worksheet.Cells["A7:N7"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A7:N7"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A7:N7"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A7:N7"].Style.Font.Color.SetColor(Color.Black);
                        range.Worksheet.Cells["A7:N7"].Style.Font.Bold = true;
                    }

                    using (var range = worksheet.Cells["A8:F8"])
                    {
                        range.Worksheet.Cells["A8:F8"].Merge = true;

                        range.Worksheet.Cells["A8:F8"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["A8:F8"].RichText.Add("(1) Họ tên người bệnh: ");
                        var value = range.Worksheet.Cells["A8:F8"].RichText.Add(yeuCauTiepNhan.HoTen);
                        value.Bold = true;

                        range.Worksheet.Cells["A8:F8"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A8:F8"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A8:F8"].Style.Font.SetFromFont(new Font("Times New Roman", 11));


                        range.Worksheet.Cells["A8:F8"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["G8:J8"])
                    {
                        range.Worksheet.Cells["G8:J8"].Merge = true;
                        range.Worksheet.Cells["G8:J8"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["G8:J8"].RichText.Add("Ngày,tháng,năm sinh: ");
                        var value = range.Worksheet.Cells["G8:J8"].RichText.Add(DateHelper.DOBFormat(yeuCauTiepNhan.NgaySinh, yeuCauTiepNhan.ThangSinh, yeuCauTiepNhan.NamSinh));
                        value.Bold = true;

                        range.Worksheet.Cells["G8:J8"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["G8:J8"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["G8:J8"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["G8:J8"].Style.Font.Color.SetColor(Color.Black);
                    }

                    var gioitinh = yeuCauTiepNhan.GioiTinh != null ? yeuCauTiepNhan.GioiTinh.GetDescription() : "";
                    using (var range = worksheet.Cells["K8:N8"])
                    {
                        range.Worksheet.Cells["K8:N8"].Merge = true;

                        range.Worksheet.Cells["K8:N8"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["K8:N8"].RichText.Add("Giới tính: ");
                        var value = range.Worksheet.Cells["K8:N8"].RichText.Add(gioitinh);
                        value.Bold = true;

                        range.Worksheet.Cells["K8:N8"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["K8:N8"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["K8:N8"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["K8:N8"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["A9:F9"])
                    {
                        range.Worksheet.Cells["A9:F9"].Merge = true;

                        range.Worksheet.Cells["A9:F9"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["A9:F9"].RichText.Add("(2)Địa chỉ hiện tại: ");
                        var value = range.Worksheet.Cells["A9:F9"].RichText.Add(yeuCauTiepNhan.DiaChiDayDu);
                        value.Bold = true;

                        range.Worksheet.Cells["A9:F9"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A9:F9"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A9:F9"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A9:F9"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["G9:J9"])
                    {
                        range.Worksheet.Cells["G9:J9"].Merge = true;

                        range.Worksheet.Cells["G9:J9"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["G9:J9"].RichText.Add("(3)Mã khu vực(K1/K2/K3): ");
                        var value = range.Worksheet.Cells["G9:J9"].RichText.Add(yeuCauTiepNhan.BHYTMaKhuVuc);
                        value.Bold = true;

                        range.Worksheet.Cells["G9:J9"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["G9:J9"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["G9:J9"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["G9:J9"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["A10:F10"])
                    {
                        range.Worksheet.Cells["A10:F10"].Merge = true;
                        range.Worksheet.Cells["A10:F10"].Style.WrapText = true;

                        var title = range.Worksheet.Cells["A10:F10"].RichText.Add("(4)Mã thẻ BHYT: ");
                        var value = range.Worksheet.Cells["A10:F10"].RichText.Add(maBHYT);
                        value.Bold = true;

                        range.Worksheet.Cells["A10:F10"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A10:F10"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A10:F10"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A10:F10"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["G10:J10"])
                    {
                        range.Worksheet.Cells["G10:J10"].Merge = true;
                        range.Worksheet.Cells["G10:J10"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["G10:J10"].RichText.Add("Giá trị từ: ");
                        var valuebHYTTuNgay = range.Worksheet.Cells["G10:J10"].RichText.Add(bHYTTuNgay);
                        valuebHYTTuNgay.Bold = true;

                        var den = range.Worksheet.Cells["G10:J10"].RichText.Add(" đến: ");
                        den.Bold = false;
                        var valuebHYTDenNgay = range.Worksheet.Cells["G10:J10"].RichText.Add(bHYTDenNgay);
                        valuebHYTDenNgay.Bold = true;


                        range.Worksheet.Cells["G10:J10"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["G10:J10"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["G10:J10"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["G10:J10"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["A11:F11"])
                    {
                        range.Worksheet.Cells["A11:F11"].Merge = true;

                        range.Worksheet.Cells["A11:F11"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["A11:F11"].RichText.Add("(5)Nơi ĐK KCB ban đầu: ");
                        var valueNoiDKKCBBanDau = range.Worksheet.Cells["A11:F11"].RichText.Add(NoiDKKCBBanDau);
                        valueNoiDKKCBBanDau.Bold = true;

                        range.Worksheet.Cells["A11:F11"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A11:F11"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A11:F11"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A11:F11"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["G11:J11"])
                    {
                        range.Worksheet.Cells["G11:J11"].Merge = true;
                        range.Worksheet.Cells["G11:J11"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["G11:J11"].RichText.Add("(6)Mã: ");
                        var valueMaKCBBanDau = range.Worksheet.Cells["G11:J11"].RichText.Add(MaKCBBanDau);
                        valueMaKCBBanDau.Bold = true;

                        range.Worksheet.Cells["G11:J11"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["G11:J11"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["G11:J11"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["G11:J11"].Style.Font.Color.SetColor(Color.Black);
                    }


                    using (var range = worksheet.Cells["A12:F12"])
                    {
                        range.Worksheet.Cells["A12:F12"].Merge = true;

                        range.Worksheet.Cells["A12:F12"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["A12:F12"].RichText.Add("(7)Đến Khám: ");
                        var value = range.Worksheet.Cells["A12:F12"].RichText.Add(yeuCauTiepNhan.ThoiDiemTiepNhan.ApplyFormatGioPhutNgay());
                        value.Bold = true;

                        range.Worksheet.Cells["A12:F12"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A12:F12"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A12:F12"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A12:F12"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["A13:F13"])
                    {
                        range.Worksheet.Cells["A13:F13"].Merge = true;

                        range.Worksheet.Cells["A13:F13"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["A13:F13"].RichText.Add("(8)Điều trị ngoại trú/nội trú từ: ");
                        var value = range.Worksheet.Cells["A13:F13"].RichText.Add(yeuCauTiepNhan.NoiTruBenhAn?.ThoiDiemNhapVien.ApplyFormatGioPhutNgay());
                        value.Bold = true;

                        range.Worksheet.Cells["A13:F13"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A13:F13"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A13:F13"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A13:F13"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["A14:F14"])
                    {
                        range.Worksheet.Cells["A14:F14"].Merge = true;
                        range.Worksheet.Cells["A14:F14"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["A14:F14"].RichText.Add("(9)Kết thúc khám/điều trị: ");
                        var value = range.Worksheet.Cells["A14:F14"].RichText.Add(yeuCauTiepNhan.NoiTruBenhAn?.ThoiDiemRaVien?.ApplyFormatGioPhutNgay());
                        value.Bold = true;


                        range.Worksheet.Cells["A14:F14"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A14:F14"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A14:F14"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A14:F14"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["G14:J14"])
                    {
                        range.Worksheet.Cells["G14:J14"].Merge = true;
                        range.Worksheet.Cells["G14:J14"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["G14:J14"].RichText.Add("Tổng số ngày điều trị: ");
                        var value = range.Worksheet.Cells["G14:J14"].RichText.Add(NoiTruBenhAnHelper.TinhSoNgayDieuTri(yeuCauTiepNhan.NoiTruBenhAn)?.ToString() ?? string.Empty);
                        value.Bold = true;

                        range.Worksheet.Cells["G14:J14"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["G14:J14"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["G14:J14"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["G14:J14"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["K14:N14"])
                    {
                        range.Worksheet.Cells["K14:N14"].Merge = true;

                        range.Worksheet.Cells["K14:N14"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["K14:N14"].RichText.Add("(10)Tình trạng ra viện: ");
                        var value = range.Worksheet.Cells["K14:N14"].RichText.Add((yeuCauTiepNhan.NoiTruBenhAn?.TinhTrangRaVien == EnumTinhTrangRaVien.RaVien && (yeuCauTiepNhan.NoiTruBenhAn?.KetQuaDieuTri == EnumKetQuaDieuTri.Do || yeuCauTiepNhan.NoiTruBenhAn?.KetQuaDieuTri == EnumKetQuaDieuTri.Khoi) ? 1 : 2).ToString());
                        value.Bold = true;


                        range.Worksheet.Cells["K14:N14"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["K14:N14"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["K14:N14"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["K14:N14"].Style.Font.Color.SetColor(Color.Black);
                    }

                    //=================================15=================================
                    var coCapCuu = yeuCauTiepNhan.LyDoVaoVien == Enums.EnumLyDoVaoVien.CapCuu ? "X" : string.Empty;
                    var coDungTuyen = yeuCauTiepNhan.LyDoVaoVien == Enums.EnumLyDoVaoVien.DungTuyen ? "X" : string.Empty;
                    var coThongTuyen = yeuCauTiepNhan.LyDoVaoVien == Enums.EnumLyDoVaoVien.ThongTuyen ? "X" : string.Empty;
                    var coTraiTuyen = yeuCauTiepNhan.LyDoVaoVien == Enums.EnumLyDoVaoVien.TraiTuyen ? "X" : string.Empty;

                    using (var range = worksheet.Cells["A15:C15"])
                    {
                        range.Worksheet.Cells["A15:C15"].Merge = true;

                        range.Worksheet.Cells["A15:C15"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["A15:C15"].RichText.Add("(11) Cấp cứu: ");
                        var value = range.Worksheet.Cells["A15:C15"].RichText.Add(coCapCuu);
                        value.Bold = true;

                        range.Worksheet.Cells["A15:C15"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A15:C15"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A15:C15"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A15:C15"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["D15:F15"])
                    {
                        range.Worksheet.Cells["D15:F15"].Merge = true;
                        range.Worksheet.Cells["D15:F15"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["D15:F15"].RichText.Add("(12) Đúng tuyến: ");
                        var value = range.Worksheet.Cells["D15:F15"].RichText.Add(coDungTuyen);
                        value.Bold = true;

                        range.Worksheet.Cells["D15:F15"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["D15:F15"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["D15:F15"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["D15:F15"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["G15:J15"])
                    {
                        range.Worksheet.Cells["G15:J15"].Merge = true;
                        range.Worksheet.Cells["G15:J15"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["G15:J15"].RichText.Add("Nơi chuyến đến: ");
                        var value = range.Worksheet.Cells["G15:J15"].RichText.Add(yeuCauTiepNhan.NoiChuyen?.Ten);
                        value.Bold = true;
                        range.Worksheet.Cells["G15:J15"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["G15:J15"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["G15:J15"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["G15:J15"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["K15:N15"])
                    {
                        range.Worksheet.Cells["K15:N15"].Merge = true;
                        range.Worksheet.Cells["K15:N15"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["K15:N15"].RichText.Add("Nơi chuyển đi: ");
                        var value = range.Worksheet.Cells["K15:N15"].RichText.Add(yeuCauTiepNhan.NoiTruBenhAn?.ChuyenDenBenhVien?.Ten);
                        value.Bold = true;
                        range.Worksheet.Cells["K15:N15"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["K15:N15"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["K15:N15"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["K15:N15"].Style.Font.Color.SetColor(Color.Black);
                    }

                    //=================================16=================================
                    using (var range = worksheet.Cells["A16:C16"])
                    {
                        range.Worksheet.Cells["A16:C16"].Merge = true;
                        range.Worksheet.Cells["A16:C16"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["A16:C16"].RichText.Add("(13)Thông tuyến: ");
                        var value = range.Worksheet.Cells["A16:C16"].RichText.Add(coThongTuyen);
                        value.Bold = true;
                        range.Worksheet.Cells["A16:C16"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A16:C16"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A16:C16"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A16:C16"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["D16:F16"])
                    {
                        range.Worksheet.Cells["D16:F16"].Merge = true;
                        range.Worksheet.Cells["D16:F16"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["D16:F16"].RichText.Add("(14)Trái tuyến: ");
                        var value = range.Worksheet.Cells["D16:F16"].RichText.Add(coTraiTuyen);
                        value.Bold = true;

                        range.Worksheet.Cells["D16:F16"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["D16:F16"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["D16:F16"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["D16:F16"].Style.Font.Color.SetColor(Color.Black);
                    }

                    //================================= 17 =================================

                    var chuanDoanXacDinhStr = yeuCauTiepNhan.NoiTruBenhAn?.LoaiBenhAn == LoaiBenhAn.SanKhoaMo || yeuCauTiepNhan.NoiTruBenhAn?.LoaiBenhAn == LoaiBenhAn.SanKhoaThuong
                                                             ? chuanDoanXacDinhSanKhoa : yeuCauTiepNhan.NoiTruBenhAn?.ChanDoanChinhRaVienGhiChu;


                    var iCD10 = yeuCauTiepNhan.NoiTruBenhAn?.LoaiBenhAn == LoaiBenhAn.SanKhoaMo || yeuCauTiepNhan.NoiTruBenhAn?.LoaiBenhAn == LoaiBenhAn.SanKhoaThuong
                                                               ? maICD10 : yeuCauTiepNhan.NoiTruBenhAn?.ChanDoanChinhRaVienICD?.Ma;


                    using (var range = worksheet.Cells["A17:F17"])
                    {
                        range.Worksheet.Cells["A17:F17"].Merge = true;
                        range.Worksheet.Cells["A17:F17"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["A17:F17"].RichText.Add("(15)Chẩn đoán xác định: ");
                        var value = range.Worksheet.Cells["A17:F17"].RichText.Add(chuanDoanXacDinhStr);
                        value.Bold = true;

                        range.Worksheet.Cells["A17:F17"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A17:F17"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A17:F17"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A17:F17"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["G17:N17"])
                    {
                        range.Worksheet.Cells["G17:N17"].Merge = true;

                        range.Worksheet.Cells["G17:N17"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["G17:N17"].RichText.Add("(17) Mã bệnh: ");
                        var value = range.Worksheet.Cells["G17:N17"].RichText.Add(iCD10);
                        value.Bold = true;


                        range.Worksheet.Cells["G17:N17"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["G17:N17"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["G17:N17"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["G17:N17"].Style.Font.Color.SetColor(Color.Black);
                    }

                    //================================= 18 =================================

                    using (var range = worksheet.Cells["A18:F18"])
                    {
                        range.Worksheet.Cells["A18:F18"].Merge = true;
                        range.Worksheet.Cells["A18:F18"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["A18:F18"].RichText.Add("(18)Bệnh kèm theo: ");
                        var value = range.Worksheet.Cells["A18:F18"].RichText.Add(tenICDKemTheo);
                        value.Bold = true;


                        range.Worksheet.Cells["A18:F18"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A18:F18"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A18:F18"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A18:F18"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["G18:N18"])
                    {
                        range.Worksheet.Cells["G18:N18"].Merge = true;
                        range.Worksheet.Cells["G18:N18"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["G18:N18"].RichText.Add("(18)Mã bệnh kèm theo: ");
                        var value = range.Worksheet.Cells["G18:N18"].RichText.Add(maICDKemTheo);
                        value.Bold = true;


                        range.Worksheet.Cells["G18:N18"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["G18:N18"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["G18:N18"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["G18:N18"].Style.Font.Color.SetColor(Color.Black);
                    }

                    //================================= 19 =================================

                    using (var range = worksheet.Cells["A19:F19"])
                    {
                        range.Worksheet.Cells["A19:F19"].Merge = true;
                        range.Worksheet.Cells["A19:F19"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["A19:F19"].RichText.Add("(19)Thời điểm đủ 05 năm liên tục từ ngày: ");
                        var value = range.Worksheet.Cells["A19:F19"].RichText.Add(yeuCauTiepNhan.BHYTNgayDu5Nam?.ApplyFormatDate());
                        value.Bold = true;


                        range.Worksheet.Cells["A19:F19"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A19:F19"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A19:F19"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A19:F19"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["G19:N19"])
                    {
                        range.Worksheet.Cells["G19:N19"].Merge = true;
                        range.Worksheet.Cells["G19:N19"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["G19:N19"].RichText.Add("(20)Miễn cùng chi trả trong năm từ ngày: ");
                        var value = range.Worksheet.Cells["G19:N19"].RichText.Add(yeuCauTiepNhan.BHYTNgayDuocMienCungChiTra?.ApplyFormatDate());
                        value.Bold = true;

                        range.Worksheet.Cells["G19:N19"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["G19:N19"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["G19:N19"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["G19:N19"].Style.Font.Color.SetColor(Color.Black);
                    }

                    //================================= 20 =================================

                    using (var range = worksheet.Cells["A20:N20"])
                    {
                        range.Worksheet.Cells["A20:N20"].Merge = true;
                        range.Worksheet.Cells["A20:N20"].Value = "II. Phần Chi phí khám bệnh, chữa bệnh";
                        range.Worksheet.Cells["A20:N20"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A20:N20"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A20:N20"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A20:N20"].Style.Font.Color.SetColor(Color.Black);
                        range.Worksheet.Cells["A20:N20"].Style.Font.Bold = true;
                    }

                    int index = 21;

                    var groupChiPhiTheoThe = danhSachChiPhi.GroupBy(o => o.MaSoTheBHYT);

                    if (groupChiPhiTheoThe.Count() > 2 ||
                        (groupChiPhiTheoThe.All(o => o.Key != string.Empty) && groupChiPhiTheoThe.Count() > 1))
                    {
                        var groupNgayPhatSinhTheoThe = groupChiPhiTheoThe.Where(o => o.Key != string.Empty).Select(o => new { o.Key, o.OrderBy(j => j.NgayPhatSinh).First().NgayPhatSinh }).OrderBy(o => o.NgayPhatSinh).ToArray();
                        for (int i = 0; i < groupNgayPhatSinhTheoThe.Count(); i++)
                        {
                            var ngayPhatSinhTheoThe = groupNgayPhatSinhTheoThe[i];
                            var theBHYTChiTra = yeuCauTiepNhan.YeuCauTiepNhanTheBHYTs.First(o => o.MaSoThe == ngayPhatSinhTheoThe.Key);
                            var chiPhis = groupChiPhiTheoThe.FirstOrDefault(o => o.Key == ngayPhatSinhTheoThe.Key).ToList();
                            DateTime? ngayPhatSinhTiepTheo = i < groupNgayPhatSinhTheoThe.Count() - 1
                                ? groupNgayPhatSinhTheoThe[i + 1].NgayPhatSinh
                                : null;
                            chiPhis.AddRange(groupChiPhiTheoThe.FirstOrDefault(o => o.Key == string.Empty).Where(j => (i == 0 || j.NgayPhatSinh >= ngayPhatSinhTheoThe.NgayPhatSinh) && (ngayPhatSinhTiepTheo != null && j.NgayPhatSinh < ngayPhatSinhTiepTheo)).ToList());
                            var mucHuongPT = theBHYTChiTra != null && theBHYTChiTra?.MucHuong > 0 ? theBHYTChiTra?.MucHuong + "%" : string.Empty;


                            using (var range = worksheet.Cells["A" + index + ":C" + index])
                            {
                                range.Worksheet.Cells["A" + index + ":C" + index].Merge = true;
                                range.Worksheet.Cells["A" + index + ":C" + index].Style.WrapText = true;
                                var title = range.Worksheet.Cells["A" + index + ":C" + index].RichText.Add("Mã thẻ BHYT: ");
                                var value = range.Worksheet.Cells["A" + index + ":C" + index].RichText.Add(theBHYTChiTra.MaSoThe);
                                value.Bold = true;

                                range.Worksheet.Cells["A" + index + ":C" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                range.Worksheet.Cells["A" + index + ":C" + index].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                                range.Worksheet.Cells["A" + index + ":C" + index].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                                range.Worksheet.Cells["A" + index + ":C" + index].Style.Font.Color.SetColor(Color.Black);
                            }

                            using (var range = worksheet.Cells["D" + index + ":F" + index])
                            {
                                range.Worksheet.Cells["D" + index + ":F" + index].Merge = true;
                                range.Worksheet.Cells["D" + index + ":F" + index].Style.WrapText = true;
                                var title = range.Worksheet.Cells["D" + index + ":F" + index].RichText.Add("Giá trị từ: ");
                                var valuebHYTTuNgay = range.Worksheet.Cells["D" + index + ":F" + index].RichText.Add(theBHYTChiTra.NgayHieuLuc.ApplyFormatDate());
                                valuebHYTTuNgay.Bold = true;

                                var den = range.Worksheet.Cells["D" + index + ":F" + index].RichText.Add(" đến: ");
                                den.Bold = false;
                                var valuebHYTDenNgay = range.Worksheet.Cells["D" + index + ":F" + index].RichText.Add(theBHYTChiTra?.NgayHetHan?.ApplyFormatDate());
                                valuebHYTDenNgay.Bold = true;

                                range.Worksheet.Cells["D" + index + ":F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                range.Worksheet.Cells["D" + index + ":F" + index].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                                range.Worksheet.Cells["D" + index + ":F" + index].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                                range.Worksheet.Cells["D" + index + ":F" + index].Style.Font.Color.SetColor(Color.Black);
                            }

                            using (var range = worksheet.Cells["G" + index + ":J" + index])
                            {
                                range.Worksheet.Cells["G" + index + ":J" + index].Merge = true;
                                range.Worksheet.Cells["G" + index + ":J" + index].Style.WrapText = true;
                                var title = range.Worksheet.Cells["G" + index + ":J" + index].RichText.Add("Mức hưởng: ");
                                var value = range.Worksheet.Cells["G" + index + ":J" + index].RichText.Add(mucHuongPT);
                                value.Bold = true;


                                range.Worksheet.Cells["G" + index + ":J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                range.Worksheet.Cells["G" + index + ":J" + index].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                                range.Worksheet.Cells["G" + index + ":J" + index].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                                range.Worksheet.Cells["G" + index + ":J" + index].Style.Font.Color.SetColor(Color.Black);
                            }

                            index++;

                            var indexTableFirst = index;
                            var indexTableLast = index + 1;

                            using (var range = worksheet.Cells["A" + indexTableFirst + ":N" + indexTableLast])
                            {
                                range.Worksheet.Cells["A" + indexTableFirst + ":N" + indexTableLast].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                                range.Worksheet.Cells["A" + indexTableFirst + ":N" + indexTableLast].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                                range.Worksheet.Cells["A" + indexTableFirst + ":N" + indexTableLast].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                range.Worksheet.Cells["A" + indexTableFirst + ":N" + indexTableLast].Style.Font.Color.SetColor(Color.Black);
                                range.Worksheet.Cells["A" + indexTableFirst + ":N" + indexTableLast].Style.Font.Bold = true;
                                range.Worksheet.Cells["A" + indexTableFirst + ":N" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);

                                range.Worksheet.Cells["A" + indexTableFirst + ":A" + indexTableLast].Merge = true;
                                range.Worksheet.Cells["A" + indexTableFirst + ":A" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["A" + indexTableFirst + ":A" + indexTableLast].Value = "STT";

                                range.Worksheet.Cells["B" + indexTableFirst + ":B" + indexTableLast].Merge = true;
                                range.Worksheet.Cells["B" + indexTableFirst + ":B" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["B" + indexTableFirst + ":B" + indexTableLast].Value = "Nội dung";

                                range.Worksheet.Cells["C" + indexTableFirst + ":C" + indexTableLast].Merge = true;
                                range.Worksheet.Cells["C" + indexTableFirst + ":C" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["C" + indexTableFirst + ":C" + indexTableLast].Value = "Đơn vị tính";

                                range.Worksheet.Cells["D" + indexTableFirst + ":D" + indexTableLast].Merge = true;
                                range.Worksheet.Cells["D" + indexTableFirst + ":D" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["D" + indexTableFirst + ":D" + indexTableLast].Value = "Số lượng";

                                range.Worksheet.Cells["E" + indexTableFirst + ":E" + indexTableLast].Merge = true;
                                range.Worksheet.Cells["E" + indexTableFirst + ":E" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["E" + indexTableFirst + ":E" + indexTableLast].Value = "Đơn giá BV(đồng)";

                                range.Worksheet.Cells["F" + indexTableFirst + ":F" + indexTableLast].Merge = true;
                                range.Worksheet.Cells["F" + indexTableFirst + ":F" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["F" + indexTableFirst + ":F" + indexTableLast].Value = "Đơn giá BH(đồng)";

                                range.Worksheet.Cells["G" + indexTableFirst + ":G" + indexTableLast].Merge = true;
                                range.Worksheet.Cells["G" + indexTableFirst + ":G" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["G" + indexTableFirst + ":G" + indexTableLast].Value = "Tỉ lệ thanh toán theo dịch vụ (%)";

                                range.Worksheet.Cells["H" + indexTableFirst + ":H" + indexTableLast].Merge = true;
                                range.Worksheet.Cells["H" + indexTableFirst + ":H" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["H" + indexTableFirst + ":H" + indexTableLast].Value = "Thành tiền BV (đồng)";

                                range.Worksheet.Cells["I" + indexTableFirst + ":I" + indexTableLast].Merge = true;
                                range.Worksheet.Cells["I" + indexTableFirst + ":I" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["I" + indexTableFirst + ":I" + indexTableLast].Value = "Tỷ lệ thanh toán BHYT (%)";

                                range.Worksheet.Cells["J" + indexTableFirst + ":J" + indexTableLast].Merge = true;
                                range.Worksheet.Cells["J" + indexTableFirst + ":J" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["J" + indexTableFirst + ":J" + indexTableLast].Value = "Thành tiền BH(đồng)";

                                range.Worksheet.Cells["K" + indexTableFirst + ":N" + indexTableFirst].Merge = true;
                                range.Worksheet.Cells["K" + indexTableFirst + ":N" + indexTableFirst].Value = "Nguồn thanh toán (đồng)";

                                range.Worksheet.Cells["K" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["K" + indexTableLast].Value = "Quỹ BHYT";

                                range.Worksheet.Cells["L" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["L" + indexTableLast].Value = "Người bệnh cùng chi trả (đồng)";

                                range.Worksheet.Cells["M" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["M" + indexTableLast].Value = "Khác (đồng)";

                                range.Worksheet.Cells["N" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["N" + indexTableLast].Value = "Người bệnh tự trả(đồng)";
                            }

                            index = indexTableLast + 1;

                            var dsChiPhiBangKeTheoThe = new List<BangKeKhamBenhCoBHYTVo>();
                            foreach (var chiPhi in chiPhis.Where(c => c.NhomChiPhiBangKe != NhomChiPhiBangKe.GoiVatTu).GroupBy(c => new { c.NhomChiPhiBangKe, c.TenDichVu, c.DonViTinh, c.DuocHuongBHYT, c.DonGia, c.DonGiaBHYT, c.MucHuongBaoHiem, c.TiLeBaoHiemThanhToan }).OrderByDescending(o => o.Key.DuocHuongBHYT))
                            {
                                dsChiPhiBangKeTheoThe.Add(new BangKeKhamBenhCoBHYTVo
                                {
                                    Nhom = chiPhi.Key.NhomChiPhiBangKe,
                                    Id = chiPhi.FirstOrDefault().Id,
                                    NoiDung = chiPhi.Key.TenDichVu,
                                    DonViTinh = chiPhi.Key.DonViTinh,
                                    SoLuong = (decimal)chiPhi.Sum(c => c.Soluong),
                                    DuocHuongBaoHiem = chiPhi.Key.DuocHuongBHYT,
                                    DonGiaBH = chiPhi.Key.DonGiaBHYT,
                                    DonGiaTheoBV = chiPhi.Key.DonGia,
                                    MucHuongBaoHiem = chiPhi.Key.MucHuongBaoHiem,
                                    TiLeThanhToanTheoDV = chiPhi.Key.TiLeBaoHiemThanhToan,
                                    BaoHiemChiTra = true
                                });
                            }

                            foreach (var chiPhi in chiPhis.Where(c => c.NhomChiPhiBangKe == NhomChiPhiBangKe.GoiVatTu).OrderByDescending(o => o.DuocHuongBHYT))
                            {
                                dsChiPhiBangKeTheoThe.Add(new BangKeKhamBenhCoBHYTVo
                                {
                                    Nhom = chiPhi.NhomChiPhiBangKe,
                                    Id = chiPhi.Id,
                                    NoiDung = chiPhi.TenDichVu,
                                    DonViTinh = chiPhi.DonViTinh,
                                    SoLuong = (decimal)chiPhi.Soluong,
                                    DuocHuongBaoHiem = chiPhi.DuocHuongBHYT,
                                    DonGiaBH = chiPhi.DonGiaBHYT,
                                    DonGiaTheoBV = chiPhi.DonGia,
                                    MucHuongBaoHiem = chiPhi.MucHuongBaoHiem,
                                    TiLeThanhToanTheoDV = chiPhi.TiLeBaoHiemThanhToan,
                                    BaoHiemChiTra = true
                                });
                            }
                            dsChiPhiBangKe.AddRange(dsChiPhiBangKeTheoThe);
                            var groupChiPhiBangKes = dsChiPhiBangKeTheoThe.GroupBy(x => x.Nhom).OrderBy(o => (int)o.Key * (o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay || o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriNoiTru ? 1 : 10));
                            if (!groupChiPhiBangKes.Any())
                            {
                                return null;
                            }
                            foreach (var groupChiPhiBangKe in groupChiPhiBangKes)
                            {
                                if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay)
                                {

                                    worksheet.Cells["A" + index + ":N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["A" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                    worksheet.Cells["A" + index + ":N" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                    worksheet.Cells["A" + index + ":N" + index].Merge = true;
                                    worksheet.Cells["A" + index + ":N" + index].Value = "2. Ngày giường:";
                                    worksheet.Cells["A" + index + ":N" + index].Style.Font.Bold = true;

                                    index++;

                                    worksheet.Cells["A" + index + ":G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["A" + index + ":G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                    worksheet.Cells["A" + index + ":G" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                    worksheet.Cells["A" + index + ":G" + index].Merge = true;
                                    worksheet.Cells["A" + index + ":G" + index].Value = "2.1." + groupChiPhiBangKe.Key.GetDescription();
                                    worksheet.Cells["A" + index + ":G" + index].Style.Font.Bold = true;

                                    worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["H" + index].Style.Font.Bold = true;
                                    worksheet.Cells["H" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBV);

                                    worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["J" + index].Style.Font.Bold = true;
                                    worksheet.Cells["J" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBH);

                                    worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["K" + index].Style.Font.Bold = true;
                                    worksheet.Cells["K" + index].Value = groupChiPhiBangKe.Sum(o => o.QuyBHYT);

                                    worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["L" + index].Style.Font.Bold = true;
                                    worksheet.Cells["L" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra);

                                    worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["M" + index].Style.Font.Bold = true;
                                    worksheet.Cells["M" + index].Value = groupChiPhiBangKe.Sum(o => o.Khac);

                                    worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["N" + index].Style.Font.Bold = true;
                                    worksheet.Cells["N" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra);

                                    index++;
                                }
                                else if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.NgayGiuongDieuTriNoiTru)
                                {
                                    if (!groupChiPhiBangKes.Any(o => o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay))
                                    {
                                        worksheet.Cells["A" + index + ":N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["A" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                        worksheet.Cells["A" + index + ":N" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                        worksheet.Cells["A" + index + ":N" + index].Merge = true;
                                        worksheet.Cells["A" + index + ":N" + index].Value = "2. Ngày giường:";
                                        worksheet.Cells["A" + index + ":N" + index].Style.Font.Bold = true;

                                    }

                                    index++;

                                    worksheet.Cells["A" + index + ":G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["A" + index + ":G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                    worksheet.Cells["A" + index + ":G" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                    worksheet.Cells["A" + index + ":G" + index].Merge = true;
                                    worksheet.Cells["A" + index + ":G" + index].Value = "2.2." + groupChiPhiBangKe.Key.GetDescription();
                                    worksheet.Cells["A" + index + ":G" + index].Style.Font.Bold = true;

                                    worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["H" + index].Style.Font.Bold = true;
                                    worksheet.Cells["H" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBV);

                                    worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["J" + index].Style.Font.Bold = true;
                                    worksheet.Cells["J" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBH);

                                    worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["K" + index].Style.Font.Bold = true;
                                    worksheet.Cells["K" + index].Value = groupChiPhiBangKe.Sum(o => o.QuyBHYT);

                                    worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["L" + index].Style.Font.Bold = true;
                                    worksheet.Cells["L" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra);

                                    worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["M" + index].Style.Font.Bold = true;
                                    worksheet.Cells["M" + index].Value = groupChiPhiBangKe.Sum(o => o.Khac);

                                    worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["N" + index].Style.Font.Bold = true;
                                    worksheet.Cells["N" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra);

                                    index++;
                                }
                                else
                                {
                                    worksheet.Cells["A" + index + ":G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["A" + index + ":G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                    worksheet.Cells["A" + index + ":G" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                    worksheet.Cells["A" + index + ":G" + index].Merge = true;
                                    worksheet.Cells["A" + index + ":G" + index].Value = (int)groupChiPhiBangKe.Key + "." + groupChiPhiBangKe.Key.GetDescription();
                                    worksheet.Cells["A" + index + ":G" + index].Style.Font.Bold = true;

                                    worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["H" + index].Style.Font.Bold = true;
                                    worksheet.Cells["H" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBV);

                                    worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["J" + index].Style.Font.Bold = true;
                                    worksheet.Cells["J" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBH);

                                    worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["K" + index].Style.Font.Bold = true;
                                    worksheet.Cells["K" + index].Value = groupChiPhiBangKe.Sum(o => o.QuyBHYT);

                                    worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["L" + index].Style.Font.Bold = true;
                                    worksheet.Cells["L" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra);

                                    worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["M" + index].Style.Font.Bold = true;
                                    worksheet.Cells["M" + index].Value = groupChiPhiBangKe.Sum(o => o.Khac);

                                    worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["N" + index].Style.Font.Bold = true;
                                    worksheet.Cells["N" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra);

                                    index++;
                                }
                                if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.GoiVatTu)
                                {
                                    var groupGoiVatTus = groupChiPhiBangKe.ToList().GroupBy(o => o.SoGoiVatTu.GetValueOrDefault()).OrderBy(o => o.Key);
                                    int sttGoiVatTu = 1;
                                    foreach (var groupGoiVatTu in groupGoiVatTus)
                                    {
                                        worksheet.Cells["A" + index + ":G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["A" + index + ":G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                        worksheet.Cells["A" + index + ":G" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                        worksheet.Cells["A" + index + ":G" + index].Value = "10." + sttGoiVatTu + ". " + groupChiPhiBangKe.Key.GetDescription() + " " + sttGoiVatTu;
                                        worksheet.Cells["A" + index + ":G" + index].Style.Font.Bold = true;
                                        worksheet.Cells["A" + index + ":G" + index].Merge = true;

                                        worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["H" + index].Style.Font.Bold = true;
                                        worksheet.Cells["H" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBV);

                                        worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["J" + index].Style.Font.Bold = true;
                                        worksheet.Cells["J" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBH);

                                        worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["K" + index].Style.Font.Bold = true;
                                        worksheet.Cells["K" + index].Value = groupChiPhiBangKe.Sum(o => o.QuyBHYT);

                                        worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["L" + index].Style.Font.Bold = true;
                                        worksheet.Cells["L" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra);

                                        worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["M" + index].Style.Font.Bold = true;
                                        worksheet.Cells["M" + index].Value = groupChiPhiBangKe.Sum(o => o.Khac);

                                        worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["N" + index].Style.Font.Bold = true;
                                        worksheet.Cells["N" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra);

                                        index++;

                                        foreach (var chiPhiBangKe in groupGoiVatTu)
                                        {
                                            worksheet.Cells["A" + index + ":N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["A" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                            worksheet.Cells["A" + index + ":N" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));

                                            worksheet.Cells["A" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["A" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                            worksheet.Cells["A" + index].Value = indexItem;

                                            worksheet.Cells["B" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["B" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                            worksheet.Cells["B" + index].Value = chiPhiBangKe.NoiDung;

                                            worksheet.Cells["C" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["C" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                            worksheet.Cells["C" + index].Value = chiPhiBangKe.DonViTinh;

                                            worksheet.Cells["D" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["D" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                            worksheet.Cells["D" + index].Value = chiPhiBangKe.SoLuong;

                                            worksheet.Cells["E" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["E" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                            worksheet.Cells["E" + index].Style.Numberformat.Format = "#,##0.00";
                                            worksheet.Cells["E" + index].Value = chiPhiBangKe.DonGiaBV;

                                            worksheet.Cells["F" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["F" + index].Style.Numberformat.Format = "#,##0.00";
                                            worksheet.Cells["F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                            worksheet.Cells["F" + index].Value = chiPhiBangKe.DonGiaBH;

                                            worksheet.Cells["G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                            worksheet.Cells["G" + index].Style.Numberformat.Format = "#,##0.00";
                                            worksheet.Cells["G" + index].Value = chiPhiBangKe.TiLeThanhToanTheoDV;

                                            worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                            worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                            worksheet.Cells["H" + index].Value = chiPhiBangKe.ThanhTienBV;

                                            worksheet.Cells["I" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["I" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                            worksheet.Cells["I" + index].Value = Convert.ToDouble(chiPhiBangKe.MucHuongBaoHiem > 0 ? 100 : 0).ApplyFormatMoneyToDouble();


                                            worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                            worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                            worksheet.Cells["J" + index].Value = chiPhiBangKe.ThanhTienBH;


                                            worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                            worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                            worksheet.Cells["K" + index].Value = chiPhiBangKe.QuyBHYT;


                                            worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                            worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                            worksheet.Cells["L" + index].Value = chiPhiBangKe.NguoiBenhCungChiTra;


                                            worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                            worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                            worksheet.Cells["M" + index].Value = chiPhiBangKe.Khac;


                                            worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                            worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                            worksheet.Cells["N" + index].Value = chiPhiBangKe.NguoiBenhTuTra;

                                            indexItem++;
                                            index++;
                                        }
                                    }
                                }
                                else
                                {
                                    foreach (var chiPhiBangKe in groupChiPhiBangKe)
                                    {
                                        worksheet.Cells["A" + index + ":N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["A" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                        worksheet.Cells["A" + index + ":N" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));

                                        worksheet.Cells["A" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["A" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                        worksheet.Cells["A" + index].Value = indexItem;

                                        worksheet.Cells["B" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["B" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                        worksheet.Cells["B" + index].Value = chiPhiBangKe.NoiDung;

                                        worksheet.Cells["C" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["C" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                        worksheet.Cells["C" + index].Value = chiPhiBangKe.DonViTinh;

                                        worksheet.Cells["D" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["D" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                        worksheet.Cells["D" + index].Value = chiPhiBangKe.SoLuong;

                                        worksheet.Cells["E" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["E" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["E" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["E" + index].Value = chiPhiBangKe.DonGiaBV;

                                        worksheet.Cells["F" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["F" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["F" + index].Value = chiPhiBangKe.DonGiaBH;

                                        worksheet.Cells["G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["G" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["G" + index].Value = chiPhiBangKe.TiLeThanhToanTheoDV;

                                        worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["H" + index].Value = chiPhiBangKe.ThanhTienBV;

                                        worksheet.Cells["I" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["I" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["I" + index].Value = Convert.ToDouble(chiPhiBangKe.MucHuongBaoHiem > 0 ? 100 : 0).ApplyFormatMoneyToDouble();


                                        worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["J" + index].Value = chiPhiBangKe.ThanhTienBH;


                                        worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["K" + index].Value = chiPhiBangKe.QuyBHYT;


                                        worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["L" + index].Value = chiPhiBangKe.NguoiBenhCungChiTra;


                                        worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["M" + index].Value = chiPhiBangKe.Khac;


                                        worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["N" + index].Value = chiPhiBangKe.NguoiBenhTuTra;

                                        indexItem++;
                                        index++;
                                    }
                                }

                            }

                            worksheet.Cells["A" + index + ":G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["A" + index + ":G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                            worksheet.Cells["A" + index + ":G" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                            worksheet.Cells["A" + index + ":G" + index].Merge = true;
                            worksheet.Cells["A" + index + ":G" + index].Value = "Tổng cộng";
                            worksheet.Cells["A" + index + ":G" + index].Style.Font.Bold = true;

                            worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                            worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                            worksheet.Cells["H" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.ThanhTienBV)).Sum();

                            worksheet.Cells["I" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["I" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;

                            worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                            worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                            worksheet.Cells["J" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.ThanhTienBH)).Sum();

                            worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                            worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                            worksheet.Cells["K" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.QuyBHYT)).Sum();

                            worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                            worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                            worksheet.Cells["L" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.NguoiBenhCungChiTra)).Sum();

                            worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                            worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                            worksheet.Cells["M" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.Khac)).Sum();

                            worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                            worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                            worksheet.Cells["N" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.NguoiBenhTuTra)).Sum();

                            index++;

                            worksheet.Cells["A" + index + ":N" + index].Merge = true;
                            worksheet.Cells["A" + index + ":N" + index].Value = "Tổng chi phí lần khám bệnh/cả đợt điều trị: " + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble() + " đồng";
                            worksheet.Cells["A" + index + ":N" + index].Style.Font.Bold = true;

                            index++;

                            worksheet.Cells["A" + index + ":N" + index].Merge = true;
                            worksheet.Cells["A" + index + ":N" + index].Value = "(Viết bằng chữ: " + NumberHelper.ChuyenSoRaText(Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBH))) + ")";

                            index++;

                            worksheet.Cells["A" + index + ":N" + index].Merge = true;
                            worksheet.Cells["A" + index + ":N" + index].Value = "Trong đó , số tiền do:";
                            worksheet.Cells["A" + index + ":N" + index].Style.Font.Bold = true;

                            index++;
                            worksheet.Cells["A" + index + ":N" + index].Merge = true;
                            worksheet.Cells["A" + index + ":N" + index].Value = "- Quỹ BHYT thanh toán: " + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble();

                            index++;
                            worksheet.Cells["A" + index + ":N" + index].Merge = true;
                            worksheet.Cells["A" + index + ":N" + index].Value = "- Người bệnh trả trong đó: " + (Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)) + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhTuTra))).ApplyFormatMoneyToDouble();

                            index++;
                            worksheet.Cells["A" + index + ":N" + index].Merge = true;
                            worksheet.Cells["A" + index + ":N" + index].Value = "+ Cùng chi trả trong phạm vi BHYT: " + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble(true);

                            index++;
                            worksheet.Cells["A" + index + ":N" + index].Merge = true;
                            worksheet.Cells["A" + index + ":N" + index].Value = "+ Các khoản phải trả khác: " + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true);

                            index++;
                            worksheet.Cells["A" + index + ":N" + index].Merge = true;
                            worksheet.Cells["A" + index + ":N" + index].Value = "+ Nguồn khác: " + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble(true);


                            index = index + 2;

                            worksheet.Cells["D" + index + ":F" + index].Style.Font.SetFromFont(new Font("Times New Roman", 12));
                            worksheet.Cells["D" + index + ":F" + index].Merge = true;
                            worksheet.Cells["D" + index + ":F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                            worksheet.Cells["D" + index + ":F" + index].Style.VerticalAlignment = ExcelVerticalAlignment.Top;
                            worksheet.Cells["D" + index + ":F" + index].Value = $"Ngày {DateTime.Now.Day} tháng {DateTime.Now.Month} năm {DateTime.Now.Year}";

                            worksheet.Cells["G" + index + ":I" + index].Style.Font.SetFromFont(new Font("Times New Roman", 12));
                            worksheet.Cells["G" + index + ":I" + index].Merge = true;
                            worksheet.Cells["G" + index + ":I" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                            worksheet.Cells["G" + index + ":I" + index].Style.VerticalAlignment = ExcelVerticalAlignment.Top;
                            worksheet.Cells["G" + index + ":I" + index].Value = $"Ngày {DateTime.Now.Day} tháng {DateTime.Now.Month} năm {DateTime.Now.Year}";

                            worksheet.Cells["J" + index + ":N" + index].Style.Font.Bold = true;
                            worksheet.Cells["J" + index + ":N" + index].Merge = true;
                            worksheet.Cells["J" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                            worksheet.Cells["J" + index + ":N" + index].Value = "XÁC NHẬN CỦA NGƯỜI BỆNH ";

                            index++;

                            worksheet.Cells["A" + index + ":C" + index].Style.Font.Bold = true;
                            worksheet.Cells["A" + index + ":C" + index].Merge = true;
                            worksheet.Cells["A" + index + ":C" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                            worksheet.Cells["A" + index + ":C" + index].Value = "NGƯỜI LẬP BẢNG KÊ";

                            worksheet.Cells["D" + index + ":F" + index].Style.Font.Bold = true;
                            worksheet.Cells["D" + index + ":F" + index].Merge = true;
                            worksheet.Cells["D" + index + ":F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                            worksheet.Cells["D" + index + ":F" + index].Value = "KẾ TOÁN VIỆN PHÍ";

                            worksheet.Cells["G" + index + ":I" + index].Style.Font.Bold = true;
                            worksheet.Cells["G" + index + ":I" + index].Merge = true;
                            worksheet.Cells["G" + index + ":I" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                            worksheet.Cells["G" + index + ":I" + index].Value = "GIÁM ĐỊNH BHYT";

                            worksheet.Cells["J" + index + ":N" + index].Style.Font.Bold = true;
                            worksheet.Cells["J" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                            worksheet.Cells["J" + index + ":N" + index].Merge = true;
                            worksheet.Cells["J" + index + ":N" + index].Value = "(Ký , Ghi rõ họ tên)";

                            index++;

                            worksheet.Cells["A" + index + ":C" + index].Style.Font.Bold = true;
                            worksheet.Cells["A" + index + ":C" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                            worksheet.Cells["A" + index + ":C" + index].Merge = true;
                            worksheet.Cells["A" + index + ":C" + index].Value = "(Ký , Ghi rõ họ tên)";


                            worksheet.Cells["D" + index + ":F" + index].Style.Font.Bold = true;
                            worksheet.Cells["D" + index + ":F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                            worksheet.Cells["D" + index + ":F" + index].Merge = true;
                            worksheet.Cells["D" + index + ":F" + index].Value = "(Ký , Ghi rõ họ tên)";

                            worksheet.Cells["G" + index + ":I" + index].Style.Font.Bold = true;
                            worksheet.Cells["G" + index + ":I" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                            worksheet.Cells["G" + index + ":I" + index].Merge = true;
                            worksheet.Cells["G" + index + ":I" + index].Value = "(Ký , Ghi rõ họ tên)";

                            worksheet.Cells["J" + index + ":N" + index].Style.Font.Bold = true;
                            worksheet.Cells["J" + index + ":N" + index].Merge = true;
                            worksheet.Cells["J" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                            worksheet.Cells["J" + index + ":N" + index].Value = "(Tôi đã nhận...phim...Xquang / CT / MRI)";

                            xlPackage.Save();
                        }
                    }
                    else
                    {
                        YeuCauTiepNhanTheBHYT theBHYTChiTra = null;
                        var maSoThe = groupChiPhiTheoThe.Where(o => o.Key != string.Empty).FirstOrDefault()?.Key;
                        if (!string.IsNullOrEmpty(maSoThe))
                        {
                            theBHYTChiTra = yeuCauTiepNhan.YeuCauTiepNhanTheBHYTs.First(o => o.MaSoThe == maSoThe);
                        }

                        var chiPhis = groupChiPhiTheoThe.SelectMany(o => o).ToList();
                        var mucHuongPT = theBHYTChiTra != null && theBHYTChiTra?.MucHuong > 0 ? theBHYTChiTra?.MucHuong + "%" : string.Empty;

                        using (var range = worksheet.Cells["A21:C21"])
                        {
                            range.Worksheet.Cells["A21:C21"].Merge = true;
                            range.Worksheet.Cells["A21:C21"].Style.WrapText = true;
                            var title = range.Worksheet.Cells["A21:C21"].RichText.Add("Mã thẻ BHYT: ");
                            var value = range.Worksheet.Cells["A21:C21"].RichText.Add(maBHYT);
                            value.Bold = true;

                            range.Worksheet.Cells["A21:C21"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                            range.Worksheet.Cells["A21:C21"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                            range.Worksheet.Cells["A21:C21"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                            range.Worksheet.Cells["A21:C21"].Style.Font.Color.SetColor(Color.Black);
                        }
                        using (var range = worksheet.Cells["A21:N21"])
                        {
                            range.Worksheet.Cells["D" + index + ":F" + index].Merge = true;
                            range.Worksheet.Cells["D" + index + ":F" + index].Style.WrapText = true;
                            var title = range.Worksheet.Cells["D" + index + ":F" + index].RichText.Add("Giá trị từ: ");
                            var valuebHYTTuNgay = range.Worksheet.Cells["D" + index + ":F" + index].RichText.Add(bHYTTuNgay);
                            valuebHYTTuNgay.Bold = true;

                            var den = range.Worksheet.Cells["D" + index + ":F" + index].RichText.Add(" đến: ");
                            den.Bold = false;
                            var valuebHYTDenNgay = range.Worksheet.Cells["D" + index + ":F" + index].RichText.Add(bHYTDenNgay);
                            valuebHYTDenNgay.Bold = true;

                            range.Worksheet.Cells["D" + index + ":F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                            range.Worksheet.Cells["D" + index + ":F" + index].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                            range.Worksheet.Cells["D" + index + ":F" + index].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                            range.Worksheet.Cells["D" + index + ":F" + index].Style.Font.Color.SetColor(Color.Black);
                        }
                        using (var range = worksheet.Cells["G21:J21"])
                        {
                            range.Worksheet.Cells["G21:J21"].Merge = true;
                            range.Worksheet.Cells["G21:J21"].Style.WrapText = true;
                            var title = range.Worksheet.Cells["G21:J21"].RichText.Add("Mức hưởng: ");
                            var value = range.Worksheet.Cells["G21:J21"].RichText.Add(mucHuong);
                            value.Bold = true;


                            range.Worksheet.Cells["G21:J21"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                            range.Worksheet.Cells["G21:J21"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                            range.Worksheet.Cells["G21:J21"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                            range.Worksheet.Cells["G21:J21"].Style.Font.Color.SetColor(Color.Black);
                        }
                        using (var range = worksheet.Cells["A22:N23"])
                        {
                            range.Worksheet.Cells["A22:N23"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                            range.Worksheet.Cells["A22:N23"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                            range.Worksheet.Cells["A22:N23"].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                            range.Worksheet.Cells["A22:N23"].Style.Font.Color.SetColor(Color.Black);
                            range.Worksheet.Cells["A22:N23"].Style.Font.Bold = true;
                            range.Worksheet.Cells["A22:N23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);

                            range.Worksheet.Cells["A22:A23"].Merge = true;
                            range.Worksheet.Cells["A22:A23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["A22:A23"].Value = "STT";

                            range.Worksheet.Cells["B22:B23"].Merge = true;
                            range.Worksheet.Cells["B22:B23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["B22:B23"].Value = "Nội dung";

                            range.Worksheet.Cells["C22:C23"].Merge = true;
                            range.Worksheet.Cells["C22:C23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["C22:C23"].Value = "Đơn vị tính";

                            range.Worksheet.Cells["D22:D23"].Merge = true;
                            range.Worksheet.Cells["D22:D23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["D22:D23"].Value = "Số lượng";

                            range.Worksheet.Cells["E22:E23"].Merge = true;
                            range.Worksheet.Cells["E22:E23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["E22:E23"].Value = "Đơn giá BV(đồng)";

                            range.Worksheet.Cells["F22:F23"].Merge = true;
                            range.Worksheet.Cells["F22:F23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["F22:F23"].Value = "Đơn giá BH(đồng)";

                            range.Worksheet.Cells["G22:G23"].Merge = true;
                            range.Worksheet.Cells["G22:G23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["G22:G23"].Value = "Tỉ lệ thanh toán theo dịch vụ (%)";

                            range.Worksheet.Cells["H22:H23"].Merge = true;
                            range.Worksheet.Cells["H22:H23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["H22:H23"].Value = "Thành tiền BV (đồng)";

                            range.Worksheet.Cells["I22:I23"].Merge = true;
                            range.Worksheet.Cells["I22:I23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["I22:I23"].Value = "Tỷ lệ thanh toán BHYT (%)";

                            range.Worksheet.Cells["J22:J23"].Merge = true;
                            range.Worksheet.Cells["J22:J23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["J22:J23"].Value = "Thành tiền BH(đồng)";

                            range.Worksheet.Cells["K22:N22"].Merge = true;
                            range.Worksheet.Cells["K22:N22"].Value = "Nguồn thanh toán (đồng)";

                            range.Worksheet.Cells["K23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["K23"].Value = "Quỹ BHYT";

                            range.Worksheet.Cells["L23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["L23"].Value = "Người bệnh cùng chi trả (đồng)";

                            range.Worksheet.Cells["M23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["M23"].Value = "Khác (đồng)";

                            range.Worksheet.Cells["N23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["N23"].Value = "Người bệnh tự trả(đồng)";
                        }


                        index = index + 3;

                        foreach (var chiPhi in chiPhis.Where(c => c.NhomChiPhiBangKe != NhomChiPhiBangKe.GoiVatTu).GroupBy(c => new { c.NhomChiPhiBangKe, c.TenDichVu, c.DonViTinh, c.DuocHuongBHYT, c.DonGia, c.DonGiaBHYT, c.MucHuongBaoHiem, c.TiLeBaoHiemThanhToan }).OrderByDescending(o => o.Key.DuocHuongBHYT))
                        {
                            dsChiPhiBangKe.Add(new BangKeKhamBenhCoBHYTVo
                            {
                                Nhom = chiPhi.Key.NhomChiPhiBangKe,
                                Id = chiPhi.FirstOrDefault().Id,
                                NoiDung = chiPhi.Key.TenDichVu,
                                DonViTinh = chiPhi.Key.DonViTinh,
                                SoLuong = (decimal)chiPhi.Sum(c => c.Soluong),
                                DuocHuongBaoHiem = chiPhi.Key.DuocHuongBHYT,
                                DonGiaBH = chiPhi.Key.DonGiaBHYT,
                                DonGiaTheoBV = chiPhi.Key.DonGia,
                                MucHuongBaoHiem = chiPhi.Key.MucHuongBaoHiem,
                                TiLeThanhToanTheoDV = chiPhi.Key.TiLeBaoHiemThanhToan,
                                BaoHiemChiTra = true
                            });
                        }

                        foreach (var chiPhi in chiPhis.Where(c => c.NhomChiPhiBangKe == NhomChiPhiBangKe.GoiVatTu).OrderByDescending(o => o.DuocHuongBHYT))
                        {
                            dsChiPhiBangKe.Add(new BangKeKhamBenhCoBHYTVo
                            {
                                Nhom = chiPhi.NhomChiPhiBangKe,
                                Id = chiPhi.Id,
                                NoiDung = chiPhi.TenDichVu,
                                DonViTinh = chiPhi.DonViTinh,
                                SoLuong = (decimal)chiPhi.Soluong,
                                DuocHuongBaoHiem = chiPhi.DuocHuongBHYT,
                                DonGiaBH = chiPhi.DonGiaBHYT,
                                DonGiaTheoBV = chiPhi.DonGia,
                                MucHuongBaoHiem = chiPhi.MucHuongBaoHiem,
                                TiLeThanhToanTheoDV = chiPhi.TiLeBaoHiemThanhToan,
                                BaoHiemChiTra = true
                            });
                        }
                        var groupChiPhiBangKes = dsChiPhiBangKe.GroupBy(x => x.Nhom).OrderBy(o => (int)o.Key * (o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay || o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriNoiTru ? 1 : 10));
                        if (!groupChiPhiBangKes.Any())
                        {
                            return null;
                        }
                        foreach (var groupChiPhiBangKe in groupChiPhiBangKes)
                        {
                            if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay)
                            {

                                worksheet.Cells["A" + index + ":N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["A" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                worksheet.Cells["A" + index + ":N" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                worksheet.Cells["A" + index + ":N" + index].Merge = true;
                                worksheet.Cells["A" + index + ":N" + index].Value = "2. Ngày giường:";
                                worksheet.Cells["A" + index + ":N" + index].Style.Font.Bold = true;

                                index++;

                                worksheet.Cells["A" + index + ":G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["A" + index + ":G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                worksheet.Cells["A" + index + ":G" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                worksheet.Cells["A" + index + ":G" + index].Merge = true;
                                worksheet.Cells["A" + index + ":G" + index].Value = "2.1." + groupChiPhiBangKe.Key.GetDescription();
                                worksheet.Cells["A" + index + ":G" + index].Style.Font.Bold = true;

                                worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["H" + index].Style.Font.Bold = true;
                                worksheet.Cells["H" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBV);

                                worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["J" + index].Style.Font.Bold = true;
                                worksheet.Cells["J" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBH);

                                worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["K" + index].Style.Font.Bold = true;
                                worksheet.Cells["K" + index].Value = groupChiPhiBangKe.Sum(o => o.QuyBHYT);

                                worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["L" + index].Style.Font.Bold = true;
                                worksheet.Cells["L" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra);

                                worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["M" + index].Style.Font.Bold = true;
                                worksheet.Cells["M" + index].Value = groupChiPhiBangKe.Sum(o => o.Khac);

                                worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["N" + index].Style.Font.Bold = true;
                                worksheet.Cells["N" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra);

                                index++;
                            }
                            else if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.NgayGiuongDieuTriNoiTru)
                            {
                                if (!groupChiPhiBangKes.Any(o => o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay))
                                {
                                    worksheet.Cells["A" + index + ":N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["A" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                    worksheet.Cells["A" + index + ":N" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                    worksheet.Cells["A" + index + ":N" + index].Merge = true;
                                    worksheet.Cells["A" + index + ":N" + index].Value = "2. Ngày giường:";
                                    worksheet.Cells["A" + index + ":N" + index].Style.Font.Bold = true;

                                }

                                index++;

                                worksheet.Cells["A" + index + ":G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["A" + index + ":G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                worksheet.Cells["A" + index + ":G" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                worksheet.Cells["A" + index + ":G" + index].Merge = true;
                                worksheet.Cells["A" + index + ":G" + index].Value = "2.2." + groupChiPhiBangKe.Key.GetDescription();
                                worksheet.Cells["A" + index + ":G" + index].Style.Font.Bold = true;

                                worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["H" + index].Style.Font.Bold = true;
                                worksheet.Cells["H" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBV);

                                worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["J" + index].Style.Font.Bold = true;
                                worksheet.Cells["J" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBH);

                                worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["K" + index].Style.Font.Bold = true;
                                worksheet.Cells["K" + index].Value = groupChiPhiBangKe.Sum(o => o.QuyBHYT);

                                worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["L" + index].Style.Font.Bold = true;
                                worksheet.Cells["L" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra);

                                worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["M" + index].Style.Font.Bold = true;
                                worksheet.Cells["M" + index].Value = groupChiPhiBangKe.Sum(o => o.Khac);

                                worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["N" + index].Style.Font.Bold = true;
                                worksheet.Cells["N" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra);

                                index++;
                            }
                            else
                            {
                                worksheet.Cells["A" + index + ":G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["A" + index + ":G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                worksheet.Cells["A" + index + ":G" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                worksheet.Cells["A" + index + ":G" + index].Merge = true;
                                worksheet.Cells["A" + index + ":G" + index].Value = (int)groupChiPhiBangKe.Key + "." + groupChiPhiBangKe.Key.GetDescription();
                                worksheet.Cells["A" + index + ":G" + index].Style.Font.Bold = true;

                                worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["H" + index].Style.Font.Bold = true;
                                worksheet.Cells["H" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBV);

                                worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["J" + index].Style.Font.Bold = true;
                                worksheet.Cells["J" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBH);

                                worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["K" + index].Style.Font.Bold = true;
                                worksheet.Cells["K" + index].Value = groupChiPhiBangKe.Sum(o => o.QuyBHYT);

                                worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["L" + index].Style.Font.Bold = true;
                                worksheet.Cells["L" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra);

                                worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["M" + index].Style.Font.Bold = true;
                                worksheet.Cells["M" + index].Value = groupChiPhiBangKe.Sum(o => o.Khac);

                                worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["N" + index].Style.Font.Bold = true;
                                worksheet.Cells["N" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra);

                                index++;
                            }
                            if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.GoiVatTu)
                            {
                                var groupGoiVatTus = groupChiPhiBangKe.ToList().GroupBy(o => o.SoGoiVatTu.GetValueOrDefault()).OrderBy(o => o.Key);
                                int sttGoiVatTu = 1;
                                foreach (var groupGoiVatTu in groupGoiVatTus)
                                {
                                    worksheet.Cells["A" + index + ":G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["A" + index + ":G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                    worksheet.Cells["A" + index + ":G" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                    worksheet.Cells["A" + index + ":G" + index].Value = "10." + sttGoiVatTu + ". " + groupChiPhiBangKe.Key.GetDescription() + " " + sttGoiVatTu;
                                    worksheet.Cells["A" + index + ":G" + index].Style.Font.Bold = true;
                                    worksheet.Cells["A" + index + ":G" + index].Merge = true;

                                    worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["H" + index].Style.Font.Bold = true;
                                    worksheet.Cells["H" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBV);

                                    worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["J" + index].Style.Font.Bold = true;
                                    worksheet.Cells["J" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBH);

                                    worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["K" + index].Style.Font.Bold = true;
                                    worksheet.Cells["K" + index].Value = groupChiPhiBangKe.Sum(o => o.QuyBHYT);

                                    worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["L" + index].Style.Font.Bold = true;
                                    worksheet.Cells["L" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra);

                                    worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["M" + index].Style.Font.Bold = true;
                                    worksheet.Cells["M" + index].Value = groupChiPhiBangKe.Sum(o => o.Khac);

                                    worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["N" + index].Style.Font.Bold = true;
                                    worksheet.Cells["N" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra);
                                    index++;
                                    foreach (var chiPhiBangKe in groupGoiVatTu)
                                    {
                                        worksheet.Cells["A" + index + ":N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["A" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                        worksheet.Cells["A" + index + ":N" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));

                                        worksheet.Cells["A" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["A" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                        worksheet.Cells["A" + index].Value = indexItem;

                                        worksheet.Cells["B" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["B" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                        worksheet.Cells["B" + index].Value = chiPhiBangKe.NoiDung;

                                        worksheet.Cells["C" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["C" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                        worksheet.Cells["C" + index].Value = chiPhiBangKe.DonViTinh;

                                        worksheet.Cells["D" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["D" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                        worksheet.Cells["D" + index].Value = chiPhiBangKe.SoLuong;

                                        worksheet.Cells["E" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["E" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["E" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["E" + index].Value = chiPhiBangKe.DonGiaBV;

                                        worksheet.Cells["F" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["F" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["F" + index].Value = chiPhiBangKe.DonGiaBH;

                                        worksheet.Cells["G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["G" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["G" + index].Value = chiPhiBangKe.TiLeThanhToanTheoDV;

                                        worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["H" + index].Value = chiPhiBangKe.ThanhTienBV;

                                        worksheet.Cells["I" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["I" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["I" + index].Value = Convert.ToDouble(chiPhiBangKe.MucHuongBaoHiem > 0 ? 100 : 0).ApplyFormatMoneyToDouble();


                                        worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["J" + index].Value = chiPhiBangKe.ThanhTienBH;


                                        worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["K" + index].Value = chiPhiBangKe.QuyBHYT;


                                        worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["L" + index].Value = chiPhiBangKe.NguoiBenhCungChiTra;


                                        worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["M" + index].Value = chiPhiBangKe.Khac;


                                        worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["N" + index].Value = chiPhiBangKe.NguoiBenhTuTra;

                                        indexItem++;
                                        index++;
                                    }
                                }
                            }
                            else
                            {
                                foreach (var chiPhiBangKe in groupChiPhiBangKe)
                                {
                                    worksheet.Cells["A" + index + ":N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["A" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                    worksheet.Cells["A" + index + ":N" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));

                                    worksheet.Cells["A" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["A" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                    worksheet.Cells["A" + index].Value = indexItem;

                                    worksheet.Cells["B" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["B" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                    worksheet.Cells["B" + index].Value = chiPhiBangKe.NoiDung;

                                    worksheet.Cells["C" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["C" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                    worksheet.Cells["C" + index].Value = chiPhiBangKe.DonViTinh;

                                    worksheet.Cells["D" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["D" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                    worksheet.Cells["D" + index].Value = chiPhiBangKe.SoLuong;

                                    worksheet.Cells["E" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["E" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["E" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["E" + index].Value = chiPhiBangKe.DonGiaBV;

                                    worksheet.Cells["F" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["F" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["F" + index].Value = chiPhiBangKe.DonGiaBH;

                                    worksheet.Cells["G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["G" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["G" + index].Value = chiPhiBangKe.TiLeThanhToanTheoDV;

                                    worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["H" + index].Value = chiPhiBangKe.ThanhTienBV;

                                    worksheet.Cells["I" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["I" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["I" + index].Value = Convert.ToDouble(chiPhiBangKe.MucHuongBaoHiem > 0 ? 100 : 0).ApplyFormatMoneyToDouble();


                                    worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["J" + index].Value = chiPhiBangKe.ThanhTienBH;


                                    worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["K" + index].Value = chiPhiBangKe.QuyBHYT;


                                    worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["L" + index].Value = chiPhiBangKe.NguoiBenhCungChiTra;


                                    worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["M" + index].Value = chiPhiBangKe.Khac;


                                    worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["N" + index].Value = chiPhiBangKe.NguoiBenhTuTra;

                                    indexItem++;
                                    index++;
                                }
                            }

                        }

                        worksheet.Cells["A" + index + ":G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        worksheet.Cells["A" + index + ":G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        worksheet.Cells["A" + index + ":G" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                        worksheet.Cells["A" + index + ":G" + index].Merge = true;
                        worksheet.Cells["A" + index + ":G" + index].Value = "Tổng cộng";
                        worksheet.Cells["A" + index + ":G" + index].Style.Font.Bold = true;

                        worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                        worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                        worksheet.Cells["H" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.ThanhTienBV)).Sum();

                        worksheet.Cells["I" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        worksheet.Cells["I" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;

                        worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                        worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                        worksheet.Cells["J" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.ThanhTienBH)).Sum();

                        worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                        worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                        worksheet.Cells["K" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.QuyBHYT)).Sum();

                        worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                        worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                        worksheet.Cells["L" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.NguoiBenhCungChiTra)).Sum();

                        worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                        worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                        worksheet.Cells["M" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.Khac)).Sum();

                        worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                        worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                        worksheet.Cells["N" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.NguoiBenhTuTra)).Sum();

                        index++;

                        worksheet.Cells["A" + index + ":N" + index].Merge = true;
                        worksheet.Cells["A" + index + ":N" + index].Value = "Tổng chi phí lần khám bệnh/cả đợt điều trị: " + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble() + " đồng";
                        worksheet.Cells["A" + index + ":N" + index].Style.Font.Bold = true;

                        index++;

                        worksheet.Cells["A" + index + ":N" + index].Merge = true;
                        worksheet.Cells["A" + index + ":N" + index].Value = "(Viết bằng chữ: " + NumberHelper.ChuyenSoRaText(Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBH))) + ")";

                        index++;

                        worksheet.Cells["A" + index + ":N" + index].Merge = true;
                        worksheet.Cells["A" + index + ":N" + index].Value = "Trong đó , số tiền do:";
                        worksheet.Cells["A" + index + ":N" + index].Style.Font.Bold = true;

                        index++;
                        worksheet.Cells["A" + index + ":N" + index].Merge = true;
                        worksheet.Cells["A" + index + ":N" + index].Value = "- Quỹ BHYT thanh toán: " + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble();

                        index++;
                        worksheet.Cells["A" + index + ":N" + index].Merge = true;
                        worksheet.Cells["A" + index + ":N" + index].Value = "- Người bệnh trả trong đó: " + (Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)) + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhTuTra))).ApplyFormatMoneyToDouble();

                        index++;
                        worksheet.Cells["A" + index + ":N" + index].Merge = true;
                        worksheet.Cells["A" + index + ":N" + index].Value = "+ Cùng chi trả trong phạm vi BHYT: " + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble(true);

                        index++;
                        worksheet.Cells["A" + index + ":N" + index].Merge = true;
                        worksheet.Cells["A" + index + ":N" + index].Value = "+ Các khoản phải trả khác: " + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true);

                        index++;
                        worksheet.Cells["A" + index + ":N" + index].Merge = true;
                        worksheet.Cells["A" + index + ":N" + index].Value = "+ Nguồn khác: " + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble(true);


                        index = index + 2;

                        worksheet.Cells["D" + index + ":F" + index].Style.Font.SetFromFont(new Font("Times New Roman", 12));
                        worksheet.Cells["D" + index + ":F" + index].Merge = true;
                        worksheet.Cells["D" + index + ":F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        worksheet.Cells["D" + index + ":F" + index].Style.VerticalAlignment = ExcelVerticalAlignment.Top;
                        worksheet.Cells["D" + index + ":F" + index].Value = $"Ngày {DateTime.Now.Day} tháng {DateTime.Now.Month} năm {DateTime.Now.Year}";

                        worksheet.Cells["G" + index + ":I" + index].Style.Font.SetFromFont(new Font("Times New Roman", 12));
                        worksheet.Cells["G" + index + ":I" + index].Merge = true;
                        worksheet.Cells["G" + index + ":I" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        worksheet.Cells["G" + index + ":I" + index].Style.VerticalAlignment = ExcelVerticalAlignment.Top;
                        worksheet.Cells["G" + index + ":I" + index].Value = $"Ngày {DateTime.Now.Day} tháng {DateTime.Now.Month} năm {DateTime.Now.Year}";

                        worksheet.Cells["J" + index + ":N" + index].Style.Font.Bold = true;
                        worksheet.Cells["J" + index + ":N" + index].Merge = true;
                        worksheet.Cells["J" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        worksheet.Cells["J" + index + ":N" + index].Value = "XÁC NHẬN CỦA NGƯỜI BỆNH ";

                        index++;

                        worksheet.Cells["A" + index + ":C" + index].Style.Font.Bold = true;
                        worksheet.Cells["A" + index + ":C" + index].Merge = true;
                        worksheet.Cells["A" + index + ":C" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        worksheet.Cells["A" + index + ":C" + index].Value = "NGƯỜI LẬP BẢNG KÊ";

                        worksheet.Cells["D" + index + ":F" + index].Style.Font.Bold = true;
                        worksheet.Cells["D" + index + ":F" + index].Merge = true;
                        worksheet.Cells["D" + index + ":F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        worksheet.Cells["D" + index + ":F" + index].Value = "KẾ TOÁN VIỆN PHÍ";

                        worksheet.Cells["G" + index + ":I" + index].Style.Font.Bold = true;
                        worksheet.Cells["G" + index + ":I" + index].Merge = true;
                        worksheet.Cells["G" + index + ":I" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        worksheet.Cells["G" + index + ":I" + index].Value = "GIÁM ĐỊNH BHYT";

                        worksheet.Cells["J" + index + ":N" + index].Style.Font.Bold = true;
                        worksheet.Cells["J" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        worksheet.Cells["J" + index + ":N" + index].Merge = true;
                        worksheet.Cells["J" + index + ":N" + index].Value = "(Ký , Ghi rõ họ tên)";

                        index++;

                        worksheet.Cells["A" + index + ":C" + index].Style.Font.Bold = true;
                        worksheet.Cells["A" + index + ":C" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        worksheet.Cells["A" + index + ":C" + index].Merge = true;
                        worksheet.Cells["A" + index + ":C" + index].Value = "(Ký , Ghi rõ họ tên)";


                        worksheet.Cells["D" + index + ":F" + index].Style.Font.Bold = true;
                        worksheet.Cells["D" + index + ":F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        worksheet.Cells["D" + index + ":F" + index].Merge = true;
                        worksheet.Cells["D" + index + ":F" + index].Value = "(Ký , Ghi rõ họ tên)";

                        worksheet.Cells["G" + index + ":I" + index].Style.Font.Bold = true;
                        worksheet.Cells["G" + index + ":I" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        worksheet.Cells["G" + index + ":I" + index].Merge = true;
                        worksheet.Cells["G" + index + ":I" + index].Value = "(Ký , Ghi rõ họ tên)";

                        worksheet.Cells["J" + index + ":N" + index].Style.Font.Bold = true;
                        worksheet.Cells["J" + index + ":N" + index].Merge = true;
                        worksheet.Cells["J" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        worksheet.Cells["J" + index + ":N" + index].Value = "(Tôi đã nhận...phim...Xquang / CT / MRI)";

                        xlPackage.Save();

                    }
                }

                return stream.ToArray();
            }
        }

        public byte[] XuatBangKe(long taiKhoanThuId)
        {
            var taiKhoanBenhNhanThu = _taiKhoanBenhNhanThuRepository.TableNoTracking.Where(c => c.Id == taiKhoanThuId && c.LoaiThuTienBenhNhan == Enums.LoaiThuTienBenhNhan.ThuTheoChiPhi)
                                                                                    .Include(o => o.YeuCauTiepNhan).ThenInclude(o => o.NoiTruBenhAn).ThenInclude(o => o.ChuyenDenBenhVien)
                                                                                    .Include(o => o.YeuCauTiepNhan).ThenInclude(o => o.NoiTruBenhAn).ThenInclude(o => o.KhoaPhongNhapVien)
                                                                                    .Include(o => o.YeuCauTiepNhan).ThenInclude(o => o.NoiTruBenhAn).ThenInclude(o => o.ChanDoanChinhRaVienICD)
                                                                                    .Include(o => o.YeuCauTiepNhan).ThenInclude(o => o.YeuCauTiepNhanTheBHYTs)
                                                                                    .Include(o => o.YeuCauTiepNhan).ThenInclude(o => o.YeuCauNhapVien).ThenInclude(o => o.YeuCauKhamBenh).ThenInclude(o => o.YeuCauTiepNhan)
                                                                                    .Include(cc => cc.YeuCauTiepNhan)
                                                                                    .ThenInclude(xx => xx.BenhNhan)
                                                                                    .Include(cc => cc.YeuCauTiepNhan)
                                                                                    .ThenInclude(xx => xx.YeuCauKhamBenhs)
                                                                                    .ThenInclude(o => o.YeuCauKhamBenhChuanDoans)
                                                                                    .ThenInclude(o => o.ChuanDoan)
                                                                                    .Include(cc => cc.YeuCauTiepNhan).ThenInclude(cc => cc.PhuongXa)
                                                                                    .Include(cc => cc.YeuCauTiepNhan)
                                                                                    .ThenInclude(cc => cc.QuanHuyen)
                                                                                    .Include(cc => cc.YeuCauTiepNhan)
                                                                                    .ThenInclude(cc => cc.TinhThanh)
                                                                                    .Include(cc => cc.YeuCauTiepNhan)
                                                                                    .ThenInclude(cc => cc.NoiChuyen)
                                                                                    .Include(o => o.YeuCauTiepNhan).ThenInclude(o => o.NoiTruBenhAn).ThenInclude(o => o.NoiTruPhieuDieuTris).ThenInclude(c => c.ChanDoanChinhICD)
                                                                                    .Include(o => o.YeuCauTiepNhan).ThenInclude(o => o.NoiTruBenhAn).ThenInclude(o => o.NoiTruPhieuDieuTris).ThenInclude(o => o.NoiTruThamKhamChanDoanKemTheos).ThenInclude(c => c.ICD)
                                                                                    .Include(o => o.YeuCauTiepNhan).ThenInclude(o => o.NoiTruBenhAn).ThenInclude(o => o.NoiTruKhoaPhongDieuTris).ThenInclude(c => c.KhoaPhongChuyenDen).FirstOrDefault();

            var yeuCauTiepNhan = taiKhoanBenhNhanThu.YeuCauTiepNhan;
            if (yeuCauTiepNhan == null)
                return null;

            var danhSachChiPhi = GetTatCaDichVuKhamChuaBenh(yeuCauTiepNhan.Id).Result.Where(o => !o.Soluong.AlmostEqual(0) && o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.DaThanhToan && o.YeuCauGoiDichVuId == null).ToList();
            if (danhSachChiPhi.Count == 0)
            {
                return null;
            }

            var query = taiKhoanBenhNhanThu?.YeuCauTiepNhan;
            var result = _templateRepository.TableNoTracking.FirstOrDefault(x => x.Name.Equals("BangKeKhamBenhBHYTVaBenhVien"));



            var benhVien = new Core.Domain.Entities.BenhVien.BenhVien();

            string maBHYT = string.Empty;
            string bHYTTuNgay = string.Empty;
            string bHYTDenNgay = string.Empty;
            string mucHuong = string.Empty;
            string NoiDKKCBBanDau = string.Empty;
            string MaKCBBanDau = string.Empty;


            string maICDKemTheo = string.Empty;
            string tenICDKemTheo = string.Empty;

            string chuanDoanXacDinhSanKhoa = string.Empty;
            string maICD10 = string.Empty;

            if (yeuCauTiepNhan.NoiTruBenhAn != null && (yeuCauTiepNhan.NoiTruBenhAn.LoaiBenhAn == LoaiBenhAn.SanKhoaMo || yeuCauTiepNhan.NoiTruBenhAn.LoaiBenhAn == LoaiBenhAn.SanKhoaThuong))
            {
                if (yeuCauTiepNhan.NoiTruBenhAn?.NoiTruPhieuDieuTris.Count() > 0)
                {
                    var phieuDieuTri = yeuCauTiepNhan.NoiTruBenhAn?.NoiTruPhieuDieuTris.OrderByDescending(c => c.NgayDieuTri).FirstOrDefault();

                    var icdKemTheoIds = phieuDieuTri.NoiTruThamKhamChanDoanKemTheos.Select(c => c.ICD.Ma);
                    var tenICDKemTheos = phieuDieuTri.NoiTruThamKhamChanDoanKemTheos.Select(c => c.GhiChu);

                    maICDKemTheo = string.Join(", ", icdKemTheoIds);
                    tenICDKemTheo = string.Join(", ", tenICDKemTheos);


                    maICD10 = phieuDieuTri.ChanDoanChinhICD?.Ma;
                    chuanDoanXacDinhSanKhoa = phieuDieuTri.ChanDoanChinhGhiChu;
                }
            }
            else
            {
                if (!string.IsNullOrEmpty(yeuCauTiepNhan.NoiTruBenhAn?.DanhSachChanDoanKemTheoRaVienICDId))
                {
                    var maICDKemTheos = new List<string>();

                    var icdKemTheoIds = yeuCauTiepNhan.NoiTruBenhAn?.DanhSachChanDoanKemTheoRaVienICDId.Split(Constants.ICDSeparator);
                    var tenICDKemTheos = yeuCauTiepNhan.NoiTruBenhAn?.DanhSachChanDoanKemTheoRaVienGhiChu?.Split(Constants.ICDSeparator);

                    if (icdKemTheoIds.Length > 0)
                    {
                        foreach (var icdKemTheoId in icdKemTheoIds)
                        {
                            var icdKemTheo = _icdRepository.TableNoTracking.FirstOrDefault(o => o.Id == long.Parse(icdKemTheoId));
                            if (icdKemTheo != null)
                            {
                                maICDKemTheos.Add(icdKemTheo.Ma);
                            }

                            //if (long.TryParse(yeuCauTiepNhan.NoiTruBenhAn?.DanhSachChanDoanKemTheoRaVienICDId.Split(Constants.ICDSeparator).First(), out var icdKemTheoId))
                            //{
                            //    var icdKemTheo = _icdRepository.TableNoTracking.FirstOrDefault(o => o.Id == icdKemTheoId);
                            //    if (icdKemTheo != null)
                            //    {
                            //        maICDKemTheo = icdKemTheo.Ma;
                            //        tenICDKemTheo = yeuCauTiepNhan.NoiTruBenhAn?.DanhSachChanDoanKemTheoRaVienGhiChu?.Split(Constants.ICDSeparator).First();
                            //    }
                            //}
                        }
                    }

                    maICDKemTheo = string.Join(", ", maICDKemTheos);
                    tenICDKemTheo = string.Join(", ", tenICDKemTheos);
                }
            }


            YeuCauTiepNhanTheBHYT theBHYT = null;
            if (yeuCauTiepNhan.CoBHYT == true && yeuCauTiepNhan.YeuCauTiepNhanTheBHYTs.Any())
            {
                theBHYT = yeuCauTiepNhan.YeuCauTiepNhanTheBHYTs.First();
                if (!String.IsNullOrEmpty(theBHYT.MaDKBD))
                {
                    benhVien = _benhVienRepository.TableNoTracking.FirstOrDefault(p => p.Ma.Equals(theBHYT.MaDKBD));
                }
                maBHYT = theBHYT.MaSoThe;
                bHYTTuNgay = theBHYT.NgayHieuLuc.ApplyFormatDate();
                bHYTDenNgay = theBHYT.NgayHetHan?.ApplyFormatDate();
                mucHuong = theBHYT.MucHuong.ToString() + "%";
                NoiDKKCBBanDau = benhVien != null ? benhVien?.Ten : "Chưa xác định";
                MaKCBBanDau = theBHYT.MaDKBD;
            }
            else
            {
                maBHYT = "";
                bHYTTuNgay = "";
                bHYTDenNgay = "";
                mucHuong = "0%";
                NoiDKKCBBanDau = "Chưa xác định";
                MaKCBBanDau = "Chưa xác định";
            }

            //var thongTinPhieuThus = GetThongTinPhieuThu(taiKhoanThuId, LoaiPhieuThuChiThuNgan.ThuTheoChiPhi);
            //if (thongTinPhieuThus.ChiPhiKhamChuaBenhNoiTruVos.Count == 0)
            //{
            //    return string.Empty;
            //}
            var dsChiPhiBangKe = new List<BangKeKhamBenhBenhVienVo>();
            var dateItemChiPhis = string.Empty;
            int indexItem = 1;

            using (var stream = new MemoryStream())
            {
                using (var xlPackage = new ExcelPackage(stream))
                {

                    var worksheet = xlPackage.Workbook.Worksheets.Add("BẢNG KÊ CHI PHÍ ĐIỀU TRỊ NỘI TRÚ 3");

                    // set row
                    worksheet.Row(9).Height = 24.5;
                    worksheet.DefaultRowHeight = 16;

                    //SET chiều rộng cho từng cột tương ứng
                    worksheet.Column(1).Width = 10;
                    worksheet.Column(2).Width = 25;
                    worksheet.Column(3).Width = 15;
                    worksheet.Column(4).Width = 15;
                    worksheet.Column(5).Width = 15;
                    worksheet.Column(6).Width = 15;
                    worksheet.Column(7).Width = 15;
                    worksheet.Column(8).Width = 15;
                    worksheet.Column(9).Width = 15;
                    worksheet.Column(10).Width = 15;
                    worksheet.Column(11).Width = 15;
                    worksheet.Column(12).Width = 15;
                    worksheet.Column(13).Width = 15;
                    worksheet.Column(14).Width = 15;

                    worksheet.DefaultColWidth = 7;

                    using (var range = worksheet.Cells["A1:C1"])
                    {
                        range.Worksheet.Cells["A1:C1"].Merge = true;
                        range.Worksheet.Cells["A1:C1"].Value = "CƠ SỞ KHÁM CHỮA BỆNH : BỆNH VIỆN ĐKQT BẮC HÀ";
                        range.Worksheet.Cells["A1:C1"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A1:C1"].Style.VerticalAlignment = ExcelVerticalAlignment.Bottom;
                        range.Worksheet.Cells["A1:C1"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A1:C1"].Style.Font.Color.SetColor(Color.Black);
                    }


                    var khoaPhong = yeuCauTiepNhan.NoiTruBenhAn?.NoiTruKhoaPhongDieuTris.OrderByDescending(c => c.ThoiDiemVaoKhoa).Select(c => c.KhoaPhongChuyenDen).FirstOrDefault();
                    var chuyenKhoa = GetChuyenKhoa(khoaPhong?.Id); //BVHD-3792 

                    using (var range = worksheet.Cells["A2:C2"])
                    {
                        range.Worksheet.Cells["A2:C2"].Merge = true;
                        range.Worksheet.Cells["A2:C2"].Value = "Khoa: " + khoaPhong?.Ten;
                        range.Worksheet.Cells["A2:C2"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A2:C2"].Style.VerticalAlignment = ExcelVerticalAlignment.Bottom;
                        range.Worksheet.Cells["A2:C2"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A2:C2"].Style.Font.Color.SetColor(Color.Black);
                        range.Worksheet.Cells["A2:C2"].Style.Font.Bold = true;
                    }

                    using (var range = worksheet.Cells["A3:C3"])
                    {
                        range.Worksheet.Cells["A3:C3"].Merge = true;
                        range.Worksheet.Cells["A3:C3"].Value = "Mã khoa: " + chuyenKhoa?.Ma;
                        range.Worksheet.Cells["A3:C3"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A3:C3"].Style.VerticalAlignment = ExcelVerticalAlignment.Bottom;
                        range.Worksheet.Cells["A3:C3"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A3:C3"].Style.Font.Color.SetColor(Color.Black);
                        range.Worksheet.Cells["A3:C3"].Style.Font.Bold = true;
                    }

                    using (var range = worksheet.Cells["L1:N1"])
                    {
                        range.Worksheet.Cells["L1:N1"].Merge = true;
                        range.Worksheet.Cells["L1:N1"].Value = "Mẫu số : 01/KBCB ";
                        range.Worksheet.Cells["L1:N1"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                        range.Worksheet.Cells["L1:N1"].Style.VerticalAlignment = ExcelVerticalAlignment.Bottom;
                        range.Worksheet.Cells["L1:N1"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["L1:N1"].Style.Font.Color.SetColor(Color.Black);
                        range.Worksheet.Cells["L1:N1"].Style.Font.Bold = true;
                    }

                    using (var range = worksheet.Cells["L2:N2"])
                    {
                        range.Worksheet.Cells["L2:N2"].Merge = true;
                        range.Worksheet.Cells["L2:N2"].Value = "Mã số người bệnh: " + yeuCauTiepNhan.BenhNhan.MaBN;
                        range.Worksheet.Cells["L2:N2"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                        range.Worksheet.Cells["L2:N2"].Style.VerticalAlignment = ExcelVerticalAlignment.Bottom;
                        range.Worksheet.Cells["L2:N2"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["L2:N2"].Style.Font.Color.SetColor(Color.Black);
                        range.Worksheet.Cells["L2:N2"].Style.Font.Bold = true;
                    }

                    using (var range = worksheet.Cells["L3:N3"])
                    {
                        range.Worksheet.Cells["L3:N3"].Merge = true;
                        range.Worksheet.Cells["L3:N3"].Value = "Số khám bệnh:" + yeuCauTiepNhan.MaYeuCauTiepNhan;
                        range.Worksheet.Cells["L3:N3"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                        range.Worksheet.Cells["L3:N3"].Style.VerticalAlignment = ExcelVerticalAlignment.Bottom;
                        range.Worksheet.Cells["L3:N3"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["L3:N3"].Style.Font.Color.SetColor(Color.Black);
                        range.Worksheet.Cells["L3:N3"].Style.Font.Bold = true;
                    }

                    using (var range = worksheet.Cells["L4:N4"])
                    {
                        range.Worksheet.Cells["L4:N4"].Merge = true;
                        range.Worksheet.Cells["L4:N4"].Value = "Số bệnh án: " + yeuCauTiepNhan.NoiTruBenhAn?.SoBenhAn;
                        range.Worksheet.Cells["L4:N4"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                        range.Worksheet.Cells["L4:N4"].Style.VerticalAlignment = ExcelVerticalAlignment.Bottom;
                        range.Worksheet.Cells["L4:N4"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["L4:N4"].Style.Font.Color.SetColor(Color.Black);
                        range.Worksheet.Cells["L4:N4"].Style.Font.Bold = true;
                    }

                    using (var range = worksheet.Cells["A5:N6"])
                    {
                        range.Worksheet.Cells["A5:N6"].Merge = true;
                        range.Worksheet.Cells["A5:N6"].Value = "BẢNG KÊ CHI PHÍ ĐIỀU TRỊ NỘI TRÚ 3";
                        range.Worksheet.Cells["A5:N6"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        range.Worksheet.Cells["A5:N6"].Style.VerticalAlignment = ExcelVerticalAlignment.Bottom;
                        range.Worksheet.Cells["A5:N6"].Style.Font.SetFromFont(new Font("Times New Roman", 18));
                        range.Worksheet.Cells["A5:N6"].Style.Font.Color.SetColor(Color.Black);
                        range.Worksheet.Cells["A5:N6"].Style.Font.Bold = true;
                    }

                    using (var range = worksheet.Cells["A7:N7"])
                    {
                        range.Worksheet.Cells["A7:N7"].Merge = true;
                        range.Worksheet.Cells["A7:N7"].Value = "I.Hành chính";
                        range.Worksheet.Cells["A7:N7"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A7:N7"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A7:N7"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A7:N7"].Style.Font.Color.SetColor(Color.Black);
                        range.Worksheet.Cells["A7:N7"].Style.Font.Bold = true;
                    }

                    using (var range = worksheet.Cells["A8:F8"])
                    {
                        range.Worksheet.Cells["A8:F8"].Merge = true;

                        range.Worksheet.Cells["A8:F8"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["A8:F8"].RichText.Add("(1) Họ tên người bệnh: ");
                        var value = range.Worksheet.Cells["A8:F8"].RichText.Add(yeuCauTiepNhan.HoTen);
                        value.Bold = true;

                        range.Worksheet.Cells["A8:F8"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A8:F8"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A8:F8"].Style.Font.SetFromFont(new Font("Times New Roman", 11));


                        range.Worksheet.Cells["A8:F8"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["G8:J8"])
                    {
                        range.Worksheet.Cells["G8:J8"].Merge = true;
                        range.Worksheet.Cells["G8:J8"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["G8:J8"].RichText.Add("Ngày,tháng,năm sinh: ");
                        var value = range.Worksheet.Cells["G8:J8"].RichText.Add(DateHelper.DOBFormat(yeuCauTiepNhan.NgaySinh, yeuCauTiepNhan.ThangSinh, yeuCauTiepNhan.NamSinh));
                        value.Bold = true;

                        range.Worksheet.Cells["G8:J8"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["G8:J8"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["G8:J8"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["G8:J8"].Style.Font.Color.SetColor(Color.Black);
                    }

                    var gioitinh = yeuCauTiepNhan.GioiTinh != null ? yeuCauTiepNhan.GioiTinh.GetDescription() : "";
                    using (var range = worksheet.Cells["K8:N8"])
                    {
                        range.Worksheet.Cells["K8:N8"].Merge = true;

                        range.Worksheet.Cells["K8:N8"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["K8:N8"].RichText.Add("Giới tính: ");
                        var value = range.Worksheet.Cells["K8:N8"].RichText.Add(gioitinh);
                        value.Bold = true;

                        range.Worksheet.Cells["K8:N8"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["K8:N8"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["K8:N8"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["K8:N8"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["A9:F9"])
                    {
                        range.Worksheet.Cells["A9:F9"].Merge = true;

                        range.Worksheet.Cells["A9:F9"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["A9:F9"].RichText.Add("(2)Địa chỉ hiện tại: ");
                        var value = range.Worksheet.Cells["A9:F9"].RichText.Add(yeuCauTiepNhan.DiaChiDayDu);
                        value.Bold = true;

                        range.Worksheet.Cells["A9:F9"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A9:F9"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A9:F9"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A9:F9"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["G9:J9"])
                    {
                        range.Worksheet.Cells["G9:J9"].Merge = true;

                        range.Worksheet.Cells["G9:J9"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["G9:J9"].RichText.Add("(3)Mã khu vực(K1/K2/K3): ");
                        var value = range.Worksheet.Cells["G9:J9"].RichText.Add(yeuCauTiepNhan.BHYTMaKhuVuc);
                        value.Bold = true;

                        range.Worksheet.Cells["G9:J9"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["G9:J9"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["G9:J9"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["G9:J9"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["A10:F10"])
                    {
                        range.Worksheet.Cells["A10:F10"].Merge = true;
                        range.Worksheet.Cells["A10:F10"].Style.WrapText = true;

                        var title = range.Worksheet.Cells["A10:F10"].RichText.Add("(4)Mã thẻ BHYT: ");
                        var value = range.Worksheet.Cells["A10:F10"].RichText.Add(maBHYT);
                        value.Bold = true;

                        range.Worksheet.Cells["A10:F10"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A10:F10"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A10:F10"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A10:F10"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["G10:J10"])
                    {
                        range.Worksheet.Cells["G10:J10"].Merge = true;
                        range.Worksheet.Cells["G10:J10"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["G10:J10"].RichText.Add("Giá trị từ: ");
                        var valuebHYTTuNgay = range.Worksheet.Cells["G10:J10"].RichText.Add(bHYTTuNgay);
                        valuebHYTTuNgay.Bold = true;

                        var den = range.Worksheet.Cells["G10:J10"].RichText.Add(" đến: ");
                        den.Bold = false;
                        var valuebHYTDenNgay = range.Worksheet.Cells["G10:J10"].RichText.Add(bHYTDenNgay);
                        valuebHYTDenNgay.Bold = true;


                        range.Worksheet.Cells["G10:J10"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["G10:J10"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["G10:J10"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["G10:J10"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["A11:F11"])
                    {
                        range.Worksheet.Cells["A11:F11"].Merge = true;

                        range.Worksheet.Cells["A11:F11"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["A11:F11"].RichText.Add("(5)Nơi ĐK KCB ban đầu: ");
                        var valueNoiDKKCBBanDau = range.Worksheet.Cells["A11:F11"].RichText.Add(NoiDKKCBBanDau);
                        valueNoiDKKCBBanDau.Bold = true;

                        range.Worksheet.Cells["A11:F11"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A11:F11"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A11:F11"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A11:F11"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["G11:J11"])
                    {
                        range.Worksheet.Cells["G11:J11"].Merge = true;
                        range.Worksheet.Cells["G11:J11"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["G11:J11"].RichText.Add("(6)Mã: ");
                        var valueMaKCBBanDau = range.Worksheet.Cells["G11:J11"].RichText.Add(MaKCBBanDau);
                        valueMaKCBBanDau.Bold = true;

                        range.Worksheet.Cells["G11:J11"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["G11:J11"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["G11:J11"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["G11:J11"].Style.Font.Color.SetColor(Color.Black);
                    }


                    using (var range = worksheet.Cells["A12:F12"])
                    {
                        range.Worksheet.Cells["A12:F12"].Merge = true;

                        range.Worksheet.Cells["A12:F12"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["A12:F12"].RichText.Add("(7)Đến Khám: ");
                        var value = range.Worksheet.Cells["A12:F12"].RichText.Add(yeuCauTiepNhan.ThoiDiemTiepNhan.ApplyFormatGioPhutNgay());
                        value.Bold = true;

                        range.Worksheet.Cells["A12:F12"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A12:F12"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A12:F12"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A12:F12"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["A13:F13"])
                    {
                        range.Worksheet.Cells["A13:F13"].Merge = true;

                        range.Worksheet.Cells["A13:F13"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["A13:F13"].RichText.Add("(8)Điều trị ngoại trú/nội trú từ: ");
                        var value = range.Worksheet.Cells["A13:F13"].RichText.Add(yeuCauTiepNhan.NoiTruBenhAn?.ThoiDiemNhapVien.ApplyFormatGioPhutNgay());
                        value.Bold = true;

                        range.Worksheet.Cells["A13:F13"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A13:F13"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A13:F13"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A13:F13"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["A14:F14"])
                    {
                        range.Worksheet.Cells["A14:F14"].Merge = true;
                        range.Worksheet.Cells["A14:F14"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["A14:F14"].RichText.Add("(9)Kết thúc khám/điều trị: ");
                        var value = range.Worksheet.Cells["A14:F14"].RichText.Add(yeuCauTiepNhan.NoiTruBenhAn?.ThoiDiemRaVien?.ApplyFormatGioPhutNgay());
                        value.Bold = true;


                        range.Worksheet.Cells["A14:F14"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A14:F14"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A14:F14"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A14:F14"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["G14:J14"])
                    {
                        range.Worksheet.Cells["G14:J14"].Merge = true;
                        range.Worksheet.Cells["G14:J14"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["G14:J14"].RichText.Add("Tổng số ngày điều trị: ");
                        var value = range.Worksheet.Cells["G14:J14"].RichText.Add(NoiTruBenhAnHelper.TinhSoNgayDieuTri(yeuCauTiepNhan.NoiTruBenhAn)?.ToString() ?? string.Empty);
                        value.Bold = true;

                        range.Worksheet.Cells["G14:J14"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["G14:J14"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["G14:J14"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["G14:J14"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["K14:N14"])
                    {
                        range.Worksheet.Cells["K14:N14"].Merge = true;

                        range.Worksheet.Cells["K14:N14"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["K14:N14"].RichText.Add("(10)Tình trạng ra viện: ");
                        var value = range.Worksheet.Cells["K14:N14"].RichText.Add((yeuCauTiepNhan.NoiTruBenhAn?.TinhTrangRaVien == EnumTinhTrangRaVien.RaVien && (yeuCauTiepNhan.NoiTruBenhAn?.KetQuaDieuTri == EnumKetQuaDieuTri.Do || yeuCauTiepNhan.NoiTruBenhAn?.KetQuaDieuTri == EnumKetQuaDieuTri.Khoi) ? 1 : 2).ToString());
                        value.Bold = true;


                        range.Worksheet.Cells["K14:N14"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["K14:N14"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["K14:N14"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["K14:N14"].Style.Font.Color.SetColor(Color.Black);
                    }

                    //=================================15=================================
                    var coCapCuu = yeuCauTiepNhan.LyDoVaoVien == Enums.EnumLyDoVaoVien.CapCuu ? "X" : string.Empty;
                    var coDungTuyen = yeuCauTiepNhan.LyDoVaoVien == Enums.EnumLyDoVaoVien.DungTuyen ? "X" : string.Empty;
                    var coThongTuyen = yeuCauTiepNhan.LyDoVaoVien == Enums.EnumLyDoVaoVien.ThongTuyen ? "X" : string.Empty;
                    var coTraiTuyen = yeuCauTiepNhan.LyDoVaoVien == Enums.EnumLyDoVaoVien.TraiTuyen ? "X" : string.Empty;

                    using (var range = worksheet.Cells["A15:C15"])
                    {
                        range.Worksheet.Cells["A15:C15"].Merge = true;

                        range.Worksheet.Cells["A15:C15"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["A15:C15"].RichText.Add("(11) Cấp cứu: ");
                        var value = range.Worksheet.Cells["A15:C15"].RichText.Add(coCapCuu);
                        value.Bold = true;

                        range.Worksheet.Cells["A15:C15"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A15:C15"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A15:C15"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A15:C15"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["D15:F15"])
                    {
                        range.Worksheet.Cells["D15:F15"].Merge = true;
                        range.Worksheet.Cells["D15:F15"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["D15:F15"].RichText.Add("(12) Đúng tuyến: ");
                        var value = range.Worksheet.Cells["D15:F15"].RichText.Add(coDungTuyen);
                        value.Bold = true;

                        range.Worksheet.Cells["D15:F15"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["D15:F15"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["D15:F15"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["D15:F15"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["G15:J15"])
                    {
                        range.Worksheet.Cells["G15:J15"].Merge = true;
                        range.Worksheet.Cells["G15:J15"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["G15:J15"].RichText.Add("Nơi chuyến đến: ");
                        var value = range.Worksheet.Cells["G15:J15"].RichText.Add(yeuCauTiepNhan.NoiChuyen?.Ten);
                        value.Bold = true;
                        range.Worksheet.Cells["G15:J15"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["G15:J15"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["G15:J15"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["G15:J15"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["K15:N15"])
                    {
                        range.Worksheet.Cells["K15:N15"].Merge = true;
                        range.Worksheet.Cells["K15:N15"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["K15:N15"].RichText.Add("Nơi chuyển đi: ");
                        var value = range.Worksheet.Cells["K15:N15"].RichText.Add(yeuCauTiepNhan.NoiTruBenhAn?.ChuyenDenBenhVien?.Ten);
                        value.Bold = true;
                        range.Worksheet.Cells["K15:N15"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["K15:N15"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["K15:N15"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["K15:N15"].Style.Font.Color.SetColor(Color.Black);
                    }

                    //=================================16=================================
                    using (var range = worksheet.Cells["A16:C16"])
                    {
                        range.Worksheet.Cells["A16:C16"].Merge = true;
                        range.Worksheet.Cells["A16:C16"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["A16:C16"].RichText.Add("(13)Thông tuyến: ");
                        var value = range.Worksheet.Cells["A16:C16"].RichText.Add(coThongTuyen);
                        value.Bold = true;
                        range.Worksheet.Cells["A16:C16"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A16:C16"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A16:C16"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A16:C16"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["D16:F16"])
                    {
                        range.Worksheet.Cells["D16:F16"].Merge = true;
                        range.Worksheet.Cells["D16:F16"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["D16:F16"].RichText.Add("(14)Trái tuyến: ");
                        var value = range.Worksheet.Cells["D16:F16"].RichText.Add(coTraiTuyen);
                        value.Bold = true;

                        range.Worksheet.Cells["D16:F16"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["D16:F16"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["D16:F16"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["D16:F16"].Style.Font.Color.SetColor(Color.Black);
                    }

                    //================================= 17 =================================

                    var chuanDoanXacDinhStr = yeuCauTiepNhan.NoiTruBenhAn?.LoaiBenhAn == LoaiBenhAn.SanKhoaMo || yeuCauTiepNhan.NoiTruBenhAn?.LoaiBenhAn == LoaiBenhAn.SanKhoaThuong
                                                             ? chuanDoanXacDinhSanKhoa : yeuCauTiepNhan.NoiTruBenhAn?.ChanDoanChinhRaVienGhiChu;


                    var iCD10 = yeuCauTiepNhan.NoiTruBenhAn?.LoaiBenhAn == LoaiBenhAn.SanKhoaMo || yeuCauTiepNhan.NoiTruBenhAn?.LoaiBenhAn == LoaiBenhAn.SanKhoaThuong
                                                               ? maICD10 : yeuCauTiepNhan.NoiTruBenhAn?.ChanDoanChinhRaVienICD?.Ma;


                    using (var range = worksheet.Cells["A17:F17"])
                    {
                        range.Worksheet.Cells["A17:F17"].Merge = true;
                        range.Worksheet.Cells["A17:F17"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["A17:F17"].RichText.Add("(15)Chẩn đoán xác định: ");
                        var value = range.Worksheet.Cells["A17:F17"].RichText.Add(chuanDoanXacDinhStr);
                        value.Bold = true;

                        range.Worksheet.Cells["A17:F17"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A17:F17"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A17:F17"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A17:F17"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["G17:N17"])
                    {
                        range.Worksheet.Cells["G17:N17"].Merge = true;

                        range.Worksheet.Cells["G17:N17"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["G17:N17"].RichText.Add("(17) Mã bệnh: ");
                        var value = range.Worksheet.Cells["G17:N17"].RichText.Add(iCD10);
                        value.Bold = true;


                        range.Worksheet.Cells["G17:N17"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["G17:N17"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["G17:N17"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["G17:N17"].Style.Font.Color.SetColor(Color.Black);
                    }

                    //================================= 18 =================================

                    using (var range = worksheet.Cells["A18:F18"])
                    {
                        range.Worksheet.Cells["A18:F18"].Merge = true;
                        range.Worksheet.Cells["A18:F18"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["A18:F18"].RichText.Add("(18)Bệnh kèm theo: ");
                        var value = range.Worksheet.Cells["A18:F18"].RichText.Add(tenICDKemTheo);
                        value.Bold = true;


                        range.Worksheet.Cells["A18:F18"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A18:F18"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A18:F18"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A18:F18"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["G18:N18"])
                    {
                        range.Worksheet.Cells["G18:N18"].Merge = true;
                        range.Worksheet.Cells["G18:N18"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["G18:N18"].RichText.Add("(18)Mã bệnh kèm theo: ");
                        var value = range.Worksheet.Cells["G18:N18"].RichText.Add(maICDKemTheo);
                        value.Bold = true;


                        range.Worksheet.Cells["G18:N18"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["G18:N18"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["G18:N18"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["G18:N18"].Style.Font.Color.SetColor(Color.Black);
                    }

                    //================================= 19 =================================

                    using (var range = worksheet.Cells["A19:F19"])
                    {
                        range.Worksheet.Cells["A19:F19"].Merge = true;
                        range.Worksheet.Cells["A19:F19"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["A19:F19"].RichText.Add("(19)Thời điểm đủ 05 năm liên tục từ ngày: ");
                        var value = range.Worksheet.Cells["A19:F19"].RichText.Add(yeuCauTiepNhan.BHYTNgayDu5Nam?.ApplyFormatDate());
                        value.Bold = true;


                        range.Worksheet.Cells["A19:F19"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A19:F19"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A19:F19"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A19:F19"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["G19:N19"])
                    {
                        range.Worksheet.Cells["G19:N19"].Merge = true;
                        range.Worksheet.Cells["G19:N19"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["G19:N19"].RichText.Add("(20)Miễn cùng chi trả trong năm từ ngày: ");
                        var value = range.Worksheet.Cells["G19:N19"].RichText.Add(yeuCauTiepNhan.BHYTNgayDuocMienCungChiTra?.ApplyFormatDate());
                        value.Bold = true;

                        range.Worksheet.Cells["G19:N19"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["G19:N19"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["G19:N19"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["G19:N19"].Style.Font.Color.SetColor(Color.Black);
                    }

                    //================================= 20 =================================

                    using (var range = worksheet.Cells["A20:N20"])
                    {
                        range.Worksheet.Cells["A20:N20"].Merge = true;
                        range.Worksheet.Cells["A20:N20"].Value = "II. Phần Chi phí khám bệnh, chữa bệnh";
                        range.Worksheet.Cells["A20:N20"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A20:N20"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A20:N20"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A20:N20"].Style.Font.Color.SetColor(Color.Black);
                        range.Worksheet.Cells["A20:N20"].Style.Font.Bold = true;
                    }

                    int index = 21;

                    var groupChiPhiTheoThe = danhSachChiPhi.GroupBy(o => o.MaSoTheBHYT);
                    if (groupChiPhiTheoThe.Count() > 2 ||
                        (groupChiPhiTheoThe.All(o => o.Key != string.Empty) && groupChiPhiTheoThe.Count() > 1))
                    {
                        var groupNgayPhatSinhTheoThe = groupChiPhiTheoThe.Where(o => o.Key != string.Empty).Select(o => new { o.Key, o.OrderBy(j => j.NgayPhatSinh).First().NgayPhatSinh }).OrderBy(o => o.NgayPhatSinh).ToArray();
                        for (int i = 0; i < groupNgayPhatSinhTheoThe.Count(); i++)
                        {
                            var ngayPhatSinhTheoThe = groupNgayPhatSinhTheoThe[i];
                            var theBHYTChiTra = yeuCauTiepNhan.YeuCauTiepNhanTheBHYTs.First(o => o.MaSoThe == ngayPhatSinhTheoThe.Key);
                            var chiPhis = groupChiPhiTheoThe.FirstOrDefault(o => o.Key == ngayPhatSinhTheoThe.Key).ToList();
                            DateTime? ngayPhatSinhTiepTheo = i < groupNgayPhatSinhTheoThe.Count() - 1
                                ? groupNgayPhatSinhTheoThe[i + 1].NgayPhatSinh
                                : null;
                            chiPhis.AddRange(groupChiPhiTheoThe.FirstOrDefault(o => o.Key == string.Empty).Where(j => (i == 0 || j.NgayPhatSinh >= ngayPhatSinhTheoThe.NgayPhatSinh) && (ngayPhatSinhTiepTheo != null && j.NgayPhatSinh < ngayPhatSinhTiepTheo)).ToList());
                            var mucHuongPT = theBHYTChiTra != null && theBHYTChiTra.MucHuong > 0 ? theBHYTChiTra?.MucHuong + "%" : string.Empty;

                            using (var range = worksheet.Cells["A" + index + ":C" + index])
                            {
                                range.Worksheet.Cells["A" + index + ":C" + index].Merge = true;
                                range.Worksheet.Cells["A" + index + ":C" + index].Style.WrapText = true;
                                var title = range.Worksheet.Cells["A" + index + ":C" + index].RichText.Add("Mã thẻ BHYT: ");
                                var value = range.Worksheet.Cells["A" + index + ":C" + index].RichText.Add(theBHYTChiTra.MaSoThe);
                                value.Bold = true;

                                range.Worksheet.Cells["A" + index + ":C" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                range.Worksheet.Cells["A" + index + ":C" + index].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                                range.Worksheet.Cells["A" + index + ":C" + index].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                                range.Worksheet.Cells["A" + index + ":C" + index].Style.Font.Color.SetColor(Color.Black);
                            }

                            using (var range = worksheet.Cells["D" + index + ":F" + index])
                            {
                                range.Worksheet.Cells["D" + index + ":F" + index].Merge = true;
                                range.Worksheet.Cells["D" + index + ":F" + index].Style.WrapText = true;
                                var title = range.Worksheet.Cells["D" + index + ":F" + index].RichText.Add("Giá trị từ: ");
                                var valuebHYTTuNgay = range.Worksheet.Cells["D" + index + ":F" + index].RichText.Add(theBHYTChiTra.NgayHieuLuc.ApplyFormatDate());
                                valuebHYTTuNgay.Bold = true;

                                var den = range.Worksheet.Cells["D" + index + ":F" + index].RichText.Add(" đến: ");
                                den.Bold = false;
                                var valuebHYTDenNgay = range.Worksheet.Cells["D" + index + ":F" + index].RichText.Add(theBHYTChiTra?.NgayHetHan?.ApplyFormatDate());
                                valuebHYTDenNgay.Bold = true;

                                range.Worksheet.Cells["D" + index + ":F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                range.Worksheet.Cells["D" + index + ":F" + index].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                                range.Worksheet.Cells["D" + index + ":F" + index].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                                range.Worksheet.Cells["D" + index + ":F" + index].Style.Font.Color.SetColor(Color.Black);
                            }

                            using (var range = worksheet.Cells["G" + index + ":J" + index])
                            {
                                range.Worksheet.Cells["G" + index + ":J" + index].Merge = true;
                                range.Worksheet.Cells["G" + index + ":J" + index].Style.WrapText = true;
                                var title = range.Worksheet.Cells["G" + index + ":J" + index].RichText.Add("Mức hưởng: ");
                                var value = range.Worksheet.Cells["G" + index + ":J" + index].RichText.Add(mucHuongPT);
                                value.Bold = true;


                                range.Worksheet.Cells["G" + index + ":J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                range.Worksheet.Cells["G" + index + ":J" + index].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                                range.Worksheet.Cells["G" + index + ":J" + index].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                                range.Worksheet.Cells["G" + index + ":J" + index].Style.Font.Color.SetColor(Color.Black);
                            }

                            index++;

                            var indexTableFirst = index;
                            var indexTableLast = index + 1;

                            using (var range = worksheet.Cells["A" + indexTableFirst + ":N" + indexTableLast])
                            {
                                range.Worksheet.Cells["A" + indexTableFirst + ":N" + indexTableLast].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                                range.Worksheet.Cells["A" + indexTableFirst + ":N" + indexTableLast].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                                range.Worksheet.Cells["A" + indexTableFirst + ":N" + indexTableLast].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                range.Worksheet.Cells["A" + indexTableFirst + ":N" + indexTableLast].Style.Font.Color.SetColor(Color.Black);
                                range.Worksheet.Cells["A" + indexTableFirst + ":N" + indexTableLast].Style.Font.Bold = true;
                                range.Worksheet.Cells["A" + indexTableFirst + ":N" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);

                                range.Worksheet.Cells["A" + indexTableFirst + ":A" + indexTableLast].Merge = true;
                                range.Worksheet.Cells["A" + indexTableFirst + ":A" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["A" + indexTableFirst + ":A" + indexTableLast].Value = "STT";

                                range.Worksheet.Cells["B" + indexTableFirst + ":B" + indexTableLast].Merge = true;
                                range.Worksheet.Cells["B" + indexTableFirst + ":B" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["B" + indexTableFirst + ":B" + indexTableLast].Value = "Nội dung";

                                range.Worksheet.Cells["C" + indexTableFirst + ":C" + indexTableLast].Merge = true;
                                range.Worksheet.Cells["C" + indexTableFirst + ":C" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["C" + indexTableFirst + ":C" + indexTableLast].Value = "Đơn vị tính";

                                range.Worksheet.Cells["D" + indexTableFirst + ":D" + indexTableLast].Merge = true;
                                range.Worksheet.Cells["D" + indexTableFirst + ":D" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["D" + indexTableFirst + ":D" + indexTableLast].Value = "Số lượng";

                                range.Worksheet.Cells["E" + indexTableFirst + ":E" + indexTableLast].Merge = true;
                                range.Worksheet.Cells["E" + indexTableFirst + ":E" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["E" + indexTableFirst + ":E" + indexTableLast].Value = "Đơn giá BV(đồng)";

                                range.Worksheet.Cells["F" + indexTableFirst + ":F" + indexTableLast].Merge = true;
                                range.Worksheet.Cells["F" + indexTableFirst + ":F" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["F" + indexTableFirst + ":F" + indexTableLast].Value = "Đơn giá BH(đồng)";

                                range.Worksheet.Cells["G" + indexTableFirst + ":G" + indexTableLast].Merge = true;
                                range.Worksheet.Cells["G" + indexTableFirst + ":G" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["G" + indexTableFirst + ":G" + indexTableLast].Value = "Tỉ lệ thanh toán theo dịch vụ (%)";

                                range.Worksheet.Cells["H" + indexTableFirst + ":H" + indexTableLast].Merge = true;
                                range.Worksheet.Cells["H" + indexTableFirst + ":H" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["H" + indexTableFirst + ":H" + indexTableLast].Value = "Thành tiền BV (đồng)";

                                range.Worksheet.Cells["I" + indexTableFirst + ":I" + indexTableLast].Merge = true;
                                range.Worksheet.Cells["I" + indexTableFirst + ":I" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["I" + indexTableFirst + ":I" + indexTableLast].Value = "Tỷ lệ thanh toán BHYT (%)";

                                range.Worksheet.Cells["J" + indexTableFirst + ":J" + indexTableLast].Merge = true;
                                range.Worksheet.Cells["J" + indexTableFirst + ":J" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["J" + indexTableFirst + ":J" + indexTableLast].Value = "Thành tiền BH(đồng)";

                                range.Worksheet.Cells["K" + indexTableFirst + ":N" + indexTableFirst].Merge = true;
                                range.Worksheet.Cells["K" + indexTableFirst + ":N" + indexTableFirst].Value = "Nguồn thanh toán (đồng)";

                                range.Worksheet.Cells["K" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["K" + indexTableLast].Value = "Quỹ BHYT";

                                range.Worksheet.Cells["L" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["L" + indexTableLast].Value = "Người bệnh cùng chi trả (đồng)";

                                range.Worksheet.Cells["M" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["M" + indexTableLast].Value = "Khác (đồng)";

                                range.Worksheet.Cells["N" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["N" + indexTableLast].Value = "Người bệnh tự trả(đồng)";
                            }

                            index = indexTableLast + 1;


                            var dsChiPhiBangKeTheoThe = new List<BangKeKhamBenhBenhVienVo>();

                            foreach (var chiPhi in chiPhis.Where(c => c.NhomChiPhiBangKe != NhomChiPhiBangKe.GoiVatTu && c.YeuCauGoiDichVuId == null).GroupBy(c => new { c.DonGia, c.SoTienMG, KhongTinhPhi = c.KhongTinhPhi.GetValueOrDefault(), c.NhomChiPhiBangKe, c.TenDichVu, c.DonViTinh, c.DuocHuongBHYT, c.DonGiaBHYT, c.MucHuongBaoHiem, c.TiLeBaoHiemThanhToan }).OrderByDescending(o => o.Key.DuocHuongBHYT))
                            {
                                var chiphiBangKe = new BangKeKhamBenhBenhVienVo
                                {
                                    Nhom = chiPhi.Key.NhomChiPhiBangKe,
                                    Id = chiPhi.FirstOrDefault().Id,
                                    NoiDung = chiPhi.Key.TenDichVu,
                                    DonViTinh = chiPhi.Key.DonViTinh,
                                    SoLuong = (decimal)chiPhi.Sum(c => c.Soluong),
                                    DuocHuongBaoHiem = chiPhi.Key.DuocHuongBHYT,
                                    DonGiaBH = chiPhi.Key.DuocHuongBHYT ? chiPhi.Key.DonGiaBHYT : 0,
                                    MucHuongBaoHiem = chiPhi.Key.MucHuongBaoHiem,
                                    TiLeThanhToanTheoDV = chiPhi.Key.TiLeBaoHiemThanhToan,
                                    BaoHiemChiTra = true,
                                    DonGiaBV = chiPhi.Key.DonGia
                                };
                                if (chiPhi.Key.KhongTinhPhi == true)
                                {
                                    chiphiBangKe.Khac = chiPhi.Key.MucHuongBaoHiem > 0
                                        ? (chiphiBangKe.ThanhTienBV.GetValueOrDefault() - chiphiBangKe.ThanhTienBH.GetValueOrDefault())
                                        : chiphiBangKe.ThanhTienBV.GetValueOrDefault();
                                }
                                else
                                {
                                    chiphiBangKe.Khac = chiPhi.Sum(c => c.SoTienMG);
                                }
                                dsChiPhiBangKeTheoThe.Add(chiphiBangKe);
                            }

                            foreach (var chiPhi in chiPhis.Where(c => !(c.NhomChiPhiBangKe != NhomChiPhiBangKe.GoiVatTu && c.YeuCauGoiDichVuId == null)))
                            {
                                var chiphiBangKe = new BangKeKhamBenhBenhVienVo
                                {
                                    Nhom = chiPhi.NhomChiPhiBangKe,
                                    Id = chiPhi.Id,
                                    NoiDung = chiPhi.TenDichVu,
                                    DonViTinh = chiPhi.DonViTinh,
                                    SoLuong = (decimal)chiPhi.Soluong,
                                    DuocHuongBaoHiem = chiPhi.DuocHuongBHYT,
                                    DonGiaBH = chiPhi.DuocHuongBHYT ? chiPhi.DonGiaBHYT : 0,
                                    MucHuongBaoHiem = chiPhi.MucHuongBaoHiem,
                                    TiLeThanhToanTheoDV = chiPhi.TiLeBaoHiemThanhToan,
                                    BaoHiemChiTra = true,
                                    DonGiaBV = chiPhi.DonGia
                                };
                                if (chiPhi.KhongTinhPhi == true || chiPhi.YeuCauGoiDichVuId != null)
                                {
                                    chiphiBangKe.Khac = chiPhi.MucHuongBaoHiem > 0
                                        ? (chiphiBangKe.ThanhTienBV.GetValueOrDefault() - chiphiBangKe.ThanhTienBH.GetValueOrDefault())
                                        : chiphiBangKe.ThanhTienBV.GetValueOrDefault();
                                }
                                else
                                {
                                    chiphiBangKe.Khac = chiPhi.SoTienMG;
                                }
                                dsChiPhiBangKeTheoThe.Add(chiphiBangKe);
                            }
                            dsChiPhiBangKe.AddRange(dsChiPhiBangKeTheoThe);
                            var groupChiPhiBangKes = dsChiPhiBangKeTheoThe.GroupBy(x => x.Nhom).OrderBy(o => (int)o.Key * (o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay || o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriNoiTru ? 1 : 10));
                            if (!groupChiPhiBangKes.Any())
                            {
                                return null;
                            }
                            foreach (var groupChiPhiBangKe in groupChiPhiBangKes)
                            {
                                if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay)
                                {

                                    worksheet.Cells["A" + index + ":N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["A" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                    worksheet.Cells["A" + index + ":N" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                    worksheet.Cells["A" + index + ":N" + index].Merge = true;
                                    worksheet.Cells["A" + index + ":N" + index].Value = "2. Ngày giường:";
                                    worksheet.Cells["A" + index + ":N" + index].Style.Font.Bold = true;

                                    index++;

                                    worksheet.Cells["A" + index + ":G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["A" + index + ":G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                    worksheet.Cells["A" + index + ":G" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                    worksheet.Cells["A" + index + ":G" + index].Merge = true;
                                    worksheet.Cells["A" + index + ":G" + index].Value = "2.1." + groupChiPhiBangKe.Key.GetDescription();
                                    worksheet.Cells["A" + index + ":G" + index].Style.Font.Bold = true;

                                    worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["H" + index].Style.Font.Bold = true;
                                    worksheet.Cells["H" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBV);

                                    worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["J" + index].Style.Font.Bold = true;
                                    worksheet.Cells["J" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBH);

                                    worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["K" + index].Style.Font.Bold = true;
                                    worksheet.Cells["K" + index].Value = groupChiPhiBangKe.Sum(o => o.QuyBHYT);

                                    worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["L" + index].Style.Font.Bold = true;
                                    worksheet.Cells["L" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra);

                                    worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["M" + index].Style.Font.Bold = true;
                                    worksheet.Cells["M" + index].Value = groupChiPhiBangKe.Sum(o => o.Khac);

                                    worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["N" + index].Style.Font.Bold = true;
                                    worksheet.Cells["N" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra);

                                    index++;
                                }
                                else if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.NgayGiuongDieuTriNoiTru)
                                {
                                    if (!groupChiPhiBangKes.Any(o => o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay))
                                    {
                                        worksheet.Cells["A" + index + ":N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["A" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                        worksheet.Cells["A" + index + ":N" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                        worksheet.Cells["A" + index + ":N" + index].Merge = true;
                                        worksheet.Cells["A" + index + ":N" + index].Value = "2. Ngày giường:";
                                        worksheet.Cells["A" + index + ":N" + index].Style.Font.Bold = true;

                                    }
                                    index++;

                                    worksheet.Cells["A" + index + ":G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["A" + index + ":G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                    worksheet.Cells["A" + index + ":G" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                    worksheet.Cells["A" + index + ":G" + index].Merge = true;
                                    worksheet.Cells["A" + index + ":G" + index].Value = "2.2." + groupChiPhiBangKe.Key.GetDescription();
                                    worksheet.Cells["A" + index + ":G" + index].Style.Font.Bold = true;

                                    worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["H" + index].Style.Font.Bold = true;
                                    worksheet.Cells["H" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBV);

                                    worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["J" + index].Style.Font.Bold = true;
                                    worksheet.Cells["J" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBH);

                                    worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["K" + index].Style.Font.Bold = true;
                                    worksheet.Cells["K" + index].Value = groupChiPhiBangKe.Sum(o => o.QuyBHYT);

                                    worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["L" + index].Style.Font.Bold = true;
                                    worksheet.Cells["L" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra);

                                    worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["M" + index].Style.Font.Bold = true;
                                    worksheet.Cells["M" + index].Value = groupChiPhiBangKe.Sum(o => o.Khac);

                                    worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["N" + index].Style.Font.Bold = true;
                                    worksheet.Cells["N" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra);

                                    index++;
                                }
                                else
                                {
                                    worksheet.Cells["A" + index + ":G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["A" + index + ":G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                    worksheet.Cells["A" + index + ":G" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                    worksheet.Cells["A" + index + ":G" + index].Merge = true;
                                    worksheet.Cells["A" + index + ":G" + index].Value = (int)groupChiPhiBangKe.Key + "." + groupChiPhiBangKe.Key.GetDescription();
                                    worksheet.Cells["A" + index + ":G" + index].Style.Font.Bold = true;

                                    worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["H" + index].Style.Font.Bold = true;
                                    worksheet.Cells["H" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBV);

                                    worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["J" + index].Style.Font.Bold = true;
                                    worksheet.Cells["J" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBH);

                                    worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["K" + index].Style.Font.Bold = true;
                                    worksheet.Cells["K" + index].Value = groupChiPhiBangKe.Sum(o => o.QuyBHYT);

                                    worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["L" + index].Style.Font.Bold = true;
                                    worksheet.Cells["L" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra);

                                    worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["M" + index].Style.Font.Bold = true;
                                    worksheet.Cells["M" + index].Value = groupChiPhiBangKe.Sum(o => o.Khac);

                                    worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["N" + index].Style.Font.Bold = true;
                                    worksheet.Cells["N" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra);

                                    index++;
                                }
                                if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.GoiVatTu)
                                {
                                    var groupGoiVatTus = groupChiPhiBangKe.ToList().GroupBy(o => o.SoGoiVatTu.GetValueOrDefault()).OrderBy(o => o.Key);
                                    int sttGoiVatTu = 1;
                                    foreach (var groupGoiVatTu in groupGoiVatTus)
                                    {
                                        worksheet.Cells["A" + index + ":G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["A" + index + ":G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                        worksheet.Cells["A" + index + ":G" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                        worksheet.Cells["A" + index + ":G" + index].Value = "10." + sttGoiVatTu + ". " + groupChiPhiBangKe.Key.GetDescription() + " " + sttGoiVatTu;
                                        worksheet.Cells["A" + index + ":G" + index].Style.Font.Bold = true;
                                        worksheet.Cells["A" + index + ":G" + index].Merge = true;

                                        worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["H" + index].Style.Font.Bold = true;
                                        worksheet.Cells["H" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBV);

                                        worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["J" + index].Style.Font.Bold = true;
                                        worksheet.Cells["J" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBH);

                                        worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["K" + index].Style.Font.Bold = true;
                                        worksheet.Cells["K" + index].Value = groupChiPhiBangKe.Sum(o => o.QuyBHYT);

                                        worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["L" + index].Style.Font.Bold = true;
                                        worksheet.Cells["L" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra);

                                        worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["M" + index].Style.Font.Bold = true;
                                        worksheet.Cells["M" + index].Value = groupChiPhiBangKe.Sum(o => o.Khac);

                                        worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["N" + index].Style.Font.Bold = true;
                                        worksheet.Cells["N" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra);

                                        index++;

                                        foreach (var chiPhiBangKe in groupGoiVatTu)
                                        {
                                            worksheet.Cells["A" + index + ":N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["A" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                            worksheet.Cells["A" + index + ":N" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));

                                            worksheet.Cells["A" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["A" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                            worksheet.Cells["A" + index].Value = indexItem;

                                            worksheet.Cells["B" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["B" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                            worksheet.Cells["B" + index].Value = chiPhiBangKe.NoiDung;

                                            worksheet.Cells["C" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["C" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                            worksheet.Cells["C" + index].Value = chiPhiBangKe.DonViTinh;

                                            worksheet.Cells["D" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["D" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                            worksheet.Cells["D" + index].Value = chiPhiBangKe.SoLuong;

                                            worksheet.Cells["E" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["E" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                            worksheet.Cells["E" + index].Style.Numberformat.Format = "#,##0.00";
                                            worksheet.Cells["E" + index].Value = chiPhiBangKe.DonGiaBV;

                                            worksheet.Cells["F" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["F" + index].Style.Numberformat.Format = "#,##0.00";
                                            worksheet.Cells["F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                            worksheet.Cells["F" + index].Value = chiPhiBangKe.DonGiaBH;

                                            worksheet.Cells["G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                            worksheet.Cells["G" + index].Style.Numberformat.Format = "#,##0.00";
                                            worksheet.Cells["G" + index].Value = chiPhiBangKe.TiLeThanhToanTheoDV;

                                            worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                            worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                            worksheet.Cells["H" + index].Value = chiPhiBangKe.ThanhTienBV;

                                            worksheet.Cells["I" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["I" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                            worksheet.Cells["I" + index].Value = Convert.ToDouble(chiPhiBangKe.MucHuongBaoHiem > 0 ? 100 : 0).ApplyFormatMoneyToDouble();


                                            worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                            worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                            worksheet.Cells["J" + index].Value = chiPhiBangKe.ThanhTienBH;


                                            worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                            worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                            worksheet.Cells["K" + index].Value = chiPhiBangKe.QuyBHYT;


                                            worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                            worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                            worksheet.Cells["L" + index].Value = chiPhiBangKe.NguoiBenhCungChiTra;


                                            worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                            worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                            worksheet.Cells["M" + index].Value = chiPhiBangKe.Khac;


                                            worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                            worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                            worksheet.Cells["N" + index].Value = chiPhiBangKe.NguoiBenhTuTra;

                                            indexItem++;
                                            index++;
                                        }
                                    }
                                }
                                else
                                {
                                    foreach (var chiPhiBangKe in groupChiPhiBangKe)
                                    {
                                        worksheet.Cells["A" + index + ":N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["A" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                        worksheet.Cells["A" + index + ":N" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));

                                        worksheet.Cells["A" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["A" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                        worksheet.Cells["A" + index].Value = indexItem;

                                        worksheet.Cells["B" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["B" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                        worksheet.Cells["B" + index].Value = chiPhiBangKe.NoiDung;

                                        worksheet.Cells["C" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["C" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                        worksheet.Cells["C" + index].Value = chiPhiBangKe.DonViTinh;

                                        worksheet.Cells["D" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["D" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                        worksheet.Cells["D" + index].Value = chiPhiBangKe.SoLuong;

                                        worksheet.Cells["E" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["E" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["E" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["E" + index].Value = chiPhiBangKe.DonGiaBV;

                                        worksheet.Cells["F" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["F" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["F" + index].Value = chiPhiBangKe.DonGiaBH;

                                        worksheet.Cells["G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["G" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["G" + index].Value = chiPhiBangKe.TiLeThanhToanTheoDV;

                                        worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["H" + index].Value = chiPhiBangKe.ThanhTienBV;

                                        worksheet.Cells["I" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["I" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["I" + index].Value = Convert.ToDouble(chiPhiBangKe.MucHuongBaoHiem > 0 ? 100 : 0).ApplyFormatMoneyToDouble();


                                        worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["J" + index].Value = chiPhiBangKe.ThanhTienBH;


                                        worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["K" + index].Value = chiPhiBangKe.QuyBHYT;


                                        worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["L" + index].Value = chiPhiBangKe.NguoiBenhCungChiTra;


                                        worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["M" + index].Value = chiPhiBangKe.Khac;


                                        worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["N" + index].Value = chiPhiBangKe.NguoiBenhTuTra;

                                        indexItem++;
                                        index++;
                                    }
                                }

                            }
                            worksheet.Cells["A" + index + ":G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["A" + index + ":G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                            worksheet.Cells["A" + index + ":G" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                            worksheet.Cells["A" + index + ":G" + index].Merge = true;
                            worksheet.Cells["A" + index + ":G" + index].Value = "Tổng cộng";
                            worksheet.Cells["A" + index + ":G" + index].Style.Font.Bold = true;

                            worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                            worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                            worksheet.Cells["H" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.ThanhTienBV)).Sum();

                            worksheet.Cells["I" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["I" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;

                            worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                            worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                            worksheet.Cells["J" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.ThanhTienBH)).Sum();

                            worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                            worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                            worksheet.Cells["K" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.QuyBHYT)).Sum();

                            worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                            worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                            worksheet.Cells["L" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.NguoiBenhCungChiTra)).Sum();

                            worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                            worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                            worksheet.Cells["M" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.Khac)).Sum();

                            worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                            worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                            worksheet.Cells["N" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.NguoiBenhTuTra)).Sum();

                            index++;

                            worksheet.Cells["A" + index + ":N" + index].Merge = true;
                            worksheet.Cells["A" + index + ":N" + index].Value = "Tổng chi phí lần khám bệnh/cả đợt điều trị: " + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + " đồng";
                            worksheet.Cells["A" + index + ":N" + index].Style.Font.Bold = true;

                            index++;

                            worksheet.Cells["A" + index + ":N" + index].Merge = true;
                            worksheet.Cells["A" + index + ":N" + index].Value = "(Viết bằng chữ: " + NumberHelper.ChuyenSoRaText(Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBV))) + ")";

                            index++;

                            worksheet.Cells["A" + index + ":N" + index].Merge = true;
                            worksheet.Cells["A" + index + ":N" + index].Value = "Trong đó , số tiền do:";
                            worksheet.Cells["A" + index + ":N" + index].Style.Font.Bold = true;

                            index++;
                            worksheet.Cells["A" + index + ":N" + index].Merge = true;
                            worksheet.Cells["A" + index + ":N" + index].Value = "- Quỹ BHYT thanh toán: " + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble();

                            index++;
                            worksheet.Cells["A" + index + ":N" + index].Merge = true;
                            worksheet.Cells["A" + index + ":N" + index].Value = "- Người bệnh trả trong đó: " + (Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)) + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhTuTra))).ApplyFormatMoneyToDouble();

                            index++;
                            worksheet.Cells["A" + index + ":N" + index].Merge = true;
                            worksheet.Cells["A" + index + ":N" + index].Value = "+ Cùng chi trả trong phạm vi BHYT: " + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble(true);

                            index++;
                            worksheet.Cells["A" + index + ":N" + index].Merge = true;
                            worksheet.Cells["A" + index + ":N" + index].Value = "+ Các khoản phải trả khác: " + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true);

                            index++;
                            worksheet.Cells["A" + index + ":N" + index].Merge = true;
                            worksheet.Cells["A" + index + ":N" + index].Value = "+ Nguồn khác: " + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble(true);


                            index = index + 2;

                            worksheet.Cells["D" + index + ":F" + index].Style.Font.SetFromFont(new Font("Times New Roman", 12));
                            worksheet.Cells["D" + index + ":F" + index].Merge = true;
                            worksheet.Cells["D" + index + ":F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                            worksheet.Cells["D" + index + ":F" + index].Style.VerticalAlignment = ExcelVerticalAlignment.Top;
                            worksheet.Cells["D" + index + ":F" + index].Value = $"Ngày {DateTime.Now.Day} tháng {DateTime.Now.Month} năm {DateTime.Now.Year}";

                            worksheet.Cells["G" + index + ":I" + index].Style.Font.SetFromFont(new Font("Times New Roman", 12));
                            worksheet.Cells["G" + index + ":I" + index].Merge = true;
                            worksheet.Cells["G" + index + ":I" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                            worksheet.Cells["G" + index + ":I" + index].Style.VerticalAlignment = ExcelVerticalAlignment.Top;
                            worksheet.Cells["G" + index + ":I" + index].Value = $"Ngày {DateTime.Now.Day} tháng {DateTime.Now.Month} năm {DateTime.Now.Year}";

                            worksheet.Cells["J" + index + ":N" + index].Style.Font.Bold = true;
                            worksheet.Cells["J" + index + ":N" + index].Merge = true;
                            worksheet.Cells["J" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                            worksheet.Cells["J" + index + ":N" + index].Value = "XÁC NHẬN CỦA NGƯỜI BỆNH ";

                            index++;

                            worksheet.Cells["A" + index + ":C" + index].Style.Font.Bold = true;
                            worksheet.Cells["A" + index + ":C" + index].Merge = true;
                            worksheet.Cells["A" + index + ":C" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                            worksheet.Cells["A" + index + ":C" + index].Value = "NGƯỜI LẬP BẢNG KÊ";

                            worksheet.Cells["D" + index + ":F" + index].Style.Font.Bold = true;
                            worksheet.Cells["D" + index + ":F" + index].Merge = true;
                            worksheet.Cells["D" + index + ":F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                            worksheet.Cells["D" + index + ":F" + index].Value = "KẾ TOÁN VIỆN PHÍ";

                            worksheet.Cells["G" + index + ":I" + index].Style.Font.Bold = true;
                            worksheet.Cells["G" + index + ":I" + index].Merge = true;
                            worksheet.Cells["G" + index + ":I" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                            worksheet.Cells["G" + index + ":I" + index].Value = "GIÁM ĐỊNH BHYT";

                            worksheet.Cells["J" + index + ":N" + index].Style.Font.Bold = true;
                            worksheet.Cells["J" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                            worksheet.Cells["J" + index + ":N" + index].Merge = true;
                            worksheet.Cells["J" + index + ":N" + index].Value = "(Ký , Ghi rõ họ tên)";

                            index++;

                            worksheet.Cells["A" + index + ":C" + index].Style.Font.Bold = true;
                            worksheet.Cells["A" + index + ":C" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                            worksheet.Cells["A" + index + ":C" + index].Merge = true;
                            worksheet.Cells["A" + index + ":C" + index].Value = "(Ký , Ghi rõ họ tên)";


                            worksheet.Cells["D" + index + ":F" + index].Style.Font.Bold = true;
                            worksheet.Cells["D" + index + ":F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                            worksheet.Cells["D" + index + ":F" + index].Merge = true;
                            worksheet.Cells["D" + index + ":F" + index].Value = "(Ký , Ghi rõ họ tên)";

                            worksheet.Cells["G" + index + ":I" + index].Style.Font.Bold = true;
                            worksheet.Cells["G" + index + ":I" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                            worksheet.Cells["G" + index + ":I" + index].Merge = true;
                            worksheet.Cells["G" + index + ":I" + index].Value = "(Ký , Ghi rõ họ tên)";

                            worksheet.Cells["J" + index + ":N" + index].Style.Font.Bold = true;
                            worksheet.Cells["J" + index + ":N" + index].Merge = true;
                            worksheet.Cells["J" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                            worksheet.Cells["J" + index + ":N" + index].Value = "(Tôi đã nhận...phim...Xquang / CT / MRI)";

                            xlPackage.Save();
                        }
                    }
                    else
                    {
                        YeuCauTiepNhanTheBHYT theBHYTChiTra = null;
                        var maSoThe = groupChiPhiTheoThe.Where(o => o.Key != string.Empty).FirstOrDefault()?.Key;
                        if (!string.IsNullOrEmpty(maSoThe))
                        {
                            theBHYTChiTra = yeuCauTiepNhan.YeuCauTiepNhanTheBHYTs.First(o => o.MaSoThe == maSoThe);
                        }

                        var chiPhis = groupChiPhiTheoThe.SelectMany(o => o).ToList();
                        var mucHuongPT = theBHYTChiTra != null && theBHYTChiTra?.MucHuong > 0 ? theBHYTChiTra?.MucHuong + "%" : string.Empty;

                        using (var range = worksheet.Cells["A21:C21"])
                        {
                            range.Worksheet.Cells["A21:C21"].Merge = true;
                            range.Worksheet.Cells["A21:C21"].Style.WrapText = true;
                            var title = range.Worksheet.Cells["A21:C21"].RichText.Add("Mã thẻ BHYT: ");
                            var value = range.Worksheet.Cells["A21:C21"].RichText.Add(maBHYT);
                            value.Bold = true;

                            range.Worksheet.Cells["A21:C21"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                            range.Worksheet.Cells["A21:C21"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                            range.Worksheet.Cells["A21:C21"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                            range.Worksheet.Cells["A21:C21"].Style.Font.Color.SetColor(Color.Black);
                        }
                        using (var range = worksheet.Cells["A21:N21"])
                        {
                            range.Worksheet.Cells["D" + index + ":F" + index].Merge = true;
                            range.Worksheet.Cells["D" + index + ":F" + index].Style.WrapText = true;
                            var title = range.Worksheet.Cells["D" + index + ":F" + index].RichText.Add("Giá trị từ: ");
                            var valuebHYTTuNgay = range.Worksheet.Cells["D" + index + ":F" + index].RichText.Add(bHYTTuNgay);
                            valuebHYTTuNgay.Bold = true;

                            var den = range.Worksheet.Cells["D" + index + ":F" + index].RichText.Add(" đến: ");
                            den.Bold = false;
                            var valuebHYTDenNgay = range.Worksheet.Cells["D" + index + ":F" + index].RichText.Add(bHYTDenNgay);
                            valuebHYTDenNgay.Bold = true;

                            range.Worksheet.Cells["D" + index + ":F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                            range.Worksheet.Cells["D" + index + ":F" + index].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                            range.Worksheet.Cells["D" + index + ":F" + index].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                            range.Worksheet.Cells["D" + index + ":F" + index].Style.Font.Color.SetColor(Color.Black);
                        }
                        using (var range = worksheet.Cells["G21:J21"])
                        {
                            range.Worksheet.Cells["G21:J21"].Merge = true;
                            range.Worksheet.Cells["G21:J21"].Style.WrapText = true;
                            var title = range.Worksheet.Cells["G21:J21"].RichText.Add("Mức hưởng: ");
                            var value = range.Worksheet.Cells["G21:J21"].RichText.Add(mucHuong);
                            value.Bold = true;


                            range.Worksheet.Cells["G21:J21"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                            range.Worksheet.Cells["G21:J21"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                            range.Worksheet.Cells["G21:J21"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                            range.Worksheet.Cells["G21:J21"].Style.Font.Color.SetColor(Color.Black);
                        }
                        using (var range = worksheet.Cells["A22:N23"])
                        {
                            range.Worksheet.Cells["A22:N23"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                            range.Worksheet.Cells["A22:N23"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                            range.Worksheet.Cells["A22:N23"].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                            range.Worksheet.Cells["A22:N23"].Style.Font.Color.SetColor(Color.Black);
                            range.Worksheet.Cells["A22:N23"].Style.Font.Bold = true;
                            range.Worksheet.Cells["A22:N23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);

                            range.Worksheet.Cells["A22:A23"].Merge = true;
                            range.Worksheet.Cells["A22:A23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["A22:A23"].Value = "STT";

                            range.Worksheet.Cells["B22:B23"].Merge = true;
                            range.Worksheet.Cells["B22:B23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["B22:B23"].Value = "Nội dung";

                            range.Worksheet.Cells["C22:C23"].Merge = true;
                            range.Worksheet.Cells["C22:C23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["C22:C23"].Value = "Đơn vị tính";

                            range.Worksheet.Cells["D22:D23"].Merge = true;
                            range.Worksheet.Cells["D22:D23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["D22:D23"].Value = "Số lượng";

                            range.Worksheet.Cells["E22:E23"].Merge = true;
                            range.Worksheet.Cells["E22:E23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["E22:E23"].Value = "Đơn giá BV(đồng)";

                            range.Worksheet.Cells["F22:F23"].Merge = true;
                            range.Worksheet.Cells["F22:F23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["F22:F23"].Value = "Đơn giá BH(đồng)";

                            range.Worksheet.Cells["G22:G23"].Merge = true;
                            range.Worksheet.Cells["G22:G23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["G22:G23"].Value = "Tỉ lệ thanh toán theo dịch vụ (%)";

                            range.Worksheet.Cells["H22:H23"].Merge = true;
                            range.Worksheet.Cells["H22:H23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["H22:H23"].Value = "Thành tiền BV (đồng)";

                            range.Worksheet.Cells["I22:I23"].Merge = true;
                            range.Worksheet.Cells["I22:I23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["I22:I23"].Value = "Tỷ lệ thanh toán BHYT (%)";

                            range.Worksheet.Cells["J22:J23"].Merge = true;
                            range.Worksheet.Cells["J22:J23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["J22:J23"].Value = "Thành tiền BH(đồng)";

                            range.Worksheet.Cells["K22:N22"].Merge = true;
                            range.Worksheet.Cells["K22:N22"].Value = "Nguồn thanh toán (đồng)";

                            range.Worksheet.Cells["K23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["K23"].Value = "Quỹ BHYT";

                            range.Worksheet.Cells["L23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["L23"].Value = "Người bệnh cùng chi trả (đồng)";

                            range.Worksheet.Cells["M23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["M23"].Value = "Khác (đồng)";

                            range.Worksheet.Cells["N23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["N23"].Value = "Người bệnh tự trả(đồng)";
                        }


                        index = index + 3;


                        foreach (var chiPhi in chiPhis.Where(c => c.NhomChiPhiBangKe != NhomChiPhiBangKe.GoiVatTu && c.YeuCauGoiDichVuId == null).GroupBy(c => new { c.DonGia, c.SoTienMG, KhongTinhPhi = c.KhongTinhPhi.GetValueOrDefault(), c.NhomChiPhiBangKe, c.TenDichVu, c.DonViTinh, c.DuocHuongBHYT, c.DonGiaBHYT, c.MucHuongBaoHiem, c.TiLeBaoHiemThanhToan }).OrderByDescending(o => o.Key.DuocHuongBHYT))
                        {
                            var chiphiBangKe = new BangKeKhamBenhBenhVienVo
                            {
                                Nhom = chiPhi.Key.NhomChiPhiBangKe,
                                Id = chiPhi.FirstOrDefault().Id,
                                NoiDung = chiPhi.Key.TenDichVu,
                                DonViTinh = chiPhi.Key.DonViTinh,
                                SoLuong = (decimal)chiPhi.Sum(c => c.Soluong),
                                DuocHuongBaoHiem = chiPhi.Key.DuocHuongBHYT,
                                DonGiaBH = chiPhi.Key.DuocHuongBHYT ? chiPhi.Key.DonGiaBHYT : 0,
                                MucHuongBaoHiem = chiPhi.Key.MucHuongBaoHiem,
                                TiLeThanhToanTheoDV = chiPhi.Key.TiLeBaoHiemThanhToan,
                                BaoHiemChiTra = true,
                                DonGiaBV = chiPhi.Key.DonGia
                            };
                            if (chiPhi.Key.KhongTinhPhi == true)
                            {
                                chiphiBangKe.Khac = chiPhi.Key.MucHuongBaoHiem > 0
                                    ? (chiphiBangKe.ThanhTienBV.GetValueOrDefault() - chiphiBangKe.ThanhTienBH.GetValueOrDefault())
                                    : chiphiBangKe.ThanhTienBV.GetValueOrDefault();
                            }
                            else
                            {
                                chiphiBangKe.Khac = chiPhi.Sum(c => c.SoTienMG);
                            }
                            dsChiPhiBangKe.Add(chiphiBangKe);
                        }

                        foreach (var chiPhi in chiPhis.Where(c => !(c.NhomChiPhiBangKe != NhomChiPhiBangKe.GoiVatTu && c.YeuCauGoiDichVuId == null)))
                        {
                            var chiphiBangKe = new BangKeKhamBenhBenhVienVo
                            {
                                Nhom = chiPhi.NhomChiPhiBangKe,
                                Id = chiPhi.Id,
                                NoiDung = chiPhi.TenDichVu,
                                DonViTinh = chiPhi.DonViTinh,
                                SoLuong = (decimal)chiPhi.Soluong,
                                DuocHuongBaoHiem = chiPhi.DuocHuongBHYT,
                                DonGiaBH = chiPhi.DuocHuongBHYT ? chiPhi.DonGiaBHYT : 0,
                                MucHuongBaoHiem = chiPhi.MucHuongBaoHiem,
                                TiLeThanhToanTheoDV = chiPhi.TiLeBaoHiemThanhToan,
                                BaoHiemChiTra = true,
                                DonGiaBV = chiPhi.DonGia
                            };
                            if (chiPhi.KhongTinhPhi == true || chiPhi.YeuCauGoiDichVuId != null)
                            {
                                chiphiBangKe.Khac = chiPhi.MucHuongBaoHiem > 0
                                    ? (chiphiBangKe.ThanhTienBV.GetValueOrDefault() - chiphiBangKe.ThanhTienBH.GetValueOrDefault())
                                    : chiphiBangKe.ThanhTienBV.GetValueOrDefault();
                            }
                            else
                            {
                                chiphiBangKe.Khac = chiPhi.SoTienMG;
                            }
                            dsChiPhiBangKe.Add(chiphiBangKe);
                        }

                        var groupChiPhiBangKes = dsChiPhiBangKe.GroupBy(x => x.Nhom).OrderBy(o => (int)o.Key * (o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay || o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriNoiTru ? 1 : 10));
                        if (!groupChiPhiBangKes.Any())
                        {
                            return null;
                        }
                        foreach (var groupChiPhiBangKe in groupChiPhiBangKes)
                        {
                            if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay)
                            {

                                worksheet.Cells["A" + index + ":N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["A" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                worksheet.Cells["A" + index + ":N" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                worksheet.Cells["A" + index + ":N" + index].Merge = true;
                                worksheet.Cells["A" + index + ":N" + index].Value = "2. Ngày giường:";
                                worksheet.Cells["A" + index + ":N" + index].Style.Font.Bold = true;

                                index++;

                                worksheet.Cells["A" + index + ":G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["A" + index + ":G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                worksheet.Cells["A" + index + ":G" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                worksheet.Cells["A" + index + ":G" + index].Merge = true;
                                worksheet.Cells["A" + index + ":G" + index].Value = "2.1." + groupChiPhiBangKe.Key.GetDescription();
                                worksheet.Cells["A" + index + ":G" + index].Style.Font.Bold = true;

                                worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["H" + index].Style.Font.Bold = true;
                                worksheet.Cells["H" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBV);

                                worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["J" + index].Style.Font.Bold = true;
                                worksheet.Cells["J" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBH);

                                worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["K" + index].Style.Font.Bold = true;
                                worksheet.Cells["K" + index].Value = groupChiPhiBangKe.Sum(o => o.QuyBHYT);

                                worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["L" + index].Style.Font.Bold = true;
                                worksheet.Cells["L" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra);

                                worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["M" + index].Style.Font.Bold = true;
                                worksheet.Cells["M" + index].Value = groupChiPhiBangKe.Sum(o => o.Khac);

                                worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["N" + index].Style.Font.Bold = true;
                                worksheet.Cells["N" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra);

                                index++;
                            }
                            else if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.NgayGiuongDieuTriNoiTru)
                            {
                                if (!groupChiPhiBangKes.Any(o => o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay))
                                {
                                    worksheet.Cells["A" + index + ":N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["A" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                    worksheet.Cells["A" + index + ":N" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                    worksheet.Cells["A" + index + ":N" + index].Merge = true;
                                    worksheet.Cells["A" + index + ":N" + index].Value = "2. Ngày giường:";
                                    worksheet.Cells["A" + index + ":N" + index].Style.Font.Bold = true;

                                }
                                index++;
                                worksheet.Cells["A" + index + ":G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["A" + index + ":G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                worksheet.Cells["A" + index + ":G" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                worksheet.Cells["A" + index + ":G" + index].Merge = true;
                                worksheet.Cells["A" + index + ":G" + index].Value = "2.2." + groupChiPhiBangKe.Key.GetDescription();
                                worksheet.Cells["A" + index + ":G" + index].Style.Font.Bold = true;

                                worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["H" + index].Style.Font.Bold = true;
                                worksheet.Cells["H" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBV);

                                worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["J" + index].Style.Font.Bold = true;
                                worksheet.Cells["J" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBH);

                                worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["K" + index].Style.Font.Bold = true;
                                worksheet.Cells["K" + index].Value = groupChiPhiBangKe.Sum(o => o.QuyBHYT);

                                worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["L" + index].Style.Font.Bold = true;
                                worksheet.Cells["L" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra);

                                worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["M" + index].Style.Font.Bold = true;
                                worksheet.Cells["M" + index].Value = groupChiPhiBangKe.Sum(o => o.Khac);

                                worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["N" + index].Style.Font.Bold = true;
                                worksheet.Cells["N" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra);

                                index++;
                            }
                            else
                            {
                                worksheet.Cells["A" + index + ":G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["A" + index + ":G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                worksheet.Cells["A" + index + ":G" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                worksheet.Cells["A" + index + ":G" + index].Merge = true;
                                worksheet.Cells["A" + index + ":G" + index].Value = (int)groupChiPhiBangKe.Key + "." + groupChiPhiBangKe.Key.GetDescription();
                                worksheet.Cells["A" + index + ":G" + index].Style.Font.Bold = true;

                                worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["H" + index].Style.Font.Bold = true;
                                worksheet.Cells["H" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBV);

                                worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["J" + index].Style.Font.Bold = true;
                                worksheet.Cells["J" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBH);

                                worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["K" + index].Style.Font.Bold = true;
                                worksheet.Cells["K" + index].Value = groupChiPhiBangKe.Sum(o => o.QuyBHYT);

                                worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["L" + index].Style.Font.Bold = true;
                                worksheet.Cells["L" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra);

                                worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["M" + index].Style.Font.Bold = true;
                                worksheet.Cells["M" + index].Value = groupChiPhiBangKe.Sum(o => o.Khac);

                                worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["N" + index].Style.Font.Bold = true;
                                worksheet.Cells["N" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra);

                                index++;
                            }
                            if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.GoiVatTu)
                            {
                                var groupGoiVatTus = groupChiPhiBangKe.ToList().GroupBy(o => o.SoGoiVatTu.GetValueOrDefault()).OrderBy(o => o.Key);
                                int sttGoiVatTu = 1;
                                foreach (var groupGoiVatTu in groupGoiVatTus)
                                {
                                    worksheet.Cells["A" + index + ":G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["A" + index + ":G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                    worksheet.Cells["A" + index + ":G" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                    worksheet.Cells["A" + index + ":G" + index].Value = "10." + sttGoiVatTu + ". " + groupChiPhiBangKe.Key.GetDescription() + " " + sttGoiVatTu;
                                    worksheet.Cells["A" + index + ":G" + index].Style.Font.Bold = true;
                                    worksheet.Cells["A" + index + ":G" + index].Merge = true;

                                    worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["H" + index].Style.Font.Bold = true;
                                    worksheet.Cells["H" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBV);

                                    worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["J" + index].Style.Font.Bold = true;
                                    worksheet.Cells["J" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBH);

                                    worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["K" + index].Style.Font.Bold = true;
                                    worksheet.Cells["K" + index].Value = groupChiPhiBangKe.Sum(o => o.QuyBHYT);

                                    worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["L" + index].Style.Font.Bold = true;
                                    worksheet.Cells["L" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra);

                                    worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["M" + index].Style.Font.Bold = true;
                                    worksheet.Cells["M" + index].Value = groupChiPhiBangKe.Sum(o => o.Khac);

                                    worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["N" + index].Style.Font.Bold = true;
                                    worksheet.Cells["N" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra);

                                    index++;

                                    foreach (var chiPhiBangKe in groupGoiVatTu)
                                    {
                                        worksheet.Cells["A" + index + ":N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["A" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                        worksheet.Cells["A" + index + ":N" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));

                                        worksheet.Cells["A" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["A" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                        worksheet.Cells["A" + index].Value = indexItem;

                                        worksheet.Cells["B" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["B" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                        worksheet.Cells["B" + index].Value = chiPhiBangKe.NoiDung;

                                        worksheet.Cells["C" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["C" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                        worksheet.Cells["C" + index].Value = chiPhiBangKe.DonViTinh;

                                        worksheet.Cells["D" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["D" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                        worksheet.Cells["D" + index].Value = chiPhiBangKe.SoLuong;

                                        worksheet.Cells["E" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["E" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["E" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["E" + index].Value = chiPhiBangKe.DonGiaBV;

                                        worksheet.Cells["F" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["F" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["F" + index].Value = chiPhiBangKe.DonGiaBH;

                                        worksheet.Cells["G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["G" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["G" + index].Value = chiPhiBangKe.TiLeThanhToanTheoDV;

                                        worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["H" + index].Value = chiPhiBangKe.ThanhTienBV;

                                        worksheet.Cells["I" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["I" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["I" + index].Value = Convert.ToDouble(chiPhiBangKe.MucHuongBaoHiem > 0 ? 100 : 0).ApplyFormatMoneyToDouble();


                                        worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["J" + index].Value = chiPhiBangKe.ThanhTienBH;


                                        worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["K" + index].Value = chiPhiBangKe.QuyBHYT;


                                        worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["L" + index].Value = chiPhiBangKe.NguoiBenhCungChiTra;


                                        worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["M" + index].Value = chiPhiBangKe.Khac;


                                        worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["N" + index].Value = chiPhiBangKe.NguoiBenhTuTra;

                                        indexItem++;
                                        index++;
                                    }
                                }
                            }
                            else
                            {

                                foreach (var chiPhiBangKe in groupChiPhiBangKe)
                                {
                                    worksheet.Cells["A" + index + ":N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["A" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                    worksheet.Cells["A" + index + ":N" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));

                                    worksheet.Cells["A" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["A" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                    worksheet.Cells["A" + index].Value = indexItem;

                                    worksheet.Cells["B" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["B" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                    worksheet.Cells["B" + index].Value = chiPhiBangKe.NoiDung;

                                    worksheet.Cells["C" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["C" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                    worksheet.Cells["C" + index].Value = chiPhiBangKe.DonViTinh;

                                    worksheet.Cells["D" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["D" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                    worksheet.Cells["D" + index].Value = chiPhiBangKe.SoLuong;

                                    worksheet.Cells["E" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["E" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["E" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["E" + index].Value = chiPhiBangKe.DonGiaBV;

                                    worksheet.Cells["F" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["F" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["F" + index].Value = chiPhiBangKe.DonGiaBH;

                                    worksheet.Cells["G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["G" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["G" + index].Value = chiPhiBangKe.TiLeThanhToanTheoDV;

                                    worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["H" + index].Value = chiPhiBangKe.ThanhTienBV;

                                    worksheet.Cells["I" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["I" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["I" + index].Value = Convert.ToDouble(chiPhiBangKe.MucHuongBaoHiem > 0 ? 100 : 0).ApplyFormatMoneyToDouble();


                                    worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["J" + index].Value = chiPhiBangKe.ThanhTienBH;


                                    worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["K" + index].Value = chiPhiBangKe.QuyBHYT;


                                    worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["L" + index].Value = chiPhiBangKe.NguoiBenhCungChiTra;


                                    worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["M" + index].Value = chiPhiBangKe.Khac;


                                    worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["N" + index].Value = chiPhiBangKe.NguoiBenhTuTra;

                                    indexItem++;
                                    index++;
                                }
                            }

                        }
                        worksheet.Cells["A" + index + ":G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        worksheet.Cells["A" + index + ":G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        worksheet.Cells["A" + index + ":G" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                        worksheet.Cells["A" + index + ":G" + index].Merge = true;
                        worksheet.Cells["A" + index + ":G" + index].Value = "Tổng cộng";
                        worksheet.Cells["A" + index + ":G" + index].Style.Font.Bold = true;

                        worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                        worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                        worksheet.Cells["H" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.ThanhTienBV)).Sum();

                        worksheet.Cells["I" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        worksheet.Cells["I" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;

                        worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                        worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                        worksheet.Cells["J" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.ThanhTienBH)).Sum();

                        worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                        worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                        worksheet.Cells["K" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.QuyBHYT)).Sum();

                        worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                        worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                        worksheet.Cells["L" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.NguoiBenhCungChiTra)).Sum();

                        worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                        worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                        worksheet.Cells["M" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.Khac)).Sum();

                        worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                        worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                        worksheet.Cells["N" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.NguoiBenhTuTra)).Sum();

                        index++;

                        worksheet.Cells["A" + index + ":N" + index].Merge = true;
                        worksheet.Cells["A" + index + ":N" + index].Value = "Tổng chi phí lần khám bệnh/cả đợt điều trị: " + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + " đồng";
                        worksheet.Cells["A" + index + ":N" + index].Style.Font.Bold = true;

                        index++;

                        worksheet.Cells["A" + index + ":N" + index].Merge = true;
                        worksheet.Cells["A" + index + ":N" + index].Value = "(Viết bằng chữ: " + NumberHelper.ChuyenSoRaText(Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBV))) + ")";

                        index++;

                        worksheet.Cells["A" + index + ":N" + index].Merge = true;
                        worksheet.Cells["A" + index + ":N" + index].Value = "Trong đó , số tiền do:";
                        worksheet.Cells["A" + index + ":N" + index].Style.Font.Bold = true;

                        index++;
                        worksheet.Cells["A" + index + ":N" + index].Merge = true;
                        worksheet.Cells["A" + index + ":N" + index].Value = "- Quỹ BHYT thanh toán: " + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble();

                        index++;
                        worksheet.Cells["A" + index + ":N" + index].Merge = true;
                        worksheet.Cells["A" + index + ":N" + index].Value = "- Người bệnh trả trong đó: " + (Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)) + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhTuTra))).ApplyFormatMoneyToDouble();

                        index++;
                        worksheet.Cells["A" + index + ":N" + index].Merge = true;
                        worksheet.Cells["A" + index + ":N" + index].Value = "+ Cùng chi trả trong phạm vi BHYT: " + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble(true);

                        index++;
                        worksheet.Cells["A" + index + ":N" + index].Merge = true;
                        worksheet.Cells["A" + index + ":N" + index].Value = "+ Các khoản phải trả khác: " + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true);

                        index++;
                        worksheet.Cells["A" + index + ":N" + index].Merge = true;
                        worksheet.Cells["A" + index + ":N" + index].Value = "+ Nguồn khác: " + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble(true);


                        index = index + 2;

                        worksheet.Cells["D" + index + ":F" + index].Style.Font.SetFromFont(new Font("Times New Roman", 12));
                        worksheet.Cells["D" + index + ":F" + index].Merge = true;
                        worksheet.Cells["D" + index + ":F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        worksheet.Cells["D" + index + ":F" + index].Style.VerticalAlignment = ExcelVerticalAlignment.Top;
                        worksheet.Cells["D" + index + ":F" + index].Value = $"Ngày {DateTime.Now.Day} tháng {DateTime.Now.Month} năm {DateTime.Now.Year}";

                        worksheet.Cells["G" + index + ":I" + index].Style.Font.SetFromFont(new Font("Times New Roman", 12));
                        worksheet.Cells["G" + index + ":I" + index].Merge = true;
                        worksheet.Cells["G" + index + ":I" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        worksheet.Cells["G" + index + ":I" + index].Style.VerticalAlignment = ExcelVerticalAlignment.Top;
                        worksheet.Cells["G" + index + ":I" + index].Value = $"Ngày {DateTime.Now.Day} tháng {DateTime.Now.Month} năm {DateTime.Now.Year}";

                        worksheet.Cells["J" + index + ":N" + index].Style.Font.Bold = true;
                        worksheet.Cells["J" + index + ":N" + index].Merge = true;
                        worksheet.Cells["J" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        worksheet.Cells["J" + index + ":N" + index].Value = "XÁC NHẬN CỦA NGƯỜI BỆNH ";

                        index++;

                        worksheet.Cells["A" + index + ":C" + index].Style.Font.Bold = true;
                        worksheet.Cells["A" + index + ":C" + index].Merge = true;
                        worksheet.Cells["A" + index + ":C" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        worksheet.Cells["A" + index + ":C" + index].Value = "NGƯỜI LẬP BẢNG KÊ";

                        worksheet.Cells["D" + index + ":F" + index].Style.Font.Bold = true;
                        worksheet.Cells["D" + index + ":F" + index].Merge = true;
                        worksheet.Cells["D" + index + ":F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        worksheet.Cells["D" + index + ":F" + index].Value = "KẾ TOÁN VIỆN PHÍ";

                        worksheet.Cells["G" + index + ":I" + index].Style.Font.Bold = true;
                        worksheet.Cells["G" + index + ":I" + index].Merge = true;
                        worksheet.Cells["G" + index + ":I" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        worksheet.Cells["G" + index + ":I" + index].Value = "GIÁM ĐỊNH BHYT";

                        worksheet.Cells["J" + index + ":N" + index].Style.Font.Bold = true;
                        worksheet.Cells["J" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        worksheet.Cells["J" + index + ":N" + index].Merge = true;
                        worksheet.Cells["J" + index + ":N" + index].Value = "(Ký , Ghi rõ họ tên)";

                        index++;

                        worksheet.Cells["A" + index + ":C" + index].Style.Font.Bold = true;
                        worksheet.Cells["A" + index + ":C" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        worksheet.Cells["A" + index + ":C" + index].Merge = true;
                        worksheet.Cells["A" + index + ":C" + index].Value = "(Ký , Ghi rõ họ tên)";


                        worksheet.Cells["D" + index + ":F" + index].Style.Font.Bold = true;
                        worksheet.Cells["D" + index + ":F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        worksheet.Cells["D" + index + ":F" + index].Merge = true;
                        worksheet.Cells["D" + index + ":F" + index].Value = "(Ký , Ghi rõ họ tên)";

                        worksheet.Cells["G" + index + ":I" + index].Style.Font.Bold = true;
                        worksheet.Cells["G" + index + ":I" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        worksheet.Cells["G" + index + ":I" + index].Merge = true;
                        worksheet.Cells["G" + index + ":I" + index].Value = "(Ký , Ghi rõ họ tên)";

                        worksheet.Cells["J" + index + ":N" + index].Style.Font.Bold = true;
                        worksheet.Cells["J" + index + ":N" + index].Merge = true;
                        worksheet.Cells["J" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        worksheet.Cells["J" + index + ":N" + index].Value = "(Tôi đã nhận...phim...Xquang / CT / MRI)";

                        xlPackage.Save();
                    }
                }

                return stream.ToArray();
            }
        }

        public byte[] XuatBangKeTrongGoiDv(long taiKhoanThuId)
        {
            var taiKhoanBenhNhanThu = _taiKhoanBenhNhanThuRepository.TableNoTracking.Where(c => c.Id == taiKhoanThuId && c.LoaiThuTienBenhNhan == Enums.LoaiThuTienBenhNhan.ThuTheoChiPhi)
                                                                                    .Include(o => o.YeuCauTiepNhan).ThenInclude(o => o.NoiTruBenhAn).ThenInclude(o => o.ChuyenDenBenhVien)
                                                                                    .Include(o => o.YeuCauTiepNhan).ThenInclude(o => o.NoiTruBenhAn).ThenInclude(o => o.KhoaPhongNhapVien)
                                                                                    .Include(o => o.YeuCauTiepNhan).ThenInclude(o => o.NoiTruBenhAn).ThenInclude(o => o.ChanDoanChinhRaVienICD)
                                                                                    .Include(o => o.YeuCauTiepNhan).ThenInclude(o => o.YeuCauTiepNhanTheBHYTs)
                                                                                    .Include(o => o.YeuCauTiepNhan).ThenInclude(o => o.YeuCauNhapVien).ThenInclude(o => o.YeuCauKhamBenh).ThenInclude(o => o.YeuCauTiepNhan)
                                                                                    .Include(cc => cc.YeuCauTiepNhan)
                                                                                    .ThenInclude(xx => xx.BenhNhan)
                                                                                    .Include(cc => cc.YeuCauTiepNhan)
                                                                                    .ThenInclude(xx => xx.YeuCauKhamBenhs)
                                                                                    .ThenInclude(o => o.YeuCauKhamBenhChuanDoans)
                                                                                    .ThenInclude(o => o.ChuanDoan)
                                                                                    .Include(cc => cc.YeuCauTiepNhan).ThenInclude(cc => cc.PhuongXa)
                                                                                    .Include(cc => cc.YeuCauTiepNhan)
                                                                                    .ThenInclude(cc => cc.QuanHuyen)
                                                                                    .Include(cc => cc.YeuCauTiepNhan)
                                                                                    .ThenInclude(cc => cc.TinhThanh)
                                                                                    .Include(cc => cc.YeuCauTiepNhan)
                                                                                    .ThenInclude(cc => cc.NoiChuyen)
                                                                                    .Include(o => o.YeuCauTiepNhan).ThenInclude(o => o.NoiTruBenhAn).ThenInclude(o => o.NoiTruPhieuDieuTris).ThenInclude(c => c.ChanDoanChinhICD)
                                                                                    .Include(o => o.YeuCauTiepNhan).ThenInclude(o => o.NoiTruBenhAn).ThenInclude(o => o.NoiTruPhieuDieuTris).ThenInclude(o => o.NoiTruThamKhamChanDoanKemTheos).ThenInclude(c => c.ICD)
                                                                                    .Include(o => o.YeuCauTiepNhan).ThenInclude(o => o.NoiTruBenhAn).ThenInclude(o => o.NoiTruKhoaPhongDieuTris).ThenInclude(c => c.KhoaPhongChuyenDen).FirstOrDefault();

            var yeuCauTiepNhan = taiKhoanBenhNhanThu.YeuCauTiepNhan;
            if (yeuCauTiepNhan == null)
                return null;

            var danhSachChiPhi = GetTatCaDichVuKhamChuaBenh(yeuCauTiepNhan.Id).Result.Where(o => !o.Soluong.AlmostEqual(0) && o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.DaThanhToan && o.YeuCauGoiDichVuId != null).ToList();
            if (danhSachChiPhi.Count == 0)
            {
                return null;
            }

            var query = taiKhoanBenhNhanThu?.YeuCauTiepNhan; 
            var benhVien = new Core.Domain.Entities.BenhVien.BenhVien();

            string maBHYT = string.Empty;
            string bHYTTuNgay = string.Empty;
            string bHYTDenNgay = string.Empty;
            string mucHuong = string.Empty;
            string NoiDKKCBBanDau = string.Empty;
            string MaKCBBanDau = string.Empty;


            string maICDKemTheo = string.Empty;
            string tenICDKemTheo = string.Empty;

            string chuanDoanXacDinhSanKhoa = string.Empty;
            string maICD10 = string.Empty;

            if (yeuCauTiepNhan.NoiTruBenhAn != null && (yeuCauTiepNhan.NoiTruBenhAn.LoaiBenhAn == LoaiBenhAn.SanKhoaMo || yeuCauTiepNhan.NoiTruBenhAn.LoaiBenhAn == LoaiBenhAn.SanKhoaThuong))
            {
                if (yeuCauTiepNhan.NoiTruBenhAn?.NoiTruPhieuDieuTris.Count() > 0)
                {
                    var phieuDieuTri = yeuCauTiepNhan.NoiTruBenhAn?.NoiTruPhieuDieuTris.OrderByDescending(c => c.NgayDieuTri).FirstOrDefault();

                    var icdKemTheoIds = phieuDieuTri.NoiTruThamKhamChanDoanKemTheos.Select(c => c.ICD.Ma);
                    var tenICDKemTheos = phieuDieuTri.NoiTruThamKhamChanDoanKemTheos.Select(c => c.GhiChu);

                    maICDKemTheo = string.Join(", ", icdKemTheoIds);
                    tenICDKemTheo = string.Join(", ", tenICDKemTheos);

                    maICD10 = phieuDieuTri.ChanDoanChinhICD?.Ma;
                    chuanDoanXacDinhSanKhoa = phieuDieuTri.ChanDoanChinhGhiChu;
                }
            }
            else
            {
                if (!string.IsNullOrEmpty(yeuCauTiepNhan.NoiTruBenhAn?.DanhSachChanDoanKemTheoRaVienICDId))
                {
                    var maICDKemTheos = new List<string>();

                    var icdKemTheoIds = yeuCauTiepNhan.NoiTruBenhAn?.DanhSachChanDoanKemTheoRaVienICDId.Split(Constants.ICDSeparator);
                    var tenICDKemTheos = yeuCauTiepNhan.NoiTruBenhAn?.DanhSachChanDoanKemTheoRaVienGhiChu?.Split(Constants.ICDSeparator);

                    if (icdKemTheoIds.Length > 0)
                    {
                        foreach (var icdKemTheoId in icdKemTheoIds)
                        {
                            var icdKemTheo = _icdRepository.TableNoTracking.FirstOrDefault(o => o.Id == long.Parse(icdKemTheoId));
                            if (icdKemTheo != null)
                            {
                                maICDKemTheos.Add(icdKemTheo.Ma);
                            }

                            //if (long.TryParse(yeuCauTiepNhan.NoiTruBenhAn?.DanhSachChanDoanKemTheoRaVienICDId.Split(Constants.ICDSeparator).First(), out var icdKemTheoId))
                            //{
                            //    var icdKemTheo = _icdRepository.TableNoTracking.FirstOrDefault(o => o.Id == icdKemTheoId);
                            //    if (icdKemTheo != null)
                            //    {
                            //        maICDKemTheo = icdKemTheo.Ma;
                            //        tenICDKemTheo = yeuCauTiepNhan.NoiTruBenhAn?.DanhSachChanDoanKemTheoRaVienGhiChu?.Split(Constants.ICDSeparator).First();
                            //    }
                            //}
                        }
                    }

                    maICDKemTheo = string.Join(", ", maICDKemTheos);
                    tenICDKemTheo = string.Join(", ", tenICDKemTheos);
                }
            }


            YeuCauTiepNhanTheBHYT theBHYT = null;
            if (yeuCauTiepNhan.CoBHYT == true && yeuCauTiepNhan.YeuCauTiepNhanTheBHYTs.Any())
            {
                theBHYT = yeuCauTiepNhan.YeuCauTiepNhanTheBHYTs.First();
                if (!String.IsNullOrEmpty(theBHYT.MaDKBD))
                {
                    benhVien = _benhVienRepository.TableNoTracking.FirstOrDefault(p => p.Ma.Equals(theBHYT.MaDKBD));
                }
                maBHYT = theBHYT.MaSoThe;
                bHYTTuNgay = theBHYT.NgayHieuLuc.ApplyFormatDate();
                bHYTDenNgay = theBHYT.NgayHetHan?.ApplyFormatDate();
                mucHuong = theBHYT.MucHuong.ToString() + "%";
                NoiDKKCBBanDau = benhVien != null ? benhVien?.Ten : "Chưa xác định";
                MaKCBBanDau = theBHYT.MaDKBD;
            }
            else
            {
                maBHYT = "";
                bHYTTuNgay = "";
                bHYTDenNgay = "";
                mucHuong = "0%";
                NoiDKKCBBanDau = "Chưa xác định";
                MaKCBBanDau = "Chưa xác định";
            }

            //var thongTinPhieuThus = GetThongTinPhieuThu(taiKhoanThuId, LoaiPhieuThuChiThuNgan.ThuTheoChiPhi);
            //if (thongTinPhieuThus.ChiPhiKhamChuaBenhNoiTruVos.Count == 0)
            //{
            //    return string.Empty;
            //}
            var dsChiPhiBangKe = new List<BangKeKhamBenhBenhVienVo>();
            var dateItemChiPhis = string.Empty;
            int indexItem = 1;

            using (var stream = new MemoryStream())
            {
                using (var xlPackage = new ExcelPackage(stream))
                {

                    var worksheet = xlPackage.Workbook.Worksheets.Add("BẢNG KÊ CHI PHÍ ĐIỀU TRỊ NỘI TRÚ 3");

                    // set row
                    worksheet.Row(9).Height = 24.5;
                    worksheet.DefaultRowHeight = 16;

                    //SET chiều rộng cho từng cột tương ứng
                    worksheet.Column(1).Width = 10;
                    worksheet.Column(2).Width = 25;
                    worksheet.Column(3).Width = 15;
                    worksheet.Column(4).Width = 15;
                    worksheet.Column(5).Width = 15;
                    worksheet.Column(6).Width = 15;
                    worksheet.Column(7).Width = 15;
                    worksheet.Column(8).Width = 15;
                    worksheet.Column(9).Width = 15;
                    worksheet.Column(10).Width = 15;
                    worksheet.Column(11).Width = 15;
                    worksheet.Column(12).Width = 15;
                    worksheet.Column(13).Width = 15;
                    worksheet.Column(14).Width = 15;

                    worksheet.DefaultColWidth = 7;

                    using (var range = worksheet.Cells["A1:C1"])
                    {
                        range.Worksheet.Cells["A1:C1"].Merge = true;
                        range.Worksheet.Cells["A1:C1"].Value = "CƠ SỞ KHÁM CHỮA BỆNH : BỆNH VIỆN ĐKQT BẮC HÀ";
                        range.Worksheet.Cells["A1:C1"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A1:C1"].Style.VerticalAlignment = ExcelVerticalAlignment.Bottom;
                        range.Worksheet.Cells["A1:C1"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A1:C1"].Style.Font.Color.SetColor(Color.Black);
                    }


                    var khoaPhong = yeuCauTiepNhan.NoiTruBenhAn?.NoiTruKhoaPhongDieuTris.OrderByDescending(c => c.ThoiDiemVaoKhoa).Select(c => c.KhoaPhongChuyenDen).FirstOrDefault();
                    var chuyenKhoa = GetChuyenKhoa(khoaPhong?.Id); //BVHD-3792 

                    using (var range = worksheet.Cells["A2:C2"])
                    {
                        range.Worksheet.Cells["A2:C2"].Merge = true;
                        range.Worksheet.Cells["A2:C2"].Value = "Khoa: " + khoaPhong?.Ten;
                        range.Worksheet.Cells["A2:C2"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A2:C2"].Style.VerticalAlignment = ExcelVerticalAlignment.Bottom;
                        range.Worksheet.Cells["A2:C2"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A2:C2"].Style.Font.Color.SetColor(Color.Black);
                        range.Worksheet.Cells["A2:C2"].Style.Font.Bold = true;
                    }

                    using (var range = worksheet.Cells["A3:C3"])
                    {
                        range.Worksheet.Cells["A3:C3"].Merge = true;
                        range.Worksheet.Cells["A3:C3"].Value = "Mã khoa: " + chuyenKhoa?.Ma;
                        range.Worksheet.Cells["A3:C3"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A3:C3"].Style.VerticalAlignment = ExcelVerticalAlignment.Bottom;
                        range.Worksheet.Cells["A3:C3"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A3:C3"].Style.Font.Color.SetColor(Color.Black);
                        range.Worksheet.Cells["A3:C3"].Style.Font.Bold = true;
                    }

                    using (var range = worksheet.Cells["L1:N1"])
                    {
                        range.Worksheet.Cells["L1:N1"].Merge = true;
                        range.Worksheet.Cells["L1:N1"].Value = "Mẫu số : 01/KBCB ";
                        range.Worksheet.Cells["L1:N1"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                        range.Worksheet.Cells["L1:N1"].Style.VerticalAlignment = ExcelVerticalAlignment.Bottom;
                        range.Worksheet.Cells["L1:N1"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["L1:N1"].Style.Font.Color.SetColor(Color.Black);
                        range.Worksheet.Cells["L1:N1"].Style.Font.Bold = true;
                    }

                    using (var range = worksheet.Cells["L2:N2"])
                    {
                        range.Worksheet.Cells["L2:N2"].Merge = true;
                        range.Worksheet.Cells["L2:N2"].Value = "Mã số người bệnh: " + yeuCauTiepNhan.BenhNhan.MaBN;
                        range.Worksheet.Cells["L2:N2"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                        range.Worksheet.Cells["L2:N2"].Style.VerticalAlignment = ExcelVerticalAlignment.Bottom;
                        range.Worksheet.Cells["L2:N2"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["L2:N2"].Style.Font.Color.SetColor(Color.Black);
                        range.Worksheet.Cells["L2:N2"].Style.Font.Bold = true;
                    }

                    using (var range = worksheet.Cells["L3:N3"])
                    {
                        range.Worksheet.Cells["L3:N3"].Merge = true;
                        range.Worksheet.Cells["L3:N3"].Value = "Số khám bệnh:" + yeuCauTiepNhan.MaYeuCauTiepNhan;
                        range.Worksheet.Cells["L3:N3"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                        range.Worksheet.Cells["L3:N3"].Style.VerticalAlignment = ExcelVerticalAlignment.Bottom;
                        range.Worksheet.Cells["L3:N3"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["L3:N3"].Style.Font.Color.SetColor(Color.Black);
                        range.Worksheet.Cells["L3:N3"].Style.Font.Bold = true;
                    }

                    using (var range = worksheet.Cells["L4:N4"])
                    {
                        range.Worksheet.Cells["L4:N4"].Merge = true;
                        range.Worksheet.Cells["L4:N4"].Value = "Số bệnh án: " + yeuCauTiepNhan.NoiTruBenhAn?.SoBenhAn;
                        range.Worksheet.Cells["L4:N4"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                        range.Worksheet.Cells["L4:N4"].Style.VerticalAlignment = ExcelVerticalAlignment.Bottom;
                        range.Worksheet.Cells["L4:N4"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["L4:N4"].Style.Font.Color.SetColor(Color.Black);
                        range.Worksheet.Cells["L4:N4"].Style.Font.Bold = true;
                    }

                    using (var range = worksheet.Cells["A5:N6"])
                    {
                        range.Worksheet.Cells["A5:N6"].Merge = true;
                        range.Worksheet.Cells["A5:N6"].Value = "BẢNG KÊ CHI PHÍ ĐIỀU TRỊ NỘI TRÚ 3";
                        range.Worksheet.Cells["A5:N6"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        range.Worksheet.Cells["A5:N6"].Style.VerticalAlignment = ExcelVerticalAlignment.Bottom;
                        range.Worksheet.Cells["A5:N6"].Style.Font.SetFromFont(new Font("Times New Roman", 18));
                        range.Worksheet.Cells["A5:N6"].Style.Font.Color.SetColor(Color.Black);
                        range.Worksheet.Cells["A5:N6"].Style.Font.Bold = true;
                    }

                    using (var range = worksheet.Cells["A7:N7"])
                    {
                        range.Worksheet.Cells["A7:N7"].Merge = true;
                        range.Worksheet.Cells["A7:N7"].Value = "I.Hành chính";
                        range.Worksheet.Cells["A7:N7"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A7:N7"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A7:N7"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A7:N7"].Style.Font.Color.SetColor(Color.Black);
                        range.Worksheet.Cells["A7:N7"].Style.Font.Bold = true;
                    }

                    using (var range = worksheet.Cells["A8:F8"])
                    {
                        range.Worksheet.Cells["A8:F8"].Merge = true;

                        range.Worksheet.Cells["A8:F8"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["A8:F8"].RichText.Add("(1) Họ tên người bệnh: ");
                        var value = range.Worksheet.Cells["A8:F8"].RichText.Add(yeuCauTiepNhan.HoTen);
                        value.Bold = true;

                        range.Worksheet.Cells["A8:F8"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A8:F8"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A8:F8"].Style.Font.SetFromFont(new Font("Times New Roman", 11));


                        range.Worksheet.Cells["A8:F8"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["G8:J8"])
                    {
                        range.Worksheet.Cells["G8:J8"].Merge = true;
                        range.Worksheet.Cells["G8:J8"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["G8:J8"].RichText.Add("Ngày,tháng,năm sinh: ");
                        var value = range.Worksheet.Cells["G8:J8"].RichText.Add(DateHelper.DOBFormat(yeuCauTiepNhan.NgaySinh, yeuCauTiepNhan.ThangSinh, yeuCauTiepNhan.NamSinh));
                        value.Bold = true;

                        range.Worksheet.Cells["G8:J8"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["G8:J8"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["G8:J8"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["G8:J8"].Style.Font.Color.SetColor(Color.Black);
                    }

                    var gioitinh = yeuCauTiepNhan.GioiTinh != null ? yeuCauTiepNhan.GioiTinh.GetDescription() : "";
                    using (var range = worksheet.Cells["K8:N8"])
                    {
                        range.Worksheet.Cells["K8:N8"].Merge = true;

                        range.Worksheet.Cells["K8:N8"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["K8:N8"].RichText.Add("Giới tính: ");
                        var value = range.Worksheet.Cells["K8:N8"].RichText.Add(gioitinh);
                        value.Bold = true;

                        range.Worksheet.Cells["K8:N8"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["K8:N8"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["K8:N8"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["K8:N8"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["A9:F9"])
                    {
                        range.Worksheet.Cells["A9:F9"].Merge = true;

                        range.Worksheet.Cells["A9:F9"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["A9:F9"].RichText.Add("(2)Địa chỉ hiện tại: ");
                        var value = range.Worksheet.Cells["A9:F9"].RichText.Add(yeuCauTiepNhan.DiaChiDayDu);
                        value.Bold = true;

                        range.Worksheet.Cells["A9:F9"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A9:F9"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A9:F9"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A9:F9"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["G9:J9"])
                    {
                        range.Worksheet.Cells["G9:J9"].Merge = true;

                        range.Worksheet.Cells["G9:J9"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["G9:J9"].RichText.Add("(3)Mã khu vực(K1/K2/K3): ");
                        var value = range.Worksheet.Cells["G9:J9"].RichText.Add(yeuCauTiepNhan.BHYTMaKhuVuc);
                        value.Bold = true;

                        range.Worksheet.Cells["G9:J9"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["G9:J9"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["G9:J9"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["G9:J9"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["A10:F10"])
                    {
                        range.Worksheet.Cells["A10:F10"].Merge = true;
                        range.Worksheet.Cells["A10:F10"].Style.WrapText = true;

                        var title = range.Worksheet.Cells["A10:F10"].RichText.Add("(4)Mã thẻ BHYT: ");
                        var value = range.Worksheet.Cells["A10:F10"].RichText.Add(maBHYT);
                        value.Bold = true;

                        range.Worksheet.Cells["A10:F10"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A10:F10"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A10:F10"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A10:F10"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["G10:J10"])
                    {
                        range.Worksheet.Cells["G10:J10"].Merge = true;
                        range.Worksheet.Cells["G10:J10"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["G10:J10"].RichText.Add("Giá trị từ: ");
                        var valuebHYTTuNgay = range.Worksheet.Cells["G10:J10"].RichText.Add(bHYTTuNgay);
                        valuebHYTTuNgay.Bold = true;

                        var den = range.Worksheet.Cells["G10:J10"].RichText.Add(" đến: ");
                        den.Bold = false;
                        var valuebHYTDenNgay = range.Worksheet.Cells["G10:J10"].RichText.Add(bHYTDenNgay);
                        valuebHYTDenNgay.Bold = true;


                        range.Worksheet.Cells["G10:J10"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["G10:J10"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["G10:J10"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["G10:J10"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["A11:F11"])
                    {
                        range.Worksheet.Cells["A11:F11"].Merge = true;

                        range.Worksheet.Cells["A11:F11"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["A11:F11"].RichText.Add("(5)Nơi ĐK KCB ban đầu: ");
                        var valueNoiDKKCBBanDau = range.Worksheet.Cells["A11:F11"].RichText.Add(NoiDKKCBBanDau);
                        valueNoiDKKCBBanDau.Bold = true;

                        range.Worksheet.Cells["A11:F11"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A11:F11"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A11:F11"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A11:F11"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["G11:J11"])
                    {
                        range.Worksheet.Cells["G11:J11"].Merge = true;
                        range.Worksheet.Cells["G11:J11"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["G11:J11"].RichText.Add("(6)Mã: ");
                        var valueMaKCBBanDau = range.Worksheet.Cells["G11:J11"].RichText.Add(MaKCBBanDau);
                        valueMaKCBBanDau.Bold = true;

                        range.Worksheet.Cells["G11:J11"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["G11:J11"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["G11:J11"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["G11:J11"].Style.Font.Color.SetColor(Color.Black);
                    }


                    using (var range = worksheet.Cells["A12:F12"])
                    {
                        range.Worksheet.Cells["A12:F12"].Merge = true;

                        range.Worksheet.Cells["A12:F12"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["A12:F12"].RichText.Add("(7)Đến Khám: ");
                        var value = range.Worksheet.Cells["A12:F12"].RichText.Add(yeuCauTiepNhan.ThoiDiemTiepNhan.ApplyFormatGioPhutNgay());
                        value.Bold = true;

                        range.Worksheet.Cells["A12:F12"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A12:F12"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A12:F12"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A12:F12"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["A13:F13"])
                    {
                        range.Worksheet.Cells["A13:F13"].Merge = true;

                        range.Worksheet.Cells["A13:F13"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["A13:F13"].RichText.Add("(8)Điều trị ngoại trú/nội trú từ: ");
                        var value = range.Worksheet.Cells["A13:F13"].RichText.Add(yeuCauTiepNhan.NoiTruBenhAn?.ThoiDiemNhapVien.ApplyFormatGioPhutNgay());
                        value.Bold = true;

                        range.Worksheet.Cells["A13:F13"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A13:F13"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A13:F13"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A13:F13"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["A14:F14"])
                    {
                        range.Worksheet.Cells["A14:F14"].Merge = true;
                        range.Worksheet.Cells["A14:F14"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["A14:F14"].RichText.Add("(9)Kết thúc khám/điều trị: ");
                        var value = range.Worksheet.Cells["A14:F14"].RichText.Add(yeuCauTiepNhan.NoiTruBenhAn?.ThoiDiemRaVien?.ApplyFormatGioPhutNgay());
                        value.Bold = true;


                        range.Worksheet.Cells["A14:F14"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A14:F14"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A14:F14"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A14:F14"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["G14:J14"])
                    {
                        range.Worksheet.Cells["G14:J14"].Merge = true;
                        range.Worksheet.Cells["G14:J14"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["G14:J14"].RichText.Add("Tổng số ngày điều trị: ");
                        var value = range.Worksheet.Cells["G14:J14"].RichText.Add(NoiTruBenhAnHelper.TinhSoNgayDieuTri(yeuCauTiepNhan.NoiTruBenhAn)?.ToString() ?? string.Empty);
                        value.Bold = true;

                        range.Worksheet.Cells["G14:J14"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["G14:J14"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["G14:J14"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["G14:J14"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["K14:N14"])
                    {
                        range.Worksheet.Cells["K14:N14"].Merge = true;

                        range.Worksheet.Cells["K14:N14"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["K14:N14"].RichText.Add("(10)Tình trạng ra viện: ");
                        var value = range.Worksheet.Cells["K14:N14"].RichText.Add((yeuCauTiepNhan.NoiTruBenhAn?.TinhTrangRaVien == EnumTinhTrangRaVien.RaVien && (yeuCauTiepNhan.NoiTruBenhAn?.KetQuaDieuTri == EnumKetQuaDieuTri.Do || yeuCauTiepNhan.NoiTruBenhAn?.KetQuaDieuTri == EnumKetQuaDieuTri.Khoi) ? 1 : 2).ToString());
                        value.Bold = true;


                        range.Worksheet.Cells["K14:N14"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["K14:N14"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["K14:N14"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["K14:N14"].Style.Font.Color.SetColor(Color.Black);
                    }

                    //=================================15=================================
                    var coCapCuu = yeuCauTiepNhan.LyDoVaoVien == Enums.EnumLyDoVaoVien.CapCuu ? "X" : string.Empty;
                    var coDungTuyen = yeuCauTiepNhan.LyDoVaoVien == Enums.EnumLyDoVaoVien.DungTuyen ? "X" : string.Empty;
                    var coThongTuyen = yeuCauTiepNhan.LyDoVaoVien == Enums.EnumLyDoVaoVien.ThongTuyen ? "X" : string.Empty;
                    var coTraiTuyen = yeuCauTiepNhan.LyDoVaoVien == Enums.EnumLyDoVaoVien.TraiTuyen ? "X" : string.Empty;

                    using (var range = worksheet.Cells["A15:C15"])
                    {
                        range.Worksheet.Cells["A15:C15"].Merge = true;

                        range.Worksheet.Cells["A15:C15"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["A15:C15"].RichText.Add("(11) Cấp cứu: ");
                        var value = range.Worksheet.Cells["A15:C15"].RichText.Add(coCapCuu);
                        value.Bold = true;

                        range.Worksheet.Cells["A15:C15"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A15:C15"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A15:C15"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A15:C15"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["D15:F15"])
                    {
                        range.Worksheet.Cells["D15:F15"].Merge = true;
                        range.Worksheet.Cells["D15:F15"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["D15:F15"].RichText.Add("(12) Đúng tuyến: ");
                        var value = range.Worksheet.Cells["D15:F15"].RichText.Add(coDungTuyen);
                        value.Bold = true;

                        range.Worksheet.Cells["D15:F15"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["D15:F15"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["D15:F15"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["D15:F15"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["G15:J15"])
                    {
                        range.Worksheet.Cells["G15:J15"].Merge = true;
                        range.Worksheet.Cells["G15:J15"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["G15:J15"].RichText.Add("Nơi chuyến đến: ");
                        var value = range.Worksheet.Cells["G15:J15"].RichText.Add(yeuCauTiepNhan.NoiChuyen?.Ten);
                        value.Bold = true;
                        range.Worksheet.Cells["G15:J15"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["G15:J15"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["G15:J15"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["G15:J15"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["K15:N15"])
                    {
                        range.Worksheet.Cells["K15:N15"].Merge = true;
                        range.Worksheet.Cells["K15:N15"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["K15:N15"].RichText.Add("Nơi chuyển đi: ");
                        var value = range.Worksheet.Cells["K15:N15"].RichText.Add(yeuCauTiepNhan.NoiTruBenhAn?.ChuyenDenBenhVien?.Ten);
                        value.Bold = true;
                        range.Worksheet.Cells["K15:N15"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["K15:N15"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["K15:N15"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["K15:N15"].Style.Font.Color.SetColor(Color.Black);
                    }

                    //=================================16=================================
                    using (var range = worksheet.Cells["A16:C16"])
                    {
                        range.Worksheet.Cells["A16:C16"].Merge = true;
                        range.Worksheet.Cells["A16:C16"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["A16:C16"].RichText.Add("(13)Thông tuyến: ");
                        var value = range.Worksheet.Cells["A16:C16"].RichText.Add(coThongTuyen);
                        value.Bold = true;
                        range.Worksheet.Cells["A16:C16"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A16:C16"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A16:C16"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A16:C16"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["D16:F16"])
                    {
                        range.Worksheet.Cells["D16:F16"].Merge = true;
                        range.Worksheet.Cells["D16:F16"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["D16:F16"].RichText.Add("(14)Trái tuyến: ");
                        var value = range.Worksheet.Cells["D16:F16"].RichText.Add(coTraiTuyen);
                        value.Bold = true;

                        range.Worksheet.Cells["D16:F16"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["D16:F16"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["D16:F16"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["D16:F16"].Style.Font.Color.SetColor(Color.Black);
                    }

                    //================================= 17 =================================

                    var chuanDoanXacDinhStr = yeuCauTiepNhan.NoiTruBenhAn?.LoaiBenhAn == LoaiBenhAn.SanKhoaMo || yeuCauTiepNhan.NoiTruBenhAn?.LoaiBenhAn == LoaiBenhAn.SanKhoaThuong
                                                             ? chuanDoanXacDinhSanKhoa : yeuCauTiepNhan.NoiTruBenhAn?.ChanDoanChinhRaVienGhiChu;


                    var iCD10 = yeuCauTiepNhan.NoiTruBenhAn?.LoaiBenhAn == LoaiBenhAn.SanKhoaMo || yeuCauTiepNhan.NoiTruBenhAn?.LoaiBenhAn == LoaiBenhAn.SanKhoaThuong
                                                               ? maICD10 : yeuCauTiepNhan.NoiTruBenhAn?.ChanDoanChinhRaVienICD?.Ma;


                    using (var range = worksheet.Cells["A17:F17"])
                    {
                        range.Worksheet.Cells["A17:F17"].Merge = true;
                        range.Worksheet.Cells["A17:F17"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["A17:F17"].RichText.Add("(15)Chẩn đoán xác định: ");
                        var value = range.Worksheet.Cells["A17:F17"].RichText.Add(chuanDoanXacDinhStr);
                        value.Bold = true;

                        range.Worksheet.Cells["A17:F17"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A17:F17"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A17:F17"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A17:F17"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["G17:N17"])
                    {
                        range.Worksheet.Cells["G17:N17"].Merge = true;

                        range.Worksheet.Cells["G17:N17"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["G17:N17"].RichText.Add("(17) Mã bệnh: ");
                        var value = range.Worksheet.Cells["G17:N17"].RichText.Add(iCD10);
                        value.Bold = true;


                        range.Worksheet.Cells["G17:N17"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["G17:N17"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["G17:N17"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["G17:N17"].Style.Font.Color.SetColor(Color.Black);
                    }

                    //================================= 18 =================================

                    using (var range = worksheet.Cells["A18:F18"])
                    {
                        range.Worksheet.Cells["A18:F18"].Merge = true;
                        range.Worksheet.Cells["A18:F18"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["A18:F18"].RichText.Add("(18)Bệnh kèm theo: ");
                        var value = range.Worksheet.Cells["A18:F18"].RichText.Add(tenICDKemTheo);
                        value.Bold = true;


                        range.Worksheet.Cells["A18:F18"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A18:F18"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A18:F18"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A18:F18"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["G18:N18"])
                    {
                        range.Worksheet.Cells["G18:N18"].Merge = true;
                        range.Worksheet.Cells["G18:N18"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["G18:N18"].RichText.Add("(18)Mã bệnh kèm theo: ");
                        var value = range.Worksheet.Cells["G18:N18"].RichText.Add(maICDKemTheo);
                        value.Bold = true;


                        range.Worksheet.Cells["G18:N18"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["G18:N18"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["G18:N18"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["G18:N18"].Style.Font.Color.SetColor(Color.Black);
                    }

                    //================================= 19 =================================

                    using (var range = worksheet.Cells["A19:F19"])
                    {
                        range.Worksheet.Cells["A19:F19"].Merge = true;
                        range.Worksheet.Cells["A19:F19"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["A19:F19"].RichText.Add("(19)Thời điểm đủ 05 năm liên tục từ ngày: ");
                        var value = range.Worksheet.Cells["A19:F19"].RichText.Add(yeuCauTiepNhan.BHYTNgayDu5Nam?.ApplyFormatDate());
                        value.Bold = true;


                        range.Worksheet.Cells["A19:F19"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A19:F19"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A19:F19"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A19:F19"].Style.Font.Color.SetColor(Color.Black);
                    }

                    using (var range = worksheet.Cells["G19:N19"])
                    {
                        range.Worksheet.Cells["G19:N19"].Merge = true;
                        range.Worksheet.Cells["G19:N19"].Style.WrapText = true;
                        var title = range.Worksheet.Cells["G19:N19"].RichText.Add("(20)Miễn cùng chi trả trong năm từ ngày: ");
                        var value = range.Worksheet.Cells["G19:N19"].RichText.Add(yeuCauTiepNhan.BHYTNgayDuocMienCungChiTra?.ApplyFormatDate());
                        value.Bold = true;

                        range.Worksheet.Cells["G19:N19"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["G19:N19"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["G19:N19"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["G19:N19"].Style.Font.Color.SetColor(Color.Black);
                    }

                    //================================= 20 =================================

                    using (var range = worksheet.Cells["A20:N20"])
                    {
                        range.Worksheet.Cells["A20:N20"].Merge = true;
                        range.Worksheet.Cells["A20:N20"].Value = "II. Phần Chi phí khám bệnh, chữa bệnh";
                        range.Worksheet.Cells["A20:N20"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        range.Worksheet.Cells["A20:N20"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                        range.Worksheet.Cells["A20:N20"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                        range.Worksheet.Cells["A20:N20"].Style.Font.Color.SetColor(Color.Black);
                        range.Worksheet.Cells["A20:N20"].Style.Font.Bold = true;
                    }

                    int index = 21;


                    var groupChiPhiTheoThe = danhSachChiPhi.GroupBy(o => o.MaSoTheBHYT);
                    if (groupChiPhiTheoThe.Count() > 2 ||
                        (groupChiPhiTheoThe.All(o => o.Key != string.Empty) && groupChiPhiTheoThe.Count() > 1))
                    {
                        var groupNgayPhatSinhTheoThe = groupChiPhiTheoThe.Where(o => o.Key != string.Empty).Select(o => new { o.Key, o.OrderBy(j => j.NgayPhatSinh).First().NgayPhatSinh }).OrderBy(o => o.NgayPhatSinh).ToArray();
                        for (int i = 0; i < groupNgayPhatSinhTheoThe.Count(); i++)
                        {
                            var ngayPhatSinhTheoThe = groupNgayPhatSinhTheoThe[i];
                            var theBHYTChiTra = yeuCauTiepNhan.YeuCauTiepNhanTheBHYTs.First(o => o.MaSoThe == ngayPhatSinhTheoThe.Key);
                            var chiPhis = groupChiPhiTheoThe.FirstOrDefault(o => o.Key == ngayPhatSinhTheoThe.Key).ToList();
                            DateTime? ngayPhatSinhTiepTheo = i < groupNgayPhatSinhTheoThe.Count() - 1
                                ? groupNgayPhatSinhTheoThe[i + 1].NgayPhatSinh
                                : null;
                            chiPhis.AddRange(groupChiPhiTheoThe.FirstOrDefault(o => o.Key == string.Empty).Where(j => (i == 0 || j.NgayPhatSinh >= ngayPhatSinhTheoThe.NgayPhatSinh) && (ngayPhatSinhTiepTheo != null && j.NgayPhatSinh < ngayPhatSinhTiepTheo)).ToList());
                            var mucHuongPT = theBHYTChiTra != null && theBHYTChiTra.MucHuong > 0 ? theBHYTChiTra?.MucHuong + "%" : string.Empty;

                            using (var range = worksheet.Cells["A" + index + ":C" + index])
                            {
                                range.Worksheet.Cells["A" + index + ":C" + index].Merge = true;
                                range.Worksheet.Cells["A" + index + ":C" + index].Style.WrapText = true;
                                var title = range.Worksheet.Cells["A" + index + ":C" + index].RichText.Add("Mã thẻ BHYT: ");
                                var value = range.Worksheet.Cells["A" + index + ":C" + index].RichText.Add(theBHYTChiTra.MaSoThe);
                                value.Bold = true;

                                range.Worksheet.Cells["A" + index + ":C" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                range.Worksheet.Cells["A" + index + ":C" + index].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                                range.Worksheet.Cells["A" + index + ":C" + index].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                                range.Worksheet.Cells["A" + index + ":C" + index].Style.Font.Color.SetColor(Color.Black);
                            }

                            using (var range = worksheet.Cells["D" + index + ":F" + index])
                            {
                                range.Worksheet.Cells["D" + index + ":F" + index].Merge = true;
                                range.Worksheet.Cells["D" + index + ":F" + index].Style.WrapText = true;
                                var title = range.Worksheet.Cells["D" + index + ":F" + index].RichText.Add("Giá trị từ: ");
                                var valuebHYTTuNgay = range.Worksheet.Cells["D" + index + ":F" + index].RichText.Add(theBHYTChiTra.NgayHieuLuc.ApplyFormatDate());
                                valuebHYTTuNgay.Bold = true;

                                var den = range.Worksheet.Cells["D" + index + ":F" + index].RichText.Add(" đến: ");
                                den.Bold = false;
                                var valuebHYTDenNgay = range.Worksheet.Cells["D" + index + ":F" + index].RichText.Add(theBHYTChiTra?.NgayHetHan?.ApplyFormatDate());
                                valuebHYTDenNgay.Bold = true;

                                range.Worksheet.Cells["D" + index + ":F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                range.Worksheet.Cells["D" + index + ":F" + index].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                                range.Worksheet.Cells["D" + index + ":F" + index].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                                range.Worksheet.Cells["D" + index + ":F" + index].Style.Font.Color.SetColor(Color.Black);
                            }

                            using (var range = worksheet.Cells["G" + index + ":J" + index])
                            {
                                range.Worksheet.Cells["G" + index + ":J" + index].Merge = true;
                                range.Worksheet.Cells["G" + index + ":J" + index].Style.WrapText = true;
                                var title = range.Worksheet.Cells["G" + index + ":J" + index].RichText.Add("Mức hưởng: ");
                                var value = range.Worksheet.Cells["G" + index + ":J" + index].RichText.Add(mucHuongPT);
                                value.Bold = true;


                                range.Worksheet.Cells["G" + index + ":J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                range.Worksheet.Cells["G" + index + ":J" + index].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                                range.Worksheet.Cells["G" + index + ":J" + index].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                                range.Worksheet.Cells["G" + index + ":J" + index].Style.Font.Color.SetColor(Color.Black);
                            }

                            index++;

                            var indexTableFirst = index;
                            var indexTableLast = index + 1;

                            using (var range = worksheet.Cells["A" + indexTableFirst + ":N" + indexTableLast])
                            {
                                range.Worksheet.Cells["A" + indexTableFirst + ":N" + indexTableLast].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                                range.Worksheet.Cells["A" + indexTableFirst + ":N" + indexTableLast].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                                range.Worksheet.Cells["A" + indexTableFirst + ":N" + indexTableLast].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                range.Worksheet.Cells["A" + indexTableFirst + ":N" + indexTableLast].Style.Font.Color.SetColor(Color.Black);
                                range.Worksheet.Cells["A" + indexTableFirst + ":N" + indexTableLast].Style.Font.Bold = true;
                                range.Worksheet.Cells["A" + indexTableFirst + ":N" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);

                                range.Worksheet.Cells["A" + indexTableFirst + ":A" + indexTableLast].Merge = true;
                                range.Worksheet.Cells["A" + indexTableFirst + ":A" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["A" + indexTableFirst + ":A" + indexTableLast].Value = "STT";

                                range.Worksheet.Cells["B" + indexTableFirst + ":B" + indexTableLast].Merge = true;
                                range.Worksheet.Cells["B" + indexTableFirst + ":B" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["B" + indexTableFirst + ":B" + indexTableLast].Value = "Nội dung";

                                range.Worksheet.Cells["C" + indexTableFirst + ":C" + indexTableLast].Merge = true;
                                range.Worksheet.Cells["C" + indexTableFirst + ":C" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["C" + indexTableFirst + ":C" + indexTableLast].Value = "Đơn vị tính";

                                range.Worksheet.Cells["D" + indexTableFirst + ":D" + indexTableLast].Merge = true;
                                range.Worksheet.Cells["D" + indexTableFirst + ":D" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["D" + indexTableFirst + ":D" + indexTableLast].Value = "Số lượng";

                                range.Worksheet.Cells["E" + indexTableFirst + ":E" + indexTableLast].Merge = true;
                                range.Worksheet.Cells["E" + indexTableFirst + ":E" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["E" + indexTableFirst + ":E" + indexTableLast].Value = "Đơn giá BV(đồng)";

                                range.Worksheet.Cells["F" + indexTableFirst + ":F" + indexTableLast].Merge = true;
                                range.Worksheet.Cells["F" + indexTableFirst + ":F" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["F" + indexTableFirst + ":F" + indexTableLast].Value = "Đơn giá BH(đồng)";

                                range.Worksheet.Cells["G" + indexTableFirst + ":G" + indexTableLast].Merge = true;
                                range.Worksheet.Cells["G" + indexTableFirst + ":G" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["G" + indexTableFirst + ":G" + indexTableLast].Value = "Tỉ lệ thanh toán theo dịch vụ (%)";

                                range.Worksheet.Cells["H" + indexTableFirst + ":H" + indexTableLast].Merge = true;
                                range.Worksheet.Cells["H" + indexTableFirst + ":H" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["H" + indexTableFirst + ":H" + indexTableLast].Value = "Thành tiền BV (đồng)";

                                range.Worksheet.Cells["I" + indexTableFirst + ":I" + indexTableLast].Merge = true;
                                range.Worksheet.Cells["I" + indexTableFirst + ":I" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["I" + indexTableFirst + ":I" + indexTableLast].Value = "Tỷ lệ thanh toán BHYT (%)";

                                range.Worksheet.Cells["J" + indexTableFirst + ":J" + indexTableLast].Merge = true;
                                range.Worksheet.Cells["J" + indexTableFirst + ":J" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["J" + indexTableFirst + ":J" + indexTableLast].Value = "Thành tiền BH(đồng)";

                                range.Worksheet.Cells["K" + indexTableFirst + ":N" + indexTableFirst].Merge = true;
                                range.Worksheet.Cells["K" + indexTableFirst + ":N" + indexTableFirst].Value = "Nguồn thanh toán (đồng)";

                                range.Worksheet.Cells["K" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["K" + indexTableLast].Value = "Quỹ BHYT";

                                range.Worksheet.Cells["L" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["L" + indexTableLast].Value = "Người bệnh cùng chi trả (đồng)";

                                range.Worksheet.Cells["M" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["M" + indexTableLast].Value = "Khác (đồng)";

                                range.Worksheet.Cells["N" + indexTableLast].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                range.Worksheet.Cells["N" + indexTableLast].Value = "Người bệnh tự trả(đồng)";
                            }

                            index = indexTableLast + 1;


                            var dsChiPhiBangKeTheoThe = new List<BangKeKhamBenhBenhVienVo>();

                            foreach (var chiPhi in chiPhis.Where(c => c.NhomChiPhiBangKe != NhomChiPhiBangKe.GoiVatTu && c.YeuCauGoiDichVuId == null).GroupBy(c => new { c.DonGia, c.SoTienMG, KhongTinhPhi = c.KhongTinhPhi.GetValueOrDefault(), c.NhomChiPhiBangKe, c.TenDichVu, c.DonViTinh, c.DuocHuongBHYT, c.DonGiaBHYT, c.MucHuongBaoHiem, c.TiLeBaoHiemThanhToan }).OrderByDescending(o => o.Key.DuocHuongBHYT))
                            {
                                var chiphiBangKe = new BangKeKhamBenhBenhVienVo
                                {
                                    Nhom = chiPhi.Key.NhomChiPhiBangKe,
                                    Id = chiPhi.FirstOrDefault().Id,
                                    NoiDung = chiPhi.Key.TenDichVu,
                                    DonViTinh = chiPhi.Key.DonViTinh,
                                    SoLuong = (decimal)chiPhi.Sum(c => c.Soluong),
                                    DuocHuongBaoHiem = chiPhi.Key.DuocHuongBHYT,
                                    DonGiaBH = chiPhi.Key.DuocHuongBHYT ? chiPhi.Key.DonGiaBHYT : 0,
                                    MucHuongBaoHiem = chiPhi.Key.MucHuongBaoHiem,
                                    TiLeThanhToanTheoDV = chiPhi.Key.TiLeBaoHiemThanhToan,
                                    BaoHiemChiTra = true,
                                    DonGiaBV = chiPhi.Key.DonGia
                                };
                                if (chiPhi.Key.KhongTinhPhi == true)
                                {
                                    chiphiBangKe.Khac = chiPhi.Key.MucHuongBaoHiem > 0
                                        ? (chiphiBangKe.ThanhTienBV.GetValueOrDefault() - chiphiBangKe.ThanhTienBH.GetValueOrDefault())
                                        : chiphiBangKe.ThanhTienBV.GetValueOrDefault();
                                }
                                else
                                {
                                    chiphiBangKe.Khac = chiPhi.Sum(c => c.SoTienMG);
                                }
                                dsChiPhiBangKeTheoThe.Add(chiphiBangKe);
                            }

                            foreach (var chiPhi in chiPhis.Where(c => !(c.NhomChiPhiBangKe != NhomChiPhiBangKe.GoiVatTu && c.YeuCauGoiDichVuId == null)))
                            {
                                var chiphiBangKe = new BangKeKhamBenhBenhVienVo
                                {
                                    Nhom = chiPhi.NhomChiPhiBangKe,
                                    Id = chiPhi.Id,
                                    NoiDung = chiPhi.TenDichVu,
                                    DonViTinh = chiPhi.DonViTinh,
                                    SoLuong = (decimal)chiPhi.Soluong,
                                    DuocHuongBaoHiem = chiPhi.DuocHuongBHYT,
                                    DonGiaBH = chiPhi.DuocHuongBHYT ? chiPhi.DonGiaBHYT : 0,
                                    MucHuongBaoHiem = chiPhi.MucHuongBaoHiem,
                                    TiLeThanhToanTheoDV = chiPhi.TiLeBaoHiemThanhToan,
                                    BaoHiemChiTra = true,
                                    DonGiaBV = chiPhi.DonGia
                                };
                                if (chiPhi.KhongTinhPhi == true || chiPhi.YeuCauGoiDichVuId != null)
                                {
                                    chiphiBangKe.Khac = chiPhi.MucHuongBaoHiem > 0
                                        ? (chiphiBangKe.ThanhTienBV.GetValueOrDefault() - chiphiBangKe.ThanhTienBH.GetValueOrDefault())
                                        : chiphiBangKe.ThanhTienBV.GetValueOrDefault();
                                }
                                else
                                {
                                    chiphiBangKe.Khac = chiPhi.SoTienMG;
                                }
                                dsChiPhiBangKeTheoThe.Add(chiphiBangKe);
                            }
                            dsChiPhiBangKe.AddRange(dsChiPhiBangKeTheoThe);
                            var groupChiPhiBangKes = dsChiPhiBangKeTheoThe.GroupBy(x => x.Nhom).OrderBy(o => (int)o.Key * (o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay || o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriNoiTru ? 1 : 10));
                            if (!groupChiPhiBangKes.Any())
                            {
                                return null;
                            }
                            foreach (var groupChiPhiBangKe in groupChiPhiBangKes)
                            {
                                if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay)
                                {

                                    worksheet.Cells["A" + index + ":N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["A" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                    worksheet.Cells["A" + index + ":N" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                    worksheet.Cells["A" + index + ":N" + index].Merge = true;
                                    worksheet.Cells["A" + index + ":N" + index].Value = "2. Ngày giường:";
                                    worksheet.Cells["A" + index + ":N" + index].Style.Font.Bold = true;

                                    index++;

                                    worksheet.Cells["A" + index + ":G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["A" + index + ":G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                    worksheet.Cells["A" + index + ":G" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                    worksheet.Cells["A" + index + ":G" + index].Merge = true;
                                    worksheet.Cells["A" + index + ":G" + index].Value = "2.1." + groupChiPhiBangKe.Key.GetDescription();
                                    worksheet.Cells["A" + index + ":G" + index].Style.Font.Bold = true;

                                    worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["H" + index].Style.Font.Bold = true;
                                    worksheet.Cells["H" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBV);

                                    worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["J" + index].Style.Font.Bold = true;
                                    worksheet.Cells["J" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBH);

                                    worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["K" + index].Style.Font.Bold = true;
                                    worksheet.Cells["K" + index].Value = groupChiPhiBangKe.Sum(o => o.QuyBHYT);

                                    worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["L" + index].Style.Font.Bold = true;
                                    worksheet.Cells["L" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra);

                                    worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["M" + index].Style.Font.Bold = true;
                                    worksheet.Cells["M" + index].Value = groupChiPhiBangKe.Sum(o => o.Khac);

                                    worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["N" + index].Style.Font.Bold = true;
                                    worksheet.Cells["N" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra);

                                    index++;
                                }
                                else if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.NgayGiuongDieuTriNoiTru)
                                {
                                    if (!groupChiPhiBangKes.Any(o => o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay))
                                    {
                                        worksheet.Cells["A" + index + ":N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["A" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                        worksheet.Cells["A" + index + ":N" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                        worksheet.Cells["A" + index + ":N" + index].Merge = true;
                                        worksheet.Cells["A" + index + ":N" + index].Value = "2. Ngày giường:";
                                        worksheet.Cells["A" + index + ":N" + index].Style.Font.Bold = true;

                                    }
                                    index++;

                                    worksheet.Cells["A" + index + ":G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["A" + index + ":G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                    worksheet.Cells["A" + index + ":G" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                    worksheet.Cells["A" + index + ":G" + index].Merge = true;
                                    worksheet.Cells["A" + index + ":G" + index].Value = "2.2." + groupChiPhiBangKe.Key.GetDescription();
                                    worksheet.Cells["A" + index + ":G" + index].Style.Font.Bold = true;

                                    worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["H" + index].Style.Font.Bold = true;
                                    worksheet.Cells["H" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBV);

                                    worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["J" + index].Style.Font.Bold = true;
                                    worksheet.Cells["J" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBH);

                                    worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["K" + index].Style.Font.Bold = true;
                                    worksheet.Cells["K" + index].Value = groupChiPhiBangKe.Sum(o => o.QuyBHYT);

                                    worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["L" + index].Style.Font.Bold = true;
                                    worksheet.Cells["L" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra);

                                    worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["M" + index].Style.Font.Bold = true;
                                    worksheet.Cells["M" + index].Value = groupChiPhiBangKe.Sum(o => o.Khac);

                                    worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["N" + index].Style.Font.Bold = true;
                                    worksheet.Cells["N" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra);

                                    index++;
                                }
                                else
                                {
                                    worksheet.Cells["A" + index + ":G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["A" + index + ":G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                    worksheet.Cells["A" + index + ":G" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                    worksheet.Cells["A" + index + ":G" + index].Merge = true;
                                    worksheet.Cells["A" + index + ":G" + index].Value = (int)groupChiPhiBangKe.Key + "." + groupChiPhiBangKe.Key.GetDescription();
                                    worksheet.Cells["A" + index + ":G" + index].Style.Font.Bold = true;

                                    worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["H" + index].Style.Font.Bold = true;
                                    worksheet.Cells["H" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBV);

                                    worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["J" + index].Style.Font.Bold = true;
                                    worksheet.Cells["J" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBH);

                                    worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["K" + index].Style.Font.Bold = true;
                                    worksheet.Cells["K" + index].Value = groupChiPhiBangKe.Sum(o => o.QuyBHYT);

                                    worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["L" + index].Style.Font.Bold = true;
                                    worksheet.Cells["L" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra);

                                    worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["M" + index].Style.Font.Bold = true;
                                    worksheet.Cells["M" + index].Value = groupChiPhiBangKe.Sum(o => o.Khac);

                                    worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["N" + index].Style.Font.Bold = true;
                                    worksheet.Cells["N" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra);

                                    index++;
                                }
                                if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.GoiVatTu)
                                {
                                    var groupGoiVatTus = groupChiPhiBangKe.ToList().GroupBy(o => o.SoGoiVatTu.GetValueOrDefault()).OrderBy(o => o.Key);
                                    int sttGoiVatTu = 1;
                                    foreach (var groupGoiVatTu in groupGoiVatTus)
                                    {
                                        worksheet.Cells["A" + index + ":G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["A" + index + ":G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                        worksheet.Cells["A" + index + ":G" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                        worksheet.Cells["A" + index + ":G" + index].Value = "10." + sttGoiVatTu + ". " + groupChiPhiBangKe.Key.GetDescription() + " " + sttGoiVatTu;
                                        worksheet.Cells["A" + index + ":G" + index].Style.Font.Bold = true;
                                        worksheet.Cells["A" + index + ":G" + index].Merge = true;

                                        worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["H" + index].Style.Font.Bold = true;
                                        worksheet.Cells["H" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBV);

                                        worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["J" + index].Style.Font.Bold = true;
                                        worksheet.Cells["J" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBH);

                                        worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["K" + index].Style.Font.Bold = true;
                                        worksheet.Cells["K" + index].Value = groupChiPhiBangKe.Sum(o => o.QuyBHYT);

                                        worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["L" + index].Style.Font.Bold = true;
                                        worksheet.Cells["L" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra);

                                        worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["M" + index].Style.Font.Bold = true;
                                        worksheet.Cells["M" + index].Value = groupChiPhiBangKe.Sum(o => o.Khac);

                                        worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["N" + index].Style.Font.Bold = true;
                                        worksheet.Cells["N" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra);

                                        index++;

                                        foreach (var chiPhiBangKe in groupGoiVatTu)
                                        {
                                            worksheet.Cells["A" + index + ":N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["A" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                            worksheet.Cells["A" + index + ":N" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));

                                            worksheet.Cells["A" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["A" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                            worksheet.Cells["A" + index].Value = indexItem;

                                            worksheet.Cells["B" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["B" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                            worksheet.Cells["B" + index].Value = chiPhiBangKe.NoiDung;

                                            worksheet.Cells["C" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["C" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                            worksheet.Cells["C" + index].Value = chiPhiBangKe.DonViTinh;

                                            worksheet.Cells["D" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["D" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                            worksheet.Cells["D" + index].Value = chiPhiBangKe.SoLuong;

                                            worksheet.Cells["E" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["E" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                            worksheet.Cells["E" + index].Style.Numberformat.Format = "#,##0.00";
                                            worksheet.Cells["E" + index].Value = chiPhiBangKe.DonGiaBV;

                                            worksheet.Cells["F" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["F" + index].Style.Numberformat.Format = "#,##0.00";
                                            worksheet.Cells["F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                            worksheet.Cells["F" + index].Value = chiPhiBangKe.DonGiaBH;

                                            worksheet.Cells["G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                            worksheet.Cells["G" + index].Style.Numberformat.Format = "#,##0.00";
                                            worksheet.Cells["G" + index].Value = chiPhiBangKe.TiLeThanhToanTheoDV;

                                            worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                            worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                            worksheet.Cells["H" + index].Value = chiPhiBangKe.ThanhTienBV;

                                            worksheet.Cells["I" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["I" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                            worksheet.Cells["I" + index].Value = Convert.ToDouble(chiPhiBangKe.MucHuongBaoHiem > 0 ? 100 : 0).ApplyFormatMoneyToDouble();


                                            worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                            worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                            worksheet.Cells["J" + index].Value = chiPhiBangKe.ThanhTienBH;


                                            worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                            worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                            worksheet.Cells["K" + index].Value = chiPhiBangKe.QuyBHYT;


                                            worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                            worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                            worksheet.Cells["L" + index].Value = chiPhiBangKe.NguoiBenhCungChiTra;


                                            worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                            worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                            worksheet.Cells["M" + index].Value = chiPhiBangKe.Khac;


                                            worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                            worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                            worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                            worksheet.Cells["N" + index].Value = chiPhiBangKe.NguoiBenhTuTra;

                                            indexItem++;
                                            index++;
                                        }
                                    }
                                }
                                else
                                {
                                    foreach (var chiPhiBangKe in groupChiPhiBangKe)
                                    {
                                        worksheet.Cells["A" + index + ":N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["A" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                        worksheet.Cells["A" + index + ":N" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));

                                        worksheet.Cells["A" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["A" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                        worksheet.Cells["A" + index].Value = indexItem;

                                        worksheet.Cells["B" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["B" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                        worksheet.Cells["B" + index].Value = chiPhiBangKe.NoiDung;

                                        worksheet.Cells["C" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["C" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                        worksheet.Cells["C" + index].Value = chiPhiBangKe.DonViTinh;

                                        worksheet.Cells["D" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["D" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                        worksheet.Cells["D" + index].Value = chiPhiBangKe.SoLuong;

                                        worksheet.Cells["E" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["E" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["E" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["E" + index].Value = chiPhiBangKe.DonGiaBV;

                                        worksheet.Cells["F" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["F" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["F" + index].Value = chiPhiBangKe.DonGiaBH;

                                        worksheet.Cells["G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["G" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["G" + index].Value = chiPhiBangKe.TiLeThanhToanTheoDV;

                                        worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["H" + index].Value = chiPhiBangKe.ThanhTienBV;

                                        worksheet.Cells["I" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["I" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["I" + index].Value = Convert.ToDouble(chiPhiBangKe.MucHuongBaoHiem > 0 ? 100 : 0).ApplyFormatMoneyToDouble();


                                        worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["J" + index].Value = chiPhiBangKe.ThanhTienBH;


                                        worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["K" + index].Value = chiPhiBangKe.QuyBHYT;


                                        worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["L" + index].Value = chiPhiBangKe.NguoiBenhCungChiTra;


                                        worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["M" + index].Value = chiPhiBangKe.Khac;


                                        worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["N" + index].Value = chiPhiBangKe.NguoiBenhTuTra;

                                        indexItem++;
                                        index++;
                                    }
                                }

                            }

                            worksheet.Cells["A" + index + ":G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["A" + index + ":G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                            worksheet.Cells["A" + index + ":G" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                            worksheet.Cells["A" + index + ":G" + index].Merge = true;
                            worksheet.Cells["A" + index + ":G" + index].Value = "Tổng cộng";
                            worksheet.Cells["A" + index + ":G" + index].Style.Font.Bold = true;

                            worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                            worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                            worksheet.Cells["H" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.ThanhTienBV)).Sum();

                            worksheet.Cells["I" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["I" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;

                            worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                            worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                            worksheet.Cells["J" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.ThanhTienBH)).Sum();

                            worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                            worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                            worksheet.Cells["K" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.QuyBHYT)).Sum();

                            worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                            worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                            worksheet.Cells["L" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.NguoiBenhCungChiTra)).Sum();

                            worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                            worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                            worksheet.Cells["M" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.Khac)).Sum();

                            worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                            worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                            worksheet.Cells["N" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.NguoiBenhTuTra)).Sum();

                            index++;

                            worksheet.Cells["A" + index + ":N" + index].Merge = true;
                            worksheet.Cells["A" + index + ":N" + index].Value = "Tổng chi phí lần khám bệnh/cả đợt điều trị: " + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + " đồng";
                            worksheet.Cells["A" + index + ":N" + index].Style.Font.Bold = true;

                            index++;

                            worksheet.Cells["A" + index + ":N" + index].Merge = true;
                            worksheet.Cells["A" + index + ":N" + index].Value = "(Viết bằng chữ: " + NumberHelper.ChuyenSoRaText(Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBV))) + ")";

                            index++;

                            worksheet.Cells["A" + index + ":N" + index].Merge = true;
                            worksheet.Cells["A" + index + ":N" + index].Value = "Trong đó , số tiền do:";
                            worksheet.Cells["A" + index + ":N" + index].Style.Font.Bold = true;

                            index++;
                            worksheet.Cells["A" + index + ":N" + index].Merge = true;
                            worksheet.Cells["A" + index + ":N" + index].Value = "- Quỹ BHYT thanh toán: " + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble();

                            index++;
                            worksheet.Cells["A" + index + ":N" + index].Merge = true;
                            worksheet.Cells["A" + index + ":N" + index].Value = "- Người bệnh trả trong đó: " + (Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)) + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhTuTra))).ApplyFormatMoneyToDouble();

                            index++;
                            worksheet.Cells["A" + index + ":N" + index].Merge = true;
                            worksheet.Cells["A" + index + ":N" + index].Value = "+ Cùng chi trả trong phạm vi BHYT: " + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble(true);

                            index++;
                            worksheet.Cells["A" + index + ":N" + index].Merge = true;
                            worksheet.Cells["A" + index + ":N" + index].Value = "+ Các khoản phải trả khác: " + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true);

                            index++;
                            worksheet.Cells["A" + index + ":N" + index].Merge = true;
                            worksheet.Cells["A" + index + ":N" + index].Value = "+ Nguồn khác: " + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble(true);


                            index = index + 2;

                            worksheet.Cells["D" + index + ":F" + index].Style.Font.SetFromFont(new Font("Times New Roman", 12));
                            worksheet.Cells["D" + index + ":F" + index].Merge = true;
                            worksheet.Cells["D" + index + ":F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                            worksheet.Cells["D" + index + ":F" + index].Style.VerticalAlignment = ExcelVerticalAlignment.Top;
                            worksheet.Cells["D" + index + ":F" + index].Value = $"Ngày {DateTime.Now.Day} tháng {DateTime.Now.Month} năm {DateTime.Now.Year}";

                            worksheet.Cells["G" + index + ":I" + index].Style.Font.SetFromFont(new Font("Times New Roman", 12));
                            worksheet.Cells["G" + index + ":I" + index].Merge = true;
                            worksheet.Cells["G" + index + ":I" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                            worksheet.Cells["G" + index + ":I" + index].Style.VerticalAlignment = ExcelVerticalAlignment.Top;
                            worksheet.Cells["G" + index + ":I" + index].Value = $"Ngày {DateTime.Now.Day} tháng {DateTime.Now.Month} năm {DateTime.Now.Year}";

                            worksheet.Cells["J" + index + ":N" + index].Style.Font.Bold = true;
                            worksheet.Cells["J" + index + ":N" + index].Merge = true;
                            worksheet.Cells["J" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                            worksheet.Cells["J" + index + ":N" + index].Value = "XÁC NHẬN CỦA NGƯỜI BỆNH ";

                            index++;

                            worksheet.Cells["A" + index + ":C" + index].Style.Font.Bold = true;
                            worksheet.Cells["A" + index + ":C" + index].Merge = true;
                            worksheet.Cells["A" + index + ":C" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                            worksheet.Cells["A" + index + ":C" + index].Value = "NGƯỜI LẬP BẢNG KÊ";

                            worksheet.Cells["D" + index + ":F" + index].Style.Font.Bold = true;
                            worksheet.Cells["D" + index + ":F" + index].Merge = true;
                            worksheet.Cells["D" + index + ":F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                            worksheet.Cells["D" + index + ":F" + index].Value = "KẾ TOÁN VIỆN PHÍ";

                            worksheet.Cells["G" + index + ":I" + index].Style.Font.Bold = true;
                            worksheet.Cells["G" + index + ":I" + index].Merge = true;
                            worksheet.Cells["G" + index + ":I" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                            worksheet.Cells["G" + index + ":I" + index].Value = "GIÁM ĐỊNH BHYT";

                            worksheet.Cells["J" + index + ":N" + index].Style.Font.Bold = true;
                            worksheet.Cells["J" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                            worksheet.Cells["J" + index + ":N" + index].Merge = true;
                            worksheet.Cells["J" + index + ":N" + index].Value = "(Ký , Ghi rõ họ tên)";

                            index++;

                            worksheet.Cells["A" + index + ":C" + index].Style.Font.Bold = true;
                            worksheet.Cells["A" + index + ":C" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                            worksheet.Cells["A" + index + ":C" + index].Merge = true;
                            worksheet.Cells["A" + index + ":C" + index].Value = "(Ký , Ghi rõ họ tên)";


                            worksheet.Cells["D" + index + ":F" + index].Style.Font.Bold = true;
                            worksheet.Cells["D" + index + ":F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                            worksheet.Cells["D" + index + ":F" + index].Merge = true;
                            worksheet.Cells["D" + index + ":F" + index].Value = "(Ký , Ghi rõ họ tên)";

                            worksheet.Cells["G" + index + ":I" + index].Style.Font.Bold = true;
                            worksheet.Cells["G" + index + ":I" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                            worksheet.Cells["G" + index + ":I" + index].Merge = true;
                            worksheet.Cells["G" + index + ":I" + index].Value = "(Ký , Ghi rõ họ tên)";

                            worksheet.Cells["J" + index + ":N" + index].Style.Font.Bold = true;
                            worksheet.Cells["J" + index + ":N" + index].Merge = true;
                            worksheet.Cells["J" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                            worksheet.Cells["J" + index + ":N" + index].Value = "(Tôi đã nhận...phim...Xquang / CT / MRI)";

                            xlPackage.Save();
                        }
                    }
                    else
                    {
                        YeuCauTiepNhanTheBHYT theBHYTChiTra = null;
                        var maSoThe = groupChiPhiTheoThe.Where(o => o.Key != string.Empty).FirstOrDefault()?.Key;
                        if (!string.IsNullOrEmpty(maSoThe))
                        {
                            theBHYTChiTra = yeuCauTiepNhan.YeuCauTiepNhanTheBHYTs.First(o => o.MaSoThe == maSoThe);
                        }

                        var chiPhis = groupChiPhiTheoThe.SelectMany(o => o).ToList();
                        var mucHuongPT = theBHYTChiTra != null && theBHYTChiTra?.MucHuong > 0 ? theBHYTChiTra?.MucHuong + "%" : string.Empty;


                        using (var range = worksheet.Cells["A21:C21"])
                        {
                            range.Worksheet.Cells["A21:C21"].Merge = true;
                            range.Worksheet.Cells["A21:C21"].Style.WrapText = true;
                            var title = range.Worksheet.Cells["A21:C21"].RichText.Add("Mã thẻ BHYT: ");
                            var value = range.Worksheet.Cells["A21:C21"].RichText.Add(maBHYT);
                            value.Bold = true;

                            range.Worksheet.Cells["A21:C21"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                            range.Worksheet.Cells["A21:C21"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                            range.Worksheet.Cells["A21:C21"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                            range.Worksheet.Cells["A21:C21"].Style.Font.Color.SetColor(Color.Black);
                        }
                        using (var range = worksheet.Cells["A21:N21"])
                        {
                            range.Worksheet.Cells["D" + index + ":F" + index].Merge = true;
                            range.Worksheet.Cells["D" + index + ":F" + index].Style.WrapText = true;
                            var title = range.Worksheet.Cells["D" + index + ":F" + index].RichText.Add("Giá trị từ: ");
                            var valuebHYTTuNgay = range.Worksheet.Cells["D" + index + ":F" + index].RichText.Add(bHYTTuNgay);
                            valuebHYTTuNgay.Bold = true;

                            var den = range.Worksheet.Cells["D" + index + ":F" + index].RichText.Add(" đến: ");
                            den.Bold = false;
                            var valuebHYTDenNgay = range.Worksheet.Cells["D" + index + ":F" + index].RichText.Add(bHYTDenNgay);
                            valuebHYTDenNgay.Bold = true;

                            range.Worksheet.Cells["D" + index + ":F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                            range.Worksheet.Cells["D" + index + ":F" + index].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                            range.Worksheet.Cells["D" + index + ":F" + index].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                            range.Worksheet.Cells["D" + index + ":F" + index].Style.Font.Color.SetColor(Color.Black);
                        }
                        using (var range = worksheet.Cells["G21:J21"])
                        {
                            range.Worksheet.Cells["G21:J21"].Merge = true;
                            range.Worksheet.Cells["G21:J21"].Style.WrapText = true;
                            var title = range.Worksheet.Cells["G21:J21"].RichText.Add("Mức hưởng: ");
                            var value = range.Worksheet.Cells["G21:J21"].RichText.Add(mucHuong);
                            value.Bold = true;


                            range.Worksheet.Cells["G21:J21"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                            range.Worksheet.Cells["G21:J21"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                            range.Worksheet.Cells["G21:J21"].Style.Font.SetFromFont(new Font("Times New Roman", 11));
                            range.Worksheet.Cells["G21:J21"].Style.Font.Color.SetColor(Color.Black);
                        }
                        using (var range = worksheet.Cells["A22:N23"])
                        {
                            range.Worksheet.Cells["A22:N23"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                            range.Worksheet.Cells["A22:N23"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                            range.Worksheet.Cells["A22:N23"].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                            range.Worksheet.Cells["A22:N23"].Style.Font.Color.SetColor(Color.Black);
                            range.Worksheet.Cells["A22:N23"].Style.Font.Bold = true;
                            range.Worksheet.Cells["A22:N23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);

                            range.Worksheet.Cells["A22:A23"].Merge = true;
                            range.Worksheet.Cells["A22:A23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["A22:A23"].Value = "STT";

                            range.Worksheet.Cells["B22:B23"].Merge = true;
                            range.Worksheet.Cells["B22:B23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["B22:B23"].Value = "Nội dung";

                            range.Worksheet.Cells["C22:C23"].Merge = true;
                            range.Worksheet.Cells["C22:C23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["C22:C23"].Value = "Đơn vị tính";

                            range.Worksheet.Cells["D22:D23"].Merge = true;
                            range.Worksheet.Cells["D22:D23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["D22:D23"].Value = "Số lượng";

                            range.Worksheet.Cells["E22:E23"].Merge = true;
                            range.Worksheet.Cells["E22:E23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["E22:E23"].Value = "Đơn giá BV(đồng)";

                            range.Worksheet.Cells["F22:F23"].Merge = true;
                            range.Worksheet.Cells["F22:F23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["F22:F23"].Value = "Đơn giá BH(đồng)";

                            range.Worksheet.Cells["G22:G23"].Merge = true;
                            range.Worksheet.Cells["G22:G23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["G22:G23"].Value = "Tỉ lệ thanh toán theo dịch vụ (%)";

                            range.Worksheet.Cells["H22:H23"].Merge = true;
                            range.Worksheet.Cells["H22:H23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["H22:H23"].Value = "Thành tiền BV (đồng)";

                            range.Worksheet.Cells["I22:I23"].Merge = true;
                            range.Worksheet.Cells["I22:I23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["I22:I23"].Value = "Tỷ lệ thanh toán BHYT (%)";

                            range.Worksheet.Cells["J22:J23"].Merge = true;
                            range.Worksheet.Cells["J22:J23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["J22:J23"].Value = "Thành tiền BH(đồng)";

                            range.Worksheet.Cells["K22:N22"].Merge = true;
                            range.Worksheet.Cells["K22:N22"].Value = "Nguồn thanh toán (đồng)";

                            range.Worksheet.Cells["K23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["K23"].Value = "Quỹ BHYT";

                            range.Worksheet.Cells["L23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["L23"].Value = "Người bệnh cùng chi trả (đồng)";

                            range.Worksheet.Cells["M23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["M23"].Value = "Khác (đồng)";

                            range.Worksheet.Cells["N23"].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                            range.Worksheet.Cells["N23"].Value = "Người bệnh tự trả(đồng)";
                        }


                        index = index + 3;

                        foreach (var chiPhi in chiPhis.Where(c => c.NhomChiPhiBangKe != NhomChiPhiBangKe.GoiVatTu && c.YeuCauGoiDichVuId == null).GroupBy(c => new { c.DonGia, c.SoTienMG, KhongTinhPhi = c.KhongTinhPhi.GetValueOrDefault(), c.NhomChiPhiBangKe, c.TenDichVu, c.DonViTinh, c.DuocHuongBHYT, c.DonGiaBHYT, c.MucHuongBaoHiem, c.TiLeBaoHiemThanhToan }).OrderByDescending(o => o.Key.DuocHuongBHYT))
                        {
                            var chiphiBangKe = new BangKeKhamBenhBenhVienVo
                            {
                                Nhom = chiPhi.Key.NhomChiPhiBangKe,
                                Id = chiPhi.FirstOrDefault().Id,
                                NoiDung = chiPhi.Key.TenDichVu,
                                DonViTinh = chiPhi.Key.DonViTinh,
                                SoLuong = (decimal)chiPhi.Sum(c => c.Soluong),
                                DuocHuongBaoHiem = chiPhi.Key.DuocHuongBHYT,
                                DonGiaBH = chiPhi.Key.DuocHuongBHYT ? chiPhi.Key.DonGiaBHYT : 0,
                                MucHuongBaoHiem = chiPhi.Key.MucHuongBaoHiem,
                                TiLeThanhToanTheoDV = chiPhi.Key.TiLeBaoHiemThanhToan,
                                BaoHiemChiTra = true,
                                DonGiaBV = chiPhi.Key.DonGia
                            };
                            if (chiPhi.Key.KhongTinhPhi == true)
                            {
                                chiphiBangKe.Khac = chiPhi.Key.MucHuongBaoHiem > 0
                                    ? (chiphiBangKe.ThanhTienBV.GetValueOrDefault() - chiphiBangKe.ThanhTienBH.GetValueOrDefault())
                                    : chiphiBangKe.ThanhTienBV.GetValueOrDefault();
                            }
                            else
                            {
                                chiphiBangKe.Khac = chiPhi.Sum(c => c.SoTienMG);
                            }
                            dsChiPhiBangKe.Add(chiphiBangKe);
                        }
                        foreach (var chiPhi in chiPhis.Where(c => !(c.NhomChiPhiBangKe != NhomChiPhiBangKe.GoiVatTu && c.YeuCauGoiDichVuId == null)))
                        {
                            var chiphiBangKe = new BangKeKhamBenhBenhVienVo
                            {
                                Nhom = chiPhi.NhomChiPhiBangKe,
                                Id = chiPhi.Id,
                                NoiDung = chiPhi.TenDichVu,
                                DonViTinh = chiPhi.DonViTinh,
                                SoLuong = (decimal)chiPhi.Soluong,
                                DuocHuongBaoHiem = chiPhi.DuocHuongBHYT,
                                DonGiaBH = chiPhi.DuocHuongBHYT ? chiPhi.DonGiaBHYT : 0,
                                MucHuongBaoHiem = chiPhi.MucHuongBaoHiem,
                                TiLeThanhToanTheoDV = chiPhi.TiLeBaoHiemThanhToan,
                                BaoHiemChiTra = true,
                                DonGiaBV = chiPhi.DonGia
                            };
                            if (chiPhi.KhongTinhPhi == true || chiPhi.YeuCauGoiDichVuId != null)
                            {
                                chiphiBangKe.Khac = chiPhi.MucHuongBaoHiem > 0
                                    ? (chiphiBangKe.ThanhTienBV.GetValueOrDefault() - chiphiBangKe.ThanhTienBH.GetValueOrDefault())
                                    : chiphiBangKe.ThanhTienBV.GetValueOrDefault();
                            }
                            else
                            {
                                chiphiBangKe.Khac = chiPhi.SoTienMG;
                            }
                            dsChiPhiBangKe.Add(chiphiBangKe);
                        }

                        var groupChiPhiBangKes = dsChiPhiBangKe.GroupBy(x => x.Nhom).OrderBy(o => (int)o.Key * (o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay || o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriNoiTru ? 1 : 10));
                        if (!groupChiPhiBangKes.Any())
                        {
                            return null;
                        }

                        foreach (var groupChiPhiBangKe in groupChiPhiBangKes)
                        {
                            if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay)
                            {

                                worksheet.Cells["A" + index + ":N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["A" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                worksheet.Cells["A" + index + ":N" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                worksheet.Cells["A" + index + ":N" + index].Merge = true;
                                worksheet.Cells["A" + index + ":N" + index].Value = "2. Ngày giường:";
                                worksheet.Cells["A" + index + ":N" + index].Style.Font.Bold = true;

                                index++;

                                worksheet.Cells["A" + index + ":G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["A" + index + ":G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                worksheet.Cells["A" + index + ":G" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                worksheet.Cells["A" + index + ":G" + index].Merge = true;
                                worksheet.Cells["A" + index + ":G" + index].Value = "2.1." + groupChiPhiBangKe.Key.GetDescription();
                                worksheet.Cells["A" + index + ":G" + index].Style.Font.Bold = true;

                                worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["H" + index].Style.Font.Bold = true;
                                worksheet.Cells["H" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBV);

                                worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["J" + index].Style.Font.Bold = true;
                                worksheet.Cells["J" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBH);

                                worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["K" + index].Style.Font.Bold = true;
                                worksheet.Cells["K" + index].Value = groupChiPhiBangKe.Sum(o => o.QuyBHYT);

                                worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["L" + index].Style.Font.Bold = true;
                                worksheet.Cells["L" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra);

                                worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["M" + index].Style.Font.Bold = true;
                                worksheet.Cells["M" + index].Value = groupChiPhiBangKe.Sum(o => o.Khac);

                                worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["N" + index].Style.Font.Bold = true;
                                worksheet.Cells["N" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra);

                                index++;
                            }
                            else if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.NgayGiuongDieuTriNoiTru)
                            {
                                if (!groupChiPhiBangKes.Any(o => o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay))
                                {
                                    worksheet.Cells["A" + index + ":N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["A" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                    worksheet.Cells["A" + index + ":N" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                    worksheet.Cells["A" + index + ":H" + index].Merge = true;
                                    worksheet.Cells["A" + index + ":N" + index].Value = "2. Ngày giường:";
                                    worksheet.Cells["A" + index + ":N" + index].Style.Font.Bold = true;

                                }

                                index++;
                                worksheet.Cells["A" + index + ":G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["A" + index + ":G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                worksheet.Cells["A" + index + ":G" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                worksheet.Cells["A" + index + ":G" + index].Merge = true;
                                worksheet.Cells["A" + index + ":G" + index].Value = "2.2." + groupChiPhiBangKe.Key.GetDescription();
                                worksheet.Cells["A" + index + ":G" + index].Style.Font.Bold = true;

                                worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["H" + index].Style.Font.Bold = true;
                                worksheet.Cells["H" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBV);

                                worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["J" + index].Style.Font.Bold = true;
                                worksheet.Cells["J" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBH);

                                worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["K" + index].Style.Font.Bold = true;
                                worksheet.Cells["K" + index].Value = groupChiPhiBangKe.Sum(o => o.QuyBHYT);

                                worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["L" + index].Style.Font.Bold = true;
                                worksheet.Cells["L" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra);

                                worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["M" + index].Style.Font.Bold = true;
                                worksheet.Cells["M" + index].Value = groupChiPhiBangKe.Sum(o => o.Khac);

                                worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["N" + index].Style.Font.Bold = true;
                                worksheet.Cells["N" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra);

                                index++;
                            }
                            else
                            {
                                worksheet.Cells["A" + index + ":G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["A" + index + ":G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                worksheet.Cells["A" + index + ":G" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                worksheet.Cells["A" + index + ":G" + index].Merge = true;
                                worksheet.Cells["A" + index + ":G" + index].Value = (int)groupChiPhiBangKe.Key + "." + groupChiPhiBangKe.Key.GetDescription();
                                worksheet.Cells["A" + index + ":G" + index].Style.Font.Bold = true;

                                worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["H" + index].Style.Font.Bold = true;
                                worksheet.Cells["H" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBV);

                                worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["J" + index].Style.Font.Bold = true;
                                worksheet.Cells["J" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBH);

                                worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["K" + index].Style.Font.Bold = true;
                                worksheet.Cells["K" + index].Value = groupChiPhiBangKe.Sum(o => o.QuyBHYT);

                                worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["L" + index].Style.Font.Bold = true;
                                worksheet.Cells["L" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra);

                                worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["M" + index].Style.Font.Bold = true;
                                worksheet.Cells["M" + index].Value = groupChiPhiBangKe.Sum(o => o.Khac);

                                worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                worksheet.Cells["N" + index].Style.Font.Bold = true;
                                worksheet.Cells["N" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra);

                                index++;
                            }
                            if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.GoiVatTu)
                            {
                                var groupGoiVatTus = groupChiPhiBangKe.ToList().GroupBy(o => o.SoGoiVatTu.GetValueOrDefault()).OrderBy(o => o.Key);
                                int sttGoiVatTu = 1;
                                foreach (var groupGoiVatTu in groupGoiVatTus)
                                {
                                    worksheet.Cells["A" + index + ":G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["A" + index + ":G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                    worksheet.Cells["A" + index + ":G" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                                    worksheet.Cells["A" + index + ":G" + index].Value = "10." + sttGoiVatTu + ". " + groupChiPhiBangKe.Key.GetDescription() + " " + sttGoiVatTu;
                                    worksheet.Cells["A" + index + ":G" + index].Style.Font.Bold = true;
                                    worksheet.Cells["A" + index + ":G" + index].Merge = true;

                                    worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["H" + index].Style.Font.Bold = true;
                                    worksheet.Cells["H" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBV);

                                    worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["J" + index].Style.Font.Bold = true;
                                    worksheet.Cells["J" + index].Value = groupChiPhiBangKe.Sum(o => o.ThanhTienBH);

                                    worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["K" + index].Style.Font.Bold = true;
                                    worksheet.Cells["K" + index].Value = groupChiPhiBangKe.Sum(o => o.QuyBHYT);

                                    worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["L" + index].Style.Font.Bold = true;
                                    worksheet.Cells["L" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra);

                                    worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["M" + index].Style.Font.Bold = true;
                                    worksheet.Cells["M" + index].Value = groupChiPhiBangKe.Sum(o => o.Khac);

                                    worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["N" + index].Style.Font.Bold = true;
                                    worksheet.Cells["N" + index].Value = groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra);

                                    index++;

                                    foreach (var chiPhiBangKe in groupGoiVatTu)
                                    {
                                        worksheet.Cells["A" + index + ":N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["A" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                        worksheet.Cells["A" + index + ":N" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));

                                        worksheet.Cells["A" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["A" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                        worksheet.Cells["A" + index].Value = indexItem;

                                        worksheet.Cells["B" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["B" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                        worksheet.Cells["B" + index].Value = chiPhiBangKe.NoiDung;

                                        worksheet.Cells["C" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["C" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                        worksheet.Cells["C" + index].Value = chiPhiBangKe.DonViTinh;

                                        worksheet.Cells["D" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["D" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                        worksheet.Cells["D" + index].Value = chiPhiBangKe.SoLuong;

                                        worksheet.Cells["E" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["E" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["E" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["E" + index].Value = chiPhiBangKe.DonGiaBV;

                                        worksheet.Cells["F" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["F" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["F" + index].Value = chiPhiBangKe.DonGiaBH;

                                        worksheet.Cells["G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["G" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["G" + index].Value = chiPhiBangKe.TiLeThanhToanTheoDV;

                                        worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["H" + index].Value = chiPhiBangKe.ThanhTienBV;

                                        worksheet.Cells["I" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["I" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["I" + index].Value = Convert.ToDouble(chiPhiBangKe.MucHuongBaoHiem > 0 ? 100 : 0).ApplyFormatMoneyToDouble();


                                        worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["J" + index].Value = chiPhiBangKe.ThanhTienBH;


                                        worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["K" + index].Value = chiPhiBangKe.QuyBHYT;


                                        worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["L" + index].Value = chiPhiBangKe.NguoiBenhCungChiTra;


                                        worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["M" + index].Value = chiPhiBangKe.Khac;


                                        worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                        worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                        worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                        worksheet.Cells["N" + index].Value = chiPhiBangKe.NguoiBenhTuTra;

                                        indexItem++;
                                        index++;
                                    }
                                }
                            }
                            else
                            {
                                foreach (var chiPhiBangKe in groupChiPhiBangKe)
                                {
                                    worksheet.Cells["A" + index + ":N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["A" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                    worksheet.Cells["A" + index + ":N" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));

                                    worksheet.Cells["A" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["A" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                    worksheet.Cells["A" + index].Value = indexItem;

                                    worksheet.Cells["B" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["B" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                    worksheet.Cells["B" + index].Value = chiPhiBangKe.NoiDung;

                                    worksheet.Cells["C" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["C" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                    worksheet.Cells["C" + index].Value = chiPhiBangKe.DonViTinh;

                                    worksheet.Cells["D" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["D" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                                    worksheet.Cells["D" + index].Value = chiPhiBangKe.SoLuong;

                                    worksheet.Cells["E" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["E" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["E" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["E" + index].Value = chiPhiBangKe.DonGiaBV;

                                    worksheet.Cells["F" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["F" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["F" + index].Value = chiPhiBangKe.DonGiaBH;

                                    worksheet.Cells["G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["G" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["G" + index].Value = chiPhiBangKe.TiLeThanhToanTheoDV;

                                    worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["H" + index].Value = chiPhiBangKe.ThanhTienBV;

                                    worksheet.Cells["I" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["I" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["I" + index].Value = Convert.ToDouble(chiPhiBangKe.MucHuongBaoHiem > 0 ? 100 : 0).ApplyFormatMoneyToDouble();


                                    worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["J" + index].Value = chiPhiBangKe.ThanhTienBH;


                                    worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["K" + index].Value = chiPhiBangKe.QuyBHYT;


                                    worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["L" + index].Value = chiPhiBangKe.NguoiBenhCungChiTra;


                                    worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["M" + index].Value = chiPhiBangKe.Khac;


                                    worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                                    worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                                    worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                    worksheet.Cells["N" + index].Value = chiPhiBangKe.NguoiBenhTuTra;

                                    indexItem++;
                                    index++;
                                }
                            }

                        }

                        worksheet.Cells["A" + index + ":G" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        worksheet.Cells["A" + index + ":G" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        worksheet.Cells["A" + index + ":G" + index].Style.Font.SetFromFont(new Font("Times New Roman", 10));
                        worksheet.Cells["A" + index + ":G" + index].Merge = true;
                        worksheet.Cells["A" + index + ":G" + index].Value = "Tổng cộng";
                        worksheet.Cells["A" + index + ":G" + index].Style.Font.Bold = true;

                        worksheet.Cells["H" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        worksheet.Cells["H" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                        worksheet.Cells["H" + index].Style.Numberformat.Format = "#,##0.00";
                        worksheet.Cells["H" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.ThanhTienBV)).Sum();

                        worksheet.Cells["I" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        worksheet.Cells["I" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;

                        worksheet.Cells["J" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        worksheet.Cells["J" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                        worksheet.Cells["J" + index].Style.Numberformat.Format = "#,##0.00";
                        worksheet.Cells["J" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.ThanhTienBH)).Sum();

                        worksheet.Cells["K" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        worksheet.Cells["K" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                        worksheet.Cells["K" + index].Style.Numberformat.Format = "#,##0.00";
                        worksheet.Cells["K" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.QuyBHYT)).Sum();

                        worksheet.Cells["L" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        worksheet.Cells["L" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                        worksheet.Cells["L" + index].Style.Numberformat.Format = "#,##0.00";
                        worksheet.Cells["L" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.NguoiBenhCungChiTra)).Sum();

                        worksheet.Cells["M" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        worksheet.Cells["M" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                        worksheet.Cells["M" + index].Style.Numberformat.Format = "#,##0.00";
                        worksheet.Cells["M" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.Khac)).Sum();

                        worksheet.Cells["N" + index].Style.Border.BorderAround(ExcelBorderStyle.Thin, Color.Black);
                        worksheet.Cells["N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                        worksheet.Cells["N" + index].Style.Numberformat.Format = "#,##0.00";
                        worksheet.Cells["N" + index].Value = groupChiPhiBangKes.Select(c => c.Sum(o => o.NguoiBenhTuTra)).Sum();

                        index++;

                        worksheet.Cells["A" + index + ":N" + index].Merge = true;
                        worksheet.Cells["A" + index + ":N" + index].Value = "Tổng chi phí lần khám bệnh/cả đợt điều trị: " + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + " đồng";
                        worksheet.Cells["A" + index + ":N" + index].Style.Font.Bold = true;

                        index++;

                        worksheet.Cells["A" + index + ":N" + index].Merge = true;
                        worksheet.Cells["A" + index + ":N" + index].Value = "(Viết bằng chữ: " + NumberHelper.ChuyenSoRaText(Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBV))) + ")";

                        index++;

                        worksheet.Cells["A" + index + ":N" + index].Merge = true;
                        worksheet.Cells["A" + index + ":N" + index].Value = "Trong đó , số tiền do:";
                        worksheet.Cells["A" + index + ":N" + index].Style.Font.Bold = true;

                        index++;
                        worksheet.Cells["A" + index + ":N" + index].Merge = true;
                        worksheet.Cells["A" + index + ":N" + index].Value = "- Quỹ BHYT thanh toán: " + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble();

                        index++;
                        worksheet.Cells["A" + index + ":N" + index].Merge = true;
                        worksheet.Cells["A" + index + ":N" + index].Value = "- Người bệnh trả trong đó: " + (Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)) + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhTuTra))).ApplyFormatMoneyToDouble();

                        index++;
                        worksheet.Cells["A" + index + ":N" + index].Merge = true;
                        worksheet.Cells["A" + index + ":N" + index].Value = "+ Cùng chi trả trong phạm vi BHYT: " + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble(true);

                        index++;
                        worksheet.Cells["A" + index + ":N" + index].Merge = true;
                        worksheet.Cells["A" + index + ":N" + index].Value = "+ Các khoản phải trả khác: " + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true);

                        index++;
                        worksheet.Cells["A" + index + ":N" + index].Merge = true;
                        worksheet.Cells["A" + index + ":N" + index].Value = "+ Nguồn khác: " + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble(true);


                        index = index + 2;

                        worksheet.Cells["D" + index + ":F" + index].Style.Font.SetFromFont(new Font("Times New Roman", 12));
                        worksheet.Cells["D" + index + ":F" + index].Merge = true;
                        worksheet.Cells["D" + index + ":F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        worksheet.Cells["D" + index + ":F" + index].Style.VerticalAlignment = ExcelVerticalAlignment.Top;
                        worksheet.Cells["D" + index + ":F" + index].Value = $"Ngày {DateTime.Now.Day} tháng {DateTime.Now.Month} năm {DateTime.Now.Year}";

                        worksheet.Cells["G" + index + ":I" + index].Style.Font.SetFromFont(new Font("Times New Roman", 12));
                        worksheet.Cells["G" + index + ":I" + index].Merge = true;
                        worksheet.Cells["G" + index + ":I" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        worksheet.Cells["G" + index + ":I" + index].Style.VerticalAlignment = ExcelVerticalAlignment.Top;
                        worksheet.Cells["G" + index + ":I" + index].Value = $"Ngày {DateTime.Now.Day} tháng {DateTime.Now.Month} năm {DateTime.Now.Year}";

                        worksheet.Cells["J" + index + ":N" + index].Style.Font.Bold = true;
                        worksheet.Cells["J" + index + ":N" + index].Merge = true;
                        worksheet.Cells["J" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        worksheet.Cells["J" + index + ":N" + index].Value = "XÁC NHẬN CỦA NGƯỜI BỆNH ";

                        index++;

                        worksheet.Cells["A" + index + ":C" + index].Style.Font.Bold = true;
                        worksheet.Cells["A" + index + ":C" + index].Merge = true;
                        worksheet.Cells["A" + index + ":C" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        worksheet.Cells["A" + index + ":C" + index].Value = "NGƯỜI LẬP BẢNG KÊ";

                        worksheet.Cells["D" + index + ":F" + index].Style.Font.Bold = true;
                        worksheet.Cells["D" + index + ":F" + index].Merge = true;
                        worksheet.Cells["D" + index + ":F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        worksheet.Cells["D" + index + ":F" + index].Value = "KẾ TOÁN VIỆN PHÍ";

                        worksheet.Cells["G" + index + ":I" + index].Style.Font.Bold = true;
                        worksheet.Cells["G" + index + ":I" + index].Merge = true;
                        worksheet.Cells["G" + index + ":I" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        worksheet.Cells["G" + index + ":I" + index].Value = "GIÁM ĐỊNH BHYT";

                        worksheet.Cells["J" + index + ":N" + index].Style.Font.Bold = true;
                        worksheet.Cells["J" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        worksheet.Cells["J" + index + ":N" + index].Merge = true;
                        worksheet.Cells["J" + index + ":N" + index].Value = "(Ký , Ghi rõ họ tên)";

                        index++;

                        worksheet.Cells["A" + index + ":C" + index].Style.Font.Bold = true;
                        worksheet.Cells["A" + index + ":C" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        worksheet.Cells["A" + index + ":C" + index].Merge = true;
                        worksheet.Cells["A" + index + ":C" + index].Value = "(Ký , Ghi rõ họ tên)";


                        worksheet.Cells["D" + index + ":F" + index].Style.Font.Bold = true;
                        worksheet.Cells["D" + index + ":F" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        worksheet.Cells["D" + index + ":F" + index].Merge = true;
                        worksheet.Cells["D" + index + ":F" + index].Value = "(Ký , Ghi rõ họ tên)";

                        worksheet.Cells["G" + index + ":I" + index].Style.Font.Bold = true;
                        worksheet.Cells["G" + index + ":I" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        worksheet.Cells["G" + index + ":I" + index].Merge = true;
                        worksheet.Cells["G" + index + ":I" + index].Value = "(Ký , Ghi rõ họ tên)";

                        worksheet.Cells["J" + index + ":N" + index].Style.Font.Bold = true;
                        worksheet.Cells["J" + index + ":N" + index].Merge = true;
                        worksheet.Cells["J" + index + ":N" + index].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        worksheet.Cells["J" + index + ":N" + index].Value = "(Tôi đã nhận...phim...Xquang / CT / MRI)";

                        xlPackage.Save();

                    }


                }
                return stream.ToArray();
            }

        }

        #endregion
    }
}
