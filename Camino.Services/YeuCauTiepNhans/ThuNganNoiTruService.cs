using System;
using System.Collections.Generic;
using System.Drawing.Text;
using System.Linq;
using System.Linq.Dynamic.Core;
using System.Text;
using System.Threading.Tasks;
using Camino.Core.Data;
using Camino.Core.DependencyInjection.Attributes;
using Camino.Core.Domain;
using Camino.Core.Domain.Entities.BenhNhans;
using Camino.Core.Domain.Entities.CongTyBaoHiemTuNhans;
using Camino.Core.Domain.Entities.DichVuGiuongBenhViens;
using Camino.Core.Domain.Entities.DichVuKhamBenhBenhViens;
using Camino.Core.Domain.Entities.DichVuKyThuats;
using Camino.Core.Domain.Entities.DonThuocThanhToans;
using Camino.Core.Domain.Entities.ICDs;
using Camino.Core.Domain.Entities.KhoaPhongChuyenKhoas;
using Camino.Core.Domain.Entities.NoiGioiThieu;
using Camino.Core.Domain.Entities.Users;
using Camino.Core.Domain.Entities.YeuCauKhamBenhs;
using Camino.Core.Domain.Entities.YeuCauTiepNhans;
using Camino.Core.Domain.Entities.YeuCauTiepNhanTheBHYTs;
using Camino.Core.Domain.ValueObject;
using Camino.Core.Domain.ValueObject.CauHinh;
using Camino.Core.Domain.ValueObject.DanhSachBenhNhanChoThuNgan;
using Camino.Core.Domain.ValueObject.Grid;
using Camino.Core.Domain.ValueObject.YeuCauTiepNhans;
using Camino.Core.Helpers;
using Camino.Data;
using Camino.Services.BenhNhans;
using Camino.Services.CauHinh;
using Camino.Services.Helpers;
using Camino.Services.Localization;
using Microsoft.EntityFrameworkCore;
using Newtonsoft.Json;
using static Camino.Core.Domain.Enums;

namespace Camino.Services.YeuCauTiepNhans
{
    [ScopedDependency(ServiceType = typeof(IThuNganNoiTruService))]
    public partial class ThuNganNoiTruService : YeuCauTiepNhanBaseService, IThuNganNoiTruService
    {
        private IRepository<TaiKhoanBenhNhanThu> _taiKhoanBenhNhanThuRepository;
        private IRepository<TaiKhoanBenhNhanChi> _taiKhoanBenhNhanChiRepository;
        private IRepository<User> _userRepository;
        private IRepository<ICD> _icdRepository;
        private IRepository<Core.Domain.Entities.KhoaPhongChuyenKhoas.KhoaPhongChuyenKhoa> _khoaPhongChuyenKhoaRepository;
        private IRepository<Core.Domain.Entities.KhoaPhongs.KhoaPhong> _khoaPhongRepository;
        private readonly IRepository<Template> _templateRepository;
        private readonly IRepository<Core.Domain.Entities.BenhVien.BenhVien> _benhVienRepository;
        private IRepository<YeuCauGoiDichVu> _yeuCauGoiDichVuRepository;
        private IRepository<YeuCauDichVuKyThuat> _yeuCauDichVuKyThuatRepository;
        private IRepository<Core.Domain.Entities.YeuCauKhamBenhs.YeuCauKhamBenh> _yeuCauKhamBenhRepository;
        private IRepository<NoiGioiThieuChiTietMienGiam> _noiGioiThieuChiTietMienGiamRepository;
        private IRepository<DichVuKhamBenhBenhVienGiaBenhVien> _dichVuKhamBenhBenhVienGiaBenhVienRepository;
        private IRepository<DichVuKyThuatBenhVienGiaBenhVien> _dichVuKyThuatBenhVienGiaBenhVienRepository;
        private IRepository<DichVuGiuongBenhVienGiaBenhVien> _dichVuGiuongBenhVienGiaBenhVienRepository;
        //private IRepository<Core.Domain.Entities.YeuCauKhamBenhs.YeuCauKhamBenh> _yeuCauKhamBenhRepository;

        public ThuNganNoiTruService(IRepository<YeuCauTiepNhan> yeuCauTiepNhanRepository, IRepository<Template> templateRepository,
            IRepository<Core.Domain.Entities.BenhVien.BenhVien> benhVienRepository, IRepository<Core.Domain.Entities.KhoaPhongs.KhoaPhong> khoaPhongRepository,
            IRepository<Core.Domain.Entities.KhoaPhongChuyenKhoas.KhoaPhongChuyenKhoa> khoaPhongChuyenKhoaRepository,
            IRepository<TaiKhoanBenhNhanThu> taiKhoanBenhNhanThuRepository, IRepository<TaiKhoanBenhNhanChi> taiKhoanBenhNhanChiRepository, IRepository<YeuCauGoiDichVu> yeuCauGoiDichVuRepository,
            IRepository<YeuCauDichVuKyThuat> yeuCauDichVuKyThuatRepository,
            IRepository<Core.Domain.Entities.YeuCauKhamBenhs.YeuCauKhamBenh> yeuCauKhamBenhRepository,
            IRepository<User> userRepository,
            IRepository<ICD> icdRepository,
            IUserAgentHelper userAgentHelper,
            ICauHinhService cauHinhService,
            ILocalizationService localizationService,
            IRepository<NoiGioiThieuChiTietMienGiam> noiGioiThieuChiTietMienGiamRepository,
            IRepository<DichVuKhamBenhBenhVienGiaBenhVien> dichVuKhamBenhBenhVienGiaBenhVienRepository,
            IRepository<DichVuKyThuatBenhVienGiaBenhVien> dichVuKyThuatBenhVienGiaBenhVienRepository,
            IRepository<DichVuGiuongBenhVienGiaBenhVien> dichVuGiuongBenhVienGiaBenhVienRepository,
            ITaiKhoanBenhNhanService taiKhoanBenhNhanService) :
            base(yeuCauTiepNhanRepository, userAgentHelper, cauHinhService, localizationService, taiKhoanBenhNhanService)
        {
            _taiKhoanBenhNhanThuRepository = taiKhoanBenhNhanThuRepository;
            _taiKhoanBenhNhanChiRepository = taiKhoanBenhNhanChiRepository;
            _templateRepository = templateRepository;
            _userRepository = userRepository;
            _icdRepository = icdRepository;
            _benhVienRepository = benhVienRepository;
            _yeuCauGoiDichVuRepository = yeuCauGoiDichVuRepository;
            _khoaPhongRepository = khoaPhongRepository;
            _yeuCauDichVuKyThuatRepository = yeuCauDichVuKyThuatRepository;
            _yeuCauKhamBenhRepository = yeuCauKhamBenhRepository;
            _khoaPhongChuyenKhoaRepository = khoaPhongChuyenKhoaRepository;
            _noiGioiThieuChiTietMienGiamRepository = noiGioiThieuChiTietMienGiamRepository;
            _dichVuKhamBenhBenhVienGiaBenhVienRepository = dichVuKhamBenhBenhVienGiaBenhVienRepository;
            _dichVuKyThuatBenhVienGiaBenhVienRepository = dichVuKyThuatBenhVienGiaBenhVienRepository;
            _dichVuGiuongBenhVienGiaBenhVienRepository = dichVuGiuongBenhVienGiaBenhVienRepository;
        }

        public bool KiemTraYeuCauTiepNhanCoKhuyenMai(long yeuCauTiepNhanId)
        {
            var yeuCauTiepNhan = BaseRepository.GetById(yeuCauTiepNhanId,
                x => x.Include(o => o.BenhNhan).ThenInclude(o => o.YeuCauGoiDichVus));
            if (yeuCauTiepNhan.BenhNhan.YeuCauGoiDichVus.Any(o => o.TrangThai != Enums.EnumTrangThaiYeuCauGoiDichVu.DaHuy))
            {
                var goiDvIds = yeuCauTiepNhan.BenhNhan.YeuCauGoiDichVus.Where(gdv => gdv.TrangThai != Enums.EnumTrangThaiYeuCauGoiDichVu.DaHuy).Select(gdv => gdv.Id).ToList();
                var yeuCauGoiDichVus = _yeuCauGoiDichVuRepository.TableNoTracking
                    .Where(o => goiDvIds.Contains(o.Id))
                    .Include(o => o.ChuongTrinhGoiDichVu).ThenInclude(o => o.ChuongTrinhGoiDichVuKhuyenMaiDichVuKhamBenhs)
                    .Include(o => o.ChuongTrinhGoiDichVu).ThenInclude(o => o.ChuongTrinhGoiDichVuKhuyenMaiDichVuKyThuats)
                    .Include(o => o.MienGiamChiPhis).ThenInclude(o => o.YeuCauDichVuKyThuat)
                    .Include(o => o.MienGiamChiPhis).ThenInclude(o => o.YeuCauKhamBenh)
                    .ToList();
                var chiPhis = GetDanhSachChiPhiKhamChuaBenhChuaThu(yeuCauTiepNhanId).Result;
                foreach (var chiPhi in chiPhis)
                {
                    if (chiPhi.LoaiNhom == NhomChiPhiNoiTru.DichVuKhamBenh)
                    {
                        foreach (var yeuCauGoiDichVu in yeuCauGoiDichVus)
                        {
                            var dvKhuyenMai = yeuCauGoiDichVu.ChuongTrinhGoiDichVu.ChuongTrinhGoiDichVuKhuyenMaiDichVuKhamBenhs
                                .FirstOrDefault(
                                    o => o.DichVuKhamBenhBenhVienId == chiPhi.DichVuBenhVienId &&
                                         o.NhomGiaDichVuKhamBenhBenhVienId == chiPhi.LoaiGiaId);
                            if (dvKhuyenMai != null)
                            {
                                var dvKhuyenMaiDaDung = yeuCauGoiDichVu.MienGiamChiPhis.Count(o =>
                                    o.YeuCauTiepNhanId != yeuCauTiepNhanId &&
                                    o.YeuCauKhamBenh != null &&
                                    o.YeuCauKhamBenh.DichVuKhamBenhBenhVienId == chiPhi.DichVuBenhVienId &&
                                    o.YeuCauKhamBenh.NhomGiaDichVuKhamBenhBenhVienId == chiPhi.LoaiGiaId);
                                if (dvKhuyenMai.SoLan > dvKhuyenMaiDaDung && DateTime.Now.Date <
                                    yeuCauGoiDichVu.ThoiDiemChiDinh.AddDays(dvKhuyenMai.SoNgaySuDung))
                                {
                                    return true;
                                }
                            }

                        }
                    }
                    if (chiPhi.LoaiNhom == NhomChiPhiNoiTru.DichVuKyThuat)
                    {
                        foreach (var yeuCauGoiDichVu in yeuCauGoiDichVus)
                        {
                            var dvKhuyenMai = yeuCauGoiDichVu.ChuongTrinhGoiDichVu.ChuongTrinhGoiDichVuKhuyenMaiDichVuKyThuats
                                .FirstOrDefault(
                                    o => o.DichVuKyThuatBenhVienId == chiPhi.DichVuBenhVienId &&
                                         o.NhomGiaDichVuKyThuatBenhVienId == chiPhi.LoaiGiaId);
                            if (dvKhuyenMai != null)
                            {
                                var dvKhuyenMaiDaDung = yeuCauGoiDichVu.MienGiamChiPhis.Where(o =>
                                    o.YeuCauTiepNhanId != yeuCauTiepNhanId &&
                                    o.YeuCauDichVuKyThuat != null &&
                                    o.YeuCauDichVuKyThuat.DichVuKyThuatBenhVienId == chiPhi.DichVuBenhVienId &&
                                    o.YeuCauDichVuKyThuat.NhomGiaDichVuKyThuatBenhVienId == chiPhi.LoaiGiaId).Select(o => o.YeuCauDichVuKyThuat.SoLan).DefaultIfEmpty().Sum();
                                if (dvKhuyenMai.SoLan > dvKhuyenMaiDaDung && DateTime.Now.Date <
                                    yeuCauGoiDichVu.ThoiDiemChiDinh.AddDays(dvKhuyenMai.SoNgaySuDung))
                                {
                                    return true;
                                }
                            }

                        }
                    }
                }
            }
            return false;
        }
        public async Task<List<DanhSachDichVuKhuyenMaiBenhNhanNoiTruVo>> GetDanhSachDichVuKhuyenMaiForGrid(long yeuCauTiepNhanId)
        {
            List<DanhSachDichVuKhuyenMaiBenhNhanNoiTruVo> danhSachDichVuKhuyenMaiBenhNhanVos = new List<DanhSachDichVuKhuyenMaiBenhNhanNoiTruVo>();
            var yeuCauTiepNhan = await BaseRepository.GetByIdAsync(yeuCauTiepNhanId, x => x.Include(o => o.BenhNhan).ThenInclude(o => o.YeuCauGoiDichVus));

            if (yeuCauTiepNhan.BenhNhan.YeuCauGoiDichVus.Any(o => o.TrangThai != Enums.EnumTrangThaiYeuCauGoiDichVu.DaHuy))
            {
                var goiDvIds = yeuCauTiepNhan.BenhNhan.YeuCauGoiDichVus.Where(gdv => gdv.TrangThai != Enums.EnumTrangThaiYeuCauGoiDichVu.DaHuy).Select(gdv => gdv.Id).ToList();
                var yeuCauGoiDichVus = _yeuCauGoiDichVuRepository.TableNoTracking
                    .Where(o => goiDvIds.Contains(o.Id))
                    .Include(o => o.ChuongTrinhGoiDichVu).ThenInclude(o => o.ChuongTrinhGoiDichVuKhuyenMaiDichVuKhamBenhs)
                    .Include(o => o.ChuongTrinhGoiDichVu).ThenInclude(o => o.ChuongTrinhGoiDichVuKhuyenMaiDichVuKyThuats)
                    .Include(o => o.MienGiamChiPhis).ThenInclude(o => o.YeuCauDichVuKyThuat)
                    .Include(o => o.MienGiamChiPhis).ThenInclude(o => o.YeuCauKhamBenh)
                    .ToList();
                var chiPhis = GetDanhSachChiPhiKhamChuaBenhChuaThu(yeuCauTiepNhanId).Result;
                foreach (var chiPhi in chiPhis)
                {
                    if (chiPhi.LoaiNhom == NhomChiPhiNoiTru.DichVuKhamBenh)
                    {
                        foreach (var yeuCauGoiDichVu in yeuCauGoiDichVus)
                        {


                            var dvKhuyenMai = yeuCauGoiDichVu.ChuongTrinhGoiDichVu.ChuongTrinhGoiDichVuKhuyenMaiDichVuKhamBenhs
                                .FirstOrDefault(
                                    o => o.DichVuKhamBenhBenhVienId == chiPhi.DichVuBenhVienId &&
                                         o.NhomGiaDichVuKhamBenhBenhVienId == chiPhi.LoaiGiaId);
                            if (dvKhuyenMai != null)
                            {
                                var dvKhuyenMaiDaDung = yeuCauGoiDichVu.MienGiamChiPhis.Count(o =>
                                    o.YeuCauTiepNhanId != yeuCauTiepNhanId &&
                                    o.YeuCauKhamBenh != null &&
                                    o.YeuCauKhamBenh.DichVuKhamBenhBenhVienId == chiPhi.DichVuBenhVienId &&
                                    o.YeuCauKhamBenh.NhomGiaDichVuKhamBenhBenhVienId == chiPhi.LoaiGiaId);
                                if (dvKhuyenMai.SoLan > dvKhuyenMaiDaDung && DateTime.Now.Date <
                                    yeuCauGoiDichVu.ThoiDiemChiDinh.AddDays(dvKhuyenMai.SoNgaySuDung))
                                {
                                    var dichVuTrongGoiKhuyenMaiVo = new DanhSachDichVuTrongGoiKhuyenMaiNoiTruVo
                                    {
                                        Id = chiPhi.Id,
                                        DaChon = yeuCauGoiDichVu.MienGiamChiPhis.Any(o =>
                                            o.YeuCauKhamBenhId == chiPhi.Id),
                                        LoaiNhom = chiPhi.LoaiNhom,
                                        Ma = chiPhi.Ma,
                                        TenDichVu = chiPhi.TenDichVu,
                                        LoaiGia = chiPhi.LoaiGia,
                                        Soluong = chiPhi.Soluong,
                                        DonGia = chiPhi.DonGia,
                                        DonGiaKM = dvKhuyenMai.DonGiaKhuyenMai,
                                        HanSuDung = yeuCauGoiDichVu.ThoiDiemChiDinh.AddDays(dvKhuyenMai.SoNgaySuDung),
                                        SoLuongDaDung = dvKhuyenMaiDaDung,
                                        GhiChu = $"Khuyến mãi theo gói {dvKhuyenMai.ChuongTrinhGoiDichVu.Ten}"
                                    };

                                    var goiDichVuKhuyenMaiBenhNhan = danhSachDichVuKhuyenMaiBenhNhanVos.FirstOrDefault(o => o.Id == yeuCauGoiDichVu.Id);
                                    if (goiDichVuKhuyenMaiBenhNhan == null)
                                    {
                                        goiDichVuKhuyenMaiBenhNhan = new DanhSachDichVuKhuyenMaiBenhNhanNoiTruVo
                                        {
                                            Id = yeuCauGoiDichVu.Id,
                                            TenGoi = yeuCauGoiDichVu.TenChuongTrinh,
                                            DanhSachDichVuTrongGoiKhuyenMaiNoiTrus = new List<DanhSachDichVuTrongGoiKhuyenMaiNoiTruVo> { dichVuTrongGoiKhuyenMaiVo }
                                        };
                                        danhSachDichVuKhuyenMaiBenhNhanVos.Add(goiDichVuKhuyenMaiBenhNhan);
                                    }
                                    else
                                    {
                                        goiDichVuKhuyenMaiBenhNhan.DanhSachDichVuTrongGoiKhuyenMaiNoiTrus.Add(dichVuTrongGoiKhuyenMaiVo);
                                    }
                                }
                            }

                        }
                    }
                    if (chiPhi.LoaiNhom == NhomChiPhiNoiTru.DichVuKyThuat)
                    {
                        foreach (var yeuCauGoiDichVu in yeuCauGoiDichVus)
                        {
                            var dvKhuyenMai = yeuCauGoiDichVu.ChuongTrinhGoiDichVu.ChuongTrinhGoiDichVuKhuyenMaiDichVuKyThuats
                                .FirstOrDefault(
                                    o => o.DichVuKyThuatBenhVienId == chiPhi.DichVuBenhVienId &&
                                         o.NhomGiaDichVuKyThuatBenhVienId == chiPhi.LoaiGiaId);
                            if (dvKhuyenMai != null)
                            {
                                var dvKhuyenMaiDaDung = yeuCauGoiDichVu.MienGiamChiPhis.Where(o =>
                                    o.YeuCauTiepNhanId != yeuCauTiepNhanId &&
                                    o.YeuCauDichVuKyThuat != null &&
                                    o.YeuCauDichVuKyThuat.DichVuKyThuatBenhVienId == chiPhi.DichVuBenhVienId &&
                                    o.YeuCauDichVuKyThuat.NhomGiaDichVuKyThuatBenhVienId == chiPhi.LoaiGiaId).Select(o => o.YeuCauDichVuKyThuat.SoLan).DefaultIfEmpty().Sum();
                                if (dvKhuyenMai.SoLan > dvKhuyenMaiDaDung && DateTime.Now.Date <
                                    yeuCauGoiDichVu.ThoiDiemChiDinh.AddDays(dvKhuyenMai.SoNgaySuDung))
                                {
                                    var dichVuTrongGoiKhuyenMaiVo = new DanhSachDichVuTrongGoiKhuyenMaiNoiTruVo
                                    {
                                        Id = chiPhi.Id,
                                        DaChon = yeuCauGoiDichVu.MienGiamChiPhis.Any(o => o.YeuCauDichVuKyThuatId == chiPhi.Id),
                                        LoaiNhom = chiPhi.LoaiNhom,
                                        Ma = chiPhi.Ma,
                                        TenDichVu = chiPhi.TenDichVu,
                                        LoaiGia = chiPhi.LoaiGia,
                                        Soluong = chiPhi.Soluong,
                                        DonGia = chiPhi.DonGia,
                                        DonGiaKM = dvKhuyenMai.DonGiaKhuyenMai,
                                        HanSuDung = yeuCauGoiDichVu.ThoiDiemChiDinh.AddDays(dvKhuyenMai.SoNgaySuDung),
                                        SoLuongDaDung = dvKhuyenMaiDaDung,
                                        GhiChu = $"Khuyến mãi theo gói {dvKhuyenMai.ChuongTrinhGoiDichVu.Ten}"
                                    };

                                    var goiDichVuKhuyenMaiBenhNhan = danhSachDichVuKhuyenMaiBenhNhanVos.FirstOrDefault(o => o.Id == yeuCauGoiDichVu.Id);
                                    if (goiDichVuKhuyenMaiBenhNhan == null)
                                    {
                                        goiDichVuKhuyenMaiBenhNhan = new DanhSachDichVuKhuyenMaiBenhNhanNoiTruVo
                                        {
                                            Id = yeuCauGoiDichVu.Id,
                                            TenGoi = yeuCauGoiDichVu.TenChuongTrinh,
                                            DanhSachDichVuTrongGoiKhuyenMaiNoiTrus = new List<DanhSachDichVuTrongGoiKhuyenMaiNoiTruVo> { dichVuTrongGoiKhuyenMaiVo }
                                        };
                                        danhSachDichVuKhuyenMaiBenhNhanVos.Add(goiDichVuKhuyenMaiBenhNhan);
                                    }
                                    else
                                    {
                                        goiDichVuKhuyenMaiBenhNhan.DanhSachDichVuTrongGoiKhuyenMaiNoiTrus.Add(dichVuTrongGoiKhuyenMaiVo);
                                    }
                                }
                            }

                        }
                    }
                }
            }
            return danhSachDichVuKhuyenMaiBenhNhanVos;
        }
        public void ApDungDichVuKhuyenMai(ApDungKhuyenMaiBenhNhanNoiTru apDungKhuyenMaiBenhNhan)
        {
            var yeuCauTiepNhan = BaseRepository.GetById(apDungKhuyenMaiBenhNhan.YeuCauTiepNhanId, x => x.Include(o => o.YeuCauKhamBenhs).Include(o => o.YeuCauDichVuKyThuats).Include(o => o.BenhNhan).ThenInclude(o => o.YeuCauGoiDichVus));
            var isUpdated = false;
            if (yeuCauTiepNhan.BenhNhan.YeuCauGoiDichVus.Any(o => o.TrangThai != Enums.EnumTrangThaiYeuCauGoiDichVu.DaHuy))
            {
                var goiDvIds = yeuCauTiepNhan.BenhNhan.YeuCauGoiDichVus.Where(gdv => gdv.TrangThai != Enums.EnumTrangThaiYeuCauGoiDichVu.DaHuy).Select(gdv => gdv.Id).ToList();
                var yeuCauGoiDichVus = _yeuCauGoiDichVuRepository.Table
                    .Where(o => goiDvIds.Contains(o.Id))
                    .Include(o => o.ChuongTrinhGoiDichVu).ThenInclude(o => o.ChuongTrinhGoiDichVuKhuyenMaiDichVuKhamBenhs)
                    .Include(o => o.ChuongTrinhGoiDichVu).ThenInclude(o => o.ChuongTrinhGoiDichVuKhuyenMaiDichVuKyThuats)
                    .Include(o => o.MienGiamChiPhis).ThenInclude(o => o.YeuCauDichVuKyThuat)
                    .Include(o => o.MienGiamChiPhis).ThenInclude(o => o.YeuCauKhamBenh)
                    .ToList();
                foreach (var yeuCauGoiDichVu in yeuCauGoiDichVus)
                {
                    var chiPhiDuocKhuyenMais = apDungKhuyenMaiBenhNhan.DsKhuyenMaiBenhNhanNoiTrus.FirstOrDefault(o => o.Id == yeuCauGoiDichVu.Id)?.DanhSachDichVuTrongGoiKhuyenMaiNoiTrus;
                    if (chiPhiDuocKhuyenMais != null)
                    {
                        foreach (var chiPhi in chiPhiDuocKhuyenMais)
                        {
                            if (chiPhi.LoaiNhom == NhomChiPhiNoiTru.DichVuKhamBenh)
                            {
                                if (chiPhi.DaChon == false)
                                {
                                    var mg = yeuCauGoiDichVu.MienGiamChiPhis.FirstOrDefault(o => o.YeuCauKhamBenhId == chiPhi.Id);
                                    if (mg != null)
                                    {
                                        mg.WillDelete = true;
                                        mg.YeuCauKhamBenh.SoTienMienGiam -= mg.SoTien;
                                        isUpdated = true;
                                    }
                                }
                                else if (yeuCauGoiDichVu.MienGiamChiPhis.All(o => o.YeuCauKhamBenhId != chiPhi.Id))
                                {
                                    var yc = yeuCauTiepNhan.YeuCauKhamBenhs.First(o => o.Id == chiPhi.Id);
                                    var dvKhuyenMai = yeuCauGoiDichVu.ChuongTrinhGoiDichVu
                                        .ChuongTrinhGoiDichVuKhuyenMaiDichVuKhamBenhs
                                        .FirstOrDefault(o =>
                                            o.DichVuKhamBenhBenhVienId == yc.DichVuKhamBenhBenhVienId &&
                                            o.NhomGiaDichVuKhamBenhBenhVienId == yc.NhomGiaDichVuKhamBenhBenhVienId);
                                    if (dvKhuyenMai != null)
                                    {
                                        var dvKhuyenMaiDaDung = yeuCauGoiDichVu.MienGiamChiPhis.Where(o => o.WillDelete != true).Count(o =>
                                              o.YeuCauKhamBenh != null &&
                                              o.YeuCauKhamBenh.DichVuKhamBenhBenhVienId == yc.DichVuKhamBenhBenhVienId &&
                                              o.YeuCauKhamBenh.NhomGiaDichVuKhamBenhBenhVienId == yc.NhomGiaDichVuKhamBenhBenhVienId);
                                        if (dvKhuyenMai.SoLan > dvKhuyenMaiDaDung && DateTime.Now.Date < yeuCauGoiDichVu.ThoiDiemChiDinh.AddDays(dvKhuyenMai.SoNgaySuDung))
                                        {
                                            yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                                            {
                                                YeuCauTiepNhanId = yeuCauTiepNhan.Id,
                                                LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                                                LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoSoTien,
                                                SoTien = chiPhi.SoTienMG,
                                                YeuCauGoiDichVuId = yeuCauGoiDichVu.Id
                                            });
                                            yc.SoTienMienGiam += chiPhi.SoTienMG;
                                            isUpdated = true;
                                        }
                                    }
                                }
                            }
                            if (chiPhi.LoaiNhom == NhomChiPhiNoiTru.DichVuKyThuat)
                            {
                                if (chiPhi.DaChon == false)
                                {
                                    var mg = yeuCauGoiDichVu.MienGiamChiPhis.FirstOrDefault(o => o.YeuCauDichVuKyThuatId == chiPhi.Id);
                                    if (mg != null)
                                    {
                                        mg.WillDelete = true;
                                        mg.YeuCauDichVuKyThuat.SoTienMienGiam -= mg.SoTien;
                                        isUpdated = true;
                                    }
                                }
                                else if (yeuCauGoiDichVu.MienGiamChiPhis.All(o => o.YeuCauDichVuKyThuatId != chiPhi.Id))
                                {
                                    var yc = yeuCauTiepNhan.YeuCauDichVuKyThuats.First(o => o.Id == chiPhi.Id);
                                    var dvKhuyenMai = yeuCauGoiDichVu.ChuongTrinhGoiDichVu
                                        .ChuongTrinhGoiDichVuKhuyenMaiDichVuKyThuats
                                        .FirstOrDefault(o =>
                                            o.DichVuKyThuatBenhVienId == yc.DichVuKyThuatBenhVienId &&
                                            o.NhomGiaDichVuKyThuatBenhVienId == yc.NhomGiaDichVuKyThuatBenhVienId);
                                    if (dvKhuyenMai != null)
                                    {
                                        var dvKhuyenMaiDaDung = yeuCauGoiDichVu.MienGiamChiPhis.Where(o => o.WillDelete != true).Where(o =>
                                              o.YeuCauDichVuKyThuat != null &&
                                              o.YeuCauDichVuKyThuat.DichVuKyThuatBenhVienId == yc.DichVuKyThuatBenhVienId &&
                                              o.YeuCauDichVuKyThuat.NhomGiaDichVuKyThuatBenhVienId == yc.NhomGiaDichVuKyThuatBenhVienId)
                                              .Select(o => o.YeuCauDichVuKyThuat.SoLan).DefaultIfEmpty().Sum();
                                        if (dvKhuyenMai.SoLan > dvKhuyenMaiDaDung && DateTime.Now.Date < yeuCauGoiDichVu.ThoiDiemChiDinh.AddDays(dvKhuyenMai.SoNgaySuDung))
                                        {
                                            yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                                            {
                                                YeuCauTiepNhanId = yeuCauTiepNhan.Id,
                                                LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                                                LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoSoTien,
                                                SoTien = chiPhi.SoTienMG,
                                                YeuCauGoiDichVuId = yeuCauGoiDichVu.Id
                                            });
                                            yc.SoTienMienGiam += chiPhi.SoTienMG;
                                            isUpdated = true;
                                        }
                                    }
                                }
                            }
                        }
                    }
                }

            }
            if (isUpdated)
            {
                BaseRepository.Update(yeuCauTiepNhan);
            }
        }
        public async Task<bool> KiemTraConPhieuThuCongNo(long yeuCauTiepNhanId)
        {
            return await _taiKhoanBenhNhanService.KiemTraConPhieuThuCongNo(yeuCauTiepNhanId);
        }
        public long? KiemTraSuDungGoi(long yeuCauTiepNhanId)
        {
            var yeuCauTiepNhan = BaseRepository.GetById(yeuCauTiepNhanId);

            var ycGoiDichVu = _yeuCauGoiDichVuRepository.TableNoTracking.FirstOrDefault(o => o.YeuCauKhamBenhs.Any(yc => (yc.YeuCauTiepNhanId == yeuCauTiepNhanId || yc.YeuCauTiepNhanId == yeuCauTiepNhan.YeuCauTiepNhanNgoaiTruCanQuyetToanId) && yc.TrangThai != Enums.EnumTrangThaiYeuCauKhamBenh.HuyKham)
                || o.YeuCauDichVuKyThuats.Any(yc => (yc.YeuCauTiepNhanId == yeuCauTiepNhanId || yc.YeuCauTiepNhanId == yeuCauTiepNhan.YeuCauTiepNhanNgoaiTruCanQuyetToanId) && yc.TrangThai != Enums.EnumTrangThaiYeuCauDichVuKyThuat.DaHuy)
                || o.YeuCauDichVuGiuongBenhVienChiPhiBenhViens.Any(yc => (yc.YeuCauTiepNhanId == yeuCauTiepNhanId || yc.YeuCauTiepNhanId == yeuCauTiepNhan.YeuCauTiepNhanNgoaiTruCanQuyetToanId)));

            return ycGoiDichVu?.BenhNhanId;
        }
        public async Task<bool> CapNhatDonGiaMoi(CapNhatDonGiaMoi capNhatDonGiaMoi)
        {
            var yc = _yeuCauDichVuKyThuatRepository.Table.Include(o => o.CongTyBaoHiemTuNhanCongNos)
                .FirstOrDefault(o => o.Id == capNhatDonGiaMoi.Id && o.TrangThaiThanhToan != TrangThaiThanhToan.DaThanhToan);
            //update 19/11/2021: không cần DonGiaCapNhat phải lớn hơn DonGiaBaoHiem
            if (yc != null && capNhatDonGiaMoi.DonGiaCapNhat != null)
            {
                yc.Gia = capNhatDonGiaMoi.DonGiaCapNhat.GetValueOrDefault();
                foreach (var ycCongTyBaoHiemTuNhanCongNo in yc.CongTyBaoHiemTuNhanCongNos.Where(o => o.TaiKhoanBenhNhanThuId == null))
                {
                    ycCongTyBaoHiemTuNhanCongNo.WillDelete = true;
                }
                yc.SoTienBaoHiemTuNhanChiTra = 0;

                foreach (var mienGiam in yc.MienGiamChiPhis.Where(o => o.TaiKhoanBenhNhanThuId == null))
                {
                    mienGiam.WillDelete = true;
                }

                yc.SoTienMienGiam = 0;

                yc.GhiChuMienGiamThem = null;
                yc.NoiDungGhiChuMiemGiamId = null;

                _yeuCauDichVuKyThuatRepository.Context.SaveChanges();
                return true;
            }
            return false;
        }
        public async Task<int> KiemTraDichVuTrongGoiCoBHYTNoiTru(long yeuCauTiepNhanId)
        {
            var yeuCauTiepNhan = await BaseRepository.GetByIdAsync(yeuCauTiepNhanId,
                x => x.Include(o => o.YeuCauKhamBenhs)
                        .Include(o => o.YeuCauDichVuKyThuats)
                        .Include(o => o.YeuCauDichVuGiuongBenhVienChiPhiBenhViens).ThenInclude(o => o.YeuCauDichVuGiuongBenhVienChiPhiBHYTs));

            long? yeuCauTiepNhanNgoaiTruCanQuyetToanId = yeuCauTiepNhan.YeuCauTiepNhanNgoaiTruCanQuyetToanId;
            YeuCauTiepNhan yeuCauTiepNhanNgoaiTruCanQuyetToan = null;
            var soDichVuKhamNgoaiTru = 0;
            var soDichVuKyThuatNgoaiTru = 0;
            if (yeuCauTiepNhanNgoaiTruCanQuyetToanId != null)
            {
                yeuCauTiepNhanNgoaiTruCanQuyetToan = await BaseRepository.GetByIdAsync(yeuCauTiepNhanNgoaiTruCanQuyetToanId.Value,
                    x => x.Include(o => o.YeuCauKhamBenhs)
                        .Include(o => o.YeuCauDichVuKyThuats)
                        .Include(o => o.YeuCauDichVuGiuongBenhVienChiPhiBenhViens).ThenInclude(o => o.YeuCauDichVuGiuongBenhVienChiPhiBHYTs));
                if (yeuCauTiepNhanNgoaiTruCanQuyetToan != null)
                {
                    soDichVuKhamNgoaiTru = yeuCauTiepNhanNgoaiTruCanQuyetToan.YeuCauKhamBenhs.Count(o =>
                        o.TrangThai != Enums.EnumTrangThaiYeuCauKhamBenh.HuyKham &&
                        o.TrangThaiThanhToan != Enums.TrangThaiThanhToan.DaThanhToan && o.YeuCauGoiDichVuId != null);

                    soDichVuKyThuatNgoaiTru = yeuCauTiepNhanNgoaiTruCanQuyetToan.YeuCauDichVuKyThuats.Count(o =>
                        o.TrangThai != Enums.EnumTrangThaiYeuCauDichVuKyThuat.DaHuy &&
                        o.TrangThaiThanhToan != Enums.TrangThaiThanhToan.DaThanhToan && o.YeuCauGoiDichVuId != null);
                }
            }
            var soDichVuKyThuat = yeuCauTiepNhan.YeuCauDichVuKyThuats.Count(o =>
                o.TrangThai != Enums.EnumTrangThaiYeuCauDichVuKyThuat.DaHuy &&
                o.TrangThaiThanhToan != Enums.TrangThaiThanhToan.DaThanhToan && o.YeuCauGoiDichVuId != null);

            var soYeucCauDichVuGiuong = yeuCauTiepNhan.YeuCauDichVuGiuongBenhVienChiPhiBenhViens
                .Count(o => o.TrangThaiThanhToan != Enums.TrangThaiThanhToan.DaThanhToan && o.YeuCauGoiDichVuId != null);

            return soDichVuKhamNgoaiTru + soDichVuKyThuatNgoaiTru + soDichVuKyThuat + soYeucCauDichVuGiuong;
        }

        public decimal GetSoTienHoanUngTrongGoi(long yeuCauTiepNhanId)
        {
            var dsDichVu = GetDanhSachDichVuTrongGoiCoBHYTChuaQuyetToanNoiTru(yeuCauTiepNhanId);
            var goiDvIds = dsDichVu.Select(o => o.YeuCauGoiDichVuId).Distinct().ToList();
            var goiDvs = _yeuCauGoiDichVuRepository.Table.Where(o => goiDvIds.Contains(o.Id)).Include(o => o.ChuongTrinhGoiDichVu).ToList();
            decimal soTienHoanUng = 0;
            foreach (var goiDv in goiDvs)
            {
                if (goiDv.ChuongTrinhGoiDichVu?.CongTyBaoHiemTuNhanId != null)
                    continue;
                soTienHoanUng += Math.Round(dsDichVu.Where(o => o.YeuCauGoiDichVuId == goiDv.Id).Select(o => o.BHYTThanhToan).DefaultIfEmpty().Sum(), MidpointRounding.AwayFromZero);
                soTienHoanUng += Math.Round(dsDichVu.Where(o => o.YeuCauGoiDichVuId == goiDv.Id).Select(o => o.TongCongNo).DefaultIfEmpty().Sum(), MidpointRounding.AwayFromZero);
            }
            return soTienHoanUng;
        }
        public List<ChiPhiKhamChuaBenhTrongGoiDichVuVo> GetDanhSachDichVuTrongGoiCoBHYTChuaQuyetToanNoiTru(long yeuCauTiepNhanId)
        {
            var yeuCauTiepNhan = BaseRepository.GetById(yeuCauTiepNhanId,
                x => x.Include(o => o.YeuCauTiepNhanCongTyBaoHiemTuNhans));

            long? yeuCauTiepNhanNgoaiTruCanQuyetToanId = yeuCauTiepNhan.YeuCauTiepNhanNgoaiTruCanQuyetToanId;
            var dsDichVuTrongGoiCoBHYTChuaQT = new List<ChiPhiKhamChuaBenhTrongGoiDichVuVo>();

            var queryDichVuKhamBenh = BaseRepository.TableNoTracking.Where(o => o.Id == yeuCauTiepNhanId || o.Id == yeuCauTiepNhanNgoaiTruCanQuyetToanId)
                .SelectMany(o => o.YeuCauKhamBenhs).Include(cc => cc.CongTyBaoHiemTuNhanCongNos).Include(cc => cc.MienGiamChiPhis).Include(cc => cc.NoiDangKy).Include(cc => cc.BacSiDangKy).ThenInclude(cc => cc.User)
                .Where(o => o.TrangThai != Enums.EnumTrangThaiYeuCauKhamBenh.HuyKham && o.TrangThaiThanhToan != Enums.TrangThaiThanhToan.DaThanhToan && o.YeuCauGoiDichVuId != null)
                .Select(s => new ChiPhiKhamChuaBenhTrongGoiDichVuVo
                {
                    Id = s.Id,
                    YeuCauGoiDichVuId = s.YeuCauGoiDichVuId.Value,
                    ChuongTrinhGoiDichVuId = s.YeuCauGoiDichVu.ChuongTrinhGoiDichVuId,
                    TenChuongTrinhGoiDichVu = s.YeuCauGoiDichVu.TenChuongTrinh,
                    NgayPhatSinh = s.ThoiDiemChiDinh,
                    LoaiNhom = NhomChiPhiKhamChuaBenh.DichVuKhamBenh,
                    Ma = s.DichVuKhamBenhBenhVien.Ma,
                    TenDichVu = s.DichVuKhamBenhBenhVien.Ten,
                    LoaiGia = s.NhomGiaDichVuKhamBenhBenhVien.Ten,
                    Soluong = 1,
                    DonGia = s.DonGiaSauChietKhau.GetValueOrDefault(),
                    DonGiaBHYT = s.DonGiaBaoHiem.GetValueOrDefault(),
                    KiemTraBHYTXacNhan = s.BaoHiemChiTra != null,
                    DuocHuongBHYT = s.DuocHuongBaoHiem,
                    TiLeBaoHiemThanhToan = s.TiLeBaoHiemThanhToan.GetValueOrDefault(),
                    MucHuongBaoHiem = s.MucHuongBaoHiem.GetValueOrDefault(),
                    DanhSachCongNoChoThus = s.CongTyBaoHiemTuNhanCongNos.Count == 0 ? new List<DanhSachCongNoVo>() : s.CongTyBaoHiemTuNhanCongNos.Where(o => o.TaiKhoanBenhNhanThuId == null).Select(o => new DanhSachCongNoVo { CongTyBaoHiemTuNhanId = o.CongTyBaoHiemTuNhanId, SoTienCongNoChoThu = o.SoTien }).ToList(),
                    NoiThucHien = (s.NoiDangKy != null ? $"{s.NoiDangKy.Ma}" : "") + (s.BacSiDangKy != null && s.BacSiDangKy.User.HoTen != null ? " - " + $"{s.BacSiDangKy.User.HoTen}" : ""),
                    CheckedDefault = true,
                }).ToList();
            dsDichVuTrongGoiCoBHYTChuaQT.AddRange(queryDichVuKhamBenh);

            var queryDichVuKyThuat = BaseRepository.TableNoTracking.Where(o => o.Id == yeuCauTiepNhanId || o.Id == yeuCauTiepNhanNgoaiTruCanQuyetToanId)
                .SelectMany(o => o.YeuCauDichVuKyThuats).Include(cc => cc.CongTyBaoHiemTuNhanCongNos).Include(cc => cc.MienGiamChiPhis)
                .Where(o => o.TrangThai != Enums.EnumTrangThaiYeuCauDichVuKyThuat.DaHuy &&
                            o.TrangThaiThanhToan != Enums.TrangThaiThanhToan.DaThanhToan && o.YeuCauGoiDichVuId != null)
                .Select(s => new ChiPhiKhamChuaBenhTrongGoiDichVuVo
                {
                    Id = s.Id,
                    YeuCauGoiDichVuId = s.YeuCauGoiDichVuId.Value,
                    ChuongTrinhGoiDichVuId = s.YeuCauGoiDichVu.ChuongTrinhGoiDichVuId,
                    TenChuongTrinhGoiDichVu = s.YeuCauGoiDichVu.TenChuongTrinh,
                    NgayPhatSinh = s.NoiTruPhieuDieuTri != null ? s.NoiTruPhieuDieuTri.NgayDieuTri : s.ThoiDiemChiDinh,
                    LoaiNhom = NhomChiPhiKhamChuaBenh.DichVuKyThuat,
                    Ma = s.DichVuKyThuatBenhVien.Ma,
                    TenDichVu = s.DichVuKyThuatBenhVien.Ten,
                    LoaiGia = s.NhomGiaDichVuKyThuatBenhVien.Ten,
                    Soluong = s.SoLan,
                    DonGia = s.DonGiaSauChietKhau.GetValueOrDefault(),
                    DonGiaBHYT = s.DonGiaBaoHiem.GetValueOrDefault(),
                    KiemTraBHYTXacNhan = s.BaoHiemChiTra != null,
                    DuocHuongBHYT = s.DuocHuongBaoHiem,
                    TiLeBaoHiemThanhToan = s.TiLeBaoHiemThanhToan.GetValueOrDefault(),
                    MucHuongBaoHiem = s.MucHuongBaoHiem.GetValueOrDefault(),
                    DanhSachCongNoChoThus = s.CongTyBaoHiemTuNhanCongNos.Count == 0 ? new List<DanhSachCongNoVo>() : s.CongTyBaoHiemTuNhanCongNos.Where(o => o.TaiKhoanBenhNhanThuId == null).Select(o => new DanhSachCongNoVo { CongTyBaoHiemTuNhanId = o.CongTyBaoHiemTuNhanId, SoTienCongNoChoThu = o.SoTien }).ToList(),
                    NoiThucHien = s.NoiThucHien != null
                        ? $"{s.NoiThucHien.Ma} - {s.NoiThucHien.Ten}"
                        : string.Empty,
                    CheckedDefault = true,
                }).ToList();
            dsDichVuTrongGoiCoBHYTChuaQT.AddRange(queryDichVuKyThuat);

            var queryDichVuGiuongChiPhiBenhVien = BaseRepository.TableNoTracking.Where(o => o.Id == yeuCauTiepNhanId)
                .SelectMany(o => o.YeuCauDichVuGiuongBenhVienChiPhiBenhViens).Include(cc => cc.CongTyBaoHiemTuNhanCongNos).Include(cc => cc.MienGiamChiPhis)
                .Where(o => o.TrangThaiThanhToan != Enums.TrangThaiThanhToan.DaThanhToan && o.YeuCauGoiDichVuId != null)
                .Select(s => new ChiPhiKhamChuaBenhTrongGoiDichVuVo
                {
                    Id = s.Id,
                    YeuCauGoiDichVuId = s.YeuCauGoiDichVuId.Value,
                    TenChuongTrinhGoiDichVu = s.YeuCauGoiDichVu.TenChuongTrinh,
                    NgayPhatSinh = s.NgayPhatSinh,
                    LoaiNhom = NhomChiPhiKhamChuaBenh.DichVuGiuong,
                    Ma = s.Ma,
                    TenDichVu = s.Ten,
                    LoaiGia = s.NhomGiaDichVuGiuongBenhVien.Ten,
                    Soluong = s.SoLuong,
                    DonGia = s.DonGiaSauChietKhau.GetValueOrDefault(),
                    DanhSachCongNoChoThus = s.CongTyBaoHiemTuNhanCongNos.Count == 0 ? new List<DanhSachCongNoVo>() : s.CongTyBaoHiemTuNhanCongNos.Where(o => o.TaiKhoanBenhNhanThuId == null).Select(o => new DanhSachCongNoVo { CongTyBaoHiemTuNhanId = o.CongTyBaoHiemTuNhanId, SoTienCongNoChoThu = o.SoTien }).ToList(),
                    //DonGiaBHYT = s.YeuCauDichVuGiuongBenhVienChiPhiBHYTs.FirstOrDefault()?.DonGiaBaoHiem ?? 0,
                    //KiemTraBHYTXacNhan = s.YeuCauDichVuGiuongBenhVienChiPhiBHYTs.FirstOrDefault()?.BaoHiemChiTra != null,
                    //DuocHuongBHYT = s.YeuCauDichVuGiuongBenhVienChiPhiBHYTs.FirstOrDefault()?.DuocHuongBaoHiem ?? false,
                    //TiLeBaoHiemThanhToan = s.YeuCauDichVuGiuongBenhVienChiPhiBHYTs.FirstOrDefault()?.TiLeBaoHiemThanhToan ?? 0,
                    //MucHuongBaoHiem = s.YeuCauDichVuGiuongBenhVienChiPhiBHYTs.FirstOrDefault()?.MucHuongBaoHiem ?? 0,
                    NoiThucHien = s.PhongBenhVien != null ? $"{s.PhongBenhVien.Ma} - {s.PhongBenhVien.Ten}" : string.Empty,
                    CheckedDefault = true,
                }).ToList();

            var queryDichVuGiuongChiPhiBHYT = BaseRepository.TableNoTracking.Where(o => o.Id == yeuCauTiepNhanId)
                .SelectMany(o => o.YeuCauDichVuGiuongBenhVienChiPhiBHYTs).ToList();

            foreach (var chiPhiKhamChuaBenhTrongGoiDichVuVo in queryDichVuGiuongChiPhiBenhVien)
            {
                var chiPhiGiuongBHYT = queryDichVuGiuongChiPhiBHYT.FirstOrDefault(o => o.ThanhToanTheoYeuCauDichVuGiuongBenhVienChiPhiBenhVienId == chiPhiKhamChuaBenhTrongGoiDichVuVo.Id);
                if (chiPhiGiuongBHYT != null)
                {
                    chiPhiKhamChuaBenhTrongGoiDichVuVo.DuocHuongBHYT = true;
                    chiPhiKhamChuaBenhTrongGoiDichVuVo.KiemTraBHYTXacNhan = chiPhiGiuongBHYT.BaoHiemChiTra != null;
                    chiPhiKhamChuaBenhTrongGoiDichVuVo.DonGiaBHYT = chiPhiGiuongBHYT.DonGiaBaoHiem.GetValueOrDefault();
                    chiPhiKhamChuaBenhTrongGoiDichVuVo.TiLeBaoHiemThanhToan = chiPhiGiuongBHYT.TiLeBaoHiemThanhToan.GetValueOrDefault();
                    chiPhiKhamChuaBenhTrongGoiDichVuVo.MucHuongBaoHiem = chiPhiGiuongBHYT.MucHuongBaoHiem.GetValueOrDefault();
                    //chiPhiKhamChuaBenhTrongGoiDichVuVo.MaSoTheBHYT = chiPhiGiuongBHYT.MaSoTheBHYT ?? string.Empty;
                    //chiPhiKhamChuaBenhTrongGoiDichVuVo.YeuCauDichVuGiuongBenhVienChiPhiBHYTIds = new List<long> { chiPhiGiuongBHYT.Id };
                }
            }
            dsDichVuTrongGoiCoBHYTChuaQT.AddRange(queryDichVuGiuongChiPhiBenhVien);

            foreach (var chiPhiTrongGoi in dsDichVuTrongGoiCoBHYTChuaQT)
            {
                var congTyBaoHiemTuNhanBaoLanh = yeuCauTiepNhan.YeuCauTiepNhanCongTyBaoHiemTuNhans.FirstOrDefault(o => GetChuongTrinhGoiDichVuBHTNBaoLanhs().Any(ct => ct.CongTyBaoHiemTuNhanId == o.CongTyBaoHiemTuNhanId && ct.Id == chiPhiTrongGoi.ChuongTrinhGoiDichVuId));

                if (congTyBaoHiemTuNhanBaoLanh != null)
                {
                    chiPhiTrongGoi.DanhSachCongNoChoThus.Add(new DanhSachCongNoVo { CongTyBaoHiemTuNhanId = congTyBaoHiemTuNhanBaoLanh.CongTyBaoHiemTuNhanId, SoTienCongNoChoThu = chiPhiTrongGoi.SoTienQuyetToan });
                }
            }

            return dsDichVuTrongGoiCoBHYTChuaQT;
        }
        public List<ChiPhiKhamChuaBenhTrongGoiDichVuVo> OldGetDanhSachDichVuTrongGoiCoBHYTChuaQuyetToanNoiTru(long yeuCauTiepNhanId)
        {
            var yeuCauTiepNhan = BaseRepository.GetById(yeuCauTiepNhanId,
                x => x.Include(o => o.CongTyUuDai)
                    .Include(o => o.YeuCauKhamBenhs)
                    .Include(o => o.YeuCauDichVuKyThuats)
                    .Include(o => o.YeuCauKhamBenhs).ThenInclude(o => o.DichVuKhamBenhBenhVien)
                    .Include(o => o.YeuCauKhamBenhs).ThenInclude(o => o.YeuCauGoiDichVu)
                    .Include(o => o.YeuCauKhamBenhs).ThenInclude(o => o.NhomGiaDichVuKhamBenhBenhVien)
                    .Include(o => o.YeuCauKhamBenhs).ThenInclude(o => o.NoiDangKy)
                    .Include(o => o.YeuCauKhamBenhs).ThenInclude(o => o.BacSiDangKy).ThenInclude(o => o.User)
                    .Include(o => o.YeuCauDichVuKyThuats).ThenInclude(o => o.DichVuKyThuatBenhVien)
                    .Include(o => o.YeuCauDichVuKyThuats).ThenInclude(o => o.YeuCauGoiDichVu)
                    .Include(o => o.YeuCauDichVuKyThuats).ThenInclude(o => o.NhomGiaDichVuKyThuatBenhVien)
                    .Include(o => o.YeuCauDichVuKyThuats).ThenInclude(o => o.NoiThucHien)
                    .Include(o => o.NoiTruBenhAn)
                    .Include(o => o.YeuCauTiepNhanTheBHYTs)
                    .Include(o => o.YeuCauTiepNhanCongTyBaoHiemTuNhans)
                    .Include(o => o.YeuCauDichVuGiuongBenhVienChiPhiBenhViens).ThenInclude(o => o.YeuCauDichVuGiuongBenhVienChiPhiBHYTs)
                    .Include(o => o.YeuCauDichVuGiuongBenhVienChiPhiBenhViens).ThenInclude(o => o.YeuCauGoiDichVu)
                    .Include(o => o.YeuCauDichVuGiuongBenhVienChiPhiBenhViens).ThenInclude(o => o.NhomGiaDichVuGiuongBenhVien)
                    .Include(o => o.YeuCauDichVuGiuongBenhVienChiPhiBenhViens).ThenInclude(gb => gb.PhongBenhVien));

            long? yeuCauTiepNhanNgoaiTruCanQuyetToanId = yeuCauTiepNhan.YeuCauTiepNhanNgoaiTruCanQuyetToanId;
            YeuCauTiepNhan yeuCauTiepNhanNgoaiTruCanQuyetToan = null;
            if (yeuCauTiepNhanNgoaiTruCanQuyetToanId != null)
            {
                yeuCauTiepNhanNgoaiTruCanQuyetToan = BaseRepository.GetById(yeuCauTiepNhanNgoaiTruCanQuyetToanId.Value,
                    x => x.Include(o => o.CongTyUuDai)
                        .Include(o => o.YeuCauTiepNhanCongTyBaoHiemTuNhans)
                        .Include(o => o.YeuCauKhamBenhs)
                        .Include(o => o.YeuCauDichVuKyThuats)
                        .Include(o => o.YeuCauKhamBenhs).ThenInclude(o => o.DichVuKhamBenhBenhVien)
                        .Include(o => o.YeuCauKhamBenhs).ThenInclude(o => o.YeuCauGoiDichVu)
                        .Include(o => o.YeuCauKhamBenhs).ThenInclude(o => o.NhomGiaDichVuKhamBenhBenhVien)
                        .Include(o => o.YeuCauKhamBenhs).ThenInclude(o => o.NoiDangKy)
                        .Include(o => o.YeuCauKhamBenhs).ThenInclude(o => o.BacSiDangKy).ThenInclude(o => o.User)
                        .Include(o => o.YeuCauDichVuKyThuats).ThenInclude(o => o.DichVuKyThuatBenhVien)
                        .Include(o => o.YeuCauDichVuKyThuats).ThenInclude(o => o.YeuCauGoiDichVu)
                        .Include(o => o.YeuCauDichVuKyThuats).ThenInclude(o => o.NhomGiaDichVuKyThuatBenhVien)
                        .Include(o => o.YeuCauDichVuKyThuats).ThenInclude(o => o.NoiThucHien));
            }

            var dsDichVuTrongGoiCoBHYTChuaQT = new List<ChiPhiKhamChuaBenhTrongGoiDichVuVo>();
            if (yeuCauTiepNhanNgoaiTruCanQuyetToan != null)
            {
                dsDichVuTrongGoiCoBHYTChuaQT.AddRange(yeuCauTiepNhanNgoaiTruCanQuyetToan.YeuCauKhamBenhs.Where(o =>
                o.TrangThai != Enums.EnumTrangThaiYeuCauKhamBenh.HuyKham &&
                o.TrangThaiThanhToan != Enums.TrangThaiThanhToan.DaThanhToan && o.YeuCauGoiDichVuId != null)
                .Select(s => new ChiPhiKhamChuaBenhTrongGoiDichVuVo
                {
                    Id = s.Id,
                    YeuCauGoiDichVuId = s.YeuCauGoiDichVuId.Value,
                    ChuongTrinhGoiDichVuId = s.YeuCauGoiDichVu.ChuongTrinhGoiDichVuId,
                    TenChuongTrinhGoiDichVu = s.YeuCauGoiDichVu.TenChuongTrinh,
                    NgayPhatSinh = s.ThoiDiemChiDinh,
                    LoaiNhom = NhomChiPhiKhamChuaBenh.DichVuKhamBenh,
                    Ma = s.DichVuKhamBenhBenhVien.Ma,
                    TenDichVu = s.DichVuKhamBenhBenhVien.Ten,
                    LoaiGia = s.NhomGiaDichVuKhamBenhBenhVien.Ten,
                    Soluong = 1,
                    DonGia = s.DonGiaSauChietKhau.GetValueOrDefault(),
                    DonGiaBHYT = s.DonGiaBaoHiem.GetValueOrDefault(),
                    KiemTraBHYTXacNhan = s.BaoHiemChiTra != null,
                    DuocHuongBHYT = s.DuocHuongBaoHiem,
                    TiLeBaoHiemThanhToan = s.TiLeBaoHiemThanhToan.GetValueOrDefault(),
                    MucHuongBaoHiem = s.MucHuongBaoHiem.GetValueOrDefault(),
                    NoiThucHien = (s.NoiDangKy != null ? $"{s.NoiDangKy.Ma}" : "") + (s.BacSiDangKy != null && s.BacSiDangKy.User.HoTen != null ? " - " + $"{s.BacSiDangKy.User.HoTen}" : ""),
                    CheckedDefault = true,
                }));

                dsDichVuTrongGoiCoBHYTChuaQT.AddRange(yeuCauTiepNhanNgoaiTruCanQuyetToan.YeuCauDichVuKyThuats.Where(o =>
                        o.TrangThai != Enums.EnumTrangThaiYeuCauDichVuKyThuat.DaHuy &&
                        o.TrangThaiThanhToan != Enums.TrangThaiThanhToan.DaThanhToan && o.YeuCauGoiDichVuId != null)
                    .Select(s => new ChiPhiKhamChuaBenhTrongGoiDichVuVo
                    {
                        Id = s.Id,
                        YeuCauGoiDichVuId = s.YeuCauGoiDichVuId.Value,
                        ChuongTrinhGoiDichVuId = s.YeuCauGoiDichVu.ChuongTrinhGoiDichVuId,
                        TenChuongTrinhGoiDichVu = s.YeuCauGoiDichVu.TenChuongTrinh,
                        NgayPhatSinh = s.ThoiDiemChiDinh,
                        LoaiNhom = NhomChiPhiKhamChuaBenh.DichVuKyThuat,
                        Ma = s.DichVuKyThuatBenhVien.Ma,
                        TenDichVu = s.DichVuKyThuatBenhVien.Ten,
                        LoaiGia = s.NhomGiaDichVuKyThuatBenhVien.Ten,
                        Soluong = s.SoLan,
                        DonGia = s.DonGiaSauChietKhau.GetValueOrDefault(),
                        DonGiaBHYT = s.DonGiaBaoHiem.GetValueOrDefault(),
                        KiemTraBHYTXacNhan = s.BaoHiemChiTra != null,
                        DuocHuongBHYT = s.DuocHuongBaoHiem,
                        TiLeBaoHiemThanhToan = s.TiLeBaoHiemThanhToan.GetValueOrDefault(),
                        MucHuongBaoHiem = s.MucHuongBaoHiem.GetValueOrDefault(),
                        NoiThucHien = s.NoiThucHien != null ? $"{s.NoiThucHien.Ma} - {s.NoiThucHien.Ten}" : string.Empty,
                        CheckedDefault = true,
                    }));
            }

            dsDichVuTrongGoiCoBHYTChuaQT.AddRange(yeuCauTiepNhan.YeuCauDichVuKyThuats.Where(o =>
                    o.TrangThai != Enums.EnumTrangThaiYeuCauDichVuKyThuat.DaHuy &&
                    o.TrangThaiThanhToan != Enums.TrangThaiThanhToan.DaThanhToan && o.YeuCauGoiDichVuId != null)
                .Select(s => new ChiPhiKhamChuaBenhTrongGoiDichVuVo
                {
                    Id = s.Id,
                    YeuCauGoiDichVuId = s.YeuCauGoiDichVuId.Value,
                    ChuongTrinhGoiDichVuId = s.YeuCauGoiDichVu.ChuongTrinhGoiDichVuId,
                    TenChuongTrinhGoiDichVu = s.YeuCauGoiDichVu.TenChuongTrinh,
                    NgayPhatSinh = s.NoiTruPhieuDieuTri != null ? s.NoiTruPhieuDieuTri.NgayDieuTri : s.ThoiDiemChiDinh,
                    LoaiNhom = NhomChiPhiKhamChuaBenh.DichVuKyThuat,
                    Ma = s.DichVuKyThuatBenhVien.Ma,
                    TenDichVu = s.DichVuKyThuatBenhVien.Ten,
                    LoaiGia = s.NhomGiaDichVuKyThuatBenhVien.Ten,
                    Soluong = s.SoLan,
                    DonGia = s.DonGiaSauChietKhau.GetValueOrDefault(),
                    DonGiaBHYT = s.DonGiaBaoHiem.GetValueOrDefault(),
                    KiemTraBHYTXacNhan = s.BaoHiemChiTra != null,
                    DuocHuongBHYT = s.DuocHuongBaoHiem,
                    TiLeBaoHiemThanhToan = s.TiLeBaoHiemThanhToan.GetValueOrDefault(),
                    MucHuongBaoHiem = s.MucHuongBaoHiem.GetValueOrDefault(),
                    NoiThucHien = s.NoiThucHien != null
                        ? $"{s.NoiThucHien.Ma} - {s.NoiThucHien.Ten}"
                        : string.Empty,
                    CheckedDefault = true,
                }));

            dsDichVuTrongGoiCoBHYTChuaQT.AddRange(yeuCauTiepNhan.YeuCauDichVuGiuongBenhVienChiPhiBenhViens.Where(o =>
                   o.TrangThaiThanhToan != Enums.TrangThaiThanhToan.DaThanhToan && o.YeuCauGoiDichVuId != null)
               .Select(s => new ChiPhiKhamChuaBenhTrongGoiDichVuVo
               {
                   Id = s.Id,
                   YeuCauGoiDichVuId = s.YeuCauGoiDichVuId.Value,
                   TenChuongTrinhGoiDichVu = s.YeuCauGoiDichVu.TenChuongTrinh,
                   NgayPhatSinh = s.NgayPhatSinh,
                   LoaiNhom = NhomChiPhiKhamChuaBenh.DichVuGiuong,
                   Ma = s.Ma,
                   TenDichVu = s.Ten,
                   LoaiGia = s.NhomGiaDichVuGiuongBenhVien.Ten,
                   Soluong = s.SoLuong,
                   DonGia = s.DonGiaSauChietKhau.GetValueOrDefault(),
                   DonGiaBHYT = s.YeuCauDichVuGiuongBenhVienChiPhiBHYTs.FirstOrDefault()?.DonGiaBaoHiem ?? 0,
                   KiemTraBHYTXacNhan = s.YeuCauDichVuGiuongBenhVienChiPhiBHYTs.FirstOrDefault()?.BaoHiemChiTra != null,
                   DuocHuongBHYT = s.YeuCauDichVuGiuongBenhVienChiPhiBHYTs.FirstOrDefault()?.DuocHuongBaoHiem ?? false,
                   TiLeBaoHiemThanhToan = s.YeuCauDichVuGiuongBenhVienChiPhiBHYTs.FirstOrDefault()?.TiLeBaoHiemThanhToan ?? 0,
                   MucHuongBaoHiem = s.YeuCauDichVuGiuongBenhVienChiPhiBHYTs.FirstOrDefault()?.MucHuongBaoHiem ?? 0,
                   NoiThucHien = s.PhongBenhVien != null ? $"{s.PhongBenhVien.Ma} - {s.PhongBenhVien.Ten}" : string.Empty,
                   CheckedDefault = true,
               }));

            foreach (var chiPhiTrongGoi in dsDichVuTrongGoiCoBHYTChuaQT)
            {
                var congTyBaoHiemTuNhanBaoLanh = yeuCauTiepNhan.YeuCauTiepNhanCongTyBaoHiemTuNhans.FirstOrDefault(o => GetChuongTrinhGoiDichVuBHTNBaoLanhs().Any(ct => ct.CongTyBaoHiemTuNhanId == o.CongTyBaoHiemTuNhanId && ct.Id == chiPhiTrongGoi.ChuongTrinhGoiDichVuId));

                if (congTyBaoHiemTuNhanBaoLanh != null)
                {

                    chiPhiTrongGoi.DanhSachCongNoChoThus.Add(new DanhSachCongNoVo { CongTyBaoHiemTuNhanId = congTyBaoHiemTuNhanBaoLanh.CongTyBaoHiemTuNhanId, SoTienCongNoChoThu = chiPhiTrongGoi.SoTienQuyetToan });

                }
                //xoa BHTN va mien giam khi sl = 0
                if (chiPhiTrongGoi.Soluong.AlmostEqual(0))
                {
                    chiPhiTrongGoi.DanhSachCongNoChoThus = new List<DanhSachCongNoVo>();
                }
            }

            return dsDichVuTrongGoiCoBHYTChuaQT;
        }

        public async Task<KetQuaQuyetToanDichVuTrongGoiCoBHYT> QuyetToanDichVuTrongGoiCoBHYTNoiTru(QuyetToanDichVuTrongGoiVo chiTienQuyetToan)
        {
            var ycTiepNhan = BaseRepository.GetById(chiTienQuyetToan.Id,
                x => x.Include(o => o.CongTyUuDai)
                    .Include(o => o.BenhNhan).ThenInclude(o => o.TaiKhoanBenhNhan)
                    .Include(o => o.YeuCauKhamBenhs).ThenInclude(o => o.CongTyBaoHiemTuNhanCongNos)
                    .Include(o => o.YeuCauDichVuKyThuats).ThenInclude(o => o.CongTyBaoHiemTuNhanCongNos)
                    .Include(o => o.YeuCauKhamBenhs).ThenInclude(o => o.DichVuKhamBenhBenhVien)
                    .Include(o => o.YeuCauKhamBenhs).ThenInclude(o => o.NhomGiaDichVuKhamBenhBenhVien)
                    .Include(o => o.YeuCauKhamBenhs).ThenInclude(o => o.NoiDangKy)
                    .Include(o => o.YeuCauKhamBenhs).ThenInclude(o => o.BacSiDangKy).ThenInclude(o => o.User)
                    .Include(o => o.YeuCauDichVuKyThuats).ThenInclude(o => o.DichVuKyThuatBenhVien)
                    .Include(o => o.YeuCauDichVuKyThuats).ThenInclude(o => o.NhomGiaDichVuKyThuatBenhVien)
                    .Include(o => o.YeuCauDichVuKyThuats).ThenInclude(o => o.NoiThucHien)
                    .Include(o => o.YeuCauTruyenMaus)
                    .Include(o => o.YeuCauDuocPhamBenhViens)
                    .Include(o => o.YeuCauVatTuBenhViens)
                    .Include(o => o.NoiTruBenhAn)
                    .Include(o => o.HoatDongGiuongBenhs)
                    .Include(o => o.YeuCauTiepNhanTheBHYTs)
                    .Include(o => o.YeuCauDichVuGiuongBenhVienChiPhiBenhViens).ThenInclude(o => o.CongTyBaoHiemTuNhanCongNos)
                    .Include(o => o.YeuCauDichVuGiuongBenhVienChiPhiBenhViens).ThenInclude(o => o.YeuCauDichVuGiuongBenhVienChiPhiBHYTs)
                    .Include(o => o.YeuCauDichVuGiuongBenhVienChiPhiBenhViens).ThenInclude(o => o.NhomGiaDichVuGiuongBenhVien)
                    .Include(o => o.YeuCauDichVuGiuongBenhVienChiPhiBenhViens).ThenInclude(gb => gb.PhongBenhVien));

            long? yeuCauTiepNhanNgoaiTruCanQuyetToanId = ycTiepNhan.YeuCauTiepNhanNgoaiTruCanQuyetToanId;
            YeuCauTiepNhan yeuCauTiepNhanNgoaiTruCanQuyetToan = null;
            if (yeuCauTiepNhanNgoaiTruCanQuyetToanId != null)
            {
                yeuCauTiepNhanNgoaiTruCanQuyetToan = await BaseRepository.GetByIdAsync(yeuCauTiepNhanNgoaiTruCanQuyetToanId.Value,
                    x => x.Include(o => o.CongTyUuDai)
                        .Include(o => o.YeuCauKhamBenhs).ThenInclude(o => o.CongTyBaoHiemTuNhanCongNos)
                        .Include(o => o.YeuCauDichVuKyThuats).ThenInclude(o => o.CongTyBaoHiemTuNhanCongNos)
                        .Include(o => o.YeuCauDuocPhamBenhViens)
                        .Include(o => o.YeuCauVatTuBenhViens)
                        .Include(o => o.YeuCauKhamBenhs).ThenInclude(o => o.DichVuKhamBenhBenhVien)
                        .Include(o => o.YeuCauKhamBenhs).ThenInclude(o => o.NhomGiaDichVuKhamBenhBenhVien)
                        .Include(o => o.YeuCauKhamBenhs).ThenInclude(o => o.NoiDangKy)
                        .Include(o => o.YeuCauKhamBenhs).ThenInclude(o => o.BacSiDangKy).ThenInclude(o => o.User)
                        .Include(o => o.YeuCauDichVuKyThuats).ThenInclude(o => o.DichVuKyThuatBenhVien)
                        .Include(o => o.YeuCauDichVuKyThuats).ThenInclude(o => o.NhomGiaDichVuKyThuatBenhVien)
                        .Include(o => o.YeuCauDichVuKyThuats).ThenInclude(o => o.NoiThucHien));
            }
            var congTyBaoHiemTuNhanIds = ycTiepNhan.YeuCauTiepNhanCongTyBaoHiemTuNhans.Select(cty => cty.CongTyBaoHiemTuNhanId);
            if (yeuCauTiepNhanNgoaiTruCanQuyetToan == null)
            {
                var ycKyThuatExcept = chiTienQuyetToan.DanhSachChiPhiKhamChuaBenhTrongGoiDichVus
                    .Where(o => o.LoaiNhom == NhomChiPhiKhamChuaBenh.DichVuKyThuat).Select(o => o.Id).Except(ycTiepNhan
                        .YeuCauDichVuKyThuats
                        .Where(o => o.TrangThai != EnumTrangThaiYeuCauDichVuKyThuat.DaHuy && o.TrangThaiThanhToan != Enums.TrangThaiThanhToan.DaThanhToan && o.YeuCauGoiDichVuId != null)
                        .Select(o => o.Id));
                var ycGiuongExcept = chiTienQuyetToan.DanhSachChiPhiKhamChuaBenhTrongGoiDichVus
                    .Where(o => o.LoaiNhom == NhomChiPhiKhamChuaBenh.DichVuGiuong).Select(o => o.Id).Except(ycTiepNhan
                        .YeuCauDichVuGiuongBenhVienChiPhiBenhViens
                        .Where(o => o.YeuCauGoiDichVuId != null && o.TrangThaiThanhToan != Enums.TrangThaiThanhToan.DaThanhToan)
                        .Select(o => o.Id));

                if (ycKyThuatExcept.Any() || ycGiuongExcept.Any())
                    return new KetQuaQuyetToanDichVuTrongGoiCoBHYT { Error = "Thông tin dịch vụ thanh toán không hợp lệ, vui lòng tải lại trang" };
            }
            else
            {
                var ycKhamBenhExcept = chiTienQuyetToan.DanhSachChiPhiKhamChuaBenhTrongGoiDichVus
                .Where(o => o.LoaiNhom == NhomChiPhiKhamChuaBenh.DichVuKhamBenh).Select(o => o.Id).Except(yeuCauTiepNhanNgoaiTruCanQuyetToan
                            .YeuCauKhamBenhs
                            .Where(o => o.TrangThai != EnumTrangThaiYeuCauKhamBenh.HuyKham && o.TrangThaiThanhToan != Enums.TrangThaiThanhToan.DaThanhToan && o.YeuCauGoiDichVuId != null)
                            .Select(o => o.Id));
                var ycKyThuatExcept = chiTienQuyetToan.DanhSachChiPhiKhamChuaBenhTrongGoiDichVus
                    .Where(o => o.LoaiNhom == NhomChiPhiKhamChuaBenh.DichVuKyThuat).Select(o => o.Id).Except(ycTiepNhan
                        .YeuCauDichVuKyThuats
                        .Where(o => o.TrangThai != EnumTrangThaiYeuCauDichVuKyThuat.DaHuy && o.TrangThaiThanhToan != Enums.TrangThaiThanhToan.DaThanhToan && o.YeuCauGoiDichVuId != null)
                        .Select(o => o.Id)
                        .Concat(yeuCauTiepNhanNgoaiTruCanQuyetToan.YeuCauDichVuKyThuats
                            .Where(o => o.TrangThai != EnumTrangThaiYeuCauDichVuKyThuat.DaHuy && o.TrangThaiThanhToan != Enums.TrangThaiThanhToan.DaThanhToan && o.YeuCauGoiDichVuId != null)
                            .Select(o => o.Id)));
                var ycGiuongExcept = chiTienQuyetToan.DanhSachChiPhiKhamChuaBenhTrongGoiDichVus
                    .Where(o => o.LoaiNhom == NhomChiPhiKhamChuaBenh.DichVuGiuong).Select(o => o.Id).Except(ycTiepNhan
                        .YeuCauDichVuGiuongBenhVienChiPhiBenhViens
                        .Where(o => o.YeuCauGoiDichVuId != null && o.TrangThaiThanhToan != Enums.TrangThaiThanhToan.DaThanhToan)
                        .Select(o => o.Id));

                if (ycKhamBenhExcept.Any() || ycKyThuatExcept.Any() || ycGiuongExcept.Any())
                    return new KetQuaQuyetToanDichVuTrongGoiCoBHYT { Error = "Thông tin dịch vụ thanh toán không hợp lệ, vui lòng tải lại trang" };
            }

            if (!chiTienQuyetToan.TienMat.GetValueOrDefault().Equals(Math.Round(chiTienQuyetToan.DanhSachChiPhiKhamChuaBenhTrongGoiDichVus.Sum(o => o.SoTienQuyetToan), MidpointRounding.AwayFromZero)))
                return new KetQuaQuyetToanDichVuTrongGoiCoBHYT { Error = "Số tiền thanh toán không hợp lệ" };

            var goiDvIds = chiTienQuyetToan.DanhSachChiPhiKhamChuaBenhTrongGoiDichVus.Select(o => o.YeuCauGoiDichVuId).Distinct();
            var goiDvs = await _yeuCauGoiDichVuRepository.Table.Where(o => goiDvIds.Contains(o.Id)).Include(o => o.ChuongTrinhGoiDichVu)
                .Include(o => o.TaiKhoanBenhNhanThus).Include(o => o.TaiKhoanBenhNhanChis).ToListAsync();

            //foreach (var goiDvId in goiDvIds)
            //{
            //    var goiDv = goiDvs.First(o => o.Id == goiDvId);
            //    //update BVHD-3584
            //    //var soTienDaQuyetToan = goiDv.TaiKhoanBenhNhanThus
            //    //    .Where(o => o.DaHuy != true && o.LoaiThuTienBenhNhan == Enums.LoaiThuTienBenhNhan.ThuTheoChiPhi && o.ThuTienGoiDichVu == true)
            //    //    .Select(o => o.TamUng.GetValueOrDefault()).DefaultIfEmpty().Sum();
            //    var soTienQuyetToan = chiTienQuyetToan.DanhSachChiPhiKhamChuaBenhTrongGoiDichVus.Where(o => o.YeuCauGoiDichVuId == goiDv.Id)
            //        .Select(o => o.SoTienQuyetToan).DefaultIfEmpty().Sum();
            //    if (goiDv.SoTienBenhNhanDaChi.GetValueOrDefault() < soTienQuyetToan)
            //    {
            //        return new KetQuaQuyetToanDichVuTrongGoiCoBHYT { Error = $"Số tiền đã tạm ứng trong gói {goiDv.TenChuongTrinh} không đủ quyết toán" };
            //    }
            //}

            var userId = _userAgentHelper.GetCurrentUserId();
            var userThuNgan = _userRepository.GetById(_userAgentHelper.GetCurrentUserId());
            var maTaiKhoan = userId.ToString();
            if (userThuNgan.Email != null && userThuNgan.Email.IndexOf("@") > 0)
            {
                maTaiKhoan = userThuNgan.Email.Substring(0, userThuNgan.Email.IndexOf("@") > 10 ? 10 : userThuNgan.Email.IndexOf("@"));
            }
            var tk = ycTiepNhan.BenhNhan.TaiKhoanBenhNhan ?? new TaiKhoanBenhNhan
            {
                BenhNhan = ycTiepNhan.BenhNhan,
                SoDuTaiKhoan = 0
            };
            var thuPhi = new TaiKhoanBenhNhanThu
            {
                TaiKhoanBenhNhan = tk,
                LoaiThuTienBenhNhan = Enums.LoaiThuTienBenhNhan.ThuTheoChiPhi,
                ThuTienGoiDichVu = true,
                LoaiNoiThu = Enums.LoaiNoiThu.ThuNgan,
                NoiDungThu = chiTienQuyetToan.NoiDungThu,
                NgayThu = chiTienQuyetToan.NgayThu,
                //update BVHD-3584
                TamUng = 0,
                //TamUng = chiTienQuyetToan.TienMat.GetValueOrDefault(),
                SoPhieuHienThi = ResourceHelper.CreateSoPhieuThu(userId, maTaiKhoan),
                NhanVienThucHienId = _userAgentHelper.GetCurrentUserId(),
                NoiThucHienId = _userAgentHelper.GetCurrentNoiLLamViecId()
            };
            foreach (var goiDv in goiDvs)
            {
                decimal tamUngTheoGoi = 0;
                if (goiDv.ChuongTrinhGoiDichVu?.CongTyBaoHiemTuNhanId != null)
                    continue;

                var soTienQuyetToan = chiTienQuyetToan.DanhSachChiPhiKhamChuaBenhTrongGoiDichVus.Where(o => o.YeuCauGoiDichVuId == goiDv.Id)
                    .Select(o => o.SoTienQuyetToan).DefaultIfEmpty().Sum();

                if (soTienQuyetToan > 0)
                {
                    var phieuHoanUng = new TaiKhoanBenhNhanChi
                    {
                        TaiKhoanBenhNhan = tk,
                        LoaiChiTienBenhNhan = Enums.LoaiChiTienBenhNhan.HoanUng,
                        YeuCauGoiDichVuId = goiDv.Id,
                        TienMat = soTienQuyetToan,
                        NoiDungChi = Enums.LoaiChiTienBenhNhan.HoanUng.GetDescription(),
                        NgayChi = thuPhi.NgayThu.AddMilliseconds(-1),
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        SoPhieuHienThi = ResourceHelper.CreateSoHoanUng(),
                        NhanVienThucHienId = _userAgentHelper.GetCurrentUserId(),
                        NoiThucHienId = _userAgentHelper.GetCurrentNoiLLamViecId()
                    };
                    thuPhi.TaiKhoanBenhNhanChis.Add(phieuHoanUng);
                    //update BVHD-3584
                    thuPhi.TamUng = thuPhi.TamUng.GetValueOrDefault() + soTienQuyetToan;
                    tamUngTheoGoi += soTienQuyetToan;
                }
                //hoan BHYT
                var soTienQBHYTTrongGoi = Math.Round(chiTienQuyetToan.DanhSachChiPhiKhamChuaBenhTrongGoiDichVus.Where(o => o.YeuCauGoiDichVuId == goiDv.Id).Select(o => o.BHYTThanhToan).DefaultIfEmpty().Sum(), MidpointRounding.AwayFromZero);
                if (!soTienQBHYTTrongGoi.AlmostEqual(0))
                {
                    var phieuHoanUngTrongGoi = new TaiKhoanBenhNhanChi
                    {
                        TaiKhoanBenhNhan = tk,
                        LoaiChiTienBenhNhan = Enums.LoaiChiTienBenhNhan.HoanUng,
                        YeuCauGoiDichVuId = goiDv.Id,
                        TienMat = soTienQBHYTTrongGoi,
                        NoiDungChi = Enums.LoaiChiTienBenhNhan.HoanUng.GetDescription() + " BHYT",
                        NgayChi = thuPhi.NgayThu.AddMilliseconds(-1),
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        SoPhieuHienThi = ResourceHelper.CreateSoHoanUng(),
                        NhanVienThucHienId = _userAgentHelper.GetCurrentUserId(),
                        NoiThucHienId = _userAgentHelper.GetCurrentNoiLLamViecId()
                    };
                    thuPhi.TaiKhoanBenhNhanChis.Add(phieuHoanUngTrongGoi);
                    //update BVHD-3584
                    thuPhi.TamUng = thuPhi.TamUng.GetValueOrDefault() + soTienQBHYTTrongGoi;
                    tamUngTheoGoi += soTienQBHYTTrongGoi;
                }
                //hoan BHTN
                var soTienBHTNTrongGoi = Math.Round(chiTienQuyetToan.DanhSachChiPhiKhamChuaBenhTrongGoiDichVus.Where(o => o.YeuCauGoiDichVuId == goiDv.Id).Select(o => o.TongCongNo).DefaultIfEmpty().Sum(), MidpointRounding.AwayFromZero);
                if (!soTienBHTNTrongGoi.AlmostEqual(0))
                {
                    var phieuHoanUngTrongGoi = new TaiKhoanBenhNhanChi
                    {
                        TaiKhoanBenhNhan = tk,
                        LoaiChiTienBenhNhan = Enums.LoaiChiTienBenhNhan.HoanUng,
                        YeuCauGoiDichVuId = goiDv.Id,
                        TienMat = soTienBHTNTrongGoi,
                        NoiDungChi = Enums.LoaiChiTienBenhNhan.HoanUng.GetDescription() + " BHTN",
                        NgayChi = thuPhi.NgayThu.AddMilliseconds(-1),
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        SoPhieuHienThi = ResourceHelper.CreateSoHoanUng(),
                        NhanVienThucHienId = _userAgentHelper.GetCurrentUserId(),
                        NoiThucHienId = _userAgentHelper.GetCurrentNoiLLamViecId()
                    };
                    thuPhi.TaiKhoanBenhNhanChis.Add(phieuHoanUngTrongGoi);
                    //update BVHD-3584
                    thuPhi.TamUng = thuPhi.TamUng.GetValueOrDefault() + soTienBHTNTrongGoi;
                    tamUngTheoGoi += soTienBHTNTrongGoi;
                }
                var soTienDaHoan = goiDv.TaiKhoanBenhNhanChis.Where(o =>
                        o.CreatedOn != null && o.LoaiChiTienBenhNhan == Enums.LoaiChiTienBenhNhan.HoanUng && o.TaiKhoanBenhNhanThuId != null &&
                        o.DaHuy != true)
                    .Select(o => o.TienMat.GetValueOrDefault()).DefaultIfEmpty().Sum();

                if (goiDv.SoTienBenhNhanDaChi.GetValueOrDefault() + 100 < tamUngTheoGoi + soTienDaHoan)
                {
                    return new KetQuaQuyetToanDichVuTrongGoiCoBHYT { Error = $"Số tiền đã tạm ứng trong gói {goiDv.TenChuongTrinh} không đủ quyết toán" };
                }
            }

            foreach (var chiphi in chiTienQuyetToan.DanhSachChiPhiKhamChuaBenhTrongGoiDichVus.Where(o => o.LoaiNhom == NhomChiPhiKhamChuaBenh.DichVuKhamBenh))
            {
                var yc = yeuCauTiepNhanNgoaiTruCanQuyetToan?.YeuCauKhamBenhs?.First(o => o.Id == chiphi.Id);

                foreach (var ycCongTyBaoHiemTuNhanCongNo in yc.CongTyBaoHiemTuNhanCongNos.Where(o => o.TaiKhoanBenhNhanThuId == null))
                {
                    ycCongTyBaoHiemTuNhanCongNo.WillDelete = true;
                }
                if (chiphi.TongCongNo > 0)
                {
                    foreach (var chiphiDanhSachCongNoChoThu in chiphi.DanhSachCongNoChoThus)
                    {
                        if (chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu.AlmostEqual(0))
                            continue;
                        yc.CongTyBaoHiemTuNhanCongNos.Add(new CongTyBaoHiemTuNhanCongNo
                        {
                            TaiKhoanBenhNhanThu = thuPhi,
                            CongTyBaoHiemTuNhanId = chiphiDanhSachCongNoChoThu.CongTyBaoHiemTuNhanId,
                            SoTien = chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu
                        });
                    }
                }
                yc.SoTienBaoHiemTuNhanChiTra = chiphi.TongCongNo;

                yc.SoTienBenhNhanDaChi = chiphi.SoTienQuyetToan;
                yc.TrangThaiThanhToan = Enums.TrangThaiThanhToan.DaThanhToan;
                thuPhi.TaiKhoanBenhNhanChis.Add(new TaiKhoanBenhNhanChi
                {
                    TaiKhoanBenhNhan = tk,
                    LoaiChiTienBenhNhan = Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi,
                    TienChiPhi = yc.SoTienBenhNhanDaChi,
                    NoiDungChi = Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi.GetDescription(),
                    NgayChi = DateTime.Now,
                    SoPhieuHienThi = thuPhi.SoPhieuHienThi,
                    YeuCauKhamBenh = yc,
                    Gia = yc.DonGiaSauChietKhau.GetValueOrDefault(),
                    SoLuong = 1,
                    DonGiaBaoHiem = yc.DonGiaBaoHiem,
                    MucHuongBaoHiem = yc.DuocHuongBaoHiem ? yc.MucHuongBaoHiem : 0,
                    TiLeBaoHiemThanhToan = yc.TiLeBaoHiemThanhToan,
                    SoTienMienGiam = yc.SoTienMienGiam,
                    SoTienBaoHiemTuNhanChiTra = yc.SoTienBaoHiemTuNhanChiTra,
                    YeuCauTiepNhanId = ycTiepNhan.Id,
                    NhanVienThucHienId = _userAgentHelper.GetCurrentUserId(),
                    NoiThucHienId = _userAgentHelper.GetCurrentNoiLLamViecId()
                });
            }
            foreach (var chiphi in chiTienQuyetToan.DanhSachChiPhiKhamChuaBenhTrongGoiDichVus.Where(o => o.LoaiNhom == NhomChiPhiKhamChuaBenh.DichVuKyThuat))
            {
                var yc = yeuCauTiepNhanNgoaiTruCanQuyetToan?.YeuCauDichVuKyThuats?.FirstOrDefault(o => o.Id == chiphi.Id) ?? ycTiepNhan.YeuCauDichVuKyThuats.FirstOrDefault(o => o.Id == chiphi.Id);

                foreach (var ycCongTyBaoHiemTuNhanCongNo in yc.CongTyBaoHiemTuNhanCongNos.Where(o => o.TaiKhoanBenhNhanThuId == null))
                {
                    ycCongTyBaoHiemTuNhanCongNo.WillDelete = true;
                }
                if (chiphi.TongCongNo > 0)
                {
                    foreach (var chiphiDanhSachCongNoChoThu in chiphi.DanhSachCongNoChoThus)
                    {
                        if (chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu.AlmostEqual(0))
                            continue;
                        yc.CongTyBaoHiemTuNhanCongNos.Add(new CongTyBaoHiemTuNhanCongNo
                        {
                            TaiKhoanBenhNhanThu = thuPhi,
                            CongTyBaoHiemTuNhanId = chiphiDanhSachCongNoChoThu.CongTyBaoHiemTuNhanId,
                            SoTien = chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu
                        });
                    }
                }
                yc.SoTienBaoHiemTuNhanChiTra = chiphi.TongCongNo;

                yc.SoTienBenhNhanDaChi = chiphi.SoTienQuyetToan;
                yc.TrangThaiThanhToan = Enums.TrangThaiThanhToan.DaThanhToan;
                thuPhi.TaiKhoanBenhNhanChis.Add(new TaiKhoanBenhNhanChi
                {
                    TaiKhoanBenhNhan = tk,
                    LoaiChiTienBenhNhan = Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi,
                    TienChiPhi = yc.SoTienBenhNhanDaChi,
                    NoiDungChi = Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi.GetDescription(),
                    NgayChi = DateTime.Now,
                    SoPhieuHienThi = thuPhi.SoPhieuHienThi,
                    YeuCauDichVuKyThuat = yc,
                    Gia = yc.DonGiaSauChietKhau.GetValueOrDefault(),
                    SoLuong = yc.SoLan,
                    DonGiaBaoHiem = yc.DonGiaBaoHiem,
                    MucHuongBaoHiem = yc.DuocHuongBaoHiem ? yc.MucHuongBaoHiem : 0,
                    TiLeBaoHiemThanhToan = yc.TiLeBaoHiemThanhToan,
                    SoTienMienGiam = yc.SoTienMienGiam,
                    SoTienBaoHiemTuNhanChiTra = yc.SoTienBaoHiemTuNhanChiTra,
                    YeuCauTiepNhanId = ycTiepNhan.Id,
                    NhanVienThucHienId = _userAgentHelper.GetCurrentUserId(),
                    NoiThucHienId = _userAgentHelper.GetCurrentNoiLLamViecId()
                });
            }
            foreach (var chiphi in chiTienQuyetToan.DanhSachChiPhiKhamChuaBenhTrongGoiDichVus.Where(o => o.LoaiNhom == NhomChiPhiKhamChuaBenh.DichVuGiuong))
            {
                var hoatDongGiuongs = ycTiepNhan.HoatDongGiuongBenhs.Where(c => c.ThoiDiemKetThuc == null);

                if (hoatDongGiuongs.Any())
                {
                    foreach (var hoatDongGiuong in hoatDongGiuongs)
                    {
                        hoatDongGiuong.ThoiDiemKetThuc = ycTiepNhan.NoiTruBenhAn.ThoiDiemRaVien;
                    }
                }

                var yc = ycTiepNhan.YeuCauDichVuGiuongBenhVienChiPhiBenhViens.First(o => o.Id == chiphi.Id);
                var chiPhiBHYT = yc.YeuCauDichVuGiuongBenhVienChiPhiBHYTs.FirstOrDefault(o => o.BaoHiemChiTra == true);

                foreach (var ycCongTyBaoHiemTuNhanCongNo in yc.CongTyBaoHiemTuNhanCongNos.Where(o => o.TaiKhoanBenhNhanThuId == null))
                {
                    ycCongTyBaoHiemTuNhanCongNo.WillDelete = true;
                }
                if (chiphi.TongCongNo > 0)
                {
                    foreach (var chiphiDanhSachCongNoChoThu in chiphi.DanhSachCongNoChoThus)
                    {
                        if (chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu.AlmostEqual(0))
                            continue;
                        yc.CongTyBaoHiemTuNhanCongNos.Add(new CongTyBaoHiemTuNhanCongNo
                        {
                            TaiKhoanBenhNhanThu = thuPhi,
                            CongTyBaoHiemTuNhanId = chiphiDanhSachCongNoChoThu.CongTyBaoHiemTuNhanId,
                            SoTien = chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu
                        });
                    }
                }
                yc.SoTienBaoHiemTuNhanChiTra = chiphi.TongCongNo;

                yc.SoTienBenhNhanDaChi = chiphi.SoTienQuyetToan;
                yc.TrangThaiThanhToan = Enums.TrangThaiThanhToan.DaThanhToan;
                thuPhi.TaiKhoanBenhNhanChis.Add(new TaiKhoanBenhNhanChi
                {
                    TaiKhoanBenhNhan = tk,
                    LoaiChiTienBenhNhan = Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi,
                    TienChiPhi = yc.SoTienBenhNhanDaChi,
                    NoiDungChi = Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi.GetDescription(),
                    NgayChi = DateTime.Now,
                    SoPhieuHienThi = thuPhi.SoPhieuHienThi,
                    YeuCauDichVuGiuongBenhVienChiPhiBenhVien = yc,
                    Gia = yc.DonGiaSauChietKhau.GetValueOrDefault(),
                    SoLuong = yc.SoLuong,
                    DonGiaBaoHiem = chiPhiBHYT?.DonGiaBaoHiem,
                    MucHuongBaoHiem = (chiPhiBHYT != null && chiPhiBHYT.DuocHuongBaoHiem) ? chiPhiBHYT?.MucHuongBaoHiem : 0,
                    TiLeBaoHiemThanhToan = chiPhiBHYT?.TiLeBaoHiemThanhToan,
                    SoTienMienGiam = yc.SoTienMienGiam,
                    SoTienBaoHiemTuNhanChiTra = yc.SoTienBaoHiemTuNhanChiTra,
                    YeuCauTiepNhanId = ycTiepNhan.Id,
                    NhanVienThucHienId = _userAgentHelper.GetCurrentUserId(),
                    NoiThucHienId = _userAgentHelper.GetCurrentNoiLLamViecId()
                });
            }

            ycTiepNhan.TaiKhoanBenhNhanThus.Add(thuPhi);

            //kiem tra dich vu ngoai goi da thanh toan
            if (ycTiepNhan.YeuCauKhamBenhs.All(o => o.TrangThai == Enums.EnumTrangThaiYeuCauKhamBenh.HuyKham || o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.DaThanhToan)
                && ycTiepNhan.YeuCauDichVuKyThuats.All(o => o.TrangThai == Enums.EnumTrangThaiYeuCauDichVuKyThuat.DaHuy || o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.DaThanhToan)
                && ycTiepNhan.YeuCauTruyenMaus.All(o => o.TrangThai == EnumTrangThaiYeuCauTruyenMau.DaHuy || o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.DaThanhToan)
                && ycTiepNhan.YeuCauDuocPhamBenhViens.All(o => o.TrangThai == EnumYeuCauDuocPhamBenhVien.DaHuy || o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.DaThanhToan)
                && ycTiepNhan.YeuCauVatTuBenhViens.All(o => o.TrangThai == EnumYeuCauVatTuBenhVien.DaHuy || o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.DaThanhToan)
                && ycTiepNhan.YeuCauDichVuGiuongBenhVienChiPhiBenhViens.All(o => o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.DaThanhToan)
                && (yeuCauTiepNhanNgoaiTruCanQuyetToan == null || (yeuCauTiepNhanNgoaiTruCanQuyetToan.YeuCauKhamBenhs.All(o => o.TrangThai == Enums.EnumTrangThaiYeuCauKhamBenh.HuyKham || o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.DaThanhToan)
                                                                    && yeuCauTiepNhanNgoaiTruCanQuyetToan.YeuCauDichVuKyThuats.All(o => o.TrangThai == EnumTrangThaiYeuCauDichVuKyThuat.DaHuy || o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.DaThanhToan)
                                                                    && yeuCauTiepNhanNgoaiTruCanQuyetToan.YeuCauDuocPhamBenhViens.All(o => o.TrangThai == EnumYeuCauDuocPhamBenhVien.DaHuy || o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.DaThanhToan)
                                                                    && yeuCauTiepNhanNgoaiTruCanQuyetToan.YeuCauVatTuBenhViens.All(o => o.TrangThai == EnumYeuCauVatTuBenhVien.DaHuy || o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.DaThanhToan))))
            {
                ycTiepNhan.NoiTruBenhAn.DaQuyetToan = true;
                ycTiepNhan.TrangThaiYeuCauTiepNhan = EnumTrangThaiYeuCauTiepNhan.DaHoanTat;
                if (yeuCauTiepNhanNgoaiTruCanQuyetToan != null)
                {
                    yeuCauTiepNhanNgoaiTruCanQuyetToan.TrangThaiYeuCauTiepNhan = EnumTrangThaiYeuCauTiepNhan.DaHoanTat;
                }
                else
                {
                    var yeuCauTiepNhanNgoaiTru = BaseRepository.Table.FirstOrDefault(o => o.MaYeuCauTiepNhan == ycTiepNhan.MaYeuCauTiepNhan && o.LoaiYeuCauTiepNhan == EnumLoaiYeuCauTiepNhan.KhamChuaBenhNgoaiTru);
                    if (yeuCauTiepNhanNgoaiTru != null)
                    {
                        yeuCauTiepNhanNgoaiTru.TrangThaiYeuCauTiepNhan = EnumTrangThaiYeuCauTiepNhan.DaHoanTat;
                    }
                }
            }

            //await BaseRepository.UpdateAsync(ycTiepNhan);
            BaseRepository.Context.SaveChanges();
            return new KetQuaQuyetToanDichVuTrongGoiCoBHYT { PhieuQuyetToanId = thuPhi.Id, PhieuHoanUngIds = thuPhi.TaiKhoanBenhNhanChis.Where(o => o.LoaiChiTienBenhNhan == Enums.LoaiChiTienBenhNhan.HoanUng).Select(o => o.Id).ToList() };
        }

        public async Task LuuTamChiPhiNoiTruTrongGoi(QuyetToanDichVuTrongGoiVo chiTienQuyetToan)
        {
            var ycTiepNhan = BaseRepository.GetById(chiTienQuyetToan.Id,
                x => x.Include(o => o.CongTyUuDai)
                    .Include(o => o.BenhNhan).ThenInclude(o => o.TaiKhoanBenhNhan)
                    .Include(o => o.YeuCauKhamBenhs).ThenInclude(o => o.CongTyBaoHiemTuNhanCongNos)
                    .Include(o => o.YeuCauDichVuKyThuats).ThenInclude(o => o.CongTyBaoHiemTuNhanCongNos)
                    .Include(o => o.YeuCauKhamBenhs).ThenInclude(o => o.DichVuKhamBenhBenhVien)
                    .Include(o => o.YeuCauKhamBenhs).ThenInclude(o => o.NhomGiaDichVuKhamBenhBenhVien)
                    .Include(o => o.YeuCauKhamBenhs).ThenInclude(o => o.NoiDangKy)
                    .Include(o => o.YeuCauKhamBenhs).ThenInclude(o => o.BacSiDangKy).ThenInclude(o => o.User)
                    .Include(o => o.YeuCauDichVuKyThuats).ThenInclude(o => o.DichVuKyThuatBenhVien)
                    .Include(o => o.YeuCauDichVuKyThuats).ThenInclude(o => o.NhomGiaDichVuKyThuatBenhVien)
                    .Include(o => o.YeuCauDichVuKyThuats).ThenInclude(o => o.NoiThucHien)
                    .Include(o => o.YeuCauTruyenMaus)
                    .Include(o => o.YeuCauDuocPhamBenhViens)
                    .Include(o => o.YeuCauVatTuBenhViens)
                    .Include(o => o.NoiTruBenhAn)
                    .Include(o => o.HoatDongGiuongBenhs)
                    .Include(o => o.YeuCauTiepNhanTheBHYTs)
                    .Include(o => o.YeuCauDichVuGiuongBenhVienChiPhiBenhViens).ThenInclude(o => o.CongTyBaoHiemTuNhanCongNos)
                    .Include(o => o.YeuCauDichVuGiuongBenhVienChiPhiBenhViens).ThenInclude(o => o.YeuCauDichVuGiuongBenhVienChiPhiBHYTs)
                    .Include(o => o.YeuCauDichVuGiuongBenhVienChiPhiBenhViens).ThenInclude(o => o.NhomGiaDichVuGiuongBenhVien)
                    .Include(o => o.YeuCauDichVuGiuongBenhVienChiPhiBenhViens).ThenInclude(gb => gb.PhongBenhVien));

            long? yeuCauTiepNhanNgoaiTruCanQuyetToanId = ycTiepNhan.YeuCauTiepNhanNgoaiTruCanQuyetToanId;
            YeuCauTiepNhan yeuCauTiepNhanNgoaiTruCanQuyetToan = null;
            if (yeuCauTiepNhanNgoaiTruCanQuyetToanId != null)
            {
                yeuCauTiepNhanNgoaiTruCanQuyetToan = BaseRepository.GetById(yeuCauTiepNhanNgoaiTruCanQuyetToanId.Value,
                    x => x.Include(o => o.CongTyUuDai)
                        .Include(o => o.YeuCauKhamBenhs).ThenInclude(o => o.CongTyBaoHiemTuNhanCongNos)
                        .Include(o => o.YeuCauDichVuKyThuats).ThenInclude(o => o.CongTyBaoHiemTuNhanCongNos)
                        .Include(o => o.YeuCauDuocPhamBenhViens)
                        .Include(o => o.YeuCauVatTuBenhViens)
                        .Include(o => o.YeuCauKhamBenhs).ThenInclude(o => o.DichVuKhamBenhBenhVien)
                        .Include(o => o.YeuCauKhamBenhs).ThenInclude(o => o.NhomGiaDichVuKhamBenhBenhVien)
                        .Include(o => o.YeuCauKhamBenhs).ThenInclude(o => o.NoiDangKy)
                        .Include(o => o.YeuCauKhamBenhs).ThenInclude(o => o.BacSiDangKy).ThenInclude(o => o.User)
                        .Include(o => o.YeuCauDichVuKyThuats).ThenInclude(o => o.DichVuKyThuatBenhVien)
                        .Include(o => o.YeuCauDichVuKyThuats).ThenInclude(o => o.NhomGiaDichVuKyThuatBenhVien)
                        .Include(o => o.YeuCauDichVuKyThuats).ThenInclude(o => o.NoiThucHien));
            }
            var congTyBaoHiemTuNhanIds = ycTiepNhan.YeuCauTiepNhanCongTyBaoHiemTuNhans.Select(cty => cty.CongTyBaoHiemTuNhanId);
            if (yeuCauTiepNhanNgoaiTruCanQuyetToan == null)
            {
                var ycKyThuatExcept = chiTienQuyetToan.DanhSachChiPhiKhamChuaBenhTrongGoiDichVus
                    .Where(o => o.LoaiNhom == NhomChiPhiKhamChuaBenh.DichVuKyThuat).Select(o => o.Id).Except(ycTiepNhan
                        .YeuCauDichVuKyThuats
                        .Where(o => o.TrangThai != EnumTrangThaiYeuCauDichVuKyThuat.DaHuy && o.TrangThaiThanhToan != Enums.TrangThaiThanhToan.DaThanhToan && o.YeuCauGoiDichVuId != null)
                        .Select(o => o.Id));
                var ycGiuongExcept = chiTienQuyetToan.DanhSachChiPhiKhamChuaBenhTrongGoiDichVus
                    .Where(o => o.LoaiNhom == NhomChiPhiKhamChuaBenh.DichVuGiuong).Select(o => o.Id).Except(ycTiepNhan
                        .YeuCauDichVuGiuongBenhVienChiPhiBenhViens
                        .Where(o => o.YeuCauGoiDichVuId != null && o.TrangThaiThanhToan != Enums.TrangThaiThanhToan.DaThanhToan)
                        .Select(o => o.Id));

                if (ycKyThuatExcept.Any() || ycGiuongExcept.Any())
                    throw new Exception("Thông tin dịch vụ không hợp lệ, vui lòng tải lại trang");
            }
            else
            {
                var ycKhamBenhExcept = chiTienQuyetToan.DanhSachChiPhiKhamChuaBenhTrongGoiDichVus
                .Where(o => o.LoaiNhom == NhomChiPhiKhamChuaBenh.DichVuKhamBenh).Select(o => o.Id).Except(yeuCauTiepNhanNgoaiTruCanQuyetToan
                            .YeuCauKhamBenhs
                            .Where(o => o.TrangThai != EnumTrangThaiYeuCauKhamBenh.HuyKham && o.TrangThaiThanhToan != Enums.TrangThaiThanhToan.DaThanhToan && o.YeuCauGoiDichVuId != null)
                            .Select(o => o.Id));
                var ycKyThuatExcept = chiTienQuyetToan.DanhSachChiPhiKhamChuaBenhTrongGoiDichVus
                    .Where(o => o.LoaiNhom == NhomChiPhiKhamChuaBenh.DichVuKyThuat).Select(o => o.Id).Except(ycTiepNhan
                        .YeuCauDichVuKyThuats
                        .Where(o => o.TrangThai != EnumTrangThaiYeuCauDichVuKyThuat.DaHuy && o.TrangThaiThanhToan != Enums.TrangThaiThanhToan.DaThanhToan && o.YeuCauGoiDichVuId != null)
                        .Select(o => o.Id)
                        .Concat(yeuCauTiepNhanNgoaiTruCanQuyetToan.YeuCauDichVuKyThuats
                            .Where(o => o.TrangThai != EnumTrangThaiYeuCauDichVuKyThuat.DaHuy && o.TrangThaiThanhToan != Enums.TrangThaiThanhToan.DaThanhToan && o.YeuCauGoiDichVuId != null)
                            .Select(o => o.Id)));
                var ycGiuongExcept = chiTienQuyetToan.DanhSachChiPhiKhamChuaBenhTrongGoiDichVus
                    .Where(o => o.LoaiNhom == NhomChiPhiKhamChuaBenh.DichVuGiuong).Select(o => o.Id).Except(ycTiepNhan
                        .YeuCauDichVuGiuongBenhVienChiPhiBenhViens
                        .Where(o => o.YeuCauGoiDichVuId != null && o.TrangThaiThanhToan != Enums.TrangThaiThanhToan.DaThanhToan)
                        .Select(o => o.Id));

                if (ycKhamBenhExcept.Any() || ycKyThuatExcept.Any() || ycGiuongExcept.Any())
                    throw new Exception("Thông tin dịch vụ không hợp lệ, vui lòng tải lại trang");
            }

            var dsChiPhi = GetDanhSachDichVuTrongGoiCoBHYTChuaQuyetToanNoiTru(chiTienQuyetToan.Id);
            var dsChiPhiDaChon = chiTienQuyetToan.DanhSachChiPhiKhamChuaBenhTrongGoiDichVus;

            foreach (var chiPhiKhamChuaBenhVo in dsChiPhiDaChon)
            {
                var chiphi = dsChiPhi.FirstOrDefault(o => o.LoaiNhom == chiPhiKhamChuaBenhVo.LoaiNhom && o.Id == chiPhiKhamChuaBenhVo.Id);
                if (chiphi == null || !chiphi.ThanhTien.AlmostEqual(chiPhiKhamChuaBenhVo.ThanhTien) || !chiphi.BHYTThanhToan.AlmostEqual(chiPhiKhamChuaBenhVo.BHYTThanhToan))
                {
                    throw new Exception("Thông tin dịch vụ thanh toán không hợp lệ, vui lòng tải lại trang");
                }
                if (chiPhiKhamChuaBenhVo.TongCongNo > chiPhiKhamChuaBenhVo.ThanhTien && chiPhiKhamChuaBenhVo.TongCongNo > Math.Round(chiPhiKhamChuaBenhVo.ThanhTien, 2, MidpointRounding.AwayFromZero))
                {
                    throw new Exception("Số tiền BHTN thanh toán lớn hơn thành tiền");
                }
            }

            var goiDvIds = chiTienQuyetToan.DanhSachChiPhiKhamChuaBenhTrongGoiDichVus.Select(o => o.YeuCauGoiDichVuId).Distinct();
            var goiDvs = await _yeuCauGoiDichVuRepository.Table.Where(o => goiDvIds.Contains(o.Id))
                .Include(o => o.ChuongTrinhGoiDichVu).Include(o => o.TaiKhoanBenhNhanThus).Include(o => o.TaiKhoanBenhNhanChis).ToListAsync();

            foreach (var chiphi in chiTienQuyetToan.DanhSachChiPhiKhamChuaBenhTrongGoiDichVus.Where(o => o.LoaiNhom == NhomChiPhiKhamChuaBenh.DichVuKhamBenh))
            {
                var yc = yeuCauTiepNhanNgoaiTruCanQuyetToan?.YeuCauKhamBenhs?.First(o => o.Id == chiphi.Id);
                //kiem tra goi BHTN khong phai goi bao lanh
                if (goiDvs.FirstOrDefault(o => o.Id == yc.YeuCauGoiDichVuId)?.ChuongTrinhGoiDichVu.CongTyBaoHiemTuNhanId == null)
                {
                    foreach (var ycCongTyBaoHiemTuNhanCongNo in yc.CongTyBaoHiemTuNhanCongNos.Where(o => o.TaiKhoanBenhNhanThuId == null))
                    {
                        ycCongTyBaoHiemTuNhanCongNo.WillDelete = true;
                    }
                    if (chiphi.TongCongNo > 0)
                    {
                        foreach (var chiphiDanhSachCongNoChoThu in chiphi.DanhSachCongNoChoThus)
                        {
                            if (chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu.AlmostEqual(0))
                                continue;
                            yc.CongTyBaoHiemTuNhanCongNos.Add(new CongTyBaoHiemTuNhanCongNo
                            {
                                CongTyBaoHiemTuNhanId = chiphiDanhSachCongNoChoThu.CongTyBaoHiemTuNhanId,
                                SoTien = chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu
                            });
                        }
                    }
                    yc.SoTienBaoHiemTuNhanChiTra = chiphi.TongCongNo;
                }
            }
            foreach (var chiphi in chiTienQuyetToan.DanhSachChiPhiKhamChuaBenhTrongGoiDichVus.Where(o => o.LoaiNhom == NhomChiPhiKhamChuaBenh.DichVuKyThuat))
            {
                var yc = yeuCauTiepNhanNgoaiTruCanQuyetToan?.YeuCauDichVuKyThuats?.FirstOrDefault(o => o.Id == chiphi.Id) ?? ycTiepNhan.YeuCauDichVuKyThuats.FirstOrDefault(o => o.Id == chiphi.Id);
                //kiem tra goi BHTN khong phai goi bao lanh
                if (goiDvs.FirstOrDefault(o => o.Id == yc.YeuCauGoiDichVuId)?.ChuongTrinhGoiDichVu.CongTyBaoHiemTuNhanId == null)
                {
                    foreach (var ycCongTyBaoHiemTuNhanCongNo in yc.CongTyBaoHiemTuNhanCongNos.Where(o => o.TaiKhoanBenhNhanThuId == null))
                    {
                        ycCongTyBaoHiemTuNhanCongNo.WillDelete = true;
                    }
                    if (chiphi.TongCongNo > 0)
                    {
                        foreach (var chiphiDanhSachCongNoChoThu in chiphi.DanhSachCongNoChoThus)
                        {
                            if (chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu.AlmostEqual(0))
                                continue;
                            yc.CongTyBaoHiemTuNhanCongNos.Add(new CongTyBaoHiemTuNhanCongNo
                            {
                                CongTyBaoHiemTuNhanId = chiphiDanhSachCongNoChoThu.CongTyBaoHiemTuNhanId,
                                SoTien = chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu
                            });
                        }
                    }
                    yc.SoTienBaoHiemTuNhanChiTra = chiphi.TongCongNo;
                }
            }
            foreach (var chiphi in chiTienQuyetToan.DanhSachChiPhiKhamChuaBenhTrongGoiDichVus.Where(o => o.LoaiNhom == NhomChiPhiKhamChuaBenh.DichVuGiuong && o.Id != 0))
            {
                var yc = ycTiepNhan.YeuCauDichVuGiuongBenhVienChiPhiBenhViens.First(o => o.Id == chiphi.Id);
                //kiem tra goi BHTN khong phai goi bao lanh
                if (goiDvs.FirstOrDefault(o => o.Id == yc.YeuCauGoiDichVuId)?.ChuongTrinhGoiDichVu.CongTyBaoHiemTuNhanId == null)
                {
                    foreach (var ycCongTyBaoHiemTuNhanCongNo in yc.CongTyBaoHiemTuNhanCongNos.Where(o => o.TaiKhoanBenhNhanThuId == null))
                    {
                        ycCongTyBaoHiemTuNhanCongNo.WillDelete = true;
                    }
                    if (chiphi.TongCongNo > 0)
                    {
                        foreach (var chiphiDanhSachCongNoChoThu in chiphi.DanhSachCongNoChoThus)
                        {
                            if (chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu.AlmostEqual(0))
                                continue;
                            yc.CongTyBaoHiemTuNhanCongNos.Add(new CongTyBaoHiemTuNhanCongNo
                            {
                                CongTyBaoHiemTuNhanId = chiphiDanhSachCongNoChoThu.CongTyBaoHiemTuNhanId,
                                SoTien = chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu
                            });
                        }
                    }
                    yc.SoTienBaoHiemTuNhanChiTra = chiphi.TongCongNo;
                }
            }

            //await BaseRepository.UpdateAsync(ycTiepNhan);
            BaseRepository.Context.SaveChanges();
        }

        public async Task<GridDataSource> GetDanhSachChuaQuyetToanNoiTruAsync(ThuNganNoiTruQueryInfo queryInfo, bool isAllData)
        {
            ReplaceDisplayValueSortExpression(queryInfo);
            var sreachString = JsonConvert.DeserializeObject<DanhSachBenhNhanChoThuNganNoiTruGridVo>(queryInfo.AdditionalSearchString);

            //Build Default Sort
            if (queryInfo.Sort == null || queryInfo.Sort.Count == 0)
            {
                queryInfo.Sort = new List<Sort> { new Sort { Field = "ChoQuyetToan", Dir = "desc" },
                                                  new Sort { Field = "ChoTamUngThem", Dir = "desc" },
                                                  new Sort { Field = "DaTamUng", Dir = "asc" },
                                                  new Sort { Field = "Id", Dir = "asc" } };
            }

            var query = BaseRepository.TableNoTracking
                .Where(o => o.LoaiYeuCauTiepNhan == Enums.EnumLoaiYeuCauTiepNhan.KhamChuaBenhNoiTru &&
                            o.TrangThaiYeuCauTiepNhan == Enums.EnumTrangThaiYeuCauTiepNhan.DangThucHien && (o.NoiTruBenhAn == null || o.NoiTruBenhAn.DaQuyetToan != true))
                .Select(s => new DanhSachBenhNhanChoThuNganNoiTruGridVo
                {
                    Id = s.Id,
                    MaBenhAn = s.NoiTruBenhAn != null ? s.NoiTruBenhAn.SoBenhAn : string.Empty,
                    MaTN = s.MaYeuCauTiepNhan,
                    HoTen = s.HoTen,
                    DienThoaiStr = s.SoDienThoaiDisplay,
                    DienThoai = s.SoDienThoai,
                    GioiTinh = s.GioiTinh,
                    MaBN = s.BenhNhan != null ? s.BenhNhan.MaBN : string.Empty,
                    NamSinh = s.NamSinh,
                    ThoiDiemTiepNhan = s.ThoiDiemTiepNhan,
                    MucHuong = s.CoBHYT != null && s.CoBHYT == true && s.YeuCauTiepNhanTheBHYTs.Any() ? s.YeuCauTiepNhanTheBHYTs.OrderByDescending(a => a.MucHuong).Select(a => a.MucHuong).FirstOrDefault() : 0,
                    ChoQuyetToan = s.NoiTruBenhAn != null && s.NoiTruBenhAn.ThoiDiemRaVien != null,
                    ChoTamUngThem = s.ChoTamUngThem ?? false,
                    ChuaTaoBenhAn = s.NoiTruBenhAn == null,

                    NgayVaoVien = s.NoiTruBenhAn.ThoiDiemNhapVien,
                    NgayRaVien = s.NoiTruBenhAn != null && s.NoiTruBenhAn.ThoiDiemRaVien != null ? s.NoiTruBenhAn.ThoiDiemRaVien : null,

                    DaTamUng = s.TaiKhoanBenhNhanThus.Any(o => o.DaHuy != true && o.LoaiThuTienBenhNhan == LoaiThuTienBenhNhan.ThuTamUng && o.ThuTienGoiDichVu != true)
                })
                .Where(o => (queryInfo.ChoQuyetToan && o.ChoQuyetToan) || (queryInfo.ChuaTaoBenhAn && o.ChuaTaoBenhAn) || (queryInfo.ChoTamUngThem && (o.ChoTamUngThem || !o.DaTamUng) && !o.ChuaTaoBenhAn && !o.ChoQuyetToan) || (queryInfo.DaTamUng && o.DaTamUng && !o.ChuaTaoBenhAn && !o.ChoQuyetToan && !o.ChoTamUngThem));


            if (!string.IsNullOrEmpty(sreachString.SearchString))
            {
                query = query.ApplyLike(sreachString.SearchString.Trim(),
                    g => g.MaBN, g => g.MaBenhAn,
                    g => g.HoTen,
                    g => g.MaTN);
            }

            var queryResult = isAllData ? await query.OrderBy(queryInfo.SortString).ToArrayAsync()
                : await query.OrderBy(queryInfo.SortString).Skip(queryInfo.Skip).Take(queryInfo.Take).ToArrayAsync();
            var countTask = queryInfo.LazyLoadPage == true ? Task.FromResult(0) : query.CountAsync();

            if (queryResult.Length > 0)
            {
                var danhSachThuTamUng = await BaseRepository.TableNoTracking.Where(tn => queryResult.Select(o => o.Id).Contains(tn.Id)).Select(tn =>
                    new
                    {
                        YeuCauTiepNhanId = tn.Id,
                        TamUngNoiTru = tn.TaiKhoanBenhNhanThus,
                        TamUngNgoaiTru = tn.YeuCauTiepNhanNgoaiTruCanQuyetToanId == null ? null : tn.YeuCauTiepNhanNgoaiTruCanQuyetToan.TaiKhoanBenhNhanThus
                    }
                ).ToListAsync();

                foreach (var danhSachBenhNhanChoThuNganGridVo in queryResult)
                {
                    var tamUng = danhSachThuTamUng.FirstOrDefault(o => o.YeuCauTiepNhanId == danhSachBenhNhanChoThuNganGridVo.Id);
                    if (tamUng != null)
                    {
                        danhSachBenhNhanChoThuNganGridVo.SoTienDuTaiKhoan = tamUng.TamUngNoiTru
                            .Concat(tamUng.TamUngNgoaiTru ?? new List<TaiKhoanBenhNhanThu>())
                            .Where(o => o.DaHuy != true && o.LoaiThuTienBenhNhan == LoaiThuTienBenhNhan.ThuTamUng && o.ThuTienGoiDichVu != true && o.PhieuHoanUngId == null)
                            .Select(o =>
                                o.TienMat.GetValueOrDefault(0) + o.ChuyenKhoan.GetValueOrDefault(0) +
                                o.POS.GetValueOrDefault(0)).DefaultIfEmpty(0).Sum();
                    }
                }
            }

            return new GridDataSource { Data = queryResult, TotalRowCount = countTask.Result };

        }
        public async Task<GridDataSource> GetTotalPageDanhSachChuaQuyetToanNoiTruAsync(ThuNganNoiTruQueryInfo queryInfo)
        {
            var sreachString = JsonConvert.DeserializeObject<DanhSachBenhNhanChoThuNganNoiTruGridVo>(queryInfo.AdditionalSearchString);

            var query = BaseRepository.TableNoTracking
                .Where(o => o.LoaiYeuCauTiepNhan == Enums.EnumLoaiYeuCauTiepNhan.KhamChuaBenhNoiTru &&
                            o.TrangThaiYeuCauTiepNhan == Enums.EnumTrangThaiYeuCauTiepNhan.DangThucHien &&
                            (o.NoiTruBenhAn == null || o.NoiTruBenhAn.DaQuyetToan != true))
                .Select(s => new DanhSachBenhNhanChoThuNganNoiTruGridVo
                {
                    Id = s.Id,
                    MaBenhAn = s.NoiTruBenhAn != null ? s.NoiTruBenhAn.SoBenhAn : string.Empty,
                    MaTN = s.MaYeuCauTiepNhan,
                    HoTen = s.HoTen,
                    DienThoaiStr = s.SoDienThoaiDisplay,
                    DienThoai = s.SoDienThoai,
                    MaBN = s.BenhNhan != null ? s.BenhNhan.MaBN : string.Empty,
                    ChoQuyetToan = s.NoiTruBenhAn != null && s.NoiTruBenhAn.ThoiDiemRaVien != null,
                    ChoTamUngThem = s.ChoTamUngThem ?? false,
                    ChuaTaoBenhAn = s.NoiTruBenhAn == null,
                    DaTamUng = s.TaiKhoanBenhNhanThus.Any(o => o.DaHuy != true && o.LoaiThuTienBenhNhan == LoaiThuTienBenhNhan.ThuTamUng && o.ThuTienGoiDichVu != true)
                })
                .Where(o => (queryInfo.ChoQuyetToan && o.ChoQuyetToan) || (queryInfo.ChuaTaoBenhAn && o.ChuaTaoBenhAn) || (queryInfo.ChoTamUngThem && (o.ChoTamUngThem || !o.DaTamUng) && !o.ChuaTaoBenhAn && !o.ChoQuyetToan) || (queryInfo.DaTamUng && o.DaTamUng && !o.ChuaTaoBenhAn && !o.ChoQuyetToan && !o.ChoTamUngThem));
            if (!string.IsNullOrEmpty(sreachString.SearchString))
            {
                query = query.ApplyLike(sreachString.SearchString.Trim(),
                    g => g.MaBN, g => g.MaBenhAn,
                    g => g.HoTen,
                    g => g.MaTN);
            }

            var totalRowCount = await query.CountAsync();
            return new GridDataSource { TotalRowCount = totalRowCount };
        }
        public async Task<List<ChiPhiKhamChuaBenhNoiTruVo>> GetDanhSachChiPhiKhamChuaBenhChuaThu(long yeuCauTiepNhanId)
        {
            return await GetDanhSachChiPhiNoiTruChuaThu(yeuCauTiepNhanId);
        }

        public async Task<decimal> GetSoTienBNConPhaiThanhToan(long yeuCauTiepNhanId)
        {
            return await GetChiPhiNoiTruConPhaiThanhToan(yeuCauTiepNhanId);
        }

        private int GetTiLeBHYTThanhToanTheoDichVuGiuong(int soLuongGhep)
        {
            if (soLuongGhep == 1)
                return 100;
            if (soLuongGhep == 2)
                return 50;
            if (soLuongGhep > 2)
                return 33;
            return 0;
        }
        public async Task<GridDataSource> GetDanhSachDaQuyetToanNoiTruAsync(ThuNganNoiTruDaQuyetToanQueryInfo queryInfo, bool isAllData)
        {
            var cauHinhNoiTru = _cauHinhService.LoadSetting<CauHinhNoiTru>();
            ReplaceDisplayValueSortExpression(queryInfo);
            var sreachString = JsonConvert.DeserializeObject<DanhSachBenhNhanChoThuNganNoiTruGridVo>(queryInfo.AdditionalSearchString);

            //Build Default Sort
            if (queryInfo.Sort == null || queryInfo.Sort.Count == 0)
            {
                queryInfo.Sort = new List<Sort> { new Sort { Field = "CongNo", Dir = "desc" },
                                                  new Sort { Field = "DaQuyetToan", Dir = "desc" },
                                                  new Sort { Field = "Id", Dir = "asc" } };
            }

            var query = BaseRepository.TableNoTracking
                .Where(o => o.LoaiYeuCauTiepNhan == Enums.EnumLoaiYeuCauTiepNhan.KhamChuaBenhNoiTru &&
                          o.NoiTruBenhAn != null && o.NoiTruBenhAn.DaQuyetToan == true)
                .Select(s => new DanhSachThuNganNoiTruDaQuyetToanGridVo
                {
                    Id = s.Id,
                    MaBenhAn = s.NoiTruBenhAn != null ? s.NoiTruBenhAn.SoBenhAn : string.Empty,
                    MaTN = s.MaYeuCauTiepNhan,
                    HoTen = s.HoTen,
                    DienThoaiStr = s.SoDienThoaiDisplay,
                    DienThoai = s.SoDienThoai,
                    GioiTinh = s.GioiTinh,
                    MaBN = s.BenhNhan != null ? s.BenhNhan.MaBN : string.Empty,
                    NamSinh = s.NamSinh,
                    ThoiDiemTiepNhan = s.ThoiDiemTiepNhan,
                    MucHuong = s.CoBHYT != null && s.CoBHYT == true ? s.BHYTMucHuong.GetValueOrDefault() : 0,
                    DaQuyetToan = true,

                    NgayVaoVien = s.NoiTruBenhAn.ThoiDiemNhapVien,
                    NgayRaVien = s.NoiTruBenhAn != null && s.NoiTruBenhAn.ThoiDiemRaVien != null ? s.NoiTruBenhAn.ThoiDiemRaVien : null,
                });
            // .Where(o => (queryInfo.ChoQuyetToan && o.ChoQuyetToan) || (queryInfo.ChoTamUngThem && o.ChoTamUngThem && !o.ChoQuyetToan) || (queryInfo.DaTamUng && o.DaTamUng && !o.ChoQuyetToan && !o.ChoTamUngThem));


            if (!string.IsNullOrEmpty(sreachString.SearchString))
            {
                query = query.ApplyLike(sreachString.SearchString.Trim(),
                    g => g.MaBN, g => g.MaBenhAn,
                    g => g.HoTen,
                    g => g.MaTN);
            }

            var queryResult = isAllData ? await query.OrderBy(queryInfo.SortString).ToArrayAsync()
                : await query.OrderBy(queryInfo.SortString).Skip(queryInfo.Skip).Take(queryInfo.Take).ToArrayAsync();

            var countTask = queryInfo.LazyLoadPage == true ? Task.FromResult(0) : query.CountAsync();

            return new GridDataSource { Data = queryResult, TotalRowCount = countTask.Result };

        }
        public async Task<GridDataSource> GetTotalPageDanhSachDaQuyetToanNoiTruAsync(ThuNganNoiTruDaQuyetToanQueryInfo queryInfo)
        {
            var cauHinhNoiTru = _cauHinhService.LoadSetting<CauHinhNoiTru>();
            var sreachString = JsonConvert.DeserializeObject<DanhSachBenhNhanChoThuNganNoiTruGridVo>(queryInfo.AdditionalSearchString);

            var query = BaseRepository.TableNoTracking
                .Where(o => o.LoaiYeuCauTiepNhan == Enums.EnumLoaiYeuCauTiepNhan.KhamChuaBenhNoiTru &&
                         o.NoiTruBenhAn != null && o.NoiTruBenhAn.DaQuyetToan == true)
                .Select(s => new DanhSachThuNganNoiTruDaQuyetToanGridVo
                {
                    Id = s.Id,
                    MaBenhAn = s.NoiTruBenhAn != null ? s.NoiTruBenhAn.SoBenhAn : string.Empty,
                    MaTN = s.MaYeuCauTiepNhan,
                    HoTen = s.HoTen,
                    DienThoaiStr = s.SoDienThoaiDisplay,
                    DienThoai = s.SoDienThoai,
                    MaBN = s.BenhNhan != null ? s.BenhNhan.MaBN : string.Empty,
                    DaQuyetToan = true
                });
            //.Where(o => (queryInfo.ChoQuyetToan && o.ChoQuyetToan) || (queryInfo.ChoTamUngThem && o.ChoTamUngThem && !o.ChoQuyetToan) || (queryInfo.DaTamUng && o.DaTamUng && !o.ChoQuyetToan && !o.ChoTamUngThem));
            if (!string.IsNullOrEmpty(sreachString.SearchString))
            {
                query = query.ApplyLike(sreachString.SearchString.Trim(),
                    g => g.MaBN, g => g.MaBenhAn,
                    g => g.HoTen,
                    g => g.MaTN);
            }

            var totalRowCount = await query.CountAsync();
            return new GridDataSource { TotalRowCount = totalRowCount };
        }
        private LoaiPhieuThuChiThuNgan? GetLoaiPhieuThuChi(Enums.LoaiThuTienBenhNhan loaiThuTienBenhNhan)
        {
            switch (loaiThuTienBenhNhan)
            {
                case LoaiThuTienBenhNhan.ThuTamUng:
                    return LoaiPhieuThuChiThuNgan.ThuTamUng;
                case LoaiThuTienBenhNhan.ThuTheoChiPhi:
                    return LoaiPhieuThuChiThuNgan.ThuTheoChiPhi;
            }
            return null;
        }
        private LoaiPhieuThuChiThuNgan? GetLoaiPhieuThuChi(Enums.LoaiChiTienBenhNhan loaiChiTienBenhNhan)
        {
            switch (loaiChiTienBenhNhan)
            {
                case LoaiChiTienBenhNhan.HoanUng:
                    return LoaiPhieuThuChiThuNgan.HoanUng;
                case LoaiChiTienBenhNhan.HoanThu:
                    return LoaiPhieuThuChiThuNgan.HoanThu;
            }
            return null;
        }
        public async Task<List<ThongTinPhieuThuVo>> GetSoPhieu(DropDownListRequestModel model, long yeuCauTiepNhanId)
        {
            var yeuCauTiepNhan = await BaseRepository.GetByIdAsync(yeuCauTiepNhanId,
                o => o.Include(x => x.TaiKhoanBenhNhanThus).ThenInclude(c => c.PhieuHoanUng)
                    .Include(x => x.TaiKhoanBenhNhanThus).ThenInclude(c => c.TaiKhoanBenhNhanChis)
                    .Include(x => x.TaiKhoanBenhNhanThus).ThenInclude(c => c.NhanVienThucHien).ThenInclude(c => c.User)
                    .Include(x => x.TaiKhoanBenhNhanChis).ThenInclude(c => c.TaiKhoanBenhNhanThu)
                    .Include(x => x.TaiKhoanBenhNhanChis).ThenInclude(c => c.NhanVienThucHien).ThenInclude(c => c.User));

            var phieuThuKhacCuaGoiId = yeuCauTiepNhan.TaiKhoanBenhNhanThus.FirstOrDefault(o =>
                o.LoaiNoiThu == Enums.LoaiNoiThu.ThuNgan &&
                o.LoaiThuTienBenhNhan == Enums.LoaiThuTienBenhNhan.ThuTheoChiPhi &&
                o.TaiKhoanBenhNhanChis.Any(c => c.YeuCauGoiDichVuId != null && c.LoaiChiTienBenhNhan == Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi))?.Id;

            var dsPhieuThu = yeuCauTiepNhan.TaiKhoanBenhNhanThus.Where(o =>
                o.LoaiNoiThu == LoaiNoiThu.ThuNgan &&
                ((o.LoaiThuTienBenhNhan == LoaiThuTienBenhNhan.ThuTheoChiPhi && o.Id != phieuThuKhacCuaGoiId.GetValueOrDefault()) || (o.LoaiThuTienBenhNhan == Enums.LoaiThuTienBenhNhan.ThuTamUng && o.ThuTienGoiDichVu != true)));


            var dsPhieuChi = yeuCauTiepNhan.TaiKhoanBenhNhanChis.Where(o =>
                ((o.LoaiChiTienBenhNhan == Enums.LoaiChiTienBenhNhan.HoanUng && o.TaiKhoanBenhNhanThuId != null && o.TaiKhoanBenhNhanThuId != phieuThuKhacCuaGoiId.GetValueOrDefault()) || (o.LoaiChiTienBenhNhan == Enums.LoaiChiTienBenhNhan.HoanUng && o.TaiKhoanBenhNhanThus.Any()) ||
                (o.LoaiChiTienBenhNhan == LoaiChiTienBenhNhan.HoanThu && o.TaiKhoanBenhNhanThu?.LoaiNoiThu == LoaiNoiThu.ThuNgan)));

            var dsPhieu = dsPhieuThu.Select(o => new ThongTinPhieuThuVo
            {
                KeyId = o.Id,
                LoaiPhieuThuChiThuNgan = GetLoaiPhieuThuChi(o.LoaiThuTienBenhNhan),
                LaPhieuChi = o.TamUng.GetValueOrDefault() > o.TienMat.GetValueOrDefault(),
                DisplayName = o.SoPhieuHienThi,
                DaHuy = o.DaHuy,
                DaHoanUng = o.PhieuHoanUngId != null,
                PhieuHoanUng = o.PhieuHoanUng?.SoPhieuHienThi,
                DaThuHoi = o.DaThuHoi,
                NgayLap = o.NgayThu,
                NguoiLap = o.NhanVienThucHien.User.HoTen,
                TrongGoi = o.ThuTienGoiDichVu != null && o.ThuTienGoiDichVu == true
            })
            .Union(dsPhieuChi.Select(o => new ThongTinPhieuThuVo
            {
                KeyId = o.Id,
                LoaiPhieuThuChiThuNgan = GetLoaiPhieuThuChi(o.LoaiChiTienBenhNhan),
                DisplayName = o.SoPhieuHienThi,
                DaHuy = o.DaHuy,
                DaThuHoi = o.DaThuHoi,
                NgayLap = o.NgayChi,
                NguoiLap = o.NhanVienThucHien?.User.HoTen
            })).ToList();

            if (yeuCauTiepNhan.YeuCauTiepNhanNgoaiTruCanQuyetToanId != null)
            {
                YeuCauTiepNhan yeuCauTiepNhanNgoaiTruCanQuyetToan = await BaseRepository.GetByIdAsync(yeuCauTiepNhan.YeuCauTiepNhanNgoaiTruCanQuyetToanId.Value,
                    o => o.Include(x => x.TaiKhoanBenhNhanThus).ThenInclude(c => c.PhieuHoanUng)
                        .Include(x => x.TaiKhoanBenhNhanThus).ThenInclude(c => c.NhanVienThucHien).ThenInclude(c => c.User)
                        .Include(x => x.TaiKhoanBenhNhanChis).ThenInclude(c => c.TaiKhoanBenhNhanThu)
                        .Include(x => x.TaiKhoanBenhNhanChis).ThenInclude(c => c.NhanVienThucHien).ThenInclude(c => c.User));

                var thuNgoaiTru = yeuCauTiepNhanNgoaiTruCanQuyetToan.TaiKhoanBenhNhanThus.Where(o =>
                    o.LoaiNoiThu == LoaiNoiThu.ThuNgan &&
                    (o.LoaiThuTienBenhNhan == LoaiThuTienBenhNhan.ThuTheoChiPhi || (o.LoaiThuTienBenhNhan == Enums.LoaiThuTienBenhNhan.ThuTamUng && o.ThuTienGoiDichVu != true))).ToList();
                if (thuNgoaiTru.Count > 0)
                {
                    dsPhieu.AddRange(thuNgoaiTru.Select(o => new ThongTinPhieuThuVo
                    {
                        KeyId = o.Id,
                        LoaiPhieuThuChiThuNgan = GetLoaiPhieuThuChi(o.LoaiThuTienBenhNhan),
                        LaPhieuChi = o.TamUng.GetValueOrDefault() > o.TienMat.GetValueOrDefault(),
                        DisplayName = o.SoPhieuHienThi,
                        DaHuy = o.DaHuy,
                        DaHoanUng = o.PhieuHoanUngId != null,
                        PhieuHoanUng = o.PhieuHoanUng?.SoPhieuHienThi,
                        DaThuHoi = o.DaThuHoi,
                        NgayLap = o.NgayThu,
                        NguoiLap = o.NhanVienThucHien.User.HoTen,
                        TrongGoi = o.ThuTienGoiDichVu != null && o.ThuTienGoiDichVu == true,
                        NgoaiTru = true
                    }));
                }
                var chiNgoaiTru = yeuCauTiepNhanNgoaiTruCanQuyetToan.TaiKhoanBenhNhanChis.Where(o =>
                    ((o.LoaiChiTienBenhNhan == Enums.LoaiChiTienBenhNhan.HoanUng && o.TaiKhoanBenhNhanThuId != null) ||
                     (o.LoaiChiTienBenhNhan == LoaiChiTienBenhNhan.HoanThu && o.TaiKhoanBenhNhanThu?.LoaiNoiThu == LoaiNoiThu.ThuNgan))).ToList();
                if (chiNgoaiTru.Count > 0)
                {
                    dsPhieu.AddRange(chiNgoaiTru.Select(o => new ThongTinPhieuThuVo
                    {
                        KeyId = o.Id,
                        LoaiPhieuThuChiThuNgan = GetLoaiPhieuThuChi(o.LoaiChiTienBenhNhan),
                        DisplayName = o.SoPhieuHienThi,
                        DaHuy = o.DaHuy,
                        DaThuHoi = o.DaThuHoi,
                        NgayLap = o.NgayChi,
                        NguoiLap = o.NhanVienThucHien?.User.HoTen,
                        NgoaiTru = true
                    }));
                }
            }

            return dsPhieu.OrderByDescending(o => o.NgayLap).ToList();
        }
        public ThongTinPhieuThu GetThongTinPhieuThu(long soPhieuId, LoaiPhieuThuChiThuNgan loaiPhieu)
        {
            ThongTinPhieuThu thongTinPhieuThu = null;
            if (loaiPhieu == LoaiPhieuThuChiThuNgan.HoanUng || loaiPhieu == LoaiPhieuThuChiThuNgan.HoanThu)
            {
                var taiKhoanBenhNhanChi = _taiKhoanBenhNhanChiRepository.TableNoTracking.Include(o => o.NhanVienHuy).ThenInclude(o => o.User).Include(o => o.NhanVienThuHoi).ThenInclude(o => o.User).FirstOrDefault(o => o.Id == soPhieuId);
                if (taiKhoanBenhNhanChi != null)
                {
                    thongTinPhieuThu = new ThongTinPhieuThu
                    {
                        Id = taiKhoanBenhNhanChi.Id,
                        SoPhieu = taiKhoanBenhNhanChi.SoPhieuHienThi,
                        LoaiPhieuThuChiThuNgan = loaiPhieu,
                        DaHuy = taiKhoanBenhNhanChi.DaHuy,
                        TienMat = taiKhoanBenhNhanChi.TienMat,
                        HinhThucThanhToan = "Tiền mặt",
                        NgayThu = taiKhoanBenhNhanChi.NgayChi,
                        NoiDungThu = taiKhoanBenhNhanChi.NoiDungChi,
                        DaThuHoi = taiKhoanBenhNhanChi.DaThuHoi.GetValueOrDefault(),
                        NgayThuHoi = taiKhoanBenhNhanChi.NgayThuHoi,
                        NguoiThuHoiId = taiKhoanBenhNhanChi.NhanVienThuHoiId,
                        NguoiThuHoi = taiKhoanBenhNhanChi.NhanVienThuHoi?.User.HoTen,
                        NhanVienHuyPhieu = taiKhoanBenhNhanChi.NhanVienHuy?.User.HoTen,
                        NgayHuy = taiKhoanBenhNhanChi.NgayHuy
                    };
                }
            }
            else if (loaiPhieu == LoaiPhieuThuChiThuNgan.ThuTamUng)
            {
                var taiKhoanBenhNhanThu = _taiKhoanBenhNhanThuRepository.TableNoTracking.Include(o => o.PhieuHoanUng)
                                                                        .Include(o => o.NhanVienHuy).ThenInclude(o => o.User)
                                                                        .Include(o => o.NhanVienThuHoi).ThenInclude(o => o.User)
                                                                        .FirstOrDefault(o => o.Id == soPhieuId);
                if (taiKhoanBenhNhanThu != null)
                {
                    var hinhThucThanhToans = new List<string>();
                    if (taiKhoanBenhNhanThu.TienMat.GetValueOrDefault(0) != 0)
                    {
                        hinhThucThanhToans.Add("Tiền mặt");
                    }
                    if (taiKhoanBenhNhanThu.ChuyenKhoan.GetValueOrDefault(0) != 0)
                    {
                        hinhThucThanhToans.Add("Chuyển khoản");
                    }
                    if (taiKhoanBenhNhanThu.POS.GetValueOrDefault(0) != 0)
                    {
                        hinhThucThanhToans.Add("POS");
                    }
                    if (taiKhoanBenhNhanThu.CongNo.GetValueOrDefault(0) != 0)
                    {
                        hinhThucThanhToans.Add("Công nợ");
                    }
                    thongTinPhieuThu = new ThongTinPhieuThu
                    {
                        Id = taiKhoanBenhNhanThu.Id,
                        SoPhieu = taiKhoanBenhNhanThu.SoPhieuHienThi,
                        LoaiPhieuThuChiThuNgan = loaiPhieu,
                        DaHoanUng = taiKhoanBenhNhanThu.PhieuHoanUngId != null,
                        PhieuHoanUng = taiKhoanBenhNhanThu.PhieuHoanUng?.SoPhieuHienThi,
                        DaHuy = taiKhoanBenhNhanThu.DaHuy,
                        TienMat = taiKhoanBenhNhanThu.TienMat,
                        ChuyenKhoan = taiKhoanBenhNhanThu.ChuyenKhoan,
                        Pos = taiKhoanBenhNhanThu.POS,
                        CongNo = taiKhoanBenhNhanThu.CongNo,
                        HinhThucThanhToan = string.Join(", ", hinhThucThanhToans),
                        NgayThu = taiKhoanBenhNhanThu.NgayThu,
                        NoiDungThu = taiKhoanBenhNhanThu.NoiDungThu,
                        DaThuHoi = taiKhoanBenhNhanThu.DaThuHoi.GetValueOrDefault(),
                        NgayThuHoi = taiKhoanBenhNhanThu.NgayThuHoi,
                        NguoiThuHoiId = taiKhoanBenhNhanThu.NhanVienThuHoiId,
                        NguoiThuHoi = taiKhoanBenhNhanThu.NhanVienThuHoi?.User.HoTen,
                        NhanVienHuyPhieu = taiKhoanBenhNhanThu.NhanVienHuy?.User.HoTen,
                        NgayHuy = taiKhoanBenhNhanThu.NgayHuy
                    };
                }
            }
            else if (loaiPhieu == LoaiPhieuThuChiThuNgan.ThuTheoChiPhi)
            {
                var taiKhoanBenhNhanThu = _taiKhoanBenhNhanThuRepository.TableNoTracking
                    .Include(o => o.TaiKhoanBenhNhanChis)
                    .Include(o => o.TaiKhoanBenhNhanChis).ThenInclude(o => o.YeuCauKhamBenh).ThenInclude(o => o.NhomGiaDichVuKhamBenhBenhVien)
                    .Include(o => o.TaiKhoanBenhNhanChis).ThenInclude(o => o.YeuCauKhamBenh).ThenInclude(o => o.NoiThucHien).ThenInclude(o => o.KhoaPhong)
                    .Include(o => o.TaiKhoanBenhNhanChis).ThenInclude(o => o.YeuCauKhamBenh).ThenInclude(o => o.NoiChiDinh).ThenInclude(o => o.KhoaPhong)
                    .Include(o => o.TaiKhoanBenhNhanChis).ThenInclude(o => o.YeuCauDichVuKyThuat).ThenInclude(o => o.NhomGiaDichVuKyThuatBenhVien)
                    .Include(o => o.TaiKhoanBenhNhanChis).ThenInclude(o => o.YeuCauDichVuKyThuat).ThenInclude(o => o.NoiTruPhieuDieuTri)
                    .Include(o => o.TaiKhoanBenhNhanChis).ThenInclude(o => o.YeuCauDichVuKyThuat).ThenInclude(o => o.NoiThucHien).ThenInclude(o => o.KhoaPhong)
                    .Include(o => o.TaiKhoanBenhNhanChis).ThenInclude(o => o.YeuCauDichVuKyThuat).ThenInclude(o => o.NoiChiDinh).ThenInclude(o => o.KhoaPhong)
                    .Include(o => o.TaiKhoanBenhNhanChis).ThenInclude(o => o.YeuCauDuocPhamBenhVien).ThenInclude(o => o.DuocPhamBenhVien)
                    .Include(o => o.TaiKhoanBenhNhanChis).ThenInclude(o => o.YeuCauDuocPhamBenhVien).ThenInclude(o => o.DonViTinh)
                    .Include(o => o.TaiKhoanBenhNhanChis).ThenInclude(o => o.YeuCauDuocPhamBenhVien).ThenInclude(o => o.NoiTruPhieuDieuTri)
                    .Include(o => o.TaiKhoanBenhNhanChis).ThenInclude(o => o.YeuCauDuocPhamBenhVien).ThenInclude(o => o.NoiCapThuoc).ThenInclude(o => o.KhoaPhong)
                    .Include(o => o.TaiKhoanBenhNhanChis).ThenInclude(o => o.YeuCauDuocPhamBenhVien).ThenInclude(o => o.NoiChiDinh).ThenInclude(o => o.KhoaPhong)
                    .Include(o => o.TaiKhoanBenhNhanChis).ThenInclude(o => o.YeuCauVatTuBenhVien).ThenInclude(o => o.VatTuBenhVien)
                    .Include(o => o.TaiKhoanBenhNhanChis).ThenInclude(o => o.YeuCauVatTuBenhVien).ThenInclude(o => o.YeuCauDichVuKyThuat)
                    .Include(o => o.TaiKhoanBenhNhanChis).ThenInclude(o => o.YeuCauVatTuBenhVien).ThenInclude(o => o.NoiTruPhieuDieuTri)
                    .Include(o => o.TaiKhoanBenhNhanChis).ThenInclude(o => o.YeuCauVatTuBenhVien).ThenInclude(o => o.NoiCapVatTu).ThenInclude(o => o.KhoaPhong)
                    .Include(o => o.TaiKhoanBenhNhanChis).ThenInclude(o => o.YeuCauVatTuBenhVien).ThenInclude(o => o.NoiChiDinh).ThenInclude(o => o.KhoaPhong)
                    .Include(o => o.TaiKhoanBenhNhanChis).ThenInclude(o => o.YeuCauTruyenMau).ThenInclude(o => o.NoiThucHien).ThenInclude(o => o.KhoaPhong)
                    .Include(o => o.TaiKhoanBenhNhanChis).ThenInclude(o => o.YeuCauTruyenMau).ThenInclude(o => o.NoiTruPhieuDieuTri)
                    .Include(o => o.TaiKhoanBenhNhanChis).ThenInclude(o => o.YeuCauTruyenMau).ThenInclude(o => o.NoiChiDinh).ThenInclude(o => o.KhoaPhong)
                    .Include(o => o.TaiKhoanBenhNhanChis).ThenInclude(o => o.DonThuocThanhToanChiTiet).ThenInclude(o => o.DonViTinh)
                    .Include(o => o.TaiKhoanBenhNhanChis).ThenInclude(o => o.YeuCauDichVuGiuongBenhVienChiPhiBenhVien).ThenInclude(o => o.KhoaPhong)
                    .Include(o => o.TaiKhoanBenhNhanChis).ThenInclude(o => o.YeuCauDichVuGiuongBenhVienChiPhiBenhVien).ThenInclude(o => o.YeuCauDichVuGiuongBenhVienChiPhiBHYTs)
                    .Include(o => o.MienGiamChiPhis)
                    .Include(o => o.CongTyBaoHiemTuNhanCongNos)
                    .Include(o => o.NhanVienThuHoi).ThenInclude(o => o.User)
                    .Include(o => o.NhanVienHuy).ThenInclude(o => o.User).FirstOrDefault(o => o.Id == soPhieuId);
                if (taiKhoanBenhNhanThu != null)
                {
                    var tongBHYTTT = taiKhoanBenhNhanThu.TaiKhoanBenhNhanChis.Where(o => o.LoaiChiTienBenhNhan == LoaiChiTienBenhNhan.ThanhToanChiPhi).Select(o => (decimal)o.SoLuong.GetValueOrDefault() * o.DonGiaBaoHiem.GetValueOrDefault() * o.TiLeBaoHiemThanhToan.GetValueOrDefault() / 100 * o.MucHuongBaoHiem.GetValueOrDefault() / 100).DefaultIfEmpty().Sum();
                    var tongChiPhiBNTT = taiKhoanBenhNhanThu.TaiKhoanBenhNhanChis.Where(o => o.LoaiChiTienBenhNhan == LoaiChiTienBenhNhan.ThanhToanChiPhi).Select(o => o.TienChiPhi.GetValueOrDefault()).DefaultIfEmpty().Sum();
                    var tongMienGiam = taiKhoanBenhNhanThu.MienGiamChiPhis.Select(o => o.SoTien).DefaultIfEmpty().Sum();
                    var tongCongNoBaoHiemTuNhan = taiKhoanBenhNhanThu.CongTyBaoHiemTuNhanCongNos.Select(o => o.SoTien).DefaultIfEmpty().Sum();

                    var tongChiPhi = tongChiPhiBNTT + tongMienGiam + tongCongNoBaoHiemTuNhan + tongBHYTTT;
                    var benhNhanThanhToan = tongChiPhiBNTT + tongCongNoBaoHiemTuNhan;
                    decimal tienChuyenTuTrongGoi = 0;
                    if (tongChiPhiBNTT > (taiKhoanBenhNhanThu.TamUng.GetValueOrDefault() + taiKhoanBenhNhanThu.CongNo.GetValueOrDefault() + taiKhoanBenhNhanThu.TienMat.GetValueOrDefault() + taiKhoanBenhNhanThu.ChuyenKhoan.GetValueOrDefault() + taiKhoanBenhNhanThu.POS.GetValueOrDefault()))
                    {
                        tienChuyenTuTrongGoi = tongChiPhiBNTT - (taiKhoanBenhNhanThu.TamUng.GetValueOrDefault() +
                                                                 taiKhoanBenhNhanThu.CongNo.GetValueOrDefault() +
                                                                 taiKhoanBenhNhanThu.TienMat.GetValueOrDefault() +
                                                                 taiKhoanBenhNhanThu.ChuyenKhoan.GetValueOrDefault() +
                                                                 taiKhoanBenhNhanThu.POS.GetValueOrDefault());
                    }

                    thongTinPhieuThu = new ThongTinPhieuThu
                    {
                        Id = taiKhoanBenhNhanThu.Id,
                        SoPhieu = taiKhoanBenhNhanThu.SoPhieuHienThi,
                        LoaiPhieuThuChiThuNgan = loaiPhieu,
                        DaHuy = taiKhoanBenhNhanThu.DaHuy,
                        TongChiPhi = tongChiPhi,
                        BHYTThanhToan = tongBHYTTT,
                        MienGiam = tongMienGiam,
                        BenhNhanThanhToan = benhNhanThanhToan,
                        TienMat = tongChiPhiBNTT < (taiKhoanBenhNhanThu.TamUng.GetValueOrDefault() + taiKhoanBenhNhanThu.CongNo.GetValueOrDefault())
                            ? (tongChiPhiBNTT - taiKhoanBenhNhanThu.CongNo.GetValueOrDefault())
                            : taiKhoanBenhNhanThu.TamUng.GetValueOrDefault() + taiKhoanBenhNhanThu.TienMat.GetValueOrDefault() + tienChuyenTuTrongGoi,
                        ChuyenKhoan = taiKhoanBenhNhanThu.ChuyenKhoan.GetValueOrDefault(),
                        Pos = taiKhoanBenhNhanThu.POS.GetValueOrDefault(),
                        CongNo = taiKhoanBenhNhanThu.CongNo.GetValueOrDefault() + tongCongNoBaoHiemTuNhan,
                        TamUng = taiKhoanBenhNhanThu.TamUng.GetValueOrDefault(),
                        SoTienPhaiThuHoacChi = tongChiPhiBNTT < (taiKhoanBenhNhanThu.TamUng.GetValueOrDefault() + taiKhoanBenhNhanThu.CongNo.GetValueOrDefault())
                            ? ((taiKhoanBenhNhanThu.TamUng.GetValueOrDefault() + taiKhoanBenhNhanThu.CongNo.GetValueOrDefault()) - tongChiPhiBNTT)
                            : taiKhoanBenhNhanThu.TienMat.GetValueOrDefault() + taiKhoanBenhNhanThu.ChuyenKhoan.GetValueOrDefault() + taiKhoanBenhNhanThu.POS.GetValueOrDefault() + tienChuyenTuTrongGoi,
                        LaPhieuChi = tongChiPhiBNTT < taiKhoanBenhNhanThu.TamUng.GetValueOrDefault() + taiKhoanBenhNhanThu.CongNo.GetValueOrDefault(),
                        NgayThu = taiKhoanBenhNhanThu.NgayThu,
                        NoiDungThu = taiKhoanBenhNhanThu.NoiDungThu,
                        DaThuHoi = taiKhoanBenhNhanThu.DaThuHoi.GetValueOrDefault(),
                        NgayThuHoi = taiKhoanBenhNhanThu.NgayThuHoi,
                        NguoiThuHoiId = taiKhoanBenhNhanThu.NhanVienThuHoiId,
                        NguoiThuHoi = taiKhoanBenhNhanThu.NhanVienThuHoi?.User.HoTen,
                        NhanVienHuyPhieu = taiKhoanBenhNhanThu.NhanVienHuy?.User.HoTen,
                        NgayHuy = taiKhoanBenhNhanThu.NgayHuy,
                        ThuTienGoiDichVu = taiKhoanBenhNhanThu.ThuTienGoiDichVu
                    };

                    foreach (var taiKhoanBenhNhanChi in taiKhoanBenhNhanThu.TaiKhoanBenhNhanChis.Where(o => o.LoaiChiTienBenhNhan == LoaiChiTienBenhNhan.ThanhToanChiPhi))
                    {
                        var chiPhiDichVu = new ChiPhiKhamChuaBenhNoiTruVo
                        {
                            TaiKhoanBenhNhanChiId = taiKhoanBenhNhanChi.Id,
                            Soluong = taiKhoanBenhNhanChi.SoLuong.GetValueOrDefault(),
                            DonGia = taiKhoanBenhNhanChi.Gia.GetValueOrDefault(),
                            KhongTinhPhi = false,
                            KiemTraBHYTXacNhan = true,
                            DuocHuongBHYT = taiKhoanBenhNhanChi.MucHuongBaoHiem.GetValueOrDefault() > 0,
                            DonGiaBHYT = taiKhoanBenhNhanChi.DonGiaBaoHiem.GetValueOrDefault(),
                            TiLeBaoHiemThanhToan = taiKhoanBenhNhanChi.TiLeBaoHiemThanhToan.GetValueOrDefault(),
                            MucHuongBaoHiem = taiKhoanBenhNhanChi.MucHuongBaoHiem.GetValueOrDefault(),
                            SoTienMG = taiKhoanBenhNhanChi.SoTienMienGiam.GetValueOrDefault(),

                            DaThanhToan = taiKhoanBenhNhanChi.TienChiPhi.GetValueOrDefault(),
                            DaHoanThu = taiKhoanBenhNhanThu.DaHuy != true && taiKhoanBenhNhanChi.DaHuy == true,
                            NgayThu = taiKhoanBenhNhanThu.NgayThu,
                            DaThucHien = true
                        };
                        if (taiKhoanBenhNhanChi.YeuCauKhamBenh != null)
                        {
                            chiPhiDichVu.Id = taiKhoanBenhNhanChi.YeuCauKhamBenh.Id;
                            chiPhiDichVu.NgayPhatSinh = taiKhoanBenhNhanChi.YeuCauKhamBenh.ThoiDiemChiDinh;
                            chiPhiDichVu.DichVuBenhVienId = taiKhoanBenhNhanChi.YeuCauKhamBenh.DichVuKhamBenhBenhVienId;
                            chiPhiDichVu.LoaiNhom = NhomChiPhiNoiTru.DichVuKhamBenh;
                            chiPhiDichVu.NhomChiPhiBangKe = NhomChiPhiBangKe.KhamBenh;
                            chiPhiDichVu.Ma = taiKhoanBenhNhanChi.YeuCauKhamBenh.MaDichVu;
                            chiPhiDichVu.Nhom = NhomChiPhiNoiTru.DichVuKhamBenh.GetDescription();
                            chiPhiDichVu.TenDichVu = taiKhoanBenhNhanChi.YeuCauKhamBenh.TenDichVu;
                            chiPhiDichVu.DonViTinh = "Lần";
                            chiPhiDichVu.LoaiGia = taiKhoanBenhNhanChi.YeuCauKhamBenh.NhomGiaDichVuKhamBenhBenhVien.Ten;
                            chiPhiDichVu.MaSoTheBHYT = taiKhoanBenhNhanChi.YeuCauKhamBenh.MaSoTheBHYT ?? string.Empty;
                            chiPhiDichVu.DanhSachCongNoChoThus = taiKhoanBenhNhanThu
                                .CongTyBaoHiemTuNhanCongNos.Where(o => o.YeuCauKhamBenhId == taiKhoanBenhNhanChi.YeuCauKhamBenh.Id).Select(o => new DanhSachCongNoVo { CongTyBaoHiemTuNhanId = o.CongTyBaoHiemTuNhanId, SoTienCongNoChoThu = o.SoTien })
                                .ToList();
                            chiPhiDichVu.DanhSachMienGiamVos = taiKhoanBenhNhanThu.MienGiamChiPhis
                                .Where(o => o.YeuCauKhamBenhId == taiKhoanBenhNhanChi.YeuCauKhamBenh.Id).GroupBy(
                                    o => new
                                    {
                                        o.LoaiMienGiam,
                                        o.TheVoucherId,
                                        o.MaTheVoucher,
                                        o.DoiTuongUuDaiId,
                                        o.LoaiChietKhau
                                    }, o => o,
                                    (k, v) => new DanhSachMienGiamVo
                                    {
                                        LoaiMienGiam = k.LoaiMienGiam,
                                        LoaiChietKhau = k.LoaiChietKhau,
                                        TheVoucherId = k.TheVoucherId,
                                        MaTheVoucher = k.MaTheVoucher,
                                        DoiTuongUuDaiId = k.DoiTuongUuDaiId,
                                        TiLe = v.Select(o => o.TiLe).DefaultIfEmpty().Sum(),
                                        SoTien = v.Select(o => o.SoTien).DefaultIfEmpty().Sum()
                                    }).ToList();

                            chiPhiDichVu.GhiChuMienGiamThem = taiKhoanBenhNhanChi.YeuCauKhamBenh.GhiChuMienGiamThem;
                            chiPhiDichVu.NoiDungGhiChuMiemGiamId = taiKhoanBenhNhanChi.YeuCauKhamBenh.NoiDungGhiChuMiemGiamId;

                            chiPhiDichVu.Khoa = taiKhoanBenhNhanChi.YeuCauKhamBenh.NoiThucHien != null
                                ? taiKhoanBenhNhanChi.YeuCauKhamBenh.NoiThucHien.KhoaPhong.Ten
                                : taiKhoanBenhNhanChi.YeuCauKhamBenh.NoiChiDinh.KhoaPhong.Ten;
                            chiPhiDichVu.DaThucHien = taiKhoanBenhNhanChi.YeuCauKhamBenh.ThoiDiemHoanThanh != null ||
                                                      taiKhoanBenhNhanChi.YeuCauKhamBenh.TrangThai == Enums.EnumTrangThaiYeuCauKhamBenh.DaKham;

                        }
                        else if (taiKhoanBenhNhanChi.YeuCauDichVuKyThuat != null)
                        {
                            chiPhiDichVu.Id = taiKhoanBenhNhanChi.YeuCauDichVuKyThuat.Id;
                            chiPhiDichVu.NgayPhatSinh = taiKhoanBenhNhanChi.YeuCauDichVuKyThuat.NoiTruPhieuDieuTri?.NgayDieuTri ?? taiKhoanBenhNhanChi.YeuCauDichVuKyThuat.ThoiDiemChiDinh;
                            chiPhiDichVu.DichVuBenhVienId = taiKhoanBenhNhanChi.YeuCauDichVuKyThuat.DichVuKyThuatBenhVienId;
                            chiPhiDichVu.LoaiNhom = NhomChiPhiNoiTru.DichVuKyThuat;


                            switch (taiKhoanBenhNhanChi.YeuCauDichVuKyThuat.LoaiDichVuKyThuat)
                            {
                                case LoaiDichVuKyThuat.XetNghiem:
                                    chiPhiDichVu.NhomChiPhiBangKe = NhomChiPhiBangKe.XetNgiem;
                                    break;
                                case LoaiDichVuKyThuat.ChuanDoanHinhAnh:
                                    chiPhiDichVu.NhomChiPhiBangKe = NhomChiPhiBangKe.ChuanDoanHinhAnh;
                                    break;
                                case LoaiDichVuKyThuat.ThamDoChucNang:
                                    chiPhiDichVu.NhomChiPhiBangKe = NhomChiPhiBangKe.ThamDoChucNang;
                                    break;
                                case LoaiDichVuKyThuat.ThuThuatPhauThuat:
                                    chiPhiDichVu.NhomChiPhiBangKe = NhomChiPhiBangKe.ThuThuatPhauThuat;
                                    break;
                                default:
                                    chiPhiDichVu.NhomChiPhiBangKe = NhomChiPhiBangKe.DichVuKhac;
                                    break;
                            }

                            chiPhiDichVu.Ma = taiKhoanBenhNhanChi.YeuCauDichVuKyThuat.MaDichVu;
                            chiPhiDichVu.Nhom = NhomChiPhiNoiTru.DichVuKyThuat.GetDescription();
                            chiPhiDichVu.TenDichVu = taiKhoanBenhNhanChi.YeuCauDichVuKyThuat.TenDichVu;
                            chiPhiDichVu.DonViTinh = "Lần";
                            chiPhiDichVu.LoaiGia = taiKhoanBenhNhanChi.YeuCauDichVuKyThuat.NhomGiaDichVuKyThuatBenhVien.Ten;
                            chiPhiDichVu.MaSoTheBHYT = taiKhoanBenhNhanChi.YeuCauDichVuKyThuat.MaSoTheBHYT ?? string.Empty;
                            chiPhiDichVu.DanhSachCongNoChoThus = taiKhoanBenhNhanThu
                                .CongTyBaoHiemTuNhanCongNos.Where(o => o.YeuCauDichVuKyThuatId == taiKhoanBenhNhanChi.YeuCauDichVuKyThuat.Id).Select(o => new DanhSachCongNoVo { CongTyBaoHiemTuNhanId = o.CongTyBaoHiemTuNhanId, SoTienCongNoChoThu = o.SoTien })
                                .ToList();
                            chiPhiDichVu.DanhSachMienGiamVos = taiKhoanBenhNhanThu.MienGiamChiPhis
                                .Where(o => o.YeuCauDichVuKyThuatId == taiKhoanBenhNhanChi.YeuCauDichVuKyThuat.Id).GroupBy(
                                    o => new
                                    {
                                        o.LoaiMienGiam,
                                        o.TheVoucherId,
                                        o.MaTheVoucher,
                                        o.DoiTuongUuDaiId,
                                        o.LoaiChietKhau
                                    }, o => o,
                                    (k, v) => new DanhSachMienGiamVo
                                    {
                                        LoaiMienGiam = k.LoaiMienGiam,
                                        LoaiChietKhau = k.LoaiChietKhau,
                                        TheVoucherId = k.TheVoucherId,
                                        MaTheVoucher = k.MaTheVoucher,
                                        DoiTuongUuDaiId = k.DoiTuongUuDaiId,
                                        TiLe = v.Select(o => o.TiLe).DefaultIfEmpty().Sum(),
                                        SoTien = v.Select(o => o.SoTien).DefaultIfEmpty().Sum()
                                    }).ToList();

                            chiPhiDichVu.GhiChuMienGiamThem = taiKhoanBenhNhanChi.YeuCauDichVuKyThuat.GhiChuMienGiamThem;
                            chiPhiDichVu.NoiDungGhiChuMiemGiamId = taiKhoanBenhNhanChi.YeuCauDichVuKyThuat.NoiDungGhiChuMiemGiamId;

                            chiPhiDichVu.Khoa = taiKhoanBenhNhanChi.YeuCauDichVuKyThuat.NoiThucHien != null
                                ? taiKhoanBenhNhanChi.YeuCauDichVuKyThuat.NoiThucHien.KhoaPhong.Ten
                                : taiKhoanBenhNhanChi.YeuCauDichVuKyThuat.NoiChiDinh.KhoaPhong.Ten;
                            chiPhiDichVu.DaThucHien = taiKhoanBenhNhanChi.YeuCauDichVuKyThuat.ThoiDiemHoanThanh != null ||
                                                      taiKhoanBenhNhanChi.YeuCauDichVuKyThuat.TrangThai == Enums.EnumTrangThaiYeuCauDichVuKyThuat.DaThucHien;
                        }
                        else if (taiKhoanBenhNhanChi.YeuCauDuocPhamBenhVien != null)
                        {
                            chiPhiDichVu.Id = taiKhoanBenhNhanChi.YeuCauDuocPhamBenhVien.Id;
                            chiPhiDichVu.NgayPhatSinh = taiKhoanBenhNhanChi.YeuCauDuocPhamBenhVien.NoiTruPhieuDieuTri?.NgayDieuTri ?? taiKhoanBenhNhanChi.YeuCauDuocPhamBenhVien.ThoiDiemChiDinh;
                            chiPhiDichVu.DichVuBenhVienId = taiKhoanBenhNhanChi.YeuCauDuocPhamBenhVien.DuocPhamBenhVienId;
                            chiPhiDichVu.LoaiNhom = NhomChiPhiNoiTru.DuocPham;
                            chiPhiDichVu.NhomChiPhiBangKe = NhomChiPhiBangKe.ThuocDichTruyen;
                            chiPhiDichVu.Ma = taiKhoanBenhNhanChi.YeuCauDuocPhamBenhVien.DuocPhamBenhVien.Ma;
                            chiPhiDichVu.Nhom = NhomChiPhiNoiTru.DuocPham.GetDescription();
                            chiPhiDichVu.TenDichVu = taiKhoanBenhNhanChi.YeuCauDuocPhamBenhVien.Ten;
                            chiPhiDichVu.DonViTinh = taiKhoanBenhNhanChi.YeuCauDuocPhamBenhVien.DonViTinh?.Ten;
                            chiPhiDichVu.LoaiGia = string.Empty;
                            chiPhiDichVu.MaSoTheBHYT = taiKhoanBenhNhanChi.YeuCauDuocPhamBenhVien.MaSoTheBHYT ?? string.Empty;
                            chiPhiDichVu.DanhSachCongNoChoThus = taiKhoanBenhNhanThu
                                .CongTyBaoHiemTuNhanCongNos.Where(o => o.YeuCauDuocPhamBenhVienId == taiKhoanBenhNhanChi.YeuCauDuocPhamBenhVien.Id).Select(o => new DanhSachCongNoVo { CongTyBaoHiemTuNhanId = o.CongTyBaoHiemTuNhanId, SoTienCongNoChoThu = o.SoTien })
                                .ToList();
                            chiPhiDichVu.DanhSachMienGiamVos = taiKhoanBenhNhanThu.MienGiamChiPhis
                                .Where(o => o.YeuCauDuocPhamBenhVienId == taiKhoanBenhNhanChi.YeuCauDuocPhamBenhVien.Id).GroupBy(
                                    o => new
                                    {
                                        o.LoaiMienGiam,
                                        o.TheVoucherId,
                                        o.MaTheVoucher,
                                        o.DoiTuongUuDaiId,
                                        o.LoaiChietKhau
                                    }, o => o,
                                    (k, v) => new DanhSachMienGiamVo
                                    {
                                        LoaiMienGiam = k.LoaiMienGiam,
                                        LoaiChietKhau = k.LoaiChietKhau,
                                        TheVoucherId = k.TheVoucherId,
                                        MaTheVoucher = k.MaTheVoucher,
                                        DoiTuongUuDaiId = k.DoiTuongUuDaiId,
                                        TiLe = v.Select(o => o.TiLe).DefaultIfEmpty().Sum(),
                                        SoTien = v.Select(o => o.SoTien).DefaultIfEmpty().Sum()
                                    }).ToList();

                            chiPhiDichVu.GhiChuMienGiamThem = taiKhoanBenhNhanChi.YeuCauDuocPhamBenhVien.GhiChuMienGiamThem;
                            chiPhiDichVu.NoiDungGhiChuMiemGiamId = taiKhoanBenhNhanChi.YeuCauDuocPhamBenhVien.NoiDungGhiChuMiemGiamId;

                            chiPhiDichVu.Khoa = taiKhoanBenhNhanChi.YeuCauDuocPhamBenhVien.NoiCapThuoc != null
                                ? taiKhoanBenhNhanChi.YeuCauDuocPhamBenhVien.NoiCapThuoc.KhoaPhong.Ten
                                : taiKhoanBenhNhanChi.YeuCauDuocPhamBenhVien.NoiChiDinh.KhoaPhong.Ten;
                            chiPhiDichVu.DaThucHien = taiKhoanBenhNhanChi.YeuCauDuocPhamBenhVien.TrangThai == Enums.EnumYeuCauDuocPhamBenhVien.DaThucHien;
                        }
                        else if (taiKhoanBenhNhanChi.YeuCauVatTuBenhVien != null)
                        {
                            chiPhiDichVu.Id = taiKhoanBenhNhanChi.YeuCauVatTuBenhVien.Id;
                            chiPhiDichVu.NgayPhatSinh = taiKhoanBenhNhanChi.YeuCauVatTuBenhVien.NoiTruPhieuDieuTri?.NgayDieuTri ?? taiKhoanBenhNhanChi.YeuCauVatTuBenhVien.ThoiDiemChiDinh;
                            chiPhiDichVu.DichVuBenhVienId = taiKhoanBenhNhanChi.YeuCauVatTuBenhVien.VatTuBenhVienId;
                            chiPhiDichVu.LoaiNhom = NhomChiPhiNoiTru.VatTuTieuHao;
                            chiPhiDichVu.NhomChiPhiBangKe = taiKhoanBenhNhanChi.YeuCauVatTuBenhVien.YeuCauDichVuKyThuat?.LanThucHien != null ? NhomChiPhiBangKe.GoiVatTu : NhomChiPhiBangKe.VatTuYte;
                            chiPhiDichVu.SoThuTuGoiTrongNhomChiPhiBangKe = taiKhoanBenhNhanChi.YeuCauVatTuBenhVien.YeuCauDichVuKyThuat?.LanThucHien ?? 0;
                            chiPhiDichVu.Ma = taiKhoanBenhNhanChi.YeuCauVatTuBenhVien.Ma;
                            chiPhiDichVu.Nhom = NhomChiPhiNoiTru.VatTuTieuHao.GetDescription();
                            chiPhiDichVu.TenDichVu = taiKhoanBenhNhanChi.YeuCauVatTuBenhVien.Ten;
                            chiPhiDichVu.DonViTinh = taiKhoanBenhNhanChi.YeuCauVatTuBenhVien.DonViTinh;
                            chiPhiDichVu.LoaiGia = string.Empty;
                            chiPhiDichVu.MaSoTheBHYT = taiKhoanBenhNhanChi.YeuCauVatTuBenhVien.MaSoTheBHYT ?? string.Empty;
                            chiPhiDichVu.DanhSachCongNoChoThus = taiKhoanBenhNhanThu
                                .CongTyBaoHiemTuNhanCongNos.Where(o => o.YeuCauVatTuBenhVienId == taiKhoanBenhNhanChi.YeuCauVatTuBenhVien.Id).Select(o => new DanhSachCongNoVo { CongTyBaoHiemTuNhanId = o.CongTyBaoHiemTuNhanId, SoTienCongNoChoThu = o.SoTien })
                                .ToList();
                            chiPhiDichVu.DanhSachMienGiamVos = taiKhoanBenhNhanThu.MienGiamChiPhis
                                .Where(o => o.YeuCauVatTuBenhVienId == taiKhoanBenhNhanChi.YeuCauVatTuBenhVien.Id).GroupBy(
                                    o => new
                                    {
                                        o.LoaiMienGiam,
                                        o.TheVoucherId,
                                        o.MaTheVoucher,
                                        o.DoiTuongUuDaiId,
                                        o.LoaiChietKhau
                                    }, o => o,
                                    (k, v) => new DanhSachMienGiamVo
                                    {
                                        LoaiMienGiam = k.LoaiMienGiam,
                                        LoaiChietKhau = k.LoaiChietKhau,
                                        TheVoucherId = k.TheVoucherId,
                                        MaTheVoucher = k.MaTheVoucher,
                                        DoiTuongUuDaiId = k.DoiTuongUuDaiId,
                                        TiLe = v.Select(o => o.TiLe).DefaultIfEmpty().Sum(),
                                        SoTien = v.Select(o => o.SoTien).DefaultIfEmpty().Sum()
                                    }).ToList();

                            chiPhiDichVu.GhiChuMienGiamThem = taiKhoanBenhNhanChi.YeuCauVatTuBenhVien.GhiChuMienGiamThem;
                            chiPhiDichVu.NoiDungGhiChuMiemGiamId = taiKhoanBenhNhanChi.YeuCauVatTuBenhVien.NoiDungGhiChuMiemGiamId;

                            chiPhiDichVu.Khoa = taiKhoanBenhNhanChi.YeuCauVatTuBenhVien.NoiCapVatTu != null
                                ? taiKhoanBenhNhanChi.YeuCauVatTuBenhVien.NoiCapVatTu.KhoaPhong.Ten
                                : taiKhoanBenhNhanChi.YeuCauVatTuBenhVien.NoiChiDinh.KhoaPhong.Ten;
                            chiPhiDichVu.DaThucHien = taiKhoanBenhNhanChi.YeuCauVatTuBenhVien.TrangThai == Enums.EnumYeuCauVatTuBenhVien.DaThucHien;
                        }
                        else if (taiKhoanBenhNhanChi.YeuCauGoiDichVu != null)
                        {
                            chiPhiDichVu.Id = taiKhoanBenhNhanChi.YeuCauGoiDichVu.Id;
                            chiPhiDichVu.NgayPhatSinh = taiKhoanBenhNhanChi.YeuCauGoiDichVu.ThoiDiemChiDinh;
                            chiPhiDichVu.DichVuBenhVienId = taiKhoanBenhNhanChi.YeuCauGoiDichVu.ChuongTrinhGoiDichVuId;
                            chiPhiDichVu.LoaiNhom = NhomChiPhiNoiTru.GoiDichVu;
                            chiPhiDichVu.Ma = taiKhoanBenhNhanChi.YeuCauGoiDichVu.MaChuongTrinh;
                            chiPhiDichVu.Nhom = NhomChiPhiNoiTru.GoiDichVu.GetDescription();
                            chiPhiDichVu.TenDichVu = taiKhoanBenhNhanChi.YeuCauGoiDichVu.TenChuongTrinh;
                            chiPhiDichVu.LoaiGia = string.Empty;
                            chiPhiDichVu.MaSoTheBHYT = string.Empty;
                            chiPhiDichVu.DanhSachCongNoChoThus = taiKhoanBenhNhanThu
                                .CongTyBaoHiemTuNhanCongNos.Where(o => o.YeuCauGoiDichVuId == taiKhoanBenhNhanChi.YeuCauGoiDichVu.Id).Select(o => new DanhSachCongNoVo { CongTyBaoHiemTuNhanId = o.CongTyBaoHiemTuNhanId, SoTienCongNoChoThu = o.SoTien })
                                .ToList();
                            chiPhiDichVu.DanhSachMienGiamVos = taiKhoanBenhNhanThu.MienGiamChiPhis
                                .Where(o => o.YeuCauGoiDichVuId == taiKhoanBenhNhanChi.YeuCauGoiDichVu.Id).GroupBy(
                                    o => new
                                    {
                                        o.LoaiMienGiam,
                                        o.TheVoucherId,
                                        o.MaTheVoucher,
                                        o.DoiTuongUuDaiId,
                                        o.LoaiChietKhau
                                    }, o => o,
                                    (k, v) => new DanhSachMienGiamVo
                                    {
                                        LoaiMienGiam = k.LoaiMienGiam,
                                        LoaiChietKhau = k.LoaiChietKhau,
                                        TheVoucherId = k.TheVoucherId,
                                        MaTheVoucher = k.MaTheVoucher,
                                        DoiTuongUuDaiId = k.DoiTuongUuDaiId,
                                        TiLe = v.Select(o => o.TiLe).DefaultIfEmpty().Sum(),
                                        SoTien = v.Select(o => o.SoTien).DefaultIfEmpty().Sum()
                                    }).ToList();

                            chiPhiDichVu.GhiChuMienGiamThem = taiKhoanBenhNhanChi.YeuCauGoiDichVu.GhiChuMienGiamThem;
                            chiPhiDichVu.NoiDungGhiChuMiemGiamId = taiKhoanBenhNhanChi.YeuCauGoiDichVu.NoiDungGhiChuMiemGiamId;

                            chiPhiDichVu.Khoa = "Marketing";
                        }
                        else if (taiKhoanBenhNhanChi.DonThuocThanhToanChiTietTheoPhieuThu != null)
                        {
                            chiPhiDichVu.Id = taiKhoanBenhNhanChi.DonThuocThanhToanChiTietTheoPhieuThu.Id;
                            chiPhiDichVu.NgayPhatSinh = taiKhoanBenhNhanChi.DonThuocThanhToanChiTietTheoPhieuThu.NgayPhatSinh;
                            chiPhiDichVu.DichVuBenhVienId = taiKhoanBenhNhanChi.DonThuocThanhToanChiTietTheoPhieuThu.DuocPhamId;
                            chiPhiDichVu.LoaiNhom = NhomChiPhiNoiTru.ToaThuoc;
                            chiPhiDichVu.NhomChiPhiBangKe = NhomChiPhiBangKe.ThuocDichTruyen;
                            chiPhiDichVu.Ma = string.Empty;
                            chiPhiDichVu.Nhom = NhomChiPhiKhamChuaBenh.ToaThuoc.GetDescription();
                            chiPhiDichVu.TenDichVu = taiKhoanBenhNhanChi.DonThuocThanhToanChiTietTheoPhieuThu.Ten;
                            chiPhiDichVu.DonViTinh = taiKhoanBenhNhanChi.DonThuocThanhToanChiTietTheoPhieuThu.DonViTinh?.Ten;
                            chiPhiDichVu.LoaiGia = string.Empty;
                            chiPhiDichVu.SoTienBaoHiemTuNhanChiTra = taiKhoanBenhNhanChi.DonThuocThanhToanChiTietTheoPhieuThu.SoTienBaoHiemTuNhanChiTra.GetValueOrDefault();
                            chiPhiDichVu.SoTienMG = taiKhoanBenhNhanChi.DonThuocThanhToanChiTietTheoPhieuThu.SoTienMienGiam.GetValueOrDefault();
                            chiPhiDichVu.Khoa = "Nhà thuốc";
                        }
                        else if (taiKhoanBenhNhanChi.DonThuocThanhToanChiTiet != null)
                        {
                            chiPhiDichVu.Id = taiKhoanBenhNhanChi.DonThuocThanhToanChiTiet.Id;
                            chiPhiDichVu.NgayPhatSinh = taiKhoanBenhNhanChi.DonThuocThanhToanChiTiet.CreatedOn;
                            chiPhiDichVu.DichVuBenhVienId = taiKhoanBenhNhanChi.DonThuocThanhToanChiTiet.DuocPhamId;
                            chiPhiDichVu.LoaiNhom = NhomChiPhiNoiTru.ToaThuoc;
                            chiPhiDichVu.NhomChiPhiBangKe = NhomChiPhiBangKe.ThuocDichTruyen;
                            chiPhiDichVu.Ma = string.Empty;
                            chiPhiDichVu.Nhom = NhomChiPhiNoiTru.ToaThuoc.GetDescription();
                            chiPhiDichVu.TenDichVu = taiKhoanBenhNhanChi.DonThuocThanhToanChiTiet.Ten;
                            chiPhiDichVu.DonViTinh = taiKhoanBenhNhanChi.DonThuocThanhToanChiTiet.DonViTinh?.Ten;
                            chiPhiDichVu.LoaiGia = string.Empty;
                            chiPhiDichVu.MaSoTheBHYT = taiKhoanBenhNhanChi.DonThuocThanhToanChiTiet.MaSoTheBHYT ?? string.Empty;
                            chiPhiDichVu.DanhSachCongNoChoThus = taiKhoanBenhNhanThu
                                .CongTyBaoHiemTuNhanCongNos.Where(o => o.DonThuocThanhToanChiTietId == taiKhoanBenhNhanChi.DonThuocThanhToanChiTiet.Id).Select(o => new DanhSachCongNoVo { CongTyBaoHiemTuNhanId = o.CongTyBaoHiemTuNhanId, SoTienCongNoChoThu = o.SoTien })
                                .ToList();
                            chiPhiDichVu.DanhSachMienGiamVos = taiKhoanBenhNhanThu.MienGiamChiPhis
                                .Where(o => o.DonThuocThanhToanChiTietId == taiKhoanBenhNhanChi.DonThuocThanhToanChiTiet.Id).GroupBy(
                                    o => new
                                    {
                                        o.LoaiMienGiam,
                                        o.TheVoucherId,
                                        o.MaTheVoucher,
                                        o.DoiTuongUuDaiId,
                                        o.LoaiChietKhau
                                    }, o => o,
                                    (k, v) => new DanhSachMienGiamVo
                                    {
                                        LoaiMienGiam = k.LoaiMienGiam,
                                        LoaiChietKhau = k.LoaiChietKhau,
                                        TheVoucherId = k.TheVoucherId,
                                        MaTheVoucher = k.MaTheVoucher,
                                        DoiTuongUuDaiId = k.DoiTuongUuDaiId,
                                        TiLe = v.Select(o => o.TiLe).DefaultIfEmpty().Sum(),
                                        SoTien = v.Select(o => o.SoTien).DefaultIfEmpty().Sum()
                                    }).ToList();

                            chiPhiDichVu.GhiChuMienGiamThem = taiKhoanBenhNhanChi.DonThuocThanhToanChiTiet.GhiChuMienGiamThem;
                            chiPhiDichVu.NoiDungGhiChuMiemGiamId = taiKhoanBenhNhanChi.DonThuocThanhToanChiTiet.NoiDungGhiChuMiemGiamId;
                            chiPhiDichVu.DaThucHien = true;
                            chiPhiDichVu.Khoa = "Nhà thuốc";
                        }
                        else if (taiKhoanBenhNhanChi.YeuCauTruyenMau != null)
                        {
                            chiPhiDichVu.Id = taiKhoanBenhNhanChi.YeuCauTruyenMau.Id;
                            chiPhiDichVu.NgayPhatSinh = taiKhoanBenhNhanChi.YeuCauTruyenMau.NoiTruPhieuDieuTri?.NgayDieuTri ?? taiKhoanBenhNhanChi.YeuCauTruyenMau.ThoiDiemChiDinh;
                            chiPhiDichVu.DichVuBenhVienId = taiKhoanBenhNhanChi.YeuCauTruyenMau.MauVaChePhamId;
                            chiPhiDichVu.LoaiNhom = NhomChiPhiNoiTru.TruyenMau;
                            chiPhiDichVu.NhomChiPhiBangKe = NhomChiPhiBangKe.Mau;
                            chiPhiDichVu.Ma = taiKhoanBenhNhanChi.YeuCauTruyenMau.MaDichVu;
                            chiPhiDichVu.Nhom = NhomChiPhiNoiTru.TruyenMau.GetDescription();
                            chiPhiDichVu.TenDichVu = taiKhoanBenhNhanChi.YeuCauTruyenMau.TenDichVu;
                            chiPhiDichVu.DonViTinh = "Lần";
                            chiPhiDichVu.LoaiGia = string.Empty;
                            chiPhiDichVu.MaSoTheBHYT = taiKhoanBenhNhanChi.YeuCauTruyenMau.MaSoTheBHYT ?? string.Empty;
                            chiPhiDichVu.DanhSachCongNoChoThus = taiKhoanBenhNhanThu
                                .CongTyBaoHiemTuNhanCongNos.Where(o => o.YeuCauTruyenMauId == taiKhoanBenhNhanChi.YeuCauTruyenMau.Id).Select(o => new DanhSachCongNoVo { CongTyBaoHiemTuNhanId = o.CongTyBaoHiemTuNhanId, SoTienCongNoChoThu = o.SoTien })
                                .ToList();
                            chiPhiDichVu.DanhSachMienGiamVos = taiKhoanBenhNhanThu.MienGiamChiPhis
                                .Where(o => o.YeuCauTruyenMauId == taiKhoanBenhNhanChi.YeuCauTruyenMau.Id).GroupBy(
                                    o => new
                                    {
                                        o.LoaiMienGiam,
                                        o.TheVoucherId,
                                        o.MaTheVoucher,
                                        o.DoiTuongUuDaiId,
                                        o.LoaiChietKhau
                                    }, o => o,
                                    (k, v) => new DanhSachMienGiamVo
                                    {
                                        LoaiMienGiam = k.LoaiMienGiam,
                                        LoaiChietKhau = k.LoaiChietKhau,
                                        TheVoucherId = k.TheVoucherId,
                                        MaTheVoucher = k.MaTheVoucher,
                                        DoiTuongUuDaiId = k.DoiTuongUuDaiId,
                                        TiLe = v.Select(o => o.TiLe).DefaultIfEmpty().Sum(),
                                        SoTien = v.Select(o => o.SoTien).DefaultIfEmpty().Sum()
                                    }).ToList();

                            chiPhiDichVu.GhiChuMienGiamThem = taiKhoanBenhNhanChi.YeuCauTruyenMau.GhiChuMienGiamThem;
                            chiPhiDichVu.NoiDungGhiChuMiemGiamId = taiKhoanBenhNhanChi.YeuCauTruyenMau.NoiDungGhiChuMiemGiamId;

                            chiPhiDichVu.Khoa = taiKhoanBenhNhanChi.YeuCauTruyenMau.NoiThucHien != null
                                ? taiKhoanBenhNhanChi.YeuCauTruyenMau.NoiThucHien.KhoaPhong.Ten
                                : taiKhoanBenhNhanChi.YeuCauTruyenMau.NoiChiDinh.KhoaPhong.Ten;
                            chiPhiDichVu.DaThucHien = taiKhoanBenhNhanChi.YeuCauTruyenMau.TrangThai == EnumTrangThaiYeuCauTruyenMau.DaThucHien;
                        }
                        else if (taiKhoanBenhNhanChi.YeuCauDichVuGiuongBenhVienChiPhiBenhVien != null)
                        {
                            chiPhiDichVu.Id = taiKhoanBenhNhanChi.YeuCauDichVuGiuongBenhVienChiPhiBenhVien.Id;
                            chiPhiDichVu.NgayPhatSinh = taiKhoanBenhNhanChi.YeuCauDichVuGiuongBenhVienChiPhiBenhVien.NgayPhatSinh;
                            chiPhiDichVu.DichVuBenhVienId = taiKhoanBenhNhanChi.YeuCauDichVuGiuongBenhVienChiPhiBenhVien.DichVuGiuongBenhVienId;
                            chiPhiDichVu.LoaiNhom = NhomChiPhiNoiTru.DichVuGiuong;
                            chiPhiDichVu.NhomChiPhiBangKe = NhomChiPhiBangKe.NgayGiuongDieuTriNoiTru;
                            chiPhiDichVu.Ma = taiKhoanBenhNhanChi.YeuCauDichVuGiuongBenhVienChiPhiBenhVien.Ma;
                            chiPhiDichVu.Nhom = NhomChiPhiNoiTru.DichVuGiuong.GetDescription();
                            chiPhiDichVu.TenDichVu = taiKhoanBenhNhanChi.YeuCauDichVuGiuongBenhVienChiPhiBenhVien.Ten;
                            chiPhiDichVu.DonViTinh = "Ngày";
                            chiPhiDichVu.LoaiGia = string.Empty;
                            chiPhiDichVu.MaSoTheBHYT = taiKhoanBenhNhanChi.YeuCauDichVuGiuongBenhVienChiPhiBenhVien.YeuCauDichVuGiuongBenhVienChiPhiBHYTs.FirstOrDefault()?.MaSoTheBHYT ?? string.Empty;
                            chiPhiDichVu.DanhSachCongNoChoThus = taiKhoanBenhNhanThu
                                .CongTyBaoHiemTuNhanCongNos.Where(o => o.YeuCauDichVuGiuongBenhVienChiPhiBenhVienId == taiKhoanBenhNhanChi.YeuCauDichVuGiuongBenhVienChiPhiBenhVien.Id).Select(o => new DanhSachCongNoVo { CongTyBaoHiemTuNhanId = o.CongTyBaoHiemTuNhanId, SoTienCongNoChoThu = o.SoTien })
                                .ToList();
                            chiPhiDichVu.DanhSachMienGiamVos = taiKhoanBenhNhanThu.MienGiamChiPhis
                                .Where(o => o.YeuCauDichVuGiuongBenhVienChiPhiBenhVienId == taiKhoanBenhNhanChi.YeuCauDichVuGiuongBenhVienChiPhiBenhVien.Id).GroupBy(
                                    o => new
                                    {
                                        o.LoaiMienGiam,
                                        o.TheVoucherId,
                                        o.MaTheVoucher,
                                        o.DoiTuongUuDaiId,
                                        o.LoaiChietKhau
                                    }, o => o,
                                    (k, v) => new DanhSachMienGiamVo
                                    {
                                        LoaiMienGiam = k.LoaiMienGiam,
                                        LoaiChietKhau = k.LoaiChietKhau,
                                        TheVoucherId = k.TheVoucherId,
                                        MaTheVoucher = k.MaTheVoucher,
                                        DoiTuongUuDaiId = k.DoiTuongUuDaiId,
                                        TiLe = v.Select(o => o.TiLe).DefaultIfEmpty().Sum(),
                                        SoTien = v.Select(o => o.SoTien).DefaultIfEmpty().Sum()
                                    }).ToList();

                            chiPhiDichVu.GhiChuMienGiamThem = taiKhoanBenhNhanChi.YeuCauDichVuGiuongBenhVienChiPhiBenhVien.GhiChuMienGiamThem;
                            chiPhiDichVu.NoiDungGhiChuMiemGiamId = taiKhoanBenhNhanChi.YeuCauDichVuGiuongBenhVienChiPhiBenhVien.NoiDungGhiChuMiemGiamId;
                            chiPhiDichVu.DaThucHien = true;
                            chiPhiDichVu.Khoa = taiKhoanBenhNhanChi.YeuCauDichVuGiuongBenhVienChiPhiBenhVien.KhoaPhong.Ten;
                        }

                        thongTinPhieuThu.ChiPhiKhamChuaBenhNoiTruVos.Add(chiPhiDichVu);
                    }

                }
            }

            return thongTinPhieuThu;
        }
        public async Task<(long, string)> ThuTienTamUngNoiTru(ThuPhiTamUngNoiTruVo thuPhiTamUngNoiTruVo)
        {
            var ycTiepNhan = BaseRepository.GetById(thuPhiTamUngNoiTruVo.Id, x => x.Include(o => o.NoiTruBenhAn).Include(o => o.BenhNhan).ThenInclude(o => o.TaiKhoanBenhNhan));

            if (ycTiepNhan.BenhNhan == null)
                return (0, "Không có người bệnh");

            var tongThu = thuPhiTamUngNoiTruVo.TienMat.GetValueOrDefault() +
                          thuPhiTamUngNoiTruVo.ChuyenKhoan.GetValueOrDefault() +
                          thuPhiTamUngNoiTruVo.POS.GetValueOrDefault();
            var thuPhi = new TaiKhoanBenhNhanThu
            {
                LoaiThuTienBenhNhan = Enums.LoaiThuTienBenhNhan.ThuTamUng,
                LoaiNoiThu = Enums.LoaiNoiThu.ThuNgan,
                TienMat = thuPhiTamUngNoiTruVo.TienMat,
                ChuyenKhoan = thuPhiTamUngNoiTruVo.ChuyenKhoan,
                POS = thuPhiTamUngNoiTruVo.POS,
                NoiDungThu = thuPhiTamUngNoiTruVo.NoiDungThuTamUng,
                NgayThu = thuPhiTamUngNoiTruVo.NgayThuTamUng,
                SoPhieuHienThi = ResourceHelper.CreateSoTamUng(),
                NhanVienThucHienId = _userAgentHelper.GetCurrentUserId(),
                NoiThucHienId = _userAgentHelper.GetCurrentNoiLLamViecId()
            };

            //BVHD-3847: Khi khoa chưa tạo BA, BN đóng tiền Tạm ứng được tính là phiếu tạm ứng ngoại trú
            if (ycTiepNhan.NoiTruBenhAn == null && ycTiepNhan.YeuCauTiepNhanNgoaiTruCanQuyetToanId != null)
            {
                var ycTiepNhanNgoaiTru = BaseRepository.GetById(ycTiepNhan.YeuCauTiepNhanNgoaiTruCanQuyetToanId.Value, x => x.Include(o => o.BenhNhan).ThenInclude(o => o.TaiKhoanBenhNhan));
                var tk = ycTiepNhanNgoaiTru.BenhNhan.TaiKhoanBenhNhan ?? new TaiKhoanBenhNhan
                {
                    BenhNhan = ycTiepNhanNgoaiTru.BenhNhan,
                    SoDuTaiKhoan = 0
                };
                tk.SoDuTaiKhoan += tongThu;
                thuPhi.TaiKhoanBenhNhan = tk;

                ycTiepNhanNgoaiTru.TaiKhoanBenhNhanThus.Add(thuPhi);
            }
            else
            {
                var tk = ycTiepNhan.BenhNhan.TaiKhoanBenhNhan ?? new TaiKhoanBenhNhan
                {
                    BenhNhan = ycTiepNhan.BenhNhan,
                    SoDuTaiKhoan = 0
                };
                tk.SoDuTaiKhoan += tongThu;
                thuPhi.TaiKhoanBenhNhan = tk;

                ycTiepNhan.TaiKhoanBenhNhanThus.Add(thuPhi);
                ycTiepNhan.ChoTamUngThem = false;

            }
            BaseRepository.Context.SaveChanges();
            return (thuPhi.Id, string.Empty);

        }
        public async Task<KetQuaThuPhiKhamChuaBenhNoiTruVo> ThuPhiNoiTru(ThuPhiKhamChuaBenhNoiTruVo thuPhiKhamChuaBenhVo)
        {
            var ycTiepNhan = BaseRepository.GetById(thuPhiKhamChuaBenhVo.Id,
                x => x.Include(o => o.NoiTruBenhAn)
                    .Include(o => o.TheVoucherYeuCauTiepNhans).ThenInclude(g => g.TheVoucher).ThenInclude(v => v.Voucher).ThenInclude(v => v.VoucherChiTietMienGiams)
                    .Include(o => o.YeuCauKhamBenhs).ThenInclude(g => g.CongTyBaoHiemTuNhanCongNos)
                    .Include(o => o.YeuCauDichVuKyThuats).ThenInclude(g => g.CongTyBaoHiemTuNhanCongNos)
                    .Include(o => o.YeuCauDuocPhamBenhViens).ThenInclude(g => g.CongTyBaoHiemTuNhanCongNos)
                    .Include(o => o.YeuCauVatTuBenhViens).ThenInclude(g => g.CongTyBaoHiemTuNhanCongNos)
                    .Include(o => o.YeuCauTruyenMaus).ThenInclude(g => g.CongTyBaoHiemTuNhanCongNos)
                    .Include(o => o.YeuCauDichVuGiuongBenhVienChiPhiBenhViens).ThenInclude(g => g.CongTyBaoHiemTuNhanCongNos)
                    .Include(o => o.YeuCauDichVuGiuongBenhVienChiPhiBenhViens).ThenInclude(g => g.YeuCauDichVuGiuongBenhVienChiPhiBHYTs)
                    .Include(o => o.HoatDongGiuongBenhs)
                    .Include(o => o.YeuCauDichVuGiuongBenhVienChiPhiBHYTs)
                    .Include(o => o.DonThuocThanhToans).ThenInclude(g => g.DonThuocThanhToanChiTiets).ThenInclude(g => g.CongTyBaoHiemTuNhanCongNos)
                    .Include(o => o.DonThuocThanhToans).ThenInclude(g => g.DonThuocThanhToanChiTiets).ThenInclude(g => g.XuatKhoDuocPhamChiTietViTri).ThenInclude(g => g.NhapKhoDuocPhamChiTiet)
                    .Include(o => o.DonThuocThanhToans).ThenInclude(g => g.DonThuocThanhToanChiTiets).ThenInclude(g => g.YeuCauKhamBenhDonThuocChiTiet).ThenInclude(g => g.YeuCauKhamBenhDonThuoc)
                    //.Include(o => o.BenhNhan).ThenInclude(o => o.YeuCauGoiDichVus).ThenInclude(g => g.CongTyBaoHiemTuNhanCongNos)
                    //.Include(o => o.BenhNhan).ThenInclude(o => o.YeuCauGoiDichVus).ThenInclude(g => g.YeuCauDichVuKyThuats)
                    //.Include(o => o.BenhNhan).ThenInclude(o => o.YeuCauGoiDichVus).ThenInclude(g => g.YeuCauKhamBenhs)
                    //.Include(o => o.BenhNhan).ThenInclude(o => o.YeuCauGoiDichVus).ThenInclude(g => g.MienGiamChiPhis)
                    .Include(o => o.BenhNhan).ThenInclude(o => o.TaiKhoanBenhNhan)
                    .Include(o => o.TaiKhoanBenhNhanThus)
                    .Include(o => o.TaiKhoanBenhNhanChis)
                    .Include(o => o.DoiTuongUuDai).ThenInclude(ud => ud.DoiTuongUuDaiDichVuKhamBenhBenhViens)
                    .Include(o => o.DoiTuongUuDai).ThenInclude(ud => ud.DoiTuongUuDaiDichVuKyThuatBenhViens)
                    .Include(o => o.MienGiamChiPhis));

            long? yeuCauTiepNhanNgoaiTruCanQuyetToanId = ycTiepNhan.YeuCauTiepNhanNgoaiTruCanQuyetToanId;
            YeuCauTiepNhan yeuCauTiepNhanNgoaiTruCanQuyetToan = null;
            if (yeuCauTiepNhanNgoaiTruCanQuyetToanId != null)
            {
                yeuCauTiepNhanNgoaiTruCanQuyetToan = await BaseRepository.GetByIdAsync(yeuCauTiepNhanNgoaiTruCanQuyetToanId.Value,
                    x => x.Include(o => o.TheVoucherYeuCauTiepNhans).ThenInclude(g => g.TheVoucher).ThenInclude(v => v.Voucher).ThenInclude(v => v.VoucherChiTietMienGiams)
                        .Include(o => o.YeuCauKhamBenhs).ThenInclude(g => g.CongTyBaoHiemTuNhanCongNos)
                        .Include(o => o.YeuCauDichVuKyThuats).ThenInclude(g => g.CongTyBaoHiemTuNhanCongNos)
                        .Include(o => o.YeuCauDuocPhamBenhViens).ThenInclude(g => g.CongTyBaoHiemTuNhanCongNos)
                        .Include(o => o.YeuCauVatTuBenhViens).ThenInclude(g => g.CongTyBaoHiemTuNhanCongNos)
                        .Include(o => o.YeuCauDichVuGiuongBenhViens).ThenInclude(g => g.CongTyBaoHiemTuNhanCongNos)
                        .Include(o => o.DonThuocThanhToans).ThenInclude(g => g.DonThuocThanhToanChiTiets).ThenInclude(g => g.CongTyBaoHiemTuNhanCongNos)
                        .Include(o => o.DonThuocThanhToans).ThenInclude(g => g.DonThuocThanhToanChiTiets).ThenInclude(g => g.XuatKhoDuocPhamChiTietViTri).ThenInclude(g => g.NhapKhoDuocPhamChiTiet)
                        .Include(o => o.DonThuocThanhToans).ThenInclude(g => g.DonThuocThanhToanChiTiets).ThenInclude(g => g.YeuCauKhamBenhDonThuocChiTiet).ThenInclude(g => g.YeuCauKhamBenhDonThuoc)
                        //.Include(o => o.BenhNhan).ThenInclude(o => o.YeuCauGoiDichVus).ThenInclude(g => g.CongTyBaoHiemTuNhanCongNos)
                        //.Include(o => o.BenhNhan).ThenInclude(o => o.YeuCauGoiDichVus).ThenInclude(g => g.YeuCauDichVuKyThuats)
                        //.Include(o => o.BenhNhan).ThenInclude(o => o.YeuCauGoiDichVus).ThenInclude(g => g.YeuCauKhamBenhs)
                        //.Include(o => o.BenhNhan).ThenInclude(o => o.YeuCauGoiDichVus).ThenInclude(g => g.MienGiamChiPhis)
                        .Include(o => o.BenhNhan).ThenInclude(o => o.TaiKhoanBenhNhan)
                        .Include(o => o.TaiKhoanBenhNhanThus)
                        .Include(o => o.TaiKhoanBenhNhanChis)
                        .Include(o => o.DoiTuongUuDai).ThenInclude(ud => ud.DoiTuongUuDaiDichVuKhamBenhBenhViens)
                        .Include(o => o.DoiTuongUuDai).ThenInclude(ud => ud.DoiTuongUuDaiDichVuKyThuatBenhViens)
                        .Include(o => o.MienGiamChiPhis));
            }

            if (ycTiepNhan.BenhNhan == null)
                return new KetQuaThuPhiKhamChuaBenhNoiTruVo { Error = "Không có người bệnh" };

            //kiem tra thong tin truoc khi thanh toan
            if (yeuCauTiepNhanNgoaiTruCanQuyetToan == null)
            {
                var ycKhamBenhExcept = thuPhiKhamChuaBenhVo.DanhSachChiPhiKhamChuaBenhDaChons
                    .Where(o => o.LoaiNhom == NhomChiPhiNoiTru.DichVuKhamBenh).Select(o => o.Id).Except(ycTiepNhan
                        .YeuCauKhamBenhs
                        .Where(o => o.YeuCauGoiDichVuId == null && (!o.DuocHuongBaoHiem || o.BaoHiemChiTra != null) &&
                                    (o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan ||
                                     o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                                     o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                        .Select(o => o.Id));
                var ycKyThuatExcept = thuPhiKhamChuaBenhVo.DanhSachChiPhiKhamChuaBenhDaChons
                    .Where(o => o.LoaiNhom == NhomChiPhiNoiTru.DichVuKyThuat).Select(o => o.Id).Except(ycTiepNhan
                        .YeuCauDichVuKyThuats
                        .Where(o => o.YeuCauGoiDichVuId == null && (!o.DuocHuongBaoHiem || o.BaoHiemChiTra != null) &&
                                    (o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan ||
                                     o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                                     o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                        .Select(o => o.Id));
                var ycTruyenMauExcept = thuPhiKhamChuaBenhVo.DanhSachChiPhiKhamChuaBenhDaChons
                    .Where(o => o.LoaiNhom == NhomChiPhiNoiTru.TruyenMau).Select(o => o.Id).Except(ycTiepNhan
                        .YeuCauTruyenMaus
                        .Where(o => (!o.DuocHuongBaoHiem || o.BaoHiemChiTra != null) &&
                                    (o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan ||
                                     o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                                     o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                        .Select(o => o.Id));
                var ycGiuongExcept = thuPhiKhamChuaBenhVo.DanhSachChiPhiKhamChuaBenhDaChons
                    .Where(o => o.LoaiNhom == NhomChiPhiNoiTru.DichVuGiuong).Select(o => o.Id).Except(ycTiepNhan
                        .YeuCauDichVuGiuongBenhVienChiPhiBenhViens
                        .Where(o => o.YeuCauGoiDichVuId == null && (o.YeuCauDichVuGiuongBenhVienChiPhiBHYTs.All(gbh => !gbh.DuocHuongBaoHiem || gbh.BaoHiemChiTra != null)) &&
                                    (o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan ||
                                     o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                                     o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                        .Select(o => o.Id));
                var ycDuocPhamExcept = thuPhiKhamChuaBenhVo.DanhSachChiPhiKhamChuaBenhDaChons
                    .Where(o => o.LoaiNhom == NhomChiPhiNoiTru.DuocPham).Select(o => o.Id).Except(ycTiepNhan
                        .YeuCauDuocPhamBenhViens
                        .Where(o => o.YeuCauGoiDichVuId == null && (!o.DuocHuongBaoHiem || o.BaoHiemChiTra != null) &&
                                    (o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan ||
                                     o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                                     o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                        .Select(o => o.Id));
                var ycVatTuExcept = thuPhiKhamChuaBenhVo.DanhSachChiPhiKhamChuaBenhDaChons
                    .Where(o => o.LoaiNhom == NhomChiPhiNoiTru.VatTuTieuHao).Select(o => o.Id).Except(ycTiepNhan
                        .YeuCauVatTuBenhViens
                        .Where(o => o.YeuCauGoiDichVuId == null && (!o.DuocHuongBaoHiem || o.BaoHiemChiTra != null) &&
                                    (o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan ||
                                     o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                                     o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                        .Select(o => o.Id));
                var ycToaThuocExcept = thuPhiKhamChuaBenhVo.DanhSachChiPhiKhamChuaBenhDaChons
                    .Where(o => o.LoaiNhom == NhomChiPhiNoiTru.ToaThuoc).Select(o => o.Id).Except(ycTiepNhan
                        .DonThuocThanhToans
                        .Where(o => o.LoaiDonThuoc == Enums.EnumLoaiDonThuoc.ThuocBHYT &&
                                    (o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan ||
                                     o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                                     o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                        .SelectMany(o => o.DonThuocThanhToanChiTiets).Where(o => o.BaoHiemChiTra != null)
                        .Select(o => o.Id));

                //var ycGoiDvExcept = thuPhiKhamChuaBenhVo.DanhSachChiPhiKhamChuaBenhDaChons
                //    .Where(o => o.LoaiNhom == NhomChiPhiNoiTru.GoiDichVu).Select(o => o.Id).Except(ycTiepNhan.BenhNhan
                //        .YeuCauGoiDichVus
                //        .Where(o => o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan ||
                //                    o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                //                    o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan)
                //        .Select(o => o.Id));

                if (ycKhamBenhExcept.Any() || ycKyThuatExcept.Any() || ycGiuongExcept.Any() || ycDuocPhamExcept.Any() ||
                    ycVatTuExcept.Any() || ycTruyenMauExcept.Any() ||
                    ycToaThuocExcept.Any())
                    return new KetQuaThuPhiKhamChuaBenhNoiTruVo { Error = "Thông tin dịch vụ thanh toán không hợp lệ, vui lòng tải lại trang" };
            }
            else
            {
                var ycKhamBenhExcept = thuPhiKhamChuaBenhVo.DanhSachChiPhiKhamChuaBenhDaChons
                .Where(o => o.LoaiNhom == NhomChiPhiNoiTru.DichVuKhamBenh).Select(o => o.Id).Except(ycTiepNhan
                    .YeuCauKhamBenhs
                    .Where(o => o.YeuCauGoiDichVuId == null && (!o.DuocHuongBaoHiem || o.BaoHiemChiTra != null) &&
                                (o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                                 o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                    .Select(o => o.Id)
                    .Concat(yeuCauTiepNhanNgoaiTruCanQuyetToan
                            .YeuCauKhamBenhs
                            .Where(o => o.YeuCauGoiDichVuId == null && (!o.DuocHuongBaoHiem || o.BaoHiemChiTra != null) &&
                                        (o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                                         o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                            .Select(o => o.Id)));
                var ycKyThuatExcept = thuPhiKhamChuaBenhVo.DanhSachChiPhiKhamChuaBenhDaChons
                    .Where(o => o.LoaiNhom == NhomChiPhiNoiTru.DichVuKyThuat).Select(o => o.Id).Except(ycTiepNhan
                        .YeuCauDichVuKyThuats
                        .Where(o => o.YeuCauGoiDichVuId == null && (!o.DuocHuongBaoHiem || o.BaoHiemChiTra != null) &&
                                    (o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                                     o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                        .Select(o => o.Id)
                        .Concat(yeuCauTiepNhanNgoaiTruCanQuyetToan.YeuCauDichVuKyThuats
                            .Where(o => o.YeuCauGoiDichVuId == null && (!o.DuocHuongBaoHiem || o.BaoHiemChiTra != null) &&
                                        (o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                                         o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                            .Select(o => o.Id)));
                var ycTruyenMauExcept = thuPhiKhamChuaBenhVo.DanhSachChiPhiKhamChuaBenhDaChons
                    .Where(o => o.LoaiNhom == NhomChiPhiNoiTru.TruyenMau).Select(o => o.Id).Except(ycTiepNhan
                        .YeuCauTruyenMaus
                        .Where(o => (!o.DuocHuongBaoHiem || o.BaoHiemChiTra != null) &&
                                    (o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                                     o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                        .Select(o => o.Id));
                var ycGiuongExcept = thuPhiKhamChuaBenhVo.DanhSachChiPhiKhamChuaBenhDaChons
                    .Where(o => o.LoaiNhom == NhomChiPhiNoiTru.DichVuGiuong).Select(o => o.Id).Except(ycTiepNhan
                        .YeuCauDichVuGiuongBenhVienChiPhiBenhViens
                        .Where(o => o.YeuCauGoiDichVuId == null && (o.YeuCauDichVuGiuongBenhVienChiPhiBHYTs.All(gbh => !gbh.DuocHuongBaoHiem || gbh.BaoHiemChiTra != null)) &&
                                    (o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                                     o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                        .Select(o => o.Id));
                var ycDuocPhamExcept = thuPhiKhamChuaBenhVo.DanhSachChiPhiKhamChuaBenhDaChons
                    .Where(o => o.LoaiNhom == NhomChiPhiNoiTru.DuocPham).Select(o => o.Id).Except(ycTiepNhan
                        .YeuCauDuocPhamBenhViens
                        .Where(o => o.YeuCauGoiDichVuId == null && (!o.DuocHuongBaoHiem || o.BaoHiemChiTra != null) &&
                                    (o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                                     o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                        .Select(o => o.Id)
                        .Concat(yeuCauTiepNhanNgoaiTruCanQuyetToan
                            .YeuCauDuocPhamBenhViens
                            .Where(o => o.YeuCauGoiDichVuId == null && (!o.DuocHuongBaoHiem || o.BaoHiemChiTra != null) &&
                                        (o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                                         o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                            .Select(o => o.Id)));
                var ycVatTuExcept = thuPhiKhamChuaBenhVo.DanhSachChiPhiKhamChuaBenhDaChons
                    .Where(o => o.LoaiNhom == NhomChiPhiNoiTru.VatTuTieuHao).Select(o => o.Id).Except(ycTiepNhan
                        .YeuCauVatTuBenhViens
                        .Where(o => o.YeuCauGoiDichVuId == null && (!o.DuocHuongBaoHiem || o.BaoHiemChiTra != null) &&
                                    (o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                                     o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                        .Select(o => o.Id)
                        .Concat(yeuCauTiepNhanNgoaiTruCanQuyetToan
                            .YeuCauVatTuBenhViens
                            .Where(o => o.YeuCauGoiDichVuId == null && (!o.DuocHuongBaoHiem || o.BaoHiemChiTra != null) &&
                                        (o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                                         o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                            .Select(o => o.Id)));
                var ycToaThuocExcept = thuPhiKhamChuaBenhVo.DanhSachChiPhiKhamChuaBenhDaChons
                    .Where(o => o.LoaiNhom == NhomChiPhiNoiTru.ToaThuoc).Select(o => o.Id).Except(ycTiepNhan
                        .DonThuocThanhToans
                        .Where(o => o.LoaiDonThuoc == Enums.EnumLoaiDonThuoc.ThuocBHYT &&
                                    (o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                                     o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                        .SelectMany(o => o.DonThuocThanhToanChiTiets).Where(o => o.BaoHiemChiTra != null)
                        .Select(o => o.Id)
                        .Concat(yeuCauTiepNhanNgoaiTruCanQuyetToan
                            .DonThuocThanhToans
                            .Where(o => o.LoaiDonThuoc == Enums.EnumLoaiDonThuoc.ThuocBHYT &&
                                        (o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                                         o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                            .SelectMany(o => o.DonThuocThanhToanChiTiets).Where(o => o.BaoHiemChiTra != null)
                            .Select(o => o.Id)));

                //var ycGoiDvExcept = thuPhiKhamChuaBenhVo.DanhSachChiPhiKhamChuaBenhDaChons
                //    .Where(o => o.LoaiNhom == NhomChiPhiNoiTru.GoiDichVu).Select(o => o.Id).Except(ycTiepNhan.BenhNhan.YeuCauGoiDichVus
                //        .Where(o => o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                //                    o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan)
                //        .Select(o => o.Id));

                if (ycKhamBenhExcept.Any() || ycKyThuatExcept.Any() || ycGiuongExcept.Any() || ycDuocPhamExcept.Any() || ycVatTuExcept.Any() || ycTruyenMauExcept.Any() ||
                    ycToaThuocExcept.Any())
                    return new KetQuaThuPhiKhamChuaBenhNoiTruVo { Error = "Thông tin dịch vụ thanh toán không hợp lệ, vui lòng tải lại trang" };
            }


            //var tongThu = thuPhiKhamChuaBenhVo.TienMat.GetValueOrDefault() +
            //              thuPhiKhamChuaBenhVo.ChuyenKhoan.GetValueOrDefault() +
            //              thuPhiKhamChuaBenhVo.POS.GetValueOrDefault() + thuPhiKhamChuaBenhVo.SoTienCongNo.GetValueOrDefault() + thuPhiKhamChuaBenhVo.SoTienHoanLaiThanhToan.GetValueOrDefault();
            var tongThuBenhNhan = thuPhiKhamChuaBenhVo.TienMat.GetValueOrDefault() +
                                  thuPhiKhamChuaBenhVo.ChuyenKhoan.GetValueOrDefault() +
                                  thuPhiKhamChuaBenhVo.POS.GetValueOrDefault();

            var dsChiPhi = await GetDanhSachChiPhiKhamChuaBenhChuaThu(thuPhiKhamChuaBenhVo.Id);
            var dsChiPhiDaChon = thuPhiKhamChuaBenhVo.DanhSachChiPhiKhamChuaBenhDaChons;

            foreach (var chiPhiKhamChuaBenhVo in dsChiPhiDaChon)
            {
                var chiphi = dsChiPhi.FirstOrDefault(o => o.LoaiNhom == chiPhiKhamChuaBenhVo.LoaiNhom && o.Id == chiPhiKhamChuaBenhVo.Id);
                if (chiphi == null || !chiphi.ThanhTien.AlmostEqual(chiPhiKhamChuaBenhVo.ThanhTien) || !chiphi.BHYTThanhToan.AlmostEqual(chiPhiKhamChuaBenhVo.BHYTThanhToan))
                {
                    return new KetQuaThuPhiKhamChuaBenhNoiTruVo { Error = "Thông tin dịch vụ thanh toán không hợp lệ, vui lòng tải lại trang" };
                }
                if (chiPhiKhamChuaBenhVo.TongCongNo > chiPhiKhamChuaBenhVo.ThanhTien && chiPhiKhamChuaBenhVo.TongCongNo > Math.Round(chiPhiKhamChuaBenhVo.ThanhTien, 2, MidpointRounding.AwayFromZero))
                {
                    return new KetQuaThuPhiKhamChuaBenhNoiTruVo { Error = "Số tiền BHTN thanh toán lớn hơn thành tiền" };
                }
                var soTienTruocMienGiam = chiPhiKhamChuaBenhVo.ThanhTien - chiPhiKhamChuaBenhVo.BHYTThanhToan;

                decimal soTienMienGiamTheoDv = 0;

                foreach (var mienGiamTheoTiLe in chiPhiKhamChuaBenhVo.DanhSachMienGiamVos.Where(o => o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoTiLe))
                {
                    mienGiamTheoTiLe.SoTien = Math.Round((soTienTruocMienGiam * mienGiamTheoTiLe.TiLe.GetValueOrDefault() / 100), 2, MidpointRounding.AwayFromZero);
                    soTienMienGiamTheoDv += mienGiamTheoTiLe.SoTien;
                }
                foreach (var mienGiamTheoTiLe in chiPhiKhamChuaBenhVo.DanhSachMienGiamVos.Where(o => o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoSoTien))
                {
                    soTienMienGiamTheoDv += mienGiamTheoTiLe.SoTien;
                }
                if (soTienMienGiamTheoDv > chiPhiKhamChuaBenhVo.ThanhTien && soTienMienGiamTheoDv > Math.Round(chiPhiKhamChuaBenhVo.ThanhTien, 2, MidpointRounding.AwayFromZero))
                {
                    return new KetQuaThuPhiKhamChuaBenhNoiTruVo { Error = "Số tiền miễn giảm lớn hơn thành tiền" };
                }
                chiPhiKhamChuaBenhVo.SoTienMG = soTienMienGiamTheoDv;
            }
            var thuTamUng = ycTiepNhan.TaiKhoanBenhNhanThus.Where(o => o.DaHuy != true && o.LoaiThuTienBenhNhan == LoaiThuTienBenhNhan.ThuTamUng && o.ThuTienGoiDichVu != true && o.PhieuHoanUngId == null).ToList();
            if (yeuCauTiepNhanNgoaiTruCanQuyetToan != null)
            {
                thuTamUng.AddRange(yeuCauTiepNhanNgoaiTruCanQuyetToan.TaiKhoanBenhNhanThus.Where(o => o.DaHuy != true && o.LoaiThuTienBenhNhan == LoaiThuTienBenhNhan.ThuTamUng && o.ThuTienGoiDichVu != true && o.PhieuHoanUngId == null).ToList());
            }
            var soTienDaTamUng = thuTamUng.Select(o => o.TienMat.GetValueOrDefault(0) + o.ChuyenKhoan.GetValueOrDefault(0) + o.POS.GetValueOrDefault(0)).DefaultIfEmpty(0).Sum();
            var soTienCanThu = Math.Round(dsChiPhiDaChon.Sum(o => o.BNConPhaiThanhToan), MidpointRounding.AwayFromZero);

            if ((!thuPhiKhamChuaBenhVo.SoTienCongNo.GetValueOrDefault().SoTienTuongDuong(0) && thuPhiKhamChuaBenhVo.SoTienCongNo.GetValueOrDefault() > soTienCanThu)
                || (soTienDaTamUng + thuPhiKhamChuaBenhVo.SoTienCongNo.GetValueOrDefault() >= soTienCanThu && !tongThuBenhNhan.SoTienTuongDuong(0))
                || soTienDaTamUng.SoTienTuongDuong(0) && !soTienCanThu.SoTienTuongDuong(tongThuBenhNhan + thuPhiKhamChuaBenhVo.SoTienCongNo.GetValueOrDefault())
                || soTienDaTamUng + thuPhiKhamChuaBenhVo.SoTienCongNo.GetValueOrDefault() < soTienCanThu && !soTienCanThu.SoTienTuongDuong(tongThuBenhNhan + thuPhiKhamChuaBenhVo.SoTienCongNo.GetValueOrDefault() + soTienDaTamUng))
                return new KetQuaThuPhiKhamChuaBenhNoiTruVo { Error = "Số tiền thanh toán không hợp lệ" };

            var soTienMienGiam = dsChiPhiDaChon.Sum(o => o.SoTienMG);

            var tk = ycTiepNhan.BenhNhan.TaiKhoanBenhNhan ?? new TaiKhoanBenhNhan
            {
                BenhNhan = ycTiepNhan.BenhNhan
            };
            var userId = _userAgentHelper.GetCurrentUserId();
            var userThuNgan = _userRepository.GetById(_userAgentHelper.GetCurrentUserId());
            var maTaiKhoan = userId.ToString();
            if (userThuNgan.Email != null && userThuNgan.Email.IndexOf("@") > 0)
            {
                maTaiKhoan = userThuNgan.Email.Substring(0, userThuNgan.Email.IndexOf("@") > 10 ? 10 : userThuNgan.Email.IndexOf("@"));
            }
            var thuPhi = new TaiKhoanBenhNhanThu
            {
                TaiKhoanBenhNhan = tk,
                LoaiThuTienBenhNhan = Enums.LoaiThuTienBenhNhan.ThuTheoChiPhi,
                LoaiNoiThu = Enums.LoaiNoiThu.ThuNgan,
                TienMat = thuPhiKhamChuaBenhVo.TienMat,
                ChuyenKhoan = thuPhiKhamChuaBenhVo.ChuyenKhoan,
                POS = thuPhiKhamChuaBenhVo.POS,
                CongNo = thuPhiKhamChuaBenhVo.SoTienCongNo,
                NoiDungThu = thuPhiKhamChuaBenhVo.NoiDungThu,
                NgayThu = thuPhiKhamChuaBenhVo.NgayThu,
                SoPhieuHienThi = ResourceHelper.CreateSoPhieuThu(userId, maTaiKhoan),
                NhanVienThucHienId = userId,
                NoiThucHienId = _userAgentHelper.GetCurrentNoiLLamViecId()
            };

            foreach (var chiphi in dsChiPhiDaChon.Where(o => o.LoaiNhom == NhomChiPhiNoiTru.DichVuKhamBenh))
            {
                var yc = chiphi.DichVuNgoaiTru ? yeuCauTiepNhanNgoaiTruCanQuyetToan.YeuCauKhamBenhs.First(o => o.Id == chiphi.Id) : ycTiepNhan.YeuCauKhamBenhs.First(o => o.Id == chiphi.Id);
                #region cong no update 02/02/2021
                foreach (var ycCongTyBaoHiemTuNhanCongNo in yc.CongTyBaoHiemTuNhanCongNos.Where(o => o.TaiKhoanBenhNhanThuId == null))
                {
                    ycCongTyBaoHiemTuNhanCongNo.WillDelete = true;
                }
                if (chiphi.TongCongNo > 0)
                {
                    foreach (var chiphiDanhSachCongNoChoThu in chiphi.DanhSachCongNoChoThus)
                    {
                        if (chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu.AlmostEqual(0))
                            continue;
                        yc.CongTyBaoHiemTuNhanCongNos.Add(new CongTyBaoHiemTuNhanCongNo
                        {
                            TaiKhoanBenhNhanThu = thuPhi,
                            CongTyBaoHiemTuNhanId = chiphiDanhSachCongNoChoThu.CongTyBaoHiemTuNhanId,
                            SoTien = chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu
                        });
                    }
                }
                yc.SoTienBaoHiemTuNhanChiTra = chiphi.TongCongNo;
                #endregion
                #region mien giam update 02/02/2021
                foreach (var mienGiam in yc.MienGiamChiPhis.Where(o => o.TaiKhoanBenhNhanThuId == null))
                {
                    mienGiam.WillDelete = true;
                }
                //mien giam theo uu dai noi gioi thieu: BVHD-3882
                var mienGiamNoiGioiThieu = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.NoiGioiThieuId != null);
                if (mienGiamNoiGioiThieu != null)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                        NoiGioiThieuId = mienGiamNoiGioiThieu.NoiGioiThieuId,
                        LoaiChietKhau = mienGiamNoiGioiThieu.LoaiChietKhau,
                        TiLe = mienGiamNoiGioiThieu.TiLe,
                        SoTien = mienGiamNoiGioiThieu.SoTien
                    });
                }
                //mien giam theo uu dai
                var mienGiamUuDai = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.DoiTuongUuDaiId != null && o.TiLe != 0);
                if (mienGiamUuDai != null)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                        DoiTuongUuDaiId = mienGiamUuDai.DoiTuongUuDaiId,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                        TiLe = mienGiamUuDai.TiLe.GetValueOrDefault(),
                        SoTien = mienGiamUuDai.SoTien
                    });
                }
                //mien giam theo voucher
                var mienGiamVouchers = chiphi.DanhSachMienGiamVos.Where(o => o.TheVoucherId != null).ToList();
                foreach (var voucher in mienGiamVouchers)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.Voucher,
                        TheVoucherId = voucher.TheVoucherId,
                        LoaiChietKhau = voucher.LoaiChietKhau,
                        MaTheVoucher = voucher.MaTheVoucher,
                        TiLe = voucher.TiLe.GetValueOrDefault(),
                        SoTien = voucher.SoTien
                    });
                }
                //mien giam them theo ti le
                var mienGiamThemTiLe = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoTiLe);
                if (mienGiamThemTiLe != null && mienGiamThemTiLe.TiLe.GetValueOrDefault() != 0)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                        TiLe = mienGiamThemTiLe.TiLe,
                        SoTien = mienGiamThemTiLe.SoTien
                    });
                }
                //mien giam them theo so tien
                var mienGiamThemSoTien = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoSoTien);
                if (mienGiamThemSoTien != null && !mienGiamThemSoTien.SoTien.AlmostEqual(0))
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoSoTien,
                        SoTien = mienGiamThemSoTien.SoTien
                    });
                }

                yc.SoTienMienGiam = chiphi.SoTienMG;
                if ((mienGiamThemTiLe?.SoTien ?? 0).AlmostEqual(0) && (mienGiamThemSoTien?.SoTien ?? 0).AlmostEqual(0))
                {
                    yc.GhiChuMienGiamThem = null;
                    yc.NoiDungGhiChuMiemGiamId = null;
                }
                else
                {
                    yc.GhiChuMienGiamThem = chiphi.GhiChuMienGiamThem;
                    yc.NoiDungGhiChuMiemGiamId = chiphi.NoiDungGhiChuMiemGiamId;
                }
                #endregion
                yc.SoTienBenhNhanDaChi = yc.SoTienBenhNhanDaChi.GetValueOrDefault() + chiphi.BNConPhaiThanhToan;
                yc.TrangThaiThanhToan = Enums.TrangThaiThanhToan.DaThanhToan;
                thuPhi.TaiKhoanBenhNhanChis.Add(new TaiKhoanBenhNhanChi
                {
                    TaiKhoanBenhNhan = tk,
                    LoaiChiTienBenhNhan = Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi,
                    TienChiPhi = chiphi.BNConPhaiThanhToan,
                    NoiDungChi = Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi.GetDescription(),
                    NgayChi = DateTime.Now,
                    SoPhieuHienThi = thuPhi.SoPhieuHienThi,
                    YeuCauKhamBenh = yc,
                    Gia = yc.Gia,
                    SoLuong = 1,
                    DonGiaBaoHiem = yc.DonGiaBaoHiem,
                    MucHuongBaoHiem = yc.MucHuongBaoHiem,
                    TiLeBaoHiemThanhToan = yc.TiLeBaoHiemThanhToan,
                    SoTienMienGiam = yc.SoTienMienGiam,
                    SoTienBaoHiemTuNhanChiTra = yc.SoTienBaoHiemTuNhanChiTra,
                    YeuCauTiepNhanId = ycTiepNhan.Id,
                    NhanVienThucHienId = _userAgentHelper.GetCurrentUserId(),
                    NoiThucHienId = _userAgentHelper.GetCurrentNoiLLamViecId()
                });
            }

            foreach (var chiphi in dsChiPhiDaChon.Where(o => o.LoaiNhom == NhomChiPhiNoiTru.DichVuKyThuat))
            {
                var yc = chiphi.DichVuNgoaiTru ? yeuCauTiepNhanNgoaiTruCanQuyetToan.YeuCauDichVuKyThuats.First(o => o.Id == chiphi.Id) : ycTiepNhan.YeuCauDichVuKyThuats.First(o => o.Id == chiphi.Id);
                #region cong no update 02/02/2021
                foreach (var ycCongTyBaoHiemTuNhanCongNo in yc.CongTyBaoHiemTuNhanCongNos.Where(o => o.TaiKhoanBenhNhanThuId == null))
                {
                    ycCongTyBaoHiemTuNhanCongNo.WillDelete = true;
                }
                if (chiphi.TongCongNo > 0)
                {
                    foreach (var chiphiDanhSachCongNoChoThu in chiphi.DanhSachCongNoChoThus)
                    {
                        if (chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu.AlmostEqual(0))
                            continue;
                        yc.CongTyBaoHiemTuNhanCongNos.Add(new CongTyBaoHiemTuNhanCongNo
                        {
                            TaiKhoanBenhNhanThu = thuPhi,
                            CongTyBaoHiemTuNhanId = chiphiDanhSachCongNoChoThu.CongTyBaoHiemTuNhanId,
                            SoTien = chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu
                        });
                    }
                }
                yc.SoTienBaoHiemTuNhanChiTra = chiphi.TongCongNo;
                #endregion
                #region mien giam update 02/02/2021
                foreach (var mienGiam in yc.MienGiamChiPhis.Where(o => o.TaiKhoanBenhNhanThuId == null))
                {
                    mienGiam.WillDelete = true;
                }
                //mien giam theo uu dai noi gioi thieu: BVHD-3882
                var mienGiamNoiGioiThieu = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.NoiGioiThieuId != null);
                if (mienGiamNoiGioiThieu != null)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                        NoiGioiThieuId = mienGiamNoiGioiThieu.NoiGioiThieuId,
                        LoaiChietKhau = mienGiamNoiGioiThieu.LoaiChietKhau,
                        TiLe = mienGiamNoiGioiThieu.TiLe,
                        SoTien = mienGiamNoiGioiThieu.SoTien
                    });
                }
                //mien giam theo uu dai
                var mienGiamUuDai = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.DoiTuongUuDaiId != null && o.TiLe != 0);
                if (mienGiamUuDai != null)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                        DoiTuongUuDaiId = mienGiamUuDai.DoiTuongUuDaiId,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                        TiLe = mienGiamUuDai.TiLe.GetValueOrDefault(),
                        SoTien = mienGiamUuDai.SoTien
                    });
                }
                //mien giam theo voucher
                var mienGiamVouchers = chiphi.DanhSachMienGiamVos.Where(o => o.TheVoucherId != null).ToList();
                foreach (var voucher in mienGiamVouchers)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.Voucher,
                        TheVoucherId = voucher.TheVoucherId,
                        LoaiChietKhau = voucher.LoaiChietKhau,
                        MaTheVoucher = voucher.MaTheVoucher,
                        TiLe = voucher.TiLe.GetValueOrDefault(),
                        SoTien = voucher.SoTien
                    });
                }
                //mien giam them theo ti le
                var mienGiamThemTiLe = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoTiLe);
                if (mienGiamThemTiLe != null && mienGiamThemTiLe.TiLe.GetValueOrDefault() != 0)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                        TiLe = mienGiamThemTiLe.TiLe,
                        SoTien = mienGiamThemTiLe.SoTien
                    });
                }
                //mien giam them theo so tien
                var mienGiamThemSoTien = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoSoTien);
                if (mienGiamThemSoTien != null && !mienGiamThemSoTien.SoTien.AlmostEqual(0))
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoSoTien,
                        SoTien = mienGiamThemSoTien.SoTien
                    });
                }

                yc.SoTienMienGiam = chiphi.SoTienMG;
                if ((mienGiamThemTiLe?.SoTien ?? 0).AlmostEqual(0) && (mienGiamThemSoTien?.SoTien ?? 0).AlmostEqual(0))
                {
                    yc.GhiChuMienGiamThem = null;
                    yc.NoiDungGhiChuMiemGiamId = null;
                }
                else
                {
                    yc.GhiChuMienGiamThem = chiphi.GhiChuMienGiamThem;
                    yc.NoiDungGhiChuMiemGiamId = chiphi.NoiDungGhiChuMiemGiamId;
                }
                #endregion
                yc.SoTienBenhNhanDaChi = yc.SoTienBenhNhanDaChi.GetValueOrDefault() + chiphi.BNConPhaiThanhToan;
                yc.TrangThaiThanhToan = Enums.TrangThaiThanhToan.DaThanhToan;
                thuPhi.TaiKhoanBenhNhanChis.Add(new TaiKhoanBenhNhanChi
                {
                    TaiKhoanBenhNhan = tk,
                    LoaiChiTienBenhNhan = Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi,
                    TienChiPhi = chiphi.BNConPhaiThanhToan,
                    NoiDungChi = Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi.GetDescription(),
                    NgayChi = DateTime.Now,
                    SoPhieuHienThi = thuPhi.SoPhieuHienThi,
                    YeuCauDichVuKyThuat = yc,
                    Gia = yc.Gia,
                    SoLuong = yc.SoLan,
                    DonGiaBaoHiem = yc.DonGiaBaoHiem,
                    MucHuongBaoHiem = yc.MucHuongBaoHiem,
                    TiLeBaoHiemThanhToan = yc.TiLeBaoHiemThanhToan,
                    SoTienMienGiam = yc.SoTienMienGiam,
                    SoTienBaoHiemTuNhanChiTra = yc.SoTienBaoHiemTuNhanChiTra,
                    YeuCauTiepNhanId = ycTiepNhan.Id,
                    NhanVienThucHienId = _userAgentHelper.GetCurrentUserId(),
                    NoiThucHienId = _userAgentHelper.GetCurrentNoiLLamViecId()
                });
            }

            foreach (var chiphi in dsChiPhiDaChon.Where(o => o.LoaiNhom == NhomChiPhiNoiTru.TruyenMau))
            {
                var yc = ycTiepNhan.YeuCauTruyenMaus.First(o => o.Id == chiphi.Id);
                #region cong no update 02/02/2021
                foreach (var ycCongTyBaoHiemTuNhanCongNo in yc.CongTyBaoHiemTuNhanCongNos.Where(o => o.TaiKhoanBenhNhanThuId == null))
                {
                    ycCongTyBaoHiemTuNhanCongNo.WillDelete = true;
                }
                if (chiphi.TongCongNo > 0)
                {
                    foreach (var chiphiDanhSachCongNoChoThu in chiphi.DanhSachCongNoChoThus)
                    {
                        if (chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu.AlmostEqual(0))
                            continue;
                        yc.CongTyBaoHiemTuNhanCongNos.Add(new CongTyBaoHiemTuNhanCongNo
                        {
                            TaiKhoanBenhNhanThu = thuPhi,
                            CongTyBaoHiemTuNhanId = chiphiDanhSachCongNoChoThu.CongTyBaoHiemTuNhanId,
                            SoTien = chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu
                        });
                    }
                }
                yc.SoTienBaoHiemTuNhanChiTra = chiphi.TongCongNo;
                #endregion
                #region mien giam
                //mien giam theo uu dai
                var uuDai = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.DoiTuongUuDaiId != null && o.TiLe != 0);
                var mienGiamChiPhiTruoc = ycTiepNhan.MienGiamChiPhis.Where(o => o.YeuCauDichVuKyThuatId == yc.Id).ToList();
                var mienGiamTheoUuDaiGroups = mienGiamChiPhiTruoc.Where(o => o.DoiTuongUuDaiId != null).GroupBy(o => o.DoiTuongUuDaiId.Value);
                bool daMienGiamUuDai = false;
                foreach (var mienGiamTheoUuDaiGroup in mienGiamTheoUuDaiGroups)
                {
                    if (mienGiamTheoUuDaiGroup.Key != uuDai?.DoiTuongUuDaiId)
                    {
                        yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                        {
                            TaiKhoanBenhNhanThu = thuPhi,
                            YeuCauTiepNhanId = ycTiepNhan.Id,
                            LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                            DoiTuongUuDaiId = mienGiamTheoUuDaiGroup.Key,
                            LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                            TiLe = 0 - mienGiamTheoUuDaiGroup.Sum(o => o.TiLe.GetValueOrDefault()),
                            SoTien = 0 - mienGiamTheoUuDaiGroup.Sum(o => o.SoTien)
                        });
                    }
                    else
                    {
                        daMienGiamUuDai = true;
                        if (uuDai.TiLe.GetValueOrDefault() != mienGiamTheoUuDaiGroup.Sum(o => o.TiLe.GetValueOrDefault()) || !uuDai.SoTien.AlmostEqual(mienGiamTheoUuDaiGroup.Sum(o => o.SoTien)))
                        {
                            yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                            {
                                TaiKhoanBenhNhanThu = thuPhi,
                                YeuCauTiepNhanId = ycTiepNhan.Id,
                                LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                                DoiTuongUuDaiId = mienGiamTheoUuDaiGroup.Key,
                                LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                                TiLe = uuDai.TiLe.GetValueOrDefault() - mienGiamTheoUuDaiGroup.Sum(o => o.TiLe.GetValueOrDefault()),
                                SoTien = uuDai.SoTien - mienGiamTheoUuDaiGroup.Sum(o => o.SoTien)
                            });
                        }
                    }
                }
                if (!daMienGiamUuDai && uuDai != null)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                        DoiTuongUuDaiId = uuDai.DoiTuongUuDaiId,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                        TiLe = uuDai.TiLe.GetValueOrDefault(),
                        SoTien = uuDai.SoTien
                    });
                }

                //mien giam theo voucher
                var vouchers = chiphi.DanhSachMienGiamVos.Where(o => o.TheVoucherId != null).ToList();
                var mienGiamTheoVoucherGroups = mienGiamChiPhiTruoc.Where(o => o.TheVoucherId != null).GroupBy(o => o.TheVoucherId.Value).ToList();

                foreach (var mienGiamTheoVoucherGroup in mienGiamTheoVoucherGroups)
                {
                    if (!vouchers.Select(o => o.TheVoucherId).Contains(mienGiamTheoVoucherGroup.Key))
                    {
                        yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                        {
                            TaiKhoanBenhNhanThu = thuPhi,
                            YeuCauTiepNhanId = ycTiepNhan.Id,
                            LoaiMienGiam = Enums.LoaiMienGiam.Voucher,
                            TheVoucherId = mienGiamTheoVoucherGroup.Key,
                            LoaiChietKhau = mienGiamTheoVoucherGroup.First().LoaiChietKhau,
                            MaTheVoucher = mienGiamTheoVoucherGroup.First().MaTheVoucher,
                            TiLe = 0 - mienGiamTheoVoucherGroup.Sum(o => o.TiLe.GetValueOrDefault()),
                            SoTien = 0 - mienGiamTheoVoucherGroup.Sum(o => o.SoTien)
                        });
                    }
                }

                foreach (var voucher in vouchers)
                {
                    var mienGiamTheoVoucherGroup = mienGiamTheoVoucherGroups.FirstOrDefault(o => o.Key == voucher.TheVoucherId);
                    if (mienGiamTheoVoucherGroup != null)
                    {
                        if (voucher.TiLe.GetValueOrDefault() != mienGiamTheoVoucherGroup.Sum(o => o.TiLe.GetValueOrDefault()) || !voucher.SoTien.AlmostEqual(mienGiamTheoVoucherGroup.Sum(o => o.SoTien)))
                        {
                            yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                            {
                                TaiKhoanBenhNhanThu = thuPhi,
                                YeuCauTiepNhanId = ycTiepNhan.Id,
                                LoaiMienGiam = Enums.LoaiMienGiam.Voucher,
                                TheVoucherId = voucher.TheVoucherId,
                                LoaiChietKhau = voucher.LoaiChietKhau,
                                MaTheVoucher = voucher.MaTheVoucher,
                                TiLe = voucher.TiLe.GetValueOrDefault() - mienGiamTheoVoucherGroup.Sum(o => o.TiLe.GetValueOrDefault()),
                                SoTien = voucher.SoTien - mienGiamTheoVoucherGroup.Sum(o => o.SoTien)
                            });
                        }
                    }
                    else
                    {
                        yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                        {
                            TaiKhoanBenhNhanThu = thuPhi,
                            YeuCauTiepNhanId = ycTiepNhan.Id,
                            LoaiMienGiam = Enums.LoaiMienGiam.Voucher,
                            TheVoucherId = voucher.TheVoucherId,
                            LoaiChietKhau = voucher.LoaiChietKhau,
                            MaTheVoucher = voucher.MaTheVoucher,
                            TiLe = voucher.TiLe.GetValueOrDefault(),
                            SoTien = voucher.SoTien
                        });
                    }
                }

                //mien giam them theo ti le
                var mienGiamThemTiLeTruoc = mienGiamChiPhiTruoc.Where(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoTiLe).ToList();
                var mienGiamThemTiLe = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoTiLe);
                if (mienGiamThemTiLeTruoc.Any())
                {
                    if (mienGiamThemTiLe == null ||
                        (mienGiamThemTiLe.TiLe.GetValueOrDefault() != mienGiamThemTiLeTruoc.Sum(o => o.TiLe.GetValueOrDefault()) || !mienGiamThemTiLe.SoTien.AlmostEqual(mienGiamThemTiLeTruoc.Sum(o => o.SoTien))))
                    {
                        yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                        {
                            TaiKhoanBenhNhanThu = thuPhi,
                            YeuCauTiepNhanId = ycTiepNhan.Id,
                            LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                            LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                            TiLe = (mienGiamThemTiLe?.TiLe ?? 0) - mienGiamThemTiLeTruoc.Sum(o => o.TiLe.GetValueOrDefault()),
                            SoTien = (mienGiamThemTiLe?.SoTien ?? 0) - mienGiamThemTiLeTruoc.Sum(o => o.SoTien)
                        });
                    }
                }
                else if (mienGiamThemTiLe != null && mienGiamThemTiLe.TiLe.GetValueOrDefault() != 0)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                        TiLe = mienGiamThemTiLe.TiLe,
                        SoTien = mienGiamThemTiLe.SoTien
                    });
                }

                //mien giam them theo so tien
                var mienGiamThemSoTienTruoc = mienGiamChiPhiTruoc.Where(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoSoTien).ToList();
                var mienGiamThemSoTien = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoSoTien);
                if (mienGiamThemSoTienTruoc.Any())
                {
                    if (mienGiamThemSoTien == null || !mienGiamThemSoTien.SoTien.AlmostEqual(mienGiamThemSoTienTruoc.Sum(o => o.SoTien)))
                    {
                        yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                        {
                            TaiKhoanBenhNhanThu = thuPhi,
                            YeuCauTiepNhanId = ycTiepNhan.Id,
                            LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                            LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoSoTien,
                            SoTien = (mienGiamThemSoTien?.SoTien ?? 0) - mienGiamThemSoTienTruoc.Sum(o => o.SoTien)
                        });
                    }
                }
                else if (mienGiamThemSoTien != null && !mienGiamThemSoTien.SoTien.AlmostEqual(0))
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoSoTien,
                        SoTien = mienGiamThemSoTien.SoTien
                    });
                }
                yc.SoTienMienGiam = chiphi.SoTienMG;

                if ((mienGiamThemTiLe?.SoTien ?? 0).AlmostEqual(0) && (mienGiamThemSoTien?.SoTien ?? 0).AlmostEqual(0))
                {
                    yc.GhiChuMienGiamThem = null;
                    yc.NoiDungGhiChuMiemGiamId = null;
                }
                else
                {
                    yc.GhiChuMienGiamThem = chiphi.GhiChuMienGiamThem;
                    yc.NoiDungGhiChuMiemGiamId = chiphi.NoiDungGhiChuMiemGiamId;
                }
                #endregion
                yc.SoTienBenhNhanDaChi = yc.SoTienBenhNhanDaChi.GetValueOrDefault() + chiphi.BNConPhaiThanhToan;
                yc.TrangThaiThanhToan = Enums.TrangThaiThanhToan.DaThanhToan;
                thuPhi.TaiKhoanBenhNhanChis.Add(new TaiKhoanBenhNhanChi
                {
                    TaiKhoanBenhNhan = tk,
                    LoaiChiTienBenhNhan = Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi,
                    TienChiPhi = chiphi.BNConPhaiThanhToan,
                    NoiDungChi = Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi.GetDescription(),
                    NgayChi = DateTime.Now,
                    SoPhieuHienThi = thuPhi.SoPhieuHienThi,
                    YeuCauTruyenMau = yc,
                    Gia = yc.DonGiaBan,
                    SoLuong = 1,
                    DonGiaBaoHiem = yc.DonGiaBaoHiem,
                    MucHuongBaoHiem = yc.MucHuongBaoHiem,
                    TiLeBaoHiemThanhToan = yc.TiLeBaoHiemThanhToan,
                    SoTienMienGiam = yc.SoTienMienGiam,
                    SoTienBaoHiemTuNhanChiTra = yc.SoTienBaoHiemTuNhanChiTra,
                    YeuCauTiepNhanId = ycTiepNhan.Id,
                    NhanVienThucHienId = _userAgentHelper.GetCurrentUserId(),
                    NoiThucHienId = _userAgentHelper.GetCurrentNoiLLamViecId()
                });
            }

            foreach (var chiphi in dsChiPhiDaChon.Where(o => o.LoaiNhom == NhomChiPhiNoiTru.DichVuGiuong))
            {
                var chiPhiGiuongChuaThu = dsChiPhi.First(o => o.Id == chiphi.Id && o.LoaiNhom == NhomChiPhiNoiTru.DichVuGiuong);

                var hoatDongGiuongs = ycTiepNhan.HoatDongGiuongBenhs.Where(c => c.ThoiDiemKetThuc == null);
                var yc = ycTiepNhan.YeuCauDichVuGiuongBenhVienChiPhiBenhViens.First(o => o.Id == chiphi.Id);

                #region cong no update 02/02/2021
                foreach (var ycCongTyBaoHiemTuNhanCongNo in yc.CongTyBaoHiemTuNhanCongNos.Where(o => o.TaiKhoanBenhNhanThuId == null))
                {
                    ycCongTyBaoHiemTuNhanCongNo.WillDelete = true;
                }
                if (chiphi.TongCongNo > 0)
                {
                    foreach (var chiphiDanhSachCongNoChoThu in chiphi.DanhSachCongNoChoThus)
                    {
                        if (chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu.AlmostEqual(0))
                            continue;
                        yc.CongTyBaoHiemTuNhanCongNos.Add(new CongTyBaoHiemTuNhanCongNo
                        {
                            TaiKhoanBenhNhanThu = thuPhi,
                            CongTyBaoHiemTuNhanId = chiphiDanhSachCongNoChoThu.CongTyBaoHiemTuNhanId,
                            SoTien = chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu
                        });
                    }
                }

                yc.SoTienBaoHiemTuNhanChiTra = chiphi.TongCongNo;

                if (hoatDongGiuongs.Any())
                {
                    foreach (var hoatDongGiuong in hoatDongGiuongs)
                    {
                        hoatDongGiuong.ThoiDiemKetThuc = ycTiepNhan.NoiTruBenhAn.ThoiDiemRaVien;
                    }
                }


                #endregion

                #region mien giam update 02/02/2021
                foreach (var mienGiam in yc.MienGiamChiPhis.Where(o => o.TaiKhoanBenhNhanThuId == null))
                {
                    mienGiam.WillDelete = true;
                }
                //mien giam theo uu dai noi gioi thieu: BVHD-3882
                var mienGiamNoiGioiThieu = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.NoiGioiThieuId != null);
                if (mienGiamNoiGioiThieu != null)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                        NoiGioiThieuId = mienGiamNoiGioiThieu.NoiGioiThieuId,
                        LoaiChietKhau = mienGiamNoiGioiThieu.LoaiChietKhau,
                        TiLe = mienGiamNoiGioiThieu.TiLe,
                        SoTien = mienGiamNoiGioiThieu.SoTien
                    });
                }
                //mien giam theo uu dai
                var mienGiamUuDai = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.DoiTuongUuDaiId != null && o.TiLe != 0);
                if (mienGiamUuDai != null)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                        DoiTuongUuDaiId = mienGiamUuDai.DoiTuongUuDaiId,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                        TiLe = mienGiamUuDai.TiLe.GetValueOrDefault(),
                        SoTien = mienGiamUuDai.SoTien
                    });
                }
                //mien giam theo voucher
                var mienGiamVouchers = chiphi.DanhSachMienGiamVos.Where(o => o.TheVoucherId != null).ToList();
                foreach (var voucher in mienGiamVouchers)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.Voucher,
                        TheVoucherId = voucher.TheVoucherId,
                        LoaiChietKhau = voucher.LoaiChietKhau,
                        MaTheVoucher = voucher.MaTheVoucher,
                        TiLe = voucher.TiLe.GetValueOrDefault(),
                        SoTien = voucher.SoTien
                    });
                }
                //mien giam them theo ti le
                var mienGiamThemTiLe = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoTiLe);
                if (mienGiamThemTiLe != null && mienGiamThemTiLe.TiLe.GetValueOrDefault() != 0)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                        TiLe = mienGiamThemTiLe.TiLe,
                        SoTien = mienGiamThemTiLe.SoTien
                    });
                }
                //mien giam them theo so tien
                var mienGiamThemSoTien = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoSoTien);
                if (mienGiamThemSoTien != null && !mienGiamThemSoTien.SoTien.AlmostEqual(0))
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoSoTien,
                        SoTien = mienGiamThemSoTien.SoTien
                    });
                }

                yc.SoTienMienGiam = chiphi.SoTienMG;
                if ((mienGiamThemTiLe?.SoTien ?? 0).AlmostEqual(0) && (mienGiamThemSoTien?.SoTien ?? 0).AlmostEqual(0))
                {
                    yc.GhiChuMienGiamThem = null;
                    yc.NoiDungGhiChuMiemGiamId = null;
                }
                else
                {
                    yc.GhiChuMienGiamThem = chiphi.GhiChuMienGiamThem;
                    yc.NoiDungGhiChuMiemGiamId = chiphi.NoiDungGhiChuMiemGiamId;
                }
                #endregion
                yc.SoTienBenhNhanDaChi = yc.SoTienBenhNhanDaChi.GetValueOrDefault() + chiphi.BNConPhaiThanhToan;
                yc.TrangThaiThanhToan = Enums.TrangThaiThanhToan.DaThanhToan;
                thuPhi.TaiKhoanBenhNhanChis.Add(new TaiKhoanBenhNhanChi
                {
                    TaiKhoanBenhNhan = tk,
                    LoaiChiTienBenhNhan = Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi,
                    TienChiPhi = chiphi.BNConPhaiThanhToan,
                    NoiDungChi = Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi.GetDescription(),
                    NgayChi = DateTime.Now,
                    SoPhieuHienThi = thuPhi.SoPhieuHienThi,
                    YeuCauDichVuGiuongBenhVienChiPhiBenhVien = yc,
                    Gia = yc.Gia,
                    SoLuong = yc.SoLuong,
                    DonGiaBaoHiem = chiPhiGiuongChuaThu.DonGiaBHYT,
                    MucHuongBaoHiem = chiPhiGiuongChuaThu.MucHuongBaoHiem,
                    TiLeBaoHiemThanhToan = chiPhiGiuongChuaThu.TiLeBaoHiemThanhToan,
                    SoTienMienGiam = yc.SoTienMienGiam,
                    SoTienBaoHiemTuNhanChiTra = yc.SoTienBaoHiemTuNhanChiTra,
                    YeuCauTiepNhanId = ycTiepNhan.Id,
                    NhanVienThucHienId = _userAgentHelper.GetCurrentUserId(),
                    NoiThucHienId = _userAgentHelper.GetCurrentNoiLLamViecId()
                });
            }

            foreach (var chiphi in dsChiPhiDaChon.Where(o => o.LoaiNhom == NhomChiPhiNoiTru.DuocPham))
            {
                var yc = chiphi.DichVuNgoaiTru ? yeuCauTiepNhanNgoaiTruCanQuyetToan.YeuCauDuocPhamBenhViens.First(o => o.Id == chiphi.Id) : ycTiepNhan.YeuCauDuocPhamBenhViens.First(o => o.Id == chiphi.Id);
                #region cong no update 02/02/2021
                foreach (var ycCongTyBaoHiemTuNhanCongNo in yc.CongTyBaoHiemTuNhanCongNos.Where(o => o.TaiKhoanBenhNhanThuId == null))
                {
                    ycCongTyBaoHiemTuNhanCongNo.WillDelete = true;
                }
                if (chiphi.TongCongNo > 0)
                {
                    foreach (var chiphiDanhSachCongNoChoThu in chiphi.DanhSachCongNoChoThus)
                    {
                        if (chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu.AlmostEqual(0))
                            continue;
                        yc.CongTyBaoHiemTuNhanCongNos.Add(new CongTyBaoHiemTuNhanCongNo
                        {
                            TaiKhoanBenhNhanThu = thuPhi,
                            CongTyBaoHiemTuNhanId = chiphiDanhSachCongNoChoThu.CongTyBaoHiemTuNhanId,
                            SoTien = chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu
                        });
                    }
                }
                yc.SoTienBaoHiemTuNhanChiTra = chiphi.TongCongNo;
                #endregion
                #region mien giam update 02/02/2021
                foreach (var mienGiam in yc.MienGiamChiPhis.Where(o => o.TaiKhoanBenhNhanThuId == null))
                {
                    mienGiam.WillDelete = true;
                }
                //mien giam theo uu dai noi gioi thieu: BVHD-3882
                var mienGiamNoiGioiThieu = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.NoiGioiThieuId != null);
                if (mienGiamNoiGioiThieu != null)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                        NoiGioiThieuId = mienGiamNoiGioiThieu.NoiGioiThieuId,
                        LoaiChietKhau = mienGiamNoiGioiThieu.LoaiChietKhau,
                        TiLe = mienGiamNoiGioiThieu.TiLe,
                        SoTien = mienGiamNoiGioiThieu.SoTien
                    });
                }
                //mien giam theo uu dai
                var mienGiamUuDai = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.DoiTuongUuDaiId != null && o.TiLe != 0);
                if (mienGiamUuDai != null)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                        DoiTuongUuDaiId = mienGiamUuDai.DoiTuongUuDaiId,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                        TiLe = mienGiamUuDai.TiLe.GetValueOrDefault(),
                        SoTien = mienGiamUuDai.SoTien
                    });
                }
                //mien giam theo voucher
                var mienGiamVouchers = chiphi.DanhSachMienGiamVos.Where(o => o.TheVoucherId != null).ToList();
                foreach (var voucher in mienGiamVouchers)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.Voucher,
                        TheVoucherId = voucher.TheVoucherId,
                        LoaiChietKhau = voucher.LoaiChietKhau,
                        MaTheVoucher = voucher.MaTheVoucher,
                        TiLe = voucher.TiLe.GetValueOrDefault(),
                        SoTien = voucher.SoTien
                    });
                }
                //mien giam them theo ti le
                var mienGiamThemTiLe = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoTiLe);
                if (mienGiamThemTiLe != null && mienGiamThemTiLe.TiLe.GetValueOrDefault() != 0)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                        TiLe = mienGiamThemTiLe.TiLe,
                        SoTien = mienGiamThemTiLe.SoTien
                    });
                }
                //mien giam them theo so tien
                var mienGiamThemSoTien = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoSoTien);
                if (mienGiamThemSoTien != null && !mienGiamThemSoTien.SoTien.AlmostEqual(0))
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoSoTien,
                        SoTien = mienGiamThemSoTien.SoTien
                    });
                }

                yc.SoTienMienGiam = chiphi.SoTienMG;
                if ((mienGiamThemTiLe?.SoTien ?? 0).AlmostEqual(0) && (mienGiamThemSoTien?.SoTien ?? 0).AlmostEqual(0))
                {
                    yc.GhiChuMienGiamThem = null;
                    yc.NoiDungGhiChuMiemGiamId = null;
                }
                else
                {
                    yc.GhiChuMienGiamThem = chiphi.GhiChuMienGiamThem;
                    yc.NoiDungGhiChuMiemGiamId = chiphi.NoiDungGhiChuMiemGiamId;
                }
                #endregion
                yc.SoTienBenhNhanDaChi = yc.SoTienBenhNhanDaChi.GetValueOrDefault() + chiphi.BNConPhaiThanhToan;
                yc.TrangThaiThanhToan = Enums.TrangThaiThanhToan.DaThanhToan;
                thuPhi.TaiKhoanBenhNhanChis.Add(new TaiKhoanBenhNhanChi
                {
                    TaiKhoanBenhNhan = tk,
                    LoaiChiTienBenhNhan = Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi,
                    TienChiPhi = chiphi.BNConPhaiThanhToan,
                    NoiDungChi = Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi.GetDescription(),
                    NgayChi = DateTime.Now,
                    SoPhieuHienThi = thuPhi.SoPhieuHienThi,
                    YeuCauDuocPhamBenhVien = yc,
                    Gia = yc.DonGiaBan,
                    SoLuong = yc.SoLuong,
                    DonGiaBaoHiem = yc.DonGiaBaoHiem,
                    MucHuongBaoHiem = yc.MucHuongBaoHiem,
                    TiLeBaoHiemThanhToan = yc.TiLeBaoHiemThanhToan,
                    SoTienMienGiam = yc.SoTienMienGiam,
                    SoTienBaoHiemTuNhanChiTra = yc.SoTienBaoHiemTuNhanChiTra,
                    YeuCauTiepNhanId = ycTiepNhan.Id,
                    NhanVienThucHienId = _userAgentHelper.GetCurrentUserId(),
                    NoiThucHienId = _userAgentHelper.GetCurrentNoiLLamViecId()
                });
            }

            foreach (var chiphi in dsChiPhiDaChon.Where(o => o.LoaiNhom == NhomChiPhiNoiTru.VatTuTieuHao))
            {
                var yc = chiphi.DichVuNgoaiTru ? yeuCauTiepNhanNgoaiTruCanQuyetToan.YeuCauVatTuBenhViens.First(o => o.Id == chiphi.Id) : ycTiepNhan.YeuCauVatTuBenhViens.First(o => o.Id == chiphi.Id);
                #region cong no update 02/02/2021
                foreach (var ycCongTyBaoHiemTuNhanCongNo in yc.CongTyBaoHiemTuNhanCongNos.Where(o => o.TaiKhoanBenhNhanThuId == null))
                {
                    ycCongTyBaoHiemTuNhanCongNo.WillDelete = true;
                }
                if (chiphi.TongCongNo > 0)
                {
                    foreach (var chiphiDanhSachCongNoChoThu in chiphi.DanhSachCongNoChoThus)
                    {
                        if (chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu.AlmostEqual(0))
                            continue;
                        yc.CongTyBaoHiemTuNhanCongNos.Add(new CongTyBaoHiemTuNhanCongNo
                        {
                            TaiKhoanBenhNhanThu = thuPhi,
                            CongTyBaoHiemTuNhanId = chiphiDanhSachCongNoChoThu.CongTyBaoHiemTuNhanId,
                            SoTien = chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu
                        });
                    }
                }
                yc.SoTienBaoHiemTuNhanChiTra = chiphi.TongCongNo;
                #endregion
                #region mien giam update 02/02/2021
                foreach (var mienGiam in yc.MienGiamChiPhis.Where(o => o.TaiKhoanBenhNhanThuId == null))
                {
                    mienGiam.WillDelete = true;
                }
                //mien giam theo uu dai noi gioi thieu: BVHD-3882
                var mienGiamNoiGioiThieu = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.NoiGioiThieuId != null);
                if (mienGiamNoiGioiThieu != null)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                        NoiGioiThieuId = mienGiamNoiGioiThieu.NoiGioiThieuId,
                        LoaiChietKhau = mienGiamNoiGioiThieu.LoaiChietKhau,
                        TiLe = mienGiamNoiGioiThieu.TiLe,
                        SoTien = mienGiamNoiGioiThieu.SoTien
                    });
                }
                //mien giam theo uu dai
                var mienGiamUuDai = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.DoiTuongUuDaiId != null && o.TiLe != 0);
                if (mienGiamUuDai != null)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                        DoiTuongUuDaiId = mienGiamUuDai.DoiTuongUuDaiId,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                        TiLe = mienGiamUuDai.TiLe.GetValueOrDefault(),
                        SoTien = mienGiamUuDai.SoTien
                    });
                }
                //mien giam theo voucher
                var mienGiamVouchers = chiphi.DanhSachMienGiamVos.Where(o => o.TheVoucherId != null).ToList();
                foreach (var voucher in mienGiamVouchers)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.Voucher,
                        TheVoucherId = voucher.TheVoucherId,
                        LoaiChietKhau = voucher.LoaiChietKhau,
                        MaTheVoucher = voucher.MaTheVoucher,
                        TiLe = voucher.TiLe.GetValueOrDefault(),
                        SoTien = voucher.SoTien
                    });
                }
                //mien giam them theo ti le
                var mienGiamThemTiLe = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoTiLe);
                if (mienGiamThemTiLe != null && mienGiamThemTiLe.TiLe.GetValueOrDefault() != 0)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                        TiLe = mienGiamThemTiLe.TiLe,
                        SoTien = mienGiamThemTiLe.SoTien
                    });
                }
                //mien giam them theo so tien
                var mienGiamThemSoTien = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoSoTien);
                if (mienGiamThemSoTien != null && !mienGiamThemSoTien.SoTien.AlmostEqual(0))
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoSoTien,
                        SoTien = mienGiamThemSoTien.SoTien
                    });
                }

                yc.SoTienMienGiam = chiphi.SoTienMG;
                if ((mienGiamThemTiLe?.SoTien ?? 0).AlmostEqual(0) && (mienGiamThemSoTien?.SoTien ?? 0).AlmostEqual(0))
                {
                    yc.GhiChuMienGiamThem = null;
                    yc.NoiDungGhiChuMiemGiamId = null;
                }
                else
                {
                    yc.GhiChuMienGiamThem = chiphi.GhiChuMienGiamThem;
                    yc.NoiDungGhiChuMiemGiamId = chiphi.NoiDungGhiChuMiemGiamId;
                }
                #endregion
                yc.SoTienBenhNhanDaChi = yc.SoTienBenhNhanDaChi.GetValueOrDefault() + chiphi.BNConPhaiThanhToan;
                yc.TrangThaiThanhToan = Enums.TrangThaiThanhToan.DaThanhToan;
                thuPhi.TaiKhoanBenhNhanChis.Add(new TaiKhoanBenhNhanChi
                {
                    TaiKhoanBenhNhan = tk,
                    LoaiChiTienBenhNhan = Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi,
                    TienChiPhi = chiphi.BNConPhaiThanhToan,
                    NoiDungChi = Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi.GetDescription(),
                    NgayChi = DateTime.Now,
                    SoPhieuHienThi = thuPhi.SoPhieuHienThi,
                    YeuCauVatTuBenhVien = yc,
                    Gia = yc.DonGiaBan,
                    SoLuong = yc.SoLuong,
                    DonGiaBaoHiem = yc.DonGiaBaoHiem,
                    MucHuongBaoHiem = yc.MucHuongBaoHiem,
                    TiLeBaoHiemThanhToan = yc.TiLeBaoHiemThanhToan,
                    SoTienMienGiam = yc.SoTienMienGiam,
                    SoTienBaoHiemTuNhanChiTra = yc.SoTienBaoHiemTuNhanChiTra,
                    YeuCauTiepNhanId = ycTiepNhan.Id,
                    NhanVienThucHienId = _userAgentHelper.GetCurrentUserId(),
                    NoiThucHienId = _userAgentHelper.GetCurrentNoiLLamViecId()
                });
            }

            //foreach (var chiphi in dsChiPhiDaChon.Where(o => o.LoaiNhom == NhomChiPhiNoiTru.GoiDichVu))
            //{
            //    var yc = ycTiepNhan.BenhNhan.YeuCauGoiDichVus.First(o => o.Id == chiphi.Id);
            //    #region cong no update 02/02/2021
            //    foreach (var ycCongTyBaoHiemTuNhanCongNo in yc.CongTyBaoHiemTuNhanCongNos.Where(o => o.TaiKhoanBenhNhanThuId == null))
            //    {
            //        ycCongTyBaoHiemTuNhanCongNo.WillDelete = true;
            //    }
            //    if (chiphi.TongCongNo > 0)
            //    {
            //        foreach (var chiphiDanhSachCongNoChoThu in chiphi.DanhSachCongNoChoThus)
            //        {
            //            if (chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu.AlmostEqual(0))
            //                continue;
            //            yc.CongTyBaoHiemTuNhanCongNos.Add(new CongTyBaoHiemTuNhanCongNo
            //            {
            //                TaiKhoanBenhNhanThu = thuPhi,
            //                CongTyBaoHiemTuNhanId = chiphiDanhSachCongNoChoThu.CongTyBaoHiemTuNhanId,
            //                SoTien = chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu
            //            });
            //        }
            //    }
            //    yc.SoTienBaoHiemTuNhanChiTra = chiphi.TongCongNo;
            //    #endregion
            //    #region mien giam update 02/02/2021
            //    foreach (var mienGiam in yc.MienGiamChiPhis.Where(o => o.TaiKhoanBenhNhanThuId == null))
            //    {
            //        mienGiam.WillDelete = true;
            //    }
            //    //mien giam theo uu dai
            //    var mienGiamUuDai = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.DoiTuongUuDaiId != null && o.TiLe != 0);
            //    if (mienGiamUuDai != null)
            //    {
            //        yc.MienGiamChiPhis.Add(new MienGiamChiPhi
            //        {
            //            TaiKhoanBenhNhanThu = thuPhi,
            //            YeuCauTiepNhanId = ycTiepNhan.Id,
            //            LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
            //            DoiTuongUuDaiId = mienGiamUuDai.DoiTuongUuDaiId,
            //            LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
            //            TiLe = mienGiamUuDai.TiLe.GetValueOrDefault(),
            //            SoTien = mienGiamUuDai.SoTien
            //        });
            //    }
            //    //mien giam theo voucher
            //    var mienGiamVouchers = chiphi.DanhSachMienGiamVos.Where(o => o.TheVoucherId != null).ToList();
            //    foreach (var voucher in mienGiamVouchers)
            //    {
            //        yc.MienGiamChiPhis.Add(new MienGiamChiPhi
            //        {
            //            TaiKhoanBenhNhanThu = thuPhi,
            //            YeuCauTiepNhanId = ycTiepNhan.Id,
            //            LoaiMienGiam = Enums.LoaiMienGiam.Voucher,
            //            TheVoucherId = voucher.TheVoucherId,
            //            LoaiChietKhau = voucher.LoaiChietKhau,
            //            MaTheVoucher = voucher.MaTheVoucher,
            //            TiLe = voucher.TiLe.GetValueOrDefault(),
            //            SoTien = voucher.SoTien
            //        });
            //    }
            //    //mien giam them theo ti le
            //    var mienGiamThemTiLe = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoTiLe);
            //    if (mienGiamThemTiLe != null && mienGiamThemTiLe.TiLe.GetValueOrDefault() != 0)
            //    {
            //        yc.MienGiamChiPhis.Add(new MienGiamChiPhi
            //        {
            //            TaiKhoanBenhNhanThu = thuPhi,
            //            YeuCauTiepNhanId = ycTiepNhan.Id,
            //            LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
            //            LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
            //            TiLe = mienGiamThemTiLe.TiLe,
            //            SoTien = mienGiamThemTiLe.SoTien
            //        });
            //    }
            //    //mien giam them theo so tien
            //    var mienGiamThemSoTien = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoSoTien);
            //    if (mienGiamThemSoTien != null && !mienGiamThemSoTien.SoTien.AlmostEqual(0))
            //    {
            //        yc.MienGiamChiPhis.Add(new MienGiamChiPhi
            //        {
            //            TaiKhoanBenhNhanThu = thuPhi,
            //            YeuCauTiepNhanId = ycTiepNhan.Id,
            //            LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
            //            LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoSoTien,
            //            SoTien = mienGiamThemSoTien.SoTien
            //        });
            //    }

            //    yc.SoTienMienGiam = chiphi.SoTienMG;
            //    if ((mienGiamThemTiLe?.SoTien ?? 0).AlmostEqual(0) && (mienGiamThemSoTien?.SoTien ?? 0).AlmostEqual(0))
            //    {
            //        yc.GhiChuMienGiamThem = null;
            //        yc.NoiDungGhiChuMiemGiamId = null;
            //    }
            //    else
            //    {
            //        yc.GhiChuMienGiamThem = chiphi.GhiChuMienGiamThem;
            //        yc.NoiDungGhiChuMiemGiamId = chiphi.NoiDungGhiChuMiemGiamId;
            //    }
            //    #endregion
            //    yc.SoTienBenhNhanDaChi = yc.SoTienBenhNhanDaChi.GetValueOrDefault() + chiphi.BNConPhaiThanhToan;
            //    yc.TrangThaiThanhToan = Enums.TrangThaiThanhToan.DaThanhToan;
            //    if (yc.TrangThai == Enums.EnumTrangThaiYeuCauGoiDichVu.ChuaThucHien)
            //    {
            //        yc.TrangThai = Enums.EnumTrangThaiYeuCauGoiDichVu.DangThucHien;
            //    }
            //    thuPhi.TaiKhoanBenhNhanChis.Add(new TaiKhoanBenhNhanChi
            //    {
            //        TaiKhoanBenhNhan = tk,
            //        LoaiChiTienBenhNhan = Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi,
            //        TienChiPhi = chiphi.BNConPhaiThanhToan,
            //        NoiDungChi = Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi.GetDescription(),
            //        NgayChi = DateTime.Now,
            //        SoPhieuHienThi = thuPhi.SoPhieuHienThi,
            //        YeuCauGoiDichVu = yc,
            //        Gia = yc.GiaSauChietKhau,
            //        SoLuong = 1,
            //        SoTienMienGiam = yc.SoTienMienGiam,
            //        SoTienBaoHiemTuNhanChiTra = yc.SoTienBaoHiemTuNhanChiTra,
            //        YeuCauTiepNhanId = ycTiepNhan.Id,
            //        NhanVienThucHienId = _userAgentHelper.GetCurrentUserId(),
            //        NoiThucHienId = _userAgentHelper.GetCurrentNoiLLamViecId()
            //    });

            //}

            foreach (var chiphi in dsChiPhiDaChon.Where(o => o.LoaiNhom == NhomChiPhiNoiTru.ToaThuoc))
            {
                var yc = chiphi.DichVuNgoaiTru ? yeuCauTiepNhanNgoaiTruCanQuyetToan.DonThuocThanhToans.SelectMany(o => o.DonThuocThanhToanChiTiets).First(o => o.Id == chiphi.Id) : ycTiepNhan.DonThuocThanhToans.SelectMany(o => o.DonThuocThanhToanChiTiets).First(o => o.Id == chiphi.Id);
                #region cong no update 02/02/2021
                foreach (var ycCongTyBaoHiemTuNhanCongNo in yc.CongTyBaoHiemTuNhanCongNos.Where(o => o.TaiKhoanBenhNhanThuId == null))
                {
                    ycCongTyBaoHiemTuNhanCongNo.WillDelete = true;
                }
                if (chiphi.TongCongNo > 0)
                {
                    foreach (var chiphiDanhSachCongNoChoThu in chiphi.DanhSachCongNoChoThus)
                    {
                        if (chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu.AlmostEqual(0))
                            continue;
                        yc.CongTyBaoHiemTuNhanCongNos.Add(new CongTyBaoHiemTuNhanCongNo
                        {
                            TaiKhoanBenhNhanThu = thuPhi,
                            CongTyBaoHiemTuNhanId = chiphiDanhSachCongNoChoThu.CongTyBaoHiemTuNhanId,
                            SoTien = chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu
                        });
                    }
                }
                yc.SoTienBaoHiemTuNhanChiTra = chiphi.TongCongNo;
                #endregion
                #region mien giam update 02/02/2021
                foreach (var mienGiam in yc.MienGiamChiPhis.Where(o => o.TaiKhoanBenhNhanThuId == null))
                {
                    mienGiam.WillDelete = true;
                }
                //mien giam theo uu dai noi gioi thieu: BVHD-3882
                var mienGiamNoiGioiThieu = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.NoiGioiThieuId != null);
                if (mienGiamNoiGioiThieu != null)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                        NoiGioiThieuId = mienGiamNoiGioiThieu.NoiGioiThieuId,
                        LoaiChietKhau = mienGiamNoiGioiThieu.LoaiChietKhau,
                        TiLe = mienGiamNoiGioiThieu.TiLe,
                        SoTien = mienGiamNoiGioiThieu.SoTien
                    });
                }
                //mien giam theo uu dai
                var mienGiamUuDai = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.DoiTuongUuDaiId != null && o.TiLe != 0);
                if (mienGiamUuDai != null)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                        DoiTuongUuDaiId = mienGiamUuDai.DoiTuongUuDaiId,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                        TiLe = mienGiamUuDai.TiLe.GetValueOrDefault(),
                        SoTien = mienGiamUuDai.SoTien
                    });
                }
                //mien giam theo voucher
                var mienGiamVouchers = chiphi.DanhSachMienGiamVos.Where(o => o.TheVoucherId != null).ToList();
                foreach (var voucher in mienGiamVouchers)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.Voucher,
                        TheVoucherId = voucher.TheVoucherId,
                        LoaiChietKhau = voucher.LoaiChietKhau,
                        MaTheVoucher = voucher.MaTheVoucher,
                        TiLe = voucher.TiLe.GetValueOrDefault(),
                        SoTien = voucher.SoTien
                    });
                }
                //mien giam them theo ti le
                var mienGiamThemTiLe = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoTiLe);
                if (mienGiamThemTiLe != null && mienGiamThemTiLe.TiLe.GetValueOrDefault() != 0)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                        TiLe = mienGiamThemTiLe.TiLe,
                        SoTien = mienGiamThemTiLe.SoTien
                    });
                }
                //mien giam them theo so tien
                var mienGiamThemSoTien = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoSoTien);
                if (mienGiamThemSoTien != null && !mienGiamThemSoTien.SoTien.AlmostEqual(0))
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoSoTien,
                        SoTien = mienGiamThemSoTien.SoTien
                    });
                }

                yc.SoTienMienGiam = chiphi.SoTienMG;
                if ((mienGiamThemTiLe?.SoTien ?? 0).AlmostEqual(0) && (mienGiamThemSoTien?.SoTien ?? 0).AlmostEqual(0))
                {
                    yc.GhiChuMienGiamThem = null;
                    yc.NoiDungGhiChuMiemGiamId = null;
                }
                else
                {
                    yc.GhiChuMienGiamThem = chiphi.GhiChuMienGiamThem;
                    yc.NoiDungGhiChuMiemGiamId = chiphi.NoiDungGhiChuMiemGiamId;
                }
                #endregion
                yc.SoTienBenhNhanDaChi = yc.SoTienBenhNhanDaChi.GetValueOrDefault() + chiphi.BNConPhaiThanhToan;
                yc.DonThuocThanhToan.TrangThaiThanhToan = Enums.TrangThaiThanhToan.DaThanhToan;
                var donThuocThanhToanChiTietTheoPhieuThu = yc.Map<DonThuocThanhToanChiTietTheoPhieuThu>();
                donThuocThanhToanChiTietTheoPhieuThu.NgayPhatSinh = yc.CreatedOn ?? DateTime.Now;
                donThuocThanhToanChiTietTheoPhieuThu.LoaiDonThuoc = yc.DonThuocThanhToan.LoaiDonThuoc;
                var ttNhapThuoc = yc.XuatKhoDuocPhamChiTietViTri.NhapKhoDuocPhamChiTiet;
                donThuocThanhToanChiTietTheoPhieuThu.Solo = ttNhapThuoc.Solo;
                donThuocThanhToanChiTietTheoPhieuThu.MaVach = ttNhapThuoc.MaVach;
                donThuocThanhToanChiTietTheoPhieuThu.HanSuDung = ttNhapThuoc.HanSuDung;
                donThuocThanhToanChiTietTheoPhieuThu.NgayNhapVaoBenhVien = ttNhapThuoc.NgayNhapVaoBenhVien;
                donThuocThanhToanChiTietTheoPhieuThu.SoLuongToa = yc.YeuCauKhamBenhDonThuocChiTiet?.SoLuong;
                donThuocThanhToanChiTietTheoPhieuThu.BacSiKeDonId = yc.YeuCauKhamBenhDonThuocChiTiet?.YeuCauKhamBenhDonThuoc.BacSiKeDonId;
                donThuocThanhToanChiTietTheoPhieuThu.ThoiDiemKeDon = yc.YeuCauKhamBenhDonThuocChiTiet?.YeuCauKhamBenhDonThuoc.ThoiDiemKeDon;

                thuPhi.TaiKhoanBenhNhanChis.Add(new TaiKhoanBenhNhanChi
                {
                    TaiKhoanBenhNhan = tk,
                    LoaiChiTienBenhNhan = Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi,
                    TienChiPhi = chiphi.BNConPhaiThanhToan,
                    NoiDungChi = Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi.GetDescription(),
                    NgayChi = DateTime.Now,
                    SoPhieuHienThi = thuPhi.SoPhieuHienThi,
                    DonThuocThanhToanChiTiet = yc,
                    DonThuocThanhToanChiTietTheoPhieuThu = donThuocThanhToanChiTietTheoPhieuThu,
                    Gia = yc.DonGiaBan,
                    SoLuong = yc.SoLuong,
                    DonGiaBaoHiem = yc.DonGiaBaoHiem,
                    MucHuongBaoHiem = yc.MucHuongBaoHiem,
                    TiLeBaoHiemThanhToan = yc.TiLeBaoHiemThanhToan,
                    SoTienMienGiam = yc.SoTienMienGiam,
                    SoTienBaoHiemTuNhanChiTra = yc.SoTienBaoHiemTuNhanChiTra,
                    YeuCauTiepNhanId = ycTiepNhan.Id,
                    NhanVienThucHienId = _userAgentHelper.GetCurrentUserId(),
                    NoiThucHienId = _userAgentHelper.GetCurrentNoiLLamViecId()
                });
            }
            TaiKhoanBenhNhanChi phieuHoanUng = null;
            if (thuTamUng.Any())
            {
                thuPhi.TamUng = soTienDaTamUng;
                phieuHoanUng = new TaiKhoanBenhNhanChi
                {
                    TaiKhoanBenhNhan = tk,
                    LoaiChiTienBenhNhan = Enums.LoaiChiTienBenhNhan.HoanUng,
                    TienMat = soTienDaTamUng,
                    NoiDungChi = Enums.LoaiChiTienBenhNhan.HoanUng.GetDescription(),
                    NgayChi = thuPhi.NgayThu.AddMilliseconds(-1),
                    YeuCauTiepNhanId = ycTiepNhan.Id,
                    SoPhieuHienThi = ResourceHelper.CreateSoHoanUng(),
                    NhanVienThucHienId = _userAgentHelper.GetCurrentUserId(),
                    NoiThucHienId = _userAgentHelper.GetCurrentNoiLLamViecId()
                };
                thuPhi.TaiKhoanBenhNhanChis.Add(phieuHoanUng);

                foreach (var taiKhoanBenhNhanThu in ycTiepNhan.TaiKhoanBenhNhanThus.Where(o => o.DaHuy != true && o.LoaiThuTienBenhNhan == LoaiThuTienBenhNhan.ThuTamUng && o.ThuTienGoiDichVu != true && o.PhieuHoanUngId == null))
                {
                    taiKhoanBenhNhanThu.PhieuHoanUng = phieuHoanUng;
                }
                if (yeuCauTiepNhanNgoaiTruCanQuyetToan != null)
                {
                    foreach (var taiKhoanBenhNhanThu in yeuCauTiepNhanNgoaiTruCanQuyetToan.TaiKhoanBenhNhanThus.Where(o => o.DaHuy != true && o.LoaiThuTienBenhNhan == LoaiThuTienBenhNhan.ThuTamUng && o.ThuTienGoiDichVu != true && o.PhieuHoanUngId == null))
                    {
                        taiKhoanBenhNhanThu.PhieuHoanUng = phieuHoanUng;
                    }
                }
            }

            tk.SoDuTaiKhoan -= soTienDaTamUng;
            ycTiepNhan.TaiKhoanBenhNhanThus.Add(thuPhi);

            //kiem tra dich vu trong goi da thanh toan
            if (ycTiepNhan.YeuCauKhamBenhs.All(o => o.TrangThai == Enums.EnumTrangThaiYeuCauKhamBenh.HuyKham || o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.DaThanhToan)
                && ycTiepNhan.YeuCauDichVuKyThuats.All(o => o.TrangThai == Enums.EnumTrangThaiYeuCauDichVuKyThuat.DaHuy || o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.DaThanhToan)
                && ycTiepNhan.YeuCauDichVuGiuongBenhVienChiPhiBenhViens.All(o => o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.DaThanhToan)
                && (yeuCauTiepNhanNgoaiTruCanQuyetToan == null || (yeuCauTiepNhanNgoaiTruCanQuyetToan.YeuCauKhamBenhs.All(o => o.TrangThai == Enums.EnumTrangThaiYeuCauKhamBenh.HuyKham || o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.DaThanhToan) &&
                                                                    yeuCauTiepNhanNgoaiTruCanQuyetToan.YeuCauDichVuKyThuats.All(o => o.TrangThai == EnumTrangThaiYeuCauDichVuKyThuat.DaHuy || o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.DaThanhToan))))
            {
                ycTiepNhan.NoiTruBenhAn.DaQuyetToan = true;
                ycTiepNhan.TrangThaiYeuCauTiepNhan = EnumTrangThaiYeuCauTiepNhan.DaHoanTat;
                if (yeuCauTiepNhanNgoaiTruCanQuyetToan != null)
                {
                    yeuCauTiepNhanNgoaiTruCanQuyetToan.TrangThaiYeuCauTiepNhan = EnumTrangThaiYeuCauTiepNhan.DaHoanTat;
                }
                else
                {
                    var yeuCauTiepNhanNgoaiTru = BaseRepository.Table.FirstOrDefault(o => o.MaYeuCauTiepNhan == ycTiepNhan.MaYeuCauTiepNhan && o.LoaiYeuCauTiepNhan == EnumLoaiYeuCauTiepNhan.KhamChuaBenhNgoaiTru);
                    if (yeuCauTiepNhanNgoaiTru != null)
                    {
                        yeuCauTiepNhanNgoaiTru.TrangThaiYeuCauTiepNhan = EnumTrangThaiYeuCauTiepNhan.DaHoanTat;
                    }
                }
            }
            //await BaseRepository.UpdateAsync(ycTiepNhan);
            BaseRepository.Context.SaveChanges();
            return new KetQuaThuPhiKhamChuaBenhNoiTruVo { PhieuThuId = thuPhi.Id, LaPhieuChi = soTienDaTamUng + thuPhiKhamChuaBenhVo.SoTienCongNo.GetValueOrDefault() > soTienCanThu, PhieuHoanUngId = phieuHoanUng?.Id ?? 0 };
        }

        public async Task<KetQuaThuPhiKhamChuaBenhNoiTruVaQuyetToanDichVuTrongGoiVo> ThuPhiNoiTruVaQuyetToanDichVuTrongGoi(ThuPhiKhamChuaBenhNoiTruVo thuPhiKhamChuaBenhVo)
        {
            var ycTiepNhan = BaseRepository.GetById(thuPhiKhamChuaBenhVo.Id,
                x => x.Include(o => o.NoiTruBenhAn)
                    .Include(o => o.TheVoucherYeuCauTiepNhans).ThenInclude(g => g.TheVoucher).ThenInclude(v => v.Voucher).ThenInclude(v => v.VoucherChiTietMienGiams)
                    .Include(o => o.YeuCauKhamBenhs).ThenInclude(g => g.CongTyBaoHiemTuNhanCongNos)
                    .Include(o => o.YeuCauKhamBenhs).ThenInclude(o => o.YeuCauGoiDichVu)
                    .Include(o => o.YeuCauDichVuKyThuats).ThenInclude(g => g.CongTyBaoHiemTuNhanCongNos)
                    .Include(o => o.YeuCauDichVuKyThuats).ThenInclude(o => o.YeuCauGoiDichVu)
                    .Include(o => o.YeuCauDuocPhamBenhViens).ThenInclude(g => g.CongTyBaoHiemTuNhanCongNos)
                    .Include(o => o.YeuCauVatTuBenhViens).ThenInclude(g => g.CongTyBaoHiemTuNhanCongNos)
                    .Include(o => o.YeuCauTruyenMaus).ThenInclude(g => g.CongTyBaoHiemTuNhanCongNos)
                    .Include(o => o.YeuCauDichVuGiuongBenhVienChiPhiBenhViens).ThenInclude(g => g.CongTyBaoHiemTuNhanCongNos)
                    .Include(o => o.YeuCauDichVuGiuongBenhVienChiPhiBenhViens).ThenInclude(g => g.YeuCauDichVuGiuongBenhVienChiPhiBHYTs)
                    .Include(o => o.YeuCauDichVuGiuongBenhVienChiPhiBenhViens).ThenInclude(o => o.YeuCauGoiDichVu)
                    .Include(o => o.HoatDongGiuongBenhs)
                    .Include(o => o.YeuCauDichVuGiuongBenhVienChiPhiBHYTs)
                    .Include(o => o.DonThuocThanhToans).ThenInclude(g => g.DonThuocThanhToanChiTiets).ThenInclude(g => g.CongTyBaoHiemTuNhanCongNos)
                    .Include(o => o.DonThuocThanhToans).ThenInclude(g => g.DonThuocThanhToanChiTiets).ThenInclude(g => g.XuatKhoDuocPhamChiTietViTri).ThenInclude(g => g.NhapKhoDuocPhamChiTiet)
                    .Include(o => o.DonThuocThanhToans).ThenInclude(g => g.DonThuocThanhToanChiTiets).ThenInclude(g => g.YeuCauKhamBenhDonThuocChiTiet).ThenInclude(g => g.YeuCauKhamBenhDonThuoc)
                    //.Include(o => o.BenhNhan).ThenInclude(o => o.YeuCauGoiDichVus).ThenInclude(g => g.CongTyBaoHiemTuNhanCongNos)
                    //.Include(o => o.BenhNhan).ThenInclude(o => o.YeuCauGoiDichVus).ThenInclude(g => g.YeuCauDichVuKyThuats)
                    //.Include(o => o.BenhNhan).ThenInclude(o => o.YeuCauGoiDichVus).ThenInclude(g => g.YeuCauKhamBenhs)
                    //.Include(o => o.BenhNhan).ThenInclude(o => o.YeuCauGoiDichVus).ThenInclude(g => g.MienGiamChiPhis)
                    .Include(o => o.BenhNhan).ThenInclude(o => o.TaiKhoanBenhNhan)
                    .Include(o => o.TaiKhoanBenhNhanThus)
                    .Include(o => o.TaiKhoanBenhNhanChis)
                    .Include(o => o.DoiTuongUuDai).ThenInclude(ud => ud.DoiTuongUuDaiDichVuKhamBenhBenhViens)
                    .Include(o => o.DoiTuongUuDai).ThenInclude(ud => ud.DoiTuongUuDaiDichVuKyThuatBenhViens)
                    .Include(o => o.YeuCauTiepNhanCongTyBaoHiemTuNhans)
                    .Include(o => o.MienGiamChiPhis));

            long? yeuCauTiepNhanNgoaiTruCanQuyetToanId = ycTiepNhan.YeuCauTiepNhanNgoaiTruCanQuyetToanId;
            YeuCauTiepNhan yeuCauTiepNhanNgoaiTruCanQuyetToan = null;
            if (yeuCauTiepNhanNgoaiTruCanQuyetToanId != null)
            {
                yeuCauTiepNhanNgoaiTruCanQuyetToan = await BaseRepository.GetByIdAsync(yeuCauTiepNhanNgoaiTruCanQuyetToanId.Value,
                    x => x.Include(o => o.TheVoucherYeuCauTiepNhans).ThenInclude(g => g.TheVoucher).ThenInclude(v => v.Voucher).ThenInclude(v => v.VoucherChiTietMienGiams)
                        .Include(o => o.YeuCauKhamBenhs).ThenInclude(g => g.CongTyBaoHiemTuNhanCongNos)
                        .Include(o => o.YeuCauKhamBenhs).ThenInclude(o => o.YeuCauGoiDichVu)
                        .Include(o => o.YeuCauDichVuKyThuats).ThenInclude(g => g.CongTyBaoHiemTuNhanCongNos)
                        .Include(o => o.YeuCauDichVuKyThuats).ThenInclude(o => o.YeuCauGoiDichVu)
                        .Include(o => o.YeuCauDuocPhamBenhViens).ThenInclude(g => g.CongTyBaoHiemTuNhanCongNos)
                        .Include(o => o.YeuCauVatTuBenhViens).ThenInclude(g => g.CongTyBaoHiemTuNhanCongNos)
                        .Include(o => o.YeuCauDichVuGiuongBenhViens).ThenInclude(g => g.CongTyBaoHiemTuNhanCongNos)
                        .Include(o => o.DonThuocThanhToans).ThenInclude(g => g.DonThuocThanhToanChiTiets).ThenInclude(g => g.CongTyBaoHiemTuNhanCongNos)
                        .Include(o => o.DonThuocThanhToans).ThenInclude(g => g.DonThuocThanhToanChiTiets).ThenInclude(g => g.XuatKhoDuocPhamChiTietViTri).ThenInclude(g => g.NhapKhoDuocPhamChiTiet)
                        .Include(o => o.DonThuocThanhToans).ThenInclude(g => g.DonThuocThanhToanChiTiets).ThenInclude(g => g.YeuCauKhamBenhDonThuocChiTiet).ThenInclude(g => g.YeuCauKhamBenhDonThuoc)
                        //.Include(o => o.BenhNhan).ThenInclude(o => o.YeuCauGoiDichVus).ThenInclude(g => g.CongTyBaoHiemTuNhanCongNos)
                        //.Include(o => o.BenhNhan).ThenInclude(o => o.YeuCauGoiDichVus).ThenInclude(g => g.YeuCauDichVuKyThuats)
                        //.Include(o => o.BenhNhan).ThenInclude(o => o.YeuCauGoiDichVus).ThenInclude(g => g.YeuCauKhamBenhs)
                        //.Include(o => o.BenhNhan).ThenInclude(o => o.YeuCauGoiDichVus).ThenInclude(g => g.MienGiamChiPhis)
                        .Include(o => o.BenhNhan).ThenInclude(o => o.TaiKhoanBenhNhan)
                        .Include(o => o.TaiKhoanBenhNhanThus)
                        .Include(o => o.TaiKhoanBenhNhanChis)
                        .Include(o => o.DoiTuongUuDai).ThenInclude(ud => ud.DoiTuongUuDaiDichVuKhamBenhBenhViens)
                        .Include(o => o.DoiTuongUuDai).ThenInclude(ud => ud.DoiTuongUuDaiDichVuKyThuatBenhViens)
                        .Include(o => o.YeuCauTiepNhanCongTyBaoHiemTuNhans)
                        .Include(o => o.MienGiamChiPhis));
            }

            if (ycTiepNhan.BenhNhan == null)
                return new KetQuaThuPhiKhamChuaBenhNoiTruVaQuyetToanDichVuTrongGoiVo { Error = "Không có người bệnh" };

            //kiem tra thong tin truoc khi thanh toan
            if (yeuCauTiepNhanNgoaiTruCanQuyetToan == null)
            {
                var ycKhamBenhExcept = thuPhiKhamChuaBenhVo.DanhSachChiPhiKhamChuaBenhDaChons
                    .Where(o => o.LoaiNhom == NhomChiPhiNoiTru.DichVuKhamBenh).Select(o => o.Id).Except(ycTiepNhan
                        .YeuCauKhamBenhs
                        .Where(o => o.YeuCauGoiDichVuId == null && (!o.DuocHuongBaoHiem || o.BaoHiemChiTra != null) &&
                                    (o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan ||
                                     o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                                     o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                        .Select(o => o.Id));
                var ycKyThuatExcept = thuPhiKhamChuaBenhVo.DanhSachChiPhiKhamChuaBenhDaChons
                    .Where(o => o.LoaiNhom == NhomChiPhiNoiTru.DichVuKyThuat).Select(o => o.Id).Except(ycTiepNhan
                        .YeuCauDichVuKyThuats
                        .Where(o => o.YeuCauGoiDichVuId == null && (!o.DuocHuongBaoHiem || o.BaoHiemChiTra != null) &&
                                    (o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan ||
                                     o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                                     o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                        .Select(o => o.Id));
                var ycTruyenMauExcept = thuPhiKhamChuaBenhVo.DanhSachChiPhiKhamChuaBenhDaChons
                    .Where(o => o.LoaiNhom == NhomChiPhiNoiTru.TruyenMau).Select(o => o.Id).Except(ycTiepNhan
                        .YeuCauTruyenMaus
                        .Where(o => (!o.DuocHuongBaoHiem || o.BaoHiemChiTra != null) &&
                                    (o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan ||
                                     o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                                     o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                        .Select(o => o.Id));
                var ycGiuongExcept = thuPhiKhamChuaBenhVo.DanhSachChiPhiKhamChuaBenhDaChons
                    .Where(o => o.LoaiNhom == NhomChiPhiNoiTru.DichVuGiuong).Select(o => o.Id).Except(ycTiepNhan
                        .YeuCauDichVuGiuongBenhVienChiPhiBenhViens
                        .Where(o => o.YeuCauGoiDichVuId == null && (o.YeuCauDichVuGiuongBenhVienChiPhiBHYTs.All(gbh => !gbh.DuocHuongBaoHiem || gbh.BaoHiemChiTra != null)) &&
                                    (o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan ||
                                     o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                                     o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                        .Select(o => o.Id));
                var ycDuocPhamExcept = thuPhiKhamChuaBenhVo.DanhSachChiPhiKhamChuaBenhDaChons
                    .Where(o => o.LoaiNhom == NhomChiPhiNoiTru.DuocPham).Select(o => o.Id).Except(ycTiepNhan
                        .YeuCauDuocPhamBenhViens
                        .Where(o => o.YeuCauGoiDichVuId == null && (!o.DuocHuongBaoHiem || o.BaoHiemChiTra != null) &&
                                    (o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan ||
                                     o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                                     o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                        .Select(o => o.Id));
                var ycVatTuExcept = thuPhiKhamChuaBenhVo.DanhSachChiPhiKhamChuaBenhDaChons
                    .Where(o => o.LoaiNhom == NhomChiPhiNoiTru.VatTuTieuHao).Select(o => o.Id).Except(ycTiepNhan
                        .YeuCauVatTuBenhViens
                        .Where(o => o.YeuCauGoiDichVuId == null && (!o.DuocHuongBaoHiem || o.BaoHiemChiTra != null) &&
                                    (o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan ||
                                     o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                                     o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                        .Select(o => o.Id));
                var ycToaThuocExcept = thuPhiKhamChuaBenhVo.DanhSachChiPhiKhamChuaBenhDaChons
                    .Where(o => o.LoaiNhom == NhomChiPhiNoiTru.ToaThuoc).Select(o => o.Id).Except(ycTiepNhan
                        .DonThuocThanhToans
                        .Where(o => o.LoaiDonThuoc == Enums.EnumLoaiDonThuoc.ThuocBHYT &&
                                    (o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan ||
                                     o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                                     o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                        .SelectMany(o => o.DonThuocThanhToanChiTiets).Where(o => o.BaoHiemChiTra != null)
                        .Select(o => o.Id));

                if (ycKhamBenhExcept.Any() || ycKyThuatExcept.Any() || ycGiuongExcept.Any() || ycDuocPhamExcept.Any() ||
                    ycVatTuExcept.Any() || ycTruyenMauExcept.Any() ||
                    ycToaThuocExcept.Any())
                    return new KetQuaThuPhiKhamChuaBenhNoiTruVaQuyetToanDichVuTrongGoiVo { Error = "Thông tin dịch vụ thanh toán không hợp lệ, vui lòng tải lại trang" };
            }
            else
            {
                var ycKhamBenhExcept = thuPhiKhamChuaBenhVo.DanhSachChiPhiKhamChuaBenhDaChons
                .Where(o => o.LoaiNhom == NhomChiPhiNoiTru.DichVuKhamBenh).Select(o => o.Id).Except(ycTiepNhan
                    .YeuCauKhamBenhs
                    .Where(o => o.YeuCauGoiDichVuId == null && (!o.DuocHuongBaoHiem || o.BaoHiemChiTra != null) &&
                                (o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                                 o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                    .Select(o => o.Id)
                    .Concat(yeuCauTiepNhanNgoaiTruCanQuyetToan
                            .YeuCauKhamBenhs
                            .Where(o => o.YeuCauGoiDichVuId == null && (!o.DuocHuongBaoHiem || o.BaoHiemChiTra != null) &&
                                        (o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                                         o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                            .Select(o => o.Id)));
                var ycKyThuatExcept = thuPhiKhamChuaBenhVo.DanhSachChiPhiKhamChuaBenhDaChons
                    .Where(o => o.LoaiNhom == NhomChiPhiNoiTru.DichVuKyThuat).Select(o => o.Id).Except(ycTiepNhan
                        .YeuCauDichVuKyThuats
                        .Where(o => o.YeuCauGoiDichVuId == null && (!o.DuocHuongBaoHiem || o.BaoHiemChiTra != null) &&
                                    (o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                                     o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                        .Select(o => o.Id)
                        .Concat(yeuCauTiepNhanNgoaiTruCanQuyetToan.YeuCauDichVuKyThuats
                            .Where(o => o.YeuCauGoiDichVuId == null && (!o.DuocHuongBaoHiem || o.BaoHiemChiTra != null) &&
                                        (o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                                         o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                            .Select(o => o.Id)));
                var ycTruyenMauExcept = thuPhiKhamChuaBenhVo.DanhSachChiPhiKhamChuaBenhDaChons
                    .Where(o => o.LoaiNhom == NhomChiPhiNoiTru.TruyenMau).Select(o => o.Id).Except(ycTiepNhan
                        .YeuCauTruyenMaus
                        .Where(o => (!o.DuocHuongBaoHiem || o.BaoHiemChiTra != null) &&
                                    (o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                                     o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                        .Select(o => o.Id));
                var ycGiuongExcept = thuPhiKhamChuaBenhVo.DanhSachChiPhiKhamChuaBenhDaChons
                    .Where(o => o.LoaiNhom == NhomChiPhiNoiTru.DichVuGiuong).Select(o => o.Id).Except(ycTiepNhan
                        .YeuCauDichVuGiuongBenhVienChiPhiBenhViens
                        .Where(o => o.YeuCauGoiDichVuId == null && (o.YeuCauDichVuGiuongBenhVienChiPhiBHYTs.All(gbh => !gbh.DuocHuongBaoHiem || gbh.BaoHiemChiTra != null)) &&
                                    (o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                                     o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                        .Select(o => o.Id));
                var ycDuocPhamExcept = thuPhiKhamChuaBenhVo.DanhSachChiPhiKhamChuaBenhDaChons
                    .Where(o => o.LoaiNhom == NhomChiPhiNoiTru.DuocPham).Select(o => o.Id).Except(ycTiepNhan
                        .YeuCauDuocPhamBenhViens
                        .Where(o => o.YeuCauGoiDichVuId == null && (!o.DuocHuongBaoHiem || o.BaoHiemChiTra != null) &&
                                    (o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                                     o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                        .Select(o => o.Id)
                        .Concat(yeuCauTiepNhanNgoaiTruCanQuyetToan
                            .YeuCauDuocPhamBenhViens
                            .Where(o => o.YeuCauGoiDichVuId == null && (!o.DuocHuongBaoHiem || o.BaoHiemChiTra != null) &&
                                        (o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                                         o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                            .Select(o => o.Id)));
                var ycVatTuExcept = thuPhiKhamChuaBenhVo.DanhSachChiPhiKhamChuaBenhDaChons
                    .Where(o => o.LoaiNhom == NhomChiPhiNoiTru.VatTuTieuHao).Select(o => o.Id).Except(ycTiepNhan
                        .YeuCauVatTuBenhViens
                        .Where(o => o.YeuCauGoiDichVuId == null && (!o.DuocHuongBaoHiem || o.BaoHiemChiTra != null) &&
                                    (o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                                     o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                        .Select(o => o.Id)
                        .Concat(yeuCauTiepNhanNgoaiTruCanQuyetToan
                            .YeuCauVatTuBenhViens
                            .Where(o => o.YeuCauGoiDichVuId == null && (!o.DuocHuongBaoHiem || o.BaoHiemChiTra != null) &&
                                        (o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                                         o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                            .Select(o => o.Id)));
                var ycToaThuocExcept = thuPhiKhamChuaBenhVo.DanhSachChiPhiKhamChuaBenhDaChons
                    .Where(o => o.LoaiNhom == NhomChiPhiNoiTru.ToaThuoc).Select(o => o.Id).Except(ycTiepNhan
                        .DonThuocThanhToans
                        .Where(o => o.LoaiDonThuoc == Enums.EnumLoaiDonThuoc.ThuocBHYT &&
                                    (o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                                     o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                        .SelectMany(o => o.DonThuocThanhToanChiTiets).Where(o => o.BaoHiemChiTra != null)
                        .Select(o => o.Id)
                        .Concat(yeuCauTiepNhanNgoaiTruCanQuyetToan
                            .DonThuocThanhToans
                            .Where(o => o.LoaiDonThuoc == Enums.EnumLoaiDonThuoc.ThuocBHYT &&
                                        (o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                                         o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                            .SelectMany(o => o.DonThuocThanhToanChiTiets).Where(o => o.BaoHiemChiTra != null)
                            .Select(o => o.Id)));

                if (ycKhamBenhExcept.Any() || ycKyThuatExcept.Any() || ycGiuongExcept.Any() || ycDuocPhamExcept.Any() || ycVatTuExcept.Any() || ycTruyenMauExcept.Any() ||
                    ycToaThuocExcept.Any())
                    return new KetQuaThuPhiKhamChuaBenhNoiTruVaQuyetToanDichVuTrongGoiVo { Error = "Thông tin dịch vụ thanh toán không hợp lệ, vui lòng tải lại trang" };
            }

            var tongThuBenhNhan = thuPhiKhamChuaBenhVo.TienMat.GetValueOrDefault() +
                                  thuPhiKhamChuaBenhVo.ChuyenKhoan.GetValueOrDefault() +
                                  thuPhiKhamChuaBenhVo.POS.GetValueOrDefault();

            var dsChiPhi = await GetDanhSachChiPhiKhamChuaBenhChuaThu(thuPhiKhamChuaBenhVo.Id);
            var dsChiPhiDaChon = thuPhiKhamChuaBenhVo.DanhSachChiPhiKhamChuaBenhDaChons;

            foreach (var chiPhiKhamChuaBenhVo in dsChiPhiDaChon)
            {
                var chiphi = dsChiPhi.FirstOrDefault(o => o.LoaiNhom == chiPhiKhamChuaBenhVo.LoaiNhom && o.Id == chiPhiKhamChuaBenhVo.Id);
                if (chiphi == null || !chiphi.ThanhTien.AlmostEqual(chiPhiKhamChuaBenhVo.ThanhTien) || !chiphi.BHYTThanhToan.AlmostEqual(chiPhiKhamChuaBenhVo.BHYTThanhToan))
                {
                    return new KetQuaThuPhiKhamChuaBenhNoiTruVaQuyetToanDichVuTrongGoiVo { Error = "Thông tin dịch vụ thanh toán không hợp lệ, vui lòng tải lại trang" };
                }
                if (chiPhiKhamChuaBenhVo.TongCongNo > chiPhiKhamChuaBenhVo.ThanhTien && chiPhiKhamChuaBenhVo.TongCongNo > Math.Round(chiPhiKhamChuaBenhVo.ThanhTien, 2, MidpointRounding.AwayFromZero))
                {
                    return new KetQuaThuPhiKhamChuaBenhNoiTruVaQuyetToanDichVuTrongGoiVo { Error = "Số tiền BHTN thanh toán lớn hơn thành tiền" };
                }
                var soTienTruocMienGiam = chiPhiKhamChuaBenhVo.ThanhTien - chiPhiKhamChuaBenhVo.BHYTThanhToan;

                decimal soTienMienGiamTheoDv = 0;

                foreach (var mienGiamTheoTiLe in chiPhiKhamChuaBenhVo.DanhSachMienGiamVos.Where(o => o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoTiLe))
                {
                    mienGiamTheoTiLe.SoTien = Math.Round((soTienTruocMienGiam * mienGiamTheoTiLe.TiLe.GetValueOrDefault() / 100), 2, MidpointRounding.AwayFromZero);
                    soTienMienGiamTheoDv += mienGiamTheoTiLe.SoTien;
                }
                foreach (var mienGiamTheoTiLe in chiPhiKhamChuaBenhVo.DanhSachMienGiamVos.Where(o => o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoSoTien))
                {
                    soTienMienGiamTheoDv += mienGiamTheoTiLe.SoTien;
                }
                if (soTienMienGiamTheoDv > chiPhiKhamChuaBenhVo.ThanhTien && soTienMienGiamTheoDv > Math.Round(chiPhiKhamChuaBenhVo.ThanhTien, 2, MidpointRounding.AwayFromZero))
                {
                    return new KetQuaThuPhiKhamChuaBenhNoiTruVaQuyetToanDichVuTrongGoiVo { Error = "Số tiền miễn giảm lớn hơn thành tiền" };
                }
                chiPhiKhamChuaBenhVo.SoTienMG = soTienMienGiamTheoDv;
            }
            var thuTamUng = ycTiepNhan.TaiKhoanBenhNhanThus.Where(o => o.DaHuy != true && o.LoaiThuTienBenhNhan == LoaiThuTienBenhNhan.ThuTamUng && o.ThuTienGoiDichVu != true && o.PhieuHoanUngId == null).ToList();
            if (yeuCauTiepNhanNgoaiTruCanQuyetToan != null)
            {
                thuTamUng.AddRange(yeuCauTiepNhanNgoaiTruCanQuyetToan.TaiKhoanBenhNhanThus.Where(o => o.DaHuy != true && o.LoaiThuTienBenhNhan == LoaiThuTienBenhNhan.ThuTamUng && o.ThuTienGoiDichVu != true && o.PhieuHoanUngId == null).ToList());
            }
            var soTienDaTamUng = thuTamUng.Select(o => o.TienMat.GetValueOrDefault(0) + o.ChuyenKhoan.GetValueOrDefault(0) + o.POS.GetValueOrDefault(0)).DefaultIfEmpty(0).Sum();
            var soTienCanThu = Math.Round(dsChiPhiDaChon.Sum(o => o.BNConPhaiThanhToan), MidpointRounding.AwayFromZero);

            //chi phi trong goi
            var chiPhiTrongGois = new List<ChiPhiKhamChuaBenhTrongGoiDichVuVo>();
            if (yeuCauTiepNhanNgoaiTruCanQuyetToan != null)
            {
                chiPhiTrongGois.AddRange(yeuCauTiepNhanNgoaiTruCanQuyetToan.YeuCauKhamBenhs.Where(o =>
                o.TrangThai != Enums.EnumTrangThaiYeuCauKhamBenh.HuyKham &&
                o.TrangThaiThanhToan != Enums.TrangThaiThanhToan.DaThanhToan && o.YeuCauGoiDichVuId != null)
                .Select(s => new ChiPhiKhamChuaBenhTrongGoiDichVuVo
                {
                    Id = s.Id,
                    YeuCauGoiDichVuId = s.YeuCauGoiDichVuId.Value,
                    ChuongTrinhGoiDichVuId = s.YeuCauGoiDichVu.ChuongTrinhGoiDichVuId,
                    NgayPhatSinh = s.ThoiDiemChiDinh,
                    LoaiNhom = NhomChiPhiKhamChuaBenh.DichVuKhamBenh,
                    Soluong = 1,
                    DonGia = s.DonGiaSauChietKhau.GetValueOrDefault(),
                    DonGiaBHYT = s.DonGiaBaoHiem.GetValueOrDefault(),
                    KiemTraBHYTXacNhan = s.BaoHiemChiTra != null,
                    DuocHuongBHYT = s.DuocHuongBaoHiem,
                    TiLeBaoHiemThanhToan = s.TiLeBaoHiemThanhToan.GetValueOrDefault(),
                    MucHuongBaoHiem = s.MucHuongBaoHiem.GetValueOrDefault(),
                    DanhSachCongNoChoThus = s.CongTyBaoHiemTuNhanCongNos.Count == 0 ? new List<DanhSachCongNoVo>() : s.CongTyBaoHiemTuNhanCongNos.Where(o => o.TaiKhoanBenhNhanThuId == null).Select(o => new DanhSachCongNoVo { CongTyBaoHiemTuNhanId = o.CongTyBaoHiemTuNhanId, SoTienCongNoChoThu = o.SoTien }).ToList(),
                    CheckedDefault = true,
                }));

                chiPhiTrongGois.AddRange(yeuCauTiepNhanNgoaiTruCanQuyetToan.YeuCauDichVuKyThuats.Where(o =>
                        o.TrangThai != Enums.EnumTrangThaiYeuCauDichVuKyThuat.DaHuy &&
                        o.TrangThaiThanhToan != Enums.TrangThaiThanhToan.DaThanhToan && o.YeuCauGoiDichVuId != null)
                    .Select(s => new ChiPhiKhamChuaBenhTrongGoiDichVuVo
                    {
                        Id = s.Id,
                        YeuCauGoiDichVuId = s.YeuCauGoiDichVuId.Value,
                        ChuongTrinhGoiDichVuId = s.YeuCauGoiDichVu.ChuongTrinhGoiDichVuId,
                        NgayPhatSinh = s.ThoiDiemChiDinh,
                        LoaiNhom = NhomChiPhiKhamChuaBenh.DichVuKyThuat,
                        Soluong = s.SoLan,
                        DonGia = s.DonGiaSauChietKhau.GetValueOrDefault(),
                        DonGiaBHYT = s.DonGiaBaoHiem.GetValueOrDefault(),
                        KiemTraBHYTXacNhan = s.BaoHiemChiTra != null,
                        DuocHuongBHYT = s.DuocHuongBaoHiem,
                        TiLeBaoHiemThanhToan = s.TiLeBaoHiemThanhToan.GetValueOrDefault(),
                        MucHuongBaoHiem = s.MucHuongBaoHiem.GetValueOrDefault(),
                        DanhSachCongNoChoThus = s.CongTyBaoHiemTuNhanCongNos.Count == 0 ? new List<DanhSachCongNoVo>() : s.CongTyBaoHiemTuNhanCongNos.Where(o => o.TaiKhoanBenhNhanThuId == null).Select(o => new DanhSachCongNoVo { CongTyBaoHiemTuNhanId = o.CongTyBaoHiemTuNhanId, SoTienCongNoChoThu = o.SoTien }).ToList(),
                        CheckedDefault = true,
                    }));
            }

            chiPhiTrongGois.AddRange(ycTiepNhan.YeuCauDichVuKyThuats.Where(o =>
                    o.TrangThai != Enums.EnumTrangThaiYeuCauDichVuKyThuat.DaHuy &&
                    o.TrangThaiThanhToan != Enums.TrangThaiThanhToan.DaThanhToan && o.YeuCauGoiDichVuId != null)
                .Select(s => new ChiPhiKhamChuaBenhTrongGoiDichVuVo
                {
                    Id = s.Id,
                    YeuCauGoiDichVuId = s.YeuCauGoiDichVuId.Value,
                    ChuongTrinhGoiDichVuId = s.YeuCauGoiDichVu.ChuongTrinhGoiDichVuId,
                    LoaiNhom = NhomChiPhiKhamChuaBenh.DichVuKyThuat,
                    Soluong = s.SoLan,
                    DonGia = s.DonGiaSauChietKhau.GetValueOrDefault(),
                    DonGiaBHYT = s.DonGiaBaoHiem.GetValueOrDefault(),
                    KiemTraBHYTXacNhan = s.BaoHiemChiTra != null,
                    DuocHuongBHYT = s.DuocHuongBaoHiem,
                    TiLeBaoHiemThanhToan = s.TiLeBaoHiemThanhToan.GetValueOrDefault(),
                    MucHuongBaoHiem = s.MucHuongBaoHiem.GetValueOrDefault(),
                    DanhSachCongNoChoThus = s.CongTyBaoHiemTuNhanCongNos.Count == 0 ? new List<DanhSachCongNoVo>() : s.CongTyBaoHiemTuNhanCongNos.Where(o => o.TaiKhoanBenhNhanThuId == null).Select(o => new DanhSachCongNoVo { CongTyBaoHiemTuNhanId = o.CongTyBaoHiemTuNhanId, SoTienCongNoChoThu = o.SoTien }).ToList(),
                    CheckedDefault = true,
                }));

            chiPhiTrongGois.AddRange(ycTiepNhan.YeuCauDichVuGiuongBenhVienChiPhiBenhViens.Where(o =>
                   o.TrangThaiThanhToan != Enums.TrangThaiThanhToan.DaThanhToan && o.YeuCauGoiDichVuId != null)
               .Select(s => new ChiPhiKhamChuaBenhTrongGoiDichVuVo
               {
                   Id = s.Id,
                   YeuCauGoiDichVuId = s.YeuCauGoiDichVuId.Value,
                   NgayPhatSinh = s.NgayPhatSinh,
                   LoaiNhom = NhomChiPhiKhamChuaBenh.DichVuGiuong,
                   Ma = s.Ma,
                   TenDichVu = s.Ten,
                   Soluong = s.SoLuong,
                   DonGia = s.DonGiaSauChietKhau.GetValueOrDefault(),
                   DonGiaBHYT = s.YeuCauDichVuGiuongBenhVienChiPhiBHYTs.FirstOrDefault()?.DonGiaBaoHiem ?? 0,
                   KiemTraBHYTXacNhan = s.YeuCauDichVuGiuongBenhVienChiPhiBHYTs.FirstOrDefault()?.BaoHiemChiTra != null,
                   DuocHuongBHYT = s.YeuCauDichVuGiuongBenhVienChiPhiBHYTs.FirstOrDefault()?.DuocHuongBaoHiem ?? false,
                   TiLeBaoHiemThanhToan = s.YeuCauDichVuGiuongBenhVienChiPhiBHYTs.FirstOrDefault()?.TiLeBaoHiemThanhToan ?? 0,
                   DanhSachCongNoChoThus = s.CongTyBaoHiemTuNhanCongNos.Count == 0 ? new List<DanhSachCongNoVo>() : s.CongTyBaoHiemTuNhanCongNos.Where(o => o.TaiKhoanBenhNhanThuId == null).Select(o => new DanhSachCongNoVo { CongTyBaoHiemTuNhanId = o.CongTyBaoHiemTuNhanId, SoTienCongNoChoThu = o.SoTien }).ToList(),
                   MucHuongBaoHiem = s.YeuCauDichVuGiuongBenhVienChiPhiBHYTs.FirstOrDefault()?.MucHuongBaoHiem ?? 0,
                   CheckedDefault = true,
               }));

            var goiDvIds = chiPhiTrongGois.Select(o => o.YeuCauGoiDichVuId).Distinct().ToList();
            var goiDvs = goiDvIds.Any() ?
                _yeuCauGoiDichVuRepository.Table.Where(o => goiDvIds.Contains(o.Id)).Include(o => o.ChuongTrinhGoiDichVu).Include(o => o.TaiKhoanBenhNhanThus).Include(o => o.TaiKhoanBenhNhanChis).ToList()
                : new List<YeuCauGoiDichVu>();

            //var tongSoTienQBHYTTrongGoi = Math.Round(chiPhiTrongGois.Where(o => o.KiemTraBHYTXacNhan).Select(o => o.BHYTThanhToan).DefaultIfEmpty().Sum(), MidpointRounding.AwayFromZero);

            decimal soTienHoanUng = 0;
            foreach (var goiDv in goiDvs)
            {
                if (goiDv.ChuongTrinhGoiDichVu?.CongTyBaoHiemTuNhanId != null)
                    continue;
                soTienHoanUng += Math.Round(chiPhiTrongGois.Where(o => o.YeuCauGoiDichVuId == goiDv.Id).Select(o => o.BHYTThanhToan).DefaultIfEmpty().Sum(), MidpointRounding.AwayFromZero);
                soTienHoanUng += Math.Round(chiPhiTrongGois.Where(o => o.YeuCauGoiDichVuId == goiDv.Id).Select(o => o.TongCongNo).DefaultIfEmpty().Sum(), MidpointRounding.AwayFromZero);
            }

            if ((!thuPhiKhamChuaBenhVo.SoTienCongNo.GetValueOrDefault().SoTienTuongDuong(0) && thuPhiKhamChuaBenhVo.SoTienCongNo.GetValueOrDefault() > soTienCanThu)
                || (soTienDaTamUng + thuPhiKhamChuaBenhVo.SoTienCongNo.GetValueOrDefault() + soTienHoanUng >= soTienCanThu && !tongThuBenhNhan.SoTienTuongDuong(0))
                || (soTienDaTamUng + thuPhiKhamChuaBenhVo.SoTienCongNo.GetValueOrDefault() + soTienHoanUng < soTienCanThu && !soTienCanThu.SoTienTuongDuong(tongThuBenhNhan + thuPhiKhamChuaBenhVo.SoTienCongNo.GetValueOrDefault() + soTienDaTamUng + soTienHoanUng)))
                return new KetQuaThuPhiKhamChuaBenhNoiTruVaQuyetToanDichVuTrongGoiVo { Error = "Số tiền thanh toán không hợp lệ" };

            var tk = ycTiepNhan.BenhNhan.TaiKhoanBenhNhan ?? new TaiKhoanBenhNhan
            {
                BenhNhan = ycTiepNhan.BenhNhan
            };
            var userId = _userAgentHelper.GetCurrentUserId();
            var userThuNgan = _userRepository.GetById(_userAgentHelper.GetCurrentUserId());
            var maTaiKhoan = userId.ToString();
            if (userThuNgan.Email != null && userThuNgan.Email.IndexOf("@") > 0)
            {
                maTaiKhoan = userThuNgan.Email.Substring(0, userThuNgan.Email.IndexOf("@") > 10 ? 10 : userThuNgan.Email.IndexOf("@"));
            }


            //thu trong goi
            TaiKhoanBenhNhanThu thuPhi = null;
            if (chiPhiTrongGois.Any())
            {
                if (chiPhiTrongGois.Any(o => o.DuocHuongBHYT && !o.KiemTraBHYTXacNhan))
                {
                    return new KetQuaThuPhiKhamChuaBenhNoiTruVaQuyetToanDichVuTrongGoiVo { Error = "Có dịch vụ trong gói chưa được duyệt BHYT" };
                }

                foreach (var chiPhiTrongGoi in chiPhiTrongGois)
                {
                    var congTyBaoHiemTuNhanBaoLanh = ycTiepNhan.YeuCauTiepNhanCongTyBaoHiemTuNhans.FirstOrDefault(o => GetChuongTrinhGoiDichVuBHTNBaoLanhs().Any(ct => ct.CongTyBaoHiemTuNhanId == o.CongTyBaoHiemTuNhanId && ct.Id == chiPhiTrongGoi.ChuongTrinhGoiDichVuId));

                    if (congTyBaoHiemTuNhanBaoLanh != null)
                    {
                        chiPhiTrongGoi.DanhSachCongNoChoThus.Add(new DanhSachCongNoVo { CongTyBaoHiemTuNhanId = congTyBaoHiemTuNhanBaoLanh.CongTyBaoHiemTuNhanId, SoTienCongNoChoThu = chiPhiTrongGoi.SoTienQuyetToan });
                    }
                }

                //var goiDvIds = chiPhiTrongGois.Select(o => o.YeuCauGoiDichVuId).Distinct();
                //var goiDvs = await _yeuCauGoiDichVuRepository.Table.Where(o => goiDvIds.Contains(o.Id)).Include(o => o.ChuongTrinhGoiDichVu)
                //    .Include(o => o.TaiKhoanBenhNhanThus).Include(o => o.TaiKhoanBenhNhanChis).ToListAsync();

                //foreach (var goiDvId in goiDvIds)
                //{
                //    var goiDv = goiDvs.First(o => o.Id == goiDvId);
                //    //update BVHD-3584
                //    //var soTienDaQuyetToan = goiDv.TaiKhoanBenhNhanThus
                //    //    .Where(o => o.DaHuy != true && o.LoaiThuTienBenhNhan == Enums.LoaiThuTienBenhNhan.ThuTheoChiPhi && o.ThuTienGoiDichVu == true)
                //    //    .Select(o => o.TamUng.GetValueOrDefault()).DefaultIfEmpty().Sum();
                //    var soTienQuyetToan = chiPhiTrongGois.Where(o => o.YeuCauGoiDichVuId == goiDv.Id)
                //        .Select(o => o.SoTienQuyetToan).DefaultIfEmpty().Sum();
                //    if (goiDv.SoTienBenhNhanDaChi.GetValueOrDefault() < soTienQuyetToan)
                //    {
                //        return new KetQuaThuPhiKhamChuaBenhNoiTruVaQuyetToanDichVuTrongGoiVo { Error = $"Số tiền đã tạm ứng trong gói {goiDv.TenChuongTrinh} không đủ quyết toán" };
                //    }
                //}

                thuPhi = new TaiKhoanBenhNhanThu
                {
                    TaiKhoanBenhNhan = tk,
                    LoaiThuTienBenhNhan = Enums.LoaiThuTienBenhNhan.ThuTheoChiPhi,
                    ThuTienGoiDichVu = true,
                    LoaiNoiThu = Enums.LoaiNoiThu.ThuNgan,
                    NoiDungThu = thuPhiKhamChuaBenhVo.NoiDungThu,
                    NgayThu = thuPhiKhamChuaBenhVo.NgayThu,
                    //update BVHD-3584
                    TamUng = 0,
                    //TamUng = chiPhiTrongGois.Sum(o => o.SoTienQuyetToan),
                    SoPhieuHienThi = ResourceHelper.CreateSoPhieuThu(userId, maTaiKhoan),
                    NhanVienThucHienId = _userAgentHelper.GetCurrentUserId(),
                    NoiThucHienId = _userAgentHelper.GetCurrentNoiLLamViecId()
                };
                foreach (var goiDv in goiDvs)
                {
                    decimal tamUngTheoGoi = 0;
                    if (goiDv.ChuongTrinhGoiDichVu?.CongTyBaoHiemTuNhanId != null)
                        continue;

                    var soTienQuyetToan = chiPhiTrongGois.Where(o => o.YeuCauGoiDichVuId == goiDv.Id)
                        .Select(o => o.SoTienQuyetToan).DefaultIfEmpty().Sum();

                    if (soTienQuyetToan > 0)
                    {
                        var phieuHoanUngTrongGoi = new TaiKhoanBenhNhanChi
                        {
                            TaiKhoanBenhNhan = tk,
                            LoaiChiTienBenhNhan = Enums.LoaiChiTienBenhNhan.HoanUng,
                            YeuCauGoiDichVuId = goiDv.Id,
                            TienMat = soTienQuyetToan,
                            NoiDungChi = Enums.LoaiChiTienBenhNhan.HoanUng.GetDescription(),
                            NgayChi = thuPhi.NgayThu.AddMilliseconds(-1),
                            YeuCauTiepNhanId = ycTiepNhan.Id,
                            SoPhieuHienThi = ResourceHelper.CreateSoHoanUng(),
                            NhanVienThucHienId = _userAgentHelper.GetCurrentUserId(),
                            NoiThucHienId = _userAgentHelper.GetCurrentNoiLLamViecId()
                        };
                        thuPhi.TaiKhoanBenhNhanChis.Add(phieuHoanUngTrongGoi);
                        //update BVHD-3584
                        thuPhi.TamUng = thuPhi.TamUng.GetValueOrDefault() + soTienQuyetToan;
                        tamUngTheoGoi += soTienQuyetToan;
                    }
                    //hoan BHYT
                    var soTienQBHYTTrongGoi = Math.Round(chiPhiTrongGois.Where(o => o.YeuCauGoiDichVuId == goiDv.Id).Select(o => o.BHYTThanhToan).DefaultIfEmpty().Sum(), MidpointRounding.AwayFromZero);
                    if (!soTienQBHYTTrongGoi.AlmostEqual(0))
                    {
                        var phieuHoanUngTrongGoi = new TaiKhoanBenhNhanChi
                        {
                            TaiKhoanBenhNhan = tk,
                            LoaiChiTienBenhNhan = Enums.LoaiChiTienBenhNhan.HoanUng,
                            YeuCauGoiDichVuId = goiDv.Id,
                            TienMat = soTienQBHYTTrongGoi,
                            NoiDungChi = Enums.LoaiChiTienBenhNhan.HoanUng.GetDescription() + " BHYT",
                            NgayChi = thuPhi.NgayThu.AddMilliseconds(-1),
                            YeuCauTiepNhanId = ycTiepNhan.Id,
                            SoPhieuHienThi = ResourceHelper.CreateSoHoanUng(),
                            NhanVienThucHienId = _userAgentHelper.GetCurrentUserId(),
                            NoiThucHienId = _userAgentHelper.GetCurrentNoiLLamViecId()
                        };
                        thuPhi.TaiKhoanBenhNhanChis.Add(phieuHoanUngTrongGoi);
                        //update BVHD-3584
                        thuPhi.TamUng = thuPhi.TamUng.GetValueOrDefault() + soTienQBHYTTrongGoi;
                        tamUngTheoGoi += soTienQBHYTTrongGoi;
                    }
                    //hoan BHTN
                    var soTienBHTNTrongGoi = Math.Round(chiPhiTrongGois.Where(o => o.YeuCauGoiDichVuId == goiDv.Id).Select(o => o.TongCongNo).DefaultIfEmpty().Sum(), MidpointRounding.AwayFromZero);
                    if (!soTienBHTNTrongGoi.AlmostEqual(0))
                    {
                        var phieuHoanUngTrongGoi = new TaiKhoanBenhNhanChi
                        {
                            TaiKhoanBenhNhan = tk,
                            LoaiChiTienBenhNhan = Enums.LoaiChiTienBenhNhan.HoanUng,
                            YeuCauGoiDichVuId = goiDv.Id,
                            TienMat = soTienBHTNTrongGoi,
                            NoiDungChi = Enums.LoaiChiTienBenhNhan.HoanUng.GetDescription() + " BHTN",
                            NgayChi = thuPhi.NgayThu.AddMilliseconds(-1),
                            YeuCauTiepNhanId = ycTiepNhan.Id,
                            SoPhieuHienThi = ResourceHelper.CreateSoHoanUng(),
                            NhanVienThucHienId = _userAgentHelper.GetCurrentUserId(),
                            NoiThucHienId = _userAgentHelper.GetCurrentNoiLLamViecId()
                        };
                        thuPhi.TaiKhoanBenhNhanChis.Add(phieuHoanUngTrongGoi);
                        //update BVHD-3584
                        thuPhi.TamUng = thuPhi.TamUng.GetValueOrDefault() + soTienBHTNTrongGoi;
                        tamUngTheoGoi += soTienBHTNTrongGoi;
                    }
                    var soTienDaHoan = goiDv.TaiKhoanBenhNhanChis.Where(o =>
                            o.CreatedOn != null && o.LoaiChiTienBenhNhan == Enums.LoaiChiTienBenhNhan.HoanUng && o.TaiKhoanBenhNhanThuId != null &&
                            o.DaHuy != true)
                        .Select(o => o.TienMat.GetValueOrDefault()).DefaultIfEmpty().Sum();

                    if (goiDv.SoTienBenhNhanDaChi.GetValueOrDefault() + 100 < tamUngTheoGoi + soTienDaHoan)
                    {
                        return new KetQuaThuPhiKhamChuaBenhNoiTruVaQuyetToanDichVuTrongGoiVo { Error = $"Số tiền đã tạm ứng trong gói {goiDv.TenChuongTrinh} không đủ quyết toán" };
                    }
                }

                foreach (var chiphi in chiPhiTrongGois.Where(o => o.LoaiNhom == NhomChiPhiKhamChuaBenh.DichVuKhamBenh))
                {
                    var yc = yeuCauTiepNhanNgoaiTruCanQuyetToan?.YeuCauKhamBenhs?.First(o => o.Id == chiphi.Id);

                    foreach (var ycCongTyBaoHiemTuNhanCongNo in yc.CongTyBaoHiemTuNhanCongNos.Where(o => o.TaiKhoanBenhNhanThuId == null))
                    {
                        ycCongTyBaoHiemTuNhanCongNo.WillDelete = true;
                    }
                    if (chiphi.TongCongNo > 0)
                    {
                        foreach (var chiphiDanhSachCongNoChoThu in chiphi.DanhSachCongNoChoThus)
                        {
                            if (chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu.AlmostEqual(0))
                                continue;
                            yc.CongTyBaoHiemTuNhanCongNos.Add(new CongTyBaoHiemTuNhanCongNo
                            {
                                TaiKhoanBenhNhanThu = thuPhi,
                                CongTyBaoHiemTuNhanId = chiphiDanhSachCongNoChoThu.CongTyBaoHiemTuNhanId,
                                SoTien = chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu
                            });
                        }
                    }
                    yc.SoTienBaoHiemTuNhanChiTra = chiphi.TongCongNo;

                    yc.SoTienBenhNhanDaChi = chiphi.SoTienQuyetToan;
                    yc.TrangThaiThanhToan = Enums.TrangThaiThanhToan.DaThanhToan;
                    thuPhi.TaiKhoanBenhNhanChis.Add(new TaiKhoanBenhNhanChi
                    {
                        TaiKhoanBenhNhan = tk,
                        LoaiChiTienBenhNhan = Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi,
                        TienChiPhi = yc.SoTienBenhNhanDaChi,
                        NoiDungChi = Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi.GetDescription(),
                        NgayChi = DateTime.Now,
                        SoPhieuHienThi = thuPhi.SoPhieuHienThi,
                        YeuCauKhamBenh = yc,
                        Gia = yc.DonGiaSauChietKhau.GetValueOrDefault(),
                        SoLuong = 1,
                        DonGiaBaoHiem = yc.DonGiaBaoHiem,
                        MucHuongBaoHiem = yc.DuocHuongBaoHiem ? yc.MucHuongBaoHiem : 0,
                        TiLeBaoHiemThanhToan = yc.TiLeBaoHiemThanhToan,
                        SoTienMienGiam = yc.SoTienMienGiam,
                        SoTienBaoHiemTuNhanChiTra = yc.SoTienBaoHiemTuNhanChiTra,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        NhanVienThucHienId = _userAgentHelper.GetCurrentUserId(),
                        NoiThucHienId = _userAgentHelper.GetCurrentNoiLLamViecId()
                    });
                }
                foreach (var chiphi in chiPhiTrongGois.Where(o => o.LoaiNhom == NhomChiPhiKhamChuaBenh.DichVuKyThuat))
                {
                    var yc = yeuCauTiepNhanNgoaiTruCanQuyetToan?.YeuCauDichVuKyThuats?.FirstOrDefault(o => o.Id == chiphi.Id) ?? ycTiepNhan.YeuCauDichVuKyThuats.FirstOrDefault(o => o.Id == chiphi.Id);

                    foreach (var ycCongTyBaoHiemTuNhanCongNo in yc.CongTyBaoHiemTuNhanCongNos.Where(o => o.TaiKhoanBenhNhanThuId == null))
                    {
                        ycCongTyBaoHiemTuNhanCongNo.WillDelete = true;
                    }
                    if (chiphi.TongCongNo > 0)
                    {
                        foreach (var chiphiDanhSachCongNoChoThu in chiphi.DanhSachCongNoChoThus)
                        {
                            if (chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu.AlmostEqual(0))
                                continue;
                            yc.CongTyBaoHiemTuNhanCongNos.Add(new CongTyBaoHiemTuNhanCongNo
                            {
                                TaiKhoanBenhNhanThu = thuPhi,
                                CongTyBaoHiemTuNhanId = chiphiDanhSachCongNoChoThu.CongTyBaoHiemTuNhanId,
                                SoTien = chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu
                            });
                        }
                    }
                    yc.SoTienBaoHiemTuNhanChiTra = chiphi.TongCongNo;

                    yc.SoTienBenhNhanDaChi = chiphi.SoTienQuyetToan;
                    yc.TrangThaiThanhToan = Enums.TrangThaiThanhToan.DaThanhToan;
                    thuPhi.TaiKhoanBenhNhanChis.Add(new TaiKhoanBenhNhanChi
                    {
                        TaiKhoanBenhNhan = tk,
                        LoaiChiTienBenhNhan = Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi,
                        TienChiPhi = yc.SoTienBenhNhanDaChi,
                        NoiDungChi = Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi.GetDescription(),
                        NgayChi = DateTime.Now,
                        SoPhieuHienThi = thuPhi.SoPhieuHienThi,
                        YeuCauDichVuKyThuat = yc,
                        Gia = yc.DonGiaSauChietKhau.GetValueOrDefault(),
                        SoLuong = yc.SoLan,
                        DonGiaBaoHiem = yc.DonGiaBaoHiem,
                        MucHuongBaoHiem = yc.DuocHuongBaoHiem ? yc.MucHuongBaoHiem : 0,
                        TiLeBaoHiemThanhToan = yc.TiLeBaoHiemThanhToan,
                        SoTienMienGiam = yc.SoTienMienGiam,
                        SoTienBaoHiemTuNhanChiTra = yc.SoTienBaoHiemTuNhanChiTra,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        NhanVienThucHienId = _userAgentHelper.GetCurrentUserId(),
                        NoiThucHienId = _userAgentHelper.GetCurrentNoiLLamViecId()
                    });
                }
                foreach (var chiphi in chiPhiTrongGois.Where(o => o.LoaiNhom == NhomChiPhiKhamChuaBenh.DichVuGiuong))
                {
                    var hoatDongGiuongs = ycTiepNhan.HoatDongGiuongBenhs.Where(c => c.ThoiDiemKetThuc == null);

                    if (hoatDongGiuongs.Any())
                    {
                        foreach (var hoatDongGiuong in hoatDongGiuongs)
                        {
                            hoatDongGiuong.ThoiDiemKetThuc = ycTiepNhan.NoiTruBenhAn.ThoiDiemRaVien;
                        }
                    }

                    var yc = ycTiepNhan.YeuCauDichVuGiuongBenhVienChiPhiBenhViens.First(o => o.Id == chiphi.Id);
                    var chiPhiBHYT = yc.YeuCauDichVuGiuongBenhVienChiPhiBHYTs.FirstOrDefault(o => o.BaoHiemChiTra == true);

                    foreach (var ycCongTyBaoHiemTuNhanCongNo in yc.CongTyBaoHiemTuNhanCongNos.Where(o => o.TaiKhoanBenhNhanThuId == null))
                    {
                        ycCongTyBaoHiemTuNhanCongNo.WillDelete = true;
                    }
                    if (chiphi.TongCongNo > 0)
                    {
                        foreach (var chiphiDanhSachCongNoChoThu in chiphi.DanhSachCongNoChoThus)
                        {
                            if (chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu.AlmostEqual(0))
                                continue;
                            yc.CongTyBaoHiemTuNhanCongNos.Add(new CongTyBaoHiemTuNhanCongNo
                            {
                                TaiKhoanBenhNhanThu = thuPhi,
                                CongTyBaoHiemTuNhanId = chiphiDanhSachCongNoChoThu.CongTyBaoHiemTuNhanId,
                                SoTien = chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu
                            });
                        }
                    }
                    yc.SoTienBaoHiemTuNhanChiTra = chiphi.TongCongNo;

                    yc.SoTienBenhNhanDaChi = chiphi.SoTienQuyetToan;
                    yc.TrangThaiThanhToan = Enums.TrangThaiThanhToan.DaThanhToan;
                    thuPhi.TaiKhoanBenhNhanChis.Add(new TaiKhoanBenhNhanChi
                    {
                        TaiKhoanBenhNhan = tk,
                        LoaiChiTienBenhNhan = Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi,
                        TienChiPhi = yc.SoTienBenhNhanDaChi,
                        NoiDungChi = Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi.GetDescription(),
                        NgayChi = DateTime.Now,
                        SoPhieuHienThi = thuPhi.SoPhieuHienThi,
                        YeuCauDichVuGiuongBenhVienChiPhiBenhVien = yc,
                        Gia = yc.DonGiaSauChietKhau.GetValueOrDefault(),
                        SoLuong = yc.SoLuong,
                        DonGiaBaoHiem = chiPhiBHYT?.DonGiaBaoHiem,
                        MucHuongBaoHiem = (chiPhiBHYT != null && chiPhiBHYT.DuocHuongBaoHiem) ? chiPhiBHYT?.MucHuongBaoHiem : 0,
                        TiLeBaoHiemThanhToan = chiPhiBHYT?.TiLeBaoHiemThanhToan,
                        SoTienMienGiam = yc.SoTienMienGiam,
                        SoTienBaoHiemTuNhanChiTra = yc.SoTienBaoHiemTuNhanChiTra,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        NhanVienThucHienId = _userAgentHelper.GetCurrentUserId(),
                        NoiThucHienId = _userAgentHelper.GetCurrentNoiLLamViecId()
                    });
                }

                ycTiepNhan.TaiKhoanBenhNhanThus.Add(thuPhi);
            }

            var thuPhiNgoaiGoi = new TaiKhoanBenhNhanThu
            {
                TaiKhoanBenhNhan = tk,
                LoaiThuTienBenhNhan = Enums.LoaiThuTienBenhNhan.ThuTheoChiPhi,
                LoaiNoiThu = Enums.LoaiNoiThu.ThuNgan,
                TienMat = thuPhiKhamChuaBenhVo.TienMat,
                ChuyenKhoan = thuPhiKhamChuaBenhVo.ChuyenKhoan,
                POS = thuPhiKhamChuaBenhVo.POS,
                CongNo = thuPhiKhamChuaBenhVo.SoTienCongNo,
                NoiDungThu = thuPhiKhamChuaBenhVo.NoiDungThu,
                NgayThu = thuPhiKhamChuaBenhVo.NgayThu,
                SoPhieuHienThi = ResourceHelper.CreateSoPhieuThu(userId, maTaiKhoan),
                NhanVienThucHienId = userId,
                NoiThucHienId = _userAgentHelper.GetCurrentNoiLLamViecId()
            };

            foreach (var chiphi in dsChiPhiDaChon.Where(o => o.LoaiNhom == NhomChiPhiNoiTru.DichVuKhamBenh))
            {
                var yc = chiphi.DichVuNgoaiTru ? yeuCauTiepNhanNgoaiTruCanQuyetToan.YeuCauKhamBenhs.First(o => o.Id == chiphi.Id) : ycTiepNhan.YeuCauKhamBenhs.First(o => o.Id == chiphi.Id);
                #region cong no update 02/02/2021
                foreach (var ycCongTyBaoHiemTuNhanCongNo in yc.CongTyBaoHiemTuNhanCongNos.Where(o => o.TaiKhoanBenhNhanThuId == null))
                {
                    ycCongTyBaoHiemTuNhanCongNo.WillDelete = true;
                }
                if (chiphi.TongCongNo > 0)
                {
                    foreach (var chiphiDanhSachCongNoChoThu in chiphi.DanhSachCongNoChoThus)
                    {
                        if (chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu.AlmostEqual(0))
                            continue;
                        yc.CongTyBaoHiemTuNhanCongNos.Add(new CongTyBaoHiemTuNhanCongNo
                        {
                            TaiKhoanBenhNhanThu = thuPhiNgoaiGoi,
                            CongTyBaoHiemTuNhanId = chiphiDanhSachCongNoChoThu.CongTyBaoHiemTuNhanId,
                            SoTien = chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu
                        });
                    }
                }
                yc.SoTienBaoHiemTuNhanChiTra = chiphi.TongCongNo;
                #endregion
                #region mien giam update 02/02/2021
                foreach (var mienGiam in yc.MienGiamChiPhis.Where(o => o.TaiKhoanBenhNhanThuId == null))
                {
                    mienGiam.WillDelete = true;
                }
                //mien giam theo uu dai noi gioi thieu: BVHD-3882
                var mienGiamNoiGioiThieu = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.NoiGioiThieuId != null);
                if (mienGiamNoiGioiThieu != null)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhiNgoaiGoi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                        NoiGioiThieuId = mienGiamNoiGioiThieu.NoiGioiThieuId,
                        LoaiChietKhau = mienGiamNoiGioiThieu.LoaiChietKhau,
                        TiLe = mienGiamNoiGioiThieu.TiLe,
                        SoTien = mienGiamNoiGioiThieu.SoTien
                    });
                }
                //mien giam theo uu dai
                var mienGiamUuDai = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.DoiTuongUuDaiId != null && o.TiLe != 0);
                if (mienGiamUuDai != null)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhiNgoaiGoi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                        DoiTuongUuDaiId = mienGiamUuDai.DoiTuongUuDaiId,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                        TiLe = mienGiamUuDai.TiLe.GetValueOrDefault(),
                        SoTien = mienGiamUuDai.SoTien
                    });
                }
                //mien giam theo voucher
                var mienGiamVouchers = chiphi.DanhSachMienGiamVos.Where(o => o.TheVoucherId != null).ToList();
                foreach (var voucher in mienGiamVouchers)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhiNgoaiGoi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.Voucher,
                        TheVoucherId = voucher.TheVoucherId,
                        LoaiChietKhau = voucher.LoaiChietKhau,
                        MaTheVoucher = voucher.MaTheVoucher,
                        TiLe = voucher.TiLe.GetValueOrDefault(),
                        SoTien = voucher.SoTien
                    });
                }
                //mien giam them theo ti le
                var mienGiamThemTiLe = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoTiLe);
                if (mienGiamThemTiLe != null && mienGiamThemTiLe.TiLe.GetValueOrDefault() != 0)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhiNgoaiGoi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                        TiLe = mienGiamThemTiLe.TiLe,
                        SoTien = mienGiamThemTiLe.SoTien
                    });
                }
                //mien giam them theo so tien
                var mienGiamThemSoTien = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoSoTien);
                if (mienGiamThemSoTien != null && !mienGiamThemSoTien.SoTien.AlmostEqual(0))
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhiNgoaiGoi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoSoTien,
                        SoTien = mienGiamThemSoTien.SoTien
                    });
                }

                yc.SoTienMienGiam = chiphi.SoTienMG;
                if ((mienGiamThemTiLe?.SoTien ?? 0).AlmostEqual(0) && (mienGiamThemSoTien?.SoTien ?? 0).AlmostEqual(0))
                {
                    yc.GhiChuMienGiamThem = null;
                    yc.NoiDungGhiChuMiemGiamId = null;
                }
                else
                {
                    yc.GhiChuMienGiamThem = chiphi.GhiChuMienGiamThem;
                    yc.NoiDungGhiChuMiemGiamId = chiphi.NoiDungGhiChuMiemGiamId;
                }
                #endregion
                yc.SoTienBenhNhanDaChi = yc.SoTienBenhNhanDaChi.GetValueOrDefault() + chiphi.BNConPhaiThanhToan;
                yc.TrangThaiThanhToan = Enums.TrangThaiThanhToan.DaThanhToan;
                thuPhiNgoaiGoi.TaiKhoanBenhNhanChis.Add(new TaiKhoanBenhNhanChi
                {
                    TaiKhoanBenhNhan = tk,
                    LoaiChiTienBenhNhan = Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi,
                    TienChiPhi = chiphi.BNConPhaiThanhToan,
                    NoiDungChi = Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi.GetDescription(),
                    NgayChi = DateTime.Now,
                    SoPhieuHienThi = thuPhiNgoaiGoi.SoPhieuHienThi,
                    YeuCauKhamBenh = yc,
                    Gia = yc.Gia,
                    SoLuong = 1,
                    DonGiaBaoHiem = yc.DonGiaBaoHiem,
                    MucHuongBaoHiem = yc.MucHuongBaoHiem,
                    TiLeBaoHiemThanhToan = yc.TiLeBaoHiemThanhToan,
                    SoTienMienGiam = yc.SoTienMienGiam,
                    SoTienBaoHiemTuNhanChiTra = yc.SoTienBaoHiemTuNhanChiTra,
                    YeuCauTiepNhanId = ycTiepNhan.Id,
                    NhanVienThucHienId = _userAgentHelper.GetCurrentUserId(),
                    NoiThucHienId = _userAgentHelper.GetCurrentNoiLLamViecId()
                });
            }

            foreach (var chiphi in dsChiPhiDaChon.Where(o => o.LoaiNhom == NhomChiPhiNoiTru.DichVuKyThuat))
            {
                var yc = chiphi.DichVuNgoaiTru ? yeuCauTiepNhanNgoaiTruCanQuyetToan.YeuCauDichVuKyThuats.First(o => o.Id == chiphi.Id) : ycTiepNhan.YeuCauDichVuKyThuats.First(o => o.Id == chiphi.Id);
                #region cong no update 02/02/2021
                foreach (var ycCongTyBaoHiemTuNhanCongNo in yc.CongTyBaoHiemTuNhanCongNos.Where(o => o.TaiKhoanBenhNhanThuId == null))
                {
                    ycCongTyBaoHiemTuNhanCongNo.WillDelete = true;
                }
                if (chiphi.TongCongNo > 0)
                {
                    foreach (var chiphiDanhSachCongNoChoThu in chiphi.DanhSachCongNoChoThus)
                    {
                        if (chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu.AlmostEqual(0))
                            continue;
                        yc.CongTyBaoHiemTuNhanCongNos.Add(new CongTyBaoHiemTuNhanCongNo
                        {
                            TaiKhoanBenhNhanThu = thuPhiNgoaiGoi,
                            CongTyBaoHiemTuNhanId = chiphiDanhSachCongNoChoThu.CongTyBaoHiemTuNhanId,
                            SoTien = chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu
                        });
                    }
                }
                yc.SoTienBaoHiemTuNhanChiTra = chiphi.TongCongNo;
                #endregion
                #region mien giam update 02/02/2021
                foreach (var mienGiam in yc.MienGiamChiPhis.Where(o => o.TaiKhoanBenhNhanThuId == null))
                {
                    mienGiam.WillDelete = true;
                }
                //mien giam theo uu dai noi gioi thieu: BVHD-3882
                var mienGiamNoiGioiThieu = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.NoiGioiThieuId != null);
                if (mienGiamNoiGioiThieu != null)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhiNgoaiGoi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                        NoiGioiThieuId = mienGiamNoiGioiThieu.NoiGioiThieuId,
                        LoaiChietKhau = mienGiamNoiGioiThieu.LoaiChietKhau,
                        TiLe = mienGiamNoiGioiThieu.TiLe,
                        SoTien = mienGiamNoiGioiThieu.SoTien
                    });
                }
                //mien giam theo uu dai
                var mienGiamUuDai = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.DoiTuongUuDaiId != null && o.TiLe != 0);
                if (mienGiamUuDai != null)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhiNgoaiGoi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                        DoiTuongUuDaiId = mienGiamUuDai.DoiTuongUuDaiId,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                        TiLe = mienGiamUuDai.TiLe.GetValueOrDefault(),
                        SoTien = mienGiamUuDai.SoTien
                    });
                }
                //mien giam theo voucher
                var mienGiamVouchers = chiphi.DanhSachMienGiamVos.Where(o => o.TheVoucherId != null).ToList();
                foreach (var voucher in mienGiamVouchers)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhiNgoaiGoi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.Voucher,
                        TheVoucherId = voucher.TheVoucherId,
                        LoaiChietKhau = voucher.LoaiChietKhau,
                        MaTheVoucher = voucher.MaTheVoucher,
                        TiLe = voucher.TiLe.GetValueOrDefault(),
                        SoTien = voucher.SoTien
                    });
                }
                //mien giam them theo ti le
                var mienGiamThemTiLe = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoTiLe);
                if (mienGiamThemTiLe != null && mienGiamThemTiLe.TiLe.GetValueOrDefault() != 0)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhiNgoaiGoi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                        TiLe = mienGiamThemTiLe.TiLe,
                        SoTien = mienGiamThemTiLe.SoTien
                    });
                }
                //mien giam them theo so tien
                var mienGiamThemSoTien = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoSoTien);
                if (mienGiamThemSoTien != null && !mienGiamThemSoTien.SoTien.AlmostEqual(0))
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhiNgoaiGoi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoSoTien,
                        SoTien = mienGiamThemSoTien.SoTien
                    });
                }

                yc.SoTienMienGiam = chiphi.SoTienMG;
                if ((mienGiamThemTiLe?.SoTien ?? 0).AlmostEqual(0) && (mienGiamThemSoTien?.SoTien ?? 0).AlmostEqual(0))
                {
                    yc.GhiChuMienGiamThem = null;
                    yc.NoiDungGhiChuMiemGiamId = null;
                }
                else
                {
                    yc.GhiChuMienGiamThem = chiphi.GhiChuMienGiamThem;
                    yc.NoiDungGhiChuMiemGiamId = chiphi.NoiDungGhiChuMiemGiamId;
                }
                #endregion
                yc.SoTienBenhNhanDaChi = yc.SoTienBenhNhanDaChi.GetValueOrDefault() + chiphi.BNConPhaiThanhToan;
                yc.TrangThaiThanhToan = Enums.TrangThaiThanhToan.DaThanhToan;
                thuPhiNgoaiGoi.TaiKhoanBenhNhanChis.Add(new TaiKhoanBenhNhanChi
                {
                    TaiKhoanBenhNhan = tk,
                    LoaiChiTienBenhNhan = Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi,
                    TienChiPhi = chiphi.BNConPhaiThanhToan,
                    NoiDungChi = Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi.GetDescription(),
                    NgayChi = DateTime.Now,
                    SoPhieuHienThi = thuPhiNgoaiGoi.SoPhieuHienThi,
                    YeuCauDichVuKyThuat = yc,
                    Gia = yc.Gia,
                    SoLuong = yc.SoLan,
                    DonGiaBaoHiem = yc.DonGiaBaoHiem,
                    MucHuongBaoHiem = yc.MucHuongBaoHiem,
                    TiLeBaoHiemThanhToan = yc.TiLeBaoHiemThanhToan,
                    SoTienMienGiam = yc.SoTienMienGiam,
                    SoTienBaoHiemTuNhanChiTra = yc.SoTienBaoHiemTuNhanChiTra,
                    YeuCauTiepNhanId = ycTiepNhan.Id,
                    NhanVienThucHienId = _userAgentHelper.GetCurrentUserId(),
                    NoiThucHienId = _userAgentHelper.GetCurrentNoiLLamViecId()
                });
            }

            foreach (var chiphi in dsChiPhiDaChon.Where(o => o.LoaiNhom == NhomChiPhiNoiTru.TruyenMau))
            {
                var yc = ycTiepNhan.YeuCauTruyenMaus.First(o => o.Id == chiphi.Id);
                #region cong no update 02/02/2021
                foreach (var ycCongTyBaoHiemTuNhanCongNo in yc.CongTyBaoHiemTuNhanCongNos.Where(o => o.TaiKhoanBenhNhanThuId == null))
                {
                    ycCongTyBaoHiemTuNhanCongNo.WillDelete = true;
                }
                if (chiphi.TongCongNo > 0)
                {
                    foreach (var chiphiDanhSachCongNoChoThu in chiphi.DanhSachCongNoChoThus)
                    {
                        if (chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu.AlmostEqual(0))
                            continue;
                        yc.CongTyBaoHiemTuNhanCongNos.Add(new CongTyBaoHiemTuNhanCongNo
                        {
                            TaiKhoanBenhNhanThu = thuPhiNgoaiGoi,
                            CongTyBaoHiemTuNhanId = chiphiDanhSachCongNoChoThu.CongTyBaoHiemTuNhanId,
                            SoTien = chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu
                        });
                    }
                }
                yc.SoTienBaoHiemTuNhanChiTra = chiphi.TongCongNo;
                #endregion
                #region mien giam
                //mien giam theo uu dai
                var uuDai = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.DoiTuongUuDaiId != null && o.TiLe != 0);
                var mienGiamChiPhiTruoc = ycTiepNhan.MienGiamChiPhis.Where(o => o.YeuCauDichVuKyThuatId == yc.Id).ToList();
                var mienGiamTheoUuDaiGroups = mienGiamChiPhiTruoc.Where(o => o.DoiTuongUuDaiId != null).GroupBy(o => o.DoiTuongUuDaiId.Value);
                bool daMienGiamUuDai = false;
                foreach (var mienGiamTheoUuDaiGroup in mienGiamTheoUuDaiGroups)
                {
                    if (mienGiamTheoUuDaiGroup.Key != uuDai?.DoiTuongUuDaiId)
                    {
                        yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                        {
                            TaiKhoanBenhNhanThu = thuPhiNgoaiGoi,
                            YeuCauTiepNhanId = ycTiepNhan.Id,
                            LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                            DoiTuongUuDaiId = mienGiamTheoUuDaiGroup.Key,
                            LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                            TiLe = 0 - mienGiamTheoUuDaiGroup.Sum(o => o.TiLe.GetValueOrDefault()),
                            SoTien = 0 - mienGiamTheoUuDaiGroup.Sum(o => o.SoTien)
                        });
                    }
                    else
                    {
                        daMienGiamUuDai = true;
                        if (uuDai.TiLe.GetValueOrDefault() != mienGiamTheoUuDaiGroup.Sum(o => o.TiLe.GetValueOrDefault()) || !uuDai.SoTien.AlmostEqual(mienGiamTheoUuDaiGroup.Sum(o => o.SoTien)))
                        {
                            yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                            {
                                TaiKhoanBenhNhanThu = thuPhiNgoaiGoi,
                                YeuCauTiepNhanId = ycTiepNhan.Id,
                                LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                                DoiTuongUuDaiId = mienGiamTheoUuDaiGroup.Key,
                                LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                                TiLe = uuDai.TiLe.GetValueOrDefault() - mienGiamTheoUuDaiGroup.Sum(o => o.TiLe.GetValueOrDefault()),
                                SoTien = uuDai.SoTien - mienGiamTheoUuDaiGroup.Sum(o => o.SoTien)
                            });
                        }
                    }
                }
                if (!daMienGiamUuDai && uuDai != null)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhiNgoaiGoi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                        DoiTuongUuDaiId = uuDai.DoiTuongUuDaiId,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                        TiLe = uuDai.TiLe.GetValueOrDefault(),
                        SoTien = uuDai.SoTien
                    });
                }

                //mien giam theo voucher
                var vouchers = chiphi.DanhSachMienGiamVos.Where(o => o.TheVoucherId != null).ToList();
                var mienGiamTheoVoucherGroups = mienGiamChiPhiTruoc.Where(o => o.TheVoucherId != null).GroupBy(o => o.TheVoucherId.Value).ToList();

                foreach (var mienGiamTheoVoucherGroup in mienGiamTheoVoucherGroups)
                {
                    if (!vouchers.Select(o => o.TheVoucherId).Contains(mienGiamTheoVoucherGroup.Key))
                    {
                        yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                        {
                            TaiKhoanBenhNhanThu = thuPhiNgoaiGoi,
                            YeuCauTiepNhanId = ycTiepNhan.Id,
                            LoaiMienGiam = Enums.LoaiMienGiam.Voucher,
                            TheVoucherId = mienGiamTheoVoucherGroup.Key,
                            LoaiChietKhau = mienGiamTheoVoucherGroup.First().LoaiChietKhau,
                            MaTheVoucher = mienGiamTheoVoucherGroup.First().MaTheVoucher,
                            TiLe = 0 - mienGiamTheoVoucherGroup.Sum(o => o.TiLe.GetValueOrDefault()),
                            SoTien = 0 - mienGiamTheoVoucherGroup.Sum(o => o.SoTien)
                        });
                    }
                }

                foreach (var voucher in vouchers)
                {
                    var mienGiamTheoVoucherGroup = mienGiamTheoVoucherGroups.FirstOrDefault(o => o.Key == voucher.TheVoucherId);
                    if (mienGiamTheoVoucherGroup != null)
                    {
                        if (voucher.TiLe.GetValueOrDefault() != mienGiamTheoVoucherGroup.Sum(o => o.TiLe.GetValueOrDefault()) || !voucher.SoTien.AlmostEqual(mienGiamTheoVoucherGroup.Sum(o => o.SoTien)))
                        {
                            yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                            {
                                TaiKhoanBenhNhanThu = thuPhiNgoaiGoi,
                                YeuCauTiepNhanId = ycTiepNhan.Id,
                                LoaiMienGiam = Enums.LoaiMienGiam.Voucher,
                                TheVoucherId = voucher.TheVoucherId,
                                LoaiChietKhau = voucher.LoaiChietKhau,
                                MaTheVoucher = voucher.MaTheVoucher,
                                TiLe = voucher.TiLe.GetValueOrDefault() - mienGiamTheoVoucherGroup.Sum(o => o.TiLe.GetValueOrDefault()),
                                SoTien = voucher.SoTien - mienGiamTheoVoucherGroup.Sum(o => o.SoTien)
                            });
                        }
                    }
                    else
                    {
                        yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                        {
                            TaiKhoanBenhNhanThu = thuPhiNgoaiGoi,
                            YeuCauTiepNhanId = ycTiepNhan.Id,
                            LoaiMienGiam = Enums.LoaiMienGiam.Voucher,
                            TheVoucherId = voucher.TheVoucherId,
                            LoaiChietKhau = voucher.LoaiChietKhau,
                            MaTheVoucher = voucher.MaTheVoucher,
                            TiLe = voucher.TiLe.GetValueOrDefault(),
                            SoTien = voucher.SoTien
                        });
                    }
                }

                //mien giam them theo ti le
                var mienGiamThemTiLeTruoc = mienGiamChiPhiTruoc.Where(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoTiLe).ToList();
                var mienGiamThemTiLe = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoTiLe);
                if (mienGiamThemTiLeTruoc.Any())
                {
                    if (mienGiamThemTiLe == null ||
                        (mienGiamThemTiLe.TiLe.GetValueOrDefault() != mienGiamThemTiLeTruoc.Sum(o => o.TiLe.GetValueOrDefault()) || !mienGiamThemTiLe.SoTien.AlmostEqual(mienGiamThemTiLeTruoc.Sum(o => o.SoTien))))
                    {
                        yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                        {
                            TaiKhoanBenhNhanThu = thuPhiNgoaiGoi,
                            YeuCauTiepNhanId = ycTiepNhan.Id,
                            LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                            LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                            TiLe = (mienGiamThemTiLe?.TiLe ?? 0) - mienGiamThemTiLeTruoc.Sum(o => o.TiLe.GetValueOrDefault()),
                            SoTien = (mienGiamThemTiLe?.SoTien ?? 0) - mienGiamThemTiLeTruoc.Sum(o => o.SoTien)
                        });
                    }
                }
                else if (mienGiamThemTiLe != null && mienGiamThemTiLe.TiLe.GetValueOrDefault() != 0)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhiNgoaiGoi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                        TiLe = mienGiamThemTiLe.TiLe,
                        SoTien = mienGiamThemTiLe.SoTien
                    });
                }

                //mien giam them theo so tien
                var mienGiamThemSoTienTruoc = mienGiamChiPhiTruoc.Where(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoSoTien).ToList();
                var mienGiamThemSoTien = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoSoTien);
                if (mienGiamThemSoTienTruoc.Any())
                {
                    if (mienGiamThemSoTien == null || !mienGiamThemSoTien.SoTien.AlmostEqual(mienGiamThemSoTienTruoc.Sum(o => o.SoTien)))
                    {
                        yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                        {
                            TaiKhoanBenhNhanThu = thuPhiNgoaiGoi,
                            YeuCauTiepNhanId = ycTiepNhan.Id,
                            LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                            LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoSoTien,
                            SoTien = (mienGiamThemSoTien?.SoTien ?? 0) - mienGiamThemSoTienTruoc.Sum(o => o.SoTien)
                        });
                    }
                }
                else if (mienGiamThemSoTien != null && !mienGiamThemSoTien.SoTien.AlmostEqual(0))
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhiNgoaiGoi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoSoTien,
                        SoTien = mienGiamThemSoTien.SoTien
                    });
                }
                yc.SoTienMienGiam = chiphi.SoTienMG;

                if ((mienGiamThemTiLe?.SoTien ?? 0).AlmostEqual(0) && (mienGiamThemSoTien?.SoTien ?? 0).AlmostEqual(0))
                {
                    yc.GhiChuMienGiamThem = null;
                    yc.NoiDungGhiChuMiemGiamId = null;
                }
                else
                {
                    yc.GhiChuMienGiamThem = chiphi.GhiChuMienGiamThem;
                    yc.NoiDungGhiChuMiemGiamId = chiphi.NoiDungGhiChuMiemGiamId;
                }
                #endregion
                yc.SoTienBenhNhanDaChi = yc.SoTienBenhNhanDaChi.GetValueOrDefault() + chiphi.BNConPhaiThanhToan;
                yc.TrangThaiThanhToan = Enums.TrangThaiThanhToan.DaThanhToan;
                thuPhiNgoaiGoi.TaiKhoanBenhNhanChis.Add(new TaiKhoanBenhNhanChi
                {
                    TaiKhoanBenhNhan = tk,
                    LoaiChiTienBenhNhan = Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi,
                    TienChiPhi = chiphi.BNConPhaiThanhToan,
                    NoiDungChi = Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi.GetDescription(),
                    NgayChi = DateTime.Now,
                    SoPhieuHienThi = thuPhiNgoaiGoi.SoPhieuHienThi,
                    YeuCauTruyenMau = yc,
                    Gia = yc.DonGiaBan,
                    SoLuong = 1,
                    DonGiaBaoHiem = yc.DonGiaBaoHiem,
                    MucHuongBaoHiem = yc.MucHuongBaoHiem,
                    TiLeBaoHiemThanhToan = yc.TiLeBaoHiemThanhToan,
                    SoTienMienGiam = yc.SoTienMienGiam,
                    SoTienBaoHiemTuNhanChiTra = yc.SoTienBaoHiemTuNhanChiTra,
                    YeuCauTiepNhanId = ycTiepNhan.Id,
                    NhanVienThucHienId = _userAgentHelper.GetCurrentUserId(),
                    NoiThucHienId = _userAgentHelper.GetCurrentNoiLLamViecId()
                });
            }

            foreach (var chiphi in dsChiPhiDaChon.Where(o => o.LoaiNhom == NhomChiPhiNoiTru.DichVuGiuong))
            {
                var chiPhiGiuongChuaThu = dsChiPhi.First(o => o.Id == chiphi.Id && o.LoaiNhom == NhomChiPhiNoiTru.DichVuGiuong);

                var hoatDongGiuongs = ycTiepNhan.HoatDongGiuongBenhs.Where(c => c.ThoiDiemKetThuc == null);
                var yc = ycTiepNhan.YeuCauDichVuGiuongBenhVienChiPhiBenhViens.First(o => o.Id == chiphi.Id);

                #region cong no update 02/02/2021
                foreach (var ycCongTyBaoHiemTuNhanCongNo in yc.CongTyBaoHiemTuNhanCongNos.Where(o => o.TaiKhoanBenhNhanThuId == null))
                {
                    ycCongTyBaoHiemTuNhanCongNo.WillDelete = true;
                }
                if (chiphi.TongCongNo > 0)
                {
                    foreach (var chiphiDanhSachCongNoChoThu in chiphi.DanhSachCongNoChoThus)
                    {
                        if (chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu.AlmostEqual(0))
                            continue;
                        yc.CongTyBaoHiemTuNhanCongNos.Add(new CongTyBaoHiemTuNhanCongNo
                        {
                            TaiKhoanBenhNhanThu = thuPhiNgoaiGoi,
                            CongTyBaoHiemTuNhanId = chiphiDanhSachCongNoChoThu.CongTyBaoHiemTuNhanId,
                            SoTien = chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu
                        });
                    }
                }

                yc.SoTienBaoHiemTuNhanChiTra = chiphi.TongCongNo;

                if (hoatDongGiuongs.Any())
                {
                    foreach (var hoatDongGiuong in hoatDongGiuongs)
                    {
                        hoatDongGiuong.ThoiDiemKetThuc = ycTiepNhan.NoiTruBenhAn.ThoiDiemRaVien;
                    }
                }


                #endregion

                #region mien giam update 02/02/2021
                foreach (var mienGiam in yc.MienGiamChiPhis.Where(o => o.TaiKhoanBenhNhanThuId == null))
                {
                    mienGiam.WillDelete = true;
                }
                //mien giam theo uu dai noi gioi thieu: BVHD-3882
                var mienGiamNoiGioiThieu = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.NoiGioiThieuId != null);
                if (mienGiamNoiGioiThieu != null)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhiNgoaiGoi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                        NoiGioiThieuId = mienGiamNoiGioiThieu.NoiGioiThieuId,
                        LoaiChietKhau = mienGiamNoiGioiThieu.LoaiChietKhau,
                        TiLe = mienGiamNoiGioiThieu.TiLe,
                        SoTien = mienGiamNoiGioiThieu.SoTien
                    });
                }
                //mien giam theo uu dai
                var mienGiamUuDai = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.DoiTuongUuDaiId != null && o.TiLe != 0);
                if (mienGiamUuDai != null)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhiNgoaiGoi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                        DoiTuongUuDaiId = mienGiamUuDai.DoiTuongUuDaiId,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                        TiLe = mienGiamUuDai.TiLe.GetValueOrDefault(),
                        SoTien = mienGiamUuDai.SoTien
                    });
                }
                //mien giam theo voucher
                var mienGiamVouchers = chiphi.DanhSachMienGiamVos.Where(o => o.TheVoucherId != null).ToList();
                foreach (var voucher in mienGiamVouchers)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhiNgoaiGoi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.Voucher,
                        TheVoucherId = voucher.TheVoucherId,
                        LoaiChietKhau = voucher.LoaiChietKhau,
                        MaTheVoucher = voucher.MaTheVoucher,
                        TiLe = voucher.TiLe.GetValueOrDefault(),
                        SoTien = voucher.SoTien
                    });
                }
                //mien giam them theo ti le
                var mienGiamThemTiLe = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoTiLe);
                if (mienGiamThemTiLe != null && mienGiamThemTiLe.TiLe.GetValueOrDefault() != 0)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhiNgoaiGoi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                        TiLe = mienGiamThemTiLe.TiLe,
                        SoTien = mienGiamThemTiLe.SoTien
                    });
                }
                //mien giam them theo so tien
                var mienGiamThemSoTien = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoSoTien);
                if (mienGiamThemSoTien != null && !mienGiamThemSoTien.SoTien.AlmostEqual(0))
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhiNgoaiGoi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoSoTien,
                        SoTien = mienGiamThemSoTien.SoTien
                    });
                }

                yc.SoTienMienGiam = chiphi.SoTienMG;
                if ((mienGiamThemTiLe?.SoTien ?? 0).AlmostEqual(0) && (mienGiamThemSoTien?.SoTien ?? 0).AlmostEqual(0))
                {
                    yc.GhiChuMienGiamThem = null;
                    yc.NoiDungGhiChuMiemGiamId = null;
                }
                else
                {
                    yc.GhiChuMienGiamThem = chiphi.GhiChuMienGiamThem;
                    yc.NoiDungGhiChuMiemGiamId = chiphi.NoiDungGhiChuMiemGiamId;
                }
                #endregion
                yc.SoTienBenhNhanDaChi = yc.SoTienBenhNhanDaChi.GetValueOrDefault() + chiphi.BNConPhaiThanhToan;
                yc.TrangThaiThanhToan = Enums.TrangThaiThanhToan.DaThanhToan;
                thuPhiNgoaiGoi.TaiKhoanBenhNhanChis.Add(new TaiKhoanBenhNhanChi
                {
                    TaiKhoanBenhNhan = tk,
                    LoaiChiTienBenhNhan = Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi,
                    TienChiPhi = chiphi.BNConPhaiThanhToan,
                    NoiDungChi = Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi.GetDescription(),
                    NgayChi = DateTime.Now,
                    SoPhieuHienThi = thuPhiNgoaiGoi.SoPhieuHienThi,
                    YeuCauDichVuGiuongBenhVienChiPhiBenhVien = yc,
                    Gia = yc.Gia,
                    SoLuong = yc.SoLuong,
                    DonGiaBaoHiem = chiPhiGiuongChuaThu.DonGiaBHYT,
                    MucHuongBaoHiem = chiPhiGiuongChuaThu.MucHuongBaoHiem,
                    TiLeBaoHiemThanhToan = chiPhiGiuongChuaThu.TiLeBaoHiemThanhToan,
                    SoTienMienGiam = yc.SoTienMienGiam,
                    SoTienBaoHiemTuNhanChiTra = yc.SoTienBaoHiemTuNhanChiTra,
                    YeuCauTiepNhanId = ycTiepNhan.Id,
                    NhanVienThucHienId = _userAgentHelper.GetCurrentUserId(),
                    NoiThucHienId = _userAgentHelper.GetCurrentNoiLLamViecId()
                });
            }

            foreach (var chiphi in dsChiPhiDaChon.Where(o => o.LoaiNhom == NhomChiPhiNoiTru.DuocPham))
            {
                var yc = chiphi.DichVuNgoaiTru ? yeuCauTiepNhanNgoaiTruCanQuyetToan.YeuCauDuocPhamBenhViens.First(o => o.Id == chiphi.Id) : ycTiepNhan.YeuCauDuocPhamBenhViens.First(o => o.Id == chiphi.Id);
                #region cong no update 02/02/2021
                foreach (var ycCongTyBaoHiemTuNhanCongNo in yc.CongTyBaoHiemTuNhanCongNos.Where(o => o.TaiKhoanBenhNhanThuId == null))
                {
                    ycCongTyBaoHiemTuNhanCongNo.WillDelete = true;
                }
                if (chiphi.TongCongNo > 0)
                {
                    foreach (var chiphiDanhSachCongNoChoThu in chiphi.DanhSachCongNoChoThus)
                    {
                        if (chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu.AlmostEqual(0))
                            continue;
                        yc.CongTyBaoHiemTuNhanCongNos.Add(new CongTyBaoHiemTuNhanCongNo
                        {
                            TaiKhoanBenhNhanThu = thuPhiNgoaiGoi,
                            CongTyBaoHiemTuNhanId = chiphiDanhSachCongNoChoThu.CongTyBaoHiemTuNhanId,
                            SoTien = chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu
                        });
                    }
                }
                yc.SoTienBaoHiemTuNhanChiTra = chiphi.TongCongNo;
                #endregion
                #region mien giam update 02/02/2021
                foreach (var mienGiam in yc.MienGiamChiPhis.Where(o => o.TaiKhoanBenhNhanThuId == null))
                {
                    mienGiam.WillDelete = true;
                }
                //mien giam theo uu dai noi gioi thieu: BVHD-3882
                var mienGiamNoiGioiThieu = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.NoiGioiThieuId != null);
                if (mienGiamNoiGioiThieu != null)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhiNgoaiGoi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                        NoiGioiThieuId = mienGiamNoiGioiThieu.NoiGioiThieuId,
                        LoaiChietKhau = mienGiamNoiGioiThieu.LoaiChietKhau,
                        TiLe = mienGiamNoiGioiThieu.TiLe,
                        SoTien = mienGiamNoiGioiThieu.SoTien
                    });
                }
                //mien giam theo uu dai
                var mienGiamUuDai = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.DoiTuongUuDaiId != null && o.TiLe != 0);
                if (mienGiamUuDai != null)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhiNgoaiGoi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                        DoiTuongUuDaiId = mienGiamUuDai.DoiTuongUuDaiId,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                        TiLe = mienGiamUuDai.TiLe.GetValueOrDefault(),
                        SoTien = mienGiamUuDai.SoTien
                    });
                }
                //mien giam theo voucher
                var mienGiamVouchers = chiphi.DanhSachMienGiamVos.Where(o => o.TheVoucherId != null).ToList();
                foreach (var voucher in mienGiamVouchers)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhiNgoaiGoi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.Voucher,
                        TheVoucherId = voucher.TheVoucherId,
                        LoaiChietKhau = voucher.LoaiChietKhau,
                        MaTheVoucher = voucher.MaTheVoucher,
                        TiLe = voucher.TiLe.GetValueOrDefault(),
                        SoTien = voucher.SoTien
                    });
                }
                //mien giam them theo ti le
                var mienGiamThemTiLe = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoTiLe);
                if (mienGiamThemTiLe != null && mienGiamThemTiLe.TiLe.GetValueOrDefault() != 0)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhiNgoaiGoi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                        TiLe = mienGiamThemTiLe.TiLe,
                        SoTien = mienGiamThemTiLe.SoTien
                    });
                }
                //mien giam them theo so tien
                var mienGiamThemSoTien = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoSoTien);
                if (mienGiamThemSoTien != null && !mienGiamThemSoTien.SoTien.AlmostEqual(0))
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhiNgoaiGoi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoSoTien,
                        SoTien = mienGiamThemSoTien.SoTien
                    });
                }

                yc.SoTienMienGiam = chiphi.SoTienMG;
                if ((mienGiamThemTiLe?.SoTien ?? 0).AlmostEqual(0) && (mienGiamThemSoTien?.SoTien ?? 0).AlmostEqual(0))
                {
                    yc.GhiChuMienGiamThem = null;
                    yc.NoiDungGhiChuMiemGiamId = null;
                }
                else
                {
                    yc.GhiChuMienGiamThem = chiphi.GhiChuMienGiamThem;
                    yc.NoiDungGhiChuMiemGiamId = chiphi.NoiDungGhiChuMiemGiamId;
                }
                #endregion
                yc.SoTienBenhNhanDaChi = yc.SoTienBenhNhanDaChi.GetValueOrDefault() + chiphi.BNConPhaiThanhToan;
                yc.TrangThaiThanhToan = Enums.TrangThaiThanhToan.DaThanhToan;
                thuPhiNgoaiGoi.TaiKhoanBenhNhanChis.Add(new TaiKhoanBenhNhanChi
                {
                    TaiKhoanBenhNhan = tk,
                    LoaiChiTienBenhNhan = Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi,
                    TienChiPhi = chiphi.BNConPhaiThanhToan,
                    NoiDungChi = Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi.GetDescription(),
                    NgayChi = DateTime.Now,
                    SoPhieuHienThi = thuPhiNgoaiGoi.SoPhieuHienThi,
                    YeuCauDuocPhamBenhVien = yc,
                    Gia = yc.DonGiaBan,
                    SoLuong = yc.SoLuong,
                    DonGiaBaoHiem = yc.DonGiaBaoHiem,
                    MucHuongBaoHiem = yc.MucHuongBaoHiem,
                    TiLeBaoHiemThanhToan = yc.TiLeBaoHiemThanhToan,
                    SoTienMienGiam = yc.SoTienMienGiam,
                    SoTienBaoHiemTuNhanChiTra = yc.SoTienBaoHiemTuNhanChiTra,
                    YeuCauTiepNhanId = ycTiepNhan.Id,
                    NhanVienThucHienId = _userAgentHelper.GetCurrentUserId(),
                    NoiThucHienId = _userAgentHelper.GetCurrentNoiLLamViecId()
                });
            }

            foreach (var chiphi in dsChiPhiDaChon.Where(o => o.LoaiNhom == NhomChiPhiNoiTru.VatTuTieuHao))
            {
                var yc = chiphi.DichVuNgoaiTru ? yeuCauTiepNhanNgoaiTruCanQuyetToan.YeuCauVatTuBenhViens.First(o => o.Id == chiphi.Id) : ycTiepNhan.YeuCauVatTuBenhViens.First(o => o.Id == chiphi.Id);
                #region cong no update 02/02/2021
                foreach (var ycCongTyBaoHiemTuNhanCongNo in yc.CongTyBaoHiemTuNhanCongNos.Where(o => o.TaiKhoanBenhNhanThuId == null))
                {
                    ycCongTyBaoHiemTuNhanCongNo.WillDelete = true;
                }
                if (chiphi.TongCongNo > 0)
                {
                    foreach (var chiphiDanhSachCongNoChoThu in chiphi.DanhSachCongNoChoThus)
                    {
                        if (chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu.AlmostEqual(0))
                            continue;
                        yc.CongTyBaoHiemTuNhanCongNos.Add(new CongTyBaoHiemTuNhanCongNo
                        {
                            TaiKhoanBenhNhanThu = thuPhiNgoaiGoi,
                            CongTyBaoHiemTuNhanId = chiphiDanhSachCongNoChoThu.CongTyBaoHiemTuNhanId,
                            SoTien = chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu
                        });
                    }
                }
                yc.SoTienBaoHiemTuNhanChiTra = chiphi.TongCongNo;
                #endregion
                #region mien giam update 02/02/2021
                foreach (var mienGiam in yc.MienGiamChiPhis.Where(o => o.TaiKhoanBenhNhanThuId == null))
                {
                    mienGiam.WillDelete = true;
                }
                //mien giam theo uu dai noi gioi thieu: BVHD-3882
                var mienGiamNoiGioiThieu = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.NoiGioiThieuId != null);
                if (mienGiamNoiGioiThieu != null)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhiNgoaiGoi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                        NoiGioiThieuId = mienGiamNoiGioiThieu.NoiGioiThieuId,
                        LoaiChietKhau = mienGiamNoiGioiThieu.LoaiChietKhau,
                        TiLe = mienGiamNoiGioiThieu.TiLe,
                        SoTien = mienGiamNoiGioiThieu.SoTien
                    });
                }
                //mien giam theo uu dai
                var mienGiamUuDai = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.DoiTuongUuDaiId != null && o.TiLe != 0);
                if (mienGiamUuDai != null)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhiNgoaiGoi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                        DoiTuongUuDaiId = mienGiamUuDai.DoiTuongUuDaiId,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                        TiLe = mienGiamUuDai.TiLe.GetValueOrDefault(),
                        SoTien = mienGiamUuDai.SoTien
                    });
                }
                //mien giam theo voucher
                var mienGiamVouchers = chiphi.DanhSachMienGiamVos.Where(o => o.TheVoucherId != null).ToList();
                foreach (var voucher in mienGiamVouchers)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhiNgoaiGoi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.Voucher,
                        TheVoucherId = voucher.TheVoucherId,
                        LoaiChietKhau = voucher.LoaiChietKhau,
                        MaTheVoucher = voucher.MaTheVoucher,
                        TiLe = voucher.TiLe.GetValueOrDefault(),
                        SoTien = voucher.SoTien
                    });
                }
                //mien giam them theo ti le
                var mienGiamThemTiLe = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoTiLe);
                if (mienGiamThemTiLe != null && mienGiamThemTiLe.TiLe.GetValueOrDefault() != 0)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhiNgoaiGoi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                        TiLe = mienGiamThemTiLe.TiLe,
                        SoTien = mienGiamThemTiLe.SoTien
                    });
                }
                //mien giam them theo so tien
                var mienGiamThemSoTien = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoSoTien);
                if (mienGiamThemSoTien != null && !mienGiamThemSoTien.SoTien.AlmostEqual(0))
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhiNgoaiGoi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoSoTien,
                        SoTien = mienGiamThemSoTien.SoTien
                    });
                }

                yc.SoTienMienGiam = chiphi.SoTienMG;
                if ((mienGiamThemTiLe?.SoTien ?? 0).AlmostEqual(0) && (mienGiamThemSoTien?.SoTien ?? 0).AlmostEqual(0))
                {
                    yc.GhiChuMienGiamThem = null;
                    yc.NoiDungGhiChuMiemGiamId = null;
                }
                else
                {
                    yc.GhiChuMienGiamThem = chiphi.GhiChuMienGiamThem;
                    yc.NoiDungGhiChuMiemGiamId = chiphi.NoiDungGhiChuMiemGiamId;
                }
                #endregion
                yc.SoTienBenhNhanDaChi = yc.SoTienBenhNhanDaChi.GetValueOrDefault() + chiphi.BNConPhaiThanhToan;
                yc.TrangThaiThanhToan = Enums.TrangThaiThanhToan.DaThanhToan;
                thuPhiNgoaiGoi.TaiKhoanBenhNhanChis.Add(new TaiKhoanBenhNhanChi
                {
                    TaiKhoanBenhNhan = tk,
                    LoaiChiTienBenhNhan = Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi,
                    TienChiPhi = chiphi.BNConPhaiThanhToan,
                    NoiDungChi = Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi.GetDescription(),
                    NgayChi = DateTime.Now,
                    SoPhieuHienThi = thuPhiNgoaiGoi.SoPhieuHienThi,
                    YeuCauVatTuBenhVien = yc,
                    Gia = yc.DonGiaBan,
                    SoLuong = yc.SoLuong,
                    DonGiaBaoHiem = yc.DonGiaBaoHiem,
                    MucHuongBaoHiem = yc.MucHuongBaoHiem,
                    TiLeBaoHiemThanhToan = yc.TiLeBaoHiemThanhToan,
                    SoTienMienGiam = yc.SoTienMienGiam,
                    SoTienBaoHiemTuNhanChiTra = yc.SoTienBaoHiemTuNhanChiTra,
                    YeuCauTiepNhanId = ycTiepNhan.Id,
                    NhanVienThucHienId = _userAgentHelper.GetCurrentUserId(),
                    NoiThucHienId = _userAgentHelper.GetCurrentNoiLLamViecId()
                });
            }

            //foreach (var chiphi in dsChiPhiDaChon.Where(o => o.LoaiNhom == NhomChiPhiNoiTru.GoiDichVu))
            //{
            //    var yc = ycTiepNhan.BenhNhan.YeuCauGoiDichVus.First(o => o.Id == chiphi.Id);
            //    #region cong no update 02/02/2021
            //    foreach (var ycCongTyBaoHiemTuNhanCongNo in yc.CongTyBaoHiemTuNhanCongNos.Where(o => o.TaiKhoanBenhNhanThuId == null))
            //    {
            //        ycCongTyBaoHiemTuNhanCongNo.WillDelete = true;
            //    }
            //    if (chiphi.TongCongNo > 0)
            //    {
            //        foreach (var chiphiDanhSachCongNoChoThu in chiphi.DanhSachCongNoChoThus)
            //        {
            //            if (chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu.AlmostEqual(0))
            //                continue;
            //            yc.CongTyBaoHiemTuNhanCongNos.Add(new CongTyBaoHiemTuNhanCongNo
            //            {
            //                TaiKhoanBenhNhanThu = thuPhiNgoaiGoi,
            //                CongTyBaoHiemTuNhanId = chiphiDanhSachCongNoChoThu.CongTyBaoHiemTuNhanId,
            //                SoTien = chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu
            //            });
            //        }
            //    }
            //    yc.SoTienBaoHiemTuNhanChiTra = chiphi.TongCongNo;
            //    #endregion
            //    #region mien giam update 02/02/2021
            //    foreach (var mienGiam in yc.MienGiamChiPhis.Where(o => o.TaiKhoanBenhNhanThuId == null))
            //    {
            //        mienGiam.WillDelete = true;
            //    }
            //    //mien giam theo uu dai
            //    var mienGiamUuDai = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.DoiTuongUuDaiId != null && o.TiLe != 0);
            //    if (mienGiamUuDai != null)
            //    {
            //        yc.MienGiamChiPhis.Add(new MienGiamChiPhi
            //        {
            //            TaiKhoanBenhNhanThu = thuPhiNgoaiGoi,
            //            YeuCauTiepNhanId = ycTiepNhan.Id,
            //            LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
            //            DoiTuongUuDaiId = mienGiamUuDai.DoiTuongUuDaiId,
            //            LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
            //            TiLe = mienGiamUuDai.TiLe.GetValueOrDefault(),
            //            SoTien = mienGiamUuDai.SoTien
            //        });
            //    }
            //    //mien giam theo voucher
            //    var mienGiamVouchers = chiphi.DanhSachMienGiamVos.Where(o => o.TheVoucherId != null).ToList();
            //    foreach (var voucher in mienGiamVouchers)
            //    {
            //        yc.MienGiamChiPhis.Add(new MienGiamChiPhi
            //        {
            //            TaiKhoanBenhNhanThu = thuPhiNgoaiGoi,
            //            YeuCauTiepNhanId = ycTiepNhan.Id,
            //            LoaiMienGiam = Enums.LoaiMienGiam.Voucher,
            //            TheVoucherId = voucher.TheVoucherId,
            //            LoaiChietKhau = voucher.LoaiChietKhau,
            //            MaTheVoucher = voucher.MaTheVoucher,
            //            TiLe = voucher.TiLe.GetValueOrDefault(),
            //            SoTien = voucher.SoTien
            //        });
            //    }
            //    //mien giam them theo ti le
            //    var mienGiamThemTiLe = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoTiLe);
            //    if (mienGiamThemTiLe != null && mienGiamThemTiLe.TiLe.GetValueOrDefault() != 0)
            //    {
            //        yc.MienGiamChiPhis.Add(new MienGiamChiPhi
            //        {
            //            TaiKhoanBenhNhanThu = thuPhiNgoaiGoi,
            //            YeuCauTiepNhanId = ycTiepNhan.Id,
            //            LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
            //            LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
            //            TiLe = mienGiamThemTiLe.TiLe,
            //            SoTien = mienGiamThemTiLe.SoTien
            //        });
            //    }
            //    //mien giam them theo so tien
            //    var mienGiamThemSoTien = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoSoTien);
            //    if (mienGiamThemSoTien != null && !mienGiamThemSoTien.SoTien.AlmostEqual(0))
            //    {
            //        yc.MienGiamChiPhis.Add(new MienGiamChiPhi
            //        {
            //            TaiKhoanBenhNhanThu = thuPhiNgoaiGoi,
            //            YeuCauTiepNhanId = ycTiepNhan.Id,
            //            LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
            //            LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoSoTien,
            //            SoTien = mienGiamThemSoTien.SoTien
            //        });
            //    }

            //    yc.SoTienMienGiam = chiphi.SoTienMG;
            //    if ((mienGiamThemTiLe?.SoTien ?? 0).AlmostEqual(0) && (mienGiamThemSoTien?.SoTien ?? 0).AlmostEqual(0))
            //    {
            //        yc.GhiChuMienGiamThem = null;
            //        yc.NoiDungGhiChuMiemGiamId = null;
            //    }
            //    else
            //    {
            //        yc.GhiChuMienGiamThem = chiphi.GhiChuMienGiamThem;
            //        yc.NoiDungGhiChuMiemGiamId = chiphi.NoiDungGhiChuMiemGiamId;
            //    }
            //    #endregion
            //    yc.SoTienBenhNhanDaChi = yc.SoTienBenhNhanDaChi.GetValueOrDefault() + chiphi.BNConPhaiThanhToan;
            //    yc.TrangThaiThanhToan = Enums.TrangThaiThanhToan.DaThanhToan;
            //    if (yc.TrangThai == Enums.EnumTrangThaiYeuCauGoiDichVu.ChuaThucHien)
            //    {
            //        yc.TrangThai = Enums.EnumTrangThaiYeuCauGoiDichVu.DangThucHien;
            //    }
            //    thuPhiNgoaiGoi.TaiKhoanBenhNhanChis.Add(new TaiKhoanBenhNhanChi
            //    {
            //        TaiKhoanBenhNhan = tk,
            //        LoaiChiTienBenhNhan = Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi,
            //        TienChiPhi = chiphi.BNConPhaiThanhToan,
            //        NoiDungChi = Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi.GetDescription(),
            //        NgayChi = DateTime.Now,
            //        SoPhieuHienThi = thuPhiNgoaiGoi.SoPhieuHienThi,
            //        YeuCauGoiDichVu = yc,
            //        Gia = yc.GiaSauChietKhau,
            //        SoLuong = 1,
            //        SoTienMienGiam = yc.SoTienMienGiam,
            //        SoTienBaoHiemTuNhanChiTra = yc.SoTienBaoHiemTuNhanChiTra,
            //        YeuCauTiepNhanId = ycTiepNhan.Id,
            //        NhanVienThucHienId = _userAgentHelper.GetCurrentUserId(),
            //        NoiThucHienId = _userAgentHelper.GetCurrentNoiLLamViecId()
            //    });

            //}

            foreach (var chiphi in dsChiPhiDaChon.Where(o => o.LoaiNhom == NhomChiPhiNoiTru.ToaThuoc))
            {
                var yc = chiphi.DichVuNgoaiTru ? yeuCauTiepNhanNgoaiTruCanQuyetToan.DonThuocThanhToans.SelectMany(o => o.DonThuocThanhToanChiTiets).First(o => o.Id == chiphi.Id) : ycTiepNhan.DonThuocThanhToans.SelectMany(o => o.DonThuocThanhToanChiTiets).First(o => o.Id == chiphi.Id);
                #region cong no update 02/02/2021
                foreach (var ycCongTyBaoHiemTuNhanCongNo in yc.CongTyBaoHiemTuNhanCongNos.Where(o => o.TaiKhoanBenhNhanThuId == null))
                {
                    ycCongTyBaoHiemTuNhanCongNo.WillDelete = true;
                }
                if (chiphi.TongCongNo > 0)
                {
                    foreach (var chiphiDanhSachCongNoChoThu in chiphi.DanhSachCongNoChoThus)
                    {
                        if (chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu.AlmostEqual(0))
                            continue;
                        yc.CongTyBaoHiemTuNhanCongNos.Add(new CongTyBaoHiemTuNhanCongNo
                        {
                            TaiKhoanBenhNhanThu = thuPhiNgoaiGoi,
                            CongTyBaoHiemTuNhanId = chiphiDanhSachCongNoChoThu.CongTyBaoHiemTuNhanId,
                            SoTien = chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu
                        });
                    }
                }
                yc.SoTienBaoHiemTuNhanChiTra = chiphi.TongCongNo;
                #endregion
                #region mien giam update 02/02/2021
                foreach (var mienGiam in yc.MienGiamChiPhis.Where(o => o.TaiKhoanBenhNhanThuId == null))
                {
                    mienGiam.WillDelete = true;
                }
                //mien giam theo uu dai noi gioi thieu: BVHD-3882
                var mienGiamNoiGioiThieu = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.NoiGioiThieuId != null);
                if (mienGiamNoiGioiThieu != null)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhiNgoaiGoi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                        NoiGioiThieuId = mienGiamNoiGioiThieu.NoiGioiThieuId,
                        LoaiChietKhau = mienGiamNoiGioiThieu.LoaiChietKhau,
                        TiLe = mienGiamNoiGioiThieu.TiLe,
                        SoTien = mienGiamNoiGioiThieu.SoTien
                    });
                }
                //mien giam theo uu dai
                var mienGiamUuDai = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.DoiTuongUuDaiId != null && o.TiLe != 0);
                if (mienGiamUuDai != null)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhiNgoaiGoi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                        DoiTuongUuDaiId = mienGiamUuDai.DoiTuongUuDaiId,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                        TiLe = mienGiamUuDai.TiLe.GetValueOrDefault(),
                        SoTien = mienGiamUuDai.SoTien
                    });
                }
                //mien giam theo voucher
                var mienGiamVouchers = chiphi.DanhSachMienGiamVos.Where(o => o.TheVoucherId != null).ToList();
                foreach (var voucher in mienGiamVouchers)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhiNgoaiGoi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.Voucher,
                        TheVoucherId = voucher.TheVoucherId,
                        LoaiChietKhau = voucher.LoaiChietKhau,
                        MaTheVoucher = voucher.MaTheVoucher,
                        TiLe = voucher.TiLe.GetValueOrDefault(),
                        SoTien = voucher.SoTien
                    });
                }
                //mien giam them theo ti le
                var mienGiamThemTiLe = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoTiLe);
                if (mienGiamThemTiLe != null && mienGiamThemTiLe.TiLe.GetValueOrDefault() != 0)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhiNgoaiGoi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                        TiLe = mienGiamThemTiLe.TiLe,
                        SoTien = mienGiamThemTiLe.SoTien
                    });
                }
                //mien giam them theo so tien
                var mienGiamThemSoTien = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoSoTien);
                if (mienGiamThemSoTien != null && !mienGiamThemSoTien.SoTien.AlmostEqual(0))
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhiNgoaiGoi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoSoTien,
                        SoTien = mienGiamThemSoTien.SoTien
                    });
                }

                yc.SoTienMienGiam = chiphi.SoTienMG;
                if ((mienGiamThemTiLe?.SoTien ?? 0).AlmostEqual(0) && (mienGiamThemSoTien?.SoTien ?? 0).AlmostEqual(0))
                {
                    yc.GhiChuMienGiamThem = null;
                    yc.NoiDungGhiChuMiemGiamId = null;
                }
                else
                {
                    yc.GhiChuMienGiamThem = chiphi.GhiChuMienGiamThem;
                    yc.NoiDungGhiChuMiemGiamId = chiphi.NoiDungGhiChuMiemGiamId;
                }
                #endregion
                yc.SoTienBenhNhanDaChi = yc.SoTienBenhNhanDaChi.GetValueOrDefault() + chiphi.BNConPhaiThanhToan;
                yc.DonThuocThanhToan.TrangThaiThanhToan = Enums.TrangThaiThanhToan.DaThanhToan;
                var donThuocThanhToanChiTietTheoPhieuThu = yc.Map<DonThuocThanhToanChiTietTheoPhieuThu>();
                donThuocThanhToanChiTietTheoPhieuThu.NgayPhatSinh = yc.CreatedOn ?? DateTime.Now;
                donThuocThanhToanChiTietTheoPhieuThu.LoaiDonThuoc = yc.DonThuocThanhToan.LoaiDonThuoc;
                var ttNhapThuoc = yc.XuatKhoDuocPhamChiTietViTri.NhapKhoDuocPhamChiTiet;
                donThuocThanhToanChiTietTheoPhieuThu.Solo = ttNhapThuoc.Solo;
                donThuocThanhToanChiTietTheoPhieuThu.MaVach = ttNhapThuoc.MaVach;
                donThuocThanhToanChiTietTheoPhieuThu.HanSuDung = ttNhapThuoc.HanSuDung;
                donThuocThanhToanChiTietTheoPhieuThu.NgayNhapVaoBenhVien = ttNhapThuoc.NgayNhapVaoBenhVien;
                donThuocThanhToanChiTietTheoPhieuThu.SoLuongToa = yc.YeuCauKhamBenhDonThuocChiTiet?.SoLuong;
                donThuocThanhToanChiTietTheoPhieuThu.BacSiKeDonId = yc.YeuCauKhamBenhDonThuocChiTiet?.YeuCauKhamBenhDonThuoc.BacSiKeDonId;
                donThuocThanhToanChiTietTheoPhieuThu.ThoiDiemKeDon = yc.YeuCauKhamBenhDonThuocChiTiet?.YeuCauKhamBenhDonThuoc.ThoiDiemKeDon;

                thuPhiNgoaiGoi.TaiKhoanBenhNhanChis.Add(new TaiKhoanBenhNhanChi
                {
                    TaiKhoanBenhNhan = tk,
                    LoaiChiTienBenhNhan = Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi,
                    TienChiPhi = chiphi.BNConPhaiThanhToan,
                    NoiDungChi = Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi.GetDescription(),
                    NgayChi = DateTime.Now,
                    SoPhieuHienThi = thuPhiNgoaiGoi.SoPhieuHienThi,
                    DonThuocThanhToanChiTiet = yc,
                    DonThuocThanhToanChiTietTheoPhieuThu = donThuocThanhToanChiTietTheoPhieuThu,
                    Gia = yc.DonGiaBan,
                    SoLuong = yc.SoLuong,
                    DonGiaBaoHiem = yc.DonGiaBaoHiem,
                    MucHuongBaoHiem = yc.MucHuongBaoHiem,
                    TiLeBaoHiemThanhToan = yc.TiLeBaoHiemThanhToan,
                    SoTienMienGiam = yc.SoTienMienGiam,
                    SoTienBaoHiemTuNhanChiTra = yc.SoTienBaoHiemTuNhanChiTra,
                    YeuCauTiepNhanId = ycTiepNhan.Id,
                    NhanVienThucHienId = _userAgentHelper.GetCurrentUserId(),
                    NoiThucHienId = _userAgentHelper.GetCurrentNoiLLamViecId()
                });
            }
            TaiKhoanBenhNhanChi phieuHoanUng = null;
            if (thuTamUng.Any())
            {
                thuPhiNgoaiGoi.TamUng = soTienDaTamUng;
                phieuHoanUng = new TaiKhoanBenhNhanChi
                {
                    TaiKhoanBenhNhan = tk,
                    LoaiChiTienBenhNhan = Enums.LoaiChiTienBenhNhan.HoanUng,
                    TienMat = soTienDaTamUng,
                    NoiDungChi = Enums.LoaiChiTienBenhNhan.HoanUng.GetDescription(),
                    NgayChi = thuPhiNgoaiGoi.NgayThu.AddMilliseconds(-1),
                    YeuCauTiepNhanId = ycTiepNhan.Id,
                    SoPhieuHienThi = ResourceHelper.CreateSoHoanUng(),
                    NhanVienThucHienId = _userAgentHelper.GetCurrentUserId(),
                    NoiThucHienId = _userAgentHelper.GetCurrentNoiLLamViecId()
                };
                thuPhiNgoaiGoi.TaiKhoanBenhNhanChis.Add(phieuHoanUng);

                foreach (var taiKhoanBenhNhanThu in ycTiepNhan.TaiKhoanBenhNhanThus.Where(o => o.DaHuy != true && o.LoaiThuTienBenhNhan == LoaiThuTienBenhNhan.ThuTamUng && o.ThuTienGoiDichVu != true && o.PhieuHoanUngId == null))
                {
                    taiKhoanBenhNhanThu.PhieuHoanUng = phieuHoanUng;
                }
                if (yeuCauTiepNhanNgoaiTruCanQuyetToan != null)
                {
                    foreach (var taiKhoanBenhNhanThu in yeuCauTiepNhanNgoaiTruCanQuyetToan.TaiKhoanBenhNhanThus.Where(o => o.DaHuy != true && o.LoaiThuTienBenhNhan == LoaiThuTienBenhNhan.ThuTamUng && o.ThuTienGoiDichVu != true && o.PhieuHoanUngId == null))
                    {
                        taiKhoanBenhNhanThu.PhieuHoanUng = phieuHoanUng;
                    }
                }
            }

            tk.SoDuTaiKhoan -= soTienDaTamUng;
            ycTiepNhan.TaiKhoanBenhNhanThus.Add(thuPhiNgoaiGoi);

            //kiem tra dich vu trong goi da thanh toan
            if (ycTiepNhan.YeuCauKhamBenhs.All(o => o.TrangThai == Enums.EnumTrangThaiYeuCauKhamBenh.HuyKham || o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.DaThanhToan)
                && ycTiepNhan.YeuCauDichVuKyThuats.All(o => o.TrangThai == Enums.EnumTrangThaiYeuCauDichVuKyThuat.DaHuy || o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.DaThanhToan)
                && ycTiepNhan.YeuCauDichVuGiuongBenhVienChiPhiBenhViens.All(o => o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.DaThanhToan)
                && (yeuCauTiepNhanNgoaiTruCanQuyetToan == null || (yeuCauTiepNhanNgoaiTruCanQuyetToan.YeuCauKhamBenhs.All(o => o.TrangThai == Enums.EnumTrangThaiYeuCauKhamBenh.HuyKham || o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.DaThanhToan) &&
                                                                    yeuCauTiepNhanNgoaiTruCanQuyetToan.YeuCauDichVuKyThuats.All(o => o.TrangThai == EnumTrangThaiYeuCauDichVuKyThuat.DaHuy || o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.DaThanhToan))))
            {
                ycTiepNhan.NoiTruBenhAn.DaQuyetToan = true;
                ycTiepNhan.TrangThaiYeuCauTiepNhan = EnumTrangThaiYeuCauTiepNhan.DaHoanTat;
                if (yeuCauTiepNhanNgoaiTruCanQuyetToan != null)
                    yeuCauTiepNhanNgoaiTruCanQuyetToan.TrangThaiYeuCauTiepNhan = EnumTrangThaiYeuCauTiepNhan.DaHoanTat;
            }
            //await BaseRepository.UpdateAsync(ycTiepNhan);
            BaseRepository.Context.SaveChanges();
            var phieuThuIds = new List<long>();
            var phieuHoanUngIds = new List<long>();
            if (thuPhi != null)
            {
                phieuThuIds.Add(thuPhi.Id);
                phieuHoanUngIds = thuPhi.TaiKhoanBenhNhanChis.Where(o => o.LoaiChiTienBenhNhan == Enums.LoaiChiTienBenhNhan.HoanUng).Select(o => o.Id).ToList();
            }
            phieuThuIds.Add(thuPhiNgoaiGoi.Id);

            if (phieuHoanUng != null)
            {
                phieuHoanUngIds.Add(phieuHoanUng.Id);
            }
            return new KetQuaThuPhiKhamChuaBenhNoiTruVaQuyetToanDichVuTrongGoiVo
            {
                PhieuThuIds = phieuThuIds,
                LaPhieuChi = soTienDaTamUng + thuPhiKhamChuaBenhVo.SoTienCongNo.GetValueOrDefault() > soTienCanThu,
                PhieuHoanUngIds = phieuHoanUngIds
            };
        }
        public async Task LuuTamChiPhiNoiTru(ThuPhiKhamChuaBenhNoiTruVo thuPhiKhamChuaBenhVo)
        {
            var ycTiepNhan = BaseRepository.GetById(thuPhiKhamChuaBenhVo.Id,
                x => x.Include(o => o.NoiTruBenhAn)
                    .Include(o => o.TheVoucherYeuCauTiepNhans).ThenInclude(g => g.TheVoucher).ThenInclude(v => v.Voucher).ThenInclude(v => v.VoucherChiTietMienGiams)
                    .Include(o => o.YeuCauKhamBenhs).ThenInclude(g => g.CongTyBaoHiemTuNhanCongNos)
                    .Include(o => o.YeuCauDichVuKyThuats).ThenInclude(g => g.CongTyBaoHiemTuNhanCongNos)
                    .Include(o => o.YeuCauDuocPhamBenhViens).ThenInclude(g => g.CongTyBaoHiemTuNhanCongNos)
                    .Include(o => o.YeuCauVatTuBenhViens).ThenInclude(g => g.CongTyBaoHiemTuNhanCongNos)
                    .Include(o => o.YeuCauTruyenMaus).ThenInclude(g => g.CongTyBaoHiemTuNhanCongNos)
                    .Include(o => o.YeuCauDichVuGiuongBenhVienChiPhiBenhViens).ThenInclude(g => g.CongTyBaoHiemTuNhanCongNos)
                    .Include(o => o.YeuCauDichVuGiuongBenhVienChiPhiBHYTs)
                    .Include(o => o.DonThuocThanhToans).ThenInclude(g => g.DonThuocThanhToanChiTiets)
                    .ThenInclude(g => g.CongTyBaoHiemTuNhanCongNos)
                    //.Include(o => o.BenhNhan).ThenInclude(o => o.YeuCauGoiDichVus).ThenInclude(g => g.CongTyBaoHiemTuNhanCongNos)
                    //.Include(o => o.BenhNhan).ThenInclude(o => o.YeuCauGoiDichVus).ThenInclude(g => g.YeuCauDichVuKyThuats)
                    //.Include(o => o.BenhNhan).ThenInclude(o => o.YeuCauGoiDichVus).ThenInclude(g => g.YeuCauKhamBenhs)
                    //.Include(o => o.BenhNhan).ThenInclude(o => o.YeuCauGoiDichVus).ThenInclude(g => g.MienGiamChiPhis)
                    .Include(o => o.BenhNhan).ThenInclude(o => o.TaiKhoanBenhNhan)
                    .Include(o => o.TaiKhoanBenhNhanThus)
                    .Include(o => o.TaiKhoanBenhNhanChis)
                    .Include(o => o.DoiTuongUuDai).ThenInclude(ud => ud.DoiTuongUuDaiDichVuKhamBenhBenhViens)
                    .Include(o => o.DoiTuongUuDai).ThenInclude(ud => ud.DoiTuongUuDaiDichVuKyThuatBenhViens)
                    .Include(o => o.MienGiamChiPhis));

            long? yeuCauTiepNhanNgoaiTruCanQuyetToanId = ycTiepNhan.YeuCauTiepNhanNgoaiTruCanQuyetToanId;
            YeuCauTiepNhan yeuCauTiepNhanNgoaiTruCanQuyetToan = null;
            if (yeuCauTiepNhanNgoaiTruCanQuyetToanId != null)
            {
                yeuCauTiepNhanNgoaiTruCanQuyetToan = BaseRepository.GetById(yeuCauTiepNhanNgoaiTruCanQuyetToanId.Value,
                    x => x.Include(o => o.TheVoucherYeuCauTiepNhans).ThenInclude(g => g.TheVoucher).ThenInclude(v => v.Voucher).ThenInclude(v => v.VoucherChiTietMienGiams)
                        .Include(o => o.YeuCauKhamBenhs).ThenInclude(g => g.CongTyBaoHiemTuNhanCongNos)
                        .Include(o => o.YeuCauDichVuKyThuats).ThenInclude(g => g.CongTyBaoHiemTuNhanCongNos)
                        .Include(o => o.YeuCauDuocPhamBenhViens).ThenInclude(g => g.CongTyBaoHiemTuNhanCongNos)
                        .Include(o => o.YeuCauVatTuBenhViens).ThenInclude(g => g.CongTyBaoHiemTuNhanCongNos)
                        .Include(o => o.YeuCauDichVuGiuongBenhViens).ThenInclude(g => g.CongTyBaoHiemTuNhanCongNos)
                        .Include(o => o.DonThuocThanhToans).ThenInclude(g => g.DonThuocThanhToanChiTiets)
                        .ThenInclude(g => g.CongTyBaoHiemTuNhanCongNos)
                        //.Include(o => o.BenhNhan).ThenInclude(o => o.YeuCauGoiDichVus).ThenInclude(g => g.CongTyBaoHiemTuNhanCongNos)
                        //.Include(o => o.BenhNhan).ThenInclude(o => o.YeuCauGoiDichVus).ThenInclude(g => g.YeuCauDichVuKyThuats)
                        //.Include(o => o.BenhNhan).ThenInclude(o => o.YeuCauGoiDichVus).ThenInclude(g => g.YeuCauKhamBenhs)
                        //.Include(o => o.BenhNhan).ThenInclude(o => o.YeuCauGoiDichVus).ThenInclude(g => g.MienGiamChiPhis)
                        .Include(o => o.BenhNhan).ThenInclude(o => o.TaiKhoanBenhNhan)
                        .Include(o => o.TaiKhoanBenhNhanThus)
                        .Include(o => o.TaiKhoanBenhNhanChis)
                        .Include(o => o.DoiTuongUuDai).ThenInclude(ud => ud.DoiTuongUuDaiDichVuKhamBenhBenhViens)
                        .Include(o => o.DoiTuongUuDai).ThenInclude(ud => ud.DoiTuongUuDaiDichVuKyThuatBenhViens)
                        .Include(o => o.MienGiamChiPhis));
            }

            if (ycTiepNhan.BenhNhan == null)
                throw new Exception("Không có người bệnh");

            //kiem tra thong tin truoc khi luu
            if (yeuCauTiepNhanNgoaiTruCanQuyetToan == null)
            {
                var ycKhamBenhExcept = thuPhiKhamChuaBenhVo.DanhSachChiPhiKhamChuaBenhDaChons
                    .Where(o => o.LoaiNhom == NhomChiPhiNoiTru.DichVuKhamBenh).Select(o => o.Id).Except(ycTiepNhan
                        .YeuCauKhamBenhs
                        .Where(o => o.YeuCauGoiDichVuId == null &&
                                    (o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan ||
                                     o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                                     o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                        .Select(o => o.Id));
                var ycKyThuatExcept = thuPhiKhamChuaBenhVo.DanhSachChiPhiKhamChuaBenhDaChons
                    .Where(o => o.LoaiNhom == NhomChiPhiNoiTru.DichVuKyThuat).Select(o => o.Id).Except(ycTiepNhan
                        .YeuCauDichVuKyThuats
                        .Where(o => o.YeuCauGoiDichVuId == null &&
                                    (o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan ||
                                     o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                                     o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                        .Select(o => o.Id));
                var ycTruyenMauExcept = thuPhiKhamChuaBenhVo.DanhSachChiPhiKhamChuaBenhDaChons
                    .Where(o => o.LoaiNhom == NhomChiPhiNoiTru.TruyenMau).Select(o => o.Id).Except(ycTiepNhan
                        .YeuCauTruyenMaus
                        .Where(o => (o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan ||
                                     o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                                     o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                        .Select(o => o.Id));
                var ycGiuongExcept = thuPhiKhamChuaBenhVo.DanhSachChiPhiKhamChuaBenhDaChons
                    .Where(o => o.LoaiNhom == NhomChiPhiNoiTru.DichVuGiuong && ycTiepNhan.NoiTruBenhAn.ThoiDiemRaVien != null).Select(o => o.Id).Except(ycTiepNhan
                        .YeuCauDichVuGiuongBenhVienChiPhiBenhViens
                        .Where(o => o.YeuCauGoiDichVuId == null && (o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan ||
                                     o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                                     o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                        .Select(o => o.Id));
                var ycDuocPhamExcept = thuPhiKhamChuaBenhVo.DanhSachChiPhiKhamChuaBenhDaChons
                    .Where(o => o.LoaiNhom == NhomChiPhiNoiTru.DuocPham).Select(o => o.Id).Except(ycTiepNhan
                        .YeuCauDuocPhamBenhViens
                        .Where(o => o.YeuCauGoiDichVuId == null &&
                                    (o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan ||
                                     o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                                     o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                        .Select(o => o.Id));
                var ycVatTuExcept = thuPhiKhamChuaBenhVo.DanhSachChiPhiKhamChuaBenhDaChons
                    .Where(o => o.LoaiNhom == NhomChiPhiNoiTru.VatTuTieuHao).Select(o => o.Id).Except(ycTiepNhan
                        .YeuCauVatTuBenhViens
                        .Where(o => o.YeuCauGoiDichVuId == null &&
                                    (o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan ||
                                     o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                                     o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                        .Select(o => o.Id));
                var ycToaThuocExcept = thuPhiKhamChuaBenhVo.DanhSachChiPhiKhamChuaBenhDaChons
                    .Where(o => o.LoaiNhom == NhomChiPhiNoiTru.ToaThuoc).Select(o => o.Id).Except(ycTiepNhan
                        .DonThuocThanhToans
                        .Where(o => o.LoaiDonThuoc == Enums.EnumLoaiDonThuoc.ThuocBHYT &&
                                    (o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan ||
                                     o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                                     o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                        .SelectMany(o => o.DonThuocThanhToanChiTiets)
                        .Select(o => o.Id));

                var ycGoiDvExcept = thuPhiKhamChuaBenhVo.DanhSachChiPhiKhamChuaBenhDaChons
                    .Where(o => o.LoaiNhom == NhomChiPhiNoiTru.GoiDichVu).Select(o => o.Id).Except(ycTiepNhan.BenhNhan
                        .YeuCauGoiDichVus
                        .Where(o => o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan ||
                                    o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                                    o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan)
                        .Select(o => o.Id));

                if (ycKhamBenhExcept.Any() || ycKyThuatExcept.Any() || ycGiuongExcept.Any() || ycDuocPhamExcept.Any() ||
                    ycVatTuExcept.Any() || ycTruyenMauExcept.Any() ||
                    ycToaThuocExcept.Any() ||
                    ycGoiDvExcept.Any())
                    throw new Exception("Thông tin dịch vụ thanh toán không hợp lệ, vui lòng tải lại trang");
            }
            else
            {
                var ycKhamBenhExcept = thuPhiKhamChuaBenhVo.DanhSachChiPhiKhamChuaBenhDaChons
                .Where(o => o.LoaiNhom == NhomChiPhiNoiTru.DichVuKhamBenh).Select(o => o.Id).Except(ycTiepNhan
                    .YeuCauKhamBenhs
                    .Where(o => o.YeuCauGoiDichVuId == null &&
                                (o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                                 o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                    .Select(o => o.Id)
                    .Concat(yeuCauTiepNhanNgoaiTruCanQuyetToan
                            .YeuCauKhamBenhs
                            .Where(o => o.YeuCauGoiDichVuId == null &&
                                        (o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                                         o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                            .Select(o => o.Id)));
                var ycKyThuatExcept = thuPhiKhamChuaBenhVo.DanhSachChiPhiKhamChuaBenhDaChons
                    .Where(o => o.LoaiNhom == NhomChiPhiNoiTru.DichVuKyThuat).Select(o => o.Id).Except(ycTiepNhan
                        .YeuCauDichVuKyThuats
                        .Where(o => o.YeuCauGoiDichVuId == null &&
                                    (o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                                     o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                        .Select(o => o.Id)
                        .Concat(yeuCauTiepNhanNgoaiTruCanQuyetToan.YeuCauDichVuKyThuats
                            .Where(o => o.YeuCauGoiDichVuId == null &&
                                        (o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                                         o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                            .Select(o => o.Id)));
                var ycTruyenMauExcept = thuPhiKhamChuaBenhVo.DanhSachChiPhiKhamChuaBenhDaChons
                    .Where(o => o.LoaiNhom == NhomChiPhiNoiTru.TruyenMau).Select(o => o.Id).Except(ycTiepNhan
                        .YeuCauTruyenMaus
                        .Where(o => (o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                                     o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                        .Select(o => o.Id));
                var ycGiuongExcept = thuPhiKhamChuaBenhVo.DanhSachChiPhiKhamChuaBenhDaChons
                    .Where(o => o.LoaiNhom == NhomChiPhiNoiTru.DichVuGiuong && ycTiepNhan.NoiTruBenhAn.ThoiDiemRaVien != null).Select(o => o.Id).Except(ycTiepNhan
                        .YeuCauDichVuGiuongBenhVienChiPhiBenhViens
                        .Where(o => o.YeuCauGoiDichVuId == null && (o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                                     o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                        .Select(o => o.Id));
                var ycDuocPhamExcept = thuPhiKhamChuaBenhVo.DanhSachChiPhiKhamChuaBenhDaChons
                    .Where(o => o.LoaiNhom == NhomChiPhiNoiTru.DuocPham).Select(o => o.Id).Except(ycTiepNhan
                        .YeuCauDuocPhamBenhViens
                        .Where(o => o.YeuCauGoiDichVuId == null &&
                                    (o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                                     o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                        .Select(o => o.Id)
                        .Concat(yeuCauTiepNhanNgoaiTruCanQuyetToan
                            .YeuCauDuocPhamBenhViens
                            .Where(o => o.YeuCauGoiDichVuId == null &&
                                        (o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                                         o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                            .Select(o => o.Id)));
                var ycVatTuExcept = thuPhiKhamChuaBenhVo.DanhSachChiPhiKhamChuaBenhDaChons
                    .Where(o => o.LoaiNhom == NhomChiPhiNoiTru.VatTuTieuHao).Select(o => o.Id).Except(ycTiepNhan
                        .YeuCauVatTuBenhViens
                        .Where(o => o.YeuCauGoiDichVuId == null &&
                                    (o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                                     o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                        .Select(o => o.Id)
                        .Concat(yeuCauTiepNhanNgoaiTruCanQuyetToan
                            .YeuCauVatTuBenhViens
                            .Where(o => o.YeuCauGoiDichVuId == null &&
                                        (o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                                         o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                            .Select(o => o.Id)));
                var ycToaThuocExcept = thuPhiKhamChuaBenhVo.DanhSachChiPhiKhamChuaBenhDaChons
                    .Where(o => o.LoaiNhom == NhomChiPhiNoiTru.ToaThuoc).Select(o => o.Id).Except(ycTiepNhan
                        .DonThuocThanhToans
                        .Where(o => o.LoaiDonThuoc == Enums.EnumLoaiDonThuoc.ThuocBHYT &&
                                    (o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                                     o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                        .SelectMany(o => o.DonThuocThanhToanChiTiets)
                        .Select(o => o.Id)
                        .Concat(yeuCauTiepNhanNgoaiTruCanQuyetToan
                            .DonThuocThanhToans
                            .Where(o => o.LoaiDonThuoc == Enums.EnumLoaiDonThuoc.ThuocBHYT &&
                                        (o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                                         o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                            .SelectMany(o => o.DonThuocThanhToanChiTiets)
                            .Select(o => o.Id)));

                var ycGoiDvExcept = thuPhiKhamChuaBenhVo.DanhSachChiPhiKhamChuaBenhDaChons
                    .Where(o => o.LoaiNhom == NhomChiPhiNoiTru.GoiDichVu).Select(o => o.Id).Except(ycTiepNhan.BenhNhan.YeuCauGoiDichVus
                        .Where(o => o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                                    o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan)
                        .Select(o => o.Id));

                if (ycKhamBenhExcept.Any() || ycKyThuatExcept.Any() || ycGiuongExcept.Any() || ycDuocPhamExcept.Any() || ycVatTuExcept.Any() || ycTruyenMauExcept.Any() ||
                    ycToaThuocExcept.Any() || ycGoiDvExcept.Any())
                    throw new Exception("Thông tin dịch vụ thanh toán không hợp lệ, vui lòng tải lại trang");
            }


            var dsChiPhi = await GetDanhSachChiPhiKhamChuaBenhChuaThu(thuPhiKhamChuaBenhVo.Id);
            var dsChiPhiDaChon = thuPhiKhamChuaBenhVo.DanhSachChiPhiKhamChuaBenhDaChons;

            foreach (var chiPhiKhamChuaBenhVo in dsChiPhiDaChon.Where(o => o.Id != 0))
            {
                var chiphi = dsChiPhi.FirstOrDefault(o => o.LoaiNhom == chiPhiKhamChuaBenhVo.LoaiNhom && o.Id == chiPhiKhamChuaBenhVo.Id);
                if (chiphi == null || !chiphi.ThanhTien.AlmostEqual(chiPhiKhamChuaBenhVo.ThanhTien) || !chiphi.BHYTThanhToan.AlmostEqual(chiPhiKhamChuaBenhVo.BHYTThanhToan))
                {
                    throw new Exception("Thông tin dịch vụ thanh toán không hợp lệ, vui lòng tải lại trang");
                }
                if (chiPhiKhamChuaBenhVo.TongCongNo > chiPhiKhamChuaBenhVo.ThanhTien && chiPhiKhamChuaBenhVo.TongCongNo > Math.Round(chiPhiKhamChuaBenhVo.ThanhTien, 2, MidpointRounding.AwayFromZero))
                {
                    throw new Exception("Số tiền BHTN thanh toán lớn hơn thành tiền");
                }
                var soTienTruocMienGiam = chiPhiKhamChuaBenhVo.ThanhTien - chiPhiKhamChuaBenhVo.BHYTThanhToan;

                decimal soTienMienGiamTheoDv = 0;

                foreach (var mienGiamTheoTiLe in chiPhiKhamChuaBenhVo.DanhSachMienGiamVos.Where(o => o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoTiLe))
                {
                    mienGiamTheoTiLe.SoTien = Math.Round((soTienTruocMienGiam * mienGiamTheoTiLe.TiLe.GetValueOrDefault() / 100), 2, MidpointRounding.AwayFromZero);
                    soTienMienGiamTheoDv += mienGiamTheoTiLe.SoTien;
                }
                foreach (var mienGiamTheoTiLe in chiPhiKhamChuaBenhVo.DanhSachMienGiamVos.Where(o => o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoSoTien))
                {
                    soTienMienGiamTheoDv += mienGiamTheoTiLe.SoTien;
                }
                if (soTienMienGiamTheoDv > chiPhiKhamChuaBenhVo.ThanhTien && soTienMienGiamTheoDv > Math.Round(chiPhiKhamChuaBenhVo.ThanhTien, 2, MidpointRounding.AwayFromZero))
                {
                    throw new Exception("Số tiền miễn giảm lớn hơn thành tiền");
                }
                chiPhiKhamChuaBenhVo.SoTienMG = soTienMienGiamTheoDv;
            }

            foreach (var chiphi in dsChiPhiDaChon.Where(o => o.LoaiNhom == NhomChiPhiNoiTru.DichVuKhamBenh))
            {
                var yc = chiphi.DichVuNgoaiTru ? yeuCauTiepNhanNgoaiTruCanQuyetToan.YeuCauKhamBenhs.First(o => o.Id == chiphi.Id) : ycTiepNhan.YeuCauKhamBenhs.First(o => o.Id == chiphi.Id);
                #region cong no update 02/02/2021
                foreach (var ycCongTyBaoHiemTuNhanCongNo in yc.CongTyBaoHiemTuNhanCongNos.Where(o => o.TaiKhoanBenhNhanThuId == null))
                {
                    ycCongTyBaoHiemTuNhanCongNo.WillDelete = true;
                }
                if (chiphi.TongCongNo > 0)
                {
                    foreach (var chiphiDanhSachCongNoChoThu in chiphi.DanhSachCongNoChoThus)
                    {
                        if (chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu.AlmostEqual(0))
                            continue;
                        yc.CongTyBaoHiemTuNhanCongNos.Add(new CongTyBaoHiemTuNhanCongNo
                        {
                            CongTyBaoHiemTuNhanId = chiphiDanhSachCongNoChoThu.CongTyBaoHiemTuNhanId,
                            SoTien = chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu
                        });
                    }
                }
                yc.SoTienBaoHiemTuNhanChiTra = chiphi.TongCongNo;
                #endregion
                #region mien giam update 02/02/2021
                foreach (var mienGiam in yc.MienGiamChiPhis.Where(o => o.TaiKhoanBenhNhanThuId == null))
                {
                    mienGiam.WillDelete = true;
                }
                //mien giam theo uu dai noi gioi thieu: BVHD-3882
                var mienGiamNoiGioiThieu = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.NoiGioiThieuId != null);
                if (mienGiamNoiGioiThieu != null)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                        NoiGioiThieuId = mienGiamNoiGioiThieu.NoiGioiThieuId,
                        LoaiChietKhau = mienGiamNoiGioiThieu.LoaiChietKhau,
                        TiLe = mienGiamNoiGioiThieu.TiLe,
                        SoTien = mienGiamNoiGioiThieu.SoTien
                    });
                }
                //mien giam theo uu dai
                var mienGiamUuDai = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.DoiTuongUuDaiId != null && o.TiLe != 0);
                if (mienGiamUuDai != null)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                        DoiTuongUuDaiId = mienGiamUuDai.DoiTuongUuDaiId,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                        TiLe = mienGiamUuDai.TiLe.GetValueOrDefault(),
                        SoTien = mienGiamUuDai.SoTien
                    });
                }
                //mien giam theo voucher
                var mienGiamVouchers = chiphi.DanhSachMienGiamVos.Where(o => o.TheVoucherId != null).ToList();
                foreach (var voucher in mienGiamVouchers)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.Voucher,
                        TheVoucherId = voucher.TheVoucherId,
                        LoaiChietKhau = voucher.LoaiChietKhau,
                        MaTheVoucher = voucher.MaTheVoucher,
                        TiLe = voucher.TiLe.GetValueOrDefault(),
                        SoTien = voucher.SoTien
                    });
                }
                //mien giam them theo ti le
                var mienGiamThemTiLe = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoTiLe);
                if (mienGiamThemTiLe != null && mienGiamThemTiLe.TiLe.GetValueOrDefault() != 0)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                        TiLe = mienGiamThemTiLe.TiLe,
                        SoTien = mienGiamThemTiLe.SoTien
                    });
                }
                //mien giam them theo so tien
                var mienGiamThemSoTien = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoSoTien);
                if (mienGiamThemSoTien != null && !mienGiamThemSoTien.SoTien.AlmostEqual(0))
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoSoTien,
                        SoTien = mienGiamThemSoTien.SoTien
                    });
                }

                yc.SoTienMienGiam = chiphi.SoTienMG;
                if ((mienGiamThemTiLe?.SoTien ?? 0).AlmostEqual(0) && (mienGiamThemSoTien?.SoTien ?? 0).AlmostEqual(0))
                {
                    yc.GhiChuMienGiamThem = null;
                    yc.NoiDungGhiChuMiemGiamId = null;
                }
                else
                {
                    yc.GhiChuMienGiamThem = chiphi.GhiChuMienGiamThem;
                    yc.NoiDungGhiChuMiemGiamId = chiphi.NoiDungGhiChuMiemGiamId;
                }
                #endregion
            }

            foreach (var chiphi in dsChiPhiDaChon.Where(o => o.LoaiNhom == NhomChiPhiNoiTru.DichVuKyThuat))
            {
                var yc = chiphi.DichVuNgoaiTru ? yeuCauTiepNhanNgoaiTruCanQuyetToan.YeuCauDichVuKyThuats.First(o => o.Id == chiphi.Id) : ycTiepNhan.YeuCauDichVuKyThuats.First(o => o.Id == chiphi.Id);
                #region cong no update 02/02/2021
                foreach (var ycCongTyBaoHiemTuNhanCongNo in yc.CongTyBaoHiemTuNhanCongNos.Where(o => o.TaiKhoanBenhNhanThuId == null))
                {
                    ycCongTyBaoHiemTuNhanCongNo.WillDelete = true;
                }
                if (chiphi.TongCongNo > 0)
                {
                    foreach (var chiphiDanhSachCongNoChoThu in chiphi.DanhSachCongNoChoThus)
                    {
                        if (chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu.AlmostEqual(0))
                            continue;
                        yc.CongTyBaoHiemTuNhanCongNos.Add(new CongTyBaoHiemTuNhanCongNo
                        {
                            CongTyBaoHiemTuNhanId = chiphiDanhSachCongNoChoThu.CongTyBaoHiemTuNhanId,
                            SoTien = chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu
                        });
                    }
                }
                yc.SoTienBaoHiemTuNhanChiTra = chiphi.TongCongNo;
                #endregion
                #region mien giam update 02/02/2021
                foreach (var mienGiam in yc.MienGiamChiPhis.Where(o => o.TaiKhoanBenhNhanThuId == null))
                {
                    mienGiam.WillDelete = true;
                }
                //mien giam theo uu dai noi gioi thieu: BVHD-3882
                var mienGiamNoiGioiThieu = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.NoiGioiThieuId != null);
                if (mienGiamNoiGioiThieu != null)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                        NoiGioiThieuId = mienGiamNoiGioiThieu.NoiGioiThieuId,
                        LoaiChietKhau = mienGiamNoiGioiThieu.LoaiChietKhau,
                        TiLe = mienGiamNoiGioiThieu.TiLe,
                        SoTien = mienGiamNoiGioiThieu.SoTien
                    });
                }
                //mien giam theo uu dai
                var mienGiamUuDai = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.DoiTuongUuDaiId != null && o.TiLe != 0);
                if (mienGiamUuDai != null)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                        DoiTuongUuDaiId = mienGiamUuDai.DoiTuongUuDaiId,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                        TiLe = mienGiamUuDai.TiLe.GetValueOrDefault(),
                        SoTien = mienGiamUuDai.SoTien
                    });
                }
                //mien giam theo voucher
                var mienGiamVouchers = chiphi.DanhSachMienGiamVos.Where(o => o.TheVoucherId != null).ToList();
                foreach (var voucher in mienGiamVouchers)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.Voucher,
                        TheVoucherId = voucher.TheVoucherId,
                        LoaiChietKhau = voucher.LoaiChietKhau,
                        MaTheVoucher = voucher.MaTheVoucher,
                        TiLe = voucher.TiLe.GetValueOrDefault(),
                        SoTien = voucher.SoTien
                    });
                }
                //mien giam them theo ti le
                var mienGiamThemTiLe = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoTiLe);
                if (mienGiamThemTiLe != null && mienGiamThemTiLe.TiLe.GetValueOrDefault() != 0)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                        TiLe = mienGiamThemTiLe.TiLe,
                        SoTien = mienGiamThemTiLe.SoTien
                    });
                }
                //mien giam them theo so tien
                var mienGiamThemSoTien = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoSoTien);
                if (mienGiamThemSoTien != null && !mienGiamThemSoTien.SoTien.AlmostEqual(0))
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoSoTien,
                        SoTien = mienGiamThemSoTien.SoTien
                    });
                }

                yc.SoTienMienGiam = chiphi.SoTienMG;
                if ((mienGiamThemTiLe?.SoTien ?? 0).AlmostEqual(0) && (mienGiamThemSoTien?.SoTien ?? 0).AlmostEqual(0))
                {
                    yc.GhiChuMienGiamThem = null;
                    yc.NoiDungGhiChuMiemGiamId = null;
                }
                else
                {
                    yc.GhiChuMienGiamThem = chiphi.GhiChuMienGiamThem;
                    yc.NoiDungGhiChuMiemGiamId = chiphi.NoiDungGhiChuMiemGiamId;
                }
                #endregion
            }

            foreach (var chiphi in dsChiPhiDaChon.Where(o => o.LoaiNhom == NhomChiPhiNoiTru.DichVuGiuong && o.Id != 0))
            {
                var yc = ycTiepNhan.YeuCauDichVuGiuongBenhVienChiPhiBenhViens.First(o => o.Id == chiphi.Id);
                #region cong no update 02/02/2021
                foreach (var ycCongTyBaoHiemTuNhanCongNo in yc.CongTyBaoHiemTuNhanCongNos.Where(o => o.TaiKhoanBenhNhanThuId == null))
                {
                    ycCongTyBaoHiemTuNhanCongNo.WillDelete = true;
                }
                if (chiphi.TongCongNo > 0)
                {
                    foreach (var chiphiDanhSachCongNoChoThu in chiphi.DanhSachCongNoChoThus)
                    {
                        if (chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu.AlmostEqual(0))
                            continue;
                        yc.CongTyBaoHiemTuNhanCongNos.Add(new CongTyBaoHiemTuNhanCongNo
                        {
                            CongTyBaoHiemTuNhanId = chiphiDanhSachCongNoChoThu.CongTyBaoHiemTuNhanId,
                            SoTien = chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu
                        });
                    }
                }
                yc.SoTienBaoHiemTuNhanChiTra = chiphi.TongCongNo;
                #endregion
                #region mien giam update 02/02/2021
                foreach (var mienGiam in yc.MienGiamChiPhis.Where(o => o.TaiKhoanBenhNhanThuId == null))
                {
                    mienGiam.WillDelete = true;
                }
                //mien giam theo uu dai noi gioi thieu: BVHD-3882
                var mienGiamNoiGioiThieu = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.NoiGioiThieuId != null);
                if (mienGiamNoiGioiThieu != null)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                        NoiGioiThieuId = mienGiamNoiGioiThieu.NoiGioiThieuId,
                        LoaiChietKhau = mienGiamNoiGioiThieu.LoaiChietKhau,
                        TiLe = mienGiamNoiGioiThieu.TiLe,
                        SoTien = mienGiamNoiGioiThieu.SoTien
                    });
                }
                //mien giam theo uu dai
                var mienGiamUuDai = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.DoiTuongUuDaiId != null && o.TiLe != 0);
                if (mienGiamUuDai != null)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                        DoiTuongUuDaiId = mienGiamUuDai.DoiTuongUuDaiId,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                        TiLe = mienGiamUuDai.TiLe.GetValueOrDefault(),
                        SoTien = mienGiamUuDai.SoTien
                    });
                }
                //mien giam theo voucher
                var mienGiamVouchers = chiphi.DanhSachMienGiamVos.Where(o => o.TheVoucherId != null).ToList();
                foreach (var voucher in mienGiamVouchers)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.Voucher,
                        TheVoucherId = voucher.TheVoucherId,
                        LoaiChietKhau = voucher.LoaiChietKhau,
                        MaTheVoucher = voucher.MaTheVoucher,
                        TiLe = voucher.TiLe.GetValueOrDefault(),
                        SoTien = voucher.SoTien
                    });
                }
                //mien giam them theo ti le
                var mienGiamThemTiLe = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoTiLe);
                if (mienGiamThemTiLe != null && mienGiamThemTiLe.TiLe.GetValueOrDefault() != 0)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                        TiLe = mienGiamThemTiLe.TiLe,
                        SoTien = mienGiamThemTiLe.SoTien
                    });
                }
                //mien giam them theo so tien
                var mienGiamThemSoTien = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoSoTien);
                if (mienGiamThemSoTien != null && !mienGiamThemSoTien.SoTien.AlmostEqual(0))
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoSoTien,
                        SoTien = mienGiamThemSoTien.SoTien
                    });
                }

                yc.SoTienMienGiam = chiphi.SoTienMG;
                if ((mienGiamThemTiLe?.SoTien ?? 0).AlmostEqual(0) && (mienGiamThemSoTien?.SoTien ?? 0).AlmostEqual(0))
                {
                    yc.GhiChuMienGiamThem = null;
                    yc.NoiDungGhiChuMiemGiamId = null;
                }
                else
                {
                    yc.GhiChuMienGiamThem = chiphi.GhiChuMienGiamThem;
                    yc.NoiDungGhiChuMiemGiamId = chiphi.NoiDungGhiChuMiemGiamId;
                }
                #endregion
            }

            foreach (var chiphi in dsChiPhiDaChon.Where(o => o.LoaiNhom == NhomChiPhiNoiTru.TruyenMau))
            {
                var yc = ycTiepNhan.YeuCauTruyenMaus.First(o => o.Id == chiphi.Id);
                #region cong no update 02/02/2021
                foreach (var ycCongTyBaoHiemTuNhanCongNo in yc.CongTyBaoHiemTuNhanCongNos.Where(o => o.TaiKhoanBenhNhanThuId == null))
                {
                    ycCongTyBaoHiemTuNhanCongNo.WillDelete = true;
                }
                if (chiphi.TongCongNo > 0)
                {
                    foreach (var chiphiDanhSachCongNoChoThu in chiphi.DanhSachCongNoChoThus)
                    {
                        if (chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu.AlmostEqual(0))
                            continue;
                        yc.CongTyBaoHiemTuNhanCongNos.Add(new CongTyBaoHiemTuNhanCongNo
                        {
                            CongTyBaoHiemTuNhanId = chiphiDanhSachCongNoChoThu.CongTyBaoHiemTuNhanId,
                            SoTien = chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu
                        });
                    }
                }
                yc.SoTienBaoHiemTuNhanChiTra = chiphi.TongCongNo;
                #endregion
                #region mien giam update 02/02/2021
                foreach (var mienGiam in yc.MienGiamChiPhis.Where(o => o.TaiKhoanBenhNhanThuId == null))
                {
                    mienGiam.WillDelete = true;
                }
                //mien giam theo uu dai
                var mienGiamUuDai = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.DoiTuongUuDaiId != null && o.TiLe != 0);
                if (mienGiamUuDai != null)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                        DoiTuongUuDaiId = mienGiamUuDai.DoiTuongUuDaiId,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                        TiLe = mienGiamUuDai.TiLe.GetValueOrDefault(),
                        SoTien = mienGiamUuDai.SoTien
                    });
                }
                //mien giam theo voucher
                var mienGiamVouchers = chiphi.DanhSachMienGiamVos.Where(o => o.TheVoucherId != null).ToList();
                foreach (var voucher in mienGiamVouchers)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.Voucher,
                        TheVoucherId = voucher.TheVoucherId,
                        LoaiChietKhau = voucher.LoaiChietKhau,
                        MaTheVoucher = voucher.MaTheVoucher,
                        TiLe = voucher.TiLe.GetValueOrDefault(),
                        SoTien = voucher.SoTien
                    });
                }
                //mien giam them theo ti le
                var mienGiamThemTiLe = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoTiLe);
                if (mienGiamThemTiLe != null && mienGiamThemTiLe.TiLe.GetValueOrDefault() != 0)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                        TiLe = mienGiamThemTiLe.TiLe,
                        SoTien = mienGiamThemTiLe.SoTien
                    });
                }
                //mien giam them theo so tien
                var mienGiamThemSoTien = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoSoTien);
                if (mienGiamThemSoTien != null && !mienGiamThemSoTien.SoTien.AlmostEqual(0))
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoSoTien,
                        SoTien = mienGiamThemSoTien.SoTien
                    });
                }

                yc.SoTienMienGiam = chiphi.SoTienMG;
                if ((mienGiamThemTiLe?.SoTien ?? 0).AlmostEqual(0) && (mienGiamThemSoTien?.SoTien ?? 0).AlmostEqual(0))
                {
                    yc.GhiChuMienGiamThem = null;
                    yc.NoiDungGhiChuMiemGiamId = null;
                }
                else
                {
                    yc.GhiChuMienGiamThem = chiphi.GhiChuMienGiamThem;
                    yc.NoiDungGhiChuMiemGiamId = chiphi.NoiDungGhiChuMiemGiamId;
                }
                #endregion
            }

            foreach (var chiphi in dsChiPhiDaChon.Where(o => o.LoaiNhom == NhomChiPhiNoiTru.DuocPham))
            {
                var yc = chiphi.DichVuNgoaiTru ? yeuCauTiepNhanNgoaiTruCanQuyetToan.YeuCauDuocPhamBenhViens.First(o => o.Id == chiphi.Id) : ycTiepNhan.YeuCauDuocPhamBenhViens.First(o => o.Id == chiphi.Id);
                #region cong no update 02/02/2021
                foreach (var ycCongTyBaoHiemTuNhanCongNo in yc.CongTyBaoHiemTuNhanCongNos.Where(o => o.TaiKhoanBenhNhanThuId == null))
                {
                    ycCongTyBaoHiemTuNhanCongNo.WillDelete = true;
                }
                if (chiphi.TongCongNo > 0)
                {
                    foreach (var chiphiDanhSachCongNoChoThu in chiphi.DanhSachCongNoChoThus)
                    {
                        if (chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu.AlmostEqual(0))
                            continue;
                        yc.CongTyBaoHiemTuNhanCongNos.Add(new CongTyBaoHiemTuNhanCongNo
                        {
                            CongTyBaoHiemTuNhanId = chiphiDanhSachCongNoChoThu.CongTyBaoHiemTuNhanId,
                            SoTien = chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu
                        });
                    }
                }
                yc.SoTienBaoHiemTuNhanChiTra = chiphi.TongCongNo;
                #endregion
                #region mien giam update 02/02/2021
                foreach (var mienGiam in yc.MienGiamChiPhis.Where(o => o.TaiKhoanBenhNhanThuId == null))
                {
                    mienGiam.WillDelete = true;
                }
                //mien giam theo uu dai noi gioi thieu: BVHD-3882
                var mienGiamNoiGioiThieu = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.NoiGioiThieuId != null);
                if (mienGiamNoiGioiThieu != null)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                        NoiGioiThieuId = mienGiamNoiGioiThieu.NoiGioiThieuId,
                        LoaiChietKhau = mienGiamNoiGioiThieu.LoaiChietKhau,
                        TiLe = mienGiamNoiGioiThieu.TiLe,
                        SoTien = mienGiamNoiGioiThieu.SoTien
                    });
                }
                //mien giam theo uu dai
                var mienGiamUuDai = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.DoiTuongUuDaiId != null && o.TiLe != 0);
                if (mienGiamUuDai != null)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                        DoiTuongUuDaiId = mienGiamUuDai.DoiTuongUuDaiId,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                        TiLe = mienGiamUuDai.TiLe.GetValueOrDefault(),
                        SoTien = mienGiamUuDai.SoTien
                    });
                }
                //mien giam theo voucher
                var mienGiamVouchers = chiphi.DanhSachMienGiamVos.Where(o => o.TheVoucherId != null).ToList();
                foreach (var voucher in mienGiamVouchers)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.Voucher,
                        TheVoucherId = voucher.TheVoucherId,
                        LoaiChietKhau = voucher.LoaiChietKhau,
                        MaTheVoucher = voucher.MaTheVoucher,
                        TiLe = voucher.TiLe.GetValueOrDefault(),
                        SoTien = voucher.SoTien
                    });
                }
                //mien giam them theo ti le
                var mienGiamThemTiLe = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoTiLe);
                if (mienGiamThemTiLe != null && mienGiamThemTiLe.TiLe.GetValueOrDefault() != 0)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                        TiLe = mienGiamThemTiLe.TiLe,
                        SoTien = mienGiamThemTiLe.SoTien
                    });
                }
                //mien giam them theo so tien
                var mienGiamThemSoTien = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoSoTien);
                if (mienGiamThemSoTien != null && !mienGiamThemSoTien.SoTien.AlmostEqual(0))
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoSoTien,
                        SoTien = mienGiamThemSoTien.SoTien
                    });
                }

                yc.SoTienMienGiam = chiphi.SoTienMG;
                if ((mienGiamThemTiLe?.SoTien ?? 0).AlmostEqual(0) && (mienGiamThemSoTien?.SoTien ?? 0).AlmostEqual(0))
                {
                    yc.GhiChuMienGiamThem = null;
                    yc.NoiDungGhiChuMiemGiamId = null;
                }
                else
                {
                    yc.GhiChuMienGiamThem = chiphi.GhiChuMienGiamThem;
                    yc.NoiDungGhiChuMiemGiamId = chiphi.NoiDungGhiChuMiemGiamId;
                }
                #endregion
            }

            foreach (var chiphi in dsChiPhiDaChon.Where(o => o.LoaiNhom == NhomChiPhiNoiTru.VatTuTieuHao))
            {
                var yc = chiphi.DichVuNgoaiTru ? yeuCauTiepNhanNgoaiTruCanQuyetToan.YeuCauVatTuBenhViens.First(o => o.Id == chiphi.Id) : ycTiepNhan.YeuCauVatTuBenhViens.First(o => o.Id == chiphi.Id);
                #region cong no update 02/02/2021
                foreach (var ycCongTyBaoHiemTuNhanCongNo in yc.CongTyBaoHiemTuNhanCongNos.Where(o => o.TaiKhoanBenhNhanThuId == null))
                {
                    ycCongTyBaoHiemTuNhanCongNo.WillDelete = true;
                }
                if (chiphi.TongCongNo > 0)
                {
                    foreach (var chiphiDanhSachCongNoChoThu in chiphi.DanhSachCongNoChoThus)
                    {
                        if (chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu.AlmostEqual(0))
                            continue;
                        yc.CongTyBaoHiemTuNhanCongNos.Add(new CongTyBaoHiemTuNhanCongNo
                        {
                            CongTyBaoHiemTuNhanId = chiphiDanhSachCongNoChoThu.CongTyBaoHiemTuNhanId,
                            SoTien = chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu
                        });
                    }
                }
                yc.SoTienBaoHiemTuNhanChiTra = chiphi.TongCongNo;
                #endregion
                #region mien giam update 02/02/2021
                foreach (var mienGiam in yc.MienGiamChiPhis.Where(o => o.TaiKhoanBenhNhanThuId == null))
                {
                    mienGiam.WillDelete = true;
                }
                //mien giam theo uu dai noi gioi thieu: BVHD-3882
                var mienGiamNoiGioiThieu = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.NoiGioiThieuId != null);
                if (mienGiamNoiGioiThieu != null)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                        NoiGioiThieuId = mienGiamNoiGioiThieu.NoiGioiThieuId,
                        LoaiChietKhau = mienGiamNoiGioiThieu.LoaiChietKhau,
                        TiLe = mienGiamNoiGioiThieu.TiLe,
                        SoTien = mienGiamNoiGioiThieu.SoTien
                    });
                }
                //mien giam theo uu dai
                var mienGiamUuDai = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.DoiTuongUuDaiId != null && o.TiLe != 0);
                if (mienGiamUuDai != null)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                        DoiTuongUuDaiId = mienGiamUuDai.DoiTuongUuDaiId,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                        TiLe = mienGiamUuDai.TiLe.GetValueOrDefault(),
                        SoTien = mienGiamUuDai.SoTien
                    });
                }
                //mien giam theo voucher
                var mienGiamVouchers = chiphi.DanhSachMienGiamVos.Where(o => o.TheVoucherId != null).ToList();
                foreach (var voucher in mienGiamVouchers)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.Voucher,
                        TheVoucherId = voucher.TheVoucherId,
                        LoaiChietKhau = voucher.LoaiChietKhau,
                        MaTheVoucher = voucher.MaTheVoucher,
                        TiLe = voucher.TiLe.GetValueOrDefault(),
                        SoTien = voucher.SoTien
                    });
                }
                //mien giam them theo ti le
                var mienGiamThemTiLe = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoTiLe);
                if (mienGiamThemTiLe != null && mienGiamThemTiLe.TiLe.GetValueOrDefault() != 0)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                        TiLe = mienGiamThemTiLe.TiLe,
                        SoTien = mienGiamThemTiLe.SoTien
                    });
                }
                //mien giam them theo so tien
                var mienGiamThemSoTien = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoSoTien);
                if (mienGiamThemSoTien != null && !mienGiamThemSoTien.SoTien.AlmostEqual(0))
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoSoTien,
                        SoTien = mienGiamThemSoTien.SoTien
                    });
                }

                yc.SoTienMienGiam = chiphi.SoTienMG;
                if ((mienGiamThemTiLe?.SoTien ?? 0).AlmostEqual(0) && (mienGiamThemSoTien?.SoTien ?? 0).AlmostEqual(0))
                {
                    yc.GhiChuMienGiamThem = null;
                    yc.NoiDungGhiChuMiemGiamId = null;
                }
                else
                {
                    yc.GhiChuMienGiamThem = chiphi.GhiChuMienGiamThem;
                    yc.NoiDungGhiChuMiemGiamId = chiphi.NoiDungGhiChuMiemGiamId;
                }
                #endregion
            }

            foreach (var chiphi in dsChiPhiDaChon.Where(o => o.LoaiNhom == NhomChiPhiNoiTru.GoiDichVu))
            {
                var yc = ycTiepNhan.BenhNhan.YeuCauGoiDichVus.First(o => o.Id == chiphi.Id);
                #region cong no update 02/02/2021
                foreach (var ycCongTyBaoHiemTuNhanCongNo in yc.CongTyBaoHiemTuNhanCongNos.Where(o => o.TaiKhoanBenhNhanThuId == null))
                {
                    ycCongTyBaoHiemTuNhanCongNo.WillDelete = true;
                }
                if (chiphi.TongCongNo > 0)
                {
                    foreach (var chiphiDanhSachCongNoChoThu in chiphi.DanhSachCongNoChoThus)
                    {
                        if (chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu.AlmostEqual(0))
                            continue;
                        yc.CongTyBaoHiemTuNhanCongNos.Add(new CongTyBaoHiemTuNhanCongNo
                        {
                            CongTyBaoHiemTuNhanId = chiphiDanhSachCongNoChoThu.CongTyBaoHiemTuNhanId,
                            SoTien = chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu
                        });
                    }
                }
                yc.SoTienBaoHiemTuNhanChiTra = chiphi.TongCongNo;
                #endregion
                #region mien giam update 02/02/2021
                foreach (var mienGiam in yc.MienGiamChiPhis.Where(o => o.TaiKhoanBenhNhanThuId == null))
                {
                    mienGiam.WillDelete = true;
                }
                //mien giam theo uu dai
                var mienGiamUuDai = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.DoiTuongUuDaiId != null && o.TiLe != 0);
                if (mienGiamUuDai != null)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                        DoiTuongUuDaiId = mienGiamUuDai.DoiTuongUuDaiId,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                        TiLe = mienGiamUuDai.TiLe.GetValueOrDefault(),
                        SoTien = mienGiamUuDai.SoTien
                    });
                }
                //mien giam theo voucher
                var mienGiamVouchers = chiphi.DanhSachMienGiamVos.Where(o => o.TheVoucherId != null).ToList();
                foreach (var voucher in mienGiamVouchers)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.Voucher,
                        TheVoucherId = voucher.TheVoucherId,
                        LoaiChietKhau = voucher.LoaiChietKhau,
                        MaTheVoucher = voucher.MaTheVoucher,
                        TiLe = voucher.TiLe.GetValueOrDefault(),
                        SoTien = voucher.SoTien
                    });
                }
                //mien giam them theo ti le
                var mienGiamThemTiLe = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoTiLe);
                if (mienGiamThemTiLe != null && mienGiamThemTiLe.TiLe.GetValueOrDefault() != 0)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                        TiLe = mienGiamThemTiLe.TiLe,
                        SoTien = mienGiamThemTiLe.SoTien
                    });
                }
                //mien giam them theo so tien
                var mienGiamThemSoTien = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoSoTien);
                if (mienGiamThemSoTien != null && !mienGiamThemSoTien.SoTien.AlmostEqual(0))
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoSoTien,
                        SoTien = mienGiamThemSoTien.SoTien
                    });
                }

                yc.SoTienMienGiam = chiphi.SoTienMG;
                if ((mienGiamThemTiLe?.SoTien ?? 0).AlmostEqual(0) && (mienGiamThemSoTien?.SoTien ?? 0).AlmostEqual(0))
                {
                    yc.GhiChuMienGiamThem = null;
                    yc.NoiDungGhiChuMiemGiamId = null;
                }
                else
                {
                    yc.GhiChuMienGiamThem = chiphi.GhiChuMienGiamThem;
                    yc.NoiDungGhiChuMiemGiamId = chiphi.NoiDungGhiChuMiemGiamId;
                }
                #endregion
            }

            foreach (var chiphi in dsChiPhiDaChon.Where(o => o.LoaiNhom == NhomChiPhiNoiTru.ToaThuoc))
            {
                var yc = chiphi.DichVuNgoaiTru ? yeuCauTiepNhanNgoaiTruCanQuyetToan.DonThuocThanhToans.SelectMany(o => o.DonThuocThanhToanChiTiets).First(o => o.Id == chiphi.Id) : ycTiepNhan.DonThuocThanhToans.SelectMany(o => o.DonThuocThanhToanChiTiets).First(o => o.Id == chiphi.Id);
                #region cong no update 02/02/2021
                foreach (var ycCongTyBaoHiemTuNhanCongNo in yc.CongTyBaoHiemTuNhanCongNos.Where(o => o.TaiKhoanBenhNhanThuId == null))
                {
                    ycCongTyBaoHiemTuNhanCongNo.WillDelete = true;
                }
                if (chiphi.TongCongNo > 0)
                {
                    foreach (var chiphiDanhSachCongNoChoThu in chiphi.DanhSachCongNoChoThus)
                    {
                        if (chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu.AlmostEqual(0))
                            continue;
                        yc.CongTyBaoHiemTuNhanCongNos.Add(new CongTyBaoHiemTuNhanCongNo
                        {
                            CongTyBaoHiemTuNhanId = chiphiDanhSachCongNoChoThu.CongTyBaoHiemTuNhanId,
                            SoTien = chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu
                        });
                    }
                }
                yc.SoTienBaoHiemTuNhanChiTra = chiphi.TongCongNo;
                #endregion
                #region mien giam update 02/02/2021
                foreach (var mienGiam in yc.MienGiamChiPhis.Where(o => o.TaiKhoanBenhNhanThuId == null))
                {
                    mienGiam.WillDelete = true;
                }
                //mien giam theo uu dai noi gioi thieu: BVHD-3882
                var mienGiamNoiGioiThieu = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.NoiGioiThieuId != null);
                if (mienGiamNoiGioiThieu != null)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                        NoiGioiThieuId = mienGiamNoiGioiThieu.NoiGioiThieuId,
                        LoaiChietKhau = mienGiamNoiGioiThieu.LoaiChietKhau,
                        TiLe = mienGiamNoiGioiThieu.TiLe,
                        SoTien = mienGiamNoiGioiThieu.SoTien
                    });
                }
                //mien giam theo uu dai
                var mienGiamUuDai = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.DoiTuongUuDaiId != null && o.TiLe != 0);
                if (mienGiamUuDai != null)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                        DoiTuongUuDaiId = mienGiamUuDai.DoiTuongUuDaiId,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                        TiLe = mienGiamUuDai.TiLe.GetValueOrDefault(),
                        SoTien = mienGiamUuDai.SoTien
                    });
                }
                //mien giam theo voucher
                var mienGiamVouchers = chiphi.DanhSachMienGiamVos.Where(o => o.TheVoucherId != null).ToList();
                foreach (var voucher in mienGiamVouchers)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.Voucher,
                        TheVoucherId = voucher.TheVoucherId,
                        LoaiChietKhau = voucher.LoaiChietKhau,
                        MaTheVoucher = voucher.MaTheVoucher,
                        TiLe = voucher.TiLe.GetValueOrDefault(),
                        SoTien = voucher.SoTien
                    });
                }
                //mien giam them theo ti le
                var mienGiamThemTiLe = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoTiLe);
                if (mienGiamThemTiLe != null && mienGiamThemTiLe.TiLe.GetValueOrDefault() != 0)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                        TiLe = mienGiamThemTiLe.TiLe,
                        SoTien = mienGiamThemTiLe.SoTien
                    });
                }
                //mien giam them theo so tien
                var mienGiamThemSoTien = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoSoTien);
                if (mienGiamThemSoTien != null && !mienGiamThemSoTien.SoTien.AlmostEqual(0))
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoSoTien,
                        SoTien = mienGiamThemSoTien.SoTien
                    });
                }

                yc.SoTienMienGiam = chiphi.SoTienMG;
                if ((mienGiamThemTiLe?.SoTien ?? 0).AlmostEqual(0) && (mienGiamThemSoTien?.SoTien ?? 0).AlmostEqual(0))
                {
                    yc.GhiChuMienGiamThem = null;
                    yc.NoiDungGhiChuMiemGiamId = null;
                }
                else
                {
                    yc.GhiChuMienGiamThem = chiphi.GhiChuMienGiamThem;
                    yc.NoiDungGhiChuMiemGiamId = chiphi.NoiDungGhiChuMiemGiamId;
                }
                #endregion
            }
            //await BaseRepository.UpdateAsync(ycTiepNhan);
            BaseRepository.Context.SaveChanges();
        }

        public async Task ApDungMiemGiamTuNoiGioiThieu(long yeuCauTiepNhanId)
        {
            var ycTiepNhan = BaseRepository.GetById(yeuCauTiepNhanId,
                x => x.Include(o => o.NoiTruBenhAn)                    
                    .Include(o => o.YeuCauKhamBenhs).ThenInclude(g => g.MienGiamChiPhis)
                    .Include(o => o.YeuCauDichVuKyThuats).ThenInclude(g => g.MienGiamChiPhis)
                    .Include(o => o.YeuCauDuocPhamBenhViens).ThenInclude(g => g.MienGiamChiPhis)
                    .Include(o => o.YeuCauVatTuBenhViens).ThenInclude(g => g.MienGiamChiPhis)
                    .Include(o => o.YeuCauTruyenMaus).ThenInclude(g => g.MienGiamChiPhis)
                    .Include(o => o.YeuCauDichVuGiuongBenhVienChiPhiBenhViens).ThenInclude(g => g.MienGiamChiPhis)
                    .Include(o => o.YeuCauDichVuGiuongBenhVienChiPhiBenhViens).ThenInclude(g => g.YeuCauDichVuGiuongBenhVienChiPhiBHYTs)
                    .Include(o => o.DonThuocThanhToans).ThenInclude(g => g.DonThuocThanhToanChiTiets).ThenInclude(g => g.MienGiamChiPhis)
                    .Include(o => o.BenhNhan).ThenInclude(o => o.TaiKhoanBenhNhan));

            long? yeuCauTiepNhanNgoaiTruCanQuyetToanId = ycTiepNhan.YeuCauTiepNhanNgoaiTruCanQuyetToanId;
            YeuCauTiepNhan yeuCauTiepNhanNgoaiTruCanQuyetToan = null;
            if (yeuCauTiepNhanNgoaiTruCanQuyetToanId != null)
            {
                yeuCauTiepNhanNgoaiTruCanQuyetToan = BaseRepository.GetById(yeuCauTiepNhanNgoaiTruCanQuyetToanId.Value,
                    x => x
                        .Include(o => o.YeuCauKhamBenhs).ThenInclude(g => g.MienGiamChiPhis)
                        .Include(o => o.YeuCauDichVuKyThuats).ThenInclude(g => g.MienGiamChiPhis)
                        .Include(o => o.YeuCauDuocPhamBenhViens).ThenInclude(g => g.MienGiamChiPhis)
                        .Include(o => o.YeuCauVatTuBenhViens).ThenInclude(g => g.MienGiamChiPhis)
                        .Include(o => o.DonThuocThanhToans).ThenInclude(g => g.DonThuocThanhToanChiTiets).ThenInclude(g => g.MienGiamChiPhis)                        
                        .Include(o => o.BenhNhan).ThenInclude(o => o.TaiKhoanBenhNhan));
            }

            var chiTietMienGiams = _noiGioiThieuChiTietMienGiamRepository.TableNoTracking.Where(o => o.NoiGioiThieuId == ycTiepNhan.NoiGioiThieuId).OrderByDescending(o => o.Id).ToList();

            foreach (var yc in ycTiepNhan.YeuCauKhamBenhs.Where(yc => yc.YeuCauGoiDichVuId == null && yc.GoiKhamSucKhoeId == null && yc.TrangThai != Enums.EnumTrangThaiYeuCauKhamBenh.HuyKham &&
                             (yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                              yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan)))
            {
                foreach (var mienGiam in yc.MienGiamChiPhis.Where(o => o.TaiKhoanBenhNhanThuId == null && o.NoiGioiThieuId != null))
                {
                    mienGiam.WillDelete = true;
                    yc.SoTienMienGiam = yc.SoTienMienGiam.GetValueOrDefault() - mienGiam.SoTien;
                }
                //mien giam theo uu dai noi gioi thieu: BVHD-3882
                var chiTietMienGiam = chiTietMienGiams.FirstOrDefault(o => o.DichVuKhamBenhBenhVienId == yc.DichVuKhamBenhBenhVienId && o.NhomGiaDichVuKhamBenhBenhVienId == yc.NhomGiaDichVuKhamBenhBenhVienId);
                if (chiTietMienGiam != null)
                {
                    var mienGiamChiPhi = new MienGiamChiPhi
                    {
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                        NoiGioiThieuId = chiTietMienGiam.NoiGioiThieuId,
                        LoaiChietKhau = chiTietMienGiam.LoaiChietKhau,
                        TiLe = chiTietMienGiam.TiLeChietKhau
                    };
                    if (chiTietMienGiam.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoTiLe)
                    {
                        var soTienTruocMienGiam = (yc.KhongTinhPhi == true ? 0 : (decimal)(1 * yc.Gia)) - (yc.BaoHiemChiTra == true ? (decimal)(1 * (yc.DonGiaBaoHiem.GetValueOrDefault() * yc.TiLeBaoHiemThanhToan.GetValueOrDefault() / 100 * yc.MucHuongBaoHiem.GetValueOrDefault() / 100)) : 0);
                        var soTienMienGiamTheoTiLe = Math.Round((soTienTruocMienGiam * chiTietMienGiam.TiLeChietKhau.GetValueOrDefault() / 100), 2, MidpointRounding.AwayFromZero);

                        mienGiamChiPhi.SoTien = soTienMienGiamTheoTiLe;
                        yc.SoTienMienGiam = yc.SoTienMienGiam.GetValueOrDefault() + soTienMienGiamTheoTiLe;
                    }
                    else
                    {
                        mienGiamChiPhi.SoTien = chiTietMienGiam.SoTienChietKhau.GetValueOrDefault();
                        yc.SoTienMienGiam = yc.SoTienMienGiam.GetValueOrDefault() + chiTietMienGiam.SoTienChietKhau.GetValueOrDefault();
                    }

                    yc.MienGiamChiPhis.Add(mienGiamChiPhi);
                }
            }

            foreach (var yc in ycTiepNhan.YeuCauDichVuKyThuats.Where(yc => yc.YeuCauGoiDichVuId == null && yc.GoiKhamSucKhoeId == null && yc.TrangThai != Enums.EnumTrangThaiYeuCauDichVuKyThuat.DaHuy &&
                             (yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                              yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan)))
            {
                foreach (var mienGiam in yc.MienGiamChiPhis.Where(o => o.TaiKhoanBenhNhanThuId == null && o.NoiGioiThieuId != null))
                {
                    mienGiam.WillDelete = true;
                    yc.SoTienMienGiam = yc.SoTienMienGiam.GetValueOrDefault() - mienGiam.SoTien;
                }
                //mien giam theo uu dai noi gioi thieu: BVHD-3882
                var chiTietMienGiam = chiTietMienGiams.FirstOrDefault(o => o.DichVuKyThuatBenhVienId == yc.DichVuKyThuatBenhVienId && o.NhomGiaDichVuKyThuatBenhVienId == yc.NhomGiaDichVuKyThuatBenhVienId);
                if (chiTietMienGiam != null)
                {
                    var mienGiamChiPhi = new MienGiamChiPhi
                    {
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                        NoiGioiThieuId = chiTietMienGiam.NoiGioiThieuId,
                        LoaiChietKhau = chiTietMienGiam.LoaiChietKhau,
                        TiLe = chiTietMienGiam.TiLeChietKhau
                    };
                    if (chiTietMienGiam.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoTiLe)
                    {
                        var soTienTruocMienGiam = (yc.KhongTinhPhi == true ? 0 : (decimal)(yc.SoLan * yc.Gia)) - (yc.BaoHiemChiTra == true ? (decimal)(yc.SoLan * (yc.DonGiaBaoHiem.GetValueOrDefault() * yc.TiLeBaoHiemThanhToan.GetValueOrDefault() / 100 * yc.MucHuongBaoHiem.GetValueOrDefault() / 100)) : 0);
                        var soTienMienGiamTheoTiLe = Math.Round((soTienTruocMienGiam * chiTietMienGiam.TiLeChietKhau.GetValueOrDefault() / 100), 2, MidpointRounding.AwayFromZero);

                        mienGiamChiPhi.SoTien = soTienMienGiamTheoTiLe;
                        yc.SoTienMienGiam = yc.SoTienMienGiam.GetValueOrDefault() + soTienMienGiamTheoTiLe;
                    }
                    else
                    {
                        mienGiamChiPhi.SoTien = (yc.SoLan * chiTietMienGiam.SoTienChietKhau.GetValueOrDefault());
                        yc.SoTienMienGiam = yc.SoTienMienGiam.GetValueOrDefault() + (yc.SoLan * chiTietMienGiam.SoTienChietKhau.GetValueOrDefault());
                    }

                    yc.MienGiamChiPhis.Add(mienGiamChiPhi);
                }
            }

            foreach (var yc in ycTiepNhan.YeuCauDichVuGiuongBenhVienChiPhiBenhViens.Where(yc => yc.YeuCauGoiDichVuId == null && 
                             (yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                              yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan)))
            {
                foreach (var mienGiam in yc.MienGiamChiPhis.Where(o => o.TaiKhoanBenhNhanThuId == null && o.NoiGioiThieuId != null))
                {
                    mienGiam.WillDelete = true;
                    yc.SoTienMienGiam = yc.SoTienMienGiam.GetValueOrDefault() - mienGiam.SoTien;
                }
                //mien giam theo uu dai noi gioi thieu: BVHD-3882
                var chiTietMienGiam = chiTietMienGiams.FirstOrDefault(o => o.DichVuGiuongBenhVienId == yc.DichVuGiuongBenhVienId && o.NhomGiaDichVuGiuongBenhVienId == yc.NhomGiaDichVuGiuongBenhVienId);
                if (chiTietMienGiam != null)
                {
                    var mienGiamChiPhi = new MienGiamChiPhi
                    {
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                        NoiGioiThieuId = chiTietMienGiam.NoiGioiThieuId,
                        LoaiChietKhau = chiTietMienGiam.LoaiChietKhau,
                        TiLe = chiTietMienGiam.TiLeChietKhau
                    };
                    if (chiTietMienGiam.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoTiLe)
                    {
                        decimal soTienBHYT = 0;
                        var chiPhiGiuongBHYT = yc.YeuCauDichVuGiuongBenhVienChiPhiBHYTs.FirstOrDefault();
                        if (chiPhiGiuongBHYT != null)
                        {
                            soTienBHYT = (chiPhiGiuongBHYT.BaoHiemChiTra == true ? ((decimal)chiPhiGiuongBHYT.SoLuong * (chiPhiGiuongBHYT.DonGiaBaoHiem.GetValueOrDefault() * chiPhiGiuongBHYT.TiLeBaoHiemThanhToan.GetValueOrDefault() / 100 * chiPhiGiuongBHYT.MucHuongBaoHiem.GetValueOrDefault() / 100)) : 0);                            
                        }

                        var soTienTruocMienGiam = ((decimal)yc.SoLuong * yc.Gia) - soTienBHYT;
                        var soTienMienGiamTheoTiLe = Math.Round((soTienTruocMienGiam * chiTietMienGiam.TiLeChietKhau.GetValueOrDefault() / 100), 2, MidpointRounding.AwayFromZero);

                        mienGiamChiPhi.SoTien = soTienMienGiamTheoTiLe;
                        yc.SoTienMienGiam = yc.SoTienMienGiam.GetValueOrDefault() + soTienMienGiamTheoTiLe;
                    }
                    else
                    {
                        mienGiamChiPhi.SoTien = ((decimal)yc.SoLuong * chiTietMienGiam.SoTienChietKhau.GetValueOrDefault());
                        yc.SoTienMienGiam = yc.SoTienMienGiam.GetValueOrDefault() + ((decimal)yc.SoLuong * chiTietMienGiam.SoTienChietKhau.GetValueOrDefault());
                    }
                    yc.MienGiamChiPhis.Add(mienGiamChiPhi);
                }
            }

            foreach (var yc in ycTiepNhan.YeuCauDuocPhamBenhViens.Where(yc => yc.YeuCauGoiDichVuId == null && yc.TrangThai != Enums.EnumYeuCauDuocPhamBenhVien.DaHuy &&
                             (yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                              yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan)))
            {
                foreach (var mienGiam in yc.MienGiamChiPhis.Where(o => o.TaiKhoanBenhNhanThuId == null && o.NoiGioiThieuId != null))
                {
                    mienGiam.WillDelete = true;
                    yc.SoTienMienGiam = yc.SoTienMienGiam.GetValueOrDefault() - mienGiam.SoTien;
                }
                //mien giam theo uu dai noi gioi thieu: BVHD-3882
                var chiTietMienGiam = chiTietMienGiams.FirstOrDefault(o => o.DuocPhamBenhVienId == yc.DuocPhamBenhVienId);
                if (chiTietMienGiam != null)
                {
                    var mienGiamChiPhi = new MienGiamChiPhi
                    {
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                        NoiGioiThieuId = chiTietMienGiam.NoiGioiThieuId,
                        LoaiChietKhau = chiTietMienGiam.LoaiChietKhau,
                        TiLe = chiTietMienGiam.TiLeChietKhau
                    };
                    if (chiTietMienGiam.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoTiLe)
                    {
                        var soTienTruocMienGiam = (yc.KhongTinhPhi == true ? 0 : (decimal)((decimal)yc.SoLuong * yc.DonGiaBan)) - (yc.BaoHiemChiTra == true ? (decimal)((decimal)yc.SoLuong * (yc.DonGiaBaoHiem.GetValueOrDefault() * yc.TiLeBaoHiemThanhToan.GetValueOrDefault() / 100 * yc.MucHuongBaoHiem.GetValueOrDefault() / 100)) : 0);
                        var soTienMienGiamTheoTiLe = Math.Round((soTienTruocMienGiam * chiTietMienGiam.TiLeChietKhau.GetValueOrDefault() / 100), 2, MidpointRounding.AwayFromZero);

                        mienGiamChiPhi.SoTien = soTienMienGiamTheoTiLe;
                        yc.SoTienMienGiam = yc.SoTienMienGiam.GetValueOrDefault() + soTienMienGiamTheoTiLe;
                    }
                    else
                    {
                        mienGiamChiPhi.SoTien = (decimal)yc.SoLuong * chiTietMienGiam.SoTienChietKhau.GetValueOrDefault();
                        yc.SoTienMienGiam = yc.SoTienMienGiam.GetValueOrDefault() + ((decimal)yc.SoLuong * chiTietMienGiam.SoTienChietKhau.GetValueOrDefault());
                    }

                    yc.MienGiamChiPhis.Add(mienGiamChiPhi);
                }
            }

            foreach (var yc in ycTiepNhan.YeuCauVatTuBenhViens.Where(yc => yc.YeuCauGoiDichVuId == null && yc.TrangThai != Enums.EnumYeuCauVatTuBenhVien.DaHuy &&
                             (yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                              yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan)))
            {
                foreach (var mienGiam in yc.MienGiamChiPhis.Where(o => o.TaiKhoanBenhNhanThuId == null && o.NoiGioiThieuId != null))
                {
                    mienGiam.WillDelete = true;
                    yc.SoTienMienGiam = yc.SoTienMienGiam.GetValueOrDefault() - mienGiam.SoTien;
                }
                //mien giam theo uu dai noi gioi thieu: BVHD-3882
                var chiTietMienGiam = chiTietMienGiams.FirstOrDefault(o => o.VatTuBenhVienId == yc.VatTuBenhVienId);
                if (chiTietMienGiam != null)
                {
                    var mienGiamChiPhi = new MienGiamChiPhi
                    {
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                        NoiGioiThieuId = chiTietMienGiam.NoiGioiThieuId,
                        LoaiChietKhau = chiTietMienGiam.LoaiChietKhau,
                        TiLe = chiTietMienGiam.TiLeChietKhau
                    };
                    if (chiTietMienGiam.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoTiLe)
                    {
                        var soTienTruocMienGiam = (yc.KhongTinhPhi == true ? 0 : (decimal)((decimal)yc.SoLuong * yc.DonGiaBan)) - (yc.BaoHiemChiTra == true ? (decimal)((decimal)yc.SoLuong * (yc.DonGiaBaoHiem.GetValueOrDefault() * yc.TiLeBaoHiemThanhToan.GetValueOrDefault() / 100 * yc.MucHuongBaoHiem.GetValueOrDefault() / 100)) : 0);
                        var soTienMienGiamTheoTiLe = Math.Round((soTienTruocMienGiam * chiTietMienGiam.TiLeChietKhau.GetValueOrDefault() / 100), 2, MidpointRounding.AwayFromZero);

                        mienGiamChiPhi.SoTien = soTienMienGiamTheoTiLe;
                        yc.SoTienMienGiam = yc.SoTienMienGiam.GetValueOrDefault() + soTienMienGiamTheoTiLe;
                    }
                    else
                    {
                        mienGiamChiPhi.SoTien = (decimal)yc.SoLuong * chiTietMienGiam.SoTienChietKhau.GetValueOrDefault();
                        yc.SoTienMienGiam = yc.SoTienMienGiam.GetValueOrDefault() + ((decimal)yc.SoLuong * chiTietMienGiam.SoTienChietKhau.GetValueOrDefault());
                    }

                    yc.MienGiamChiPhis.Add(mienGiamChiPhi);
                }
            }

            foreach (var yc in ycTiepNhan.DonThuocThanhToans
                .Where(dt => dt.LoaiDonThuoc == Enums.EnumLoaiDonThuoc.ThuocBHYT && dt.TrangThai != Enums.TrangThaiDonThuocThanhToan.DaHuy &&
                    (dt.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || dt.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                     dt.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                .SelectMany(o => o.DonThuocThanhToanChiTiets))
            {
                foreach (var mienGiam in yc.MienGiamChiPhis.Where(o => o.TaiKhoanBenhNhanThuId == null && o.NoiGioiThieuId != null))
                {
                    mienGiam.WillDelete = true;
                    yc.SoTienMienGiam = yc.SoTienMienGiam.GetValueOrDefault() - mienGiam.SoTien;
                }
                //mien giam theo uu dai noi gioi thieu: BVHD-3882
                var chiTietMienGiam = chiTietMienGiams.FirstOrDefault(o => o.DuocPhamBenhVienId == yc.DuocPhamId);
                if (chiTietMienGiam != null)
                {
                    var mienGiamChiPhi = new MienGiamChiPhi
                    {
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                        NoiGioiThieuId = chiTietMienGiam.NoiGioiThieuId,
                        LoaiChietKhau = chiTietMienGiam.LoaiChietKhau,
                        TiLe = chiTietMienGiam.TiLeChietKhau
                    };
                    if (chiTietMienGiam.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoTiLe)
                    {
                        var soTienTruocMienGiam = (decimal)((decimal)yc.SoLuong * yc.DonGiaBan) - (yc.BaoHiemChiTra == true ? (decimal)((decimal)yc.SoLuong * (yc.DonGiaBaoHiem.GetValueOrDefault() * yc.TiLeBaoHiemThanhToan.GetValueOrDefault() / 100 * yc.MucHuongBaoHiem.GetValueOrDefault() / 100)) : 0);
                        var soTienMienGiamTheoTiLe = Math.Round((soTienTruocMienGiam * chiTietMienGiam.TiLeChietKhau.GetValueOrDefault() / 100), 2, MidpointRounding.AwayFromZero);

                        mienGiamChiPhi.SoTien = soTienMienGiamTheoTiLe;
                        yc.SoTienMienGiam = yc.SoTienMienGiam.GetValueOrDefault() + soTienMienGiamTheoTiLe;
                    }
                    else
                    {
                        mienGiamChiPhi.SoTien = (decimal)yc.SoLuong * chiTietMienGiam.SoTienChietKhau.GetValueOrDefault();
                        yc.SoTienMienGiam = yc.SoTienMienGiam.GetValueOrDefault() + ((decimal)yc.SoLuong * chiTietMienGiam.SoTienChietKhau.GetValueOrDefault());
                    }

                    yc.MienGiamChiPhis.Add(mienGiamChiPhi);
                }
            }

            if(yeuCauTiepNhanNgoaiTruCanQuyetToan != null)
            {
                foreach (var yc in yeuCauTiepNhanNgoaiTruCanQuyetToan.YeuCauKhamBenhs.Where(yc => yc.YeuCauGoiDichVuId == null && yc.GoiKhamSucKhoeId == null && yc.TrangThai != Enums.EnumTrangThaiYeuCauKhamBenh.HuyKham &&
                             (yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                              yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan)))
                {
                    foreach (var mienGiam in yc.MienGiamChiPhis.Where(o => o.TaiKhoanBenhNhanThuId == null && o.NoiGioiThieuId != null))
                    {
                        mienGiam.WillDelete = true;
                        yc.SoTienMienGiam = yc.SoTienMienGiam.GetValueOrDefault() - mienGiam.SoTien;
                    }
                    //mien giam theo uu dai noi gioi thieu: BVHD-3882
                    var chiTietMienGiam = chiTietMienGiams.FirstOrDefault(o => o.DichVuKhamBenhBenhVienId == yc.DichVuKhamBenhBenhVienId && o.NhomGiaDichVuKhamBenhBenhVienId == yc.NhomGiaDichVuKhamBenhBenhVienId);
                    if (chiTietMienGiam != null)
                    {
                        var mienGiamChiPhi = new MienGiamChiPhi
                        {
                            YeuCauTiepNhanId = yeuCauTiepNhanNgoaiTruCanQuyetToan.Id,
                            LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                            NoiGioiThieuId = chiTietMienGiam.NoiGioiThieuId,
                            LoaiChietKhau = chiTietMienGiam.LoaiChietKhau,
                            TiLe = chiTietMienGiam.TiLeChietKhau
                        };
                        if (chiTietMienGiam.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoTiLe)
                        {
                            var soTienTruocMienGiam = (yc.KhongTinhPhi == true ? 0 : (decimal)(1 * yc.Gia)) - (yc.BaoHiemChiTra == true ? (decimal)(1 * (yc.DonGiaBaoHiem.GetValueOrDefault() * yc.TiLeBaoHiemThanhToan.GetValueOrDefault() / 100 * yc.MucHuongBaoHiem.GetValueOrDefault() / 100)) : 0);
                            var soTienMienGiamTheoTiLe = Math.Round((soTienTruocMienGiam * chiTietMienGiam.TiLeChietKhau.GetValueOrDefault() / 100), 2, MidpointRounding.AwayFromZero);

                            mienGiamChiPhi.SoTien = soTienMienGiamTheoTiLe;
                            yc.SoTienMienGiam = yc.SoTienMienGiam.GetValueOrDefault() + soTienMienGiamTheoTiLe;
                        }
                        else
                        {
                            mienGiamChiPhi.SoTien = chiTietMienGiam.SoTienChietKhau.GetValueOrDefault();
                            yc.SoTienMienGiam = yc.SoTienMienGiam.GetValueOrDefault() + chiTietMienGiam.SoTienChietKhau.GetValueOrDefault();
                        }

                        yc.MienGiamChiPhis.Add(mienGiamChiPhi);
                    }
                }

                foreach (var yc in yeuCauTiepNhanNgoaiTruCanQuyetToan.YeuCauDichVuKyThuats.Where(yc => yc.YeuCauGoiDichVuId == null && yc.GoiKhamSucKhoeId == null && yc.TrangThai != Enums.EnumTrangThaiYeuCauDichVuKyThuat.DaHuy &&
                                 (yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                                  yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan)))
                {
                    foreach (var mienGiam in yc.MienGiamChiPhis.Where(o => o.TaiKhoanBenhNhanThuId == null && o.NoiGioiThieuId != null))
                    {
                        mienGiam.WillDelete = true;
                        yc.SoTienMienGiam = yc.SoTienMienGiam.GetValueOrDefault() - mienGiam.SoTien;
                    }
                    //mien giam theo uu dai noi gioi thieu: BVHD-3882
                    var chiTietMienGiam = chiTietMienGiams.FirstOrDefault(o => o.DichVuKyThuatBenhVienId == yc.DichVuKyThuatBenhVienId && o.NhomGiaDichVuKyThuatBenhVienId == yc.NhomGiaDichVuKyThuatBenhVienId);
                    if (chiTietMienGiam != null)
                    {
                        var mienGiamChiPhi = new MienGiamChiPhi
                        {
                            YeuCauTiepNhanId = yeuCauTiepNhanNgoaiTruCanQuyetToan.Id,
                            LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                            NoiGioiThieuId = chiTietMienGiam.NoiGioiThieuId,
                            LoaiChietKhau = chiTietMienGiam.LoaiChietKhau,
                            TiLe = chiTietMienGiam.TiLeChietKhau
                        };
                        if (chiTietMienGiam.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoTiLe)
                        {
                            var soTienTruocMienGiam = (yc.KhongTinhPhi == true ? 0 : (decimal)(yc.SoLan * yc.Gia)) - (yc.BaoHiemChiTra == true ? (decimal)(yc.SoLan * (yc.DonGiaBaoHiem.GetValueOrDefault() * yc.TiLeBaoHiemThanhToan.GetValueOrDefault() / 100 * yc.MucHuongBaoHiem.GetValueOrDefault() / 100)) : 0);
                            var soTienMienGiamTheoTiLe = Math.Round((soTienTruocMienGiam * chiTietMienGiam.TiLeChietKhau.GetValueOrDefault() / 100), 2, MidpointRounding.AwayFromZero);

                            mienGiamChiPhi.SoTien = soTienMienGiamTheoTiLe;
                            yc.SoTienMienGiam = yc.SoTienMienGiam.GetValueOrDefault() + soTienMienGiamTheoTiLe;
                        }
                        else
                        {
                            mienGiamChiPhi.SoTien = (yc.SoLan * chiTietMienGiam.SoTienChietKhau.GetValueOrDefault());
                            yc.SoTienMienGiam = yc.SoTienMienGiam.GetValueOrDefault() + (yc.SoLan * chiTietMienGiam.SoTienChietKhau.GetValueOrDefault());
                        }

                        yc.MienGiamChiPhis.Add(mienGiamChiPhi);
                    }
                }                

                foreach (var yc in yeuCauTiepNhanNgoaiTruCanQuyetToan.YeuCauDuocPhamBenhViens.Where(yc => yc.YeuCauGoiDichVuId == null && yc.TrangThai != Enums.EnumYeuCauDuocPhamBenhVien.DaHuy &&
                                 (yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                                  yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan)))
                {
                    foreach (var mienGiam in yc.MienGiamChiPhis.Where(o => o.TaiKhoanBenhNhanThuId == null && o.NoiGioiThieuId != null))
                    {
                        mienGiam.WillDelete = true;
                        yc.SoTienMienGiam = yc.SoTienMienGiam.GetValueOrDefault() - mienGiam.SoTien;
                    }
                    //mien giam theo uu dai noi gioi thieu: BVHD-3882
                    var chiTietMienGiam = chiTietMienGiams.FirstOrDefault(o => o.DuocPhamBenhVienId == yc.DuocPhamBenhVienId);
                    if (chiTietMienGiam != null)
                    {
                        var mienGiamChiPhi = new MienGiamChiPhi
                        {
                            YeuCauTiepNhanId = yeuCauTiepNhanNgoaiTruCanQuyetToan.Id,
                            LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                            NoiGioiThieuId = chiTietMienGiam.NoiGioiThieuId,
                            LoaiChietKhau = chiTietMienGiam.LoaiChietKhau,
                            TiLe = chiTietMienGiam.TiLeChietKhau
                        };
                        if (chiTietMienGiam.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoTiLe)
                        {
                            var soTienTruocMienGiam = (yc.KhongTinhPhi == true ? 0 : (decimal)((decimal)yc.SoLuong * yc.DonGiaBan)) - (yc.BaoHiemChiTra == true ? (decimal)((decimal)yc.SoLuong * (yc.DonGiaBaoHiem.GetValueOrDefault() * yc.TiLeBaoHiemThanhToan.GetValueOrDefault() / 100 * yc.MucHuongBaoHiem.GetValueOrDefault() / 100)) : 0);
                            var soTienMienGiamTheoTiLe = Math.Round((soTienTruocMienGiam * chiTietMienGiam.TiLeChietKhau.GetValueOrDefault() / 100), 2, MidpointRounding.AwayFromZero);

                            mienGiamChiPhi.SoTien = soTienMienGiamTheoTiLe;
                            yc.SoTienMienGiam = yc.SoTienMienGiam.GetValueOrDefault() + soTienMienGiamTheoTiLe;
                        }
                        else
                        {
                            mienGiamChiPhi.SoTien = (decimal)yc.SoLuong * chiTietMienGiam.SoTienChietKhau.GetValueOrDefault();
                            yc.SoTienMienGiam = yc.SoTienMienGiam.GetValueOrDefault() + ((decimal)yc.SoLuong * chiTietMienGiam.SoTienChietKhau.GetValueOrDefault());
                        }

                        yc.MienGiamChiPhis.Add(mienGiamChiPhi);
                    }
                }

                foreach (var yc in yeuCauTiepNhanNgoaiTruCanQuyetToan.YeuCauVatTuBenhViens.Where(yc => yc.YeuCauGoiDichVuId == null && yc.TrangThai != Enums.EnumYeuCauVatTuBenhVien.DaHuy &&
                                 (yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                                  yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan)))
                {
                    foreach (var mienGiam in yc.MienGiamChiPhis.Where(o => o.TaiKhoanBenhNhanThuId == null && o.NoiGioiThieuId != null))
                    {
                        mienGiam.WillDelete = true;
                        yc.SoTienMienGiam = yc.SoTienMienGiam.GetValueOrDefault() - mienGiam.SoTien;
                    }
                    //mien giam theo uu dai noi gioi thieu: BVHD-3882
                    var chiTietMienGiam = chiTietMienGiams.FirstOrDefault(o => o.VatTuBenhVienId == yc.VatTuBenhVienId);
                    if (chiTietMienGiam != null)
                    {
                        var mienGiamChiPhi = new MienGiamChiPhi
                        {
                            YeuCauTiepNhanId = yeuCauTiepNhanNgoaiTruCanQuyetToan.Id,
                            LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                            NoiGioiThieuId = chiTietMienGiam.NoiGioiThieuId,
                            LoaiChietKhau = chiTietMienGiam.LoaiChietKhau,
                            TiLe = chiTietMienGiam.TiLeChietKhau
                        };
                        if (chiTietMienGiam.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoTiLe)
                        {
                            var soTienTruocMienGiam = (yc.KhongTinhPhi == true ? 0 : (decimal)((decimal)yc.SoLuong * yc.DonGiaBan)) - (yc.BaoHiemChiTra == true ? (decimal)((decimal)yc.SoLuong * (yc.DonGiaBaoHiem.GetValueOrDefault() * yc.TiLeBaoHiemThanhToan.GetValueOrDefault() / 100 * yc.MucHuongBaoHiem.GetValueOrDefault() / 100)) : 0);
                            var soTienMienGiamTheoTiLe = Math.Round((soTienTruocMienGiam * chiTietMienGiam.TiLeChietKhau.GetValueOrDefault() / 100), 2, MidpointRounding.AwayFromZero);

                            mienGiamChiPhi.SoTien = soTienMienGiamTheoTiLe;
                            yc.SoTienMienGiam = yc.SoTienMienGiam.GetValueOrDefault() + soTienMienGiamTheoTiLe;
                        }
                        else
                        {
                            mienGiamChiPhi.SoTien = (decimal)yc.SoLuong * chiTietMienGiam.SoTienChietKhau.GetValueOrDefault();
                            yc.SoTienMienGiam = yc.SoTienMienGiam.GetValueOrDefault() + ((decimal)yc.SoLuong * chiTietMienGiam.SoTienChietKhau.GetValueOrDefault());
                        }

                        yc.MienGiamChiPhis.Add(mienGiamChiPhi);
                    }
                }

                foreach (var yc in yeuCauTiepNhanNgoaiTruCanQuyetToan.DonThuocThanhToans
                    .Where(dt => dt.LoaiDonThuoc == Enums.EnumLoaiDonThuoc.ThuocBHYT && dt.TrangThai != Enums.TrangThaiDonThuocThanhToan.DaHuy &&
                        (dt.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || dt.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                         dt.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                    .SelectMany(o => o.DonThuocThanhToanChiTiets))
                {
                    foreach (var mienGiam in yc.MienGiamChiPhis.Where(o => o.TaiKhoanBenhNhanThuId == null && o.NoiGioiThieuId != null))
                    {
                        mienGiam.WillDelete = true;
                        yc.SoTienMienGiam = yc.SoTienMienGiam.GetValueOrDefault() - mienGiam.SoTien;
                    }
                    //mien giam theo uu dai noi gioi thieu: BVHD-3882
                    var chiTietMienGiam = chiTietMienGiams.FirstOrDefault(o => o.DuocPhamBenhVienId == yc.DuocPhamId);
                    if (chiTietMienGiam != null)
                    {
                        var mienGiamChiPhi = new MienGiamChiPhi
                        {
                            YeuCauTiepNhanId = yeuCauTiepNhanNgoaiTruCanQuyetToan.Id,
                            LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                            NoiGioiThieuId = chiTietMienGiam.NoiGioiThieuId,
                            LoaiChietKhau = chiTietMienGiam.LoaiChietKhau,
                            TiLe = chiTietMienGiam.TiLeChietKhau
                        };
                        if (chiTietMienGiam.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoTiLe)
                        {
                            var soTienTruocMienGiam = (decimal)((decimal)yc.SoLuong * yc.DonGiaBan) - (yc.BaoHiemChiTra == true ? (decimal)((decimal)yc.SoLuong * (yc.DonGiaBaoHiem.GetValueOrDefault() * yc.TiLeBaoHiemThanhToan.GetValueOrDefault() / 100 * yc.MucHuongBaoHiem.GetValueOrDefault() / 100)) : 0);
                            var soTienMienGiamTheoTiLe = Math.Round((soTienTruocMienGiam * chiTietMienGiam.TiLeChietKhau.GetValueOrDefault() / 100), 2, MidpointRounding.AwayFromZero);

                            mienGiamChiPhi.SoTien = soTienMienGiamTheoTiLe;
                            yc.SoTienMienGiam = yc.SoTienMienGiam.GetValueOrDefault() + soTienMienGiamTheoTiLe;
                        }
                        else
                        {
                            mienGiamChiPhi.SoTien = (decimal)yc.SoLuong * chiTietMienGiam.SoTienChietKhau.GetValueOrDefault();
                            yc.SoTienMienGiam = yc.SoTienMienGiam.GetValueOrDefault() + ((decimal)yc.SoLuong * chiTietMienGiam.SoTienChietKhau.GetValueOrDefault());
                        }

                        yc.MienGiamChiPhis.Add(mienGiamChiPhi);
                    }
                }
            }

            BaseRepository.Context.SaveChanges();
        }

        public async Task HuyApDungMiemGiamTuNoiGioiThieu(long yeuCauTiepNhanId)
        {
            var ycTiepNhan = BaseRepository.GetById(yeuCauTiepNhanId,
                x => x.Include(o => o.NoiTruBenhAn)
                    .Include(o => o.YeuCauKhamBenhs).ThenInclude(g => g.MienGiamChiPhis)
                    .Include(o => o.YeuCauDichVuKyThuats).ThenInclude(g => g.MienGiamChiPhis)
                    .Include(o => o.YeuCauDuocPhamBenhViens).ThenInclude(g => g.MienGiamChiPhis)
                    .Include(o => o.YeuCauVatTuBenhViens).ThenInclude(g => g.MienGiamChiPhis)
                    .Include(o => o.YeuCauTruyenMaus).ThenInclude(g => g.MienGiamChiPhis)
                    .Include(o => o.YeuCauDichVuGiuongBenhVienChiPhiBenhViens).ThenInclude(g => g.MienGiamChiPhis)
                    .Include(o => o.YeuCauDichVuGiuongBenhVienChiPhiBenhViens).ThenInclude(g => g.YeuCauDichVuGiuongBenhVienChiPhiBHYTs)
                    .Include(o => o.DonThuocThanhToans).ThenInclude(g => g.DonThuocThanhToanChiTiets).ThenInclude(g => g.MienGiamChiPhis)
                    .Include(o => o.BenhNhan).ThenInclude(o => o.TaiKhoanBenhNhan));

            long? yeuCauTiepNhanNgoaiTruCanQuyetToanId = ycTiepNhan.YeuCauTiepNhanNgoaiTruCanQuyetToanId;
            YeuCauTiepNhan yeuCauTiepNhanNgoaiTruCanQuyetToan = null;
            if (yeuCauTiepNhanNgoaiTruCanQuyetToanId != null)
            {
                yeuCauTiepNhanNgoaiTruCanQuyetToan = BaseRepository.GetById(yeuCauTiepNhanNgoaiTruCanQuyetToanId.Value,
                    x => x
                        .Include(o => o.YeuCauKhamBenhs).ThenInclude(g => g.MienGiamChiPhis)
                        .Include(o => o.YeuCauDichVuKyThuats).ThenInclude(g => g.MienGiamChiPhis)
                        .Include(o => o.YeuCauDuocPhamBenhViens).ThenInclude(g => g.MienGiamChiPhis)
                        .Include(o => o.YeuCauVatTuBenhViens).ThenInclude(g => g.MienGiamChiPhis)
                        .Include(o => o.DonThuocThanhToans).ThenInclude(g => g.DonThuocThanhToanChiTiets).ThenInclude(g => g.MienGiamChiPhis)
                        .Include(o => o.BenhNhan).ThenInclude(o => o.TaiKhoanBenhNhan));
            }

            var chiTietMienGiams = _noiGioiThieuChiTietMienGiamRepository.TableNoTracking.Where(o => o.NoiGioiThieuId == ycTiepNhan.NoiGioiThieuId).OrderByDescending(o => o.Id).ToList();

            foreach (var yc in ycTiepNhan.YeuCauKhamBenhs.Where(yc => yc.YeuCauGoiDichVuId == null && yc.GoiKhamSucKhoeId == null && yc.TrangThai != Enums.EnumTrangThaiYeuCauKhamBenh.HuyKham &&
                             (yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                              yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan)))
            {
                foreach (var mienGiam in yc.MienGiamChiPhis.Where(o => o.TaiKhoanBenhNhanThuId == null && o.NoiGioiThieuId != null))
                {
                    mienGiam.WillDelete = true;
                    yc.SoTienMienGiam = yc.SoTienMienGiam.GetValueOrDefault() - mienGiam.SoTien;
                }
            }

            foreach (var yc in ycTiepNhan.YeuCauDichVuKyThuats.Where(yc => yc.YeuCauGoiDichVuId == null && yc.GoiKhamSucKhoeId == null && yc.TrangThai != Enums.EnumTrangThaiYeuCauDichVuKyThuat.DaHuy &&
                             (yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                              yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan)))
            {
                foreach (var mienGiam in yc.MienGiamChiPhis.Where(o => o.TaiKhoanBenhNhanThuId == null && o.NoiGioiThieuId != null))
                {
                    mienGiam.WillDelete = true;
                    yc.SoTienMienGiam = yc.SoTienMienGiam.GetValueOrDefault() - mienGiam.SoTien;
                }
            }

            foreach (var yc in ycTiepNhan.YeuCauDichVuGiuongBenhVienChiPhiBenhViens.Where(yc => yc.YeuCauGoiDichVuId == null &&
                             (yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                              yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan)))
            {
                foreach (var mienGiam in yc.MienGiamChiPhis.Where(o => o.TaiKhoanBenhNhanThuId == null && o.NoiGioiThieuId != null))
                {
                    mienGiam.WillDelete = true;
                    yc.SoTienMienGiam = yc.SoTienMienGiam.GetValueOrDefault() - mienGiam.SoTien;
                }
            }

            foreach (var yc in ycTiepNhan.YeuCauDuocPhamBenhViens.Where(yc => yc.YeuCauGoiDichVuId == null && yc.TrangThai != Enums.EnumYeuCauDuocPhamBenhVien.DaHuy &&
                             (yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                              yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan)))
            {
                foreach (var mienGiam in yc.MienGiamChiPhis.Where(o => o.TaiKhoanBenhNhanThuId == null && o.NoiGioiThieuId != null))
                {
                    mienGiam.WillDelete = true;
                    yc.SoTienMienGiam = yc.SoTienMienGiam.GetValueOrDefault() - mienGiam.SoTien;
                }
            }

            foreach (var yc in ycTiepNhan.YeuCauVatTuBenhViens.Where(yc => yc.YeuCauGoiDichVuId == null && yc.TrangThai != Enums.EnumYeuCauVatTuBenhVien.DaHuy &&
                             (yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                              yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan)))
            {
                foreach (var mienGiam in yc.MienGiamChiPhis.Where(o => o.TaiKhoanBenhNhanThuId == null && o.NoiGioiThieuId != null))
                {
                    mienGiam.WillDelete = true;
                    yc.SoTienMienGiam = yc.SoTienMienGiam.GetValueOrDefault() - mienGiam.SoTien;
                }
            }

            foreach (var yc in ycTiepNhan.DonThuocThanhToans
                .Where(dt => dt.LoaiDonThuoc == Enums.EnumLoaiDonThuoc.ThuocBHYT && dt.TrangThai != Enums.TrangThaiDonThuocThanhToan.DaHuy &&
                    (dt.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || dt.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                     dt.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                .SelectMany(o => o.DonThuocThanhToanChiTiets))
            {
                foreach (var mienGiam in yc.MienGiamChiPhis.Where(o => o.TaiKhoanBenhNhanThuId == null && o.NoiGioiThieuId != null))
                {
                    mienGiam.WillDelete = true;
                    yc.SoTienMienGiam = yc.SoTienMienGiam.GetValueOrDefault() - mienGiam.SoTien;
                }
            }

            if (yeuCauTiepNhanNgoaiTruCanQuyetToan != null)
            {
                foreach (var yc in yeuCauTiepNhanNgoaiTruCanQuyetToan.YeuCauKhamBenhs.Where(yc => yc.YeuCauGoiDichVuId == null && yc.GoiKhamSucKhoeId == null && yc.TrangThai != Enums.EnumTrangThaiYeuCauKhamBenh.HuyKham &&
                             (yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                              yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan)))
                {
                    foreach (var mienGiam in yc.MienGiamChiPhis.Where(o => o.TaiKhoanBenhNhanThuId == null && o.NoiGioiThieuId != null))
                    {
                        mienGiam.WillDelete = true;
                        yc.SoTienMienGiam = yc.SoTienMienGiam.GetValueOrDefault() - mienGiam.SoTien;
                    }
                }

                foreach (var yc in yeuCauTiepNhanNgoaiTruCanQuyetToan.YeuCauDichVuKyThuats.Where(yc => yc.YeuCauGoiDichVuId == null && yc.GoiKhamSucKhoeId == null && yc.TrangThai != Enums.EnumTrangThaiYeuCauDichVuKyThuat.DaHuy &&
                                 (yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                                  yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan)))
                {
                    foreach (var mienGiam in yc.MienGiamChiPhis.Where(o => o.TaiKhoanBenhNhanThuId == null && o.NoiGioiThieuId != null))
                    {
                        mienGiam.WillDelete = true;
                        yc.SoTienMienGiam = yc.SoTienMienGiam.GetValueOrDefault() - mienGiam.SoTien;
                    }
                }

                foreach (var yc in yeuCauTiepNhanNgoaiTruCanQuyetToan.YeuCauDuocPhamBenhViens.Where(yc => yc.YeuCauGoiDichVuId == null && yc.TrangThai != Enums.EnumYeuCauDuocPhamBenhVien.DaHuy &&
                                 (yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                                  yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan)))
                {
                    foreach (var mienGiam in yc.MienGiamChiPhis.Where(o => o.TaiKhoanBenhNhanThuId == null && o.NoiGioiThieuId != null))
                    {
                        mienGiam.WillDelete = true;
                        yc.SoTienMienGiam = yc.SoTienMienGiam.GetValueOrDefault() - mienGiam.SoTien;
                    }
                }

                foreach (var yc in yeuCauTiepNhanNgoaiTruCanQuyetToan.YeuCauVatTuBenhViens.Where(yc => yc.YeuCauGoiDichVuId == null && yc.TrangThai != Enums.EnumYeuCauVatTuBenhVien.DaHuy &&
                                 (yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                                  yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan)))
                {
                    foreach (var mienGiam in yc.MienGiamChiPhis.Where(o => o.TaiKhoanBenhNhanThuId == null && o.NoiGioiThieuId != null))
                    {
                        mienGiam.WillDelete = true;
                        yc.SoTienMienGiam = yc.SoTienMienGiam.GetValueOrDefault() - mienGiam.SoTien;
                    }
                }

                foreach (var yc in yeuCauTiepNhanNgoaiTruCanQuyetToan.DonThuocThanhToans
                    .Where(dt => dt.LoaiDonThuoc == Enums.EnumLoaiDonThuoc.ThuocBHYT && dt.TrangThai != Enums.TrangThaiDonThuocThanhToan.DaHuy &&
                        (dt.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || dt.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                         dt.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                    .SelectMany(o => o.DonThuocThanhToanChiTiets))
                {
                    foreach (var mienGiam in yc.MienGiamChiPhis.Where(o => o.TaiKhoanBenhNhanThuId == null && o.NoiGioiThieuId != null))
                    {
                        mienGiam.WillDelete = true;
                        yc.SoTienMienGiam = yc.SoTienMienGiam.GetValueOrDefault() - mienGiam.SoTien;
                    }
                }
            }

            BaseRepository.Context.SaveChanges();
        }

        public async Task<(long, string)> HoanThuDichVu(ChiPhiKhamChuaBenhNoiTruVo chiPhiKhamChuaBenhNoiTruVo)
        {
            if (chiPhiKhamChuaBenhNoiTruVo.TaiKhoanBenhNhanChiId.GetValueOrDefault(0) == 0)
                return (0, "Dịch vụ cần hoàn thu không đúng");
            var taiKhoanBenhNhanChi = await _taiKhoanBenhNhanChiRepository.GetByIdAsync(chiPhiKhamChuaBenhNoiTruVo.TaiKhoanBenhNhanChiId.Value,
                o => o.Include(x => x.TaiKhoanBenhNhanThu).ThenInclude(x => x.CongTyBaoHiemTuNhanCongNos)
                    .Include(x => x.TaiKhoanBenhNhanThu).ThenInclude(x => x.MienGiamChiPhis)
                    .Include(x => x.YeuCauKhamBenh)
                    .Include(x => x.YeuCauDichVuKyThuat)
                    .Include(x => x.YeuCauDuocPhamBenhVien).ThenInclude(x => x.XuatKhoDuocPhamChiTiet)
                    .Include(x => x.YeuCauVatTuBenhVien).ThenInclude(x => x.XuatKhoVatTuChiTiet));

            if (taiKhoanBenhNhanChi.DaHuy == true)
                return (0, "Không thể hoàn thu dịch vụ này");

            //check dv chua thuc hien
            bool daThucHien = false;

            if (taiKhoanBenhNhanChi.DonThuocThanhToanChiTietId != null || taiKhoanBenhNhanChi.YeuCauTruyenMauId != null || taiKhoanBenhNhanChi.YeuCauDichVuGiuongBenhVienChiPhiBenhVienId != null)
                daThucHien = true;
            else if (taiKhoanBenhNhanChi.YeuCauKhamBenh?.ThoiDiemHoanThanh != null || taiKhoanBenhNhanChi.YeuCauKhamBenh?.TrangThai == EnumTrangThaiYeuCauKhamBenh.DaKham)
                daThucHien = true;
            else if (taiKhoanBenhNhanChi.YeuCauDichVuKyThuat?.ThoiDiemHoanThanh != null || taiKhoanBenhNhanChi.YeuCauDichVuKyThuat?.TrangThai == EnumTrangThaiYeuCauDichVuKyThuat.DaThucHien)
                daThucHien = true;
            else if (taiKhoanBenhNhanChi.YeuCauDuocPhamBenhVien?.XuatKhoDuocPhamChiTiet != null &&
                     taiKhoanBenhNhanChi.YeuCauDuocPhamBenhVien.XuatKhoDuocPhamChiTiet.NgayXuat != null)
                daThucHien = true;
            else if (taiKhoanBenhNhanChi.YeuCauVatTuBenhVien?.XuatKhoVatTuChiTiet != null &&
                     taiKhoanBenhNhanChi.YeuCauVatTuBenhVien.XuatKhoVatTuChiTiet.NgayXuat != null)
                daThucHien = true;

            if (daThucHien)
                return (0, "Không thể hoàn thu dịch vụ đã thực hiện");

            var phieuHoanThu = new TaiKhoanBenhNhanChi
            {
                TaiKhoanBenhNhanId = taiKhoanBenhNhanChi.TaiKhoanBenhNhanId,
                LoaiChiTienBenhNhan = LoaiChiTienBenhNhan.HoanThu,
                TienMat = taiKhoanBenhNhanChi.TienChiPhi,
                NoiDungChi = LoaiChiTienBenhNhan.HoanThu.GetDescription(),
                NgayChi = DateTime.Now,
                SoQuyen = taiKhoanBenhNhanChi.SoQuyen,
                SoPhieu = taiKhoanBenhNhanChi.SoPhieu,
                SoPhieuHienThi = taiKhoanBenhNhanChi.SoPhieuHienThi,
                TaiKhoanBenhNhanThuId = taiKhoanBenhNhanChi.TaiKhoanBenhNhanThuId,
                YeuCauKhamBenhId = taiKhoanBenhNhanChi.YeuCauKhamBenhId,
                YeuCauDichVuKyThuatId = taiKhoanBenhNhanChi.YeuCauDichVuKyThuatId,
                YeuCauDuocPhamBenhVienId = taiKhoanBenhNhanChi.YeuCauDuocPhamBenhVienId,
                YeuCauVatTuBenhVienId = taiKhoanBenhNhanChi.YeuCauVatTuBenhVienId,
                YeuCauDichVuGiuongBenhVienId = taiKhoanBenhNhanChi.YeuCauDichVuGiuongBenhVienId,
                YeuCauGoiDichVuId = taiKhoanBenhNhanChi.YeuCauGoiDichVuId,
                YeuCauTiepNhanId = taiKhoanBenhNhanChi.YeuCauTiepNhanId,
                NhanVienThucHienId = _userAgentHelper.GetCurrentUserId(),
                NoiThucHienId = _userAgentHelper.GetCurrentNoiLLamViecId(),
                DonThuocThanhToanChiTietId = taiKhoanBenhNhanChi.DonThuocThanhToanChiTietId,
                DonVTYTThanhToanChiTietId = taiKhoanBenhNhanChi.DonVTYTThanhToanChiTietId,
                YeuCauTruyenMauId = taiKhoanBenhNhanChi.YeuCauTruyenMauId,
                YeuCauDichVuGiuongBenhVienChiPhiBenhVienId = taiKhoanBenhNhanChi.YeuCauDichVuGiuongBenhVienChiPhiBenhVienId,
                PhieuThanhToanChiPhiId = taiKhoanBenhNhanChi.Id
            };
            taiKhoanBenhNhanChi.TaiKhoanBenhNhanChis.Add(phieuHoanThu);
            taiKhoanBenhNhanChi.DaHuy = true;
            taiKhoanBenhNhanChi.NhanVienHuyId = _userAgentHelper.GetCurrentUserId();
            taiKhoanBenhNhanChi.NoiHuyId = _userAgentHelper.GetCurrentNoiLLamViecId();
            taiKhoanBenhNhanChi.NgayHuy = DateTime.Now;

            if (taiKhoanBenhNhanChi.YeuCauKhamBenh != null)
            {
                taiKhoanBenhNhanChi.YeuCauKhamBenh.SoTienBenhNhanDaChi = 0;
                taiKhoanBenhNhanChi.YeuCauKhamBenh.SoTienMienGiam = 0;
                taiKhoanBenhNhanChi.YeuCauKhamBenh.SoTienBaoHiemTuNhanChiTra = 0;
            }

            else if (taiKhoanBenhNhanChi.YeuCauDichVuKyThuat != null)
            {
                taiKhoanBenhNhanChi.YeuCauDichVuKyThuat.SoTienBenhNhanDaChi = 0;
                taiKhoanBenhNhanChi.YeuCauDichVuKyThuat.SoTienMienGiam = 0;
                taiKhoanBenhNhanChi.YeuCauDichVuKyThuat.SoTienBaoHiemTuNhanChiTra = 0;
            }
            else if (taiKhoanBenhNhanChi.YeuCauDuocPhamBenhVien != null)
            {
                taiKhoanBenhNhanChi.YeuCauDuocPhamBenhVien.SoTienBenhNhanDaChi = 0;
                taiKhoanBenhNhanChi.YeuCauDuocPhamBenhVien.SoTienMienGiam = 0;
                taiKhoanBenhNhanChi.YeuCauDuocPhamBenhVien.SoTienBaoHiemTuNhanChiTra = 0;
            }
            else if (taiKhoanBenhNhanChi.YeuCauVatTuBenhVien != null)
            {
                taiKhoanBenhNhanChi.YeuCauVatTuBenhVien.SoTienBenhNhanDaChi = 0;
                taiKhoanBenhNhanChi.YeuCauVatTuBenhVien.SoTienMienGiam = 0;
                taiKhoanBenhNhanChi.YeuCauVatTuBenhVien.SoTienBaoHiemTuNhanChiTra = 0;
            }

            foreach (var congTyBaoHiemTuNhanCongNo in taiKhoanBenhNhanChi.TaiKhoanBenhNhanThu.CongTyBaoHiemTuNhanCongNos)
            {
                if ((congTyBaoHiemTuNhanCongNo.DonThuocThanhToanChiTietId != null &&
                    congTyBaoHiemTuNhanCongNo.DonThuocThanhToanChiTietId ==
                     taiKhoanBenhNhanChi.DonThuocThanhToanChiTietId) ||
                    (congTyBaoHiemTuNhanCongNo.YeuCauKhamBenhId != null &&
                     congTyBaoHiemTuNhanCongNo.YeuCauKhamBenhId ==
                     taiKhoanBenhNhanChi.YeuCauKhamBenhId) ||
                    (congTyBaoHiemTuNhanCongNo.YeuCauDichVuKyThuatId != null &&
                     congTyBaoHiemTuNhanCongNo.YeuCauDichVuKyThuatId ==
                     taiKhoanBenhNhanChi.YeuCauDichVuKyThuatId) ||
                    (congTyBaoHiemTuNhanCongNo.YeuCauDuocPhamBenhVienId != null &&
                     congTyBaoHiemTuNhanCongNo.YeuCauDuocPhamBenhVienId ==
                     taiKhoanBenhNhanChi.YeuCauDuocPhamBenhVienId) ||
                    (congTyBaoHiemTuNhanCongNo.YeuCauVatTuBenhVienId != null &&
                     congTyBaoHiemTuNhanCongNo.YeuCauVatTuBenhVienId ==
                     taiKhoanBenhNhanChi.YeuCauVatTuBenhVienId) ||
                    (congTyBaoHiemTuNhanCongNo.YeuCauGoiDichVuId != null &&
                     congTyBaoHiemTuNhanCongNo.YeuCauGoiDichVuId ==
                     taiKhoanBenhNhanChi.YeuCauGoiDichVuId) ||
                    (congTyBaoHiemTuNhanCongNo.DonVTYTThanhToanChiTietId != null &&
                     congTyBaoHiemTuNhanCongNo.DonVTYTThanhToanChiTietId ==
                     taiKhoanBenhNhanChi.DonVTYTThanhToanChiTietId) ||
                    (congTyBaoHiemTuNhanCongNo.YeuCauTruyenMauId != null &&
                     congTyBaoHiemTuNhanCongNo.YeuCauTruyenMauId ==
                     taiKhoanBenhNhanChi.YeuCauTruyenMauId) ||
                    (congTyBaoHiemTuNhanCongNo.YeuCauDichVuGiuongBenhVienChiPhiBenhVienId != null &&
                     congTyBaoHiemTuNhanCongNo.YeuCauDichVuGiuongBenhVienChiPhiBenhVienId ==
                     taiKhoanBenhNhanChi.YeuCauDichVuGiuongBenhVienChiPhiBenhVienId))
                {
                    congTyBaoHiemTuNhanCongNo.DaHuy = true;
                }
            }

            foreach (var mienGiamChiPhi in taiKhoanBenhNhanChi.TaiKhoanBenhNhanThu.MienGiamChiPhis)
            {
                if ((mienGiamChiPhi.DonThuocThanhToanChiTietId != null &&
                    mienGiamChiPhi.DonThuocThanhToanChiTietId ==
                     taiKhoanBenhNhanChi.DonThuocThanhToanChiTietId) ||
                    (mienGiamChiPhi.YeuCauKhamBenhId != null &&
                     mienGiamChiPhi.YeuCauKhamBenhId ==
                     taiKhoanBenhNhanChi.YeuCauKhamBenhId) ||
                    (mienGiamChiPhi.YeuCauDichVuKyThuatId != null &&
                     mienGiamChiPhi.YeuCauDichVuKyThuatId ==
                     taiKhoanBenhNhanChi.YeuCauDichVuKyThuatId) ||
                    (mienGiamChiPhi.YeuCauDuocPhamBenhVienId != null &&
                     mienGiamChiPhi.YeuCauDuocPhamBenhVienId ==
                     taiKhoanBenhNhanChi.YeuCauDuocPhamBenhVienId) ||
                    (mienGiamChiPhi.YeuCauVatTuBenhVienId != null &&
                     mienGiamChiPhi.YeuCauVatTuBenhVienId ==
                     taiKhoanBenhNhanChi.YeuCauVatTuBenhVienId) ||
                    (mienGiamChiPhi.YeuCauGoiDichVuId != null &&
                     mienGiamChiPhi.YeuCauGoiDichVuId ==
                     taiKhoanBenhNhanChi.YeuCauGoiDichVuId) ||
                    (mienGiamChiPhi.DonVTYTThanhToanChiTietId != null &&
                     mienGiamChiPhi.DonVTYTThanhToanChiTietId ==
                     taiKhoanBenhNhanChi.DonVTYTThanhToanChiTietId) ||
                    (mienGiamChiPhi.YeuCauTruyenMauId != null &&
                     mienGiamChiPhi.YeuCauTruyenMauId ==
                     taiKhoanBenhNhanChi.YeuCauTruyenMauId) ||
                    (mienGiamChiPhi.YeuCauDichVuGiuongBenhVienChiPhiBenhVienId != null &&
                     mienGiamChiPhi.YeuCauDichVuGiuongBenhVienChiPhiBenhVienId ==
                     taiKhoanBenhNhanChi.YeuCauDichVuGiuongBenhVienChiPhiBenhVienId))
                {
                    mienGiamChiPhi.DaHuy = true;
                }
            }

            //await _taiKhoanBenhNhanChiRepository.UpdateAsync(taiKhoanBenhNhanChi);
            BaseRepository.Context.SaveChanges();
            return (phieuHoanThu.Id, string.Empty);
        }
        public void HuyPhieu(ThongTinHuyPhieuVo thongTinHuyPhieuVo)
        {
            if (thongTinHuyPhieuVo.LoaiPhieuThuChiThuNgan == LoaiPhieuThuChiThuNgan.ThuTamUng)
            {
                HuyTamUng(thongTinHuyPhieuVo);
            }
            else if (thongTinHuyPhieuVo.LoaiPhieuThuChiThuNgan == LoaiPhieuThuChiThuNgan.ThuTheoChiPhi)
            {
                HuyPhieuThu(thongTinHuyPhieuVo);
            }
        }
        public void CapnhatNguoiThuHoiPhieuThu(ThongTinHuyPhieuVo thongTinHuyPhieuVo)
        {
            var phieuTamUng = _taiKhoanBenhNhanThuRepository.GetById(thongTinHuyPhieuVo.SoPhieu, o => o.Include(x => x.TaiKhoanBenhNhan));
            phieuTamUng.LyDoHuy = thongTinHuyPhieuVo.LyDo;
            phieuTamUng.DaThuHoi = thongTinHuyPhieuVo.ThoiGianThuHoi != null;
            phieuTamUng.NhanVienThuHoiId = thongTinHuyPhieuVo.NguoiThuHoiId;
            phieuTamUng.NgayThuHoi = thongTinHuyPhieuVo.ThoiGianThuHoi;

            _taiKhoanBenhNhanThuRepository.Update(phieuTamUng);
        }
        private void HuyTamUng(ThongTinHuyPhieuVo thongTinHuyPhieuVo)
        {
            var phieuTamUng = _taiKhoanBenhNhanThuRepository.GetById(thongTinHuyPhieuVo.SoPhieu, o => o.Include(x => x.TaiKhoanBenhNhan));
            if (phieuTamUng.PhieuHoanUngId != null)
            {
                throw new Exception("Không thể hủy phiếu tạm ứng đã được hoàn ứng");
            }
            if (phieuTamUng.DaHuy == true)
            {
                throw new Exception("Phiếu tạm ứng đã được hủy");
            }
            phieuTamUng.TaiKhoanBenhNhan.SoDuTaiKhoan -= phieuTamUng.TienMat.GetValueOrDefault() +
                                                         phieuTamUng.ChuyenKhoan.GetValueOrDefault() +
                                                         phieuTamUng.POS.GetValueOrDefault();
            phieuTamUng.DaHuy = true;
            phieuTamUng.NhanVienHuyId = _userAgentHelper.GetCurrentUserId();
            phieuTamUng.NoiHuyId = _userAgentHelper.GetCurrentNoiLLamViecId();
            phieuTamUng.NgayHuy = DateTime.Now;
            phieuTamUng.LyDoHuy = thongTinHuyPhieuVo.LyDo;
            phieuTamUng.DaThuHoi = thongTinHuyPhieuVo.ThoiGianThuHoi != null;
            phieuTamUng.NhanVienThuHoiId = thongTinHuyPhieuVo.NguoiThuHoiId;
            phieuTamUng.NgayThuHoi = thongTinHuyPhieuVo.ThoiGianThuHoi;
            _taiKhoanBenhNhanThuRepository.Update(phieuTamUng);
        }
        private void HuyPhieuThu(ThongTinHuyPhieuVo thongTinHuyPhieuVo)
        {
            var phieuThu = _taiKhoanBenhNhanThuRepository.GetById(thongTinHuyPhieuVo.SoPhieu,
                o => o.Include(x => x.TaiKhoanBenhNhan)
                    .Include(x => x.YeuCauTiepNhan).ThenInclude(tn => tn.NoiTruBenhAn)
                    .Include(x => x.YeuCauTiepNhan).ThenInclude(tn => tn.YeuCauTiepNhanNgoaiTruCanQuyetToan)
                    .Include(x => x.TaiKhoanBenhNhanChis).ThenInclude(c => c.TaiKhoanBenhNhanThus)

                    .Include(x => x.TaiKhoanBenhNhanChis).ThenInclude(c => c.YeuCauKhamBenh)
                    .Include(x => x.TaiKhoanBenhNhanChis).ThenInclude(c => c.YeuCauDichVuKyThuat)
                    .Include(x => x.TaiKhoanBenhNhanChis).ThenInclude(c => c.YeuCauDuocPhamBenhVien)
                    .Include(x => x.TaiKhoanBenhNhanChis).ThenInclude(c => c.YeuCauVatTuBenhVien)
                    .Include(x => x.TaiKhoanBenhNhanChis).ThenInclude(c => c.YeuCauGoiDichVu)
                    .Include(x => x.TaiKhoanBenhNhanChis).ThenInclude(c => c.DonThuocThanhToanChiTiet).ThenInclude(ct => ct.DonThuocThanhToan)
                    .Include(x => x.TaiKhoanBenhNhanChis).ThenInclude(c => c.DonVTYTThanhToanChiTiet).ThenInclude(ct => ct.DonVTYTThanhToan)
                    .Include(x => x.TaiKhoanBenhNhanChis).ThenInclude(c => c.YeuCauTruyenMau)
                    .Include(x => x.TaiKhoanBenhNhanChis).ThenInclude(c => c.YeuCauDichVuGiuongBenhVienChiPhiBenhVien)

                    .Include(x => x.CongTyBaoHiemTuNhanCongNos).ThenInclude(ct => ct.CongTyBaoHiemTuNhan)
                    .Include(x => x.MienGiamChiPhis).ThenInclude(mg => mg.YeuCauTiepNhan));
            if (phieuThu.DaHuy == true)
            {
                throw new Exception("Phiếu thu đã được hủy");
            }

            if (phieuThu.YeuCauTiepNhan.NoiTruBenhAn != null)
            {
                phieuThu.YeuCauTiepNhan.NoiTruBenhAn.DaQuyetToan = false;
            }

            phieuThu.YeuCauTiepNhan.TrangThaiYeuCauTiepNhan = EnumTrangThaiYeuCauTiepNhan.DangThucHien;
            if (phieuThu.YeuCauTiepNhan.YeuCauTiepNhanNgoaiTruCanQuyetToan != null)
            {
                phieuThu.YeuCauTiepNhan.YeuCauTiepNhanNgoaiTruCanQuyetToan.TrangThaiYeuCauTiepNhan = EnumTrangThaiYeuCauTiepNhan.DangThucHien;
            }
            else
            {
                var yeuCauTiepNhanNgoaiTru = BaseRepository.Table.FirstOrDefault(o => o.MaYeuCauTiepNhan == phieuThu.YeuCauTiepNhan.MaYeuCauTiepNhan && o.LoaiYeuCauTiepNhan == EnumLoaiYeuCauTiepNhan.KhamChuaBenhNgoaiTru);
                if (yeuCauTiepNhanNgoaiTru != null)
                {
                    yeuCauTiepNhanNgoaiTru.TrangThaiYeuCauTiepNhan = EnumTrangThaiYeuCauTiepNhan.DangThucHien;
                }
            }
            if (phieuThu.ThuTienGoiDichVu == true)
            {
                var phieuHoanUngs = phieuThu.TaiKhoanBenhNhanChis
                    .Where(o => o.LoaiChiTienBenhNhan == Enums.LoaiChiTienBenhNhan.HoanUng).ToList();
                foreach (var phieuHoanUng in phieuHoanUngs)
                {
                    phieuHoanUng.DaHuy = true;
                    phieuHoanUng.NgayHuy = DateTime.Now;
                    phieuHoanUng.NhanVienHuyId = _userAgentHelper.GetCurrentUserId();
                    phieuHoanUng.NoiHuyId = _userAgentHelper.GetCurrentNoiLLamViecId();
                    phieuHoanUng.LyDoHuy = thongTinHuyPhieuVo.LyDo;
                    phieuHoanUng.DaThuHoi = thongTinHuyPhieuVo.ThoiGianThuHoi != null;
                    phieuHoanUng.NhanVienThuHoiId = thongTinHuyPhieuVo.NguoiThuHoiId;
                    phieuHoanUng.NgayThuHoi = thongTinHuyPhieuVo.ThoiGianThuHoi;
                }
                foreach (var phieuThuTaiKhoanBenhNhanChi in phieuThu.TaiKhoanBenhNhanChis.Where(o =>
                    o.LoaiChiTienBenhNhan == Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi))
                {
                    phieuThuTaiKhoanBenhNhanChi.DaHuy = true;
                    phieuThuTaiKhoanBenhNhanChi.NhanVienHuyId = _userAgentHelper.GetCurrentUserId();
                    phieuThuTaiKhoanBenhNhanChi.NoiHuyId = _userAgentHelper.GetCurrentNoiLLamViecId();
                    phieuThuTaiKhoanBenhNhanChi.LyDoHuy = thongTinHuyPhieuVo.LyDo;
                    if (phieuThuTaiKhoanBenhNhanChi.YeuCauKhamBenh != null)
                    {
                        phieuThuTaiKhoanBenhNhanChi.YeuCauKhamBenh.SoTienBaoHiemTuNhanChiTra = 0;
                        phieuThuTaiKhoanBenhNhanChi.YeuCauKhamBenh.SoTienBenhNhanDaChi = 0;
                        phieuThuTaiKhoanBenhNhanChi.YeuCauKhamBenh.TrangThaiThanhToan =
                            Enums.TrangThaiThanhToan.BaoLanhThanhToan;
                    }
                    if (phieuThuTaiKhoanBenhNhanChi.YeuCauDichVuKyThuat != null)
                    {
                        phieuThuTaiKhoanBenhNhanChi.YeuCauDichVuKyThuat.SoTienBaoHiemTuNhanChiTra = 0;
                        phieuThuTaiKhoanBenhNhanChi.YeuCauDichVuKyThuat.SoTienBenhNhanDaChi = 0;
                        phieuThuTaiKhoanBenhNhanChi.YeuCauDichVuKyThuat.TrangThaiThanhToan =
                            Enums.TrangThaiThanhToan.BaoLanhThanhToan;
                    }
                    if (phieuThuTaiKhoanBenhNhanChi.YeuCauDichVuGiuongBenhVienChiPhiBenhVien != null)
                    {
                        phieuThuTaiKhoanBenhNhanChi.YeuCauDichVuGiuongBenhVienChiPhiBenhVien.SoTienBenhNhanDaChi = 0;
                        phieuThuTaiKhoanBenhNhanChi.YeuCauDichVuGiuongBenhVienChiPhiBenhVien.TrangThaiThanhToan =
                            Enums.TrangThaiThanhToan.ChuaThanhToan;
                    }
                }

                phieuThu.DaHuy = true;
                phieuThu.NhanVienHuyId = _userAgentHelper.GetCurrentUserId();
                phieuThu.NoiHuyId = _userAgentHelper.GetCurrentNoiLLamViecId();
                phieuThu.NgayHuy = DateTime.Now;
                phieuThu.LyDoHuy = thongTinHuyPhieuVo.LyDo;
                phieuThu.DaThuHoi = thongTinHuyPhieuVo.ThoiGianThuHoi != null;
                phieuThu.NhanVienThuHoiId = thongTinHuyPhieuVo.NguoiThuHoiId;
                phieuThu.NgayThuHoi = thongTinHuyPhieuVo.ThoiGianThuHoi;

                _taiKhoanBenhNhanThuRepository.Update(phieuThu);
            }
            else
            {
                var phieuHoanUng = phieuThu.TaiKhoanBenhNhanChis.FirstOrDefault(o => o.LoaiChiTienBenhNhan == LoaiChiTienBenhNhan.HoanUng);
                if (phieuHoanUng != null && thongTinHuyPhieuVo.HuyPhieuHoanUng == true)
                {
                    var soTienHoanUng = phieuHoanUng.TienMat.GetValueOrDefault();
                    phieuThu.TaiKhoanBenhNhan.SoDuTaiKhoan += soTienHoanUng;
                    phieuHoanUng.DaHuy = true;
                    phieuHoanUng.NhanVienHuyId = _userAgentHelper.GetCurrentUserId();
                    phieuHoanUng.NgayHuy = DateTime.Now;
                    phieuHoanUng.NoiHuyId = _userAgentHelper.GetCurrentNoiLLamViecId();
                    phieuHoanUng.LyDoHuy = thongTinHuyPhieuVo.LyDo;
                    phieuHoanUng.DaThuHoi = thongTinHuyPhieuVo.ThoiGianThuHoi != null;
                    phieuHoanUng.NhanVienThuHoiId = thongTinHuyPhieuVo.NguoiThuHoiId;
                    phieuHoanUng.NgayThuHoi = thongTinHuyPhieuVo.ThoiGianThuHoi;
                    foreach (var taiKhoanBenhNhanThu in phieuHoanUng.TaiKhoanBenhNhanThus)
                    {
                        taiKhoanBenhNhanThu.PhieuHoanUngId = null;
                    }
                }

                foreach (var phieuThuCongTyBaoHiemTuNhanCongNo in phieuThu.CongTyBaoHiemTuNhanCongNos)
                {
                    phieuThuCongTyBaoHiemTuNhanCongNo.CongTyBaoHiemTuNhan.CongTyBaoHiemTuNhanCongNos.Add(new CongTyBaoHiemTuNhanCongNo
                    {
                        TaiKhoanBenhNhanThuId = null,
                        SoTien = phieuThuCongTyBaoHiemTuNhanCongNo.SoTien,
                        YeuCauKhamBenhId = phieuThuCongTyBaoHiemTuNhanCongNo.YeuCauKhamBenhId,
                        YeuCauDichVuKyThuatId = phieuThuCongTyBaoHiemTuNhanCongNo.YeuCauDichVuKyThuatId,
                        YeuCauDuocPhamBenhVienId = phieuThuCongTyBaoHiemTuNhanCongNo.YeuCauDuocPhamBenhVienId,
                        YeuCauVatTuBenhVienId = phieuThuCongTyBaoHiemTuNhanCongNo.YeuCauVatTuBenhVienId,
                        YeuCauDichVuGiuongBenhVienId = phieuThuCongTyBaoHiemTuNhanCongNo.YeuCauDichVuGiuongBenhVienId,
                        DonThuocThanhToanChiTietId = phieuThuCongTyBaoHiemTuNhanCongNo.DonThuocThanhToanChiTietId,
                        YeuCauGoiDichVuId = phieuThuCongTyBaoHiemTuNhanCongNo.YeuCauGoiDichVuId,
                        DonVTYTThanhToanChiTietId = phieuThuCongTyBaoHiemTuNhanCongNo.DonVTYTThanhToanChiTietId,
                        YeuCauTruyenMauId = phieuThuCongTyBaoHiemTuNhanCongNo.YeuCauTruyenMauId,
                        YeuCauDichVuGiuongBenhVienChiPhiBenhVienId = phieuThuCongTyBaoHiemTuNhanCongNo.YeuCauDichVuGiuongBenhVienChiPhiBenhVienId,
                    });
                }
                foreach (var mienGiamChiPhi in phieuThu.MienGiamChiPhis)
                {
                    mienGiamChiPhi.YeuCauTiepNhan.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThuId = null,
                        LoaiMienGiam = mienGiamChiPhi.LoaiMienGiam,
                        SoTien = mienGiamChiPhi.SoTien,
                        TheVoucherId = mienGiamChiPhi.TheVoucherId,
                        YeuCauKhamBenhId = mienGiamChiPhi.YeuCauKhamBenhId,
                        YeuCauDichVuKyThuatId = mienGiamChiPhi.YeuCauDichVuKyThuatId,
                        YeuCauDuocPhamBenhVienId = mienGiamChiPhi.YeuCauDuocPhamBenhVienId,
                        YeuCauVatTuBenhVienId = mienGiamChiPhi.YeuCauVatTuBenhVienId,
                        YeuCauDichVuGiuongBenhVienId = mienGiamChiPhi.YeuCauDichVuGiuongBenhVienId,
                        YeuCauGoiDichVuId = mienGiamChiPhi.YeuCauGoiDichVuId,
                        DonThuocThanhToanChiTietId = mienGiamChiPhi.DonThuocThanhToanChiTietId,
                        DonVTYTThanhToanChiTietId = mienGiamChiPhi.DonVTYTThanhToanChiTietId,
                        LoaiChietKhau = mienGiamChiPhi.LoaiChietKhau,
                        TiLe = mienGiamChiPhi.TiLe,
                        MaTheVoucher = mienGiamChiPhi.MaTheVoucher,
                        DoiTuongUuDaiId = mienGiamChiPhi.DoiTuongUuDaiId,
                        NoiGioiThieuId = mienGiamChiPhi.NoiGioiThieuId,
                        YeuCauTruyenMauId = mienGiamChiPhi.YeuCauTruyenMauId,
                        YeuCauDichVuGiuongBenhVienChiPhiBenhVienId = mienGiamChiPhi.YeuCauDichVuGiuongBenhVienChiPhiBenhVienId
                    });
                }
                foreach (var phieuThuTaiKhoanBenhNhanChi in phieuThu.TaiKhoanBenhNhanChis.Where(o => o.LoaiChiTienBenhNhan == LoaiChiTienBenhNhan.ThanhToanChiPhi))
                {
                    if (phieuThuTaiKhoanBenhNhanChi.DaHuy == true)
                    {
                        throw new Exception("Có dịch vụ đã hoàn thu");
                    }
                    phieuThuTaiKhoanBenhNhanChi.DaHuy = true;
                    phieuThuTaiKhoanBenhNhanChi.NhanVienHuyId = _userAgentHelper.GetCurrentUserId();
                    phieuThuTaiKhoanBenhNhanChi.NoiHuyId = _userAgentHelper.GetCurrentNoiLLamViecId();
                    phieuThuTaiKhoanBenhNhanChi.LyDoHuy = thongTinHuyPhieuVo.LyDo;
                    if (phieuThuTaiKhoanBenhNhanChi.YeuCauKhamBenh != null)
                    {
                        phieuThuTaiKhoanBenhNhanChi.YeuCauKhamBenh.SoTienBenhNhanDaChi = 0;
                        phieuThuTaiKhoanBenhNhanChi.YeuCauKhamBenh.TrangThaiThanhToan = TrangThaiThanhToan.CapNhatThanhToan;
                    }
                    if (phieuThuTaiKhoanBenhNhanChi.YeuCauDichVuKyThuat != null)
                    {
                        phieuThuTaiKhoanBenhNhanChi.YeuCauDichVuKyThuat.SoTienBenhNhanDaChi = 0;
                        phieuThuTaiKhoanBenhNhanChi.YeuCauDichVuKyThuat.TrangThaiThanhToan = TrangThaiThanhToan.CapNhatThanhToan;
                    }
                    if (phieuThuTaiKhoanBenhNhanChi.YeuCauDuocPhamBenhVien != null)
                    {
                        phieuThuTaiKhoanBenhNhanChi.YeuCauDuocPhamBenhVien.SoTienBenhNhanDaChi = 0;
                        phieuThuTaiKhoanBenhNhanChi.YeuCauDuocPhamBenhVien.TrangThaiThanhToan = TrangThaiThanhToan.CapNhatThanhToan;
                    }
                    if (phieuThuTaiKhoanBenhNhanChi.YeuCauVatTuBenhVien != null)
                    {
                        phieuThuTaiKhoanBenhNhanChi.YeuCauVatTuBenhVien.SoTienBenhNhanDaChi = 0;
                        phieuThuTaiKhoanBenhNhanChi.YeuCauVatTuBenhVien.TrangThaiThanhToan = TrangThaiThanhToan.CapNhatThanhToan;
                    }
                    if (phieuThuTaiKhoanBenhNhanChi.YeuCauGoiDichVu != null)
                    {
                        phieuThuTaiKhoanBenhNhanChi.YeuCauGoiDichVu.SoTienBenhNhanDaChi = 0;
                        phieuThuTaiKhoanBenhNhanChi.YeuCauGoiDichVu.TrangThaiThanhToan = TrangThaiThanhToan.CapNhatThanhToan;
                    }
                    if (phieuThuTaiKhoanBenhNhanChi.DonThuocThanhToanChiTiet != null)
                    {
                        phieuThuTaiKhoanBenhNhanChi.DonThuocThanhToanChiTiet.SoTienBenhNhanDaChi = 0;
                        phieuThuTaiKhoanBenhNhanChi.DonThuocThanhToanChiTiet.DonThuocThanhToan.TrangThaiThanhToan = TrangThaiThanhToan.CapNhatThanhToan;
                    }
                    if (phieuThuTaiKhoanBenhNhanChi.DonVTYTThanhToanChiTiet != null)
                    {
                        phieuThuTaiKhoanBenhNhanChi.DonVTYTThanhToanChiTiet.SoTienBenhNhanDaChi = 0;
                        phieuThuTaiKhoanBenhNhanChi.DonVTYTThanhToanChiTiet.DonVTYTThanhToan.TrangThaiThanhToan = TrangThaiThanhToan.CapNhatThanhToan;
                    }
                    if (phieuThuTaiKhoanBenhNhanChi.YeuCauTruyenMau != null)
                    {
                        phieuThuTaiKhoanBenhNhanChi.YeuCauTruyenMau.SoTienBenhNhanDaChi = 0;
                        phieuThuTaiKhoanBenhNhanChi.YeuCauTruyenMau.TrangThaiThanhToan = TrangThaiThanhToan.CapNhatThanhToan;
                    }
                    if (phieuThuTaiKhoanBenhNhanChi.YeuCauDichVuGiuongBenhVienChiPhiBenhVien != null)
                    {
                        phieuThuTaiKhoanBenhNhanChi.YeuCauDichVuGiuongBenhVienChiPhiBenhVien.SoTienBenhNhanDaChi = 0;
                        phieuThuTaiKhoanBenhNhanChi.YeuCauDichVuGiuongBenhVienChiPhiBenhVien.TrangThaiThanhToan = TrangThaiThanhToan.ChuaThanhToan;
                    }
                }

                phieuThu.DaHuy = true;
                phieuThu.NhanVienHuyId = _userAgentHelper.GetCurrentUserId();
                phieuThu.NoiHuyId = _userAgentHelper.GetCurrentNoiLLamViecId();
                phieuThu.LyDoHuy = thongTinHuyPhieuVo.LyDo;
                phieuThu.NgayHuy = DateTime.Now;
                phieuThu.DaThuHoi = thongTinHuyPhieuVo.ThoiGianThuHoi != null;
                phieuThu.NhanVienThuHoiId = thongTinHuyPhieuVo.NguoiThuHoiId;
                phieuThu.NgayThuHoi = thongTinHuyPhieuVo.ThoiGianThuHoi;
                _taiKhoanBenhNhanThuRepository.Update(phieuThu);
                if (thongTinHuyPhieuVo.HuyPhieuHoanUng != true && thongTinHuyPhieuVo.ChuyenTienQuaTamUng == true)
                {
                    //khi chuyển vào tạm ứng hình thức thanh toán vẫn giống như lúc đầu là vừa chuyển khoản, pos, vừa tiền mặt trong trường hợp thu tiền luôn (ko có tạm ứng)
                    if (phieuThu.TamUng.GetValueOrDefault().AlmostEqual(0))
                    {
                        var thuTamUng = new TaiKhoanBenhNhanThu
                        {
                            YeuCauTiepNhanId = phieuThu.YeuCauTiepNhanId,
                            TaiKhoanBenhNhan = phieuThu.TaiKhoanBenhNhan,
                            LoaiThuTienBenhNhan = Enums.LoaiThuTienBenhNhan.ThuTamUng,
                            LoaiNoiThu = Enums.LoaiNoiThu.ThuNgan,
                            TienMat = phieuThu.TienMat,
                            ChuyenKhoan = phieuThu.ChuyenKhoan,
                            POS = phieuThu.POS,
                            NoiDungThu = Enums.LoaiThuTienBenhNhan.ThuTamUng.GetDescription(),
                            NgayThu = DateTime.Now,
                            SoPhieuHienThi = ResourceHelper.CreateSoTamUng(),
                            NhanVienThucHienId = _userAgentHelper.GetCurrentUserId(),
                            NoiThucHienId = _userAgentHelper.GetCurrentNoiLLamViecId()
                        };
                        phieuThu.TaiKhoanBenhNhan.SoDuTaiKhoan += thuTamUng.TienMat.GetValueOrDefault() + thuTamUng.ChuyenKhoan.GetValueOrDefault() + thuTamUng.POS.GetValueOrDefault();
                        _taiKhoanBenhNhanThuRepository.Add(thuTamUng);
                    }
                    else
                    {
                        var thuTamUng = new TaiKhoanBenhNhanThu
                        {
                            YeuCauTiepNhanId = phieuThu.YeuCauTiepNhanId,
                            TaiKhoanBenhNhan = phieuThu.TaiKhoanBenhNhan,
                            LoaiThuTienBenhNhan = Enums.LoaiThuTienBenhNhan.ThuTamUng,
                            LoaiNoiThu = Enums.LoaiNoiThu.ThuNgan,
                            TienMat = phieuThu.TienMat.GetValueOrDefault() + phieuThu.ChuyenKhoan.GetValueOrDefault() + phieuThu.POS.GetValueOrDefault() + phieuThu.TamUng.GetValueOrDefault(),
                            NoiDungThu = Enums.LoaiThuTienBenhNhan.ThuTamUng.GetDescription(),
                            NgayThu = DateTime.Now,
                            SoPhieuHienThi = ResourceHelper.CreateSoTamUng(),
                            NhanVienThucHienId = _userAgentHelper.GetCurrentUserId(),
                            NoiThucHienId = _userAgentHelper.GetCurrentNoiLLamViecId()
                        };
                        phieuThu.TaiKhoanBenhNhan.SoDuTaiKhoan += thuTamUng.TienMat.GetValueOrDefault();
                        _taiKhoanBenhNhanThuRepository.Add(thuTamUng);
                    }


                }
            }

        }
        public bool KiemTraTaiKhoanThuCoBHYT(long taiKhoanThuId)
        {
            var taiKhoanBenhNhanThus = _taiKhoanBenhNhanThuRepository.TableNoTracking
                .Where(c => c.Id == taiKhoanThuId && c.LoaiThuTienBenhNhan == Enums.LoaiThuTienBenhNhan.ThuTheoChiPhi).Include(cc => cc.YeuCauTiepNhan);
            return taiKhoanBenhNhanThus.Select(c => c.YeuCauTiepNhan).Where(c => c.CoBHYT == true).Any();
        }

        #region PHIẾU THU,PHIẾU HOÀN ỨNG, BẢNG KÊ MỚI NHẤT(17/02/2021)    

        public string GetHtmlPhieuThuChiNoiTru(long taiKhoanThuId, string hostingName)
        {
            var currentUserId = _userAgentHelper.GetCurrentUserId();
            var nguoiLapPhieu = _userRepository.GetById(currentUserId).HoTen;
            var cauHinhPhieuThu = _cauHinhService.LoadSetting<CauHinhPhieuThu>();
            var result = _templateRepository.TableNoTracking
                .FirstOrDefault(x => x.Name.Equals("PhieuThuChiNoiTru"));
            var taiKhoanBenhNhanThu = _taiKhoanBenhNhanThuRepository.TableNoTracking.Where(c =>
                    c.Id == taiKhoanThuId && c.LoaiThuTienBenhNhan == Enums.LoaiThuTienBenhNhan.ThuTheoChiPhi).Include(cc => cc.YeuCauTiepNhan)
                                                                                                              .ThenInclude(cc => cc.PhuongXa)
                                                                                                              .Include(cc => cc.YeuCauTiepNhan)
                                                                                                              .ThenInclude(cc => cc.QuanHuyen)
                                                                                                              .Include(cc => cc.YeuCauTiepNhan)
                                                                                                              .ThenInclude(cc => cc.TinhThanh)
                                                                                                              .Include(cc => cc.YeuCauTiepNhan)
                                                                                                              .ThenInclude(cc => cc.BenhNhan)
                                                                                                              .Include(ccc => ccc.TaiKhoanBenhNhanChis)
                                                                                                              .Include(dt => dt.CongTyBaoHiemTuNhanCongNos).FirstOrDefault();


            var dsChiPhi = GetThongTinPhieuThu(taiKhoanThuId, LoaiPhieuThuChiThuNgan.ThuTheoChiPhi);
            var diaChi = taiKhoanBenhNhanThu?.YeuCauTiepNhan.DiaChiDayDu;
            var trongGoi = taiKhoanBenhNhanThu.ThuTienGoiDichVu == true ? "<b style='color:red'>(Trong gói)</b>" : string.Empty;
            var data = new
            {
                cauHinhPhieuThu.TaiKhoanCo,
                cauHinhPhieuThu.TaiKhoanNo,
                LoaiPhieu = LoaiPhieuThuChiThuNgan.ThuTheoChiPhi.GetDescription().ToUpper() + trongGoi,

                LoaiNguoiNopTien = dsChiPhi.LaPhieuChi ? "Người nhận tiền" : "Người nộp tiền",
                LogoUrl = hostingName + "/assets/img/logo-bacha-full.png",
                NguoiNopTien = taiKhoanBenhNhanThu?.YeuCauTiepNhan.HoTen,
                //taiKhoanBenhNhanThu?.YeuCauTiepNhan.NamSinh,
                NamSinh = DateHelper.DOBFormat(taiKhoanBenhNhanThu?.YeuCauTiepNhan?.NgaySinh, taiKhoanBenhNhanThu?.YeuCauTiepNhan?.ThangSinh, taiKhoanBenhNhanThu?.YeuCauTiepNhan?.NamSinh),
                GioiTinh = taiKhoanBenhNhanThu?.YeuCauTiepNhan.GioiTinh.GetDescription(),
                DiaChi = diaChi,
                NoiDung = taiKhoanBenhNhanThu?.NoiDungThu,
                taiKhoanBenhNhanThu?.SoQuyen,
                SoPhieu = taiKhoanBenhNhanThu?.SoPhieuHienThi,
                //update 21/06/2022 làm tròn tiền trên phiếu thu ApplyFormatMoneyToDouble -> RoundAndApplyFormatMoney
                TongChiPhi = Convert.ToDouble(dsChiPhi.TongChiPhi).RoundAndApplyFormatMoney(),
                BHYTT = Convert.ToDouble(dsChiPhi.BHYTThanhToan).RoundAndApplyFormatMoney(),
                MiemGiam = Convert.ToDouble(dsChiPhi.MienGiam).RoundAndApplyFormatMoney(),
                nguoiLapPhieu,

                BenhNhanTT = Convert.ToDouble(dsChiPhi.BenhNhanThanhToan).RoundAndApplyFormatMoney(),
                //ngay dưới phiếu thu là ngày thu(update 07/10/2021)
                NgayThu = dsChiPhi.NgayThu.ToString("HH:mm") + " ngày " + dsChiPhi.NgayThu.Day + " tháng " + dsChiPhi.NgayThu.Month + " năm " + dsChiPhi.NgayThu.Year,
                ngayThangHientai = "Ngày " + DateTime.Now.Day + " tháng " + DateTime.Now.Month + " năm " + DateTime.Now.Year,
                TienMat = Convert.ToDouble(dsChiPhi.TienMat).RoundAndApplyFormatMoney(),
                ChuyenKhoan = Convert.ToDouble(dsChiPhi.ChuyenKhoan).RoundAndApplyFormatMoney(),
                Pos = Convert.ToDouble(dsChiPhi.Pos).RoundAndApplyFormatMoney(),
                tongCongNo = Convert.ToDouble(dsChiPhi.CongNo).RoundAndApplyFormatMoney(),
                GoiHienTai = DateTime.Now.Hour + ":" + DateTime.Now.Minute + ":" + DateTime.Now.Second,
                SoTienThuChi = dsChiPhi.LaPhieuChi ? "Số tiền phải trả BN" : "Số tiền phải thu của BN",
                ThanhTien = Convert.ToDouble(dsChiPhi.SoTienPhaiThuHoacChi).RoundAndApplyFormatMoney(),
                TamUng = Convert.ToDouble(dsChiPhi.TamUng).RoundAndApplyFormatMoney(),
                SoTienBangChu = NumberHelper.ChuyenSoRaText(Math.Round(Convert.ToDouble(dsChiPhi.SoTienPhaiThuHoacChi), MidpointRounding.AwayFromZero)),
                KemTheo = "Chứng từ gốc",
                ChungTu = "Chứng từ gốc",
                MaNB = taiKhoanBenhNhanThu?.YeuCauTiepNhan.BenhNhan.MaBN
            };

            var content = TemplateHelpper.FormatTemplateWithContentTemplate(result.Body, data);
            return content;
        }
        public string GetHtmlPhieuHoanUngNoiTru(long taiKhoanChiId, string hostingName)
        {
            var currentUserId = _userAgentHelper.GetCurrentUserId();
            var nguoiLapPhieu = _userRepository.GetById(currentUserId).HoTen;
            var result = _templateRepository.TableNoTracking.FirstOrDefault(x => x.Name.Equals("PhieuChiHoanUng"));
            var taiKhoanBenhNhanChi = _taiKhoanBenhNhanChiRepository.TableNoTracking.Include(o => o.NhanVienThuHoi).ThenInclude(o => o.User)
                                                                    .Include(o => o.YeuCauTiepNhan).ThenInclude(o => o.NoiTruBenhAn).FirstOrDefault(o => o.Id == taiKhoanChiId);
            var dsChiPhi = GetThongTinPhieuThu(taiKhoanChiId, LoaiPhieuThuChiThuNgan.HoanUng);
            var diaChi = taiKhoanBenhNhanChi?.YeuCauTiepNhan.DiaChiDayDu;

            var data = new
            {
                LogoUrl = hostingName + "/assets/img/logo-bacha-full.png",
                NguoiNhan = taiKhoanBenhNhanChi?.YeuCauTiepNhan.HoTen,
                SoVaoVien = taiKhoanBenhNhanChi?.YeuCauTiepNhan?.NoiTruBenhAn?.SoBenhAn,
                DiaChi = diaChi,
                SoQuyen = taiKhoanBenhNhanChi?.SoQuyen,
                SoPhieu = taiKhoanBenhNhanChi?.SoPhieuHienThi,
                LyDoChi = taiKhoanBenhNhanChi?.NoiDungChi,
                SoTien = Convert.ToDouble(dsChiPhi.TienMat).ApplyFormatMoneyToDouble(),
                SoTienBangChu = NumberHelper.ChuyenSoRaText(Convert.ToDouble(dsChiPhi.TienMat)),
                GoiHienTai = DateTime.Now.Hour + ":" + DateTime.Now.Minute + ":" + DateTime.Now.Second,
                KemTheo = "Chứng từ gốc",
                ChungTu = "Chứng từ gốc"
            };

            var content = TemplateHelpper.FormatTemplateWithContentTemplate(result.Body, data);
            return content;
        }
        public string GetHtmlPhieuHoanThuNoiTru(long taiKhoanChiId, string hostingName)
        {
            var currentUserId = _userAgentHelper.GetCurrentUserId();
            var nguoiLapPhieu = _userRepository.GetById(currentUserId).HoTen;
            var result = _templateRepository.TableNoTracking.FirstOrDefault(x => x.Name.Equals("PhieuHoanThu"));
            var taiKhoanBenhNhanChi = _taiKhoanBenhNhanChiRepository.TableNoTracking.Include(o => o.NhanVienThuHoi).ThenInclude(o => o.User)
                                                                    .Include(o => o.YeuCauTiepNhan).ThenInclude(o => o.NoiTruBenhAn).FirstOrDefault(o => o.Id == taiKhoanChiId);
            var dsChiPhi = GetThongTinPhieuThu(taiKhoanChiId, LoaiPhieuThuChiThuNgan.HoanThu);
            var diaChi = taiKhoanBenhNhanChi?.YeuCauTiepNhan.DiaChiDayDu;

            var data = new
            {
                LogoUrl = hostingName + "/assets/img/logo-bacha-full.png",
                NguoiNhan = taiKhoanBenhNhanChi?.YeuCauTiepNhan.HoTen,
                SoVaoVien = taiKhoanBenhNhanChi?.YeuCauTiepNhan?.NoiTruBenhAn?.SoBenhAn,
                DiaChi = diaChi,
                SoQuyen = taiKhoanBenhNhanChi?.SoQuyen,
                SoPhieu = taiKhoanBenhNhanChi?.SoPhieuHienThi,
                LyDoChi = taiKhoanBenhNhanChi?.NoiDungChi,
                SoTien = Convert.ToDouble(dsChiPhi.TienMat).ApplyFormatMoneyToDouble(),
                SoTienBangChu = NumberHelper.ChuyenSoRaText(Convert.ToDouble(dsChiPhi.TienMat)),
                GoiHienTai = DateTime.Now.Hour + ":" + DateTime.Now.Minute + ":" + DateTime.Now.Second,
                KemTheo = "Chứng từ gốc",
                ChungTu = "Chứng từ gốc"
            };

            var content = TemplateHelpper.FormatTemplateWithContentTemplate(result.Body, data);
            return content;
        }

        public string GetHtmlBangKeCoBHYT(long taiKhoanThuId, string hostingName, ref TaiKhoanBenhNhanThu taiKhoanBenhNhanThu, ref List<ChiPhiKhamChuaBenhNoiTruVo> tatCaDichVuKhamChuaBenh)
        {
            if (taiKhoanBenhNhanThu == null)
            {
                taiKhoanBenhNhanThu = _taiKhoanBenhNhanThuRepository.TableNoTracking.Where(c => c.Id == taiKhoanThuId && c.LoaiThuTienBenhNhan == Enums.LoaiThuTienBenhNhan.ThuTheoChiPhi)
                                                                                    .Include(o => o.YeuCauTiepNhan).ThenInclude(o => o.NoiTruBenhAn).ThenInclude(o => o.ChuyenDenBenhVien)
                                                                                    .Include(o => o.YeuCauTiepNhan).ThenInclude(o => o.NoiTruBenhAn).ThenInclude(o => o.KhoaPhongNhapVien)
                                                                                    .Include(o => o.YeuCauTiepNhan).ThenInclude(o => o.NoiTruBenhAn).ThenInclude(o => o.ChanDoanChinhRaVienICD)
                                                                                    .Include(o => o.YeuCauTiepNhan).ThenInclude(o => o.YeuCauTiepNhanTheBHYTs)
                                                                                    .Include(o => o.YeuCauTiepNhan).ThenInclude(o => o.YeuCauNhapVien).ThenInclude(o => o.YeuCauKhamBenh).ThenInclude(o => o.YeuCauTiepNhan)
                                                                                    .Include(cc => cc.YeuCauTiepNhan)
                                                                                    .ThenInclude(xx => xx.BenhNhan)
                                                                                    .Include(cc => cc.YeuCauTiepNhan)
                                                                                    .ThenInclude(xx => xx.YeuCauKhamBenhs)
                                                                                    .ThenInclude(o => o.YeuCauKhamBenhChuanDoans)
                                                                                    .ThenInclude(o => o.ChuanDoan)
                                                                                    .Include(cc => cc.YeuCauTiepNhan).ThenInclude(cc => cc.PhuongXa)
                                                                                    .Include(cc => cc.YeuCauTiepNhan)
                                                                                    .ThenInclude(cc => cc.QuanHuyen)
                                                                                    .Include(cc => cc.YeuCauTiepNhan)
                                                                                    .ThenInclude(cc => cc.TinhThanh)
                                                                                    .Include(cc => cc.YeuCauTiepNhan).ThenInclude(cc => cc.NoiChuyen)
                                                                                    .Include(o => o.YeuCauTiepNhan).ThenInclude(o => o.NoiTruBenhAn).ThenInclude(o => o.NoiTruPhieuDieuTris).ThenInclude(c => c.ChanDoanChinhICD)
                                                                                    .Include(o => o.YeuCauTiepNhan).ThenInclude(o => o.NoiTruBenhAn).ThenInclude(o => o.NoiTruPhieuDieuTris).ThenInclude(o => o.NoiTruThamKhamChanDoanKemTheos).ThenInclude(c => c.ICD)
                                                                                    .Include(o => o.YeuCauTiepNhan).ThenInclude(o => o.NoiTruBenhAn).ThenInclude(o => o.NoiTruKhoaPhongDieuTris).ThenInclude(c => c.KhoaPhongChuyenDen).FirstOrDefault();

            }
            var yeuCauTiepNhan = taiKhoanBenhNhanThu.YeuCauTiepNhan;
            if(tatCaDichVuKhamChuaBenh == null)
            {
                tatCaDichVuKhamChuaBenh = GetTatCaDichVuKhamChuaBenh(yeuCauTiepNhan.Id).Result;
            }
            var danhSachChiPhi = tatCaDichVuKhamChuaBenh.Where(o => !o.Soluong.AlmostEqual(0) && o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.DaThanhToan && o.KhongTinhPhi != true && o.DuocHuongBHYT && o.MucHuongBaoHiem > 0).ToList();

            if (danhSachChiPhi.Count() == 0)
            {
                return string.Empty;
            }

            var query = taiKhoanBenhNhanThu?.YeuCauTiepNhan;
            var result = _templateRepository.TableNoTracking.FirstOrDefault(x => x.Name.Equals("BangKeKhamBenhBHYTVaBenhVien"));

            if (yeuCauTiepNhan == null)
                return string.Empty;

            var benhVien = new Core.Domain.Entities.BenhVien.BenhVien();

            string maBHYT = string.Empty;
            string bHYTTuNgay = string.Empty;
            string bHYTDenNgay = string.Empty;
            string mucHuong = string.Empty;
            string NoiDKKCBBanDau = string.Empty;
            string MaKCBBanDau = string.Empty;


            string maICDKemTheo = string.Empty;
            string tenICDKemTheo = string.Empty;


            string chuanDoanXacDinhSanKhoa = string.Empty;
            string maICD10 = string.Empty;

            if (yeuCauTiepNhan.NoiTruBenhAn != null && (yeuCauTiepNhan.NoiTruBenhAn.LoaiBenhAn == LoaiBenhAn.SanKhoaMo || yeuCauTiepNhan.NoiTruBenhAn.LoaiBenhAn == LoaiBenhAn.SanKhoaThuong))
            {
                if (yeuCauTiepNhan.NoiTruBenhAn?.NoiTruPhieuDieuTris.Count() > 0)
                {
                    var phieuDieuTri = yeuCauTiepNhan.NoiTruBenhAn?.NoiTruPhieuDieuTris.OrderByDescending(c => c.NgayDieuTri).FirstOrDefault();

                    var icdKemTheoIds = phieuDieuTri.NoiTruThamKhamChanDoanKemTheos.Select(c => c.ICD.Ma);
                    var tenICDKemTheos = phieuDieuTri.NoiTruThamKhamChanDoanKemTheos.Select(c => c.GhiChu);

                    maICDKemTheo = string.Join(", ", icdKemTheoIds);
                    tenICDKemTheo = string.Join(", ", tenICDKemTheos);


                    maICD10 = phieuDieuTri.ChanDoanChinhICD?.Ma;
                    chuanDoanXacDinhSanKhoa = phieuDieuTri.ChanDoanChinhGhiChu;
                }
            }
            else
            {
                if (!string.IsNullOrEmpty(yeuCauTiepNhan.NoiTruBenhAn?.DanhSachChanDoanKemTheoRaVienICDId))
                {
                    var maICDKemTheos = new List<string>();

                    var icdKemTheoIds = yeuCauTiepNhan.NoiTruBenhAn?.DanhSachChanDoanKemTheoRaVienICDId.Split(Constants.ICDSeparator);
                    var tenICDKemTheos = yeuCauTiepNhan.NoiTruBenhAn?.DanhSachChanDoanKemTheoRaVienGhiChu?.Split(Constants.ICDSeparator);

                    if (icdKemTheoIds.Length > 0)
                    {
                        foreach (var icdKemTheoId in icdKemTheoIds)
                        {
                            var icdKemTheo = _icdRepository.TableNoTracking.FirstOrDefault(o => o.Id == long.Parse(icdKemTheoId));
                            if (icdKemTheo != null)
                            {
                                maICDKemTheos.Add(icdKemTheo.Ma);
                            }

                            //if (long.TryParse(yeuCauTiepNhan.NoiTruBenhAn?.DanhSachChanDoanKemTheoRaVienICDId.Split(Constants.ICDSeparator).First(), out var icdKemTheoId))
                            //{
                            //    var icdKemTheo = _icdRepository.TableNoTracking.FirstOrDefault(o => o.Id == icdKemTheoId);
                            //    if (icdKemTheo != null)
                            //    {
                            //        maICDKemTheo = icdKemTheo.Ma;
                            //        tenICDKemTheo = yeuCauTiepNhan.NoiTruBenhAn?.DanhSachChanDoanKemTheoRaVienGhiChu?.Split(Constants.ICDSeparator).First();
                            //    }
                            //}
                        }
                    }

                    maICDKemTheo = string.Join(", ", maICDKemTheos);
                    tenICDKemTheo = string.Join(", ", tenICDKemTheos);
                }
            }

            YeuCauTiepNhanTheBHYT theBHYT = null;
            if (yeuCauTiepNhan.CoBHYT == true && yeuCauTiepNhan.YeuCauTiepNhanTheBHYTs.Any())
            {
                theBHYT = yeuCauTiepNhan.YeuCauTiepNhanTheBHYTs.First();
                if (!String.IsNullOrEmpty(theBHYT.MaDKBD))
                {
                    benhVien = _benhVienRepository.TableNoTracking.FirstOrDefault(p => p.Ma.Equals(theBHYT.MaDKBD));
                }
                maBHYT = theBHYT.MaSoThe;
                bHYTTuNgay = theBHYT.NgayHieuLuc.ApplyFormatDate();
                bHYTDenNgay = theBHYT.NgayHetHan?.ApplyFormatDate();
                mucHuong = theBHYT.MucHuong.ToString() + "%";
                NoiDKKCBBanDau = benhVien != null ? benhVien?.Ten : "Chưa xác định";
                MaKCBBanDau = theBHYT.MaDKBD;
            }
            else
            {
                maBHYT = "";
                bHYTTuNgay = "";
                bHYTDenNgay = "";
                mucHuong = "0%";
                NoiDKKCBBanDau = "Chưa xác định";
                MaKCBBanDau = "Chưa xác định";
            }

            //var thongTinPhieuThus = GetThongTinPhieuThu(taiKhoanThuId, LoaiPhieuThuChiThuNgan.ThuTheoChiPhi);
            //if (thongTinPhieuThus.ChiPhiKhamChuaBenhNoiTruVos.Where(o => o.KhongTinhPhi != true && o.DuocHuongBHYT && o.MucHuongBaoHiem > 0).Count() == 0)
            //{
            //    return string.Empty;
            //}
            var dsChiPhiBangKe = new List<BangKeKhamBenhCoBHYTVo>();
            var dateItemChiPhis = string.Empty;
            int indexItem = 1;
            var groupChiPhiTheoThe = danhSachChiPhi.GroupBy(o => o.MaSoTheBHYT);

            var ngayNhapVien = yeuCauTiepNhan.NoiTruBenhAn.ThoiDiemNhapVien.ApplyFormatDate();
            var ngayRaVien = yeuCauTiepNhan.NoiTruBenhAn.ThoiDiemRaVien?.ApplyFormatDate();

            if (groupChiPhiTheoThe.Count() > 2 ||
                (groupChiPhiTheoThe.All(o => o.Key != string.Empty) && groupChiPhiTheoThe.Count() > 1))
            {
                var groupNgayPhatSinhTheoThe = groupChiPhiTheoThe.Where(o => o.Key != string.Empty).Select(o => new { o.Key, o.OrderBy(j => j.NgayPhatSinh).First().NgayPhatSinh }).OrderBy(o => o.NgayPhatSinh).ToArray();
                for (int i = 0; i < groupNgayPhatSinhTheoThe.Count(); i++)
                {
                    var ngayPhatSinhTheoThe = groupNgayPhatSinhTheoThe[i];
                    var theBHYTChiTra = yeuCauTiepNhan.YeuCauTiepNhanTheBHYTs.First(o => o.MaSoThe == ngayPhatSinhTheoThe.Key);
                    var chiPhis = groupChiPhiTheoThe.FirstOrDefault(o => o.Key == ngayPhatSinhTheoThe.Key).ToList();
                    DateTime? ngayPhatSinhTiepTheo = i < groupNgayPhatSinhTheoThe.Count() - 1
                        ? groupNgayPhatSinhTheoThe[i + 1].NgayPhatSinh
                        : null;
                    chiPhis.AddRange(groupChiPhiTheoThe.FirstOrDefault(o => o.Key == string.Empty).Where(j => (i == 0 || j.NgayPhatSinh >= ngayPhatSinhTheoThe.NgayPhatSinh) && (ngayPhatSinhTiepTheo != null && j.NgayPhatSinh < ngayPhatSinhTiepTheo)).ToList());

                    var mucHuongPT = theBHYTChiTra != null && theBHYTChiTra?.MucHuong > 0 ? theBHYTChiTra?.MucHuong + "%" : string.Empty;

                    dateItemChiPhis += "<table style='width: 100 %;margin-bottom:-21px; '>" +
                                       "<tbody>" +
                                       "<tr>" +
                                       $"<td style='padding-left:-5px; width: 40 %; '>Mã thẻ BHYT {i + 1}: <b>{theBHYTChiTra.MaSoThe}</b> " +
                                       $"<span style='padding-left:20px'>Giá trị từ: <b>{theBHYTChiTra.NgayHieuLuc.ApplyFormatDate()}</b> đến <b>{theBHYTChiTra.NgayHetHan?.ApplyFormatDate()}</b></span>" +
                                       $"<span style='padding-left:20px'>Mức hưởng: <b>{mucHuongPT}</b></span></td>" +
                                       "</tr>" +

                                      //Thêm dòng: (Chi phí KCB tính từ ngày...đến ngày...) BVHD-3792
                                      "<tr>" +
                                       $"<td>" +
                                       $"<span> (Chi phí KCB tính từ ngày <b>{ngayNhapVien}</b> đến ngày <b>{ngayRaVien}</b>) </span></td>" +
                                      "</tr>" +

                                       "</tbody>" +
                                       "</table>" +
                                       "</br>" +
                                       "<table style='width:100%;border: 1px solid #020000; border-collapse: collapse;'>" +
                                            "<tr style='border: 1px solid black;  border-collapse: collapse;'>" +
                                            "<th style='border: 1px solid #020000; border-collapse: collapse;text-align: center;' rowspan='2'>" +
                                                    "STT </th>" +
                                                "<th style='border: 1px solid #020000; border-collapse: collapse;width:35%;text-align: center;' rowspan='2'>" +
                                                    "Nội dung </th>" +
                                                "<th style='border: 1px solid #020000; border-collapse: collapse;width:5%;text-align: center;' rowspan='2'>" +
                                                    "Đơn vị tính</th>" +
                                                "<th style='border: 1px solid #020000; border-collapse: collapse;width:3%; text-align: center;' rowspan='2'>" +
                                                    "Số lượng</th>" +
                                                "<th style='border: 1px solid #020000; border-collapse: collapse;width:3%; text-align: center;' rowspan='2'>" +
                                                    "Đơn giá BV <span style='font-weight: 100;'>(đồng)</span></th>" +
                                                "<th style='border: 1px solid #020000; border-collapse: collapse;width:3%; text-align: center;' rowspan='2'>" +
                                                    "Đơn giá BH  <span style='font-weight: 100;'>(đồng)</span></th>" +
                                                "<th style='border: 1px solid #020000; border-collapse: collapse;width:200px; text-align: center;'" +
                                                    "rowspan='2'>" +
                                                    "Tỉ lệ thanh toán theo dich vụ   <span style='font-weight: 100;'>(%)</span></th>" +
                                                "<th style='border: 1px solid #020000; border-collapse: collapse;width:8%;text-align: center;' rowspan='2'>" +
                                                    "Thành tiền BV  <span style='font-weight: 100;'>(đồng)</span>" +
                                                "</th>" +
                                                "<th style='border: 1px solid #020000; border-collapse: collapse;width:200px; text-align: center;'" +
                                                    "rowspan='2'>" +
                                                    "Tỷ lệ thanh toán BHYT <span style='font-weight: 100;'>(%)</span>" +
                                                "</th>" +
                                                "<th style='border: 1px solid #020000; border-collapse: collapse;width:8%;text-align: center;' rowspan='2'>" +
                                                    "Thành tiền BH  <span style='font-weight: 100;'>(đồng)</span>" +
                                                "</th>" +
                                                "<th style='border: 1px solid #020000; border-collapse: collapse;width:35%;text-align: center;' colspan='4'>" +
                                                    "Nguồn thanh toán  <span style='font-weight: 100;'>(đồng)</span></th>" +
                                            "</tr>" +
                                            "<tr style='border: 1px solid #020000; border-collapse: collapse;'>" +
                                                "<td style='border: 1px solid #020000; border-collapse: collapse;text-align: center;'><b>Quỹ BHYT</b></td>" +
                                                "<td style=' border: 1px solid #020000; border-collapse: collapse;width:80px;text-align: center;'>" +
                                                    "<b>Người bệnh cùng chi" +
                                                    " trả</b> (đồng)</td>" +
                                                "<td style=' border: 1px solid #020000; border-collapse: collapse;text-align: center;'><b>Khác</b> (đồng)</td>" +
                                                "<td style='border: 1px solid #020000; border-collapse: collapse;text-align: center;width: 90px;'>" +
                                                    "<b>Người bệnh" +
                                                    "tự trả </b>(đồng)" +
                                                "</td>" +
                                            "</tr>" +
                                            "<tr style=' border: 1px solid #020000; '>" +
                                              "<td style='border: 1px solid #020000;text-align: center;'><b> </b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(1)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(2)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(3)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(4)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(5)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(6)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(7)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(8)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(9)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(10)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(11)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(12)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(13)</b> </td>" +
                                            "</tr>";


                    var dsChiPhiBangKeTheoThe = new List<BangKeKhamBenhCoBHYTVo>();
                    //ThuocDichTruyen và VatTuYte
                    foreach (var chiPhi in chiPhis.Where(c => c.NhomChiPhiBangKe != NhomChiPhiBangKe.GoiVatTu).GroupBy(c => new { c.NhomChiPhiBangKe, c.TenDichVu, c.DonViTinh, c.DuocHuongBHYT, c.DonGia, c.DonGiaBHYT, c.MucHuongBaoHiem, c.TiLeBaoHiemThanhToan }).OrderByDescending(o => o.Key.DuocHuongBHYT))
                    {
                        dsChiPhiBangKeTheoThe.Add(new BangKeKhamBenhCoBHYTVo
                        {
                            Nhom = chiPhi.Key.NhomChiPhiBangKe,
                            Id = chiPhi.FirstOrDefault().Id,
                            NoiDung = chiPhi.Key.TenDichVu,
                            DonViTinh = chiPhi.Key.DonViTinh,
                            SoLuong = (decimal)chiPhi.Sum(c => c.Soluong),
                            DuocHuongBaoHiem = chiPhi.Key.DuocHuongBHYT,
                            DonGiaBH = chiPhi.Key.DonGiaBHYT,
                            DonGiaTheoBV = chiPhi.Key.DonGia,
                            MucHuongBaoHiem = chiPhi.Key.MucHuongBaoHiem,
                            TiLeThanhToanTheoDV = chiPhi.Key.TiLeBaoHiemThanhToan,
                            BaoHiemChiTra = true
                        });

                    }

                    foreach (var chiPhi in chiPhis.Where(c => c.NhomChiPhiBangKe == NhomChiPhiBangKe.GoiVatTu).OrderByDescending(o => o.DuocHuongBHYT))
                    {
                        dsChiPhiBangKeTheoThe.Add(new BangKeKhamBenhCoBHYTVo
                        {
                            Nhom = chiPhi.NhomChiPhiBangKe,
                            Id = chiPhi.Id,
                            NoiDung = chiPhi.TenDichVu,
                            DonViTinh = chiPhi.DonViTinh,
                            SoLuong = (decimal)chiPhi.Soluong,
                            DuocHuongBaoHiem = chiPhi.DuocHuongBHYT,
                            DonGiaBH = chiPhi.DonGiaBHYT,
                            DonGiaTheoBV = chiPhi.DonGia,
                            MucHuongBaoHiem = chiPhi.MucHuongBaoHiem,
                            TiLeThanhToanTheoDV = chiPhi.TiLeBaoHiemThanhToan,
                            BaoHiemChiTra = true
                        });
                    }
                    dsChiPhiBangKe.AddRange(dsChiPhiBangKeTheoThe);
                    var groupChiPhiBangKes = dsChiPhiBangKeTheoThe.GroupBy(x => x.Nhom).OrderBy(o => (int)o.Key * (o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay || o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriNoiTru ? 1 : 10));
                    foreach (var groupChiPhiBangKe in groupChiPhiBangKes)
                    {
                        if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay)
                        {

                            dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                               "<td style='border: 1px solid #020000;' colspan='7'>" +
                                               "<span style='float:left;'><b>2. Ngày giường:  </b></span>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                               "</tr>";
                            dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                               "<td style='border: 1px solid #020000;' colspan='7'>" +
                                               "<span style='float:left;'><b>2.1." + groupChiPhiBangKe.Key.GetDescription() + "  </b></span>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b> " + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true) + "</b> </td>" +
                                               "</tr>";
                        }
                        else if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.NgayGiuongDieuTriNoiTru)
                        {
                            if (!groupChiPhiBangKes.Any(o => o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay))
                            {
                                dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                                   "<td style='border: 1px solid #020000;' colspan='7'>" +
                                                   "<span style='float:left;'><b>2. Ngày giường:  </b></span>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                   "</tr>";
                            }
                            dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                               "<td style='border: 1px solid #020000;' colspan='7'>" +
                                               "<span style='float:left;'><b>2.2." + groupChiPhiBangKe.Key.GetDescription() + "  </b></span>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b> " + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true) + "</b> </td>" +
                                               "</tr>";
                        }
                        else
                        {
                            dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                               "<td style='border: 1px solid #020000;' colspan='7'>" +
                                               "<span style='float:left;'><b>" + (int)groupChiPhiBangKe.Key + "." + groupChiPhiBangKe.Key.GetDescription() + "  </b></span>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b> " + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true) + "</b> </td>" +
                                               "</tr>";
                        }
                        if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.GoiVatTu)
                        {
                            var groupGoiVatTus = groupChiPhiBangKe.ToList().GroupBy(o => o.SoGoiVatTu.GetValueOrDefault()).OrderBy(o => o.Key);
                            int sttGoiVatTu = 1;
                            foreach (var groupGoiVatTu in groupGoiVatTus)
                            {
                                dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                                   "<td style='border: 1px solid #020000;' colspan='7'>" +
                                                   "<span style='float:left;'><b>10." + sttGoiVatTu + ". " + groupChiPhiBangKe.Key.GetDescription() + " " + sttGoiVatTu + "  </b></span>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.Khac)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'><b> " + Convert.ToDouble(groupGoiVatTu.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true) + "</b> </td>" +
                                                   "</tr>";
                                foreach (var chiPhiBangKe in groupGoiVatTu)
                                {
                                    dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                                    "<td style='border: 1px solid #020000; text-align: center;'> " + indexItem + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: left;'> " + chiPhiBangKe.NoiDung + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: center;'>  " + chiPhiBangKe.DonViTinh + " </td>" +
                                                    "<td style='border: 1px solid #020000;text-align: center;'> " + chiPhiBangKe.SoLuong + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: center;'> " + Convert.ToDouble(chiPhiBangKe.DonGiaBV).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: center;'> " + Convert.ToDouble(chiPhiBangKe.DonGiaBH).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.TiLeThanhToanTheoDV).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.ThanhTienBV).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.MucHuongBaoHiem > 0 ? 100 : 0).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.ThanhTienBH).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.QuyBHYT).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.NguoiBenhCungChiTra).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.Khac).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.NguoiBenhTuTra).ApplyFormatMoneyToDouble(true) + "</td>" +
                                                    "</tr>";
                                    indexItem++;
                                }
                            }
                        }
                        else
                        {
                            foreach (var chiPhiBangKe in groupChiPhiBangKe)
                            {
                                dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                                "<td style='border: 1px solid #020000; text-align: center;'> " + indexItem + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: left;'> " + chiPhiBangKe.NoiDung + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'>  " + chiPhiBangKe.DonViTinh + " </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'> " + chiPhiBangKe.SoLuong + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'> " + Convert.ToDouble(chiPhiBangKe.DonGiaBV).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'> " + Convert.ToDouble(chiPhiBangKe.DonGiaBH).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.TiLeThanhToanTheoDV).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.ThanhTienBV).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.MucHuongBaoHiem > 0 ? 100 : 0).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.ThanhTienBH).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.QuyBHYT).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.NguoiBenhCungChiTra).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.Khac).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.NguoiBenhTuTra).ApplyFormatMoneyToDouble(true) + "</td>" +
                                                "</tr>";
                                indexItem++;
                            }
                        }

                    }

                    dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                       "<td style='border: 1px solid #020000;' colspan='7'></span>" +
                                       "<span style='float:right;padding-right: 50px;'><b>Tổng Cộng</b></span>" +
                                       "</td>" +
                                       $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKeTheoThe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                       $"<td style='border: 1px solid #020000;text-align: right;'><b></b> </td>" +
                                       $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKeTheoThe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                       $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKeTheoThe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                       $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKeTheoThe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                       $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKeTheoThe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                       $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKeTheoThe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true)}</b> </td>" +
                                       "</tr>" +
                                       "</table>";
                }
            }
            else
            {
                YeuCauTiepNhanTheBHYT theBHYTChiTra = null;
                var maSoThe = groupChiPhiTheoThe.Where(o => o.Key != string.Empty).FirstOrDefault()?.Key;
                if (!string.IsNullOrEmpty(maSoThe))
                {
                    theBHYTChiTra = yeuCauTiepNhan.YeuCauTiepNhanTheBHYTs.First(o => o.MaSoThe == maSoThe);
                }

                var chiPhis = groupChiPhiTheoThe.SelectMany(o => o).ToList();
                var mucHuongPT = theBHYTChiTra != null && theBHYTChiTra?.MucHuong > 0 ? theBHYTChiTra?.MucHuong + "%" : string.Empty;

                dateItemChiPhis += "<table style='width: 100 %;margin-bottom:-21px; '>" +
                                    "<tbody>" +
                                     "<tr>" +
                                       $"<td style='padding-left: -5px; width: 40 %; '>Mã thẻ BHYT: <b>{theBHYTChiTra?.MaSoThe}</b> " +
                                       $"<span style='padding-left:20px'>Giá trị từ: <b>{theBHYTChiTra?.NgayHieuLuc.ApplyFormatDate()}</b> đến <b>{theBHYTChiTra?.NgayHetHan?.ApplyFormatDate()}</b></span>" +
                                       $"<span style='padding-left:20px'>Mức hưởng: <b>{mucHuongPT}</b></span></td>" +
                                     "</tr>" +

                                     //Thêm dòng: (Chi phí KCB tính từ ngày...đến ngày...) BVHD-3792
                                     "<tr>" +
                                       $"<td>" +
                                       $"<span> (Chi phí KCB tính từ ngày <b>{ngayNhapVien}</b> đến ngày <b>{ngayRaVien}</b>) </span></td>" +
                                     "</tr>" +

                                    "</tbody>" +
                                    "</table>" +
                                    "</br>" +
                                    "<table style='width:100%;border: 1px solid #020000; border-collapse: collapse;'>" +
                                        "<tr style='border: 1px solid black;  border-collapse: collapse;'>" +
                                        "<th style='border: 1px solid #020000; border-collapse: collapse;text-align: center;' rowspan='2'>" +
                                                "STT </th>" +
                                            "<th style='border: 1px solid #020000; border-collapse: collapse;width:35%;text-align: center;' rowspan='2'>" +
                                                "Nội dung </th>" +
                                            "<th style='border: 1px solid #020000; border-collapse: collapse;width:5%;text-align: center;' rowspan='2'>" +
                                                "Đơn vị tính</th>" +
                                            "<th style='border: 1px solid #020000; border-collapse: collapse;width:3%; text-align: center;' rowspan='2'>" +
                                                "Số lượng</th>" +
                                            "<th style='border: 1px solid #020000; border-collapse: collapse;width:3%; text-align: center;' rowspan='2'>" +
                                                "Đơn giá BV <span style='font-weight: 100;'>(đồng)</span></th>" +
                                            "<th style='border: 1px solid #020000; border-collapse: collapse;width:3%; text-align: center;' rowspan='2'>" +
                                                "Đơn giá BH  <span style='font-weight: 100;'>(đồng)</span></th>" +
                                            "<th style='border: 1px solid #020000; border-collapse: collapse;width:200px; text-align: center;'" +
                                                "rowspan='2'>" +
                                                "Tỉ lệ thanh toán theo dich vụ   <span style='font-weight: 100;'>(%)</span></th>" +
                                            "<th style='border: 1px solid #020000; border-collapse: collapse;width:8%;text-align: center;' rowspan='2'>" +
                                                "Thành tiền BV  <span style='font-weight: 100;'>(đồng)</span>" +
                                            "</th>" +
                                            "<th style='border: 1px solid #020000; border-collapse: collapse;width:200px; text-align: center;'" +
                                                "rowspan='2'>" +
                                                "Tỷ lệ thanh toán BHYT <span style='font-weight: 100;'>(%)</span>" +
                                            "</th>" +
                                            "<th style='border: 1px solid #020000; border-collapse: collapse;width:8%;text-align: center;' rowspan='2'>" +
                                                "Thành tiền BH  <span style='font-weight: 100;'>(đồng)</span>" +
                                            "</th>" +
                                            "<th style='border: 1px solid #020000; border-collapse: collapse;width:35%;text-align: center;' colspan='4'>" +
                                                "Nguồn thanh toán  <span style='font-weight: 100;'>(đồng)</span></th>" +
                                        "</tr>" +
                                        "<tr style='border: 1px solid #020000; border-collapse: collapse;'>" +
                                            "<td style='border: 1px solid #020000; border-collapse: collapse;text-align: center;'><b>Quỹ BHYT</b></td>" +
                                            "<td style=' border: 1px solid #020000; border-collapse: collapse;width:80px;text-align: center;'>" +
                                                "<b>Người bệnh cùng chi" +
                                                " trả</b> (đồng)</td>" +
                                            "<td style=' border: 1px solid #020000; border-collapse: collapse;text-align: center;'><b>Khác</b> (đồng)</td>" +
                                            "<td style='border: 1px solid #020000; border-collapse: collapse;text-align: center;width: 90px;'>" +
                                                "<b>Người bệnh" +
                                                "tự trả </b>(đồng)" +
                                            "</td>" +
                                        "</tr>" +
                                        "<tr style=' border: 1px solid #020000; '>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b> </b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b>(1)</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b>(2)</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b>(3)</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b>(4)</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b>(5)</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b>(6)</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b>(7)</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b>(8)</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b>(9)</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b>(10)</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b>(11)</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b>(12)</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b>(13)</b> </td>" +
                                        "</tr>";


                //ThuocDichTruyen và VatTuYte
                foreach (var chiPhi in chiPhis.Where(c => c.NhomChiPhiBangKe != NhomChiPhiBangKe.GoiVatTu).GroupBy(c => new { c.NhomChiPhiBangKe, c.TenDichVu, c.DonViTinh, c.DuocHuongBHYT, c.DonGia, c.DonGiaBHYT, c.MucHuongBaoHiem, c.TiLeBaoHiemThanhToan }).OrderByDescending(o => o.Key.DuocHuongBHYT))
                {
                    dsChiPhiBangKe.Add(new BangKeKhamBenhCoBHYTVo
                    {
                        Nhom = chiPhi.Key.NhomChiPhiBangKe,
                        Id = chiPhi.FirstOrDefault().Id,
                        NoiDung = chiPhi.Key.TenDichVu,
                        DonViTinh = chiPhi.Key.DonViTinh,
                        SoLuong = (decimal)chiPhi.Sum(c => c.Soluong),
                        DuocHuongBaoHiem = chiPhi.Key.DuocHuongBHYT,
                        DonGiaBH = chiPhi.Key.DonGiaBHYT,
                        DonGiaTheoBV = chiPhi.Key.DonGia,
                        MucHuongBaoHiem = chiPhi.Key.MucHuongBaoHiem,
                        TiLeThanhToanTheoDV = chiPhi.Key.TiLeBaoHiemThanhToan,
                        BaoHiemChiTra = true
                    });

                }

                foreach (var chiPhi in chiPhis.Where(c => c.NhomChiPhiBangKe == NhomChiPhiBangKe.GoiVatTu).OrderByDescending(o => o.DuocHuongBHYT))
                {
                    dsChiPhiBangKe.Add(new BangKeKhamBenhCoBHYTVo
                    {
                        Nhom = chiPhi.NhomChiPhiBangKe,
                        Id = chiPhi.Id,
                        NoiDung = chiPhi.TenDichVu,
                        DonViTinh = chiPhi.DonViTinh,
                        SoLuong = (decimal)chiPhi.Soluong,
                        DuocHuongBaoHiem = chiPhi.DuocHuongBHYT,
                        DonGiaBH = chiPhi.DonGiaBHYT,
                        DonGiaTheoBV = chiPhi.DonGia,
                        MucHuongBaoHiem = chiPhi.MucHuongBaoHiem,
                        TiLeThanhToanTheoDV = chiPhi.TiLeBaoHiemThanhToan,
                        BaoHiemChiTra = true
                    });
                }
                var groupChiPhiBangKes = dsChiPhiBangKe.GroupBy(x => x.Nhom).OrderBy(o => (int)o.Key * (o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay || o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriNoiTru ? 1 : 10));
                foreach (var groupChiPhiBangKe in groupChiPhiBangKes)
                {
                    if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay)
                    {

                        dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                            "<td style='border: 1px solid #020000;' colspan='7'>" +
                                            "<span style='float:left;'><b>2. Ngày giường:  </b></span>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                            "</tr>";
                        dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                            "<td style='border: 1px solid #020000;' colspan='7'>" +
                                            "<span style='float:left;'><b>2.1." + groupChiPhiBangKe.Key.GetDescription() + "  </b></span>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b> " + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true) + "</b> </td>" +
                                            "</tr>";
                    }
                    else if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.NgayGiuongDieuTriNoiTru)
                    {
                        if (!groupChiPhiBangKes.Any(o => o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay))
                        {
                            dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                                "<td style='border: 1px solid #020000;' colspan='7'>" +
                                                "<span style='float:left;'><b>2. Ngày giường:  </b></span>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                "</tr>";
                        }
                        dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                            "<td style='border: 1px solid #020000;' colspan='7'>" +
                                            "<span style='float:left;'><b>2.2." + groupChiPhiBangKe.Key.GetDescription() + "  </b></span>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b> " + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true) + "</b> </td>" +
                                            "</tr>";
                    }
                    else
                    {
                        dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                            "<td style='border: 1px solid #020000;' colspan='7'>" +
                                            "<span style='float:left;'><b>" + (int)groupChiPhiBangKe.Key + "." + groupChiPhiBangKe.Key.GetDescription() + "  </b></span>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b> " + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true) + "</b> </td>" +
                                            "</tr>";
                    }
                    if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.GoiVatTu)
                    {
                        var groupGoiVatTus = groupChiPhiBangKe.ToList().GroupBy(o => o.SoGoiVatTu.GetValueOrDefault()).OrderBy(o => o.Key);
                        int sttGoiVatTu = 1;
                        foreach (var groupGoiVatTu in groupGoiVatTus)
                        {
                            dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                                "<td style='border: 1px solid #020000;' colspan='7'>" +
                                                "<span style='float:left;'><b>10." + sttGoiVatTu + ". " + groupChiPhiBangKe.Key.GetDescription() + " " + sttGoiVatTu + "  </b></span>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.Khac)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'><b> " + Convert.ToDouble(groupGoiVatTu.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true) + "</b> </td>" +
                                                "</tr>";
                            foreach (var chiPhiBangKe in groupGoiVatTu)
                            {
                                dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                                "<td style='border: 1px solid #020000; text-align: center;'> " + indexItem + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: left;'> " + chiPhiBangKe.NoiDung + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'>  " + chiPhiBangKe.DonViTinh + " </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'> " + chiPhiBangKe.SoLuong + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'> " + Convert.ToDouble(chiPhiBangKe.DonGiaBV).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'> " + Convert.ToDouble(chiPhiBangKe.DonGiaBH).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.TiLeThanhToanTheoDV).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.ThanhTienBV).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.MucHuongBaoHiem > 0 ? 100 : 0).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.ThanhTienBH).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.QuyBHYT).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.NguoiBenhCungChiTra).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.Khac).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.NguoiBenhTuTra).ApplyFormatMoneyToDouble(true) + "</td>" +
                                                "</tr>";
                                indexItem++;
                            }
                        }
                    }
                    else
                    {
                        foreach (var chiPhiBangKe in groupChiPhiBangKe)
                        {
                            dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                            "<td style='border: 1px solid #020000; text-align: center;'> " + indexItem + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: left;'> " + chiPhiBangKe.NoiDung + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'>  " + chiPhiBangKe.DonViTinh + " </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'> " + chiPhiBangKe.SoLuong + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'> " + Convert.ToDouble(chiPhiBangKe.DonGiaBV).ApplyFormatMoneyToDouble() + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'> " + Convert.ToDouble(chiPhiBangKe.DonGiaBH).ApplyFormatMoneyToDouble() + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.TiLeThanhToanTheoDV).ApplyFormatMoneyToDouble() + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.ThanhTienBV).ApplyFormatMoneyToDouble() + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.MucHuongBaoHiem > 0 ? 100 : 0).ApplyFormatMoneyToDouble() + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.ThanhTienBH).ApplyFormatMoneyToDouble() + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.QuyBHYT).ApplyFormatMoneyToDouble() + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.NguoiBenhCungChiTra).ApplyFormatMoneyToDouble() + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.Khac).ApplyFormatMoneyToDouble() + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.NguoiBenhTuTra).ApplyFormatMoneyToDouble(true) + "</td>" +
                                            "</tr>";
                            indexItem++;
                        }
                    }

                }

                dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                    "<td style='border: 1px solid #020000;' colspan='7'></span>" +
                                    "<span style='float:right;padding-right: 50px;'><b>Tổng Cộng</b></span>" +
                                    "</td>" +
                                    $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                    $"<td style='border: 1px solid #020000;text-align: right;'><b></b> </td>" +
                                    $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                    $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                    $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                    $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                    $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true)}</b> </td>" +
                                    "</tr>" +
                                    "</table>";

            }

            var checkedLyDoVaoVien = "<input id='demo_box_2' class='css - checkbox' type='checkbox' checked  disabled='true'/>";
            var unCheckedLyDoVaoVien = "<input id='demo_box_2' class='css - checkbox' type='checkbox' disabled='true' />";

            var khoaPhong = yeuCauTiepNhan.NoiTruBenhAn?.NoiTruKhoaPhongDieuTris.OrderByDescending(c => c.ThoiDiemVaoKhoa).Select(c => c.KhoaPhongChuyenDen).FirstOrDefault();
            var chuyenKhoa = GetChuyenKhoa(khoaPhong?.Id); //BVHD-3792 

            var data = new
            {
                TitleBangKe = "ĐIỀU TRỊ NỘI TRÚ",
                SoBangKe = "3",
                yeuCauTiepNhan.BenhNhan.MaBN,
                MaTN = yeuCauTiepNhan.MaYeuCauTiepNhan,
                SoBenhAn = "Số bệnh án: " + yeuCauTiepNhan.NoiTruBenhAn?.SoBenhAn,
                yeuCauTiepNhan.HoTen,
                DiaChi = yeuCauTiepNhan.DiaChiDayDu,
                BarCodeImgBase64 = !string.IsNullOrEmpty(yeuCauTiepNhan.MaYeuCauTiepNhan) ? BarcodeHelper.GenerateBarCode(yeuCauTiepNhan.MaYeuCauTiepNhan) : "",
                NamSinh = DateHelper.DOBFormat(yeuCauTiepNhan.NgaySinh, yeuCauTiepNhan.ThangSinh, yeuCauTiepNhan.NamSinh),
                GioiTinh = yeuCauTiepNhan.GioiTinh != null ? yeuCauTiepNhan.GioiTinh.GetDescription() : "",


                //TenKhoa = "Khoa: " + yeuCauTiepNhan.NoiTruBenhAn?.KhoaPhongNhapVien?.Ten,
                //MaKhoa = "Mã khoa: " + yeuCauTiepNhan.NoiTruBenhAn?.KhoaPhongNhapVien?.Ma,

                TenKhoa = "Khoa: " + khoaPhong?.Ten,
                MaKhoa = "Mã khoa: " + chuyenKhoa?.Ma,


                MaBHYT = theBHYT?.MaSoThe,
                BHYTTuNgay = bHYTTuNgay,
                BHYTDenNgay = bHYTDenNgay,
                NoiDKKCBBanDau,
                MaKCBBanDau,
                NgayDenKham = yeuCauTiepNhan.YeuCauNhapVien?.YeuCauKhamBenh?.YeuCauTiepNhan.ThoiDiemTiepNhan.ApplyFormatGioPhutNgay(),
                DieuTriKNT = yeuCauTiepNhan.NoiTruBenhAn?.ThoiDiemNhapVien.ApplyFormatGioPhutNgay(),
                KetThucKhamNgoaiTru = yeuCauTiepNhan.NoiTruBenhAn?.ThoiDiemRaVien?.ApplyFormatGioPhutNgay(),
                SoNgayDTri = NoiTruBenhAnHelper.TinhSoNgayDieuTri(yeuCauTiepNhan.NoiTruBenhAn)?.ToString() ?? string.Empty,//yeuCauTiepNhan.NoiTruBenhAn?.ThoiDiemRaVien == null ? "" : (yeuCauTiepNhan.NoiTruBenhAn.ThoiDiemRaVien.Value.Date.AddDays(1) - yeuCauTiepNhan.NoiTruBenhAn.ThoiDiemNhapVien.Date).Days.ToString(),
                TinhTrangRaVien = yeuCauTiepNhan.NoiTruBenhAn?.TinhTrangRaVien == EnumTinhTrangRaVien.RaVien && (yeuCauTiepNhan.NoiTruBenhAn?.KetQuaDieuTri == EnumKetQuaDieuTri.Do || yeuCauTiepNhan.NoiTruBenhAn?.KetQuaDieuTri == EnumKetQuaDieuTri.Khoi) ? 1 : 2,
                MucHuong = mucHuong,
                NoiChuyenDen = yeuCauTiepNhan.NoiChuyen?.Ten,
                NoiChuyenDi = yeuCauTiepNhan.NoiTruBenhAn?.ChuyenDenBenhVien?.Ten,
                MKV = theBHYT?.MaKhuVuc,
                NgayMiemCungTC = theBHYT?.NgayDuocMienCungChiTra?.ApplyFormatDate(),
                ThoiGian5Nam = theBHYT?.NgayDu5Nam?.ApplyFormatDate(),
                CoCapCuu = yeuCauTiepNhan.LyDoVaoVien == Enums.EnumLyDoVaoVien.CapCuu ? checkedLyDoVaoVien : unCheckedLyDoVaoVien,
                CoDungTuyen = yeuCauTiepNhan.LyDoVaoVien == Enums.EnumLyDoVaoVien.DungTuyen ? checkedLyDoVaoVien : unCheckedLyDoVaoVien,
                CoThongTuyen = yeuCauTiepNhan.LyDoVaoVien == Enums.EnumLyDoVaoVien.ThongTuyen ? checkedLyDoVaoVien : unCheckedLyDoVaoVien,
                CoTraiTuyen = yeuCauTiepNhan.LyDoVaoVien == Enums.EnumLyDoVaoVien.TraiTuyen ? checkedLyDoVaoVien : unCheckedLyDoVaoVien,

                ChuanDoanXacDinh = yeuCauTiepNhan.NoiTruBenhAn != null && (yeuCauTiepNhan.NoiTruBenhAn.LoaiBenhAn == LoaiBenhAn.SanKhoaMo || yeuCauTiepNhan.NoiTruBenhAn.LoaiBenhAn == LoaiBenhAn.SanKhoaThuong) ? chuanDoanXacDinhSanKhoa : yeuCauTiepNhan.NoiTruBenhAn?.ChanDoanChinhRaVienGhiChu,
                MaICD10 = yeuCauTiepNhan.NoiTruBenhAn != null && (yeuCauTiepNhan.NoiTruBenhAn.LoaiBenhAn == LoaiBenhAn.SanKhoaMo || yeuCauTiepNhan.NoiTruBenhAn.LoaiBenhAn == LoaiBenhAn.SanKhoaThuong) ? maICD10 : yeuCauTiepNhan.NoiTruBenhAn?.ChanDoanChinhRaVienICD?.Ma,

                BenhKemTheo = tenICDKemTheo,
                ICDKemTheo10 = maICDKemTheo,

                DateItemChiPhis = dateItemChiPhis,

                TTDV = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble(),
                TTTTBHYT = "",

                TTTienBH = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble(),
                TQBHYT = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble(),
                TNCCTra = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble(),
                TongSoKhac = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble(),
                TNBTuTra = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true),

                TongChiPhi = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble(),
                SoTienBangChu = NumberHelper.ChuyenSoRaText(Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBH))),

                NguoiBenhPhaiTra = (Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)) + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhTuTra))).ApplyFormatMoneyToDouble(),

                TTQuyTT = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble(),
                BHYTChiTra = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble(),
                CacKhoanTraKhac = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true),
                SoTienKhac = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble(),
                NgayHienTai = DateTime.Now.ApplyFormatNgayThangNam()
            };

            var content = TemplateHelpper.FormatTemplateWithContentTemplate(result?.Body, data);
            return content;
        }
        public string GetHtmlBangKe(long taiKhoanThuId, string hostingName, ref TaiKhoanBenhNhanThu taiKhoanBenhNhanThu, ref List<ChiPhiKhamChuaBenhNoiTruVo> tatCaDichVuKhamChuaBenh)
        {
            if (taiKhoanBenhNhanThu == null)
            {
                taiKhoanBenhNhanThu = _taiKhoanBenhNhanThuRepository.TableNoTracking.Where(c => c.Id == taiKhoanThuId && c.LoaiThuTienBenhNhan == Enums.LoaiThuTienBenhNhan.ThuTheoChiPhi)
                                                                                        .Include(o => o.YeuCauTiepNhan).ThenInclude(o => o.NoiTruBenhAn).ThenInclude(o => o.ChuyenDenBenhVien)
                                                                                        .Include(o => o.YeuCauTiepNhan).ThenInclude(o => o.NoiTruBenhAn).ThenInclude(o => o.KhoaPhongNhapVien)
                                                                                        .Include(o => o.YeuCauTiepNhan).ThenInclude(o => o.NoiTruBenhAn).ThenInclude(o => o.ChanDoanChinhRaVienICD)
                                                                                        .Include(o => o.YeuCauTiepNhan).ThenInclude(o => o.YeuCauTiepNhanTheBHYTs)
                                                                                        .Include(o => o.YeuCauTiepNhan).ThenInclude(o => o.YeuCauNhapVien).ThenInclude(o => o.YeuCauKhamBenh).ThenInclude(o => o.YeuCauTiepNhan)
                                                                                        .Include(cc => cc.YeuCauTiepNhan)
                                                                                        .ThenInclude(xx => xx.BenhNhan)
                                                                                        .Include(cc => cc.YeuCauTiepNhan)
                                                                                        .ThenInclude(xx => xx.YeuCauKhamBenhs)
                                                                                        .ThenInclude(o => o.YeuCauKhamBenhChuanDoans)
                                                                                        .ThenInclude(o => o.ChuanDoan)
                                                                                        .Include(cc => cc.YeuCauTiepNhan).ThenInclude(cc => cc.PhuongXa)
                                                                                        .Include(cc => cc.YeuCauTiepNhan)
                                                                                        .ThenInclude(cc => cc.QuanHuyen)
                                                                                        .Include(cc => cc.YeuCauTiepNhan)
                                                                                        .ThenInclude(cc => cc.TinhThanh)
                                                                                        .Include(cc => cc.YeuCauTiepNhan)
                                                                                        .ThenInclude(cc => cc.NoiChuyen)
                                                                                        .Include(o => o.YeuCauTiepNhan).ThenInclude(o => o.NoiTruBenhAn).ThenInclude(o => o.NoiTruPhieuDieuTris).ThenInclude(c => c.ChanDoanChinhICD)
                                                                                        .Include(o => o.YeuCauTiepNhan).ThenInclude(o => o.NoiTruBenhAn).ThenInclude(o => o.NoiTruPhieuDieuTris).ThenInclude(o => o.NoiTruThamKhamChanDoanKemTheos).ThenInclude(c => c.ICD)
                                                                                        .Include(o => o.YeuCauTiepNhan).ThenInclude(o => o.NoiTruBenhAn).ThenInclude(o => o.NoiTruKhoaPhongDieuTris).ThenInclude(c => c.KhoaPhongChuyenDen).FirstOrDefault();

            }
            var yeuCauTiepNhan = taiKhoanBenhNhanThu.YeuCauTiepNhan;
            if (yeuCauTiepNhan == null)
                return string.Empty;
            if(tatCaDichVuKhamChuaBenh == null)
            {
                tatCaDichVuKhamChuaBenh = GetTatCaDichVuKhamChuaBenh(yeuCauTiepNhan.Id).Result;
            }
            var danhSachChiPhi = tatCaDichVuKhamChuaBenh.Where(o => !o.Soluong.AlmostEqual(0) && o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.DaThanhToan && o.YeuCauGoiDichVuId == null).ToList();
            if (danhSachChiPhi.Count == 0)
            {
                return string.Empty;
            }

            var query = taiKhoanBenhNhanThu?.YeuCauTiepNhan;
            var result = _templateRepository.TableNoTracking.FirstOrDefault(x => x.Name.Equals("BangKeKhamBenhBHYTVaBenhVien"));



            var benhVien = new Core.Domain.Entities.BenhVien.BenhVien();

            string maBHYT = string.Empty;
            string bHYTTuNgay = string.Empty;
            string bHYTDenNgay = string.Empty;
            string mucHuong = string.Empty;
            string NoiDKKCBBanDau = string.Empty;
            string MaKCBBanDau = string.Empty;


            string maICDKemTheo = string.Empty;
            string tenICDKemTheo = string.Empty;

            string chuanDoanXacDinhSanKhoa = string.Empty;
            string maICD10 = string.Empty;

            if (yeuCauTiepNhan.NoiTruBenhAn != null && (yeuCauTiepNhan.NoiTruBenhAn.LoaiBenhAn == LoaiBenhAn.SanKhoaMo || yeuCauTiepNhan.NoiTruBenhAn.LoaiBenhAn == LoaiBenhAn.SanKhoaThuong))
            {
                if (yeuCauTiepNhan.NoiTruBenhAn?.NoiTruPhieuDieuTris.Count() > 0)
                {
                    var phieuDieuTri = yeuCauTiepNhan.NoiTruBenhAn?.NoiTruPhieuDieuTris.OrderByDescending(c => c.NgayDieuTri).FirstOrDefault();

                    var icdKemTheoIds = phieuDieuTri.NoiTruThamKhamChanDoanKemTheos.Select(c => c.ICD.Ma);
                    var tenICDKemTheos = phieuDieuTri.NoiTruThamKhamChanDoanKemTheos.Select(c => c.GhiChu);

                    maICDKemTheo = string.Join(", ", icdKemTheoIds);
                    tenICDKemTheo = string.Join(", ", tenICDKemTheos);


                    maICD10 = phieuDieuTri.ChanDoanChinhICD?.Ma;
                    chuanDoanXacDinhSanKhoa = phieuDieuTri.ChanDoanChinhGhiChu;
                }
            }
            else
            {
                if (!string.IsNullOrEmpty(yeuCauTiepNhan.NoiTruBenhAn?.DanhSachChanDoanKemTheoRaVienICDId))
                {
                    var maICDKemTheos = new List<string>();

                    var icdKemTheoIds = yeuCauTiepNhan.NoiTruBenhAn?.DanhSachChanDoanKemTheoRaVienICDId.Split(Constants.ICDSeparator);
                    var tenICDKemTheos = yeuCauTiepNhan.NoiTruBenhAn?.DanhSachChanDoanKemTheoRaVienGhiChu?.Split(Constants.ICDSeparator);

                    if (icdKemTheoIds.Length > 0)
                    {
                        foreach (var icdKemTheoId in icdKemTheoIds)
                        {
                            var icdKemTheo = _icdRepository.TableNoTracking.FirstOrDefault(o => o.Id == long.Parse(icdKemTheoId));
                            if (icdKemTheo != null)
                            {
                                maICDKemTheos.Add(icdKemTheo.Ma);
                            }

                            //if (long.TryParse(yeuCauTiepNhan.NoiTruBenhAn?.DanhSachChanDoanKemTheoRaVienICDId.Split(Constants.ICDSeparator).First(), out var icdKemTheoId))
                            //{
                            //    var icdKemTheo = _icdRepository.TableNoTracking.FirstOrDefault(o => o.Id == icdKemTheoId);
                            //    if (icdKemTheo != null)
                            //    {
                            //        maICDKemTheo = icdKemTheo.Ma;
                            //        tenICDKemTheo = yeuCauTiepNhan.NoiTruBenhAn?.DanhSachChanDoanKemTheoRaVienGhiChu?.Split(Constants.ICDSeparator).First();
                            //    }
                            //}
                        }
                    }

                    maICDKemTheo = string.Join(", ", maICDKemTheos);
                    tenICDKemTheo = string.Join(", ", tenICDKemTheos);
                }
            }


            YeuCauTiepNhanTheBHYT theBHYT = null;
            if (yeuCauTiepNhan.CoBHYT == true && yeuCauTiepNhan.YeuCauTiepNhanTheBHYTs.Any())
            {
                theBHYT = yeuCauTiepNhan.YeuCauTiepNhanTheBHYTs.First();
                if (!String.IsNullOrEmpty(theBHYT.MaDKBD))
                {
                    benhVien = _benhVienRepository.TableNoTracking.FirstOrDefault(p => p.Ma.Equals(theBHYT.MaDKBD));
                }
                maBHYT = theBHYT.MaSoThe;
                bHYTTuNgay = theBHYT.NgayHieuLuc.ApplyFormatDate();
                bHYTDenNgay = theBHYT.NgayHetHan?.ApplyFormatDate();
                mucHuong = theBHYT.MucHuong.ToString() + "%";
                NoiDKKCBBanDau = benhVien != null ? benhVien?.Ten : "Chưa xác định";
                MaKCBBanDau = theBHYT.MaDKBD;
            }
            else
            {
                maBHYT = "";
                bHYTTuNgay = "";
                bHYTDenNgay = "";
                mucHuong = "0%";
                NoiDKKCBBanDau = "Chưa xác định";
                MaKCBBanDau = "Chưa xác định";
            }

            //var thongTinPhieuThus = GetThongTinPhieuThu(taiKhoanThuId, LoaiPhieuThuChiThuNgan.ThuTheoChiPhi);
            //if (thongTinPhieuThus.ChiPhiKhamChuaBenhNoiTruVos.Count == 0)
            //{
            //    return string.Empty;
            //}
            var dsChiPhiBangKe = new List<BangKeKhamBenhBenhVienVo>();
            var dateItemChiPhis = string.Empty;
            int indexItem = 1;
            var groupChiPhiTheoThe = danhSachChiPhi.GroupBy(o => o.MaSoTheBHYT);
            if (groupChiPhiTheoThe.Count() > 2 ||
                (groupChiPhiTheoThe.All(o => o.Key != string.Empty) && groupChiPhiTheoThe.Count() > 1))
            {
                var groupNgayPhatSinhTheoThe = groupChiPhiTheoThe.Where(o => o.Key != string.Empty).Select(o => new { o.Key, o.OrderBy(j => j.NgayPhatSinh).First().NgayPhatSinh }).OrderBy(o => o.NgayPhatSinh).ToArray();
                for (int i = 0; i < groupNgayPhatSinhTheoThe.Count(); i++)
                {
                    var ngayPhatSinhTheoThe = groupNgayPhatSinhTheoThe[i];
                    var theBHYTChiTra = yeuCauTiepNhan.YeuCauTiepNhanTheBHYTs.First(o => o.MaSoThe == ngayPhatSinhTheoThe.Key);
                    var chiPhis = groupChiPhiTheoThe.FirstOrDefault(o => o.Key == ngayPhatSinhTheoThe.Key).ToList();
                    DateTime? ngayPhatSinhTiepTheo = i < groupNgayPhatSinhTheoThe.Count() - 1
                        ? groupNgayPhatSinhTheoThe[i + 1].NgayPhatSinh
                        : null;
                    chiPhis.AddRange(groupChiPhiTheoThe.FirstOrDefault(o => o.Key == string.Empty).Where(j => (i == 0 || j.NgayPhatSinh >= ngayPhatSinhTheoThe.NgayPhatSinh) && (ngayPhatSinhTiepTheo != null && j.NgayPhatSinh < ngayPhatSinhTiepTheo)).ToList());
                    var mucHuongPT = theBHYTChiTra != null && theBHYTChiTra?.MucHuong > 0 ? theBHYTChiTra?.MucHuong + "%" : string.Empty;

                    dateItemChiPhis += "<table style='width: 100 %; '>" +
                                       "<tbody>" +
                                       "<tr>" +
                                       $"<td style='padding-left:-5px; width: 40 %; '>Mã thẻ BHYT {i + 1}: <b>{theBHYTChiTra.MaSoThe}</b> " +
                                       $"<span style='padding-left:20px'>Giá trị từ: <b>{theBHYTChiTra.NgayHieuLuc.ApplyFormatDate()}</b> đến <b>{theBHYTChiTra.NgayHetHan?.ApplyFormatDate()}</b></span>" +
                                       $"<span style='padding-left:20px'>Mức hưởng: <b>{mucHuongPT}</b></span></td>" +
                                       "</tr>" +
                                       "</tbody>" +
                                       "</table>" +
                                       "</br>" +
                                       "<table style='width:100%;border: 1px solid #020000; border-collapse: collapse;'>" +
                                            "<tr style='border: 1px solid black;  border-collapse: collapse;'>" +
                                            "<th style='border: 1px solid #020000; border-collapse: collapse;text-align: center;' rowspan='2'>" +
                                                    "STT </th>" +
                                                "<th style='border: 1px solid #020000; border-collapse: collapse;width:35%;text-align: center;' rowspan='2'>" +
                                                    "Nội dung </th>" +
                                                "<th style='border: 1px solid #020000; border-collapse: collapse;width:5%;text-align: center;' rowspan='2'>" +
                                                    "Đơn vị tính</th>" +
                                                "<th style='border: 1px solid #020000; border-collapse: collapse;width:3%; text-align: center;' rowspan='2'>" +
                                                    "Số lượng</th>" +
                                                "<th style='border: 1px solid #020000; border-collapse: collapse;width:3%; text-align: center;' rowspan='2'>" +
                                                    "Đơn giá BV <span style='font-weight: 100;'>(đồng)</span></th>" +
                                                "<th style='border: 1px solid #020000; border-collapse: collapse;width:3%; text-align: center;' rowspan='2'>" +
                                                    "Đơn giá BH  <span style='font-weight: 100;'>(đồng)</span></th>" +
                                                "<th style='border: 1px solid #020000; border-collapse: collapse;width:200px; text-align: center;'" +
                                                    "rowspan='2'>" +
                                                    "Tỉ lệ thanh toán theo dich vụ   <span style='font-weight: 100;'>(%)</span></th>" +
                                                "<th style='border: 1px solid #020000; border-collapse: collapse;width:8%;text-align: center;' rowspan='2'>" +
                                                    "Thành tiền BV  <span style='font-weight: 100;'>(đồng)</span>" +
                                                "</th>" +
                                                "<th style='border: 1px solid #020000; border-collapse: collapse;width:200px; text-align: center;'" +
                                                    "rowspan='2'>" +
                                                    "Tỷ lệ thanh toán BHYT <span style='font-weight: 100;'>(%)</span>" +
                                                "</th>" +
                                                "<th style='border: 1px solid #020000; border-collapse: collapse;width:8%;text-align: center;' rowspan='2'>" +
                                                    "Thành tiền BH  <span style='font-weight: 100;'>(đồng)</span>" +
                                                "</th>" +
                                                "<th style='border: 1px solid #020000; border-collapse: collapse;width:35%;text-align: center;' colspan='4'>" +
                                                    "Nguồn thanh toán  <span style='font-weight: 100;'>(đồng)</span></th>" +
                                            "</tr>" +
                                            "<tr style='border: 1px solid #020000; border-collapse: collapse;'>" +
                                                "<td style='border: 1px solid #020000; border-collapse: collapse;text-align: center;'><b>Quỹ BHYT</b></td>" +
                                                "<td style=' border: 1px solid #020000; border-collapse: collapse;width:80px;text-align: center;'>" +
                                                    "<b>Người bệnh cùng chi" +
                                                    " trả</b> (đồng)</td>" +
                                                "<td style=' border: 1px solid #020000; border-collapse: collapse;text-align: center;'><b>Khác</b> (đồng)</td>" +
                                                "<td style='border: 1px solid #020000; border-collapse: collapse;text-align: center;width: 90px;'>" +
                                                    "<b>Người bệnh" +
                                                    "tự trả </b>(đồng)" +
                                                "</td>" +
                                            "</tr>" +
                                            "<tr style=' border: 1px solid #020000; '>" +
                                              "<td style='border: 1px solid #020000;text-align: center;'><b> </b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(1)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(2)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(3)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(4)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(5)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(6)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(7)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(8)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(9)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(10)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(11)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(12)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(13)</b> </td>" +
                                            "</tr>";

                    var dsChiPhiBangKeTheoThe = new List<BangKeKhamBenhBenhVienVo>();

                    foreach (var chiPhi in chiPhis.Where(c => c.NhomChiPhiBangKe != NhomChiPhiBangKe.GoiVatTu && c.YeuCauGoiDichVuId == null).GroupBy(c => new { c.DonGia, c.SoTienMG, KhongTinhPhi = c.KhongTinhPhi.GetValueOrDefault(), c.NhomChiPhiBangKe, c.TenDichVu, c.DonViTinh, c.DuocHuongBHYT, c.DonGiaBHYT, c.MucHuongBaoHiem, c.TiLeBaoHiemThanhToan }).OrderByDescending(o => o.Key.DuocHuongBHYT))
                    {
                        var chiphiBangKe = new BangKeKhamBenhBenhVienVo
                        {
                            Nhom = chiPhi.Key.NhomChiPhiBangKe,
                            Id = chiPhi.FirstOrDefault().Id,
                            NoiDung = chiPhi.Key.TenDichVu,
                            DonViTinh = chiPhi.Key.DonViTinh,
                            SoLuong = (decimal)chiPhi.Sum(c => c.Soluong),
                            DuocHuongBaoHiem = chiPhi.Key.DuocHuongBHYT,
                            DonGiaBH = chiPhi.Key.DuocHuongBHYT ? chiPhi.Key.DonGiaBHYT : 0,
                            MucHuongBaoHiem = chiPhi.Key.MucHuongBaoHiem,
                            TiLeThanhToanTheoDV = chiPhi.Key.TiLeBaoHiemThanhToan,
                            BaoHiemChiTra = true,
                            DonGiaBV = chiPhi.Key.DonGia
                        };
                        if (chiPhi.Key.KhongTinhPhi == true)
                        {
                            chiphiBangKe.Khac = chiPhi.Key.MucHuongBaoHiem > 0
                                ? (chiphiBangKe.ThanhTienBV.GetValueOrDefault() - chiphiBangKe.ThanhTienBH.GetValueOrDefault())
                                : chiphiBangKe.ThanhTienBV.GetValueOrDefault();
                        }
                        else
                        {
                            chiphiBangKe.Khac = chiPhi.Sum(c => c.SoTienMG);
                        }
                        dsChiPhiBangKeTheoThe.Add(chiphiBangKe);
                    }
                    foreach (var chiPhi in chiPhis.Where(c => !(c.NhomChiPhiBangKe != NhomChiPhiBangKe.GoiVatTu && c.YeuCauGoiDichVuId == null)))
                    {
                        var chiphiBangKe = new BangKeKhamBenhBenhVienVo
                        {
                            Nhom = chiPhi.NhomChiPhiBangKe,
                            Id = chiPhi.Id,
                            NoiDung = chiPhi.TenDichVu,
                            DonViTinh = chiPhi.DonViTinh,
                            SoLuong = (decimal)chiPhi.Soluong,
                            DuocHuongBaoHiem = chiPhi.DuocHuongBHYT,
                            DonGiaBH = chiPhi.DuocHuongBHYT ? chiPhi.DonGiaBHYT : 0,
                            MucHuongBaoHiem = chiPhi.MucHuongBaoHiem,
                            TiLeThanhToanTheoDV = chiPhi.TiLeBaoHiemThanhToan,
                            BaoHiemChiTra = true,
                            DonGiaBV = chiPhi.DonGia
                        };
                        if (chiPhi.KhongTinhPhi == true || chiPhi.YeuCauGoiDichVuId != null)
                        {
                            chiphiBangKe.Khac = chiPhi.MucHuongBaoHiem > 0
                                ? (chiphiBangKe.ThanhTienBV.GetValueOrDefault() - chiphiBangKe.ThanhTienBH.GetValueOrDefault())
                                : chiphiBangKe.ThanhTienBV.GetValueOrDefault();
                        }
                        else
                        {
                            chiphiBangKe.Khac = chiPhi.SoTienMG;
                        }
                        dsChiPhiBangKeTheoThe.Add(chiphiBangKe);
                    }

                    //foreach (var chiPhi in chiPhis)
                    //{
                    //    dsChiPhiBangKeTheoThe.Add(new BangKeKhamBenhBenhVienVo
                    //    {
                    //        Nhom = chiPhi.NhomChiPhiBangKe,
                    //        Id = chiPhi.Id,
                    //        NoiDung = chiPhi.TenDichVu,
                    //        DonViTinh = chiPhi.DonViTinh,
                    //        SoLuong = (decimal)chiPhi.Soluong,
                    //        DuocHuongBaoHiem = chiPhi.DuocHuongBHYT,
                    //        DonGiaBH = chiPhi.DuocHuongBHYT ? chiPhi.DonGiaBHYT : 0,
                    //        MucHuongBaoHiem = chiPhi.MucHuongBaoHiem,
                    //        TiLeThanhToanTheoDV = chiPhi.TiLeBaoHiemThanhToan,
                    //        BaoHiemChiTra = true,
                    //        DonGiaBV = chiPhi.DonGia
                    //    });
                    //}
                    dsChiPhiBangKe.AddRange(dsChiPhiBangKeTheoThe);
                    var groupChiPhiBangKes = dsChiPhiBangKeTheoThe.GroupBy(x => x.Nhom).OrderBy(o => (int)o.Key * (o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay || o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriNoiTru ? 1 : 10));
                    foreach (var groupChiPhiBangKe in groupChiPhiBangKes)
                    {
                        if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay)
                        {

                            dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                               "<td style='border: 1px solid #020000;' colspan='7'>" +
                                               "<span style='float:left;'><b>2. Ngày giường:  </b></span>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                               "</tr>";
                            dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                               "<td style='border: 1px solid #020000;' colspan='7'>" +
                                               "<span style='float:left;'><b>2.1." + groupChiPhiBangKe.Key.GetDescription() + "  </b></span>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b> " + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true) + "</b> </td>" +
                                               "</tr>";
                        }
                        else if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.NgayGiuongDieuTriNoiTru)
                        {
                            if (!groupChiPhiBangKes.Any(o => o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay))
                            {
                                dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                                   "<td style='border: 1px solid #020000;' colspan='7'>" +
                                                   "<span style='float:left;'><b>2. Ngày giường:  </b></span>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                   "</tr>";
                            }
                            dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                               "<td style='border: 1px solid #020000;' colspan='7'>" +
                                               "<span style='float:left;'><b>2.2." + groupChiPhiBangKe.Key.GetDescription() + "  </b></span>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b> " + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true) + "</b> </td>" +
                                               "</tr>";
                        }
                        else
                        {
                            dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                               "<td style='border: 1px solid #020000;' colspan='7'>" +
                                               "<span style='float:left;'><b>" + (int)groupChiPhiBangKe.Key + "." + groupChiPhiBangKe.Key.GetDescription() + "  </b></span>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b> " + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true) + "</b> </td>" +
                                               "</tr>";
                        }
                        if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.GoiVatTu)
                        {
                            var groupGoiVatTus = groupChiPhiBangKe.ToList().GroupBy(o => o.SoGoiVatTu.GetValueOrDefault()).OrderBy(o => o.Key);
                            int sttGoiVatTu = 1;
                            foreach (var groupGoiVatTu in groupGoiVatTus)
                            {
                                dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                                   "<td style='border: 1px solid #020000;' colspan='7'>" +
                                                   "<span style='float:left;'><b>10." + sttGoiVatTu + ". " + groupChiPhiBangKe.Key.GetDescription() + " " + sttGoiVatTu + "  </b></span>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.Khac)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'><b> " + Convert.ToDouble(groupGoiVatTu.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true) + "</b> </td>" +
                                                   "</tr>";
                                foreach (var chiPhiBangKe in groupGoiVatTu)
                                {
                                    dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                                    "<td style='border: 1px solid #020000; text-align: center;'> " + indexItem + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: left;'> " + chiPhiBangKe.NoiDung + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: center;'>  " + chiPhiBangKe.DonViTinh + " </td>" +
                                                    "<td style='border: 1px solid #020000;text-align: center;'> " + chiPhiBangKe.SoLuong + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: center;'> " + Convert.ToDouble(chiPhiBangKe.DonGiaBV).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: center;'> " + Convert.ToDouble(chiPhiBangKe.DonGiaBH).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.TiLeThanhToanTheoDV).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.ThanhTienBV).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.MucHuongBaoHiem > 0 ? 100 : 0).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.ThanhTienBH).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.QuyBHYT).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.NguoiBenhCungChiTra).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.Khac).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.NguoiBenhTuTra).ApplyFormatMoneyToDouble(true) + "</td>" +
                                                    "</tr>";
                                    indexItem++;
                                }
                            }
                        }
                        else
                        {
                            foreach (var chiPhiBangKe in groupChiPhiBangKe)
                            {
                                dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                                "<td style='border: 1px solid #020000; text-align: center;'> " + indexItem + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: left;'> " + chiPhiBangKe.NoiDung + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'>  " + chiPhiBangKe.DonViTinh + " </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'> " + chiPhiBangKe.SoLuong + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'> " + Convert.ToDouble(chiPhiBangKe.DonGiaBV).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'> " + Convert.ToDouble(chiPhiBangKe.DonGiaBH).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.TiLeThanhToanTheoDV).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.ThanhTienBV).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.MucHuongBaoHiem > 0 ? 100 : 0).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.ThanhTienBH).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.QuyBHYT).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.NguoiBenhCungChiTra).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.Khac).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.NguoiBenhTuTra).ApplyFormatMoneyToDouble(true) + "</td>" +
                                                "</tr>";
                                indexItem++;
                            }
                        }

                    }

                    dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                       "<td style='border: 1px solid #020000;' colspan='7'></span>" +
                                       "<span style='float:right;padding-right: 50px;'><b>Tổng Cộng</b></span>" +
                                       "</td>" +
                                       $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKeTheoThe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                       $"<td style='border: 1px solid #020000;text-align: right;'><b></b> </td>" +
                                       $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKeTheoThe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                       $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKeTheoThe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                       $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKeTheoThe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                       $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKeTheoThe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                       $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKeTheoThe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true)}</b> </td>" +
                                       "</tr>" +
                                       "</table>";
                }
            }
            else
            {
                YeuCauTiepNhanTheBHYT theBHYTChiTra = null;
                var maSoThe = groupChiPhiTheoThe.Where(o => o.Key != string.Empty).FirstOrDefault()?.Key;
                if (!string.IsNullOrEmpty(maSoThe))
                {
                    theBHYTChiTra = yeuCauTiepNhan.YeuCauTiepNhanTheBHYTs.First(o => o.MaSoThe == maSoThe);
                }

                var chiPhis = groupChiPhiTheoThe.SelectMany(o => o).ToList();
                var mucHuongPT = theBHYTChiTra != null && theBHYTChiTra?.MucHuong > 0 ? theBHYTChiTra?.MucHuong + "%" : string.Empty;

                dateItemChiPhis += "<table style='width: 100 %; '>" +
                                    "<tbody>" +
                                    "<tr>" +
                                       $"<td style='padding-left:-5px; width: 40 %; '>Mã thẻ BHYT: <b>{theBHYTChiTra?.MaSoThe}</b> " +
                                       $"<span style='padding-left:20px'>Giá trị từ: <b>{theBHYTChiTra?.NgayHieuLuc.ApplyFormatDate()}</b> đến <b>{theBHYTChiTra?.NgayHetHan?.ApplyFormatDate()}</b></span>" +
                                       $"<span style='padding-left:20px'>Mức hưởng: <b>{mucHuongPT}</b></span></td>" +
                                       "</tr>" +
                                    "</tbody>" +
                                    "</table>" +
                                    "</br>" +
                                    "<table style='width:100%;border: 1px solid #020000; border-collapse: collapse;'>" +
                                        "<tr style='border: 1px solid black;  border-collapse: collapse;'>" +
                                        "<th style='border: 1px solid #020000; border-collapse: collapse;text-align: center;' rowspan='2'>" +
                                                "STT </th>" +
                                            "<th style='border: 1px solid #020000; border-collapse: collapse;width:35%;text-align: center;' rowspan='2'>" +
                                                "Nội dung </th>" +
                                            "<th style='border: 1px solid #020000; border-collapse: collapse;width:5%;text-align: center;' rowspan='2'>" +
                                                "Đơn vị tính</th>" +
                                            "<th style='border: 1px solid #020000; border-collapse: collapse;width:3%; text-align: center;' rowspan='2'>" +
                                                "Số lượng</th>" +
                                            "<th style='border: 1px solid #020000; border-collapse: collapse;width:3%; text-align: center;' rowspan='2'>" +
                                                "Đơn giá BV <span style='font-weight: 100;'>(đồng)</span></th>" +
                                            "<th style='border: 1px solid #020000; border-collapse: collapse;width:3%; text-align: center;' rowspan='2'>" +
                                                "Đơn giá BH  <span style='font-weight: 100;'>(đồng)</span></th>" +
                                            "<th style='border: 1px solid #020000; border-collapse: collapse;width:200px; text-align: center;'" +
                                                "rowspan='2'>" +
                                                "Tỉ lệ thanh toán theo dich vụ   <span style='font-weight: 100;'>(%)</span></th>" +
                                            "<th style='border: 1px solid #020000; border-collapse: collapse;width:8%;text-align: center;' rowspan='2'>" +
                                                "Thành tiền BV  <span style='font-weight: 100;'>(đồng)</span>" +
                                            "</th>" +
                                            "<th style='border: 1px solid #020000; border-collapse: collapse;width:200px; text-align: center;'" +
                                                "rowspan='2'>" +
                                                "Tỷ lệ thanh toán BHYT <span style='font-weight: 100;'>(%)</span>" +
                                            "</th>" +
                                            "<th style='border: 1px solid #020000; border-collapse: collapse;width:8%;text-align: center;' rowspan='2'>" +
                                                "Thành tiền BH  <span style='font-weight: 100;'>(đồng)</span>" +
                                            "</th>" +
                                            "<th style='border: 1px solid #020000; border-collapse: collapse;width:35%;text-align: center;' colspan='4'>" +
                                                "Nguồn thanh toán  <span style='font-weight: 100;'>(đồng)</span></th>" +
                                        "</tr>" +
                                        "<tr style='border: 1px solid #020000; border-collapse: collapse;'>" +
                                            "<td style='border: 1px solid #020000; border-collapse: collapse;text-align: center;'><b>Quỹ BHYT</b></td>" +
                                            "<td style=' border: 1px solid #020000; border-collapse: collapse;width:80px;text-align: center;'>" +
                                                "<b>Người bệnh cùng chi " +
                                                " trả</b> (đồng)</td>" +
                                            "<td style=' border: 1px solid #020000; border-collapse: collapse;text-align: center;'><b>Khác</b> (đồng)</td>" +
                                            "<td style='border: 1px solid #020000; border-collapse: collapse;text-align: center;width: 90px;'>" +
                                                "<b>Người bệnh" +
                                                "tự trả </b>(đồng)" +
                                            "</td>" +
                                        "</tr>" +
                                        "<tr style=' border: 1px solid #020000; '>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b> </b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b>(1)</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b>(2)</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b>(3)</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b>(4)</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b>(5)</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b>(6)</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b>(7)</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b>(8)</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b>(9)</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b>(10)</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b>(11)</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b>(12)</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b>(13)</b> </td>" +
                                        "</tr>";


                //foreach (var chiPhi in chiPhis)
                //{
                //    dsChiPhiBangKe.Add(new BangKeKhamBenhBenhVienVo
                //    {
                //        Nhom = chiPhi.NhomChiPhiBangKe,
                //        Id = chiPhi.Id,
                //        NoiDung = chiPhi.TenDichVu,
                //        DonViTinh = chiPhi.DonViTinh,
                //        SoLuong = (decimal)chiPhi.Soluong,
                //        DuocHuongBaoHiem = chiPhi.DuocHuongBHYT,
                //        DonGiaBH = chiPhi.DuocHuongBHYT ? chiPhi.DonGiaBHYT : 0,
                //        MucHuongBaoHiem = chiPhi.MucHuongBaoHiem,
                //        TiLeThanhToanTheoDV = chiPhi.TiLeBaoHiemThanhToan,
                //        BaoHiemChiTra = true,
                //        DonGiaBV = chiPhi.DonGia
                //    });
                //}

                foreach (var chiPhi in chiPhis.Where(c => c.NhomChiPhiBangKe != NhomChiPhiBangKe.GoiVatTu && c.YeuCauGoiDichVuId == null).GroupBy(c => new { c.DonGia, c.SoTienMG, KhongTinhPhi = c.KhongTinhPhi.GetValueOrDefault(), c.NhomChiPhiBangKe, c.TenDichVu, c.DonViTinh, c.DuocHuongBHYT, c.DonGiaBHYT, c.MucHuongBaoHiem, c.TiLeBaoHiemThanhToan }).OrderByDescending(o => o.Key.DuocHuongBHYT))
                {
                    var chiphiBangKe = new BangKeKhamBenhBenhVienVo
                    {
                        Nhom = chiPhi.Key.NhomChiPhiBangKe,
                        Id = chiPhi.FirstOrDefault().Id,
                        NoiDung = chiPhi.Key.TenDichVu,
                        DonViTinh = chiPhi.Key.DonViTinh,
                        SoLuong = (decimal)chiPhi.Sum(c => c.Soluong),
                        DuocHuongBaoHiem = chiPhi.Key.DuocHuongBHYT,
                        DonGiaBH = chiPhi.Key.DuocHuongBHYT ? chiPhi.Key.DonGiaBHYT : 0,
                        MucHuongBaoHiem = chiPhi.Key.MucHuongBaoHiem,
                        TiLeThanhToanTheoDV = chiPhi.Key.TiLeBaoHiemThanhToan,
                        BaoHiemChiTra = true,
                        DonGiaBV = chiPhi.Key.DonGia
                    };
                    if (chiPhi.Key.KhongTinhPhi == true)
                    {
                        chiphiBangKe.Khac = chiPhi.Key.MucHuongBaoHiem > 0
                            ? (chiphiBangKe.ThanhTienBV.GetValueOrDefault() - chiphiBangKe.ThanhTienBH.GetValueOrDefault())
                            : chiphiBangKe.ThanhTienBV.GetValueOrDefault();
                    }
                    else
                    {
                        chiphiBangKe.Khac = chiPhi.Sum(c => c.SoTienMG);
                    }
                    dsChiPhiBangKe.Add(chiphiBangKe);
                }


                foreach (var chiPhi in chiPhis.Where(c => !(c.NhomChiPhiBangKe != NhomChiPhiBangKe.GoiVatTu && c.YeuCauGoiDichVuId == null)))
                {
                    var chiphiBangKe = new BangKeKhamBenhBenhVienVo
                    {
                        Nhom = chiPhi.NhomChiPhiBangKe,
                        Id = chiPhi.Id,
                        NoiDung = chiPhi.TenDichVu,
                        DonViTinh = chiPhi.DonViTinh,
                        SoLuong = (decimal)chiPhi.Soluong,
                        DuocHuongBaoHiem = chiPhi.DuocHuongBHYT,
                        DonGiaBH = chiPhi.DuocHuongBHYT ? chiPhi.DonGiaBHYT : 0,
                        MucHuongBaoHiem = chiPhi.MucHuongBaoHiem,
                        TiLeThanhToanTheoDV = chiPhi.TiLeBaoHiemThanhToan,
                        BaoHiemChiTra = true,
                        DonGiaBV = chiPhi.DonGia
                    };
                    if (chiPhi.KhongTinhPhi == true || chiPhi.YeuCauGoiDichVuId != null)
                    {
                        chiphiBangKe.Khac = chiPhi.MucHuongBaoHiem > 0
                            ? (chiphiBangKe.ThanhTienBV.GetValueOrDefault() - chiphiBangKe.ThanhTienBH.GetValueOrDefault())
                            : chiphiBangKe.ThanhTienBV.GetValueOrDefault();
                    }
                    else
                    {
                        chiphiBangKe.Khac = chiPhi.SoTienMG;
                    }
                    dsChiPhiBangKe.Add(chiphiBangKe);
                }

                var groupChiPhiBangKes = dsChiPhiBangKe.GroupBy(x => x.Nhom).OrderBy(o => (int)o.Key * (o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay || o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriNoiTru ? 1 : 10));
                foreach (var groupChiPhiBangKe in groupChiPhiBangKes)
                {
                    if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay)
                    {

                        dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                            "<td style='border: 1px solid #020000;' colspan='7'>" +
                                            "<span style='float:left;'><b>2. Ngày giường:  </b></span>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                            "</tr>";
                        dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                            "<td style='border: 1px solid #020000;' colspan='7'>" +
                                            "<span style='float:left;'><b>2.1." + groupChiPhiBangKe.Key.GetDescription() + "  </b></span>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b> " + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true) + "</b> </td>" +
                                            "</tr>";
                    }
                    else if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.NgayGiuongDieuTriNoiTru)
                    {
                        if (!groupChiPhiBangKes.Any(o => o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay))
                        {
                            dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                                "<td style='border: 1px solid #020000;' colspan='7'>" +
                                                "<span style='float:left;'><b>2. Ngày giường:  </b></span>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                "</tr>";
                        }
                        dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                            "<td style='border: 1px solid #020000;' colspan='7'>" +
                                            "<span style='float:left;'><b>2.2." + groupChiPhiBangKe.Key.GetDescription() + "  </b></span>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b> " + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true) + "</b> </td>" +
                                            "</tr>";
                    }
                    else
                    {
                        dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                            "<td style='border: 1px solid #020000;' colspan='7'>" +
                                            "<span style='float:left;'><b>" + (int)groupChiPhiBangKe.Key + "." + groupChiPhiBangKe.Key.GetDescription() + "  </b></span>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b> " + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true) + "</b> </td>" +
                                            "</tr>";
                    }
                    if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.GoiVatTu)
                    {
                        var groupGoiVatTus = groupChiPhiBangKe.ToList().GroupBy(o => o.SoGoiVatTu.GetValueOrDefault()).OrderBy(o => o.Key);
                        int sttGoiVatTu = 1;
                        foreach (var groupGoiVatTu in groupGoiVatTus)
                        {
                            dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                                "<td style='border: 1px solid #020000;' colspan='7'>" +
                                                "<span style='float:left;'><b>10." + sttGoiVatTu + ". " + groupChiPhiBangKe.Key.GetDescription() + " " + sttGoiVatTu + "  </b></span>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.Khac)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'><b> " + Convert.ToDouble(groupGoiVatTu.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true) + "</b> </td>" +
                                                "</tr>";
                            foreach (var chiPhiBangKe in groupGoiVatTu)
                            {
                                dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                                "<td style='border: 1px solid #020000; text-align: center;'> " + indexItem + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: left;'> " + chiPhiBangKe.NoiDung + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'>  " + chiPhiBangKe.DonViTinh + " </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'> " + chiPhiBangKe.SoLuong + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'> " + Convert.ToDouble(chiPhiBangKe.DonGiaBV).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'> " + Convert.ToDouble(chiPhiBangKe.DonGiaBH).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.TiLeThanhToanTheoDV).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.ThanhTienBV).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.MucHuongBaoHiem > 0 ? 100 : 0).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.ThanhTienBH).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.QuyBHYT).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.NguoiBenhCungChiTra).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.Khac).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.NguoiBenhTuTra).ApplyFormatMoneyToDouble(true) + "</td>" +
                                                "</tr>";
                                indexItem++;
                            }
                        }
                    }
                    else
                    {
                        foreach (var chiPhiBangKe in groupChiPhiBangKe)
                        {
                            dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                            "<td style='border: 1px solid #020000; text-align: center;'> " + indexItem + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: left;'> " + chiPhiBangKe.NoiDung + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'>  " + chiPhiBangKe.DonViTinh + " </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'> " + chiPhiBangKe.SoLuong + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'> " + Convert.ToDouble(chiPhiBangKe.DonGiaBV).ApplyFormatMoneyToDouble() + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'> " + Convert.ToDouble(chiPhiBangKe.DonGiaBH).ApplyFormatMoneyToDouble() + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.TiLeThanhToanTheoDV).ApplyFormatMoneyToDouble() + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.ThanhTienBV).ApplyFormatMoneyToDouble() + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.MucHuongBaoHiem > 0 ? 100 : 0).ApplyFormatMoneyToDouble() + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.ThanhTienBH).ApplyFormatMoneyToDouble() + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.QuyBHYT).ApplyFormatMoneyToDouble() + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.NguoiBenhCungChiTra).ApplyFormatMoneyToDouble() + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.Khac).ApplyFormatMoneyToDouble() + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.NguoiBenhTuTra).ApplyFormatMoneyToDouble(true) + "</td>" +
                                            "</tr>";
                            indexItem++;
                        }
                    }

                }

                dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                    "<td style='border: 1px solid #020000;' colspan='7'></span>" +
                                    "<span style='float:right;padding-right: 50px;'><b>Tổng Cộng</b></span>" +
                                    "</td>" +
                                    $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                    $"<td style='border: 1px solid #020000;text-align: right;'><b></b> </td>" +
                                    $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                    $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                    $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                    $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                    $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true)}</b> </td>" +
                                    "</tr>" +
                                    "</table>";

            }

            var checkedLyDoVaoVien = "<input id='demo_box_2' class='css - checkbox' type='checkbox' checked  disabled='true'/>";
            var unCheckedLyDoVaoVien = "<input id='demo_box_2' class='css - checkbox' type='checkbox' disabled='true' />";

            var khoaPhong = yeuCauTiepNhan.NoiTruBenhAn?.NoiTruKhoaPhongDieuTris.OrderByDescending(c => c.ThoiDiemVaoKhoa).Select(c => c.KhoaPhongChuyenDen).FirstOrDefault();
            var chuyenKhoa = GetChuyenKhoa(khoaPhong?.Id); //BVHD-3792 

            var data = new
            {
                TitleBangKe = "ĐIỀU TRỊ NỘI TRÚ",
                SoBangKe = "3",
                yeuCauTiepNhan.BenhNhan.MaBN,
                MaTN = yeuCauTiepNhan.MaYeuCauTiepNhan,
                SoBenhAn = "Số bệnh án: " + yeuCauTiepNhan.NoiTruBenhAn?.SoBenhAn,
                yeuCauTiepNhan.HoTen,
                DiaChi = yeuCauTiepNhan.DiaChiDayDu,
                BarCodeImgBase64 = !string.IsNullOrEmpty(yeuCauTiepNhan.MaYeuCauTiepNhan) ? BarcodeHelper.GenerateBarCode(yeuCauTiepNhan.MaYeuCauTiepNhan) : "",
                NamSinh = DateHelper.DOBFormat(yeuCauTiepNhan.NgaySinh, yeuCauTiepNhan.ThangSinh, yeuCauTiepNhan.NamSinh),
                GioiTinh = yeuCauTiepNhan.GioiTinh != null ? yeuCauTiepNhan.GioiTinh.GetDescription() : "",

                //TenKhoa = "Khoa: " + yeuCauTiepNhan.NoiTruBenhAn?.KhoaPhongNhapVien?.Ten,
                //MaKhoa = "Mã khoa: " + yeuCauTiepNhan.NoiTruBenhAn?.KhoaPhongNhapVien?.Ma,

                TenKhoa = "Khoa: " + khoaPhong?.Ten,
                MaKhoa = "Mã khoa: " + chuyenKhoa?.Ma,

                MaBHYT = theBHYT?.MaSoThe,
                BHYTTuNgay = bHYTTuNgay,
                BHYTDenNgay = bHYTDenNgay,
                NoiDKKCBBanDau,
                MaKCBBanDau,
                NgayDenKham = yeuCauTiepNhan.YeuCauNhapVien?.YeuCauKhamBenh?.YeuCauTiepNhan.ThoiDiemTiepNhan.ApplyFormatGioPhutNgay(),
                DieuTriKNT = yeuCauTiepNhan.NoiTruBenhAn?.ThoiDiemNhapVien.ApplyFormatGioPhutNgay(),
                KetThucKhamNgoaiTru = yeuCauTiepNhan.NoiTruBenhAn?.ThoiDiemRaVien?.ApplyFormatGioPhutNgay(),
                SoNgayDTri = NoiTruBenhAnHelper.TinhSoNgayDieuTri(yeuCauTiepNhan.NoiTruBenhAn)?.ToString() ?? string.Empty,//yeuCauTiepNhan.NoiTruBenhAn?.ThoiDiemRaVien == null ? "" : (yeuCauTiepNhan.NoiTruBenhAn.ThoiDiemRaVien.Value.Date.AddDays(1) - yeuCauTiepNhan.NoiTruBenhAn.ThoiDiemNhapVien.Date).Days.ToString(),
                TinhTrangRaVien = yeuCauTiepNhan.NoiTruBenhAn?.TinhTrangRaVien == EnumTinhTrangRaVien.RaVien && (yeuCauTiepNhan.NoiTruBenhAn?.KetQuaDieuTri == EnumKetQuaDieuTri.Do || yeuCauTiepNhan.NoiTruBenhAn?.KetQuaDieuTri == EnumKetQuaDieuTri.Khoi) ? 1 : 2,
                MucHuong = mucHuong,
                NoiChuyenDen = yeuCauTiepNhan.NoiChuyen?.Ten,
                NoiChuyenDi = yeuCauTiepNhan.NoiTruBenhAn?.ChuyenDenBenhVien?.Ten,
                MKV = theBHYT?.MaKhuVuc,
                NgayMiemCungTC = theBHYT?.NgayDuocMienCungChiTra?.ApplyFormatDate(),
                ThoiGian5Nam = theBHYT?.NgayDu5Nam?.ApplyFormatDate(),
                CoCapCuu = yeuCauTiepNhan.LyDoVaoVien == Enums.EnumLyDoVaoVien.CapCuu ? checkedLyDoVaoVien : unCheckedLyDoVaoVien,
                CoDungTuyen = yeuCauTiepNhan.LyDoVaoVien == Enums.EnumLyDoVaoVien.DungTuyen ? checkedLyDoVaoVien : unCheckedLyDoVaoVien,
                CoThongTuyen = yeuCauTiepNhan.LyDoVaoVien == Enums.EnumLyDoVaoVien.ThongTuyen ? checkedLyDoVaoVien : unCheckedLyDoVaoVien,
                CoTraiTuyen = yeuCauTiepNhan.LyDoVaoVien == Enums.EnumLyDoVaoVien.TraiTuyen ? checkedLyDoVaoVien : unCheckedLyDoVaoVien,

                ChuanDoanXacDinh = yeuCauTiepNhan.NoiTruBenhAn != null && (yeuCauTiepNhan.NoiTruBenhAn.LoaiBenhAn == LoaiBenhAn.SanKhoaMo || yeuCauTiepNhan.NoiTruBenhAn.LoaiBenhAn == LoaiBenhAn.SanKhoaThuong) ? chuanDoanXacDinhSanKhoa : yeuCauTiepNhan.NoiTruBenhAn?.ChanDoanChinhRaVienGhiChu,
                MaICD10 = yeuCauTiepNhan.NoiTruBenhAn != null && (yeuCauTiepNhan.NoiTruBenhAn.LoaiBenhAn == LoaiBenhAn.SanKhoaMo || yeuCauTiepNhan.NoiTruBenhAn.LoaiBenhAn == LoaiBenhAn.SanKhoaThuong) ? maICD10 : yeuCauTiepNhan.NoiTruBenhAn?.ChanDoanChinhRaVienICD?.Ma,

                BenhKemTheo = tenICDKemTheo,
                ICDKemTheo10 = maICDKemTheo,

                DateItemChiPhis = dateItemChiPhis,

                TTDV = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble(),
                TTTTBHYT = "",

                TTTienBH = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble(),
                TQBHYT = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble(),
                TNCCTra = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble(),
                TongSoKhac = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble(),
                TNBTuTra = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true),

                TongChiPhi = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble(),
                SoTienBangChu = NumberHelper.ChuyenSoRaText(Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBV))),

                NguoiBenhPhaiTra = (Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)) + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhTuTra))).ApplyFormatMoneyToDouble(),

                TTQuyTT = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble(),
                BHYTChiTra = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble(),
                CacKhoanTraKhac = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true),
                SoTienKhac = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble(),
                NgayHienTai = DateTime.Now.ApplyFormatNgayThangNam()
            };

            var content = TemplateHelpper.FormatTemplateWithContentTemplate(result?.Body, data);
            return content;
        }
        public string GetHtmlBangKeTrongGoiDv(long taiKhoanThuId, string hostingName, ref TaiKhoanBenhNhanThu taiKhoanBenhNhanThu, ref List<ChiPhiKhamChuaBenhNoiTruVo> tatCaDichVuKhamChuaBenh)
        {
            if (taiKhoanBenhNhanThu == null)
            {
                taiKhoanBenhNhanThu = _taiKhoanBenhNhanThuRepository.TableNoTracking.Where(c => c.Id == taiKhoanThuId && c.LoaiThuTienBenhNhan == Enums.LoaiThuTienBenhNhan.ThuTheoChiPhi)
                                                                                        .Include(o => o.YeuCauTiepNhan).ThenInclude(o => o.NoiTruBenhAn).ThenInclude(o => o.ChuyenDenBenhVien)
                                                                                        .Include(o => o.YeuCauTiepNhan).ThenInclude(o => o.NoiTruBenhAn).ThenInclude(o => o.KhoaPhongNhapVien)
                                                                                        .Include(o => o.YeuCauTiepNhan).ThenInclude(o => o.NoiTruBenhAn).ThenInclude(o => o.ChanDoanChinhRaVienICD)
                                                                                        .Include(o => o.YeuCauTiepNhan).ThenInclude(o => o.YeuCauTiepNhanTheBHYTs)
                                                                                        .Include(o => o.YeuCauTiepNhan).ThenInclude(o => o.YeuCauNhapVien).ThenInclude(o => o.YeuCauKhamBenh).ThenInclude(o => o.YeuCauTiepNhan)
                                                                                        .Include(cc => cc.YeuCauTiepNhan)
                                                                                        .ThenInclude(xx => xx.BenhNhan)
                                                                                        .Include(cc => cc.YeuCauTiepNhan)
                                                                                        .ThenInclude(xx => xx.YeuCauKhamBenhs)
                                                                                        .ThenInclude(o => o.YeuCauKhamBenhChuanDoans)
                                                                                        .ThenInclude(o => o.ChuanDoan)
                                                                                        .Include(cc => cc.YeuCauTiepNhan).ThenInclude(cc => cc.PhuongXa)
                                                                                        .Include(cc => cc.YeuCauTiepNhan)
                                                                                        .ThenInclude(cc => cc.QuanHuyen)
                                                                                        .Include(cc => cc.YeuCauTiepNhan)
                                                                                        .ThenInclude(cc => cc.TinhThanh)
                                                                                        .Include(cc => cc.YeuCauTiepNhan)
                                                                                        .ThenInclude(cc => cc.NoiChuyen)
                                                                                        .Include(o => o.YeuCauTiepNhan).ThenInclude(o => o.NoiTruBenhAn).ThenInclude(o => o.NoiTruPhieuDieuTris).ThenInclude(c => c.ChanDoanChinhICD)
                                                                                        .Include(o => o.YeuCauTiepNhan).ThenInclude(o => o.NoiTruBenhAn).ThenInclude(o => o.NoiTruPhieuDieuTris).ThenInclude(o => o.NoiTruThamKhamChanDoanKemTheos).ThenInclude(c => c.ICD)
                                                                                        .Include(o => o.YeuCauTiepNhan).ThenInclude(o => o.NoiTruBenhAn).ThenInclude(o => o.NoiTruKhoaPhongDieuTris).ThenInclude(c => c.KhoaPhongChuyenDen).FirstOrDefault();

            }
            var yeuCauTiepNhan = taiKhoanBenhNhanThu.YeuCauTiepNhan;
            if (yeuCauTiepNhan == null)
                return string.Empty;
            if(tatCaDichVuKhamChuaBenh == null)
            {
                tatCaDichVuKhamChuaBenh = GetTatCaDichVuKhamChuaBenh(yeuCauTiepNhan.Id).Result;
            }
            var danhSachChiPhi = tatCaDichVuKhamChuaBenh.Where(o => !o.Soluong.AlmostEqual(0) && o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.DaThanhToan && o.YeuCauGoiDichVuId != null).ToList();
            if (danhSachChiPhi.Count == 0)
            {
                return string.Empty;
            }

            var query = taiKhoanBenhNhanThu?.YeuCauTiepNhan;
            var result = _templateRepository.TableNoTracking.FirstOrDefault(x => x.Name.Equals("BangKeChiPhiGoiKhamChuaBenh"));



            var benhVien = new Core.Domain.Entities.BenhVien.BenhVien();

            string maBHYT = string.Empty;
            string bHYTTuNgay = string.Empty;
            string bHYTDenNgay = string.Empty;
            string mucHuong = string.Empty;
            string NoiDKKCBBanDau = string.Empty;
            string MaKCBBanDau = string.Empty;


            string maICDKemTheo = string.Empty;
            string tenICDKemTheo = string.Empty;

            string chuanDoanXacDinhSanKhoa = string.Empty;
            string maICD10 = string.Empty;

            if (yeuCauTiepNhan.NoiTruBenhAn != null && (yeuCauTiepNhan.NoiTruBenhAn.LoaiBenhAn == LoaiBenhAn.SanKhoaMo || yeuCauTiepNhan.NoiTruBenhAn.LoaiBenhAn == LoaiBenhAn.SanKhoaThuong))
            {
                if (yeuCauTiepNhan.NoiTruBenhAn?.NoiTruPhieuDieuTris.Count() > 0)
                {
                    var phieuDieuTri = yeuCauTiepNhan.NoiTruBenhAn?.NoiTruPhieuDieuTris.OrderByDescending(c => c.NgayDieuTri).FirstOrDefault();

                    var icdKemTheoIds = phieuDieuTri.NoiTruThamKhamChanDoanKemTheos.Select(c => c.ICD.Ma);
                    var tenICDKemTheos = phieuDieuTri.NoiTruThamKhamChanDoanKemTheos.Select(c => c.GhiChu);

                    maICDKemTheo = string.Join(", ", icdKemTheoIds);
                    tenICDKemTheo = string.Join(", ", tenICDKemTheos);

                    maICD10 = phieuDieuTri.ChanDoanChinhICD?.Ma;
                    chuanDoanXacDinhSanKhoa = phieuDieuTri.ChanDoanChinhGhiChu;
                }
            }
            else
            {
                if (!string.IsNullOrEmpty(yeuCauTiepNhan.NoiTruBenhAn?.DanhSachChanDoanKemTheoRaVienICDId))
                {
                    var maICDKemTheos = new List<string>();

                    var icdKemTheoIds = yeuCauTiepNhan.NoiTruBenhAn?.DanhSachChanDoanKemTheoRaVienICDId.Split(Constants.ICDSeparator);
                    var tenICDKemTheos = yeuCauTiepNhan.NoiTruBenhAn?.DanhSachChanDoanKemTheoRaVienGhiChu?.Split(Constants.ICDSeparator);

                    if (icdKemTheoIds.Length > 0)
                    {
                        foreach (var icdKemTheoId in icdKemTheoIds)
                        {
                            var icdKemTheo = _icdRepository.TableNoTracking.FirstOrDefault(o => o.Id == long.Parse(icdKemTheoId));
                            if (icdKemTheo != null)
                            {
                                maICDKemTheos.Add(icdKemTheo.Ma);
                            }

                            //if (long.TryParse(yeuCauTiepNhan.NoiTruBenhAn?.DanhSachChanDoanKemTheoRaVienICDId.Split(Constants.ICDSeparator).First(), out var icdKemTheoId))
                            //{
                            //    var icdKemTheo = _icdRepository.TableNoTracking.FirstOrDefault(o => o.Id == icdKemTheoId);
                            //    if (icdKemTheo != null)
                            //    {
                            //        maICDKemTheo = icdKemTheo.Ma;
                            //        tenICDKemTheo = yeuCauTiepNhan.NoiTruBenhAn?.DanhSachChanDoanKemTheoRaVienGhiChu?.Split(Constants.ICDSeparator).First();
                            //    }
                            //}
                        }
                    }

                    maICDKemTheo = string.Join(", ", maICDKemTheos);
                    tenICDKemTheo = string.Join(", ", tenICDKemTheos);
                }
            }


            YeuCauTiepNhanTheBHYT theBHYT = null;
            if (yeuCauTiepNhan.CoBHYT == true && yeuCauTiepNhan.YeuCauTiepNhanTheBHYTs.Any())
            {
                theBHYT = yeuCauTiepNhan.YeuCauTiepNhanTheBHYTs.First();
                if (!String.IsNullOrEmpty(theBHYT.MaDKBD))
                {
                    benhVien = _benhVienRepository.TableNoTracking.FirstOrDefault(p => p.Ma.Equals(theBHYT.MaDKBD));
                }
                maBHYT = theBHYT.MaSoThe;
                bHYTTuNgay = theBHYT.NgayHieuLuc.ApplyFormatDate();
                bHYTDenNgay = theBHYT.NgayHetHan?.ApplyFormatDate();
                mucHuong = theBHYT.MucHuong.ToString() + "%";
                NoiDKKCBBanDau = benhVien != null ? benhVien?.Ten : "Chưa xác định";
                MaKCBBanDau = theBHYT.MaDKBD;
            }
            else
            {
                maBHYT = "";
                bHYTTuNgay = "";
                bHYTDenNgay = "";
                mucHuong = "0%";
                NoiDKKCBBanDau = "Chưa xác định";
                MaKCBBanDau = "Chưa xác định";
            }

            //var thongTinPhieuThus = GetThongTinPhieuThu(taiKhoanThuId, LoaiPhieuThuChiThuNgan.ThuTheoChiPhi);
            //if (thongTinPhieuThus.ChiPhiKhamChuaBenhNoiTruVos.Count == 0)
            //{
            //    return string.Empty;
            //}
            var dsChiPhiBangKe = new List<BangKeKhamBenhBenhVienVo>();
            var dateItemChiPhis = string.Empty;
            int indexItem = 1;
            var groupChiPhiTheoThe = danhSachChiPhi.GroupBy(o => o.MaSoTheBHYT);
            if (groupChiPhiTheoThe.Count() > 2 ||
                (groupChiPhiTheoThe.All(o => o.Key != string.Empty) && groupChiPhiTheoThe.Count() > 1))
            {
                var groupNgayPhatSinhTheoThe = groupChiPhiTheoThe.Where(o => o.Key != string.Empty).Select(o => new { o.Key, o.OrderBy(j => j.NgayPhatSinh).First().NgayPhatSinh }).OrderBy(o => o.NgayPhatSinh).ToArray();
                for (int i = 0; i < groupNgayPhatSinhTheoThe.Count(); i++)
                {
                    var ngayPhatSinhTheoThe = groupNgayPhatSinhTheoThe[i];
                    var theBHYTChiTra = yeuCauTiepNhan.YeuCauTiepNhanTheBHYTs.First(o => o.MaSoThe == ngayPhatSinhTheoThe.Key);
                    var chiPhis = groupChiPhiTheoThe.FirstOrDefault(o => o.Key == ngayPhatSinhTheoThe.Key).ToList();
                    DateTime? ngayPhatSinhTiepTheo = i < groupNgayPhatSinhTheoThe.Count() - 1
                        ? groupNgayPhatSinhTheoThe[i + 1].NgayPhatSinh
                        : null;
                    chiPhis.AddRange(groupChiPhiTheoThe.FirstOrDefault(o => o.Key == string.Empty).Where(j => (i == 0 || j.NgayPhatSinh >= ngayPhatSinhTheoThe.NgayPhatSinh) && (ngayPhatSinhTiepTheo != null && j.NgayPhatSinh < ngayPhatSinhTiepTheo)).ToList());
                    var mucHuongPT = theBHYTChiTra != null && theBHYTChiTra?.MucHuong > 0 ? theBHYTChiTra?.MucHuong + "%" : string.Empty;

                    dateItemChiPhis += "<table style='width: 100 %; '>" +
                                       "<tbody>" +
                                       "<tr>" +
                                       $"<td style='padding-left:-5px; width: 40 %; '>Mã thẻ BHYT {i + 1}: <b>{theBHYTChiTra.MaSoThe}</b> " +
                                       $"<span style='padding-left:20px'>Giá trị từ: <b>{theBHYTChiTra.NgayHieuLuc.ApplyFormatDate()}</b> đến <b>{theBHYTChiTra.NgayHetHan?.ApplyFormatDate()}</b></span>" +
                                       $"<span style='padding-left:20px'>Mức hưởng: <b>{mucHuongPT}</b></span></td>" +
                                       "</tr>" +
                                       "</tbody>" +
                                       "</table>" +
                                       "</br>" +
                                       "<table style='width:100%;border: 1px solid #020000; border-collapse: collapse;'>" +
                                            "<tr style='border: 1px solid black;  border-collapse: collapse;'>" +
                                            "<th style='border: 1px solid #020000; border-collapse: collapse;text-align: center;' rowspan='2'>" +
                                                    "STT </th>" +
                                                "<th style='border: 1px solid #020000; border-collapse: collapse;width:35%;text-align: center;' rowspan='2'>" +
                                                    "Nội dung </th>" +
                                                "<th style='border: 1px solid #020000; border-collapse: collapse;width:5%;text-align: center;' rowspan='2'>" +
                                                    "Đơn vị tính</th>" +
                                                "<th style='border: 1px solid #020000; border-collapse: collapse;width:3%; text-align: center;' rowspan='2'>" +
                                                    "Số lượng</th>" +
                                                "<th style='border: 1px solid #020000; border-collapse: collapse;width:3%; text-align: center;' rowspan='2'>" +
                                                    "Đơn giá BV <span style='font-weight: 100;'>(đồng)</span></th>" +
                                                "<th style='border: 1px solid #020000; border-collapse: collapse;width:3%; text-align: center;' rowspan='2'>" +
                                                    "Đơn giá BH  <span style='font-weight: 100;'>(đồng)</span></th>" +
                                                "<th style='border: 1px solid #020000; border-collapse: collapse;width:200px; text-align: center;'" +
                                                    "rowspan='2'>" +
                                                    "Tỉ lệ thanh toán theo dich vụ   <span style='font-weight: 100;'>(%)</span></th>" +
                                                "<th style='border: 1px solid #020000; border-collapse: collapse;width:8%;text-align: center;' rowspan='2'>" +
                                                    "Thành tiền BV  <span style='font-weight: 100;'>(đồng)</span>" +
                                                "</th>" +
                                                "<th style='border: 1px solid #020000; border-collapse: collapse;width:200px; text-align: center;'" +
                                                    "rowspan='2'>" +
                                                    "Tỷ lệ thanh toán BHYT <span style='font-weight: 100;'>(%)</span>" +
                                                "</th>" +
                                                "<th style='border: 1px solid #020000; border-collapse: collapse;width:8%;text-align: center;' rowspan='2'>" +
                                                    "Thành tiền BH  <span style='font-weight: 100;'>(đồng)</span>" +
                                                "</th>" +
                                                "<th style='border: 1px solid #020000; border-collapse: collapse;width:35%;text-align: center;' colspan='4'>" +
                                                    "Nguồn thanh toán  <span style='font-weight: 100;'>(đồng)</span></th>" +
                                            "</tr>" +
                                            "<tr style='border: 1px solid #020000; border-collapse: collapse;'>" +
                                                "<td style='border: 1px solid #020000; border-collapse: collapse;text-align: center;'><b>Quỹ BHYT</b></td>" +
                                                "<td style=' border: 1px solid #020000; border-collapse: collapse;width:80px;text-align: center;'>" +
                                                    "<b>Người bệnh cùng chi" +
                                                    " trả</b> (đồng)</td>" +
                                                "<td style=' border: 1px solid #020000; border-collapse: collapse;text-align: center;'><b>Khác</b> (đồng)</td>" +
                                                "<td style='border: 1px solid #020000; border-collapse: collapse;text-align: center;width: 90px;'>" +
                                                    "<b>Người bệnh" +
                                                    "tự trả </b>(đồng)" +
                                                "</td>" +
                                            "</tr>" +
                                            "<tr style=' border: 1px solid #020000; '>" +
                                              "<td style='border: 1px solid #020000;text-align: center;'><b> </b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(1)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(2)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(3)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(4)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(5)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(6)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(7)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(8)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(9)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(10)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(11)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(12)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(13)</b> </td>" +
                                            "</tr>";

                    var dsChiPhiBangKeTheoThe = new List<BangKeKhamBenhBenhVienVo>();

                    foreach (var chiPhi in chiPhis.Where(c => c.NhomChiPhiBangKe != NhomChiPhiBangKe.GoiVatTu && c.YeuCauGoiDichVuId == null).GroupBy(c => new { c.DonGia, c.SoTienMG, KhongTinhPhi = c.KhongTinhPhi.GetValueOrDefault(), c.NhomChiPhiBangKe, c.TenDichVu, c.DonViTinh, c.DuocHuongBHYT, c.DonGiaBHYT, c.MucHuongBaoHiem, c.TiLeBaoHiemThanhToan }).OrderByDescending(o => o.Key.DuocHuongBHYT))
                    {
                        var chiphiBangKe = new BangKeKhamBenhBenhVienVo
                        {
                            Nhom = chiPhi.Key.NhomChiPhiBangKe,
                            Id = chiPhi.FirstOrDefault().Id,
                            NoiDung = chiPhi.Key.TenDichVu,
                            DonViTinh = chiPhi.Key.DonViTinh,
                            SoLuong = (decimal)chiPhi.Sum(c => c.Soluong),
                            DuocHuongBaoHiem = chiPhi.Key.DuocHuongBHYT,
                            DonGiaBH = chiPhi.Key.DuocHuongBHYT ? chiPhi.Key.DonGiaBHYT : 0,
                            MucHuongBaoHiem = chiPhi.Key.MucHuongBaoHiem,
                            TiLeThanhToanTheoDV = chiPhi.Key.TiLeBaoHiemThanhToan,
                            BaoHiemChiTra = true,
                            DonGiaBV = chiPhi.Key.DonGia
                        };
                        if (chiPhi.Key.KhongTinhPhi == true)
                        {
                            chiphiBangKe.Khac = chiPhi.Key.MucHuongBaoHiem > 0
                                ? (chiphiBangKe.ThanhTienBV.GetValueOrDefault() - chiphiBangKe.ThanhTienBH.GetValueOrDefault())
                                : chiphiBangKe.ThanhTienBV.GetValueOrDefault();
                        }
                        else
                        {
                            chiphiBangKe.Khac = chiPhi.Sum(c => c.SoTienMG);
                        }
                        dsChiPhiBangKeTheoThe.Add(chiphiBangKe);
                    }

                    foreach (var chiPhi in chiPhis.Where(c => !(c.NhomChiPhiBangKe != NhomChiPhiBangKe.GoiVatTu && c.YeuCauGoiDichVuId == null)))
                    {
                        var chiphiBangKe = new BangKeKhamBenhBenhVienVo
                        {
                            Nhom = chiPhi.NhomChiPhiBangKe,
                            Id = chiPhi.Id,
                            NoiDung = chiPhi.TenDichVu,
                            DonViTinh = chiPhi.DonViTinh,
                            SoLuong = (decimal)chiPhi.Soluong,
                            DuocHuongBaoHiem = chiPhi.DuocHuongBHYT,
                            DonGiaBH = chiPhi.DuocHuongBHYT ? chiPhi.DonGiaBHYT : 0,
                            MucHuongBaoHiem = chiPhi.MucHuongBaoHiem,
                            TiLeThanhToanTheoDV = chiPhi.TiLeBaoHiemThanhToan,
                            BaoHiemChiTra = true,
                            DonGiaBV = chiPhi.DonGia
                        };
                        if (chiPhi.KhongTinhPhi == true || chiPhi.YeuCauGoiDichVuId != null)
                        {
                            chiphiBangKe.Khac = chiPhi.MucHuongBaoHiem > 0
                                ? (chiphiBangKe.ThanhTienBV.GetValueOrDefault() - chiphiBangKe.ThanhTienBH.GetValueOrDefault())
                                : chiphiBangKe.ThanhTienBV.GetValueOrDefault();
                        }
                        else
                        {
                            chiphiBangKe.Khac = chiPhi.SoTienMG;
                        }
                        dsChiPhiBangKeTheoThe.Add(chiphiBangKe);
                    }

                    //foreach (var chiPhi in chiPhis)
                    //{
                    //    dsChiPhiBangKeTheoThe.Add(new BangKeKhamBenhBenhVienVo
                    //    {
                    //        Nhom = chiPhi.NhomChiPhiBangKe,
                    //        Id = chiPhi.Id,
                    //        NoiDung = chiPhi.TenDichVu,
                    //        DonViTinh = chiPhi.DonViTinh,
                    //        SoLuong = (decimal)chiPhi.Soluong,
                    //        DuocHuongBaoHiem = chiPhi.DuocHuongBHYT,
                    //        DonGiaBH = chiPhi.DuocHuongBHYT ? chiPhi.DonGiaBHYT : 0,
                    //        MucHuongBaoHiem = chiPhi.MucHuongBaoHiem,
                    //        TiLeThanhToanTheoDV = chiPhi.TiLeBaoHiemThanhToan,
                    //        BaoHiemChiTra = true,
                    //        DonGiaBV = chiPhi.DonGia
                    //    });
                    //}
                    dsChiPhiBangKe.AddRange(dsChiPhiBangKeTheoThe);
                    var groupChiPhiBangKes = dsChiPhiBangKeTheoThe.GroupBy(x => x.Nhom).OrderBy(o => (int)o.Key * (o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay || o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriNoiTru ? 1 : 10));
                    foreach (var groupChiPhiBangKe in groupChiPhiBangKes)
                    {
                        if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay)
                        {

                            dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                               "<td style='border: 1px solid #020000;' colspan='7'>" +
                                               "<span style='float:left;'><b>2. Ngày giường:  </b></span>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                               "</tr>";
                            dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                               "<td style='border: 1px solid #020000;' colspan='7'>" +
                                               "<span style='float:left;'><b>2.1." + groupChiPhiBangKe.Key.GetDescription() + "  </b></span>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b> " + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true) + "</b> </td>" +
                                               "</tr>";
                        }
                        else if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.NgayGiuongDieuTriNoiTru)
                        {
                            if (!groupChiPhiBangKes.Any(o => o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay))
                            {
                                dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                                   "<td style='border: 1px solid #020000;' colspan='7'>" +
                                                   "<span style='float:left;'><b>2. Ngày giường:  </b></span>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                   "</tr>";
                            }
                            dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                               "<td style='border: 1px solid #020000;' colspan='7'>" +
                                               "<span style='float:left;'><b>2.2." + groupChiPhiBangKe.Key.GetDescription() + "  </b></span>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b> " + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true) + "</b> </td>" +
                                               "</tr>";
                        }
                        else
                        {
                            dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                               "<td style='border: 1px solid #020000;' colspan='7'>" +
                                               "<span style='float:left;'><b>" + (int)groupChiPhiBangKe.Key + "." + groupChiPhiBangKe.Key.GetDescription() + "  </b></span>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b> " + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true) + "</b> </td>" +
                                               "</tr>";
                        }
                        if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.GoiVatTu)
                        {
                            var groupGoiVatTus = groupChiPhiBangKe.ToList().GroupBy(o => o.SoGoiVatTu.GetValueOrDefault()).OrderBy(o => o.Key);
                            int sttGoiVatTu = 1;
                            foreach (var groupGoiVatTu in groupGoiVatTus)
                            {
                                dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                                   "<td style='border: 1px solid #020000;' colspan='7'>" +
                                                   "<span style='float:left;'><b>10." + sttGoiVatTu + ". " + groupChiPhiBangKe.Key.GetDescription() + " " + sttGoiVatTu + "  </b></span>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.Khac)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'><b> " + Convert.ToDouble(groupGoiVatTu.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true) + "</b> </td>" +
                                                   "</tr>";
                                foreach (var chiPhiBangKe in groupGoiVatTu)
                                {
                                    dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                                    "<td style='border: 1px solid #020000; text-align: center;'> " + indexItem + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: left;'> " + chiPhiBangKe.NoiDung + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: center;'>  " + chiPhiBangKe.DonViTinh + " </td>" +
                                                    "<td style='border: 1px solid #020000;text-align: center;'> " + chiPhiBangKe.SoLuong + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: center;'> " + Convert.ToDouble(chiPhiBangKe.DonGiaBV).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: center;'> " + Convert.ToDouble(chiPhiBangKe.DonGiaBH).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.TiLeThanhToanTheoDV).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.ThanhTienBV).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.MucHuongBaoHiem > 0 ? 100 : 0).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.ThanhTienBH).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.QuyBHYT).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.NguoiBenhCungChiTra).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.Khac).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.NguoiBenhTuTra).ApplyFormatMoneyToDouble(true) + "</td>" +
                                                    "</tr>";
                                    indexItem++;
                                }
                            }
                        }
                        else
                        {
                            foreach (var chiPhiBangKe in groupChiPhiBangKe)
                            {
                                dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                                "<td style='border: 1px solid #020000; text-align: center;'> " + indexItem + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: left;'> " + chiPhiBangKe.NoiDung + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'>  " + chiPhiBangKe.DonViTinh + " </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'> " + chiPhiBangKe.SoLuong + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'> " + Convert.ToDouble(chiPhiBangKe.DonGiaBV).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'> " + Convert.ToDouble(chiPhiBangKe.DonGiaBH).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.TiLeThanhToanTheoDV).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.ThanhTienBV).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.MucHuongBaoHiem > 0 ? 100 : 0).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.ThanhTienBH).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.QuyBHYT).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.NguoiBenhCungChiTra).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.Khac).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.NguoiBenhTuTra).ApplyFormatMoneyToDouble(true) + "</td>" +
                                                "</tr>";
                                indexItem++;
                            }
                        }

                    }

                    dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                       "<td style='border: 1px solid #020000;' colspan='7'></span>" +
                                       "<span style='float:right;padding-right: 50px;'><b>Tổng Cộng</b></span>" +
                                       "</td>" +
                                       $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKeTheoThe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                       $"<td style='border: 1px solid #020000;text-align: right;'><b></b> </td>" +
                                       $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKeTheoThe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                       $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKeTheoThe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                       $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKeTheoThe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                       $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKeTheoThe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                       $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKeTheoThe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true)}</b> </td>" +
                                       "</tr>" +
                                       "</table>";
                }
            }
            else
            {
                YeuCauTiepNhanTheBHYT theBHYTChiTra = null;
                var maSoThe = groupChiPhiTheoThe.Where(o => o.Key != string.Empty).FirstOrDefault()?.Key;
                if (!string.IsNullOrEmpty(maSoThe))
                {
                    theBHYTChiTra = yeuCauTiepNhan.YeuCauTiepNhanTheBHYTs.First(o => o.MaSoThe == maSoThe);
                }

                var chiPhis = groupChiPhiTheoThe.SelectMany(o => o).ToList();
                var mucHuongPT = theBHYTChiTra != null && theBHYTChiTra?.MucHuong > 0 ? theBHYTChiTra?.MucHuong + "%" : string.Empty;

                dateItemChiPhis += "<table style='width: 100 %; '>" +
                                    "<tbody>" +
                                    "<tr>" +
                                       $"<td style='padding-left:-5px; width: 40 %; '>Mã thẻ BHYT: <b>{theBHYTChiTra?.MaSoThe}</b> " +
                                       $"<span style='padding-left:20px'>Giá trị từ: <b>{theBHYTChiTra?.NgayHieuLuc.ApplyFormatDate()}</b> đến <b>{theBHYTChiTra?.NgayHetHan?.ApplyFormatDate()}</b></span>" +
                                       $"<span style='padding-left:20px'>Mức hưởng: <b>{mucHuongPT}</b></span></td>" +
                                       "</tr>" +
                                    "</tbody>" +
                                    "</table>" +
                                    "</br>" +
                                    "<table style='width:100%;border: 1px solid #020000; border-collapse: collapse;'>" +
                                        "<tr style='border: 1px solid black;  border-collapse: collapse;'>" +
                                        "<th style='border: 1px solid #020000; border-collapse: collapse;text-align: center;' rowspan='2'>" +
                                                "STT </th>" +
                                            "<th style='border: 1px solid #020000; border-collapse: collapse;width:35%;text-align: center;' rowspan='2'>" +
                                                "Nội dung </th>" +
                                            "<th style='border: 1px solid #020000; border-collapse: collapse;width:5%;text-align: center;' rowspan='2'>" +
                                                "Đơn vị tính</th>" +
                                            "<th style='border: 1px solid #020000; border-collapse: collapse;width:3%; text-align: center;' rowspan='2'>" +
                                                "Số lượng</th>" +
                                            "<th style='border: 1px solid #020000; border-collapse: collapse;width:3%; text-align: center;' rowspan='2'>" +
                                                "Đơn giá BV <span style='font-weight: 100;'>(đồng)</span></th>" +
                                            "<th style='border: 1px solid #020000; border-collapse: collapse;width:3%; text-align: center;' rowspan='2'>" +
                                                "Đơn giá BH  <span style='font-weight: 100;'>(đồng)</span></th>" +
                                            "<th style='border: 1px solid #020000; border-collapse: collapse;width:200px; text-align: center;'" +
                                                "rowspan='2'>" +
                                                "Tỉ lệ thanh toán theo dich vụ   <span style='font-weight: 100;'>(%)</span></th>" +
                                            "<th style='border: 1px solid #020000; border-collapse: collapse;width:8%;text-align: center;' rowspan='2'>" +
                                                "Thành tiền BV  <span style='font-weight: 100;'>(đồng)</span>" +
                                            "</th>" +
                                            "<th style='border: 1px solid #020000; border-collapse: collapse;width:200px; text-align: center;'" +
                                                "rowspan='2'>" +
                                                "Tỷ lệ thanh toán BHYT <span style='font-weight: 100;'>(%)</span>" +
                                            "</th>" +
                                            "<th style='border: 1px solid #020000; border-collapse: collapse;width:8%;text-align: center;' rowspan='2'>" +
                                                "Thành tiền BH  <span style='font-weight: 100;'>(đồng)</span>" +
                                            "</th>" +
                                            "<th style='border: 1px solid #020000; border-collapse: collapse;width:35%;text-align: center;' colspan='4'>" +
                                                "Nguồn thanh toán  <span style='font-weight: 100;'>(đồng)</span></th>" +
                                        "</tr>" +
                                        "<tr style='border: 1px solid #020000; border-collapse: collapse;'>" +
                                            "<td style='border: 1px solid #020000; border-collapse: collapse;text-align: center;'><b>Quỹ BHYT</b></td>" +
                                            "<td style=' border: 1px solid #020000; border-collapse: collapse;width:80px;text-align: center;'>" +
                                                "<b>Người bệnh cùng chi " +
                                                " trả</b> (đồng)</td>" +
                                            "<td style=' border: 1px solid #020000; border-collapse: collapse;text-align: center;'><b>Khác</b> (đồng)</td>" +
                                            "<td style='border: 1px solid #020000; border-collapse: collapse;text-align: center;width: 90px;'>" +
                                                "<b>Người bệnh" +
                                                "tự trả </b>(đồng)" +
                                            "</td>" +
                                        "</tr>" +
                                        "<tr style=' border: 1px solid #020000; '>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b> </b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b>(1)</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b>(2)</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b>(3)</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b>(4)</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b>(5)</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b>(6)</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b>(7)</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b>(8)</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b>(9)</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b>(10)</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b>(11)</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b>(12)</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b>(13)</b> </td>" +
                                        "</tr>";


                //foreach (var chiPhi in chiPhis)
                //{
                //    dsChiPhiBangKe.Add(new BangKeKhamBenhBenhVienVo
                //    {
                //        Nhom = chiPhi.NhomChiPhiBangKe,
                //        Id = chiPhi.Id,
                //        NoiDung = chiPhi.TenDichVu,
                //        DonViTinh = chiPhi.DonViTinh,
                //        SoLuong = (decimal)chiPhi.Soluong,
                //        DuocHuongBaoHiem = chiPhi.DuocHuongBHYT,
                //        DonGiaBH = chiPhi.DuocHuongBHYT ? chiPhi.DonGiaBHYT : 0,
                //        MucHuongBaoHiem = chiPhi.MucHuongBaoHiem,
                //        TiLeThanhToanTheoDV = chiPhi.TiLeBaoHiemThanhToan,
                //        BaoHiemChiTra = true,
                //        DonGiaBV = chiPhi.DonGia
                //    });
                //}

                foreach (var chiPhi in chiPhis.Where(c => c.NhomChiPhiBangKe != NhomChiPhiBangKe.GoiVatTu && c.YeuCauGoiDichVuId == null).GroupBy(c => new { c.DonGia, c.SoTienMG, KhongTinhPhi = c.KhongTinhPhi.GetValueOrDefault(), c.NhomChiPhiBangKe, c.TenDichVu, c.DonViTinh, c.DuocHuongBHYT, c.DonGiaBHYT, c.MucHuongBaoHiem, c.TiLeBaoHiemThanhToan }).OrderByDescending(o => o.Key.DuocHuongBHYT))
                {
                    var chiphiBangKe = new BangKeKhamBenhBenhVienVo
                    {
                        Nhom = chiPhi.Key.NhomChiPhiBangKe,
                        Id = chiPhi.FirstOrDefault().Id,
                        NoiDung = chiPhi.Key.TenDichVu,
                        DonViTinh = chiPhi.Key.DonViTinh,
                        SoLuong = (decimal)chiPhi.Sum(c => c.Soluong),
                        DuocHuongBaoHiem = chiPhi.Key.DuocHuongBHYT,
                        DonGiaBH = chiPhi.Key.DuocHuongBHYT ? chiPhi.Key.DonGiaBHYT : 0,
                        MucHuongBaoHiem = chiPhi.Key.MucHuongBaoHiem,
                        TiLeThanhToanTheoDV = chiPhi.Key.TiLeBaoHiemThanhToan,
                        BaoHiemChiTra = true,
                        DonGiaBV = chiPhi.Key.DonGia
                    };
                    if (chiPhi.Key.KhongTinhPhi == true)
                    {
                        chiphiBangKe.Khac = chiPhi.Key.MucHuongBaoHiem > 0
                            ? (chiphiBangKe.ThanhTienBV.GetValueOrDefault() - chiphiBangKe.ThanhTienBH.GetValueOrDefault())
                            : chiphiBangKe.ThanhTienBV.GetValueOrDefault();
                    }
                    else
                    {
                        chiphiBangKe.Khac = chiPhi.Sum(c => c.SoTienMG);
                    }
                    dsChiPhiBangKe.Add(chiphiBangKe);
                }


                foreach (var chiPhi in chiPhis.Where(c => !(c.NhomChiPhiBangKe != NhomChiPhiBangKe.GoiVatTu && c.YeuCauGoiDichVuId == null)))
                {
                    var chiphiBangKe = new BangKeKhamBenhBenhVienVo
                    {
                        Nhom = chiPhi.NhomChiPhiBangKe,
                        Id = chiPhi.Id,
                        NoiDung = chiPhi.TenDichVu,
                        DonViTinh = chiPhi.DonViTinh,
                        SoLuong = (decimal)chiPhi.Soluong,
                        DuocHuongBaoHiem = chiPhi.DuocHuongBHYT,
                        DonGiaBH = chiPhi.DuocHuongBHYT ? chiPhi.DonGiaBHYT : 0,
                        MucHuongBaoHiem = chiPhi.MucHuongBaoHiem,
                        TiLeThanhToanTheoDV = chiPhi.TiLeBaoHiemThanhToan,
                        BaoHiemChiTra = true,
                        DonGiaBV = chiPhi.DonGia
                    };
                    if (chiPhi.KhongTinhPhi == true || chiPhi.YeuCauGoiDichVuId != null)
                    {
                        chiphiBangKe.Khac = chiPhi.MucHuongBaoHiem > 0
                            ? (chiphiBangKe.ThanhTienBV.GetValueOrDefault() - chiphiBangKe.ThanhTienBH.GetValueOrDefault())
                            : chiphiBangKe.ThanhTienBV.GetValueOrDefault();
                    }
                    else
                    {
                        chiphiBangKe.Khac = chiPhi.SoTienMG;
                    }
                    dsChiPhiBangKe.Add(chiphiBangKe);
                }

                var groupChiPhiBangKes = dsChiPhiBangKe.GroupBy(x => x.Nhom).OrderBy(o => (int)o.Key * (o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay || o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriNoiTru ? 1 : 10));
                foreach (var groupChiPhiBangKe in groupChiPhiBangKes)
                {
                    if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay)
                    {

                        dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                            "<td style='border: 1px solid #020000;' colspan='7'>" +
                                            "<span style='float:left;'><b>2. Ngày giường:  </b></span>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                            "</tr>";
                        dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                            "<td style='border: 1px solid #020000;' colspan='7'>" +
                                            "<span style='float:left;'><b>2.1." + groupChiPhiBangKe.Key.GetDescription() + "  </b></span>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b> " + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true) + "</b> </td>" +
                                            "</tr>";
                    }
                    else if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.NgayGiuongDieuTriNoiTru)
                    {
                        if (!groupChiPhiBangKes.Any(o => o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay))
                        {
                            dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                                "<td style='border: 1px solid #020000;' colspan='7'>" +
                                                "<span style='float:left;'><b>2. Ngày giường:  </b></span>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                "</tr>";
                        }
                        dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                            "<td style='border: 1px solid #020000;' colspan='7'>" +
                                            "<span style='float:left;'><b>2.2." + groupChiPhiBangKe.Key.GetDescription() + "  </b></span>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b> " + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true) + "</b> </td>" +
                                            "</tr>";
                    }
                    else
                    {
                        dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                            "<td style='border: 1px solid #020000;' colspan='7'>" +
                                            "<span style='float:left;'><b>" + (int)groupChiPhiBangKe.Key + "." + groupChiPhiBangKe.Key.GetDescription() + "  </b></span>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b> " + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true) + "</b> </td>" +
                                            "</tr>";
                    }
                    if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.GoiVatTu)
                    {
                        var groupGoiVatTus = groupChiPhiBangKe.ToList().GroupBy(o => o.SoGoiVatTu.GetValueOrDefault()).OrderBy(o => o.Key);
                        int sttGoiVatTu = 1;
                        foreach (var groupGoiVatTu in groupGoiVatTus)
                        {
                            dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                                "<td style='border: 1px solid #020000;' colspan='7'>" +
                                                "<span style='float:left;'><b>10." + sttGoiVatTu + ". " + groupChiPhiBangKe.Key.GetDescription() + " " + sttGoiVatTu + "  </b></span>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.Khac)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'><b> " + Convert.ToDouble(groupGoiVatTu.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true) + "</b> </td>" +
                                                "</tr>";
                            foreach (var chiPhiBangKe in groupGoiVatTu)
                            {
                                dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                                "<td style='border: 1px solid #020000; text-align: center;'> " + indexItem + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: left;'> " + chiPhiBangKe.NoiDung + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'>  " + chiPhiBangKe.DonViTinh + " </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'> " + chiPhiBangKe.SoLuong + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'> " + Convert.ToDouble(chiPhiBangKe.DonGiaBV).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'> " + Convert.ToDouble(chiPhiBangKe.DonGiaBH).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.TiLeThanhToanTheoDV).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.ThanhTienBV).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.MucHuongBaoHiem > 0 ? 100 : 0).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.ThanhTienBH).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.QuyBHYT).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.NguoiBenhCungChiTra).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.Khac).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.NguoiBenhTuTra).ApplyFormatMoneyToDouble(true) + "</td>" +
                                                "</tr>";
                                indexItem++;
                            }
                        }
                    }
                    else
                    {
                        foreach (var chiPhiBangKe in groupChiPhiBangKe)
                        {
                            dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                            "<td style='border: 1px solid #020000; text-align: center;'> " + indexItem + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: left;'> " + chiPhiBangKe.NoiDung + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'>  " + chiPhiBangKe.DonViTinh + " </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'> " + chiPhiBangKe.SoLuong + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'> " + Convert.ToDouble(chiPhiBangKe.DonGiaBV).ApplyFormatMoneyToDouble() + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'> " + Convert.ToDouble(chiPhiBangKe.DonGiaBH).ApplyFormatMoneyToDouble() + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.TiLeThanhToanTheoDV).ApplyFormatMoneyToDouble() + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.ThanhTienBV).ApplyFormatMoneyToDouble() + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.MucHuongBaoHiem > 0 ? 100 : 0).ApplyFormatMoneyToDouble() + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.ThanhTienBH).ApplyFormatMoneyToDouble() + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.QuyBHYT).ApplyFormatMoneyToDouble() + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.NguoiBenhCungChiTra).ApplyFormatMoneyToDouble() + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.Khac).ApplyFormatMoneyToDouble() + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.NguoiBenhTuTra).ApplyFormatMoneyToDouble(true) + "</td>" +
                                            "</tr>";
                            indexItem++;
                        }
                    }

                }

                dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                    "<td style='border: 1px solid #020000;' colspan='7'></span>" +
                                    "<span style='float:right;padding-right: 50px;'><b>Tổng Cộng</b></span>" +
                                    "</td>" +
                                    $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                    $"<td style='border: 1px solid #020000;text-align: right;'><b></b> </td>" +
                                    $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                    $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                    $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                    $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                    $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true)}</b> </td>" +
                                    "</tr>" +
                                    "</table>";

            }

            var checkedLyDoVaoVien = "<input id='demo_box_2' class='css - checkbox' type='checkbox' checked  disabled='true'/>";
            var unCheckedLyDoVaoVien = "<input id='demo_box_2' class='css - checkbox' type='checkbox' disabled='true' />";

            var khoaPhong = yeuCauTiepNhan.NoiTruBenhAn?.NoiTruKhoaPhongDieuTris.OrderByDescending(c => c.ThoiDiemVaoKhoa).Select(c => c.KhoaPhongChuyenDen).FirstOrDefault();
            var chuyenKhoa = GetChuyenKhoa(khoaPhong?.Id); //BVHD-3792 

            var data = new
            {
                TitleBangKe = "ĐIỀU TRỊ NỘI TRÚ",
                SoBangKe = "3",
                yeuCauTiepNhan.BenhNhan.MaBN,
                MaTN = yeuCauTiepNhan.MaYeuCauTiepNhan,
                SoBenhAn = "Số bệnh án: " + yeuCauTiepNhan.NoiTruBenhAn?.SoBenhAn,
                yeuCauTiepNhan.HoTen,
                DiaChi = yeuCauTiepNhan.DiaChiDayDu,
                BarCodeImgBase64 = !string.IsNullOrEmpty(yeuCauTiepNhan.MaYeuCauTiepNhan) ? BarcodeHelper.GenerateBarCode(yeuCauTiepNhan.MaYeuCauTiepNhan) : "",
                NamSinh = DateHelper.DOBFormat(yeuCauTiepNhan.NgaySinh, yeuCauTiepNhan.ThangSinh, yeuCauTiepNhan.NamSinh),
                GioiTinh = yeuCauTiepNhan.GioiTinh != null ? yeuCauTiepNhan.GioiTinh.GetDescription() : "",
                //TenKhoa = "Khoa: " + yeuCauTiepNhan.NoiTruBenhAn?.KhoaPhongNhapVien?.Ten,
                //MaKhoa = "Mã khoa: " + yeuCauTiepNhan.NoiTruBenhAn?.KhoaPhongNhapVien?.Ma,

                TenKhoa = "Khoa: " + khoaPhong.Ten,
                MaKhoa = "Mã khoa: " + chuyenKhoa?.Ma,

                MaBHYT = theBHYT?.MaSoThe,
                BHYTTuNgay = bHYTTuNgay,
                BHYTDenNgay = bHYTDenNgay,
                NoiDKKCBBanDau,
                MaKCBBanDau,
                NgayDenKham = yeuCauTiepNhan.YeuCauNhapVien?.YeuCauKhamBenh?.YeuCauTiepNhan.ThoiDiemTiepNhan.ApplyFormatGioPhutNgay(),
                DieuTriKNT = yeuCauTiepNhan.NoiTruBenhAn?.ThoiDiemNhapVien.ApplyFormatGioPhutNgay(),
                KetThucKhamNgoaiTru = yeuCauTiepNhan.NoiTruBenhAn?.ThoiDiemRaVien?.ApplyFormatGioPhutNgay(),
                SoNgayDTri = NoiTruBenhAnHelper.TinhSoNgayDieuTri(yeuCauTiepNhan.NoiTruBenhAn)?.ToString() ?? string.Empty,//yeuCauTiepNhan.NoiTruBenhAn?.ThoiDiemRaVien == null ? "" : (yeuCauTiepNhan.NoiTruBenhAn.ThoiDiemRaVien.Value.Date.AddDays(1) - yeuCauTiepNhan.NoiTruBenhAn.ThoiDiemNhapVien.Date).Days.ToString(),
                TinhTrangRaVien = yeuCauTiepNhan.NoiTruBenhAn?.TinhTrangRaVien == EnumTinhTrangRaVien.RaVien && (yeuCauTiepNhan.NoiTruBenhAn?.KetQuaDieuTri == EnumKetQuaDieuTri.Do || yeuCauTiepNhan.NoiTruBenhAn?.KetQuaDieuTri == EnumKetQuaDieuTri.Khoi) ? 1 : 2,
                MucHuong = mucHuong,
                NoiChuyenDen = yeuCauTiepNhan.NoiChuyen?.Ten,
                NoiChuyenDi = yeuCauTiepNhan.NoiTruBenhAn?.ChuyenDenBenhVien?.Ten,
                MKV = theBHYT?.MaKhuVuc,
                NgayMiemCungTC = theBHYT?.NgayDuocMienCungChiTra?.ApplyFormatDate(),
                ThoiGian5Nam = theBHYT?.NgayDu5Nam?.ApplyFormatDate(),
                CoCapCuu = yeuCauTiepNhan.LyDoVaoVien == Enums.EnumLyDoVaoVien.CapCuu ? checkedLyDoVaoVien : unCheckedLyDoVaoVien,
                CoDungTuyen = yeuCauTiepNhan.LyDoVaoVien == Enums.EnumLyDoVaoVien.DungTuyen ? checkedLyDoVaoVien : unCheckedLyDoVaoVien,
                CoThongTuyen = yeuCauTiepNhan.LyDoVaoVien == Enums.EnumLyDoVaoVien.ThongTuyen ? checkedLyDoVaoVien : unCheckedLyDoVaoVien,
                CoTraiTuyen = yeuCauTiepNhan.LyDoVaoVien == Enums.EnumLyDoVaoVien.TraiTuyen ? checkedLyDoVaoVien : unCheckedLyDoVaoVien,

                ChuanDoanXacDinh = yeuCauTiepNhan.NoiTruBenhAn != null && (yeuCauTiepNhan.NoiTruBenhAn.LoaiBenhAn == LoaiBenhAn.SanKhoaMo || yeuCauTiepNhan.NoiTruBenhAn.LoaiBenhAn == LoaiBenhAn.SanKhoaThuong) ? chuanDoanXacDinhSanKhoa : yeuCauTiepNhan.NoiTruBenhAn?.ChanDoanChinhRaVienGhiChu,
                MaICD10 = yeuCauTiepNhan.NoiTruBenhAn != null && (yeuCauTiepNhan.NoiTruBenhAn.LoaiBenhAn == LoaiBenhAn.SanKhoaMo || yeuCauTiepNhan.NoiTruBenhAn.LoaiBenhAn == LoaiBenhAn.SanKhoaThuong) ? maICD10 : yeuCauTiepNhan.NoiTruBenhAn?.ChanDoanChinhRaVienICD?.Ma,

                BenhKemTheo = tenICDKemTheo,
                ICDKemTheo10 = maICDKemTheo,

                DateItemChiPhis = dateItemChiPhis,

                TTDV = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble(),
                TTTTBHYT = "",

                TTTienBH = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble(),
                TQBHYT = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble(),
                TNCCTra = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble(),
                TongSoKhac = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble(),
                TNBTuTra = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true),

                TongChiPhi = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble(),
                SoTienBangChu = NumberHelper.ChuyenSoRaText(Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBV))),

                NguoiBenhPhaiTra = (Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)) + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhTuTra))).ApplyFormatMoneyToDouble(),

                TTQuyTT = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble(),
                BHYTChiTra = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble(),
                CacKhoanTraKhac = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true),
                SoTienKhac = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble(),
                NgayHienTai = DateTime.Now.ApplyFormatNgayThangNam()
            };

            var content = TemplateHelpper.FormatTemplateWithContentTemplate(result?.Body, data);
            return content;
        }

        public string GetHtmlBangKeCoBHYTChuaQuyetToan(long yeuCauTiepNhanId, string hostingName)
        {
            //var danhSachChiPhi = GetDanhSachChiPhiNoiTruChuaThu(yeuCauTiepNhanId).Result;
            var danhSachChiPhi = GetTatCaDichVuKhamChuaBenh(yeuCauTiepNhanId).Result.Where(o => !o.Soluong.AlmostEqual(0) && o.KhongTinhPhi != true && o.DuocHuongBHYT && o.MucHuongBaoHiem > 0).ToList();
            if (danhSachChiPhi.Count() == 0)
            {
                return string.Empty;
            }

            var yeuCauTiepNhan = BaseRepository.GetById(yeuCauTiepNhanId,
                x => x.Include(o => o.NoiTruBenhAn).ThenInclude(o => o.ChuyenDenBenhVien)
                    .Include(o => o.NoiTruBenhAn).ThenInclude(o => o.KhoaPhongNhapVien)
                    .Include(o => o.NoiTruBenhAn).ThenInclude(o => o.ChanDoanChinhRaVienICD)
                    .Include(o => o.YeuCauTiepNhanTheBHYTs)
                    .Include(o => o.YeuCauNhapVien).ThenInclude(o => o.YeuCauKhamBenh).ThenInclude(o => o.YeuCauTiepNhan)
                    .Include(o => o.BenhNhan)
                    .Include(o => o.PhuongXa)
                    .Include(o => o.QuanHuyen)
                    .Include(o => o.TinhThanh)
                    .Include(o => o.NoiTruBenhAn).ThenInclude(o => o.NoiTruPhieuDieuTris).ThenInclude(o => o.NoiTruThamKhamChanDoanKemTheos).ThenInclude(c => c.ICD)
                    .Include(o => o.NoiTruBenhAn).ThenInclude(o => o.NoiTruPhieuDieuTris).ThenInclude(c => c.ChanDoanChinhICD)
                    .Include(o => o.NoiChuyen).Include(o => o.NoiTruBenhAn).ThenInclude(o => o.NoiTruKhoaPhongDieuTris).ThenInclude(c => c.KhoaPhongChuyenDen));

            var result = _templateRepository.TableNoTracking.FirstOrDefault(x => x.Name.Equals("BangKeKhamBenhBHYTVaBenhVien"));

            if (yeuCauTiepNhan == null)
                return string.Empty;

            var benhVien = new Core.Domain.Entities.BenhVien.BenhVien();

            string maBHYT = string.Empty;
            string bHYTTuNgay = string.Empty;
            string bHYTDenNgay = string.Empty;
            string mucHuong = string.Empty;
            string NoiDKKCBBanDau = string.Empty;
            string MaKCBBanDau = string.Empty;


            string maICDKemTheo = string.Empty;
            string tenICDKemTheo = string.Empty;


            string chuanDoanXacDinhSanKhoa = string.Empty;
            string maICD10 = string.Empty;

            if (yeuCauTiepNhan.NoiTruBenhAn != null && (yeuCauTiepNhan.NoiTruBenhAn.LoaiBenhAn == LoaiBenhAn.SanKhoaMo || yeuCauTiepNhan.NoiTruBenhAn.LoaiBenhAn == LoaiBenhAn.SanKhoaThuong))
            {
                if (yeuCauTiepNhan.NoiTruBenhAn?.NoiTruPhieuDieuTris.Count() > 0)
                {
                    var phieuDieuTri = yeuCauTiepNhan.NoiTruBenhAn?.NoiTruPhieuDieuTris.OrderByDescending(c => c.NgayDieuTri).FirstOrDefault();

                    var icdKemTheoIds = phieuDieuTri.NoiTruThamKhamChanDoanKemTheos.Select(c => c.ICD.Ma);
                    var tenICDKemTheos = phieuDieuTri.NoiTruThamKhamChanDoanKemTheos.Select(c => c.GhiChu);

                    maICDKemTheo = string.Join(", ", icdKemTheoIds);
                    tenICDKemTheo = string.Join(", ", tenICDKemTheos);


                    maICD10 = phieuDieuTri.ChanDoanChinhICD?.Ma;
                    chuanDoanXacDinhSanKhoa = phieuDieuTri.ChanDoanChinhGhiChu;
                }
            }
            else
            {
                if (!string.IsNullOrEmpty(yeuCauTiepNhan.NoiTruBenhAn?.DanhSachChanDoanKemTheoRaVienICDId))
                {
                    var maICDKemTheos = new List<string>();

                    var icdKemTheoIds = yeuCauTiepNhan.NoiTruBenhAn?.DanhSachChanDoanKemTheoRaVienICDId.Split(Constants.ICDSeparator);
                    var tenICDKemTheos = yeuCauTiepNhan.NoiTruBenhAn?.DanhSachChanDoanKemTheoRaVienGhiChu?.Split(Constants.ICDSeparator);

                    if (icdKemTheoIds.Length > 0)
                    {
                        foreach (var icdKemTheoId in icdKemTheoIds)
                        {
                            var icdKemTheo = _icdRepository.TableNoTracking.FirstOrDefault(o => o.Id == long.Parse(icdKemTheoId));
                            if (icdKemTheo != null)
                            {
                                maICDKemTheos.Add(icdKemTheo.Ma);
                            }

                            //if (long.TryParse(yeuCauTiepNhan.NoiTruBenhAn?.DanhSachChanDoanKemTheoRaVienICDId.Split(Constants.ICDSeparator).First(), out var icdKemTheoId))
                            //{
                            //    var icdKemTheo = _icdRepository.TableNoTracking.FirstOrDefault(o => o.Id == icdKemTheoId);
                            //    if (icdKemTheo != null)
                            //    {
                            //        maICDKemTheo = icdKemTheo.Ma;
                            //        tenICDKemTheo = yeuCauTiepNhan.NoiTruBenhAn?.DanhSachChanDoanKemTheoRaVienGhiChu?.Split(Constants.ICDSeparator).First();
                            //    }
                            //}
                        }
                    }

                    maICDKemTheo = string.Join(", ", maICDKemTheos);
                    tenICDKemTheo = string.Join(", ", tenICDKemTheos);
                }
            }

            YeuCauTiepNhanTheBHYT theBHYT = null;
            if (yeuCauTiepNhan.CoBHYT == true && yeuCauTiepNhan.YeuCauTiepNhanTheBHYTs.Any())
            {
                theBHYT = yeuCauTiepNhan.YeuCauTiepNhanTheBHYTs.First();
                if (!String.IsNullOrEmpty(theBHYT.MaDKBD))
                {
                    benhVien = _benhVienRepository.TableNoTracking.FirstOrDefault(p => p.Ma.Equals(theBHYT.MaDKBD));
                }
                maBHYT = theBHYT.MaSoThe;
                bHYTTuNgay = theBHYT.NgayHieuLuc.ApplyFormatDate();
                bHYTDenNgay = theBHYT.NgayHetHan?.ApplyFormatDate();
                mucHuong = theBHYT.MucHuong.ToString() + "%";
                NoiDKKCBBanDau = benhVien != null ? benhVien?.Ten : "Chưa xác định";
                MaKCBBanDau = theBHYT.MaDKBD;
            }
            else
            {
                maBHYT = "";
                bHYTTuNgay = "";
                bHYTDenNgay = "";
                mucHuong = "0%";
                NoiDKKCBBanDau = "Chưa xác định";
                MaKCBBanDau = "Chưa xác định";
            }

            var dsChiPhiBangKe = new List<BangKeKhamBenhCoBHYTVo>();
            var dateItemChiPhis = string.Empty;
            int indexItem = 1;
            var groupChiPhiTheoThe = danhSachChiPhi.GroupBy(o => o.MaSoTheBHYT);


            var ngayNhapVien = yeuCauTiepNhan.NoiTruBenhAn.ThoiDiemNhapVien.ApplyFormatDate();
            var ngayRaVien = yeuCauTiepNhan.NoiTruBenhAn.ThoiDiemRaVien?.ApplyFormatDate();

            if (groupChiPhiTheoThe.Count() > 2 ||
                (groupChiPhiTheoThe.All(o => o.Key != string.Empty) && groupChiPhiTheoThe.Count() > 1))
            {
                var groupNgayPhatSinhTheoThe = groupChiPhiTheoThe.Where(o => o.Key != string.Empty).Select(o => new { o.Key, o.OrderBy(j => j.NgayPhatSinh).First().NgayPhatSinh }).OrderBy(o => o.NgayPhatSinh).ToArray();
                for (int i = 0; i < groupNgayPhatSinhTheoThe.Count(); i++)
                {
                    var ngayPhatSinhTheoThe = groupNgayPhatSinhTheoThe[i];
                    var theBHYTChiTra = yeuCauTiepNhan.YeuCauTiepNhanTheBHYTs.First(o => o.MaSoThe == ngayPhatSinhTheoThe.Key);
                    var chiPhis = groupChiPhiTheoThe.FirstOrDefault(o => o.Key == ngayPhatSinhTheoThe.Key).ToList();
                    DateTime? ngayPhatSinhTiepTheo = i < groupNgayPhatSinhTheoThe.Count() - 1
                        ? groupNgayPhatSinhTheoThe[i + 1].NgayPhatSinh
                        : null;
                    chiPhis.AddRange(groupChiPhiTheoThe.FirstOrDefault(o => o.Key == string.Empty).Where(j => (i == 0 || j.NgayPhatSinh >= ngayPhatSinhTheoThe.NgayPhatSinh) && (ngayPhatSinhTiepTheo != null && j.NgayPhatSinh < ngayPhatSinhTiepTheo)).ToList());
                    var mucHuongPT = theBHYTChiTra != null && theBHYTChiTra?.MucHuong > 0 ? theBHYTChiTra?.MucHuong + "%" : string.Empty;
                    dateItemChiPhis += "<table style='width: 100 %;margin-bottom:-21px; '>" +
                                       "<tbody>" +
                                       "<tr>" +
                                       $"<td style='padding-left:-5px; width: 40 %; '>Mã thẻ BHYT {i + 1}: <b>{theBHYTChiTra.MaSoThe}</b> " +
                                       $"<span style='padding-left:20px'>Giá trị từ: <b>{theBHYTChiTra.NgayHieuLuc.ApplyFormatDate()}</b> đến <b>{theBHYTChiTra.NgayHetHan?.ApplyFormatDate()}</b></span>" +
                                       $"<span style='padding-left:20px'>Mức hưởng: <b>{mucHuongPT}</b></span></td>" +
                                       "</tr>" +

                                      //Thêm dòng: (Chi phí KCB tính từ ngày...đến ngày...) BVHD-3792
                                      "<tr>" +
                                       $"<td>" +
                                       $"<span> (Chi phí KCB tính từ ngày <b>{ngayNhapVien}</b> đến ngày <b>{ngayRaVien}</b>) </span></td>" +
                                      "</tr>" +

                                       "</tbody>" +
                                       "</table>" +
                                       "</br>" +
                                       "<table style='width:100%;border: 1px solid #020000; border-collapse: collapse;'>" +
                                            "<tr style='border: 1px solid black;  border-collapse: collapse;'>" +
                                            "<th style='border: 1px solid #020000; border-collapse: collapse;text-align: center;' rowspan='2'>" +
                                                    "STT </th>" +
                                                "<th style='border: 1px solid #020000; border-collapse: collapse;width:35%;text-align: center;' rowspan='2'>" +
                                                    "Nội dung </th>" +
                                                "<th style='border: 1px solid #020000; border-collapse: collapse;width:5%;text-align: center;' rowspan='2'>" +
                                                    "Đơn vị tính</th>" +
                                                "<th style='border: 1px solid #020000; border-collapse: collapse;width:3%; text-align: center;' rowspan='2'>" +
                                                    "Số lượng</th>" +
                                                "<th style='border: 1px solid #020000; border-collapse: collapse;width:3%; text-align: center;' rowspan='2'>" +
                                                    "Đơn giá BV <span style='font-weight: 100;'>(đồng)</span></th>" +
                                                "<th style='border: 1px solid #020000; border-collapse: collapse;width:3%; text-align: center;' rowspan='2'>" +
                                                    "Đơn giá BH  <span style='font-weight: 100;'>(đồng)</span></th>" +
                                                "<th style='border: 1px solid #020000; border-collapse: collapse;width:200px; text-align: center;'" +
                                                    "rowspan='2'>" +
                                                    "Tỉ lệ thanh toán theo dich vụ   <span style='font-weight: 100;'>(%)</span></th>" +
                                                "<th style='border: 1px solid #020000; border-collapse: collapse;width:8%;text-align: center;' rowspan='2'>" +
                                                    "Thành tiền BV  <span style='font-weight: 100;'>(đồng)</span>" +
                                                "</th>" +
                                                "<th style='border: 1px solid #020000; border-collapse: collapse;width:200px; text-align: center;'" +
                                                    "rowspan='2'>" +
                                                    "Tỷ lệ thanh toán BHYT <span style='font-weight: 100;'>(%)</span>" +
                                                "</th>" +
                                                "<th style='border: 1px solid #020000; border-collapse: collapse;width:8%;text-align: center;' rowspan='2'>" +
                                                    "Thành tiền BH  <span style='font-weight: 100;'>(đồng)</span>" +
                                                "</th>" +
                                                "<th style='border: 1px solid #020000; border-collapse: collapse;width:35%;text-align: center;' colspan='4'>" +
                                                    "Nguồn thanh toán  <span style='font-weight: 100;'>(đồng)</span></th>" +
                                            "</tr>" +
                                            "<tr style='border: 1px solid #020000; border-collapse: collapse;'>" +
                                                "<td style='border: 1px solid #020000; border-collapse: collapse;text-align: center;'><b>Quỹ BHYT</b></td>" +
                                                "<td style=' border: 1px solid #020000; border-collapse: collapse;width:80px;text-align: center;'>" +
                                                    "<b>Người bệnh cùng chi" +
                                                    " trả</b> (đồng)</td>" +
                                                "<td style=' border: 1px solid #020000; border-collapse: collapse;text-align: center;'><b>Khác</b> (đồng)</td>" +
                                                "<td style='border: 1px solid #020000; border-collapse: collapse;text-align: center;width: 90px;'>" +
                                                    "<b>Người bệnh" +
                                                    "tự trả </b>(đồng)" +
                                                "</td>" +
                                            "</tr>" +
                                            "<tr style=' border: 1px solid #020000; '>" +
                                              "<td style='border: 1px solid #020000;text-align: center;'><b> </b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(1)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(2)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(3)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(4)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(5)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(6)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(7)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(8)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(9)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(10)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(11)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(12)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(13)</b> </td>" +
                                            "</tr>";


                    var dsChiPhiBangKeTheoThe = new List<BangKeKhamBenhCoBHYTVo>();
                    foreach (var chiPhi in chiPhis.Where(c => c.NhomChiPhiBangKe != NhomChiPhiBangKe.GoiVatTu).GroupBy(c => new { c.NhomChiPhiBangKe, c.TenDichVu, c.DonViTinh, c.DuocHuongBHYT, c.DonGia, c.DonGiaBHYT, c.MucHuongBaoHiem, c.TiLeBaoHiemThanhToan }).OrderByDescending(o => o.Key.DuocHuongBHYT))
                    {
                        dsChiPhiBangKeTheoThe.Add(new BangKeKhamBenhCoBHYTVo
                        {
                            Nhom = chiPhi.Key.NhomChiPhiBangKe,
                            Id = chiPhi.FirstOrDefault().Id,
                            NoiDung = chiPhi.Key.TenDichVu,
                            DonViTinh = chiPhi.Key.DonViTinh,
                            SoLuong = (decimal)chiPhi.Sum(c => c.Soluong),
                            DuocHuongBaoHiem = chiPhi.Key.DuocHuongBHYT,
                            DonGiaBH = chiPhi.Key.DonGiaBHYT,
                            DonGiaTheoBV = chiPhi.Key.DonGia,
                            MucHuongBaoHiem = chiPhi.Key.MucHuongBaoHiem,
                            TiLeThanhToanTheoDV = chiPhi.Key.TiLeBaoHiemThanhToan,
                            BaoHiemChiTra = true
                        });
                    }

                    foreach (var chiPhi in chiPhis.Where(c => c.NhomChiPhiBangKe == NhomChiPhiBangKe.GoiVatTu).OrderByDescending(o => o.DuocHuongBHYT))
                    {
                        dsChiPhiBangKeTheoThe.Add(new BangKeKhamBenhCoBHYTVo
                        {
                            Nhom = chiPhi.NhomChiPhiBangKe,
                            Id = chiPhi.Id,
                            NoiDung = chiPhi.TenDichVu,
                            DonViTinh = chiPhi.DonViTinh,
                            SoLuong = (decimal)chiPhi.Soluong,
                            DuocHuongBaoHiem = chiPhi.DuocHuongBHYT,
                            DonGiaBH = chiPhi.DonGiaBHYT,
                            DonGiaTheoBV = chiPhi.DonGia,
                            MucHuongBaoHiem = chiPhi.MucHuongBaoHiem,
                            TiLeThanhToanTheoDV = chiPhi.TiLeBaoHiemThanhToan,
                            BaoHiemChiTra = true
                        });
                    }
                    dsChiPhiBangKe.AddRange(dsChiPhiBangKeTheoThe);
                    var groupChiPhiBangKes = dsChiPhiBangKeTheoThe.GroupBy(x => x.Nhom).OrderBy(o => (int)o.Key * (o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay || o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriNoiTru ? 1 : 10));
                    foreach (var groupChiPhiBangKe in groupChiPhiBangKes)
                    {
                        if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay)
                        {

                            dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                               "<td style='border: 1px solid #020000;' colspan='7'>" +
                                               "<span style='float:left;'><b>2. Ngày giường:  </b></span>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                               "</tr>";
                            dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                               "<td style='border: 1px solid #020000;' colspan='7'>" +
                                               "<span style='float:left;'><b>2.1." + groupChiPhiBangKe.Key.GetDescription() + "  </b></span>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b> " + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true) + "</b> </td>" +
                                               "</tr>";
                        }
                        else if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.NgayGiuongDieuTriNoiTru)
                        {
                            if (!groupChiPhiBangKes.Any(o => o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay))
                            {
                                dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                                   "<td style='border: 1px solid #020000;' colspan='7'>" +
                                                   "<span style='float:left;'><b>2. Ngày giường:  </b></span>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                   "</tr>";
                            }
                            dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                               "<td style='border: 1px solid #020000;' colspan='7'>" +
                                               "<span style='float:left;'><b>2.2." + groupChiPhiBangKe.Key.GetDescription() + "  </b></span>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b> " + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true) + "</b> </td>" +
                                               "</tr>";
                        }
                        else
                        {
                            dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                               "<td style='border: 1px solid #020000;' colspan='7'>" +
                                               "<span style='float:left;'><b>" + (int)groupChiPhiBangKe.Key + "." + groupChiPhiBangKe.Key.GetDescription() + "  </b></span>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b> " + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true) + "</b> </td>" +
                                               "</tr>";
                        }
                        if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.GoiVatTu)
                        {
                            var groupGoiVatTus = groupChiPhiBangKe.ToList().GroupBy(o => o.SoGoiVatTu.GetValueOrDefault()).OrderBy(o => o.Key);
                            int sttGoiVatTu = 1;
                            foreach (var groupGoiVatTu in groupGoiVatTus)
                            {
                                dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                                   "<td style='border: 1px solid #020000;' colspan='7'>" +
                                                   "<span style='float:left;'><b>10." + sttGoiVatTu + ". " + groupChiPhiBangKe.Key.GetDescription() + " " + sttGoiVatTu + "  </b></span>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.Khac)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'><b> " + Convert.ToDouble(groupGoiVatTu.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true) + "</b> </td>" +
                                                   "</tr>";
                                foreach (var chiPhiBangKe in groupGoiVatTu)
                                {
                                    dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                                    "<td style='border: 1px solid #020000; text-align: center;'> " + indexItem + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: left;'> " + chiPhiBangKe.NoiDung + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: center;'>  " + chiPhiBangKe.DonViTinh + " </td>" +
                                                    "<td style='border: 1px solid #020000;text-align: center;'> " + chiPhiBangKe.SoLuong + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: center;'> " + Convert.ToDouble(chiPhiBangKe.DonGiaBV).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: center;'> " + Convert.ToDouble(chiPhiBangKe.DonGiaBH).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.TiLeThanhToanTheoDV).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.ThanhTienBV).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.MucHuongBaoHiem > 0 ? 100 : 0).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.ThanhTienBH).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.QuyBHYT).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.NguoiBenhCungChiTra).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.Khac).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.NguoiBenhTuTra).ApplyFormatMoneyToDouble(true) + "</td>" +
                                                    "</tr>";
                                    indexItem++;
                                }
                            }
                        }
                        else
                        {
                            foreach (var chiPhiBangKe in groupChiPhiBangKe)
                            {
                                dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                                "<td style='border: 1px solid #020000; text-align: center;'> " + indexItem + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: left;'> " + chiPhiBangKe.NoiDung + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'>  " + chiPhiBangKe.DonViTinh + " </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'> " + chiPhiBangKe.SoLuong + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'> " + Convert.ToDouble(chiPhiBangKe.DonGiaBV).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'> " + Convert.ToDouble(chiPhiBangKe.DonGiaBH).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.TiLeThanhToanTheoDV).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.ThanhTienBV).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.MucHuongBaoHiem > 0 ? 100 : 0).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.ThanhTienBH).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.QuyBHYT).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.NguoiBenhCungChiTra).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.Khac).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.NguoiBenhTuTra).ApplyFormatMoneyToDouble(true) + "</td>" +
                                                "</tr>";
                                indexItem++;
                            }
                        }

                    }

                    dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                       "<td style='border: 1px solid #020000;' colspan='7'></span>" +
                                       "<span style='float:right;padding-right: 50px;'><b>Tổng Cộng</b></span>" +
                                       "</td>" +
                                       $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKeTheoThe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                       $"<td style='border: 1px solid #020000;text-align: right;'><b></b> </td>" +
                                       $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKeTheoThe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                       $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKeTheoThe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                       $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKeTheoThe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                       $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKeTheoThe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                       $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKeTheoThe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true)}</b> </td>" +
                                       "</tr>" +
                                       "</table>";
                }
            }
            else
            {
                YeuCauTiepNhanTheBHYT theBHYTChiTra = null;
                var maSoThe = groupChiPhiTheoThe.Where(o => o.Key != string.Empty).FirstOrDefault()?.Key;
                if (!string.IsNullOrEmpty(maSoThe))
                {
                    theBHYTChiTra = yeuCauTiepNhan.YeuCauTiepNhanTheBHYTs.First(o => o.MaSoThe == maSoThe);
                }

                var chiPhis = groupChiPhiTheoThe.SelectMany(o => o).ToList();
                var mucHuongPT = theBHYTChiTra != null && theBHYTChiTra?.MucHuong > 0 ? theBHYTChiTra?.MucHuong + "%" : string.Empty;

                dateItemChiPhis += "<table style='width: 100 %;margin-bottom:-21px; '>" +
                                    "<tbody>" +
                                     "<tr>" +
                                       $"<td style='padding-left: -5px; width: 40 %; '>Mã thẻ BHYT: <b>{theBHYTChiTra?.MaSoThe}</b> " +
                                       $"<span style='padding-left:20px'>Giá trị từ: <b>{theBHYTChiTra?.NgayHieuLuc.ApplyFormatDate()}</b> đến <b>{theBHYTChiTra?.NgayHetHan?.ApplyFormatDate()}</b></span>" +
                                       $"<span style='padding-left:20px'>Mức hưởng: <b>{mucHuongPT}</b></span></td>" +
                                     "</tr>" +
                                      //Thêm dòng: (Chi phí KCB tính từ ngày...đến ngày...) BVHD-3792
                                      "<tr>" +
                                       $"<td>" +
                                       $"<span> (Chi phí KCB tính từ ngày <b>{ngayNhapVien}</b> đến ngày <b>{ngayRaVien}</b>) </span></td>" +
                                      "</tr>" +

                                    "</tbody>" +
                                    "</table>" +
                                    "</br>" +
                                    "<table style='width:100%;border: 1px solid #020000; border-collapse: collapse;'>" +
                                        "<tr style='border: 1px solid black;  border-collapse: collapse;'>" +
                                        "<th style='border: 1px solid #020000; border-collapse: collapse;text-align: center;' rowspan='2'>" +
                                                "STT </th>" +
                                            "<th style='border: 1px solid #020000; border-collapse: collapse;width:35%;text-align: center;' rowspan='2'>" +
                                                "Nội dung </th>" +
                                            "<th style='border: 1px solid #020000; border-collapse: collapse;width:5%;text-align: center;' rowspan='2'>" +
                                                "Đơn vị tính</th>" +
                                            "<th style='border: 1px solid #020000; border-collapse: collapse;width:3%; text-align: center;' rowspan='2'>" +
                                                "Số lượng</th>" +
                                            "<th style='border: 1px solid #020000; border-collapse: collapse;width:3%; text-align: center;' rowspan='2'>" +
                                                "Đơn giá BV <span style='font-weight: 100;'>(đồng)</span></th>" +
                                            "<th style='border: 1px solid #020000; border-collapse: collapse;width:3%; text-align: center;' rowspan='2'>" +
                                                "Đơn giá BH  <span style='font-weight: 100;'>(đồng)</span></th>" +
                                            "<th style='border: 1px solid #020000; border-collapse: collapse;width:200px; text-align: center;'" +
                                                "rowspan='2'>" +
                                                "Tỉ lệ thanh toán theo dich vụ   <span style='font-weight: 100;'>(%)</span></th>" +
                                            "<th style='border: 1px solid #020000; border-collapse: collapse;width:8%;text-align: center;' rowspan='2'>" +
                                                "Thành tiền BV  <span style='font-weight: 100;'>(đồng)</span>" +
                                            "</th>" +
                                            "<th style='border: 1px solid #020000; border-collapse: collapse;width:200px; text-align: center;'" +
                                                "rowspan='2'>" +
                                                "Tỷ lệ thanh toán BHYT <span style='font-weight: 100;'>(%)</span>" +
                                            "</th>" +
                                            "<th style='border: 1px solid #020000; border-collapse: collapse;width:8%;text-align: center;' rowspan='2'>" +
                                                "Thành tiền BH  <span style='font-weight: 100;'>(đồng)</span>" +
                                            "</th>" +
                                            "<th style='border: 1px solid #020000; border-collapse: collapse;width:35%;text-align: center;' colspan='4'>" +
                                                "Nguồn thanh toán  <span style='font-weight: 100;'>(đồng)</span></th>" +
                                        "</tr>" +
                                        "<tr style='border: 1px solid #020000; border-collapse: collapse;'>" +
                                            "<td style='border: 1px solid #020000; border-collapse: collapse;text-align: center;'><b>Quỹ BHYT</b></td>" +
                                            "<td style=' border: 1px solid #020000; border-collapse: collapse;width:80px;text-align: center;'>" +
                                                "<b>Người bệnh cùng chi" +
                                                " trả</b> (đồng)</td>" +
                                            "<td style=' border: 1px solid #020000; border-collapse: collapse;text-align: center;'><b>Khác</b> (đồng)</td>" +
                                            "<td style='border: 1px solid #020000; border-collapse: collapse;text-align: center;width: 90px;'>" +
                                                "<b>Người bệnh" +
                                                "tự trả </b>(đồng)" +
                                            "</td>" +
                                        "</tr>" +
                                        "<tr style=' border: 1px solid #020000; '>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b> </b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b>(1)</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b>(2)</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b>(3)</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b>(4)</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b>(5)</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b>(6)</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b>(7)</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b>(8)</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b>(9)</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b>(10)</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b>(11)</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b>(12)</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b>(13)</b> </td>" +
                                        "</tr>";


                foreach (var chiPhi in chiPhis.Where(c => c.NhomChiPhiBangKe != NhomChiPhiBangKe.GoiVatTu).GroupBy(c => new { c.NhomChiPhiBangKe, c.TenDichVu, c.DonViTinh, c.DuocHuongBHYT, c.DonGia, c.DonGiaBHYT, c.MucHuongBaoHiem, c.TiLeBaoHiemThanhToan }).OrderByDescending(o => o.Key.DuocHuongBHYT))
                {
                    dsChiPhiBangKe.Add(new BangKeKhamBenhCoBHYTVo
                    {
                        Nhom = chiPhi.Key.NhomChiPhiBangKe,
                        Id = chiPhi.FirstOrDefault().Id,
                        NoiDung = chiPhi.Key.TenDichVu,
                        DonViTinh = chiPhi.Key.DonViTinh,
                        SoLuong = (decimal)chiPhi.Sum(c => c.Soluong),
                        DuocHuongBaoHiem = chiPhi.Key.DuocHuongBHYT,
                        DonGiaBH = chiPhi.Key.DonGiaBHYT,
                        DonGiaTheoBV = chiPhi.Key.DonGia,
                        MucHuongBaoHiem = chiPhi.Key.MucHuongBaoHiem,
                        TiLeThanhToanTheoDV = chiPhi.Key.TiLeBaoHiemThanhToan,
                        BaoHiemChiTra = true
                    });
                }

                foreach (var chiPhi in chiPhis.Where(c => c.NhomChiPhiBangKe == NhomChiPhiBangKe.GoiVatTu).OrderByDescending(o => o.DuocHuongBHYT))
                {
                    dsChiPhiBangKe.Add(new BangKeKhamBenhCoBHYTVo
                    {
                        Nhom = chiPhi.NhomChiPhiBangKe,
                        Id = chiPhi.Id,
                        NoiDung = chiPhi.TenDichVu,
                        DonViTinh = chiPhi.DonViTinh,
                        SoLuong = (decimal)chiPhi.Soluong,
                        DuocHuongBaoHiem = chiPhi.DuocHuongBHYT,
                        DonGiaBH = chiPhi.DonGiaBHYT,
                        DonGiaTheoBV = chiPhi.DonGia,
                        MucHuongBaoHiem = chiPhi.MucHuongBaoHiem,
                        TiLeThanhToanTheoDV = chiPhi.TiLeBaoHiemThanhToan,
                        BaoHiemChiTra = true
                    });
                }
                var groupChiPhiBangKes = dsChiPhiBangKe.GroupBy(x => x.Nhom).OrderBy(o => (int)o.Key * (o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay || o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriNoiTru ? 1 : 10));
                foreach (var groupChiPhiBangKe in groupChiPhiBangKes)
                {
                    if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay)
                    {

                        dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                            "<td style='border: 1px solid #020000;' colspan='7'>" +
                                            "<span style='float:left;'><b>2. Ngày giường:  </b></span>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                            "</tr>";
                        dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                            "<td style='border: 1px solid #020000;' colspan='7'>" +
                                            "<span style='float:left;'><b>2.1." + groupChiPhiBangKe.Key.GetDescription() + "  </b></span>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b> " + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true) + "</b> </td>" +
                                            "</tr>";
                    }
                    else if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.NgayGiuongDieuTriNoiTru)
                    {
                        if (!groupChiPhiBangKes.Any(o => o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay))
                        {
                            dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                                "<td style='border: 1px solid #020000;' colspan='7'>" +
                                                "<span style='float:left;'><b>2. Ngày giường:  </b></span>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                "</tr>";
                        }
                        dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                            "<td style='border: 1px solid #020000;' colspan='7'>" +
                                            "<span style='float:left;'><b>2.2." + groupChiPhiBangKe.Key.GetDescription() + "  </b></span>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b> " + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true) + "</b> </td>" +
                                            "</tr>";
                    }
                    else
                    {
                        dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                            "<td style='border: 1px solid #020000;' colspan='7'>" +
                                            "<span style='float:left;'><b>" + (int)groupChiPhiBangKe.Key + "." + groupChiPhiBangKe.Key.GetDescription() + "  </b></span>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b> " + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true) + "</b> </td>" +
                                            "</tr>";
                    }
                    if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.GoiVatTu)
                    {
                        var groupGoiVatTus = groupChiPhiBangKe.ToList().GroupBy(o => o.SoGoiVatTu.GetValueOrDefault()).OrderBy(o => o.Key);
                        int sttGoiVatTu = 1;
                        foreach (var groupGoiVatTu in groupGoiVatTus)
                        {
                            dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                                "<td style='border: 1px solid #020000;' colspan='7'>" +
                                                "<span style='float:left;'><b>10." + sttGoiVatTu + ". " + groupChiPhiBangKe.Key.GetDescription() + " " + sttGoiVatTu + "  </b></span>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.Khac)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'><b> " + Convert.ToDouble(groupGoiVatTu.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true) + "</b> </td>" +
                                                "</tr>";
                            foreach (var chiPhiBangKe in groupGoiVatTu)
                            {
                                dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                                "<td style='border: 1px solid #020000; text-align: center;'> " + indexItem + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: left;'> " + chiPhiBangKe.NoiDung + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'>  " + chiPhiBangKe.DonViTinh + " </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'> " + chiPhiBangKe.SoLuong + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'> " + Convert.ToDouble(chiPhiBangKe.DonGiaBV).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'> " + Convert.ToDouble(chiPhiBangKe.DonGiaBH).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.TiLeThanhToanTheoDV).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.ThanhTienBV).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.MucHuongBaoHiem > 0 ? 100 : 0).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.ThanhTienBH).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.QuyBHYT).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.NguoiBenhCungChiTra).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.Khac).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.NguoiBenhTuTra).ApplyFormatMoneyToDouble(true) + "</td>" +
                                                "</tr>";
                                indexItem++;
                            }
                        }
                    }
                    else
                    {
                        foreach (var chiPhiBangKe in groupChiPhiBangKe)
                        {
                            dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                            "<td style='border: 1px solid #020000; text-align: center;'> " + indexItem + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: left;'> " + chiPhiBangKe.NoiDung + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'>  " + chiPhiBangKe.DonViTinh + " </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'> " + chiPhiBangKe.SoLuong + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'> " + Convert.ToDouble(chiPhiBangKe.DonGiaBV).ApplyFormatMoneyToDouble() + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'> " + Convert.ToDouble(chiPhiBangKe.DonGiaBH).ApplyFormatMoneyToDouble() + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.TiLeThanhToanTheoDV).ApplyFormatMoneyToDouble() + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.ThanhTienBV).ApplyFormatMoneyToDouble() + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.MucHuongBaoHiem > 0 ? 100 : 0).ApplyFormatMoneyToDouble() + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.ThanhTienBH).ApplyFormatMoneyToDouble() + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.QuyBHYT).ApplyFormatMoneyToDouble() + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.NguoiBenhCungChiTra).ApplyFormatMoneyToDouble() + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.Khac).ApplyFormatMoneyToDouble() + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.NguoiBenhTuTra).ApplyFormatMoneyToDouble(true) + "</td>" +
                                            "</tr>";
                            indexItem++;
                        }
                    }

                }

                dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                    "<td style='border: 1px solid #020000;' colspan='7'></span>" +
                                    "<span style='float:right;padding-right: 50px;'><b>Tổng Cộng</b></span>" +
                                    "</td>" +
                                    $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                    $"<td style='border: 1px solid #020000;text-align: right;'><b></b> </td>" +
                                    $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                    $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                    $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                    $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                    $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true)}</b> </td>" +
                                    "</tr>" +
                                    "</table>";

            }

            var checkedLyDoVaoVien = "<input id='demo_box_2' class='css - checkbox' type='checkbox' checked  disabled='true'/>";
            var unCheckedLyDoVaoVien = "<input id='demo_box_2' class='css - checkbox' type='checkbox' disabled='true' />";

            var khoaPhong = yeuCauTiepNhan.NoiTruBenhAn?.NoiTruKhoaPhongDieuTris.OrderByDescending(c => c.ThoiDiemVaoKhoa).Select(c => c.KhoaPhongChuyenDen).FirstOrDefault();
            var chuyenKhoa = GetChuyenKhoa(khoaPhong?.Id); //BVHD-3792 

            var data = new
            {
                TitleBangKe = "ĐIỀU TRỊ NỘI TRÚ",
                SoBangKe = "3",
                yeuCauTiepNhan.BenhNhan.MaBN,
                MaTN = yeuCauTiepNhan.MaYeuCauTiepNhan,
                SoBenhAn = "Số bệnh án: " + yeuCauTiepNhan.NoiTruBenhAn?.SoBenhAn,
                yeuCauTiepNhan.HoTen,
                DiaChi = yeuCauTiepNhan.DiaChiDayDu,
                BarCodeImgBase64 = !string.IsNullOrEmpty(yeuCauTiepNhan.MaYeuCauTiepNhan) ? BarcodeHelper.GenerateBarCode(yeuCauTiepNhan.MaYeuCauTiepNhan) : "",
                NamSinh = DateHelper.DOBFormat(yeuCauTiepNhan.NgaySinh, yeuCauTiepNhan.ThangSinh, yeuCauTiepNhan.NamSinh),
                GioiTinh = yeuCauTiepNhan.GioiTinh != null ? yeuCauTiepNhan.GioiTinh.GetDescription() : "",
                //TenKhoa = "Khoa: " + yeuCauTiepNhan.NoiTruBenhAn?.KhoaPhongNhapVien?.Ten,
                //MaKhoa = "Mã khoa: " + yeuCauTiepNhan.NoiTruBenhAn?.KhoaPhongNhapVien?.Ma,

                TenKhoa = "Khoa: " + khoaPhong.Ten,
                MaKhoa = "Mã khoa: " + chuyenKhoa?.Ma,

                MaBHYT = theBHYT?.MaSoThe,
                BHYTTuNgay = bHYTTuNgay,
                BHYTDenNgay = bHYTDenNgay,
                NoiDKKCBBanDau,
                MaKCBBanDau,
                NgayDenKham = yeuCauTiepNhan.YeuCauNhapVien?.YeuCauKhamBenh?.YeuCauTiepNhan.ThoiDiemTiepNhan.ApplyFormatGioPhutNgay(),
                DieuTriKNT = yeuCauTiepNhan.NoiTruBenhAn?.ThoiDiemNhapVien.ApplyFormatGioPhutNgay(),
                KetThucKhamNgoaiTru = yeuCauTiepNhan.NoiTruBenhAn?.ThoiDiemRaVien?.ApplyFormatGioPhutNgay(),
                SoNgayDTri = NoiTruBenhAnHelper.TinhSoNgayDieuTri(yeuCauTiepNhan.NoiTruBenhAn)?.ToString() ?? string.Empty,//yeuCauTiepNhan.NoiTruBenhAn?.ThoiDiemRaVien == null ? "" : (yeuCauTiepNhan.NoiTruBenhAn.ThoiDiemRaVien.Value.Date.AddDays(1) - yeuCauTiepNhan.NoiTruBenhAn.ThoiDiemNhapVien.Date).Days.ToString(),
                TinhTrangRaVien = yeuCauTiepNhan.NoiTruBenhAn?.TinhTrangRaVien == EnumTinhTrangRaVien.RaVien && (yeuCauTiepNhan.NoiTruBenhAn?.KetQuaDieuTri == EnumKetQuaDieuTri.Do || yeuCauTiepNhan.NoiTruBenhAn?.KetQuaDieuTri == EnumKetQuaDieuTri.Khoi) ? 1 : 2,
                MucHuong = mucHuong,
                NoiChuyenDen = yeuCauTiepNhan.NoiChuyen?.Ten,
                NoiChuyenDi = yeuCauTiepNhan.NoiTruBenhAn?.ChuyenDenBenhVien?.Ten,
                MKV = theBHYT?.MaKhuVuc,
                NgayMiemCungTC = theBHYT?.NgayDuocMienCungChiTra?.ApplyFormatDate(),
                ThoiGian5Nam = theBHYT?.NgayDu5Nam?.ApplyFormatDate(),
                CoCapCuu = yeuCauTiepNhan.LyDoVaoVien == Enums.EnumLyDoVaoVien.CapCuu ? checkedLyDoVaoVien : unCheckedLyDoVaoVien,
                CoDungTuyen = yeuCauTiepNhan.LyDoVaoVien == Enums.EnumLyDoVaoVien.DungTuyen ? checkedLyDoVaoVien : unCheckedLyDoVaoVien,
                CoThongTuyen = yeuCauTiepNhan.LyDoVaoVien == Enums.EnumLyDoVaoVien.ThongTuyen ? checkedLyDoVaoVien : unCheckedLyDoVaoVien,
                CoTraiTuyen = yeuCauTiepNhan.LyDoVaoVien == Enums.EnumLyDoVaoVien.TraiTuyen ? checkedLyDoVaoVien : unCheckedLyDoVaoVien,

                ChuanDoanXacDinh = yeuCauTiepNhan.NoiTruBenhAn?.LoaiBenhAn == LoaiBenhAn.SanKhoaMo || yeuCauTiepNhan.NoiTruBenhAn?.LoaiBenhAn == LoaiBenhAn.SanKhoaThuong
                                                              ? chuanDoanXacDinhSanKhoa : yeuCauTiepNhan.NoiTruBenhAn?.ChanDoanChinhRaVienGhiChu,
                MaICD10 = yeuCauTiepNhan.NoiTruBenhAn?.LoaiBenhAn == LoaiBenhAn.SanKhoaMo || yeuCauTiepNhan.NoiTruBenhAn?.LoaiBenhAn == LoaiBenhAn.SanKhoaThuong
                                                              ? maICD10 : yeuCauTiepNhan.NoiTruBenhAn?.ChanDoanChinhRaVienICD?.Ma,

                BenhKemTheo = tenICDKemTheo,
                ICDKemTheo10 = maICDKemTheo,

                DateItemChiPhis = dateItemChiPhis,

                TTDV = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble(),
                TTTTBHYT = "",

                TTTienBH = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble(),
                TQBHYT = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble(),
                TNCCTra = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble(),
                TongSoKhac = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble(),
                TNBTuTra = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true),

                TongChiPhi = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble(),
                SoTienBangChu = NumberHelper.ChuyenSoRaText(Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBH))),

                NguoiBenhPhaiTra = (Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)) + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhTuTra))).ApplyFormatMoneyToDouble(),

                TTQuyTT = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble(),
                BHYTChiTra = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble(),
                CacKhoanTraKhac = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true),
                SoTienKhac = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble(),
                NgayHienTai = DateTime.Now.ApplyFormatNgayThangNam(),
                Notice = "<div style='color: red; font-weight:800; margin-top:200px;'>Lưu ý : Người bệnh chưa quyết toán </div>"
            };

            var content = TemplateHelpper.FormatTemplateWithContentTemplate(result?.Body, data);
            return content;
        }
        public string GetHtmlBangKeChuaQuyetToan(long yeuCauTiepNhanId, string hostingName)
        {
            //var danhSachChiPhi = GetDanhSachChiPhiNoiTruChuaThu(yeuCauTiepNhanId).Result;
            var danhSachChiPhi = GetTatCaDichVuKhamChuaBenh(yeuCauTiepNhanId).Result.Where(o => !o.Soluong.AlmostEqual(0) && o.YeuCauGoiDichVuId == null).ToList();
            if (danhSachChiPhi.Count == 0)
            {
                return string.Empty;
            }
            var yeuCauTiepNhan = BaseRepository.GetById(yeuCauTiepNhanId,
                x => x.Include(o => o.NoiTruBenhAn).ThenInclude(o => o.ChuyenDenBenhVien)
                    .Include(o => o.NoiTruBenhAn).ThenInclude(o => o.KhoaPhongNhapVien)
                    .Include(o => o.NoiTruBenhAn).ThenInclude(o => o.ChanDoanChinhRaVienICD)
                    .Include(o => o.YeuCauTiepNhanTheBHYTs)
                    .Include(o => o.YeuCauNhapVien).ThenInclude(o => o.YeuCauKhamBenh).ThenInclude(o => o.YeuCauTiepNhan)
                    .Include(o => o.BenhNhan)
                    .Include(o => o.PhuongXa)
                    .Include(o => o.QuanHuyen)
                    .Include(o => o.TinhThanh)
                    .Include(o => o.NoiTruBenhAn).ThenInclude(o => o.NoiTruPhieuDieuTris).ThenInclude(o => o.NoiTruThamKhamChanDoanKemTheos).ThenInclude(c => c.ICD)
                    .Include(o => o.NoiTruBenhAn).ThenInclude(o => o.NoiTruPhieuDieuTris).ThenInclude(c => c.ChanDoanChinhICD)
                    .Include(o => o.NoiChuyen).Include(o => o.NoiTruBenhAn).ThenInclude(o => o.NoiTruKhoaPhongDieuTris).ThenInclude(c => c.KhoaPhongChuyenDen));

            var result = _templateRepository.TableNoTracking.FirstOrDefault(x => x.Name.Equals("BangKeKhamBenhBHYTVaBenhVien"));

            var benhVien = new Core.Domain.Entities.BenhVien.BenhVien();

            string maBHYT = string.Empty;
            string bHYTTuNgay = string.Empty;
            string bHYTDenNgay = string.Empty;
            string mucHuong = string.Empty;
            string NoiDKKCBBanDau = string.Empty;
            string MaKCBBanDau = string.Empty;


            string maICDKemTheo = string.Empty;
            string tenICDKemTheo = string.Empty;
            string chuanDoanXacDinhSanKhoa = string.Empty;
            string maICD10 = string.Empty;

            if (yeuCauTiepNhan.NoiTruBenhAn != null && (yeuCauTiepNhan.NoiTruBenhAn.LoaiBenhAn == LoaiBenhAn.SanKhoaMo || yeuCauTiepNhan.NoiTruBenhAn.LoaiBenhAn == LoaiBenhAn.SanKhoaThuong))
            {
                if (yeuCauTiepNhan.NoiTruBenhAn?.NoiTruPhieuDieuTris.Count() > 0)
                {
                    var phieuDieuTri = yeuCauTiepNhan.NoiTruBenhAn?.NoiTruPhieuDieuTris.OrderByDescending(c => c.NgayDieuTri).FirstOrDefault();

                    var icdKemTheoIds = phieuDieuTri.NoiTruThamKhamChanDoanKemTheos.Select(c => c.ICD.Ma);
                    var tenICDKemTheos = phieuDieuTri.NoiTruThamKhamChanDoanKemTheos.Select(c => c.GhiChu);

                    maICDKemTheo = string.Join(", ", icdKemTheoIds);
                    tenICDKemTheo = string.Join(", ", tenICDKemTheos);

                    maICD10 = phieuDieuTri.ChanDoanChinhICD?.Ma;
                    chuanDoanXacDinhSanKhoa = phieuDieuTri.ChanDoanChinhGhiChu;
                }
            }
            else
            {
                if (!string.IsNullOrEmpty(yeuCauTiepNhan.NoiTruBenhAn?.DanhSachChanDoanKemTheoRaVienICDId))
                {
                    var maICDKemTheos = new List<string>();

                    var icdKemTheoIds = yeuCauTiepNhan.NoiTruBenhAn?.DanhSachChanDoanKemTheoRaVienICDId.Split(Constants.ICDSeparator);
                    var tenICDKemTheos = yeuCauTiepNhan.NoiTruBenhAn?.DanhSachChanDoanKemTheoRaVienGhiChu?.Split(Constants.ICDSeparator);

                    if (icdKemTheoIds.Length > 0)
                    {
                        foreach (var icdKemTheoId in icdKemTheoIds)
                        {
                            var icdKemTheo = _icdRepository.TableNoTracking.FirstOrDefault(o => o.Id == long.Parse(icdKemTheoId));
                            if (icdKemTheo != null)
                            {
                                maICDKemTheos.Add(icdKemTheo.Ma);
                            }

                            //if (long.TryParse(yeuCauTiepNhan.NoiTruBenhAn?.DanhSachChanDoanKemTheoRaVienICDId.Split(Constants.ICDSeparator).First(), out var icdKemTheoId))
                            //{
                            //    var icdKemTheo = _icdRepository.TableNoTracking.FirstOrDefault(o => o.Id == icdKemTheoId);
                            //    if (icdKemTheo != null)
                            //    {
                            //        maICDKemTheo = icdKemTheo.Ma;
                            //        tenICDKemTheo = yeuCauTiepNhan.NoiTruBenhAn?.DanhSachChanDoanKemTheoRaVienGhiChu?.Split(Constants.ICDSeparator).First();
                            //    }
                            //}
                        }
                    }

                    maICDKemTheo = string.Join(", ", maICDKemTheos);
                    tenICDKemTheo = string.Join(", ", tenICDKemTheos);
                }
            }

            YeuCauTiepNhanTheBHYT theBHYT = null;
            if (yeuCauTiepNhan.CoBHYT == true && yeuCauTiepNhan.YeuCauTiepNhanTheBHYTs.Any())
            {
                theBHYT = yeuCauTiepNhan.YeuCauTiepNhanTheBHYTs.First();
                if (!String.IsNullOrEmpty(theBHYT.MaDKBD))
                {
                    benhVien = _benhVienRepository.TableNoTracking.FirstOrDefault(p => p.Ma.Equals(theBHYT.MaDKBD));
                }
                maBHYT = theBHYT.MaSoThe;
                bHYTTuNgay = theBHYT.NgayHieuLuc.ApplyFormatDate();
                bHYTDenNgay = theBHYT.NgayHetHan?.ApplyFormatDate();
                mucHuong = theBHYT.MucHuong.ToString() + "%";
                NoiDKKCBBanDau = benhVien != null ? benhVien?.Ten : "Chưa xác định";
                MaKCBBanDau = theBHYT.MaDKBD;
            }
            else
            {
                maBHYT = "";
                bHYTTuNgay = "";
                bHYTDenNgay = "";
                mucHuong = "0%";
                NoiDKKCBBanDau = "Chưa xác định";
                MaKCBBanDau = "Chưa xác định";
            }

            var dsChiPhiBangKe = new List<BangKeKhamBenhBenhVienVo>();
            var dateItemChiPhis = string.Empty;
            int indexItem = 1;
            var groupChiPhiTheoThe = danhSachChiPhi.GroupBy(o => o.MaSoTheBHYT);
            if (groupChiPhiTheoThe.Count() > 2 ||
                (groupChiPhiTheoThe.All(o => o.Key != string.Empty) && groupChiPhiTheoThe.Count() > 1))
            {
                var groupNgayPhatSinhTheoThe = groupChiPhiTheoThe.Where(o => o.Key != string.Empty).Select(o => new { o.Key, o.OrderBy(j => j.NgayPhatSinh).First().NgayPhatSinh }).OrderBy(o => o.NgayPhatSinh).ToArray();
                for (int i = 0; i < groupNgayPhatSinhTheoThe.Count(); i++)
                {
                    var ngayPhatSinhTheoThe = groupNgayPhatSinhTheoThe[i];
                    var theBHYTChiTra = yeuCauTiepNhan.YeuCauTiepNhanTheBHYTs.First(o => o.MaSoThe == ngayPhatSinhTheoThe.Key);
                    var chiPhis = groupChiPhiTheoThe.FirstOrDefault(o => o.Key == ngayPhatSinhTheoThe.Key).ToList();
                    DateTime? ngayPhatSinhTiepTheo = i < groupNgayPhatSinhTheoThe.Count() - 1
                        ? groupNgayPhatSinhTheoThe[i + 1].NgayPhatSinh
                        : null;
                    chiPhis.AddRange(groupChiPhiTheoThe.FirstOrDefault(o => o.Key == string.Empty).Where(j => (i == 0 || j.NgayPhatSinh >= ngayPhatSinhTheoThe.NgayPhatSinh) && (ngayPhatSinhTiepTheo != null && j.NgayPhatSinh < ngayPhatSinhTiepTheo)).ToList());
                    var mucHuongPT = theBHYTChiTra != null && theBHYTChiTra.MucHuong > 0 ? theBHYTChiTra?.MucHuong + "%" : string.Empty;

                    dateItemChiPhis += "<table style='width: 100 %; '>" +
                                       "<tbody>" +
                                       "<tr>" +
                                       $"<td style='padding-left:-5px; width: 40 %; '>Mã thẻ BHYT {i + 1}: <b>{theBHYTChiTra.MaSoThe}</b> " +
                                       $"<span style='padding-left:20px'>Giá trị từ: <b>{theBHYTChiTra.NgayHieuLuc.ApplyFormatDate()}</b> đến <b>{theBHYTChiTra.NgayHetHan?.ApplyFormatDate()}</b></span>" +
                                       $"<span style='padding-left:20px'>Mức hưởng: <b>{mucHuongPT}</b></span></td>" +
                                       "</tr>" +
                                       "</tbody>" +
                                       "</table>" +
                                       "</br>" +
                                       "<table style='width:100%;border: 1px solid #020000; border-collapse: collapse;'>" +
                                            "<tr style='border: 1px solid black;  border-collapse: collapse;'>" +
                                            "<th style='border: 1px solid #020000; border-collapse: collapse;text-align: center;' rowspan='2'>" +
                                                    "STT </th>" +
                                                "<th style='border: 1px solid #020000; border-collapse: collapse;width:35%;text-align: center;' rowspan='2'>" +
                                                    "Nội dung </th>" +
                                                "<th style='border: 1px solid #020000; border-collapse: collapse;width:5%;text-align: center;' rowspan='2'>" +
                                                    "Đơn vị tính</th>" +
                                                "<th style='border: 1px solid #020000; border-collapse: collapse;width:3%; text-align: center;' rowspan='2'>" +
                                                    "Số lượng</th>" +
                                                "<th style='border: 1px solid #020000; border-collapse: collapse;width:3%; text-align: center;' rowspan='2'>" +
                                                    "Đơn giá BV <span style='font-weight: 100;'>(đồng)</span></th>" +
                                                "<th style='border: 1px solid #020000; border-collapse: collapse;width:3%; text-align: center;' rowspan='2'>" +
                                                    "Đơn giá BH  <span style='font-weight: 100;'>(đồng)</span></th>" +
                                                "<th style='border: 1px solid #020000; border-collapse: collapse;width:200px; text-align: center;'" +
                                                    "rowspan='2'>" +
                                                    "Tỉ lệ thanh toán theo dich vụ   <span style='font-weight: 100;'>(%)</span></th>" +
                                                "<th style='border: 1px solid #020000; border-collapse: collapse;width:8%;text-align: center;' rowspan='2'>" +
                                                    "Thành tiền BV  <span style='font-weight: 100;'>(đồng)</span>" +
                                                "</th>" +
                                                "<th style='border: 1px solid #020000; border-collapse: collapse;width:200px; text-align: center;'" +
                                                    "rowspan='2'>" +
                                                    "Tỷ lệ thanh toán BHYT <span style='font-weight: 100;'>(%)</span>" +
                                                "</th>" +
                                                "<th style='border: 1px solid #020000; border-collapse: collapse;width:8%;text-align: center;' rowspan='2'>" +
                                                    "Thành tiền BH  <span style='font-weight: 100;'>(đồng)</span>" +
                                                "</th>" +
                                                "<th style='border: 1px solid #020000; border-collapse: collapse;width:35%;text-align: center;' colspan='4'>" +
                                                    "Nguồn thanh toán  <span style='font-weight: 100;'>(đồng)</span></th>" +
                                            "</tr>" +
                                            "<tr style='border: 1px solid #020000; border-collapse: collapse;'>" +
                                                "<td style='border: 1px solid #020000; border-collapse: collapse;text-align: center;'><b>Quỹ BHYT</b></td>" +
                                                "<td style=' border: 1px solid #020000; border-collapse: collapse;width:80px;text-align: center;'>" +
                                                    "<b>Người bệnh cùng chi" +
                                                    " trả</b> (đồng)</td>" +
                                                "<td style=' border: 1px solid #020000; border-collapse: collapse;text-align: center;'><b>Khác</b> (đồng)</td>" +
                                                "<td style='border: 1px solid #020000; border-collapse: collapse;text-align: center;width: 90px;'>" +
                                                    "<b>Người bệnh" +
                                                    "tự trả </b>(đồng)" +
                                                "</td>" +
                                            "</tr>" +
                                            "<tr style=' border: 1px solid #020000; '>" +
                                              "<td style='border: 1px solid #020000;text-align: center;'><b> </b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(1)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(2)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(3)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(4)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(5)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(6)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(7)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(8)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(9)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(10)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(11)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(12)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(13)</b> </td>" +
                                            "</tr>";


                    var dsChiPhiBangKeTheoThe = new List<BangKeKhamBenhBenhVienVo>();

                    foreach (var chiPhi in chiPhis.Where(c => c.NhomChiPhiBangKe != NhomChiPhiBangKe.GoiVatTu && c.YeuCauGoiDichVuId == null).GroupBy(c => new { c.DonGia, c.SoTienMG, KhongTinhPhi = c.KhongTinhPhi.GetValueOrDefault(), c.NhomChiPhiBangKe, c.TenDichVu, c.DonViTinh, c.DuocHuongBHYT, c.DonGiaBHYT, c.MucHuongBaoHiem, c.TiLeBaoHiemThanhToan }).OrderByDescending(o => o.Key.DuocHuongBHYT))
                    {
                        var chiphiBangKe = new BangKeKhamBenhBenhVienVo
                        {
                            Nhom = chiPhi.Key.NhomChiPhiBangKe,
                            Id = chiPhi.FirstOrDefault().Id,
                            NoiDung = chiPhi.Key.TenDichVu,
                            DonViTinh = chiPhi.Key.DonViTinh,
                            SoLuong = (decimal)chiPhi.Sum(c => c.Soluong),
                            DuocHuongBaoHiem = chiPhi.Key.DuocHuongBHYT,
                            DonGiaBH = chiPhi.Key.DuocHuongBHYT ? chiPhi.Key.DonGiaBHYT : 0,
                            MucHuongBaoHiem = chiPhi.Key.MucHuongBaoHiem,
                            TiLeThanhToanTheoDV = chiPhi.Key.TiLeBaoHiemThanhToan,
                            BaoHiemChiTra = true,
                            DonGiaBV = chiPhi.Key.DonGia
                        };
                        if (chiPhi.Key.KhongTinhPhi == true)
                        {
                            chiphiBangKe.Khac = chiPhi.Key.MucHuongBaoHiem > 0
                                ? (chiphiBangKe.ThanhTienBV.GetValueOrDefault() - chiphiBangKe.ThanhTienBH.GetValueOrDefault())
                                : chiphiBangKe.ThanhTienBV.GetValueOrDefault();
                        }
                        else
                        {
                            chiphiBangKe.Khac = chiPhi.Sum(c => c.SoTienMG);
                        }
                        dsChiPhiBangKeTheoThe.Add(chiphiBangKe);
                    }

                    foreach (var chiPhi in chiPhis.Where(c => !(c.NhomChiPhiBangKe != NhomChiPhiBangKe.GoiVatTu && c.YeuCauGoiDichVuId == null)))
                    {
                        var chiphiBangKe = new BangKeKhamBenhBenhVienVo
                        {
                            Nhom = chiPhi.NhomChiPhiBangKe,
                            Id = chiPhi.Id,
                            NoiDung = chiPhi.TenDichVu,
                            DonViTinh = chiPhi.DonViTinh,
                            SoLuong = (decimal)chiPhi.Soluong,
                            DuocHuongBaoHiem = chiPhi.DuocHuongBHYT,
                            DonGiaBH = chiPhi.DuocHuongBHYT ? chiPhi.DonGiaBHYT : 0,
                            MucHuongBaoHiem = chiPhi.MucHuongBaoHiem,
                            TiLeThanhToanTheoDV = chiPhi.TiLeBaoHiemThanhToan,
                            BaoHiemChiTra = true,
                            DonGiaBV = chiPhi.DonGia
                        };
                        if (chiPhi.KhongTinhPhi == true || chiPhi.YeuCauGoiDichVuId != null)
                        {
                            chiphiBangKe.Khac = chiPhi.MucHuongBaoHiem > 0
                                ? (chiphiBangKe.ThanhTienBV.GetValueOrDefault() - chiphiBangKe.ThanhTienBH.GetValueOrDefault())
                                : chiphiBangKe.ThanhTienBV.GetValueOrDefault();
                        }
                        else
                        {
                            chiphiBangKe.Khac = chiPhi.SoTienMG;
                        }
                        dsChiPhiBangKeTheoThe.Add(chiphiBangKe);
                    }
                    dsChiPhiBangKe.AddRange(dsChiPhiBangKeTheoThe);
                    var groupChiPhiBangKes = dsChiPhiBangKeTheoThe.GroupBy(x => x.Nhom).OrderBy(o => (int)o.Key * (o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay || o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriNoiTru ? 1 : 10));
                    foreach (var groupChiPhiBangKe in groupChiPhiBangKes)
                    {
                        if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay)
                        {

                            dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                               "<td style='border: 1px solid #020000;' colspan='7'>" +
                                               "<span style='float:left;'><b>2. Ngày giường:  </b></span>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                               "</tr>";
                            dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                               "<td style='border: 1px solid #020000;' colspan='7'>" +
                                               "<span style='float:left;'><b>2.1." + groupChiPhiBangKe.Key.GetDescription() + "  </b></span>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b> " + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true) + "</b> </td>" +
                                               "</tr>";
                        }
                        else if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.NgayGiuongDieuTriNoiTru)
                        {
                            if (!groupChiPhiBangKes.Any(o => o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay))
                            {
                                dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                                   "<td style='border: 1px solid #020000;' colspan='7'>" +
                                                   "<span style='float:left;'><b>2. Ngày giường:  </b></span>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                   "</tr>";
                            }
                            dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                               "<td style='border: 1px solid #020000;' colspan='7'>" +
                                               "<span style='float:left;'><b>2.2." + groupChiPhiBangKe.Key.GetDescription() + "  </b></span>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b> " + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true) + "</b> </td>" +
                                               "</tr>";
                        }
                        else
                        {
                            dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                               "<td style='border: 1px solid #020000;' colspan='7'>" +
                                               "<span style='float:left;'><b>" + (int)groupChiPhiBangKe.Key + "." + groupChiPhiBangKe.Key.GetDescription() + "  </b></span>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b> " + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true) + "</b> </td>" +
                                               "</tr>";
                        }
                        if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.GoiVatTu)
                        {
                            var groupGoiVatTus = groupChiPhiBangKe.ToList().GroupBy(o => o.SoGoiVatTu.GetValueOrDefault()).OrderBy(o => o.Key);
                            int sttGoiVatTu = 1;
                            foreach (var groupGoiVatTu in groupGoiVatTus)
                            {
                                dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                                   "<td style='border: 1px solid #020000;' colspan='7'>" +
                                                   "<span style='float:left;'><b>10." + sttGoiVatTu + ". " + groupChiPhiBangKe.Key.GetDescription() + " " + sttGoiVatTu + "  </b></span>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.Khac)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'><b> " + Convert.ToDouble(groupGoiVatTu.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true) + "</b> </td>" +
                                                   "</tr>";
                                foreach (var chiPhiBangKe in groupGoiVatTu)
                                {
                                    dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                                    "<td style='border: 1px solid #020000; text-align: center;'> " + indexItem + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: left;'> " + chiPhiBangKe.NoiDung + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: center;'>  " + chiPhiBangKe.DonViTinh + " </td>" +
                                                    "<td style='border: 1px solid #020000;text-align: center;'> " + chiPhiBangKe.SoLuong + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: center;'> " + Convert.ToDouble(chiPhiBangKe.DonGiaBV).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: center;'> " + Convert.ToDouble(chiPhiBangKe.DonGiaBH).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.TiLeThanhToanTheoDV).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.ThanhTienBV).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.MucHuongBaoHiem > 0 ? 100 : 0).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.ThanhTienBH).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.QuyBHYT).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.NguoiBenhCungChiTra).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.Khac).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.NguoiBenhTuTra).ApplyFormatMoneyToDouble(true) + "</td>" +
                                                    "</tr>";
                                    indexItem++;
                                }
                            }
                        }
                        else
                        {
                            foreach (var chiPhiBangKe in groupChiPhiBangKe)
                            {
                                dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                                "<td style='border: 1px solid #020000; text-align: center;'> " + indexItem + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: left;'> " + chiPhiBangKe.NoiDung + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'>  " + chiPhiBangKe.DonViTinh + " </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'> " + chiPhiBangKe.SoLuong + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'> " + Convert.ToDouble(chiPhiBangKe.DonGiaBV).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'> " + Convert.ToDouble(chiPhiBangKe.DonGiaBH).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.TiLeThanhToanTheoDV).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.ThanhTienBV).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.MucHuongBaoHiem > 0 ? 100 : 0).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.ThanhTienBH).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.QuyBHYT).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.NguoiBenhCungChiTra).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.Khac).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.NguoiBenhTuTra).ApplyFormatMoneyToDouble(true) + "</td>" +
                                                "</tr>";
                                indexItem++;
                            }
                        }

                    }

                    dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                       "<td style='border: 1px solid #020000;' colspan='7'></span>" +
                                       "<span style='float:right;padding-right: 50px;'><b>Tổng Cộng</b></span>" +
                                       "</td>" +
                                       $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKeTheoThe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                       $"<td style='border: 1px solid #020000;text-align: right;'><b></b> </td>" +
                                       $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKeTheoThe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                       $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKeTheoThe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                       $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKeTheoThe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                       $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKeTheoThe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                       $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKeTheoThe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true)}</b> </td>" +
                                       "</tr>" +
                                       "</table>";
                }
            }
            else
            {
                YeuCauTiepNhanTheBHYT theBHYTChiTra = null;
                var maSoThe = groupChiPhiTheoThe.Where(o => o.Key != string.Empty).FirstOrDefault()?.Key;
                if (!string.IsNullOrEmpty(maSoThe))
                {
                    theBHYTChiTra = yeuCauTiepNhan.YeuCauTiepNhanTheBHYTs.First(o => o.MaSoThe == maSoThe);
                }

                var chiPhis = groupChiPhiTheoThe.SelectMany(o => o).ToList();
                var mucHuongPT = theBHYTChiTra != null && theBHYTChiTra?.MucHuong > 0 ? theBHYTChiTra?.MucHuong + "%" : string.Empty;

                dateItemChiPhis += "<table style='width: 100 %; '>" +
                                    "<tbody>" +
                                    "<tr>" +
                                       $"<td style='padding-left:-5px; width: 40 %; '>Mã thẻ BHYT: <b>{theBHYTChiTra?.MaSoThe}</b> " +
                                       $"<span style='padding-left:20px'>Giá trị từ: <b>{theBHYTChiTra?.NgayHieuLuc.ApplyFormatDate()}</b> đến <b>{theBHYTChiTra?.NgayHetHan?.ApplyFormatDate()}</b></span>" +
                                       $"<span style='padding-left:20px'>Mức hưởng: <b>{mucHuongPT}</b></span></td>" +
                                       "</tr>" +
                                    "</tbody>" +
                                    "</table>" +
                                    "</br>" +
                                    "<table style='width:100%;border: 1px solid #020000; border-collapse: collapse;'>" +
                                        "<tr style='border: 1px solid black;  border-collapse: collapse;'>" +
                                        "<th style='border: 1px solid #020000; border-collapse: collapse;text-align: center;' rowspan='2'>" +
                                                "STT </th>" +
                                            "<th style='border: 1px solid #020000; border-collapse: collapse;width:35%;text-align: center;' rowspan='2'>" +
                                                "Nội dung </th>" +
                                            "<th style='border: 1px solid #020000; border-collapse: collapse;width:5%;text-align: center;' rowspan='2'>" +
                                                "Đơn vị tính</th>" +
                                            "<th style='border: 1px solid #020000; border-collapse: collapse;width:3%; text-align: center;' rowspan='2'>" +
                                                "Số lượng</th>" +
                                            "<th style='border: 1px solid #020000; border-collapse: collapse;width:3%; text-align: center;' rowspan='2'>" +
                                                "Đơn giá BV <span style='font-weight: 100;'>(đồng)</span></th>" +
                                            "<th style='border: 1px solid #020000; border-collapse: collapse;width:3%; text-align: center;' rowspan='2'>" +
                                                "Đơn giá BH  <span style='font-weight: 100;'>(đồng)</span></th>" +
                                            "<th style='border: 1px solid #020000; border-collapse: collapse;width:200px; text-align: center;'" +
                                                "rowspan='2'>" +
                                                "Tỉ lệ thanh toán theo dich vụ   <span style='font-weight: 100;'>(%)</span></th>" +
                                            "<th style='border: 1px solid #020000; border-collapse: collapse;width:8%;text-align: center;' rowspan='2'>" +
                                                "Thành tiền BV  <span style='font-weight: 100;'>(đồng)</span>" +
                                            "</th>" +
                                            "<th style='border: 1px solid #020000; border-collapse: collapse;width:200px; text-align: center;'" +
                                                "rowspan='2'>" +
                                                "Tỷ lệ thanh toán BHYT <span style='font-weight: 100;'>(%)</span>" +
                                            "</th>" +
                                            "<th style='border: 1px solid #020000; border-collapse: collapse;width:8%;text-align: center;' rowspan='2'>" +
                                                "Thành tiền BH  <span style='font-weight: 100;'>(đồng)</span>" +
                                            "</th>" +
                                            "<th style='border: 1px solid #020000; border-collapse: collapse;width:35%;text-align: center;' colspan='4'>" +
                                                "Nguồn thanh toán  <span style='font-weight: 100;'>(đồng)</span></th>" +
                                        "</tr>" +
                                        "<tr style='border: 1px solid #020000; border-collapse: collapse;'>" +
                                            "<td style='border: 1px solid #020000; border-collapse: collapse;text-align: center;'><b>Quỹ BHYT</b></td>" +
                                            "<td style=' border: 1px solid #020000; border-collapse: collapse;width:80px;text-align: center;'>" +
                                                "<b>Người bệnh cùng chi " +
                                                " trả</b> (đồng)</td>" +
                                            "<td style=' border: 1px solid #020000; border-collapse: collapse;text-align: center;'><b>Khác</b> (đồng)</td>" +
                                            "<td style='border: 1px solid #020000; border-collapse: collapse;text-align: center;width: 90px;'>" +
                                                "<b>Người bệnh" +
                                                "tự trả </b>(đồng)" +
                                            "</td>" +
                                        "</tr>" +
                                        "<tr style=' border: 1px solid #020000; '>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b> </b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b>(1)</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b>(2)</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b>(3)</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b>(4)</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b>(5)</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b>(6)</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b>(7)</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b>(8)</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b>(9)</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b>(10)</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b>(11)</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b>(12)</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b>(13)</b> </td>" +
                                        "</tr>";


                //foreach (var chiPhi in chiPhis)
                //{
                //    dsChiPhiBangKe.Add(new BangKeKhamBenhBenhVienVo
                //    {
                //        Nhom = chiPhi.NhomChiPhiBangKe,
                //        Id = chiPhi.Id,
                //        NoiDung = chiPhi.TenDichVu,
                //        DonViTinh = chiPhi.DonViTinh,
                //        SoLuong = (decimal)chiPhi.Soluong,
                //        DuocHuongBaoHiem = chiPhi.DuocHuongBHYT,
                //        DonGiaBH = chiPhi.DuocHuongBHYT ? chiPhi.DonGiaBHYT : 0,
                //        MucHuongBaoHiem = chiPhi.MucHuongBaoHiem,
                //        TiLeThanhToanTheoDV = chiPhi.TiLeBaoHiemThanhToan,
                //        BaoHiemChiTra = true,
                //        DonGiaBV = chiPhi.DonGia
                //    });
                //}

                foreach (var chiPhi in chiPhis.Where(c => c.NhomChiPhiBangKe != NhomChiPhiBangKe.GoiVatTu && c.YeuCauGoiDichVuId == null).GroupBy(c => new { c.DonGia, c.SoTienMG, KhongTinhPhi = c.KhongTinhPhi.GetValueOrDefault(), c.NhomChiPhiBangKe, c.TenDichVu, c.DonViTinh, c.DuocHuongBHYT, c.DonGiaBHYT, c.MucHuongBaoHiem, c.TiLeBaoHiemThanhToan }).OrderByDescending(o => o.Key.DuocHuongBHYT))
                {
                    var chiphiBangKe = new BangKeKhamBenhBenhVienVo
                    {
                        Nhom = chiPhi.Key.NhomChiPhiBangKe,
                        Id = chiPhi.FirstOrDefault().Id,
                        NoiDung = chiPhi.Key.TenDichVu,
                        DonViTinh = chiPhi.Key.DonViTinh,
                        SoLuong = (decimal)chiPhi.Sum(c => c.Soluong),
                        DuocHuongBaoHiem = chiPhi.Key.DuocHuongBHYT,
                        DonGiaBH = chiPhi.Key.DuocHuongBHYT ? chiPhi.Key.DonGiaBHYT : 0,
                        MucHuongBaoHiem = chiPhi.Key.MucHuongBaoHiem,
                        TiLeThanhToanTheoDV = chiPhi.Key.TiLeBaoHiemThanhToan,
                        BaoHiemChiTra = true,
                        DonGiaBV = chiPhi.Key.DonGia
                    };
                    if (chiPhi.Key.KhongTinhPhi == true)
                    {
                        chiphiBangKe.Khac = chiPhi.Key.MucHuongBaoHiem > 0
                            ? (chiphiBangKe.ThanhTienBV.GetValueOrDefault() - chiphiBangKe.ThanhTienBH.GetValueOrDefault())
                            : chiphiBangKe.ThanhTienBV.GetValueOrDefault();
                    }
                    else
                    {
                        chiphiBangKe.Khac = chiPhi.Sum(c => c.SoTienMG);
                    }
                    dsChiPhiBangKe.Add(chiphiBangKe);
                }

                foreach (var chiPhi in chiPhis.Where(c => !(c.NhomChiPhiBangKe != NhomChiPhiBangKe.GoiVatTu && c.YeuCauGoiDichVuId == null)))
                {
                    var chiphiBangKe = new BangKeKhamBenhBenhVienVo
                    {
                        Nhom = chiPhi.NhomChiPhiBangKe,
                        Id = chiPhi.Id,
                        NoiDung = chiPhi.TenDichVu,
                        DonViTinh = chiPhi.DonViTinh,
                        SoLuong = (decimal)chiPhi.Soluong,
                        DuocHuongBaoHiem = chiPhi.DuocHuongBHYT,
                        DonGiaBH = chiPhi.DuocHuongBHYT ? chiPhi.DonGiaBHYT : 0,
                        MucHuongBaoHiem = chiPhi.MucHuongBaoHiem,
                        TiLeThanhToanTheoDV = chiPhi.TiLeBaoHiemThanhToan,
                        BaoHiemChiTra = true,
                        DonGiaBV = chiPhi.DonGia
                    };
                    if (chiPhi.KhongTinhPhi == true || chiPhi.YeuCauGoiDichVuId != null)
                    {
                        chiphiBangKe.Khac = chiPhi.MucHuongBaoHiem > 0
                            ? (chiphiBangKe.ThanhTienBV.GetValueOrDefault() - chiphiBangKe.ThanhTienBH.GetValueOrDefault())
                            : chiphiBangKe.ThanhTienBV.GetValueOrDefault();
                    }
                    else
                    {
                        chiphiBangKe.Khac = chiPhi.SoTienMG;
                    }
                    dsChiPhiBangKe.Add(chiphiBangKe);
                }

                var groupChiPhiBangKes = dsChiPhiBangKe.GroupBy(x => x.Nhom).OrderBy(o => (int)o.Key * (o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay || o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriNoiTru ? 1 : 10));
                foreach (var groupChiPhiBangKe in groupChiPhiBangKes)
                {
                    if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay)
                    {

                        dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                            "<td style='border: 1px solid #020000;' colspan='7'>" +
                                            "<span style='float:left;'><b>2. Ngày giường:  </b></span>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                            "</tr>";
                        dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                            "<td style='border: 1px solid #020000;' colspan='7'>" +
                                            "<span style='float:left;'><b>2.1." + groupChiPhiBangKe.Key.GetDescription() + "  </b></span>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b> " + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true) + "</b> </td>" +
                                            "</tr>";
                    }
                    else if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.NgayGiuongDieuTriNoiTru)
                    {
                        if (!groupChiPhiBangKes.Any(o => o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay))
                        {
                            dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                                "<td style='border: 1px solid #020000;' colspan='7'>" +
                                                "<span style='float:left;'><b>2. Ngày giường:  </b></span>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                "</tr>";
                        }
                        dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                            "<td style='border: 1px solid #020000;' colspan='7'>" +
                                            "<span style='float:left;'><b>2.2." + groupChiPhiBangKe.Key.GetDescription() + "  </b></span>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b> " + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true) + "</b> </td>" +
                                            "</tr>";
                    }
                    else
                    {
                        dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                            "<td style='border: 1px solid #020000;' colspan='7'>" +
                                            "<span style='float:left;'><b>" + (int)groupChiPhiBangKe.Key + "." + groupChiPhiBangKe.Key.GetDescription() + "  </b></span>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b> " + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true) + "</b> </td>" +
                                            "</tr>";
                    }
                    if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.GoiVatTu)
                    {
                        var groupGoiVatTus = groupChiPhiBangKe.ToList().GroupBy(o => o.SoGoiVatTu.GetValueOrDefault()).OrderBy(o => o.Key);
                        int sttGoiVatTu = 1;
                        foreach (var groupGoiVatTu in groupGoiVatTus)
                        {
                            dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                                "<td style='border: 1px solid #020000;' colspan='7'>" +
                                                "<span style='float:left;'><b>10." + sttGoiVatTu + ". " + groupChiPhiBangKe.Key.GetDescription() + " " + sttGoiVatTu + "  </b></span>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.Khac)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'><b> " + Convert.ToDouble(groupGoiVatTu.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true) + "</b> </td>" +
                                                "</tr>";
                            foreach (var chiPhiBangKe in groupGoiVatTu)
                            {
                                dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                                "<td style='border: 1px solid #020000; text-align: center;'> " + indexItem + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: left;'> " + chiPhiBangKe.NoiDung + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'>  " + chiPhiBangKe.DonViTinh + " </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'> " + chiPhiBangKe.SoLuong + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'> " + Convert.ToDouble(chiPhiBangKe.DonGiaBV).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'> " + Convert.ToDouble(chiPhiBangKe.DonGiaBH).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.TiLeThanhToanTheoDV).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.ThanhTienBV).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.MucHuongBaoHiem > 0 ? 100 : 0).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.ThanhTienBH).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.QuyBHYT).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.NguoiBenhCungChiTra).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.Khac).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.NguoiBenhTuTra).ApplyFormatMoneyToDouble(true) + "</td>" +
                                                "</tr>";
                                indexItem++;
                            }
                        }
                    }
                    else
                    {

                        foreach (var chiPhiBangKe in groupChiPhiBangKe)
                        {
                            dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                            "<td style='border: 1px solid #020000; text-align: center;'> " + indexItem + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: left;'> " + chiPhiBangKe.NoiDung + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'>  " + chiPhiBangKe.DonViTinh + " </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'> " + chiPhiBangKe.SoLuong + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'> " + Convert.ToDouble(chiPhiBangKe.DonGiaBV).ApplyFormatMoneyToDouble() + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'> " + Convert.ToDouble(chiPhiBangKe.DonGiaBH).ApplyFormatMoneyToDouble() + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.TiLeThanhToanTheoDV).ApplyFormatMoneyToDouble() + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.ThanhTienBV).ApplyFormatMoneyToDouble() + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.MucHuongBaoHiem > 0 ? 100 : 0).ApplyFormatMoneyToDouble() + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.ThanhTienBH).ApplyFormatMoneyToDouble() + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.QuyBHYT).ApplyFormatMoneyToDouble() + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.NguoiBenhCungChiTra).ApplyFormatMoneyToDouble() + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.Khac).ApplyFormatMoneyToDouble() + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.NguoiBenhTuTra).ApplyFormatMoneyToDouble(true) + "</td>" +
                                            "</tr>";
                            indexItem++;
                        }
                    }

                }

                dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                    "<td style='border: 1px solid #020000;' colspan='7'></span>" +
                                    "<span style='float:right;padding-right: 50px;'><b>Tổng Cộng</b></span>" +
                                    "</td>" +
                                    $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                    $"<td style='border: 1px solid #020000;text-align: right;'><b></b> </td>" +
                                    $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                    $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                    $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                    $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                    $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true)}</b> </td>" +
                                    "</tr>" +
                                    "</table>";

            }

            var khoaPhong = yeuCauTiepNhan.NoiTruBenhAn?.NoiTruKhoaPhongDieuTris.OrderByDescending(c => c.ThoiDiemVaoKhoa).Select(c => c.KhoaPhongChuyenDen).FirstOrDefault();
            var chuyenKhoa = GetChuyenKhoa(khoaPhong?.Id);//BVHD-3792
            var checkedLyDoVaoVien = "<input id='demo_box_2' class='css - checkbox' type='checkbox' checked  disabled='true'/>";
            var unCheckedLyDoVaoVien = "<input id='demo_box_2' class='css - checkbox' type='checkbox' disabled='true' />";
            var data = new
            {
                TitleBangKe = "ĐIỀU TRỊ NỘI TRÚ",
                SoBangKe = "3",
                yeuCauTiepNhan.BenhNhan.MaBN,
                MaTN = yeuCauTiepNhan.MaYeuCauTiepNhan,
                SoBenhAn = "Số bệnh án: " + yeuCauTiepNhan.NoiTruBenhAn?.SoBenhAn,
                yeuCauTiepNhan.HoTen,
                DiaChi = yeuCauTiepNhan.DiaChiDayDu,
                BarCodeImgBase64 = !string.IsNullOrEmpty(yeuCauTiepNhan.MaYeuCauTiepNhan) ? BarcodeHelper.GenerateBarCode(yeuCauTiepNhan.MaYeuCauTiepNhan) : "",
                NamSinh = DateHelper.DOBFormat(yeuCauTiepNhan.NgaySinh, yeuCauTiepNhan.ThangSinh, yeuCauTiepNhan.NamSinh),
                GioiTinh = yeuCauTiepNhan.GioiTinh != null ? yeuCauTiepNhan.GioiTinh.GetDescription() : "",
                //TenKhoa = "Khoa: " + yeuCauTiepNhan.NoiTruBenhAn?.KhoaPhongNhapVien?.Ten,
                //MaKhoa = "Mã khoa: " + yeuCauTiepNhan.NoiTruBenhAn?.KhoaPhongNhapVien?.Ma,

                TenKhoa = "Khoa: " + khoaPhong?.Ten,
                MaKhoa = "Mã khoa: " + chuyenKhoa?.Ma,

                MaBHYT = theBHYT?.MaSoThe,
                BHYTTuNgay = bHYTTuNgay,
                BHYTDenNgay = bHYTDenNgay,
                NoiDKKCBBanDau,
                MaKCBBanDau,
                NgayDenKham = yeuCauTiepNhan.YeuCauNhapVien?.YeuCauKhamBenh?.YeuCauTiepNhan.ThoiDiemTiepNhan.ApplyFormatGioPhutNgay(),
                DieuTriKNT = yeuCauTiepNhan.NoiTruBenhAn?.ThoiDiemNhapVien.ApplyFormatGioPhutNgay(),
                KetThucKhamNgoaiTru = yeuCauTiepNhan.NoiTruBenhAn?.ThoiDiemRaVien?.ApplyFormatGioPhutNgay(),
                SoNgayDTri = NoiTruBenhAnHelper.TinhSoNgayDieuTri(yeuCauTiepNhan.NoiTruBenhAn)?.ToString() ?? string.Empty,//yeuCauTiepNhan.NoiTruBenhAn?.ThoiDiemRaVien == null ? "" : (yeuCauTiepNhan.NoiTruBenhAn.ThoiDiemRaVien.Value.Date.AddDays(1) - yeuCauTiepNhan.NoiTruBenhAn.ThoiDiemNhapVien.Date).Days.ToString(),
                TinhTrangRaVien = yeuCauTiepNhan.NoiTruBenhAn?.TinhTrangRaVien == EnumTinhTrangRaVien.RaVien && (yeuCauTiepNhan.NoiTruBenhAn?.KetQuaDieuTri == EnumKetQuaDieuTri.Do || yeuCauTiepNhan.NoiTruBenhAn?.KetQuaDieuTri == EnumKetQuaDieuTri.Khoi) ? 1 : 2,
                MucHuong = mucHuong,
                NoiChuyenDen = yeuCauTiepNhan.NoiChuyen?.Ten,
                NoiChuyenDi = yeuCauTiepNhan.NoiTruBenhAn?.ChuyenDenBenhVien?.Ten,
                MKV = theBHYT?.MaKhuVuc,
                NgayMiemCungTC = theBHYT?.NgayDuocMienCungChiTra?.ApplyFormatDate(),
                ThoiGian5Nam = theBHYT?.NgayDu5Nam?.ApplyFormatDate(),
                CoCapCuu = yeuCauTiepNhan.LyDoVaoVien == Enums.EnumLyDoVaoVien.CapCuu ? checkedLyDoVaoVien : unCheckedLyDoVaoVien,
                CoDungTuyen = yeuCauTiepNhan.LyDoVaoVien == Enums.EnumLyDoVaoVien.DungTuyen ? checkedLyDoVaoVien : unCheckedLyDoVaoVien,
                CoThongTuyen = yeuCauTiepNhan.LyDoVaoVien == Enums.EnumLyDoVaoVien.ThongTuyen ? checkedLyDoVaoVien : unCheckedLyDoVaoVien,
                CoTraiTuyen = yeuCauTiepNhan.LyDoVaoVien == Enums.EnumLyDoVaoVien.TraiTuyen ? checkedLyDoVaoVien : unCheckedLyDoVaoVien,

                ChuanDoanXacDinh = yeuCauTiepNhan.NoiTruBenhAn != null && (yeuCauTiepNhan.NoiTruBenhAn.LoaiBenhAn == LoaiBenhAn.SanKhoaMo || yeuCauTiepNhan.NoiTruBenhAn.LoaiBenhAn == LoaiBenhAn.SanKhoaThuong) ? chuanDoanXacDinhSanKhoa : yeuCauTiepNhan.NoiTruBenhAn?.ChanDoanChinhRaVienGhiChu,
                MaICD10 = yeuCauTiepNhan.NoiTruBenhAn != null && (yeuCauTiepNhan.NoiTruBenhAn.LoaiBenhAn == LoaiBenhAn.SanKhoaMo || yeuCauTiepNhan.NoiTruBenhAn.LoaiBenhAn == LoaiBenhAn.SanKhoaThuong) ? maICD10 : yeuCauTiepNhan.NoiTruBenhAn?.ChanDoanChinhRaVienICD?.Ma,


                BenhKemTheo = tenICDKemTheo,
                ICDKemTheo10 = maICDKemTheo,

                DateItemChiPhis = dateItemChiPhis,

                TTDV = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble(),
                TTTTBHYT = "",

                TTTienBH = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble(),
                TQBHYT = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble(),
                TNCCTra = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble(),
                TongSoKhac = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble(),
                TNBTuTra = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true),

                TongChiPhi = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble(),
                SoTienBangChu = NumberHelper.ChuyenSoRaText(Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBV))),

                NguoiBenhPhaiTra = (Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)) + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhTuTra))).ApplyFormatMoneyToDouble(),

                TTQuyTT = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble(),
                BHYTChiTra = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble(),
                CacKhoanTraKhac = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true),
                SoTienKhac = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble(),
                NgayHienTai = DateTime.Now.ApplyFormatNgayThangNam(),
                Notice = "<div style='color: red; font-weight:800; margin-top:200px;'>Lưu ý : Người bệnh chưa quyết toán </div>"
            };

            var content = TemplateHelpper.FormatTemplateWithContentTemplate(result?.Body, data);
            return content;
        }
        public string GetHtmlBangKeChuaQuyetToanTrongGoiDv(long yeuCauTiepNhanId, string hostingName)
        {
            //var danhSachChiPhi = GetDanhSachChiPhiNoiTruChuaThu(yeuCauTiepNhanId).Result;
            var danhSachChiPhi = GetTatCaDichVuKhamChuaBenh(yeuCauTiepNhanId).Result.Where(o => !o.Soluong.AlmostEqual(0) && o.YeuCauGoiDichVuId != null).ToList();
            if (danhSachChiPhi.Count == 0)
            {
                return string.Empty;
            }
            var yeuCauTiepNhan = BaseRepository.GetById(yeuCauTiepNhanId,
                x => x.Include(o => o.NoiTruBenhAn).ThenInclude(o => o.ChuyenDenBenhVien)
                    .Include(o => o.NoiTruBenhAn).ThenInclude(o => o.KhoaPhongNhapVien)
                    .Include(o => o.NoiTruBenhAn).ThenInclude(o => o.ChanDoanChinhRaVienICD)
                    .Include(o => o.YeuCauTiepNhanTheBHYTs)
                    .Include(o => o.YeuCauNhapVien).ThenInclude(o => o.YeuCauKhamBenh).ThenInclude(o => o.YeuCauTiepNhan)
                    .Include(o => o.BenhNhan)
                    .Include(o => o.PhuongXa)
                    .Include(o => o.QuanHuyen)
                    .Include(o => o.TinhThanh)
                    .Include(o => o.NoiTruBenhAn).ThenInclude(o => o.NoiTruPhieuDieuTris).ThenInclude(c => c.ChanDoanChinhICD)
                    .Include(o => o.NoiTruBenhAn).ThenInclude(o => o.NoiTruPhieuDieuTris).ThenInclude(o => o.NoiTruThamKhamChanDoanKemTheos).ThenInclude(c => c.ICD)
                    .Include(o => o.NoiChuyen).Include(o => o.NoiTruBenhAn).ThenInclude(o => o.NoiTruKhoaPhongDieuTris).ThenInclude(c => c.KhoaPhongChuyenDen));

            var result = _templateRepository.TableNoTracking.FirstOrDefault(x => x.Name.Equals("BangKeChiPhiGoiKhamChuaBenh"));

            var benhVien = new Core.Domain.Entities.BenhVien.BenhVien();

            string maBHYT = string.Empty;
            string bHYTTuNgay = string.Empty;
            string bHYTDenNgay = string.Empty;
            string mucHuong = string.Empty;
            string NoiDKKCBBanDau = string.Empty;
            string MaKCBBanDau = string.Empty;


            string maICDKemTheo = string.Empty;
            string tenICDKemTheo = string.Empty;
            string chuanDoanXacDinhSanKhoa = string.Empty;
            string maICD10 = string.Empty;

            if (yeuCauTiepNhan.NoiTruBenhAn != null && (yeuCauTiepNhan.NoiTruBenhAn.LoaiBenhAn == LoaiBenhAn.SanKhoaMo || yeuCauTiepNhan.NoiTruBenhAn.LoaiBenhAn == LoaiBenhAn.SanKhoaThuong))
            {
                if (yeuCauTiepNhan.NoiTruBenhAn?.NoiTruPhieuDieuTris.Count() > 0)
                {
                    var phieuDieuTri = yeuCauTiepNhan.NoiTruBenhAn?.NoiTruPhieuDieuTris.OrderByDescending(c => c.NgayDieuTri).FirstOrDefault();

                    var icdKemTheoIds = phieuDieuTri.NoiTruThamKhamChanDoanKemTheos.Select(c => c.ICD.Ma);
                    var tenICDKemTheos = phieuDieuTri.NoiTruThamKhamChanDoanKemTheos.Select(c => c.GhiChu);

                    maICDKemTheo = string.Join(", ", icdKemTheoIds);
                    tenICDKemTheo = string.Join(", ", tenICDKemTheos);

                    maICD10 = phieuDieuTri.ChanDoanChinhICD?.Ma;
                    chuanDoanXacDinhSanKhoa = phieuDieuTri.ChanDoanChinhGhiChu;
                }
            }
            else
            {
                if (!string.IsNullOrEmpty(yeuCauTiepNhan.NoiTruBenhAn?.DanhSachChanDoanKemTheoRaVienICDId))
                {
                    var maICDKemTheos = new List<string>();

                    var icdKemTheoIds = yeuCauTiepNhan.NoiTruBenhAn?.DanhSachChanDoanKemTheoRaVienICDId.Split(Constants.ICDSeparator);
                    var tenICDKemTheos = yeuCauTiepNhan.NoiTruBenhAn?.DanhSachChanDoanKemTheoRaVienGhiChu?.Split(Constants.ICDSeparator);

                    if (icdKemTheoIds.Length > 0)
                    {
                        foreach (var icdKemTheoId in icdKemTheoIds)
                        {
                            var icdKemTheo = _icdRepository.TableNoTracking.FirstOrDefault(o => o.Id == long.Parse(icdKemTheoId));
                            if (icdKemTheo != null)
                            {
                                maICDKemTheos.Add(icdKemTheo.Ma);
                            }

                            //if (long.TryParse(yeuCauTiepNhan.NoiTruBenhAn?.DanhSachChanDoanKemTheoRaVienICDId.Split(Constants.ICDSeparator).First(), out var icdKemTheoId))
                            //{
                            //    var icdKemTheo = _icdRepository.TableNoTracking.FirstOrDefault(o => o.Id == icdKemTheoId);
                            //    if (icdKemTheo != null)
                            //    {
                            //        maICDKemTheo = icdKemTheo.Ma;
                            //        tenICDKemTheo = yeuCauTiepNhan.NoiTruBenhAn?.DanhSachChanDoanKemTheoRaVienGhiChu?.Split(Constants.ICDSeparator).First();
                            //    }
                            //}
                        }
                    }

                    maICDKemTheo = string.Join(", ", maICDKemTheos);
                    tenICDKemTheo = string.Join(", ", tenICDKemTheos);
                }
            }



            YeuCauTiepNhanTheBHYT theBHYT = null;
            if (yeuCauTiepNhan.CoBHYT == true && yeuCauTiepNhan.YeuCauTiepNhanTheBHYTs.Any())
            {
                theBHYT = yeuCauTiepNhan.YeuCauTiepNhanTheBHYTs.First();
                if (!String.IsNullOrEmpty(theBHYT.MaDKBD))
                {
                    benhVien = _benhVienRepository.TableNoTracking.FirstOrDefault(p => p.Ma.Equals(theBHYT.MaDKBD));
                }
                maBHYT = theBHYT.MaSoThe;
                bHYTTuNgay = theBHYT.NgayHieuLuc.ApplyFormatDate();
                bHYTDenNgay = theBHYT.NgayHetHan?.ApplyFormatDate();
                mucHuong = theBHYT.MucHuong.ToString() + "%";
                NoiDKKCBBanDau = benhVien != null ? benhVien?.Ten : "Chưa xác định";
                MaKCBBanDau = theBHYT.MaDKBD;
            }
            else
            {
                maBHYT = "";
                bHYTTuNgay = "";
                bHYTDenNgay = "";
                mucHuong = "0%";
                NoiDKKCBBanDau = "Chưa xác định";
                MaKCBBanDau = "Chưa xác định";
            }

            var dsChiPhiBangKe = new List<BangKeKhamBenhBenhVienVo>();
            var dateItemChiPhis = string.Empty;
            int indexItem = 1;
            var groupChiPhiTheoThe = danhSachChiPhi.GroupBy(o => o.MaSoTheBHYT);
            if (groupChiPhiTheoThe.Count() > 2 ||
                (groupChiPhiTheoThe.All(o => o.Key != string.Empty) && groupChiPhiTheoThe.Count() > 1))
            {
                var groupNgayPhatSinhTheoThe = groupChiPhiTheoThe.Where(o => o.Key != string.Empty).Select(o => new { o.Key, o.OrderBy(j => j.NgayPhatSinh).First().NgayPhatSinh }).OrderBy(o => o.NgayPhatSinh).ToArray();
                for (int i = 0; i < groupNgayPhatSinhTheoThe.Count(); i++)
                {
                    var ngayPhatSinhTheoThe = groupNgayPhatSinhTheoThe[i];
                    var theBHYTChiTra = yeuCauTiepNhan.YeuCauTiepNhanTheBHYTs.First(o => o.MaSoThe == ngayPhatSinhTheoThe.Key);
                    var chiPhis = groupChiPhiTheoThe.FirstOrDefault(o => o.Key == ngayPhatSinhTheoThe.Key).ToList();
                    DateTime? ngayPhatSinhTiepTheo = i < groupNgayPhatSinhTheoThe.Count() - 1
                        ? groupNgayPhatSinhTheoThe[i + 1].NgayPhatSinh
                        : null;
                    chiPhis.AddRange(groupChiPhiTheoThe.FirstOrDefault(o => o.Key == string.Empty).Where(j => (i == 0 || j.NgayPhatSinh >= ngayPhatSinhTheoThe.NgayPhatSinh) && (ngayPhatSinhTiepTheo != null && j.NgayPhatSinh < ngayPhatSinhTiepTheo)).ToList());
                    var mucHuongPT = theBHYTChiTra != null && theBHYTChiTra.MucHuong > 0 ? theBHYTChiTra?.MucHuong + "%" : string.Empty;

                    dateItemChiPhis += "<table style='width: 100 %; '>" +
                                       "<tbody>" +
                                       "<tr>" +
                                       $"<td style='padding-left:-5px; width: 40 %; '>Mã thẻ BHYT {i + 1}: <b>{theBHYTChiTra.MaSoThe}</b> " +
                                       $"<span style='padding-left:20px'>Giá trị từ: <b>{theBHYTChiTra.NgayHieuLuc.ApplyFormatDate()}</b> đến <b>{theBHYTChiTra.NgayHetHan?.ApplyFormatDate()}</b></span>" +
                                       $"<span style='padding-left:20px'>Mức hưởng: <b>{mucHuongPT}</b></span></td>" +
                                       "</tr>" +
                                       "</tbody>" +
                                       "</table>" +
                                       "</br>" +
                                       "<table style='width:100%;border: 1px solid #020000; border-collapse: collapse;'>" +
                                            "<tr style='border: 1px solid black;  border-collapse: collapse;'>" +
                                            "<th style='border: 1px solid #020000; border-collapse: collapse;text-align: center;' rowspan='2'>" +
                                                    "STT </th>" +
                                                "<th style='border: 1px solid #020000; border-collapse: collapse;width:35%;text-align: center;' rowspan='2'>" +
                                                    "Nội dung </th>" +
                                                "<th style='border: 1px solid #020000; border-collapse: collapse;width:5%;text-align: center;' rowspan='2'>" +
                                                    "Đơn vị tính</th>" +
                                                "<th style='border: 1px solid #020000; border-collapse: collapse;width:3%; text-align: center;' rowspan='2'>" +
                                                    "Số lượng</th>" +
                                                "<th style='border: 1px solid #020000; border-collapse: collapse;width:3%; text-align: center;' rowspan='2'>" +
                                                    "Đơn giá BV <span style='font-weight: 100;'>(đồng)</span></th>" +
                                                "<th style='border: 1px solid #020000; border-collapse: collapse;width:3%; text-align: center;' rowspan='2'>" +
                                                    "Đơn giá BH  <span style='font-weight: 100;'>(đồng)</span></th>" +
                                                "<th style='border: 1px solid #020000; border-collapse: collapse;width:200px; text-align: center;'" +
                                                    "rowspan='2'>" +
                                                    "Tỉ lệ thanh toán theo dich vụ   <span style='font-weight: 100;'>(%)</span></th>" +
                                                "<th style='border: 1px solid #020000; border-collapse: collapse;width:8%;text-align: center;' rowspan='2'>" +
                                                    "Thành tiền BV  <span style='font-weight: 100;'>(đồng)</span>" +
                                                "</th>" +
                                                "<th style='border: 1px solid #020000; border-collapse: collapse;width:200px; text-align: center;'" +
                                                    "rowspan='2'>" +
                                                    "Tỷ lệ thanh toán BHYT <span style='font-weight: 100;'>(%)</span>" +
                                                "</th>" +
                                                "<th style='border: 1px solid #020000; border-collapse: collapse;width:8%;text-align: center;' rowspan='2'>" +
                                                    "Thành tiền BH  <span style='font-weight: 100;'>(đồng)</span>" +
                                                "</th>" +
                                                "<th style='border: 1px solid #020000; border-collapse: collapse;width:35%;text-align: center;' colspan='4'>" +
                                                    "Nguồn thanh toán  <span style='font-weight: 100;'>(đồng)</span></th>" +
                                            "</tr>" +
                                            "<tr style='border: 1px solid #020000; border-collapse: collapse;'>" +
                                                "<td style='border: 1px solid #020000; border-collapse: collapse;text-align: center;'><b>Quỹ BHYT</b></td>" +
                                                "<td style=' border: 1px solid #020000; border-collapse: collapse;width:80px;text-align: center;'>" +
                                                    "<b>Người bệnh cùng chi" +
                                                    " trả</b> (đồng)</td>" +
                                                "<td style=' border: 1px solid #020000; border-collapse: collapse;text-align: center;'><b>Khác</b> (đồng)</td>" +
                                                "<td style='border: 1px solid #020000; border-collapse: collapse;text-align: center;width: 90px;'>" +
                                                    "<b>Người bệnh" +
                                                    "tự trả </b>(đồng)" +
                                                "</td>" +
                                            "</tr>" +
                                            "<tr style=' border: 1px solid #020000; '>" +
                                              "<td style='border: 1px solid #020000;text-align: center;'><b> </b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(1)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(2)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(3)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(4)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(5)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(6)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(7)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(8)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(9)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(10)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(11)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(12)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(13)</b> </td>" +
                                            "</tr>";


                    var dsChiPhiBangKeTheoThe = new List<BangKeKhamBenhBenhVienVo>();

                    foreach (var chiPhi in chiPhis.Where(c => c.NhomChiPhiBangKe != NhomChiPhiBangKe.GoiVatTu && c.YeuCauGoiDichVuId == null).GroupBy(c => new { c.DonGia, c.SoTienMG, KhongTinhPhi = c.KhongTinhPhi.GetValueOrDefault(), c.NhomChiPhiBangKe, c.TenDichVu, c.DonViTinh, c.DuocHuongBHYT, c.DonGiaBHYT, c.MucHuongBaoHiem, c.TiLeBaoHiemThanhToan }).OrderByDescending(o => o.Key.DuocHuongBHYT))
                    {
                        var chiphiBangKe = new BangKeKhamBenhBenhVienVo
                        {
                            Nhom = chiPhi.Key.NhomChiPhiBangKe,
                            Id = chiPhi.FirstOrDefault().Id,
                            NoiDung = chiPhi.Key.TenDichVu,
                            DonViTinh = chiPhi.Key.DonViTinh,
                            SoLuong = (decimal)chiPhi.Sum(c => c.Soluong),
                            DuocHuongBaoHiem = chiPhi.Key.DuocHuongBHYT,
                            DonGiaBH = chiPhi.Key.DuocHuongBHYT ? chiPhi.Key.DonGiaBHYT : 0,
                            MucHuongBaoHiem = chiPhi.Key.MucHuongBaoHiem,
                            TiLeThanhToanTheoDV = chiPhi.Key.TiLeBaoHiemThanhToan,
                            BaoHiemChiTra = true,
                            DonGiaBV = chiPhi.Key.DonGia
                        };
                        if (chiPhi.Key.KhongTinhPhi == true)
                        {
                            chiphiBangKe.Khac = chiPhi.Key.MucHuongBaoHiem > 0
                                ? (chiphiBangKe.ThanhTienBV.GetValueOrDefault() - chiphiBangKe.ThanhTienBH.GetValueOrDefault())
                                : chiphiBangKe.ThanhTienBV.GetValueOrDefault();
                        }
                        else
                        {
                            chiphiBangKe.Khac = chiPhi.Sum(c => c.SoTienMG);
                        }
                        dsChiPhiBangKeTheoThe.Add(chiphiBangKe);
                    }

                    foreach (var chiPhi in chiPhis.Where(c => !(c.NhomChiPhiBangKe != NhomChiPhiBangKe.GoiVatTu && c.YeuCauGoiDichVuId == null)))
                    {
                        var chiphiBangKe = new BangKeKhamBenhBenhVienVo
                        {
                            Nhom = chiPhi.NhomChiPhiBangKe,
                            Id = chiPhi.Id,
                            NoiDung = chiPhi.TenDichVu,
                            DonViTinh = chiPhi.DonViTinh,
                            SoLuong = (decimal)chiPhi.Soluong,
                            DuocHuongBaoHiem = chiPhi.DuocHuongBHYT,
                            DonGiaBH = chiPhi.DuocHuongBHYT ? chiPhi.DonGiaBHYT : 0,
                            MucHuongBaoHiem = chiPhi.MucHuongBaoHiem,
                            TiLeThanhToanTheoDV = chiPhi.TiLeBaoHiemThanhToan,
                            BaoHiemChiTra = true,
                            DonGiaBV = chiPhi.DonGia
                        };
                        if (chiPhi.KhongTinhPhi == true || chiPhi.YeuCauGoiDichVuId != null)
                        {
                            chiphiBangKe.Khac = chiPhi.MucHuongBaoHiem > 0
                                ? (chiphiBangKe.ThanhTienBV.GetValueOrDefault() - chiphiBangKe.ThanhTienBH.GetValueOrDefault())
                                : chiphiBangKe.ThanhTienBV.GetValueOrDefault();
                        }
                        else
                        {
                            chiphiBangKe.Khac = chiPhi.SoTienMG;
                        }
                        dsChiPhiBangKeTheoThe.Add(chiphiBangKe);
                    }
                    dsChiPhiBangKe.AddRange(dsChiPhiBangKeTheoThe);
                    var groupChiPhiBangKes = dsChiPhiBangKeTheoThe.GroupBy(x => x.Nhom).OrderBy(o => (int)o.Key * (o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay || o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriNoiTru ? 1 : 10));
                    foreach (var groupChiPhiBangKe in groupChiPhiBangKes)
                    {
                        if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay)
                        {

                            dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                               "<td style='border: 1px solid #020000;' colspan='7'>" +
                                               "<span style='float:left;'><b>2. Ngày giường:  </b></span>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                               "</tr>";
                            dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                               "<td style='border: 1px solid #020000;' colspan='7'>" +
                                               "<span style='float:left;'><b>2.1." + groupChiPhiBangKe.Key.GetDescription() + "  </b></span>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b> " + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true) + "</b> </td>" +
                                               "</tr>";
                        }
                        else if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.NgayGiuongDieuTriNoiTru)
                        {
                            if (!groupChiPhiBangKes.Any(o => o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay))
                            {
                                dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                                   "<td style='border: 1px solid #020000;' colspan='7'>" +
                                                   "<span style='float:left;'><b>2. Ngày giường:  </b></span>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                   "</tr>";
                            }
                            dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                               "<td style='border: 1px solid #020000;' colspan='7'>" +
                                               "<span style='float:left;'><b>2.2." + groupChiPhiBangKe.Key.GetDescription() + "  </b></span>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b> " + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true) + "</b> </td>" +
                                               "</tr>";
                        }
                        else
                        {
                            dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                               "<td style='border: 1px solid #020000;' colspan='7'>" +
                                               "<span style='float:left;'><b>" + (int)groupChiPhiBangKe.Key + "." + groupChiPhiBangKe.Key.GetDescription() + "  </b></span>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b> " + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true) + "</b> </td>" +
                                               "</tr>";
                        }
                        if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.GoiVatTu)
                        {
                            var groupGoiVatTus = groupChiPhiBangKe.ToList().GroupBy(o => o.SoGoiVatTu.GetValueOrDefault()).OrderBy(o => o.Key);
                            int sttGoiVatTu = 1;
                            foreach (var groupGoiVatTu in groupGoiVatTus)
                            {
                                dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                                   "<td style='border: 1px solid #020000;' colspan='7'>" +
                                                   "<span style='float:left;'><b>10." + sttGoiVatTu + ". " + groupChiPhiBangKe.Key.GetDescription() + " " + sttGoiVatTu + "  </b></span>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.Khac)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'><b> " + Convert.ToDouble(groupGoiVatTu.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true) + "</b> </td>" +
                                                   "</tr>";
                                foreach (var chiPhiBangKe in groupGoiVatTu)
                                {
                                    dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                                    "<td style='border: 1px solid #020000; text-align: center;'> " + indexItem + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: left;'> " + chiPhiBangKe.NoiDung + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: center;'>  " + chiPhiBangKe.DonViTinh + " </td>" +
                                                    "<td style='border: 1px solid #020000;text-align: center;'> " + chiPhiBangKe.SoLuong + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: center;'> " + Convert.ToDouble(chiPhiBangKe.DonGiaBV).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: center;'> " + Convert.ToDouble(chiPhiBangKe.DonGiaBH).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.TiLeThanhToanTheoDV).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.ThanhTienBV).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.MucHuongBaoHiem > 0 ? 100 : 0).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.ThanhTienBH).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.QuyBHYT).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.NguoiBenhCungChiTra).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.Khac).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.NguoiBenhTuTra).ApplyFormatMoneyToDouble(true) + "</td>" +
                                                    "</tr>";
                                    indexItem++;
                                }
                            }
                        }
                        else
                        {
                            foreach (var chiPhiBangKe in groupChiPhiBangKe)
                            {
                                dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                                "<td style='border: 1px solid #020000; text-align: center;'> " + indexItem + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: left;'> " + chiPhiBangKe.NoiDung + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'>  " + chiPhiBangKe.DonViTinh + " </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'> " + chiPhiBangKe.SoLuong + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'> " + Convert.ToDouble(chiPhiBangKe.DonGiaBV).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'> " + Convert.ToDouble(chiPhiBangKe.DonGiaBH).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.TiLeThanhToanTheoDV).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.ThanhTienBV).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.MucHuongBaoHiem > 0 ? 100 : 0).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.ThanhTienBH).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.QuyBHYT).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.NguoiBenhCungChiTra).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.Khac).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.NguoiBenhTuTra).ApplyFormatMoneyToDouble(true) + "</td>" +
                                                "</tr>";
                                indexItem++;
                            }
                        }

                    }

                    dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                       "<td style='border: 1px solid #020000;' colspan='7'></span>" +
                                       "<span style='float:right;padding-right: 50px;'><b>Tổng Cộng</b></span>" +
                                       "</td>" +
                                       $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKeTheoThe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                       $"<td style='border: 1px solid #020000;text-align: right;'><b></b> </td>" +
                                       $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKeTheoThe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                       $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKeTheoThe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                       $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKeTheoThe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                       $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKeTheoThe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                       $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKeTheoThe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true)}</b> </td>" +
                                       "</tr>" +
                                       "</table>";
                }
            }
            else
            {
                YeuCauTiepNhanTheBHYT theBHYTChiTra = null;
                var maSoThe = groupChiPhiTheoThe.Where(o => o.Key != string.Empty).FirstOrDefault()?.Key;
                if (!string.IsNullOrEmpty(maSoThe))
                {
                    theBHYTChiTra = yeuCauTiepNhan.YeuCauTiepNhanTheBHYTs.First(o => o.MaSoThe == maSoThe);
                }

                var chiPhis = groupChiPhiTheoThe.SelectMany(o => o).ToList();
                var mucHuongPT = theBHYTChiTra != null && theBHYTChiTra?.MucHuong > 0 ? theBHYTChiTra?.MucHuong + "%" : string.Empty;

                dateItemChiPhis += "<table style='width: 100 %; '>" +
                                    "<tbody>" +
                                    "<tr>" +
                                       $"<td style='padding-left:-5px; width: 40 %; '>Mã thẻ BHYT: <b>{theBHYTChiTra?.MaSoThe}</b> " +
                                       $"<span style='padding-left:20px'>Giá trị từ: <b>{theBHYTChiTra?.NgayHieuLuc.ApplyFormatDate()}</b> đến <b>{theBHYTChiTra?.NgayHetHan?.ApplyFormatDate()}</b></span>" +
                                       $"<span style='padding-left:20px'>Mức hưởng: <b>{mucHuongPT}</b></span></td>" +
                                       "</tr>" +
                                    "</tbody>" +
                                    "</table>" +
                                    "</br>" +
                                    "<table style='width:100%;border: 1px solid #020000; border-collapse: collapse;'>" +
                                        "<tr style='border: 1px solid black;  border-collapse: collapse;'>" +
                                        "<th style='border: 1px solid #020000; border-collapse: collapse;text-align: center;' rowspan='2'>" +
                                                "STT </th>" +
                                            "<th style='border: 1px solid #020000; border-collapse: collapse;width:35%;text-align: center;' rowspan='2'>" +
                                                "Nội dung </th>" +
                                            "<th style='border: 1px solid #020000; border-collapse: collapse;width:5%;text-align: center;' rowspan='2'>" +
                                                "Đơn vị tính</th>" +
                                            "<th style='border: 1px solid #020000; border-collapse: collapse;width:3%; text-align: center;' rowspan='2'>" +
                                                "Số lượng</th>" +
                                            "<th style='border: 1px solid #020000; border-collapse: collapse;width:3%; text-align: center;' rowspan='2'>" +
                                                "Đơn giá BV <span style='font-weight: 100;'>(đồng)</span></th>" +
                                            "<th style='border: 1px solid #020000; border-collapse: collapse;width:3%; text-align: center;' rowspan='2'>" +
                                                "Đơn giá BH  <span style='font-weight: 100;'>(đồng)</span></th>" +
                                            "<th style='border: 1px solid #020000; border-collapse: collapse;width:200px; text-align: center;'" +
                                                "rowspan='2'>" +
                                                "Tỉ lệ thanh toán theo dich vụ   <span style='font-weight: 100;'>(%)</span></th>" +
                                            "<th style='border: 1px solid #020000; border-collapse: collapse;width:8%;text-align: center;' rowspan='2'>" +
                                                "Thành tiền BV  <span style='font-weight: 100;'>(đồng)</span>" +
                                            "</th>" +
                                            "<th style='border: 1px solid #020000; border-collapse: collapse;width:200px; text-align: center;'" +
                                                "rowspan='2'>" +
                                                "Tỷ lệ thanh toán BHYT <span style='font-weight: 100;'>(%)</span>" +
                                            "</th>" +
                                            "<th style='border: 1px solid #020000; border-collapse: collapse;width:8%;text-align: center;' rowspan='2'>" +
                                                "Thành tiền BH  <span style='font-weight: 100;'>(đồng)</span>" +
                                            "</th>" +
                                            "<th style='border: 1px solid #020000; border-collapse: collapse;width:35%;text-align: center;' colspan='4'>" +
                                                "Nguồn thanh toán  <span style='font-weight: 100;'>(đồng)</span></th>" +
                                        "</tr>" +
                                        "<tr style='border: 1px solid #020000; border-collapse: collapse;'>" +
                                            "<td style='border: 1px solid #020000; border-collapse: collapse;text-align: center;'><b>Quỹ BHYT</b></td>" +
                                            "<td style=' border: 1px solid #020000; border-collapse: collapse;width:80px;text-align: center;'>" +
                                                "<b>Người bệnh cùng chi " +
                                                " trả</b> (đồng)</td>" +
                                            "<td style=' border: 1px solid #020000; border-collapse: collapse;text-align: center;'><b>Khác</b> (đồng)</td>" +
                                            "<td style='border: 1px solid #020000; border-collapse: collapse;text-align: center;width: 90px;'>" +
                                                "<b>Người bệnh" +
                                                "tự trả </b>(đồng)" +
                                            "</td>" +
                                        "</tr>" +
                                        "<tr style=' border: 1px solid #020000; '>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b> </b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b>(1)</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b>(2)</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b>(3)</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b>(4)</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b>(5)</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b>(6)</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b>(7)</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b>(8)</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b>(9)</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b>(10)</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b>(11)</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b>(12)</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b>(13)</b> </td>" +
                                        "</tr>";


                //foreach (var chiPhi in chiPhis)
                //{
                //    dsChiPhiBangKe.Add(new BangKeKhamBenhBenhVienVo
                //    {
                //        Nhom = chiPhi.NhomChiPhiBangKe,
                //        Id = chiPhi.Id,
                //        NoiDung = chiPhi.TenDichVu,
                //        DonViTinh = chiPhi.DonViTinh,
                //        SoLuong = (decimal)chiPhi.Soluong,
                //        DuocHuongBaoHiem = chiPhi.DuocHuongBHYT,
                //        DonGiaBH = chiPhi.DuocHuongBHYT ? chiPhi.DonGiaBHYT : 0,
                //        MucHuongBaoHiem = chiPhi.MucHuongBaoHiem,
                //        TiLeThanhToanTheoDV = chiPhi.TiLeBaoHiemThanhToan,
                //        BaoHiemChiTra = true,
                //        DonGiaBV = chiPhi.DonGia
                //    });
                //}
                foreach (var chiPhi in chiPhis.Where(c => c.NhomChiPhiBangKe != NhomChiPhiBangKe.GoiVatTu && c.YeuCauGoiDichVuId == null).GroupBy(c => new { c.DonGia, c.SoTienMG, KhongTinhPhi = c.KhongTinhPhi.GetValueOrDefault(), c.NhomChiPhiBangKe, c.TenDichVu, c.DonViTinh, c.DuocHuongBHYT, c.DonGiaBHYT, c.MucHuongBaoHiem, c.TiLeBaoHiemThanhToan }).OrderByDescending(o => o.Key.DuocHuongBHYT))
                {
                    var chiphiBangKe = new BangKeKhamBenhBenhVienVo
                    {
                        Nhom = chiPhi.Key.NhomChiPhiBangKe,
                        Id = chiPhi.FirstOrDefault().Id,
                        NoiDung = chiPhi.Key.TenDichVu,
                        DonViTinh = chiPhi.Key.DonViTinh,
                        SoLuong = (decimal)chiPhi.Sum(c => c.Soluong),
                        DuocHuongBaoHiem = chiPhi.Key.DuocHuongBHYT,
                        DonGiaBH = chiPhi.Key.DuocHuongBHYT ? chiPhi.Key.DonGiaBHYT : 0,
                        MucHuongBaoHiem = chiPhi.Key.MucHuongBaoHiem,
                        TiLeThanhToanTheoDV = chiPhi.Key.TiLeBaoHiemThanhToan,
                        BaoHiemChiTra = true,
                        DonGiaBV = chiPhi.Key.DonGia
                    };
                    if (chiPhi.Key.KhongTinhPhi == true)
                    {
                        chiphiBangKe.Khac = chiPhi.Key.MucHuongBaoHiem > 0
                            ? (chiphiBangKe.ThanhTienBV.GetValueOrDefault() - chiphiBangKe.ThanhTienBH.GetValueOrDefault())
                            : chiphiBangKe.ThanhTienBV.GetValueOrDefault();
                    }
                    else
                    {
                        chiphiBangKe.Khac = chiPhi.Sum(c => c.SoTienMG);
                    }
                    dsChiPhiBangKe.Add(chiphiBangKe);
                }


                foreach (var chiPhi in chiPhis.Where(c => !(c.NhomChiPhiBangKe != NhomChiPhiBangKe.GoiVatTu && c.YeuCauGoiDichVuId == null)))
                {
                    var chiphiBangKe = new BangKeKhamBenhBenhVienVo
                    {
                        Nhom = chiPhi.NhomChiPhiBangKe,
                        Id = chiPhi.Id,
                        NoiDung = chiPhi.TenDichVu,
                        DonViTinh = chiPhi.DonViTinh,
                        SoLuong = (decimal)chiPhi.Soluong,
                        DuocHuongBaoHiem = chiPhi.DuocHuongBHYT,
                        DonGiaBH = chiPhi.DuocHuongBHYT ? chiPhi.DonGiaBHYT : 0,
                        MucHuongBaoHiem = chiPhi.MucHuongBaoHiem,
                        TiLeThanhToanTheoDV = chiPhi.TiLeBaoHiemThanhToan,
                        BaoHiemChiTra = true,
                        DonGiaBV = chiPhi.DonGia
                    };
                    if (chiPhi.KhongTinhPhi == true || chiPhi.YeuCauGoiDichVuId != null)
                    {
                        chiphiBangKe.Khac = chiPhi.MucHuongBaoHiem > 0
                            ? (chiphiBangKe.ThanhTienBV.GetValueOrDefault() - chiphiBangKe.ThanhTienBH.GetValueOrDefault())
                            : chiphiBangKe.ThanhTienBV.GetValueOrDefault();
                    }
                    else
                    {
                        chiphiBangKe.Khac = chiPhi.SoTienMG;
                    }
                    dsChiPhiBangKe.Add(chiphiBangKe);
                }
                var groupChiPhiBangKes = dsChiPhiBangKe.GroupBy(x => x.Nhom).OrderBy(o => (int)o.Key * (o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay || o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriNoiTru ? 1 : 10));
                foreach (var groupChiPhiBangKe in groupChiPhiBangKes)
                {
                    if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay)
                    {

                        dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                            "<td style='border: 1px solid #020000;' colspan='7'>" +
                                            "<span style='float:left;'><b>2. Ngày giường:  </b></span>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                            "</tr>";
                        dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                            "<td style='border: 1px solid #020000;' colspan='7'>" +
                                            "<span style='float:left;'><b>2.1." + groupChiPhiBangKe.Key.GetDescription() + "  </b></span>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b> " + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true) + "</b> </td>" +
                                            "</tr>";
                    }
                    else if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.NgayGiuongDieuTriNoiTru)
                    {
                        if (!groupChiPhiBangKes.Any(o => o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay))
                        {
                            dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                                "<td style='border: 1px solid #020000;' colspan='7'>" +
                                                "<span style='float:left;'><b>2. Ngày giường:  </b></span>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                "</tr>";
                        }
                        dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                            "<td style='border: 1px solid #020000;' colspan='7'>" +
                                            "<span style='float:left;'><b>2.2." + groupChiPhiBangKe.Key.GetDescription() + "  </b></span>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b> " + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true) + "</b> </td>" +
                                            "</tr>";
                    }
                    else
                    {
                        dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                            "<td style='border: 1px solid #020000;' colspan='7'>" +
                                            "<span style='float:left;'><b>" + (int)groupChiPhiBangKe.Key + "." + groupChiPhiBangKe.Key.GetDescription() + "  </b></span>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b> " + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true) + "</b> </td>" +
                                            "</tr>";
                    }
                    if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.GoiVatTu)
                    {
                        var groupGoiVatTus = groupChiPhiBangKe.ToList().GroupBy(o => o.SoGoiVatTu.GetValueOrDefault()).OrderBy(o => o.Key);
                        int sttGoiVatTu = 1;
                        foreach (var groupGoiVatTu in groupGoiVatTus)
                        {
                            dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                                "<td style='border: 1px solid #020000;' colspan='7'>" +
                                                "<span style='float:left;'><b>10." + sttGoiVatTu + ". " + groupChiPhiBangKe.Key.GetDescription() + " " + sttGoiVatTu + "  </b></span>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.Khac)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'><b> " + Convert.ToDouble(groupGoiVatTu.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true) + "</b> </td>" +
                                                "</tr>";
                            foreach (var chiPhiBangKe in groupGoiVatTu)
                            {
                                dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                                "<td style='border: 1px solid #020000; text-align: center;'> " + indexItem + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: left;'> " + chiPhiBangKe.NoiDung + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'>  " + chiPhiBangKe.DonViTinh + " </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'> " + chiPhiBangKe.SoLuong + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'> " + Convert.ToDouble(chiPhiBangKe.DonGiaBV).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'> " + Convert.ToDouble(chiPhiBangKe.DonGiaBH).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.TiLeThanhToanTheoDV).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.ThanhTienBV).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.MucHuongBaoHiem > 0 ? 100 : 0).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.ThanhTienBH).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.QuyBHYT).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.NguoiBenhCungChiTra).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.Khac).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.NguoiBenhTuTra).ApplyFormatMoneyToDouble(true) + "</td>" +
                                                "</tr>";
                                indexItem++;
                            }
                        }
                    }
                    else
                    {
                        foreach (var chiPhiBangKe in groupChiPhiBangKe)
                        {
                            dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                            "<td style='border: 1px solid #020000; text-align: center;'> " + indexItem + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: left;'> " + chiPhiBangKe.NoiDung + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'>  " + chiPhiBangKe.DonViTinh + " </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'> " + chiPhiBangKe.SoLuong + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'> " + Convert.ToDouble(chiPhiBangKe.DonGiaBV).ApplyFormatMoneyToDouble() + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'> " + Convert.ToDouble(chiPhiBangKe.DonGiaBH).ApplyFormatMoneyToDouble() + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.TiLeThanhToanTheoDV).ApplyFormatMoneyToDouble() + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.ThanhTienBV).ApplyFormatMoneyToDouble() + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.MucHuongBaoHiem > 0 ? 100 : 0).ApplyFormatMoneyToDouble() + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.ThanhTienBH).ApplyFormatMoneyToDouble() + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.QuyBHYT).ApplyFormatMoneyToDouble() + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.NguoiBenhCungChiTra).ApplyFormatMoneyToDouble() + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.Khac).ApplyFormatMoneyToDouble() + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.NguoiBenhTuTra).ApplyFormatMoneyToDouble(true) + "</td>" +
                                            "</tr>";
                            indexItem++;
                        }
                    }

                }

                dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                    "<td style='border: 1px solid #020000;' colspan='7'></span>" +
                                    "<span style='float:right;padding-right: 50px;'><b>Tổng Cộng</b></span>" +
                                    "</td>" +
                                    $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                    $"<td style='border: 1px solid #020000;text-align: right;'><b></b> </td>" +
                                    $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                    $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                    $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                    $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                    $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true)}</b> </td>" +
                                    "</tr>" +
                                    "</table>";

            }

            var checkedLyDoVaoVien = "<input id='demo_box_2' class='css - checkbox' type='checkbox' checked  disabled='true'/>";
            var unCheckedLyDoVaoVien = "<input id='demo_box_2' class='css - checkbox' type='checkbox' disabled='true' />";
            var khoaPhong = yeuCauTiepNhan.NoiTruBenhAn?.NoiTruKhoaPhongDieuTris.OrderByDescending(c => c.ThoiDiemVaoKhoa).Select(c => c.KhoaPhongChuyenDen).FirstOrDefault();

            var chuyenKhoa = GetChuyenKhoa(khoaPhong.Id); //BVHD-3792

            var data = new
            {
                TitleBangKe = "ĐIỀU TRỊ NỘI TRÚ",
                SoBangKe = "3",
                yeuCauTiepNhan.BenhNhan.MaBN,
                MaTN = yeuCauTiepNhan.MaYeuCauTiepNhan,
                SoBenhAn = "Số bệnh án: " + yeuCauTiepNhan.NoiTruBenhAn?.SoBenhAn,
                yeuCauTiepNhan.HoTen,
                DiaChi = yeuCauTiepNhan.DiaChiDayDu,
                BarCodeImgBase64 = !string.IsNullOrEmpty(yeuCauTiepNhan.MaYeuCauTiepNhan) ? BarcodeHelper.GenerateBarCode(yeuCauTiepNhan.MaYeuCauTiepNhan) : "",
                NamSinh = DateHelper.DOBFormat(yeuCauTiepNhan.NgaySinh, yeuCauTiepNhan.ThangSinh, yeuCauTiepNhan.NamSinh),
                GioiTinh = yeuCauTiepNhan.GioiTinh != null ? yeuCauTiepNhan.GioiTinh.GetDescription() : "",
                //TenKhoa = "Khoa: " + yeuCauTiepNhan.NoiTruBenhAn?.KhoaPhongNhapVien?.Ten,
                //MaKhoa = "Mã khoa: " + yeuCauTiepNhan.NoiTruBenhAn?.KhoaPhongNhapVien?.Ma,

                TenKhoa = "Khoa: " + khoaPhong.Ten,
                MaKhoa = "Mã khoa: " + chuyenKhoa?.Ma,

                MaBHYT = theBHYT?.MaSoThe,
                BHYTTuNgay = bHYTTuNgay,
                BHYTDenNgay = bHYTDenNgay,
                NoiDKKCBBanDau,
                MaKCBBanDau,
                NgayDenKham = yeuCauTiepNhan.YeuCauNhapVien?.YeuCauKhamBenh?.YeuCauTiepNhan.ThoiDiemTiepNhan.ApplyFormatGioPhutNgay(),
                DieuTriKNT = yeuCauTiepNhan.NoiTruBenhAn?.ThoiDiemNhapVien.ApplyFormatGioPhutNgay(),
                KetThucKhamNgoaiTru = yeuCauTiepNhan.NoiTruBenhAn?.ThoiDiemRaVien?.ApplyFormatGioPhutNgay(),
                SoNgayDTri = NoiTruBenhAnHelper.TinhSoNgayDieuTri(yeuCauTiepNhan.NoiTruBenhAn)?.ToString() ?? string.Empty,//yeuCauTiepNhan.NoiTruBenhAn?.ThoiDiemRaVien == null ? "" : (yeuCauTiepNhan.NoiTruBenhAn.ThoiDiemRaVien.Value.Date.AddDays(1) - yeuCauTiepNhan.NoiTruBenhAn.ThoiDiemNhapVien.Date).Days.ToString(),
                TinhTrangRaVien = yeuCauTiepNhan.NoiTruBenhAn?.TinhTrangRaVien == EnumTinhTrangRaVien.RaVien && (yeuCauTiepNhan.NoiTruBenhAn?.KetQuaDieuTri == EnumKetQuaDieuTri.Do || yeuCauTiepNhan.NoiTruBenhAn?.KetQuaDieuTri == EnumKetQuaDieuTri.Khoi) ? 1 : 2,
                MucHuong = mucHuong,
                NoiChuyenDen = yeuCauTiepNhan.NoiChuyen?.Ten,
                NoiChuyenDi = yeuCauTiepNhan.NoiTruBenhAn?.ChuyenDenBenhVien?.Ten,
                MKV = theBHYT?.MaKhuVuc,
                NgayMiemCungTC = theBHYT?.NgayDuocMienCungChiTra?.ApplyFormatDate(),
                ThoiGian5Nam = theBHYT?.NgayDu5Nam?.ApplyFormatDate(),
                CoCapCuu = yeuCauTiepNhan.LyDoVaoVien == Enums.EnumLyDoVaoVien.CapCuu ? checkedLyDoVaoVien : unCheckedLyDoVaoVien,
                CoDungTuyen = yeuCauTiepNhan.LyDoVaoVien == Enums.EnumLyDoVaoVien.DungTuyen ? checkedLyDoVaoVien : unCheckedLyDoVaoVien,
                CoThongTuyen = yeuCauTiepNhan.LyDoVaoVien == Enums.EnumLyDoVaoVien.ThongTuyen ? checkedLyDoVaoVien : unCheckedLyDoVaoVien,
                CoTraiTuyen = yeuCauTiepNhan.LyDoVaoVien == Enums.EnumLyDoVaoVien.TraiTuyen ? checkedLyDoVaoVien : unCheckedLyDoVaoVien,

                ChuanDoanXacDinh = yeuCauTiepNhan.NoiTruBenhAn != null && (yeuCauTiepNhan.NoiTruBenhAn.LoaiBenhAn == LoaiBenhAn.SanKhoaMo || yeuCauTiepNhan.NoiTruBenhAn.LoaiBenhAn == LoaiBenhAn.SanKhoaThuong) ? chuanDoanXacDinhSanKhoa : yeuCauTiepNhan.NoiTruBenhAn?.ChanDoanChinhRaVienGhiChu,
                MaICD10 = yeuCauTiepNhan.NoiTruBenhAn != null && (yeuCauTiepNhan.NoiTruBenhAn.LoaiBenhAn == LoaiBenhAn.SanKhoaMo || yeuCauTiepNhan.NoiTruBenhAn.LoaiBenhAn == LoaiBenhAn.SanKhoaThuong) ? maICD10 : yeuCauTiepNhan.NoiTruBenhAn?.ChanDoanChinhRaVienICD?.Ma,


                BenhKemTheo = tenICDKemTheo,
                ICDKemTheo10 = maICDKemTheo,

                DateItemChiPhis = dateItemChiPhis,

                TTDV = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble(),
                TTTTBHYT = "",

                TTTienBH = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble(),
                TQBHYT = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble(),
                TNCCTra = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble(),
                TongSoKhac = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble(),
                TNBTuTra = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true),

                TongChiPhi = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble(),
                SoTienBangChu = NumberHelper.ChuyenSoRaText(Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBV))),

                NguoiBenhPhaiTra = (Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)) + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhTuTra))).ApplyFormatMoneyToDouble(),

                TTQuyTT = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble(),
                BHYTChiTra = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble(),
                CacKhoanTraKhac = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true),
                SoTienKhac = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble(),
                NgayHienTai = DateTime.Now.ApplyFormatNgayThangNam(),
                Notice = "<div style='color: red; font-weight:800; margin-top:200px;'>Lưu ý : Người bệnh chưa quyết toán </div>"
            };

            var content = TemplateHelpper.FormatTemplateWithContentTemplate(result?.Body, data);
            return content;
        }

        //BVHD-3938 Thêm bảng kê ngoài gói
        public string GetHtmlBangKeNgoaiGoiChuaQuyetToan(long yeuCauTiepNhanId, string hostingName, List<ChiPhiKhamChuaBenhNoiTruVo> danhSachTatCaChiPhi)
        {
            var danhSachChiPhi = danhSachTatCaChiPhi.Where(o => o.YeuCauGoiDichVuId == null && o.TrangThaiThanhToan != TrangThaiThanhToan.DaThanhToan).ToList();
            if (danhSachChiPhi.Count == 0)
            {
                return string.Empty;
            }
            var yeuCauTiepNhan = BaseRepository.GetById(yeuCauTiepNhanId,
                x => x.Include(o => o.NoiTruBenhAn).ThenInclude(o => o.ChuyenDenBenhVien)
                    .Include(o => o.NoiTruBenhAn).ThenInclude(o => o.KhoaPhongNhapVien)
                    .Include(o => o.NoiTruBenhAn).ThenInclude(o => o.ChanDoanChinhRaVienICD)
                    .Include(o => o.YeuCauTiepNhanTheBHYTs)
                    .Include(o => o.YeuCauNhapVien).ThenInclude(o => o.YeuCauKhamBenh).ThenInclude(o => o.YeuCauTiepNhan)
                    .Include(o => o.BenhNhan)
                    .Include(o => o.PhuongXa)
                    .Include(o => o.QuanHuyen)
                    .Include(o => o.TinhThanh)
                    .Include(o => o.NoiTruBenhAn).ThenInclude(o => o.NoiTruPhieuDieuTris).ThenInclude(o => o.NoiTruThamKhamChanDoanKemTheos).ThenInclude(c => c.ICD)
                    .Include(o => o.NoiTruBenhAn).ThenInclude(o => o.NoiTruPhieuDieuTris).ThenInclude(c => c.ChanDoanChinhICD)
                    .Include(o => o.NoiChuyen).Include(o => o.NoiTruBenhAn).ThenInclude(o => o.NoiTruKhoaPhongDieuTris).ThenInclude(c => c.KhoaPhongChuyenDen));

            var result = _templateRepository.TableNoTracking.FirstOrDefault(x => x.Name.Equals("BangKeChiPhiNgoaiGoiKCB"));

            var benhVien = new Core.Domain.Entities.BenhVien.BenhVien();

            string maBHYT = string.Empty;
            string bHYTTuNgay = string.Empty;
            string bHYTDenNgay = string.Empty;
            string mucHuong = string.Empty;
            string NoiDKKCBBanDau = string.Empty;
            string MaKCBBanDau = string.Empty;


            string maICDKemTheo = string.Empty;
            string tenICDKemTheo = string.Empty;
            string chuanDoanXacDinhSanKhoa = string.Empty;
            string maICD10 = string.Empty;

            var ngayNhapVien = yeuCauTiepNhan.NoiTruBenhAn.ThoiDiemNhapVien.ApplyFormatDate();
            var ngayRaVien = yeuCauTiepNhan.NoiTruBenhAn.ThoiDiemRaVien?.ApplyFormatDate();

            if (yeuCauTiepNhan.NoiTruBenhAn != null && (yeuCauTiepNhan.NoiTruBenhAn.LoaiBenhAn == LoaiBenhAn.SanKhoaMo || yeuCauTiepNhan.NoiTruBenhAn.LoaiBenhAn == LoaiBenhAn.SanKhoaThuong))
            {
                if (yeuCauTiepNhan.NoiTruBenhAn?.NoiTruPhieuDieuTris.Count() > 0)
                {
                    var phieuDieuTri = yeuCauTiepNhan.NoiTruBenhAn?.NoiTruPhieuDieuTris.OrderByDescending(c => c.NgayDieuTri).FirstOrDefault();

                    var icdKemTheoIds = phieuDieuTri.NoiTruThamKhamChanDoanKemTheos.Select(c => c.ICD.Ma);
                    var tenICDKemTheos = phieuDieuTri.NoiTruThamKhamChanDoanKemTheos.Select(c => c.GhiChu);

                    maICDKemTheo = string.Join(", ", icdKemTheoIds);
                    tenICDKemTheo = string.Join(", ", tenICDKemTheos);

                    maICD10 = phieuDieuTri.ChanDoanChinhICD?.Ma;
                    chuanDoanXacDinhSanKhoa = phieuDieuTri.ChanDoanChinhGhiChu;
                }
            }
            else
            {
                if (!string.IsNullOrEmpty(yeuCauTiepNhan.NoiTruBenhAn?.DanhSachChanDoanKemTheoRaVienICDId))
                {
                    var maICDKemTheos = new List<string>();

                    var icdKemTheoIds = yeuCauTiepNhan.NoiTruBenhAn?.DanhSachChanDoanKemTheoRaVienICDId.Split(Constants.ICDSeparator);
                    var tenICDKemTheos = yeuCauTiepNhan.NoiTruBenhAn?.DanhSachChanDoanKemTheoRaVienGhiChu?.Split(Constants.ICDSeparator);

                    if (icdKemTheoIds.Length > 0)
                    {
                        foreach (var icdKemTheoId in icdKemTheoIds)
                        {
                            var icdKemTheo = _icdRepository.TableNoTracking.FirstOrDefault(o => o.Id == long.Parse(icdKemTheoId));
                            if (icdKemTheo != null)
                            {
                                maICDKemTheos.Add(icdKemTheo.Ma);
                            }

                            //if (long.TryParse(yeuCauTiepNhan.NoiTruBenhAn?.DanhSachChanDoanKemTheoRaVienICDId.Split(Constants.ICDSeparator).First(), out var icdKemTheoId))
                            //{
                            //    var icdKemTheo = _icdRepository.TableNoTracking.FirstOrDefault(o => o.Id == icdKemTheoId);
                            //    if (icdKemTheo != null)
                            //    {
                            //        maICDKemTheo = icdKemTheo.Ma;
                            //        tenICDKemTheo = yeuCauTiepNhan.NoiTruBenhAn?.DanhSachChanDoanKemTheoRaVienGhiChu?.Split(Constants.ICDSeparator).First();
                            //    }
                            //}
                        }
                    }

                    maICDKemTheo = string.Join(", ", maICDKemTheos);
                    tenICDKemTheo = string.Join(", ", tenICDKemTheos);
                }
            }

            YeuCauTiepNhanTheBHYT theBHYT = null;
            if (yeuCauTiepNhan.CoBHYT == true && yeuCauTiepNhan.YeuCauTiepNhanTheBHYTs.Any())
            {
                theBHYT = yeuCauTiepNhan.YeuCauTiepNhanTheBHYTs.First();
                if (!String.IsNullOrEmpty(theBHYT.MaDKBD))
                {
                    benhVien = _benhVienRepository.TableNoTracking.FirstOrDefault(p => p.Ma.Equals(theBHYT.MaDKBD));
                }
                maBHYT = theBHYT.MaSoThe;
                bHYTTuNgay = theBHYT.NgayHieuLuc.ApplyFormatDate();
                bHYTDenNgay = theBHYT.NgayHetHan?.ApplyFormatDate();
                mucHuong = theBHYT.MucHuong.ToString() + "%";
                NoiDKKCBBanDau = benhVien != null ? benhVien?.Ten : "Chưa xác định";
                MaKCBBanDau = theBHYT.MaDKBD;
            }
            else
            {
                maBHYT = "";
                bHYTTuNgay = "";
                bHYTDenNgay = "";
                mucHuong = "0%";
                NoiDKKCBBanDau = "Chưa xác định";
                MaKCBBanDau = "Chưa xác định";
            }

            var dsChiPhiBangKe = new List<BangKeKhamBenhBenhVienVo>();
            var dateItemChiPhis = string.Empty;
            int indexItem = 1;
            var groupChiPhiTheoThe = danhSachChiPhi.GroupBy(o => o.MaSoTheBHYT);
            if (groupChiPhiTheoThe.Count() > 2 ||
                (groupChiPhiTheoThe.All(o => o.Key != string.Empty) && groupChiPhiTheoThe.Count() > 1))
            {
                var groupNgayPhatSinhTheoThe = groupChiPhiTheoThe.Where(o => o.Key != string.Empty).Select(o => new { o.Key, o.OrderBy(j => j.NgayPhatSinh).First().NgayPhatSinh }).OrderBy(o => o.NgayPhatSinh).ToArray();
                for (int i = 0; i < groupNgayPhatSinhTheoThe.Count(); i++)
                {
                    var ngayPhatSinhTheoThe = groupNgayPhatSinhTheoThe[i];
                    var theBHYTChiTra = yeuCauTiepNhan.YeuCauTiepNhanTheBHYTs.First(o => o.MaSoThe == ngayPhatSinhTheoThe.Key);
                    var chiPhis = groupChiPhiTheoThe.FirstOrDefault(o => o.Key == ngayPhatSinhTheoThe.Key).ToList();
                    DateTime? ngayPhatSinhTiepTheo = i < groupNgayPhatSinhTheoThe.Count() - 1
                        ? groupNgayPhatSinhTheoThe[i + 1].NgayPhatSinh
                        : null;
                    chiPhis.AddRange(groupChiPhiTheoThe.FirstOrDefault(o => o.Key == string.Empty).Where(j => (i == 0 || j.NgayPhatSinh >= ngayPhatSinhTheoThe.NgayPhatSinh) && (ngayPhatSinhTiepTheo != null && j.NgayPhatSinh < ngayPhatSinhTiepTheo)).ToList());
                    var mucHuongPT = theBHYTChiTra != null && theBHYTChiTra.MucHuong > 0 ? theBHYTChiTra?.MucHuong + "%" : string.Empty;

                    dateItemChiPhis += "<table style='width: 100 %; '>" +
                                       "<tbody>" +
                                       "<tr>" +
                                       $"<td style='padding-left:-5px; width: 40 %; '>Mã thẻ BHYT {i + 1}: <b>{theBHYTChiTra.MaSoThe}</b> " +
                                       $"<span style='padding-left:20px'>Giá trị từ: <b>{theBHYTChiTra.NgayHieuLuc.ApplyFormatDate()}</b> đến <b>{theBHYTChiTra.NgayHetHan?.ApplyFormatDate()}</b></span>" +
                                       $"<span style='padding-left:20px'>Mức hưởng: <b>{mucHuongPT}</b></span></td>" +
                                       "</tr>" +

                                      //Thêm dòng: (Chi phí KCB tính từ ngày...đến ngày...) BVHD-3792
                                      "<tr>" +
                                       $"<td>" +
                                       $"<span> (Chi phí KCB tính từ ngày <b>{ngayNhapVien}</b> đến ngày <b>{ngayRaVien}</b>) </span></td>" +
                                      "</tr>" +

                                       "</tbody>" +
                                       "</table>" +
                                       "</br>" +
                                       "<table style='width:100%;border: 1px solid #020000; border-collapse: collapse;'>" +
                                            "<tr style='border: 1px solid black;  border-collapse: collapse;'>" +
                                            "<th style='border: 1px solid #020000; border-collapse: collapse;text-align: center;' rowspan='2'>" +
                                                    "STT </th>" +
                                                "<th style='border: 1px solid #020000; border-collapse: collapse;width:35%;text-align: center;' rowspan='2'>" +
                                                    "Nội dung </th>" +
                                                "<th style='border: 1px solid #020000; border-collapse: collapse;width:5%;text-align: center;' rowspan='2'>" +
                                                    "Đơn vị tính</th>" +
                                                "<th style='border: 1px solid #020000; border-collapse: collapse;width:3%; text-align: center;' rowspan='2'>" +
                                                    "Số lượng</th>" +
                                                "<th style='border: 1px solid #020000; border-collapse: collapse;width:3%; text-align: center;' rowspan='2'>" +
                                                    "Đơn giá BV <span style='font-weight: 100;'>(đồng)</span></th>" +
                                                "<th style='border: 1px solid #020000; border-collapse: collapse;width:3%; text-align: center;' rowspan='2'>" +
                                                    "Đơn giá BH  <span style='font-weight: 100;'>(đồng)</span></th>" +
                                                "<th style='border: 1px solid #020000; border-collapse: collapse;width:200px; text-align: center;'" +
                                                    "rowspan='2'>" +
                                                    "Tỉ lệ thanh toán theo dich vụ   <span style='font-weight: 100;'>(%)</span></th>" +
                                                "<th style='border: 1px solid #020000; border-collapse: collapse;width:8%;text-align: center;' rowspan='2'>" +
                                                    "Thành tiền BV  <span style='font-weight: 100;'>(đồng)</span>" +
                                                "</th>" +
                                                "<th style='border: 1px solid #020000; border-collapse: collapse;width:200px; text-align: center;'" +
                                                    "rowspan='2'>" +
                                                    "Tỷ lệ thanh toán BHYT <span style='font-weight: 100;'>(%)</span>" +
                                                "</th>" +
                                                "<th style='border: 1px solid #020000; border-collapse: collapse;width:8%;text-align: center;' rowspan='2'>" +
                                                    "Thành tiền BH  <span style='font-weight: 100;'>(đồng)</span>" +
                                                "</th>" +
                                                "<th style='border: 1px solid #020000; border-collapse: collapse;width:35%;text-align: center;' colspan='4'>" +
                                                    "Nguồn thanh toán  <span style='font-weight: 100;'>(đồng)</span></th>" +
                                            "</tr>" +
                                            "<tr style='border: 1px solid #020000; border-collapse: collapse;'>" +
                                                "<td style='border: 1px solid #020000; border-collapse: collapse;text-align: center;'><b>Quỹ BHYT</b></td>" +
                                                "<td style=' border: 1px solid #020000; border-collapse: collapse;width:80px;text-align: center;'>" +
                                                    "<b>Người bệnh cùng chi" +
                                                    " trả</b> (đồng)</td>" +
                                                "<td style=' border: 1px solid #020000; border-collapse: collapse;text-align: center;'><b>Khác</b> (đồng)</td>" +
                                                "<td style='border: 1px solid #020000; border-collapse: collapse;text-align: center;width: 90px;'>" +
                                                    "<b>Người bệnh" +
                                                    "tự trả </b>(đồng)" +
                                                "</td>" +
                                            "</tr>" +
                                            "<tr style=' border: 1px solid #020000; '>" +
                                              "<td style='border: 1px solid #020000;text-align: center;'><b> </b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(1)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(2)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(3)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(4)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(5)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(6)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(7)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(8)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(9)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(10)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(11)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(12)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(13)</b> </td>" +
                                            "</tr>";


                    var dsChiPhiBangKeTheoThe = new List<BangKeKhamBenhBenhVienVo>();

                    foreach (var chiPhi in chiPhis.Where(c => c.NhomChiPhiBangKe != NhomChiPhiBangKe.GoiVatTu && c.YeuCauGoiDichVuId == null).GroupBy(c => new { c.DonGia, c.SoTienMG, KhongTinhPhi = c.KhongTinhPhi.GetValueOrDefault(), c.NhomChiPhiBangKe, c.TenDichVu, c.DonViTinh, c.DuocHuongBHYT, c.DonGiaBHYT, c.MucHuongBaoHiem, c.TiLeBaoHiemThanhToan }).OrderByDescending(o => o.Key.DuocHuongBHYT))
                    {
                        var chiphiBangKe = new BangKeKhamBenhBenhVienVo
                        {
                            Nhom = chiPhi.Key.NhomChiPhiBangKe,
                            Id = chiPhi.FirstOrDefault().Id,
                            NoiDung = chiPhi.Key.TenDichVu,
                            DonViTinh = chiPhi.Key.DonViTinh,
                            SoLuong = (decimal)chiPhi.Sum(c => c.Soluong),
                            DuocHuongBaoHiem = chiPhi.Key.DuocHuongBHYT,
                            //BẢNG KÊ CHI TIẾT ĐIỀU TRỊ NỘI TRÚ (Ngoài gói) DonGiaBH mặc định = 0
                            DonGiaBH = 0,
                            MucHuongBaoHiem = 0,
                            TiLeThanhToanTheoDV = 0,
                            BaoHiemChiTra = true,
                            DonGiaBV = chiPhi.Key.DonGia
                        };
                        if (chiPhi.Key.KhongTinhPhi == true)
                        {
                            chiphiBangKe.Khac = chiPhi.Key.MucHuongBaoHiem > 0
                                ? (chiphiBangKe.ThanhTienBV.GetValueOrDefault() - chiphiBangKe.ThanhTienBH.GetValueOrDefault())
                                : chiphiBangKe.ThanhTienBV.GetValueOrDefault();
                        }
                        else
                        {
                            chiphiBangKe.Khac = chiPhi.Sum(c => c.SoTienMG);
                        }
                        dsChiPhiBangKeTheoThe.Add(chiphiBangKe);
                    }

                    foreach (var chiPhi in chiPhis.Where(c => !(c.NhomChiPhiBangKe != NhomChiPhiBangKe.GoiVatTu && c.YeuCauGoiDichVuId == null)))
                    {
                        var chiphiBangKe = new BangKeKhamBenhBenhVienVo
                        {
                            Nhom = chiPhi.NhomChiPhiBangKe,
                            Id = chiPhi.Id,
                            NoiDung = chiPhi.TenDichVu,
                            DonViTinh = chiPhi.DonViTinh,
                            SoLuong = (decimal)chiPhi.Soluong,
                            DuocHuongBaoHiem = chiPhi.DuocHuongBHYT,
                            //BẢNG KÊ CHI TIẾT ĐIỀU TRỊ NỘI TRÚ (Ngoài gói) DonGiaBH mặc định = 0
                            DonGiaBH = 0,
                            MucHuongBaoHiem = 0,
                            TiLeThanhToanTheoDV = 0,
                            BaoHiemChiTra = true,
                            DonGiaBV = chiPhi.DonGia
                        };
                        if (chiPhi.KhongTinhPhi == true || chiPhi.YeuCauGoiDichVuId != null)
                        {
                            chiphiBangKe.Khac = chiPhi.MucHuongBaoHiem > 0
                                ? (chiphiBangKe.ThanhTienBV.GetValueOrDefault() - chiphiBangKe.ThanhTienBH.GetValueOrDefault())
                                : chiphiBangKe.ThanhTienBV.GetValueOrDefault();
                        }
                        else
                        {
                            chiphiBangKe.Khac = chiPhi.SoTienMG;
                        }
                        dsChiPhiBangKeTheoThe.Add(chiphiBangKe);
                    }
                    dsChiPhiBangKe.AddRange(dsChiPhiBangKeTheoThe);
                    var groupChiPhiBangKes = dsChiPhiBangKeTheoThe.GroupBy(x => x.Nhom).OrderBy(o => (int)o.Key * (o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay || o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriNoiTru ? 1 : 10));
                    foreach (var groupChiPhiBangKe in groupChiPhiBangKes)
                    {
                        if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay)
                        {

                            dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                               "<td style='border: 1px solid #020000;' colspan='7'>" +
                                               "<span style='float:left;'><b>2. Ngày giường:  </b></span>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                               "</tr>";
                            dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                               "<td style='border: 1px solid #020000;' colspan='7'>" +
                                               "<span style='float:left;'><b>2.1." + groupChiPhiBangKe.Key.GetDescription() + "  </b></span>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b> " + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true) + "</b> </td>" +
                                               "</tr>";
                        }
                        else if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.NgayGiuongDieuTriNoiTru)
                        {
                            if (!groupChiPhiBangKes.Any(o => o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay))
                            {
                                dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                                   "<td style='border: 1px solid #020000;' colspan='7'>" +
                                                   "<span style='float:left;'><b>2. Ngày giường:  </b></span>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                   "</tr>";
                            }
                            dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                               "<td style='border: 1px solid #020000;' colspan='7'>" +
                                               "<span style='float:left;'><b>2.2." + groupChiPhiBangKe.Key.GetDescription() + "  </b></span>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b> " + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true) + "</b> </td>" +
                                               "</tr>";
                        }
                        else
                        {
                            dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                               "<td style='border: 1px solid #020000;' colspan='7'>" +
                                               "<span style='float:left;'><b>" + (int)groupChiPhiBangKe.Key + "." + groupChiPhiBangKe.Key.GetDescription() + "  </b></span>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                               "<td style='border: 1px solid #020000;text-align: right;'><b> " + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true) + "</b> </td>" +
                                               "</tr>";
                        }
                        if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.GoiVatTu)
                        {
                            var groupGoiVatTus = groupChiPhiBangKe.ToList().GroupBy(o => o.SoGoiVatTu.GetValueOrDefault()).OrderBy(o => o.Key);
                            int sttGoiVatTu = 1;
                            foreach (var groupGoiVatTu in groupGoiVatTus)
                            {
                                dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                                   "<td style='border: 1px solid #020000;' colspan='7'>" +
                                                   "<span style='float:left;'><b>10." + sttGoiVatTu + ". " + groupChiPhiBangKe.Key.GetDescription() + " " + sttGoiVatTu + "  </b></span>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.Khac)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'><b> " + Convert.ToDouble(groupGoiVatTu.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true) + "</b> </td>" +
                                                   "</tr>";
                                foreach (var chiPhiBangKe in groupGoiVatTu)
                                {
                                    dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                                    "<td style='border: 1px solid #020000; text-align: center;'> " + indexItem + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: left;'> " + chiPhiBangKe.NoiDung + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: center;'>  " + chiPhiBangKe.DonViTinh + " </td>" +
                                                    "<td style='border: 1px solid #020000;text-align: center;'> " + chiPhiBangKe.SoLuong + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: center;'> " + Convert.ToDouble(chiPhiBangKe.DonGiaBV).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: center;'> " + Convert.ToDouble(chiPhiBangKe.DonGiaBH).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.TiLeThanhToanTheoDV).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.ThanhTienBV).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.MucHuongBaoHiem > 0 ? 100 : 0).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.ThanhTienBH).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.QuyBHYT).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.NguoiBenhCungChiTra).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.Khac).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.NguoiBenhTuTra).ApplyFormatMoneyToDouble(true) + "</td>" +
                                                    "</tr>";
                                    indexItem++;
                                }
                            }
                        }
                        else
                        {
                            foreach (var chiPhiBangKe in groupChiPhiBangKe)
                            {
                                dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                                "<td style='border: 1px solid #020000; text-align: center;'> " + indexItem + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: left;'> " + chiPhiBangKe.NoiDung + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'>  " + chiPhiBangKe.DonViTinh + " </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'> " + chiPhiBangKe.SoLuong + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'> " + Convert.ToDouble(chiPhiBangKe.DonGiaBV).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'> " + Convert.ToDouble(chiPhiBangKe.DonGiaBH).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.TiLeThanhToanTheoDV).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.ThanhTienBV).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.MucHuongBaoHiem > 0 ? 100 : 0).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.ThanhTienBH).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.QuyBHYT).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.NguoiBenhCungChiTra).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.Khac).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.NguoiBenhTuTra).ApplyFormatMoneyToDouble(true) + "</td>" +
                                                "</tr>";
                                indexItem++;
                            }
                        }

                    }

                    dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                       "<td style='border: 1px solid #020000;' colspan='7'></span>" +
                                       "<span style='float:right;padding-right: 50px;'><b>Tổng Cộng</b></span>" +
                                       "</td>" +
                                       $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKeTheoThe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                       $"<td style='border: 1px solid #020000;text-align: right;'><b></b> </td>" +
                                       $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKeTheoThe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                       $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKeTheoThe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                       $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKeTheoThe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                       $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKeTheoThe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                       $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKeTheoThe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true)}</b> </td>" +
                                       "</tr>" +
                                       "</table>";
                }
            }
            else
            {
                YeuCauTiepNhanTheBHYT theBHYTChiTra = null;
                var maSoThe = groupChiPhiTheoThe.Where(o => o.Key != string.Empty).FirstOrDefault()?.Key;
                if (!string.IsNullOrEmpty(maSoThe))
                {
                    theBHYTChiTra = yeuCauTiepNhan.YeuCauTiepNhanTheBHYTs.First(o => o.MaSoThe == maSoThe);
                }

                var chiPhis = groupChiPhiTheoThe.SelectMany(o => o).ToList();
                var mucHuongPT = theBHYTChiTra != null && theBHYTChiTra?.MucHuong > 0 ? theBHYTChiTra?.MucHuong + "%" : string.Empty;

                dateItemChiPhis += "<table style='width: 100 %; '>" +
                                    "<tbody>" +
                                    "<tr>" +
                                       $"<td style='padding-left:-5px; width: 40 %; '>Mã thẻ BHYT: <b>{theBHYTChiTra?.MaSoThe}</b> " +
                                       $"<span style='padding-left:20px'>Giá trị từ: <b>{theBHYTChiTra?.NgayHieuLuc.ApplyFormatDate()}</b> đến <b>{theBHYTChiTra?.NgayHetHan?.ApplyFormatDate()}</b></span>" +
                                       $"<span style='padding-left:20px'>Mức hưởng: <b>{mucHuongPT}</b></span></td>" +
                                       "</tr>" +
                                      //Thêm dòng: (Chi phí KCB tính từ ngày...đến ngày...) BVHD-3792
                                      "<tr>" +
                                       $"<td>" +
                                       $"<span> (Chi phí KCB tính từ ngày <b>{ngayNhapVien}</b> đến ngày <b>{ngayRaVien}</b>) </span></td>" +
                                      "</tr>" +

                                    "</tbody>" +
                                    "</table>" +
                                    "</br>" +
                                    "<table style='width:100%;border: 1px solid #020000; border-collapse: collapse;'>" +
                                        "<tr style='border: 1px solid black;  border-collapse: collapse;'>" +
                                        "<th style='border: 1px solid #020000; border-collapse: collapse;text-align: center;' rowspan='2'>" +
                                                "STT </th>" +
                                            "<th style='border: 1px solid #020000; border-collapse: collapse;width:35%;text-align: center;' rowspan='2'>" +
                                                "Nội dung </th>" +
                                            "<th style='border: 1px solid #020000; border-collapse: collapse;width:5%;text-align: center;' rowspan='2'>" +
                                                "Đơn vị tính</th>" +
                                            "<th style='border: 1px solid #020000; border-collapse: collapse;width:3%; text-align: center;' rowspan='2'>" +
                                                "Số lượng</th>" +
                                            "<th style='border: 1px solid #020000; border-collapse: collapse;width:3%; text-align: center;' rowspan='2'>" +
                                                "Đơn giá BV <span style='font-weight: 100;'>(đồng)</span></th>" +
                                            "<th style='border: 1px solid #020000; border-collapse: collapse;width:3%; text-align: center;' rowspan='2'>" +
                                                "Đơn giá BH  <span style='font-weight: 100;'>(đồng)</span></th>" +
                                            "<th style='border: 1px solid #020000; border-collapse: collapse;width:200px; text-align: center;'" +
                                                "rowspan='2'>" +
                                                "Tỉ lệ thanh toán theo dich vụ   <span style='font-weight: 100;'>(%)</span></th>" +
                                            "<th style='border: 1px solid #020000; border-collapse: collapse;width:8%;text-align: center;' rowspan='2'>" +
                                                "Thành tiền BV  <span style='font-weight: 100;'>(đồng)</span>" +
                                            "</th>" +
                                            "<th style='border: 1px solid #020000; border-collapse: collapse;width:200px; text-align: center;'" +
                                                "rowspan='2'>" +
                                                "Tỷ lệ thanh toán BHYT <span style='font-weight: 100;'>(%)</span>" +
                                            "</th>" +
                                            "<th style='border: 1px solid #020000; border-collapse: collapse;width:8%;text-align: center;' rowspan='2'>" +
                                                "Thành tiền BH  <span style='font-weight: 100;'>(đồng)</span>" +
                                            "</th>" +
                                            "<th style='border: 1px solid #020000; border-collapse: collapse;width:35%;text-align: center;' colspan='4'>" +
                                                "Nguồn thanh toán  <span style='font-weight: 100;'>(đồng)</span></th>" +
                                        "</tr>" +
                                        "<tr style='border: 1px solid #020000; border-collapse: collapse;'>" +
                                            "<td style='border: 1px solid #020000; border-collapse: collapse;text-align: center;'><b>Quỹ BHYT</b></td>" +
                                            "<td style=' border: 1px solid #020000; border-collapse: collapse;width:80px;text-align: center;'>" +
                                                "<b>Người bệnh cùng chi " +
                                                " trả</b> (đồng)</td>" +
                                            "<td style=' border: 1px solid #020000; border-collapse: collapse;text-align: center;'><b>Khác</b> (đồng)</td>" +
                                            "<td style='border: 1px solid #020000; border-collapse: collapse;text-align: center;width: 90px;'>" +
                                                "<b>Người bệnh" +
                                                "tự trả </b>(đồng)" +
                                            "</td>" +
                                        "</tr>" +
                                        "<tr style=' border: 1px solid #020000; '>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b> </b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b>(1)</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b>(2)</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b>(3)</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b>(4)</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b>(5)</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b>(6)</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b>(7)</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b>(8)</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b>(9)</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b>(10)</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b>(11)</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b>(12)</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'><b>(13)</b> </td>" +
                                        "</tr>";


                foreach (var chiPhi in chiPhis.Where(c => c.NhomChiPhiBangKe != NhomChiPhiBangKe.GoiVatTu && c.YeuCauGoiDichVuId == null).GroupBy(c => new { c.DonGia, c.SoTienMG, KhongTinhPhi = c.KhongTinhPhi.GetValueOrDefault(), c.NhomChiPhiBangKe, c.TenDichVu, c.DonViTinh, c.DuocHuongBHYT, c.DonGiaBHYT, c.MucHuongBaoHiem, c.TiLeBaoHiemThanhToan }).OrderByDescending(o => o.Key.DuocHuongBHYT))
                {
                    var chiphiBangKe = new BangKeKhamBenhBenhVienVo
                    {
                        Nhom = chiPhi.Key.NhomChiPhiBangKe,
                        Id = chiPhi.FirstOrDefault().Id,
                        NoiDung = chiPhi.Key.TenDichVu,
                        DonViTinh = chiPhi.Key.DonViTinh,
                        SoLuong = (decimal)chiPhi.Sum(c => c.Soluong),
                        DuocHuongBaoHiem = chiPhi.Key.DuocHuongBHYT,
                        //BẢNG KÊ CHI TIẾT ĐIỀU TRỊ NỘI TRÚ (Ngoài gói) DonGiaBH mặc định = 0
                        DonGiaBH = 0,
                        MucHuongBaoHiem = 0,
                        TiLeThanhToanTheoDV = 0,
                        BaoHiemChiTra = true,
                        DonGiaBV = chiPhi.Key.DonGia
                    };
                    if (chiPhi.Key.KhongTinhPhi == true)
                    {
                        chiphiBangKe.Khac = chiPhi.Key.MucHuongBaoHiem > 0
                            ? (chiphiBangKe.ThanhTienBV.GetValueOrDefault() - chiphiBangKe.ThanhTienBH.GetValueOrDefault())
                            : chiphiBangKe.ThanhTienBV.GetValueOrDefault();
                    }
                    else
                    {
                        chiphiBangKe.Khac = chiPhi.Sum(c => c.SoTienMG);
                    }
                    dsChiPhiBangKe.Add(chiphiBangKe);
                }

                foreach (var chiPhi in chiPhis.Where(c => !(c.NhomChiPhiBangKe != NhomChiPhiBangKe.GoiVatTu && c.YeuCauGoiDichVuId == null)))
                {
                    var chiphiBangKe = new BangKeKhamBenhBenhVienVo
                    {
                        Nhom = chiPhi.NhomChiPhiBangKe,
                        Id = chiPhi.Id,
                        NoiDung = chiPhi.TenDichVu,
                        DonViTinh = chiPhi.DonViTinh,
                        SoLuong = (decimal)chiPhi.Soluong,
                        DuocHuongBaoHiem = chiPhi.DuocHuongBHYT,
                        //BẢNG KÊ CHI TIẾT ĐIỀU TRỊ NỘI TRÚ (Ngoài gói) DonGiaBH mặc định = 0
                        DonGiaBH = 0,
                        MucHuongBaoHiem = 0,
                        TiLeThanhToanTheoDV = 0,
                        BaoHiemChiTra = true,
                        DonGiaBV = chiPhi.DonGia
                    };
                    if (chiPhi.KhongTinhPhi == true || chiPhi.YeuCauGoiDichVuId != null)
                    {
                        chiphiBangKe.Khac = chiPhi.MucHuongBaoHiem > 0
                            ? (chiphiBangKe.ThanhTienBV.GetValueOrDefault() - chiphiBangKe.ThanhTienBH.GetValueOrDefault())
                            : chiphiBangKe.ThanhTienBV.GetValueOrDefault();
                    }
                    else
                    {
                        chiphiBangKe.Khac = chiPhi.SoTienMG;
                    }
                    dsChiPhiBangKe.Add(chiphiBangKe);
                }

                var groupChiPhiBangKes = dsChiPhiBangKe.GroupBy(x => x.Nhom).OrderBy(o => (int)o.Key * (o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay || o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriNoiTru ? 1 : 10));
                foreach (var groupChiPhiBangKe in groupChiPhiBangKes)
                {
                    if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay)
                    {

                        dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                            "<td style='border: 1px solid #020000;' colspan='7'>" +
                                            "<span style='float:left;'><b>2. Ngày giường:  </b></span>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                            "</tr>";
                        dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                            "<td style='border: 1px solid #020000;' colspan='7'>" +
                                            "<span style='float:left;'><b>2.1." + groupChiPhiBangKe.Key.GetDescription() + "  </b></span>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b> " + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true) + "</b> </td>" +
                                            "</tr>";
                    }
                    else if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.NgayGiuongDieuTriNoiTru)
                    {
                        if (!groupChiPhiBangKes.Any(o => o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay))
                        {
                            dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                                "<td style='border: 1px solid #020000;' colspan='7'>" +
                                                "<span style='float:left;'><b>2. Ngày giường:  </b></span>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                "</tr>";
                        }
                        dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                            "<td style='border: 1px solid #020000;' colspan='7'>" +
                                            "<span style='float:left;'><b>2.2." + groupChiPhiBangKe.Key.GetDescription() + "  </b></span>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b> " + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true) + "</b> </td>" +
                                            "</tr>";
                    }
                    else
                    {
                        dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                            "<td style='border: 1px solid #020000;' colspan='7'>" +
                                            "<span style='float:left;'><b>" + (int)groupChiPhiBangKe.Key + "." + groupChiPhiBangKe.Key.GetDescription() + "  </b></span>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b> " + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true) + "</b> </td>" +
                                            "</tr>";
                    }
                    if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.GoiVatTu)
                    {
                        var groupGoiVatTus = groupChiPhiBangKe.ToList().GroupBy(o => o.SoGoiVatTu.GetValueOrDefault()).OrderBy(o => o.Key);
                        int sttGoiVatTu = 1;
                        foreach (var groupGoiVatTu in groupGoiVatTus)
                        {
                            dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                                "<td style='border: 1px solid #020000;' colspan='7'>" +
                                                "<span style='float:left;'><b>10." + sttGoiVatTu + ". " + groupChiPhiBangKe.Key.GetDescription() + " " + sttGoiVatTu + "  </b></span>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.Khac)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'><b> " + Convert.ToDouble(groupGoiVatTu.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true) + "</b> </td>" +
                                                "</tr>";
                            foreach (var chiPhiBangKe in groupGoiVatTu)
                            {
                                dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                                "<td style='border: 1px solid #020000; text-align: center;'> " + indexItem + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: left;'> " + chiPhiBangKe.NoiDung + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'>  " + chiPhiBangKe.DonViTinh + " </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'> " + chiPhiBangKe.SoLuong + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'> " + Convert.ToDouble(chiPhiBangKe.DonGiaBV).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'> " + Convert.ToDouble(chiPhiBangKe.DonGiaBH).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.TiLeThanhToanTheoDV).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.ThanhTienBV).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.MucHuongBaoHiem > 0 ? 100 : 0).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.ThanhTienBH).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.QuyBHYT).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.NguoiBenhCungChiTra).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.Khac).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.NguoiBenhTuTra).ApplyFormatMoneyToDouble(true) + "</td>" +
                                                "</tr>";
                                indexItem++;
                            }
                        }
                    }
                    else
                    {

                        foreach (var chiPhiBangKe in groupChiPhiBangKe)
                        {
                            dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                            "<td style='border: 1px solid #020000; text-align: center;'> " + indexItem + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: left;'> " + chiPhiBangKe.NoiDung + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'>  " + chiPhiBangKe.DonViTinh + " </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'> " + chiPhiBangKe.SoLuong + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'> " + Convert.ToDouble(chiPhiBangKe.DonGiaBV).ApplyFormatMoneyToDouble() + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'> " + Convert.ToDouble(chiPhiBangKe.DonGiaBH).ApplyFormatMoneyToDouble() + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.TiLeThanhToanTheoDV).ApplyFormatMoneyToDouble() + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.ThanhTienBV).ApplyFormatMoneyToDouble() + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.MucHuongBaoHiem > 0 ? 100 : 0).ApplyFormatMoneyToDouble() + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.ThanhTienBH).ApplyFormatMoneyToDouble() + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.QuyBHYT).ApplyFormatMoneyToDouble() + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.NguoiBenhCungChiTra).ApplyFormatMoneyToDouble() + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.Khac).ApplyFormatMoneyToDouble() + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.NguoiBenhTuTra).ApplyFormatMoneyToDouble(true) + "</td>" +
                                            "</tr>";
                            indexItem++;
                        }
                    }

                }

                dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                    "<td style='border: 1px solid #020000;' colspan='7'></span>" +
                                    "<span style='float:right;padding-right: 50px;'><b>Tổng Cộng</b></span>" +
                                    "</td>" +
                                    $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                    $"<td style='border: 1px solid #020000;text-align: right;'><b></b> </td>" +
                                    $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                    $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                    $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                    $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                    $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true)}</b> </td>" +
                                    "</tr>" +
                                    "</table>";

            }

            var khoaPhong = yeuCauTiepNhan.NoiTruBenhAn?.NoiTruKhoaPhongDieuTris.OrderByDescending(c => c.ThoiDiemVaoKhoa).Select(c => c.KhoaPhongChuyenDen).FirstOrDefault();
            var chuyenKhoa = GetChuyenKhoa(khoaPhong?.Id);//BVHD-3792
            var checkedLyDoVaoVien = "<input id='demo_box_2' class='css - checkbox' type='checkbox' checked  disabled='true'/>";
            var unCheckedLyDoVaoVien = "<input id='demo_box_2' class='css - checkbox' type='checkbox' disabled='true' />";
            var data = new
            {
                TitleBangKe = "ĐIỀU TRỊ NỘI TRÚ",
                SoBangKe = "3",
                yeuCauTiepNhan.BenhNhan.MaBN,
                MaTN = yeuCauTiepNhan.MaYeuCauTiepNhan,
                SoBenhAn = "Số bệnh án: " + yeuCauTiepNhan.NoiTruBenhAn?.SoBenhAn,
                yeuCauTiepNhan.HoTen,
                DiaChi = yeuCauTiepNhan.DiaChiDayDu,
                BarCodeImgBase64 = !string.IsNullOrEmpty(yeuCauTiepNhan.MaYeuCauTiepNhan) ? BarcodeHelper.GenerateBarCode(yeuCauTiepNhan.MaYeuCauTiepNhan) : "",
                NamSinh = DateHelper.DOBFormat(yeuCauTiepNhan.NgaySinh, yeuCauTiepNhan.ThangSinh, yeuCauTiepNhan.NamSinh),
                GioiTinh = yeuCauTiepNhan.GioiTinh != null ? yeuCauTiepNhan.GioiTinh.GetDescription() : "",
                //TenKhoa = "Khoa: " + yeuCauTiepNhan.NoiTruBenhAn?.KhoaPhongNhapVien?.Ten,
                //MaKhoa = "Mã khoa: " + yeuCauTiepNhan.NoiTruBenhAn?.KhoaPhongNhapVien?.Ma,

                TenKhoa = "Khoa: " + khoaPhong?.Ten,
                MaKhoa = "Mã khoa: " + chuyenKhoa?.Ma,

                MaBHYT = theBHYT?.MaSoThe,
                BHYTTuNgay = bHYTTuNgay,
                BHYTDenNgay = bHYTDenNgay,
                NoiDKKCBBanDau,
                MaKCBBanDau,
                NgayDenKham = yeuCauTiepNhan.YeuCauNhapVien?.YeuCauKhamBenh?.YeuCauTiepNhan.ThoiDiemTiepNhan.ApplyFormatGioPhutNgay(),
                DieuTriKNT = yeuCauTiepNhan.NoiTruBenhAn?.ThoiDiemNhapVien.ApplyFormatGioPhutNgay(),
                KetThucKhamNgoaiTru = yeuCauTiepNhan.NoiTruBenhAn?.ThoiDiemRaVien?.ApplyFormatGioPhutNgay(),
                SoNgayDTri = NoiTruBenhAnHelper.TinhSoNgayDieuTri(yeuCauTiepNhan.NoiTruBenhAn)?.ToString() ?? string.Empty,//yeuCauTiepNhan.NoiTruBenhAn?.ThoiDiemRaVien == null ? "" : (yeuCauTiepNhan.NoiTruBenhAn.ThoiDiemRaVien.Value.Date.AddDays(1) - yeuCauTiepNhan.NoiTruBenhAn.ThoiDiemNhapVien.Date).Days.ToString(),
                TinhTrangRaVien = yeuCauTiepNhan.NoiTruBenhAn?.TinhTrangRaVien == EnumTinhTrangRaVien.RaVien && (yeuCauTiepNhan.NoiTruBenhAn?.KetQuaDieuTri == EnumKetQuaDieuTri.Do || yeuCauTiepNhan.NoiTruBenhAn?.KetQuaDieuTri == EnumKetQuaDieuTri.Khoi) ? 1 : 2,
                MucHuong = mucHuong,
                NoiChuyenDen = yeuCauTiepNhan.NoiChuyen?.Ten,
                NoiChuyenDi = yeuCauTiepNhan.NoiTruBenhAn?.ChuyenDenBenhVien?.Ten,
                MKV = theBHYT?.MaKhuVuc,
                NgayMiemCungTC = theBHYT?.NgayDuocMienCungChiTra?.ApplyFormatDate(),
                ThoiGian5Nam = theBHYT?.NgayDu5Nam?.ApplyFormatDate(),
                CoCapCuu = yeuCauTiepNhan.LyDoVaoVien == Enums.EnumLyDoVaoVien.CapCuu ? checkedLyDoVaoVien : unCheckedLyDoVaoVien,
                CoDungTuyen = yeuCauTiepNhan.LyDoVaoVien == Enums.EnumLyDoVaoVien.DungTuyen ? checkedLyDoVaoVien : unCheckedLyDoVaoVien,
                CoThongTuyen = yeuCauTiepNhan.LyDoVaoVien == Enums.EnumLyDoVaoVien.ThongTuyen ? checkedLyDoVaoVien : unCheckedLyDoVaoVien,
                CoTraiTuyen = yeuCauTiepNhan.LyDoVaoVien == Enums.EnumLyDoVaoVien.TraiTuyen ? checkedLyDoVaoVien : unCheckedLyDoVaoVien,

                ChuanDoanXacDinh = yeuCauTiepNhan.NoiTruBenhAn != null && (yeuCauTiepNhan.NoiTruBenhAn.LoaiBenhAn == LoaiBenhAn.SanKhoaMo || yeuCauTiepNhan.NoiTruBenhAn.LoaiBenhAn == LoaiBenhAn.SanKhoaThuong) ? chuanDoanXacDinhSanKhoa : yeuCauTiepNhan.NoiTruBenhAn?.ChanDoanChinhRaVienGhiChu,
                MaICD10 = yeuCauTiepNhan.NoiTruBenhAn != null && (yeuCauTiepNhan.NoiTruBenhAn.LoaiBenhAn == LoaiBenhAn.SanKhoaMo || yeuCauTiepNhan.NoiTruBenhAn.LoaiBenhAn == LoaiBenhAn.SanKhoaThuong) ? maICD10 : yeuCauTiepNhan.NoiTruBenhAn?.ChanDoanChinhRaVienICD?.Ma,


                BenhKemTheo = tenICDKemTheo,
                ICDKemTheo10 = maICDKemTheo,

                DateItemChiPhis = dateItemChiPhis,

                TTDV = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble(),
                TTTTBHYT = "",

                TTTienBH = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble(),
                TQBHYT = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble(),
                TNCCTra = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble(),
                TongSoKhac = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble(),
                TNBTuTra = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true),

                TongChiPhi = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble(),
                SoTienBangChu = NumberHelper.ChuyenSoRaText(Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBV))),

                NguoiBenhPhaiTra = (Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)) + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhTuTra))).ApplyFormatMoneyToDouble(),

                TTQuyTT = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble(),
                BHYTChiTra = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble(),
                CacKhoanTraKhac = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true),
                SoTienKhac = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble(),
                NgayHienTai = DateTime.Now.ApplyFormatNgayThangNam(),
                Notice = "<div style='color: red; font-weight:800; margin-top:200px;'>Lưu ý : Người bệnh chưa quyết toán </div>"
            };

            var content = TemplateHelpper.FormatTemplateWithContentTemplate(result?.Body, data);
            return content;
        }

        //khách hàng muốn in phiếu tách theo khoa 
        public List<string> GetHtmlBangChuaQuyetToanTheoKhoaChiDinh(long yeuCauTiepNhanId, string hostingName)
        {
            List<string> inTheoKhoaChiDinh = new List<string>();

            var yeuCauTiepNhan = BaseRepository.GetById(yeuCauTiepNhanId,
                                                    x => x.Include(o => o.NoiTruBenhAn).ThenInclude(o => o.ChuyenDenBenhVien)
                                                        .Include(o => o.NoiTruBenhAn).ThenInclude(o => o.KhoaPhongNhapVien)
                                                        .Include(o => o.NoiTruBenhAn).ThenInclude(o => o.ChanDoanChinhRaVienICD)
                                                        .Include(o => o.YeuCauTiepNhanTheBHYTs)
                                                        .Include(o => o.YeuCauNhapVien).ThenInclude(o => o.YeuCauKhamBenh).ThenInclude(o => o.YeuCauTiepNhan)
                                                        .Include(o => o.BenhNhan)
                                                        .Include(o => o.PhuongXa)
                                                        .Include(o => o.QuanHuyen)
                                                        .Include(o => o.TinhThanh)
                                                        .Include(o => o.NoiChuyen)
                                                        .Include(o => o.NoiTruBenhAn).ThenInclude(o => o.NoiTruPhieuDieuTris).ThenInclude(c => c.ChanDoanChinhICD)
                                                        .Include(o => o.NoiTruBenhAn).ThenInclude(o => o.NoiTruPhieuDieuTris).ThenInclude(o => o.NoiTruThamKhamChanDoanKemTheos).ThenInclude(c => c.ICD))

;

            var result = _templateRepository.TableNoTracking.FirstOrDefault(x => x.Name.Equals("BangKeKhamBenhBHYTVaBenhVien"));


            var danhSachChiPhis = GetTatCaDichVuKhamChuaBenh(yeuCauTiepNhanId).Result.Where(o => !o.Soluong.AlmostEqual(0) && o.YeuCauGoiDichVuId == null).GroupBy(c => c.Khoa);
            if (danhSachChiPhis == null)
            {
                return null;
            }

            foreach (var danhSachChiPhi in danhSachChiPhis)
            {


                if (yeuCauTiepNhan == null)
                    return null;

                var benhVien = new Core.Domain.Entities.BenhVien.BenhVien();

                string maBHYT = string.Empty;
                string bHYTTuNgay = string.Empty;
                string bHYTDenNgay = string.Empty;
                string mucHuong = string.Empty;
                string NoiDKKCBBanDau = string.Empty;
                string MaKCBBanDau = string.Empty;


                string maICDKemTheo = string.Empty;
                string tenICDKemTheo = string.Empty;

                string chuanDoanXacDinhSanKhoa = string.Empty;
                string maICD10 = string.Empty;

                if (yeuCauTiepNhan.NoiTruBenhAn != null && (yeuCauTiepNhan.NoiTruBenhAn.LoaiBenhAn == LoaiBenhAn.SanKhoaMo || yeuCauTiepNhan.NoiTruBenhAn.LoaiBenhAn == LoaiBenhAn.SanKhoaThuong))
                {
                    if (yeuCauTiepNhan.NoiTruBenhAn?.NoiTruPhieuDieuTris.Count() > 0)
                    {
                        var phieuDieuTri = yeuCauTiepNhan.NoiTruBenhAn?.NoiTruPhieuDieuTris.OrderByDescending(c => c.NgayDieuTri).FirstOrDefault();

                        var icdKemTheoIds = phieuDieuTri.NoiTruThamKhamChanDoanKemTheos.Select(c => c.ICD.Ma);
                        var tenICDKemTheos = phieuDieuTri.NoiTruThamKhamChanDoanKemTheos.Select(c => c.GhiChu);

                        maICDKemTheo = string.Join(", ", icdKemTheoIds);
                        tenICDKemTheo = string.Join(", ", tenICDKemTheos);

                        maICD10 = phieuDieuTri.ChanDoanChinhICD?.Ma;
                        chuanDoanXacDinhSanKhoa = phieuDieuTri.ChanDoanChinhGhiChu;
                    }
                }
                else
                {
                    if (!string.IsNullOrEmpty(yeuCauTiepNhan.NoiTruBenhAn?.DanhSachChanDoanKemTheoRaVienICDId))
                    {
                        var maICDKemTheos = new List<string>();

                        var icdKemTheoIds = yeuCauTiepNhan.NoiTruBenhAn?.DanhSachChanDoanKemTheoRaVienICDId.Split(Constants.ICDSeparator);
                        var tenICDKemTheos = yeuCauTiepNhan.NoiTruBenhAn?.DanhSachChanDoanKemTheoRaVienGhiChu?.Split(Constants.ICDSeparator);

                        if (icdKemTheoIds.Length > 0)
                        {
                            foreach (var icdKemTheoId in icdKemTheoIds)
                            {
                                var icdKemTheo = _icdRepository.TableNoTracking.FirstOrDefault(o => o.Id == long.Parse(icdKemTheoId));
                                if (icdKemTheo != null)
                                {
                                    maICDKemTheos.Add(icdKemTheo.Ma);
                                }

                                //if (long.TryParse(yeuCauTiepNhan.NoiTruBenhAn?.DanhSachChanDoanKemTheoRaVienICDId.Split(Constants.ICDSeparator).First(), out var icdKemTheoId))
                                //{
                                //    var icdKemTheo = _icdRepository.TableNoTracking.FirstOrDefault(o => o.Id == icdKemTheoId);
                                //    if (icdKemTheo != null)
                                //    {
                                //        maICDKemTheo = icdKemTheo.Ma;
                                //        tenICDKemTheo = yeuCauTiepNhan.NoiTruBenhAn?.DanhSachChanDoanKemTheoRaVienGhiChu?.Split(Constants.ICDSeparator).First();
                                //    }
                                //}
                            }
                        }

                        maICDKemTheo = string.Join(", ", maICDKemTheos);
                        tenICDKemTheo = string.Join(", ", tenICDKemTheos);
                    }
                }




                YeuCauTiepNhanTheBHYT theBHYT = null;
                if (yeuCauTiepNhan.CoBHYT == true && yeuCauTiepNhan.YeuCauTiepNhanTheBHYTs.Any())
                {
                    theBHYT = yeuCauTiepNhan.YeuCauTiepNhanTheBHYTs.First();
                    if (!String.IsNullOrEmpty(theBHYT.MaDKBD))
                    {
                        benhVien = _benhVienRepository.TableNoTracking.FirstOrDefault(p => p.Ma.Equals(theBHYT.MaDKBD));
                    }
                    maBHYT = theBHYT.MaSoThe;
                    bHYTTuNgay = theBHYT.NgayHieuLuc.ApplyFormatDate();
                    bHYTDenNgay = theBHYT.NgayHetHan?.ApplyFormatDate();
                    mucHuong = theBHYT.MucHuong.ToString() + "%";
                    NoiDKKCBBanDau = benhVien != null ? benhVien?.Ten : "Chưa xác định";
                    MaKCBBanDau = theBHYT.MaDKBD;
                }
                else
                {
                    maBHYT = "";
                    bHYTTuNgay = "";
                    bHYTDenNgay = "";
                    mucHuong = "0%";
                    NoiDKKCBBanDau = "Chưa xác định";
                    MaKCBBanDau = "Chưa xác định";
                }

                var dsChiPhiBangKe = new List<BangKeKhamBenhCoBHYTVo>();
                var dateItemChiPhis = string.Empty;
                int indexItem = 1;
                var groupChiPhiTheoThe = danhSachChiPhi.GroupBy(o => o.MaSoTheBHYT);

                var ngayNhapVien = yeuCauTiepNhan.NoiTruBenhAn.ThoiDiemNhapVien.ApplyFormatDate();
                var ngayRaVien = yeuCauTiepNhan.NoiTruBenhAn.ThoiDiemRaVien?.ApplyFormatDate();

                if (groupChiPhiTheoThe.Count() > 2 ||
                    (groupChiPhiTheoThe.All(o => o.Key != string.Empty) && groupChiPhiTheoThe.Count() > 1))
                {
                    var groupNgayPhatSinhTheoThe = groupChiPhiTheoThe.Where(o => o.Key != string.Empty).Select(o => new { o.Key, o.OrderBy(j => j.NgayPhatSinh).First().NgayPhatSinh }).OrderBy(o => o.NgayPhatSinh).ToArray();
                    for (int i = 0; i < groupNgayPhatSinhTheoThe.Count(); i++)
                    {
                        var ngayPhatSinhTheoThe = groupNgayPhatSinhTheoThe[i];
                        var theBHYTChiTra = yeuCauTiepNhan.YeuCauTiepNhanTheBHYTs.First(o => o.MaSoThe == ngayPhatSinhTheoThe.Key);
                        var chiPhis = groupChiPhiTheoThe.FirstOrDefault(o => o.Key == ngayPhatSinhTheoThe.Key).ToList();
                        DateTime? ngayPhatSinhTiepTheo = i < groupNgayPhatSinhTheoThe.Count() - 1
                            ? groupNgayPhatSinhTheoThe[i + 1].NgayPhatSinh
                            : null;
                        chiPhis.AddRange(groupChiPhiTheoThe.FirstOrDefault(o => o.Key == string.Empty).Where(j => (i == 0 || j.NgayPhatSinh >= ngayPhatSinhTheoThe.NgayPhatSinh) && (ngayPhatSinhTiepTheo != null && j.NgayPhatSinh < ngayPhatSinhTiepTheo)).ToList());
                        var mucHuongPT = theBHYTChiTra != null && theBHYTChiTra?.MucHuong > 0 ? theBHYTChiTra?.MucHuong + "%" : string.Empty;
                        dateItemChiPhis += "<table style='width: 100 %;margin-bottom:-21px;  '>" +
                                           "<tbody>" +
                                           "<tr>" +
                                           $"<td style='padding-left:-5px; width: 40 %; '>Mã thẻ BHYT {i + 1}: <b>{theBHYTChiTra.MaSoThe}</b> " +
                                           $"<span style='padding-left:20px'>Giá trị từ: <b>{theBHYTChiTra.NgayHieuLuc.ApplyFormatDate()}</b> đến <b>{theBHYTChiTra.NgayHetHan?.ApplyFormatDate()}</b></span>" +
                                           $"<span style='padding-left:20px'>Mức hưởng: <b>{mucHuongPT}</b></span></td>" +
                                           "</tr>" +

                                            //Thêm dòng: (Chi phí KCB tính từ ngày...đến ngày...) BVHD-3792
                                            "<tr>" +
                                            $"<td>" +
                                            $"<span> (Chi phí KCB tính từ ngày <b>{ngayNhapVien}</b> đến ngày <b>{ngayRaVien}</b>) </span></td>" +
                                            "</tr>" +

                                           "</tbody>" +
                                           "</table>" +
                                           "</br>" +
                                           "<table style='width:100%;border: 1px solid #020000; border-collapse: collapse;'>" +
                                                "<tr style='border: 1px solid black;  border-collapse: collapse;'>" +
                                                "<th style='border: 1px solid #020000; border-collapse: collapse;text-align: center;' rowspan='2'>" +
                                                        "STT </th>" +
                                                    "<th style='border: 1px solid #020000; border-collapse: collapse;width:35%;text-align: center;' rowspan='2'>" +
                                                        "Nội dung </th>" +
                                                    "<th style='border: 1px solid #020000; border-collapse: collapse;width:5%;text-align: center;' rowspan='2'>" +
                                                        "Đơn vị tính</th>" +
                                                    "<th style='border: 1px solid #020000; border-collapse: collapse;width:3%; text-align: center;' rowspan='2'>" +
                                                        "Số lượng</th>" +
                                                    "<th style='border: 1px solid #020000; border-collapse: collapse;width:3%; text-align: center;' rowspan='2'>" +
                                                        "Đơn giá BV <span style='font-weight: 100;'>(đồng)</span></th>" +
                                                    "<th style='border: 1px solid #020000; border-collapse: collapse;width:3%; text-align: center;' rowspan='2'>" +
                                                        "Đơn giá BH  <span style='font-weight: 100;'>(đồng)</span></th>" +
                                                    "<th style='border: 1px solid #020000; border-collapse: collapse;width:200px; text-align: center;'" +
                                                        "rowspan='2'>" +
                                                        "Tỉ lệ thanh toán theo dich vụ   <span style='font-weight: 100;'>(%)</span></th>" +
                                                    "<th style='border: 1px solid #020000; border-collapse: collapse;width:8%;text-align: center;' rowspan='2'>" +
                                                        "Thành tiền BV  <span style='font-weight: 100;'>(đồng)</span>" +
                                                    "</th>" +
                                                    "<th style='border: 1px solid #020000; border-collapse: collapse;width:200px; text-align: center;'" +
                                                        "rowspan='2'>" +
                                                        "Tỷ lệ thanh toán BHYT <span style='font-weight: 100;'>(%)</span>" +
                                                    "</th>" +
                                                    "<th style='border: 1px solid #020000; border-collapse: collapse;width:8%;text-align: center;' rowspan='2'>" +
                                                        "Thành tiền BH  <span style='font-weight: 100;'>(đồng)</span>" +
                                                    "</th>" +
                                                    "<th style='border: 1px solid #020000; border-collapse: collapse;width:35%;text-align: center;' colspan='4'>" +
                                                        "Nguồn thanh toán  <span style='font-weight: 100;'>(đồng)</span></th>" +
                                                "</tr>" +
                                                "<tr style='border: 1px solid #020000; border-collapse: collapse;'>" +
                                                    "<td style='border: 1px solid #020000; border-collapse: collapse;text-align: center;'><b>Quỹ BHYT</b></td>" +
                                                    "<td style=' border: 1px solid #020000; border-collapse: collapse;width:80px;text-align: center;'>" +
                                                        "<b>Người bệnh cùng chi" +
                                                        " trả</b> (đồng)</td>" +
                                                    "<td style=' border: 1px solid #020000; border-collapse: collapse;text-align: center;'><b>Khác</b> (đồng)</td>" +
                                                    "<td style='border: 1px solid #020000; border-collapse: collapse;text-align: center;width: 90px;'>" +
                                                        "<b>Người bệnh" +
                                                        "tự trả </b>(đồng)" +
                                                    "</td>" +
                                                "</tr>" +
                                                "<tr style=' border: 1px solid #020000; '>" +
                                                  "<td style='border: 1px solid #020000;text-align: center;'><b> </b> </td>" +
                                                    "<td style='border: 1px solid #020000;text-align: center;'><b>(1)</b> </td>" +
                                                    "<td style='border: 1px solid #020000;text-align: center;'><b>(2)</b> </td>" +
                                                    "<td style='border: 1px solid #020000;text-align: center;'><b>(3)</b> </td>" +
                                                    "<td style='border: 1px solid #020000;text-align: center;'><b>(4)</b> </td>" +
                                                    "<td style='border: 1px solid #020000;text-align: center;'><b>(5)</b> </td>" +
                                                    "<td style='border: 1px solid #020000;text-align: center;'><b>(6)</b> </td>" +
                                                    "<td style='border: 1px solid #020000;text-align: center;'><b>(7)</b> </td>" +
                                                    "<td style='border: 1px solid #020000;text-align: center;'><b>(8)</b> </td>" +
                                                    "<td style='border: 1px solid #020000;text-align: center;'><b>(9)</b> </td>" +
                                                    "<td style='border: 1px solid #020000;text-align: center;'><b>(10)</b> </td>" +
                                                    "<td style='border: 1px solid #020000;text-align: center;'><b>(11)</b> </td>" +
                                                    "<td style='border: 1px solid #020000;text-align: center;'><b>(12)</b> </td>" +
                                                    "<td style='border: 1px solid #020000;text-align: center;'><b>(13)</b> </td>" +
                                                "</tr>";


                        var dsChiPhiBangKeTheoThe = new List<BangKeKhamBenhCoBHYTVo>();
                        foreach (var chiPhi in chiPhis.Where(c => c.NhomChiPhiBangKe != NhomChiPhiBangKe.GoiVatTu).GroupBy(c => new { c.NhomChiPhiBangKe, c.TenDichVu, c.DonViTinh, c.DuocHuongBHYT, c.DonGia, c.DonGiaBHYT, c.MucHuongBaoHiem, c.TiLeBaoHiemThanhToan }).OrderByDescending(o => o.Key.DuocHuongBHYT))
                        {
                            dsChiPhiBangKeTheoThe.Add(new BangKeKhamBenhCoBHYTVo
                            {
                                Nhom = chiPhi.Key.NhomChiPhiBangKe,
                                Id = chiPhi.FirstOrDefault().Id,
                                NoiDung = chiPhi.Key.TenDichVu,
                                DonViTinh = chiPhi.Key.DonViTinh,
                                SoLuong = (decimal)chiPhi.Sum(c => c.Soluong),
                                DuocHuongBaoHiem = chiPhi.Key.DuocHuongBHYT,
                                DonGiaBH = chiPhi.Key.DonGiaBHYT,
                                DonGiaTheoBV = chiPhi.Key.DonGia,
                                MucHuongBaoHiem = chiPhi.Key.MucHuongBaoHiem,
                                TiLeThanhToanTheoDV = chiPhi.Key.TiLeBaoHiemThanhToan,
                                BaoHiemChiTra = true
                            });
                        }
                        foreach (var chiPhi in chiPhis.Where(c => c.NhomChiPhiBangKe == NhomChiPhiBangKe.GoiVatTu).OrderByDescending(o => o.DuocHuongBHYT))
                        {
                            dsChiPhiBangKeTheoThe.Add(new BangKeKhamBenhCoBHYTVo
                            {
                                Nhom = chiPhi.NhomChiPhiBangKe,
                                Id = chiPhi.Id,
                                NoiDung = chiPhi.TenDichVu,
                                DonViTinh = chiPhi.DonViTinh,
                                SoLuong = (decimal)chiPhi.Soluong,
                                DuocHuongBaoHiem = chiPhi.DuocHuongBHYT,
                                DonGiaBH = chiPhi.DonGiaBHYT,
                                DonGiaTheoBV = chiPhi.DonGia,
                                MucHuongBaoHiem = chiPhi.MucHuongBaoHiem,
                                TiLeThanhToanTheoDV = chiPhi.TiLeBaoHiemThanhToan,
                                BaoHiemChiTra = true
                            });
                        }
                        dsChiPhiBangKe.AddRange(dsChiPhiBangKeTheoThe);
                        var groupChiPhiBangKes = dsChiPhiBangKeTheoThe.GroupBy(x => x.Nhom).OrderBy(o => (int)o.Key * (o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay || o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriNoiTru ? 1 : 10));
                        foreach (var groupChiPhiBangKe in groupChiPhiBangKes)
                        {
                            if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay)
                            {

                                dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                                   "<td style='border: 1px solid #020000;' colspan='7'>" +
                                                   "<span style='float:left;'><b>2. Ngày giường:  </b></span>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                   "</tr>";
                                dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                                   "<td style='border: 1px solid #020000;' colspan='7'>" +
                                                   "<span style='float:left;'><b>2.1." + groupChiPhiBangKe.Key.GetDescription() + "  </b></span>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'><b> " + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true) + "</b> </td>" +
                                                   "</tr>";
                            }
                            else if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.NgayGiuongDieuTriNoiTru)
                            {
                                if (!groupChiPhiBangKes.Any(o => o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay))
                                {
                                    dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                                       "<td style='border: 1px solid #020000;' colspan='7'>" +
                                                       "<span style='float:left;'><b>2. Ngày giường:  </b></span>" +
                                                       "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                       "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                       "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                       "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                       "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                       "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                       "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                       "</tr>";
                                }
                                dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                                   "<td style='border: 1px solid #020000;' colspan='7'>" +
                                                   "<span style='float:left;'><b>2.2." + groupChiPhiBangKe.Key.GetDescription() + "  </b></span>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'><b> " + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true) + "</b> </td>" +
                                                   "</tr>";
                            }
                            else
                            {
                                dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                                   "<td style='border: 1px solid #020000;' colspan='7'>" +
                                                   "<span style='float:left;'><b>" + (int)groupChiPhiBangKe.Key + "." + groupChiPhiBangKe.Key.GetDescription() + "  </b></span>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'><b> " + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true) + "</b> </td>" +
                                                   "</tr>";
                            }
                            if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.GoiVatTu)
                            {
                                var groupGoiVatTus = groupChiPhiBangKe.ToList().GroupBy(o => o.SoGoiVatTu.GetValueOrDefault()).OrderBy(o => o.Key);
                                int sttGoiVatTu = 1;
                                foreach (var groupGoiVatTu in groupGoiVatTus)
                                {
                                    dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                                       "<td style='border: 1px solid #020000;' colspan='7'>" +
                                                       "<span style='float:left;'><b>10." + sttGoiVatTu + ". " + groupChiPhiBangKe.Key.GetDescription() + " " + sttGoiVatTu + "  </b></span>" +
                                                       "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                       "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                       "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                       "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                       "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                       "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.Khac)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                       "<td style='border: 1px solid #020000;text-align: right;'><b> " + Convert.ToDouble(groupGoiVatTu.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true) + "</b> </td>" +
                                                       "</tr>";
                                    foreach (var chiPhiBangKe in groupGoiVatTu)
                                    {
                                        dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                                        "<td style='border: 1px solid #020000; text-align: center;'> " + indexItem + "</td>" +
                                                        "<td style='border: 1px solid #020000;text-align: left;'> " + chiPhiBangKe.NoiDung + "</td>" +
                                                        "<td style='border: 1px solid #020000;text-align: center;'>  " + chiPhiBangKe.DonViTinh + " </td>" +
                                                        "<td style='border: 1px solid #020000;text-align: center;'> " + chiPhiBangKe.SoLuong + "</td>" +
                                                        "<td style='border: 1px solid #020000;text-align: center;'> " + Convert.ToDouble(chiPhiBangKe.DonGiaBV).ApplyFormatMoneyToDouble() + "</td>" +
                                                        "<td style='border: 1px solid #020000;text-align: center;'> " + Convert.ToDouble(chiPhiBangKe.DonGiaBH).ApplyFormatMoneyToDouble() + "</td>" +
                                                        "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.TiLeThanhToanTheoDV).ApplyFormatMoneyToDouble() + "</td>" +
                                                        "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.ThanhTienBV).ApplyFormatMoneyToDouble() + "</td>" +
                                                        "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.MucHuongBaoHiem > 0 ? 100 : 0).ApplyFormatMoneyToDouble() + "</td>" +
                                                        "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.ThanhTienBH).ApplyFormatMoneyToDouble() + "</td>" +
                                                        "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.QuyBHYT).ApplyFormatMoneyToDouble() + "</td>" +
                                                        "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.NguoiBenhCungChiTra).ApplyFormatMoneyToDouble() + "</td>" +
                                                        "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.Khac).ApplyFormatMoneyToDouble() + "</td>" +
                                                        "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.NguoiBenhTuTra).ApplyFormatMoneyToDouble(true) + "</td>" +
                                                        "</tr>";
                                        indexItem++;
                                    }
                                }
                            }
                            else
                            {
                                foreach (var chiPhiBangKe in groupChiPhiBangKe)
                                {
                                    dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                                    "<td style='border: 1px solid #020000; text-align: center;'> " + indexItem + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: left;'> " + chiPhiBangKe.NoiDung + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: center;'>  " + chiPhiBangKe.DonViTinh + " </td>" +
                                                    "<td style='border: 1px solid #020000;text-align: center;'> " + chiPhiBangKe.SoLuong + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: center;'> " + Convert.ToDouble(chiPhiBangKe.DonGiaBV).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: center;'> " + Convert.ToDouble(chiPhiBangKe.DonGiaBH).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.TiLeThanhToanTheoDV).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.ThanhTienBV).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.MucHuongBaoHiem > 0 ? 100 : 0).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.ThanhTienBH).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.QuyBHYT).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.NguoiBenhCungChiTra).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.Khac).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.NguoiBenhTuTra).ApplyFormatMoneyToDouble(true) + "</td>" +
                                                    "</tr>";
                                    indexItem++;
                                }
                            }

                        }

                        dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                           "<td style='border: 1px solid #020000;' colspan='7'></span>" +
                                           "<span style='float:right;padding-right: 50px;'><b>Tổng Cộng</b></span>" +
                                           "</td>" +
                                           $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKeTheoThe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                           $"<td style='border: 1px solid #020000;text-align: right;'><b></b> </td>" +
                                           $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKeTheoThe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                           $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKeTheoThe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                           $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKeTheoThe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                           $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKeTheoThe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                           $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKeTheoThe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true)}</b> </td>" +
                                           "</tr>" +
                                           "</table>";
                    }
                }
                else
                {
                    YeuCauTiepNhanTheBHYT theBHYTChiTra = null;
                    var maSoThe = groupChiPhiTheoThe.Where(o => o.Key != string.Empty).FirstOrDefault()?.Key;
                    if (!string.IsNullOrEmpty(maSoThe))
                    {
                        theBHYTChiTra = yeuCauTiepNhan.YeuCauTiepNhanTheBHYTs.First(o => o.MaSoThe == maSoThe);
                    }

                    var chiPhis = groupChiPhiTheoThe.SelectMany(o => o).ToList();
                    var mucHuongPT = theBHYTChiTra != null && theBHYTChiTra?.MucHuong > 0 ? theBHYTChiTra?.MucHuong + "%" : string.Empty;

                    dateItemChiPhis += "<table style='width: 100 %;margin-bottom:-21px;'>" +
                                        "<tbody>" +
                                         "<tr>" +
                                           $"<td style='padding-left: -5px; width: 40 %; '>Mã thẻ BHYT: <b>{theBHYTChiTra?.MaSoThe}</b> " +
                                           $"<span style='padding-left:20px'>Giá trị từ: <b>{theBHYTChiTra?.NgayHieuLuc.ApplyFormatDate()}</b> đến <b>{theBHYTChiTra?.NgayHetHan?.ApplyFormatDate()}</b></span>" +
                                           $"<span style='padding-left:20px'>Mức hưởng: <b>{mucHuongPT}</b></span></td>" +
                                         "</tr>" +

                                        //Thêm dòng: (Chi phí KCB tính từ ngày...đến ngày...) BVHD-3792
                                        "<tr>" +
                                        $"<td>" +
                                        $"<span> (Chi phí KCB tính từ ngày <b>{ngayNhapVien}</b> đến ngày <b>{ngayRaVien}</b>) </span></td>" +
                                        "</tr>" +

                                        "</tbody>" +
                                        "</table>" +
                                        "</br>" +
                                        "<table style='width:100%;border: 1px solid #020000; border-collapse: collapse;'>" +
                                            "<tr style='border: 1px solid black;  border-collapse: collapse;'>" +
                                            "<th style='border: 1px solid #020000; border-collapse: collapse;text-align: center;' rowspan='2'>" +
                                                    "STT </th>" +
                                                "<th style='border: 1px solid #020000; border-collapse: collapse;width:35%;text-align: center;' rowspan='2'>" +
                                                    "Nội dung </th>" +
                                                "<th style='border: 1px solid #020000; border-collapse: collapse;width:5%;text-align: center;' rowspan='2'>" +
                                                    "Đơn vị tính</th>" +
                                                "<th style='border: 1px solid #020000; border-collapse: collapse;width:3%; text-align: center;' rowspan='2'>" +
                                                    "Số lượng</th>" +
                                                "<th style='border: 1px solid #020000; border-collapse: collapse;width:3%; text-align: center;' rowspan='2'>" +
                                                    "Đơn giá BV <span style='font-weight: 100;'>(đồng)</span></th>" +
                                                "<th style='border: 1px solid #020000; border-collapse: collapse;width:3%; text-align: center;' rowspan='2'>" +
                                                    "Đơn giá BH  <span style='font-weight: 100;'>(đồng)</span></th>" +
                                                "<th style='border: 1px solid #020000; border-collapse: collapse;width:200px; text-align: center;'" +
                                                    "rowspan='2'>" +
                                                    "Tỉ lệ thanh toán theo dich vụ   <span style='font-weight: 100;'>(%)</span></th>" +
                                                "<th style='border: 1px solid #020000; border-collapse: collapse;width:8%;text-align: center;' rowspan='2'>" +
                                                    "Thành tiền BV  <span style='font-weight: 100;'>(đồng)</span>" +
                                                "</th>" +
                                                "<th style='border: 1px solid #020000; border-collapse: collapse;width:200px; text-align: center;'" +
                                                    "rowspan='2'>" +
                                                    "Tỷ lệ thanh toán BHYT <span style='font-weight: 100;'>(%)</span>" +
                                                "</th>" +
                                                "<th style='border: 1px solid #020000; border-collapse: collapse;width:8%;text-align: center;' rowspan='2'>" +
                                                    "Thành tiền BH  <span style='font-weight: 100;'>(đồng)</span>" +
                                                "</th>" +
                                                "<th style='border: 1px solid #020000; border-collapse: collapse;width:35%;text-align: center;' colspan='4'>" +
                                                    "Nguồn thanh toán  <span style='font-weight: 100;'>(đồng)</span></th>" +
                                            "</tr>" +
                                            "<tr style='border: 1px solid #020000; border-collapse: collapse;'>" +
                                                "<td style='border: 1px solid #020000; border-collapse: collapse;text-align: center;'><b>Quỹ BHYT</b></td>" +
                                                "<td style=' border: 1px solid #020000; border-collapse: collapse;width:80px;text-align: center;'>" +
                                                    "<b>Người bệnh cùng chi" +
                                                    " trả</b> (đồng)</td>" +
                                                "<td style=' border: 1px solid #020000; border-collapse: collapse;text-align: center;'><b>Khác</b> (đồng)</td>" +
                                                "<td style='border: 1px solid #020000; border-collapse: collapse;text-align: center;width: 90px;'>" +
                                                    "<b>Người bệnh" +
                                                    "tự trả </b>(đồng)" +
                                                "</td>" +
                                            "</tr>" +
                                            "<tr style=' border: 1px solid #020000; '>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b> </b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(1)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(2)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(3)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(4)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(5)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(6)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(7)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(8)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(9)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(10)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(11)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(12)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(13)</b> </td>" +
                                            "</tr>";

                    foreach (var chiPhi in chiPhis.Where(c => c.NhomChiPhiBangKe != NhomChiPhiBangKe.GoiVatTu).GroupBy(c => new { c.NhomChiPhiBangKe, c.TenDichVu, c.DonViTinh, c.DuocHuongBHYT, c.DonGia, c.DonGiaBHYT, c.MucHuongBaoHiem, c.TiLeBaoHiemThanhToan }).OrderByDescending(o => o.Key.DuocHuongBHYT))
                    {
                        dsChiPhiBangKe.Add(new BangKeKhamBenhCoBHYTVo
                        {
                            Nhom = chiPhi.Key.NhomChiPhiBangKe,
                            Id = chiPhi.FirstOrDefault().Id,
                            NoiDung = chiPhi.Key.TenDichVu,
                            DonViTinh = chiPhi.Key.DonViTinh,
                            SoLuong = (decimal)chiPhi.Sum(c => c.Soluong),
                            DuocHuongBaoHiem = chiPhi.Key.DuocHuongBHYT,
                            DonGiaBH = chiPhi.Key.DonGiaBHYT,
                            DonGiaTheoBV = chiPhi.Key.DonGia,
                            MucHuongBaoHiem = chiPhi.Key.MucHuongBaoHiem,
                            TiLeThanhToanTheoDV = chiPhi.Key.TiLeBaoHiemThanhToan,
                            BaoHiemChiTra = true
                        });
                    }
                    foreach (var chiPhi in chiPhis.Where(c => c.NhomChiPhiBangKe == NhomChiPhiBangKe.GoiVatTu).OrderByDescending(o => o.DuocHuongBHYT))
                    {
                        dsChiPhiBangKe.Add(new BangKeKhamBenhCoBHYTVo
                        {
                            Nhom = chiPhi.NhomChiPhiBangKe,
                            Id = chiPhi.Id,
                            NoiDung = chiPhi.TenDichVu,
                            DonViTinh = chiPhi.DonViTinh,
                            SoLuong = (decimal)chiPhi.Soluong,
                            DuocHuongBaoHiem = chiPhi.DuocHuongBHYT,
                            DonGiaBH = chiPhi.DonGiaBHYT,
                            DonGiaTheoBV = chiPhi.DonGia,
                            MucHuongBaoHiem = chiPhi.MucHuongBaoHiem,
                            TiLeThanhToanTheoDV = chiPhi.TiLeBaoHiemThanhToan,
                            BaoHiemChiTra = true
                        });
                    }
                    var groupChiPhiBangKes = dsChiPhiBangKe.GroupBy(x => x.Nhom).OrderBy(o => (int)o.Key * (o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay || o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriNoiTru ? 1 : 10));
                    foreach (var groupChiPhiBangKe in groupChiPhiBangKes)
                    {
                        if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay)
                        {

                            dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                                "<td style='border: 1px solid #020000;' colspan='7'>" +
                                                "<span style='float:left;'><b>2. Ngày giường:  </b></span>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                "</tr>";
                            dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                                "<td style='border: 1px solid #020000;' colspan='7'>" +
                                                "<span style='float:left;'><b>2.1." + groupChiPhiBangKe.Key.GetDescription() + "  </b></span>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'><b> " + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true) + "</b> </td>" +
                                                "</tr>";
                        }
                        else if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.NgayGiuongDieuTriNoiTru)
                        {
                            if (!groupChiPhiBangKes.Any(o => o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay))
                            {
                                dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                                    "<td style='border: 1px solid #020000;' colspan='7'>" +
                                                    "<span style='float:left;'><b>2. Ngày giường:  </b></span>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                    "</tr>";
                            }
                            dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                                "<td style='border: 1px solid #020000;' colspan='7'>" +
                                                "<span style='float:left;'><b>2.2." + groupChiPhiBangKe.Key.GetDescription() + "  </b></span>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'><b> " + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true) + "</b> </td>" +
                                                "</tr>";
                        }
                        else
                        {
                            dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                                "<td style='border: 1px solid #020000;' colspan='7'>" +
                                                "<span style='float:left;'><b>" + (int)groupChiPhiBangKe.Key + "." + groupChiPhiBangKe.Key.GetDescription() + "  </b></span>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'><b> " + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true) + "</b> </td>" +
                                                "</tr>";
                        }
                        if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.GoiVatTu)
                        {
                            var groupGoiVatTus = groupChiPhiBangKe.ToList().GroupBy(o => o.SoGoiVatTu.GetValueOrDefault()).OrderBy(o => o.Key);
                            int sttGoiVatTu = 1;
                            foreach (var groupGoiVatTu in groupGoiVatTus)
                            {
                                dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                                    "<td style='border: 1px solid #020000;' colspan='7'>" +
                                                    "<span style='float:left;'><b>10." + sttGoiVatTu + ". " + groupChiPhiBangKe.Key.GetDescription() + " " + sttGoiVatTu + "  </b></span>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.Khac)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'><b> " + Convert.ToDouble(groupGoiVatTu.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true) + "</b> </td>" +
                                                    "</tr>";
                                foreach (var chiPhiBangKe in groupGoiVatTu)
                                {
                                    dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                                    "<td style='border: 1px solid #020000; text-align: center;'> " + indexItem + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: left;'> " + chiPhiBangKe.NoiDung + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: center;'>  " + chiPhiBangKe.DonViTinh + " </td>" +
                                                    "<td style='border: 1px solid #020000;text-align: center;'> " + chiPhiBangKe.SoLuong + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: center;'> " + Convert.ToDouble(chiPhiBangKe.DonGiaBV).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: center;'> " + Convert.ToDouble(chiPhiBangKe.DonGiaBH).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.TiLeThanhToanTheoDV).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.ThanhTienBV).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.MucHuongBaoHiem > 0 ? 100 : 0).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.ThanhTienBH).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.QuyBHYT).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.NguoiBenhCungChiTra).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.Khac).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.NguoiBenhTuTra).ApplyFormatMoneyToDouble(true) + "</td>" +
                                                    "</tr>";
                                    indexItem++;
                                }
                            }
                        }
                        else
                        {
                            foreach (var chiPhiBangKe in groupChiPhiBangKe)
                            {
                                dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                                "<td style='border: 1px solid #020000; text-align: center;'> " + indexItem + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: left;'> " + chiPhiBangKe.NoiDung + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'>  " + chiPhiBangKe.DonViTinh + " </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'> " + chiPhiBangKe.SoLuong + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'> " + Convert.ToDouble(chiPhiBangKe.DonGiaBV).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'> " + Convert.ToDouble(chiPhiBangKe.DonGiaBH).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.TiLeThanhToanTheoDV).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.ThanhTienBV).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.MucHuongBaoHiem > 0 ? 100 : 0).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.ThanhTienBH).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.QuyBHYT).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.NguoiBenhCungChiTra).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.Khac).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.NguoiBenhTuTra).ApplyFormatMoneyToDouble(true) + "</td>" +
                                                "</tr>";
                                indexItem++;
                            }
                        }

                    }

                    dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                        "<td style='border: 1px solid #020000;' colspan='7'></span>" +
                                        "<span style='float:right;padding-right: 50px;'><b>Tổng Cộng</b></span>" +
                                        "</td>" +
                                        $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                        $"<td style='border: 1px solid #020000;text-align: right;'><b></b> </td>" +
                                        $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                        $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                        $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                        $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                        $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true)}</b> </td>" +
                                        "</tr>" +
                                        "</table>";

                }

                var checkedLyDoVaoVien = "<input id='demo_box_2' class='css - checkbox' type='checkbox' checked  disabled='true'/>";
                var unCheckedLyDoVaoVien = "<input id='demo_box_2' class='css - checkbox' type='checkbox' disabled='true' />";


                var ktKhoa = danhSachChiPhi.Key.Contains("Khoa");
                var maKhoa = _khoaPhongRepository.TableNoTracking.Where(c => c.Ten.Contains(danhSachChiPhi.Key)).Select(s => s.Ma).FirstOrDefault();

                //BVHD-3792
                var KhoaPhongId = _khoaPhongRepository.TableNoTracking.Where(c => c.Ten.Contains(danhSachChiPhi.Key)).Select(s => s.Id).FirstOrDefault();
                var chuyenKhoa = GetChuyenKhoa(KhoaPhongId);

                var data = new
                {
                    TitleBangKe = "ĐIỀU TRỊ NỘI TRÚ",
                    SoBangKe = "3",
                    yeuCauTiepNhan.BenhNhan.MaBN,
                    MaTN = yeuCauTiepNhan.MaYeuCauTiepNhan,
                    SoBenhAn = "Số bệnh án: " + yeuCauTiepNhan.NoiTruBenhAn?.SoBenhAn,
                    yeuCauTiepNhan.HoTen,
                    DiaChi = yeuCauTiepNhan.DiaChiDayDu,
                    BarCodeImgBase64 = !string.IsNullOrEmpty(yeuCauTiepNhan.MaYeuCauTiepNhan) ? BarcodeHelper.GenerateBarCode(yeuCauTiepNhan.MaYeuCauTiepNhan) : "",
                    NamSinh = DateHelper.DOBFormat(yeuCauTiepNhan.NgaySinh, yeuCauTiepNhan.ThangSinh, yeuCauTiepNhan.NamSinh),
                    GioiTinh = yeuCauTiepNhan.GioiTinh != null ? yeuCauTiepNhan.GioiTinh.GetDescription() : "",

                    TenKhoa = ktKhoa ? "Khoa: " + danhSachChiPhi.Key.ToString().Replace("Khoa", "") : danhSachChiPhi.Key,
                    MaKhoa = "Mã khoa: " + chuyenKhoa?.Ma,

                    MaBHYT = theBHYT?.MaSoThe,
                    BHYTTuNgay = bHYTTuNgay,
                    BHYTDenNgay = bHYTDenNgay,
                    NoiDKKCBBanDau,
                    MaKCBBanDau,
                    NgayDenKham = yeuCauTiepNhan.YeuCauNhapVien?.YeuCauKhamBenh?.YeuCauTiepNhan.ThoiDiemTiepNhan.ApplyFormatGioPhutNgay(),
                    DieuTriKNT = yeuCauTiepNhan.NoiTruBenhAn?.ThoiDiemNhapVien.ApplyFormatGioPhutNgay(),
                    KetThucKhamNgoaiTru = yeuCauTiepNhan.NoiTruBenhAn?.ThoiDiemRaVien?.ApplyFormatGioPhutNgay(),
                    SoNgayDTri = NoiTruBenhAnHelper.TinhSoNgayDieuTri(yeuCauTiepNhan.NoiTruBenhAn)?.ToString() ?? string.Empty,//yeuCauTiepNhan.NoiTruBenhAn?.ThoiDiemRaVien == null ? "" : (yeuCauTiepNhan.NoiTruBenhAn.ThoiDiemRaVien.Value.Date.AddDays(1) - yeuCauTiepNhan.NoiTruBenhAn.ThoiDiemNhapVien.Date).Days.ToString(),
                    TinhTrangRaVien = yeuCauTiepNhan.NoiTruBenhAn?.TinhTrangRaVien == EnumTinhTrangRaVien.RaVien && (yeuCauTiepNhan.NoiTruBenhAn?.KetQuaDieuTri == EnumKetQuaDieuTri.Do || yeuCauTiepNhan.NoiTruBenhAn?.KetQuaDieuTri == EnumKetQuaDieuTri.Khoi) ? 1 : 2,
                    MucHuong = mucHuong,
                    NoiChuyenDen = yeuCauTiepNhan.NoiChuyen?.Ten,
                    NoiChuyenDi = yeuCauTiepNhan.NoiTruBenhAn?.ChuyenDenBenhVien?.Ten,
                    MKV = theBHYT?.MaKhuVuc,
                    NgayMiemCungTC = theBHYT?.NgayDuocMienCungChiTra?.ApplyFormatDate(),
                    ThoiGian5Nam = theBHYT?.NgayDu5Nam?.ApplyFormatDate(),
                    CoCapCuu = yeuCauTiepNhan.LyDoVaoVien == Enums.EnumLyDoVaoVien.CapCuu ? checkedLyDoVaoVien : unCheckedLyDoVaoVien,
                    CoDungTuyen = yeuCauTiepNhan.LyDoVaoVien == Enums.EnumLyDoVaoVien.DungTuyen ? checkedLyDoVaoVien : unCheckedLyDoVaoVien,
                    CoThongTuyen = yeuCauTiepNhan.LyDoVaoVien == Enums.EnumLyDoVaoVien.ThongTuyen ? checkedLyDoVaoVien : unCheckedLyDoVaoVien,
                    CoTraiTuyen = yeuCauTiepNhan.LyDoVaoVien == Enums.EnumLyDoVaoVien.TraiTuyen ? checkedLyDoVaoVien : unCheckedLyDoVaoVien,

                    ChuanDoanXacDinh = yeuCauTiepNhan.NoiTruBenhAn != null && (yeuCauTiepNhan.NoiTruBenhAn.LoaiBenhAn == LoaiBenhAn.SanKhoaMo || yeuCauTiepNhan.NoiTruBenhAn.LoaiBenhAn == LoaiBenhAn.SanKhoaThuong) ? chuanDoanXacDinhSanKhoa : yeuCauTiepNhan.NoiTruBenhAn?.ChanDoanChinhRaVienGhiChu,
                    MaICD10 = yeuCauTiepNhan.NoiTruBenhAn != null && (yeuCauTiepNhan.NoiTruBenhAn.LoaiBenhAn == LoaiBenhAn.SanKhoaMo || yeuCauTiepNhan.NoiTruBenhAn.LoaiBenhAn == LoaiBenhAn.SanKhoaThuong) ? maICD10 : yeuCauTiepNhan.NoiTruBenhAn?.ChanDoanChinhRaVienICD?.Ma,


                    BenhKemTheo = tenICDKemTheo,
                    ICDKemTheo10 = maICDKemTheo,

                    DateItemChiPhis = dateItemChiPhis,

                    TTDV = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble(),
                    TTTTBHYT = "",

                    TTTienBH = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble(),
                    TQBHYT = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble(),
                    TNCCTra = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble(),
                    TongSoKhac = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble(),
                    TNBTuTra = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true),

                    TongChiPhi = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble(),
                    SoTienBangChu = NumberHelper.ChuyenSoRaText(Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBH))),

                    NguoiBenhPhaiTra = (Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)) + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhTuTra))).ApplyFormatMoneyToDouble(),

                    TTQuyTT = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble(),
                    BHYTChiTra = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble(),
                    CacKhoanTraKhac = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true),
                    SoTienKhac = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble(),
                    NgayHienTai = DateTime.Now.ApplyFormatNgayThangNam(),
                    Notice = "<div style='color: red; font-weight:800; margin-top:200px;'>Lưu ý : Bệnh nhân chưa quyết toán </div>"
                };

                var content = TemplateHelpper.FormatTemplateWithContentTemplate(result?.Body, data);
                inTheoKhoaChiDinh.Add(content);
            }

            return inTheoKhoaChiDinh;
        }
        public List<string> GetHtmlBangKeTheoKhoaChiDinh(long taiKhoanThuId, string hostingName)
        {
            List<string> inTheoKhoaChiDinh = new List<string>();
            var taiKhoanBenhNhanThu = _taiKhoanBenhNhanThuRepository.TableNoTracking.Where(c => c.Id == taiKhoanThuId && c.LoaiThuTienBenhNhan == Enums.LoaiThuTienBenhNhan.ThuTheoChiPhi)
                                                                                    .Include(o => o.YeuCauTiepNhan).ThenInclude(o => o.NoiTruBenhAn).ThenInclude(o => o.ChuyenDenBenhVien)
                                                                                    .Include(o => o.YeuCauTiepNhan).ThenInclude(o => o.NoiTruBenhAn).ThenInclude(o => o.KhoaPhongNhapVien)
                                                                                    .Include(o => o.YeuCauTiepNhan).ThenInclude(o => o.NoiTruBenhAn).ThenInclude(o => o.ChanDoanChinhRaVienICD)
                                                                                    .Include(o => o.YeuCauTiepNhan).ThenInclude(o => o.YeuCauTiepNhanTheBHYTs)
                                                                                    .Include(o => o.YeuCauTiepNhan).ThenInclude(o => o.YeuCauNhapVien).ThenInclude(o => o.YeuCauKhamBenh).ThenInclude(o => o.YeuCauTiepNhan)
                                                                                    .Include(cc => cc.YeuCauTiepNhan)
                                                                                    .ThenInclude(xx => xx.BenhNhan)
                                                                                    .Include(cc => cc.YeuCauTiepNhan)
                                                                                    .ThenInclude(xx => xx.YeuCauKhamBenhs)
                                                                                    .ThenInclude(o => o.YeuCauKhamBenhChuanDoans)
                                                                                    .ThenInclude(o => o.ChuanDoan)
                                                                                    .Include(cc => cc.YeuCauTiepNhan).ThenInclude(cc => cc.PhuongXa)
                                                                                    .Include(cc => cc.YeuCauTiepNhan)
                                                                                    .ThenInclude(cc => cc.QuanHuyen)
                                                                                    .Include(cc => cc.YeuCauTiepNhan)
                                                                                    .ThenInclude(cc => cc.TinhThanh)
                                                                                    .Include(cc => cc.YeuCauTiepNhan)
                                                                                    .ThenInclude(cc => cc.NoiChuyen)
                                                                                     .Include(o => o.YeuCauTiepNhan).ThenInclude(o => o.NoiTruBenhAn).ThenInclude(o => o.NoiTruPhieuDieuTris).ThenInclude(c => c.ChanDoanChinhICD)
                                                                                    .Include(o => o.YeuCauTiepNhan).ThenInclude(o => o.NoiTruBenhAn).ThenInclude(o => o.NoiTruPhieuDieuTris).ThenInclude(o => o.NoiTruThamKhamChanDoanKemTheos).ThenInclude(c => c.ICD)
                                                                                    .Include(o => o.YeuCauTiepNhan).ThenInclude(o => o.NoiTruBenhAn).ThenInclude(o => o.NoiTruKhoaPhongDieuTris).ThenInclude(c => c.KhoaPhongChuyenDen).FirstOrDefault();

            var yeuCauTiepNhan = taiKhoanBenhNhanThu.YeuCauTiepNhan;
            if (yeuCauTiepNhan == null)
                return null;

            var danhSachChiPhis = GetTatCaDichVuKhamChuaBenh(yeuCauTiepNhan.Id).Result
                                                .Where(o => !o.Soluong.AlmostEqual(0) && o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.DaThanhToan && o.YeuCauGoiDichVuId == null).GroupBy(c => c.Khoa);


            if (danhSachChiPhis == null)
            {
                return null;
            }

            var query = taiKhoanBenhNhanThu?.YeuCauTiepNhan;
            var result = _templateRepository.TableNoTracking.FirstOrDefault(x => x.Name.Equals("BangKeKhamBenhBHYTVaBenhVien"));

            foreach (var danhSachChiPhi in danhSachChiPhis)
            {


                var benhVien = new Core.Domain.Entities.BenhVien.BenhVien();

                string maBHYT = string.Empty;
                string bHYTTuNgay = string.Empty;
                string bHYTDenNgay = string.Empty;
                string mucHuong = string.Empty;
                string NoiDKKCBBanDau = string.Empty;
                string MaKCBBanDau = string.Empty;


                string maICDKemTheo = string.Empty;
                string tenICDKemTheo = string.Empty;


                string chuanDoanXacDinhSanKhoa = string.Empty;
                string maICD10 = string.Empty;

                if (yeuCauTiepNhan.NoiTruBenhAn != null && (yeuCauTiepNhan.NoiTruBenhAn.LoaiBenhAn == LoaiBenhAn.SanKhoaMo || yeuCauTiepNhan.NoiTruBenhAn.LoaiBenhAn == LoaiBenhAn.SanKhoaThuong))
                {
                    if (yeuCauTiepNhan.NoiTruBenhAn?.NoiTruPhieuDieuTris.Count() > 0)
                    {
                        var phieuDieuTri = yeuCauTiepNhan.NoiTruBenhAn?.NoiTruPhieuDieuTris.OrderByDescending(c => c.NgayDieuTri).FirstOrDefault();

                        var icdKemTheoIds = phieuDieuTri.NoiTruThamKhamChanDoanKemTheos.Select(c => c.ICD.Ma);
                        var tenICDKemTheos = phieuDieuTri.NoiTruThamKhamChanDoanKemTheos.Select(c => c.GhiChu);

                        maICDKemTheo = string.Join(", ", icdKemTheoIds);
                        tenICDKemTheo = string.Join(", ", tenICDKemTheos);

                        maICD10 = phieuDieuTri.ChanDoanChinhICD?.Ma;
                        chuanDoanXacDinhSanKhoa = phieuDieuTri.ChanDoanChinhGhiChu;
                    }
                }
                else
                {
                    if (!string.IsNullOrEmpty(yeuCauTiepNhan.NoiTruBenhAn?.DanhSachChanDoanKemTheoRaVienICDId))
                    {
                        var maICDKemTheos = new List<string>();

                        var icdKemTheoIds = yeuCauTiepNhan.NoiTruBenhAn?.DanhSachChanDoanKemTheoRaVienICDId.Split(Constants.ICDSeparator);
                        var tenICDKemTheos = yeuCauTiepNhan.NoiTruBenhAn?.DanhSachChanDoanKemTheoRaVienGhiChu?.Split(Constants.ICDSeparator);

                        if (icdKemTheoIds.Length > 0)
                        {
                            foreach (var icdKemTheoId in icdKemTheoIds)
                            {
                                var icdKemTheo = _icdRepository.TableNoTracking.FirstOrDefault(o => o.Id == long.Parse(icdKemTheoId));
                                if (icdKemTheo != null)
                                {
                                    maICDKemTheos.Add(icdKemTheo.Ma);
                                }

                                //if (long.TryParse(yeuCauTiepNhan.NoiTruBenhAn?.DanhSachChanDoanKemTheoRaVienICDId.Split(Constants.ICDSeparator).First(), out var icdKemTheoId))
                                //{
                                //    var icdKemTheo = _icdRepository.TableNoTracking.FirstOrDefault(o => o.Id == icdKemTheoId);
                                //    if (icdKemTheo != null)
                                //    {
                                //        maICDKemTheo = icdKemTheo.Ma;
                                //        tenICDKemTheo = yeuCauTiepNhan.NoiTruBenhAn?.DanhSachChanDoanKemTheoRaVienGhiChu?.Split(Constants.ICDSeparator).First();
                                //    }
                                //}
                            }
                        }

                        maICDKemTheo = string.Join(", ", maICDKemTheos);
                        tenICDKemTheo = string.Join(", ", tenICDKemTheos);
                    }
                }


                YeuCauTiepNhanTheBHYT theBHYT = null;
                if (yeuCauTiepNhan.CoBHYT == true && yeuCauTiepNhan.YeuCauTiepNhanTheBHYTs.Any())
                {
                    theBHYT = yeuCauTiepNhan.YeuCauTiepNhanTheBHYTs.First();
                    if (!String.IsNullOrEmpty(theBHYT.MaDKBD))
                    {
                        benhVien = _benhVienRepository.TableNoTracking.FirstOrDefault(p => p.Ma.Equals(theBHYT.MaDKBD));
                    }
                    maBHYT = theBHYT.MaSoThe;
                    bHYTTuNgay = theBHYT.NgayHieuLuc.ApplyFormatDate();
                    bHYTDenNgay = theBHYT.NgayHetHan?.ApplyFormatDate();
                    mucHuong = theBHYT.MucHuong.ToString() + "%";
                    NoiDKKCBBanDau = benhVien != null ? benhVien?.Ten : "Chưa xác định";
                    MaKCBBanDau = theBHYT.MaDKBD;
                }
                else
                {
                    maBHYT = "";
                    bHYTTuNgay = "";
                    bHYTDenNgay = "";
                    mucHuong = "0%";
                    NoiDKKCBBanDau = "Chưa xác định";
                    MaKCBBanDau = "Chưa xác định";
                }

                //var thongTinPhieuThus = GetThongTinPhieuThu(taiKhoanThuId, LoaiPhieuThuChiThuNgan.ThuTheoChiPhi);
                //if (thongTinPhieuThus.ChiPhiKhamChuaBenhNoiTruVos.Count == 0)
                //{
                //    return string.Empty;
                //}
                var dsChiPhiBangKe = new List<BangKeKhamBenhBenhVienVo>();
                var dateItemChiPhis = string.Empty;
                int indexItem = 1;
                var groupChiPhiTheoThe = danhSachChiPhi.GroupBy(o => o.MaSoTheBHYT);

                var ngayNhapVien = yeuCauTiepNhan.NoiTruBenhAn.ThoiDiemNhapVien.ApplyFormatDate();
                var ngayRaVien = yeuCauTiepNhan.NoiTruBenhAn.ThoiDiemRaVien?.ApplyFormatDate();


                if (groupChiPhiTheoThe.Count() > 2 ||
                    (groupChiPhiTheoThe.All(o => o.Key != string.Empty) && groupChiPhiTheoThe.Count() > 1))
                {
                    var groupNgayPhatSinhTheoThe = groupChiPhiTheoThe.Where(o => o.Key != string.Empty).Select(o => new { o.Key, o.OrderBy(j => j.NgayPhatSinh).First().NgayPhatSinh }).OrderBy(o => o.NgayPhatSinh).ToArray();
                    for (int i = 0; i < groupNgayPhatSinhTheoThe.Count(); i++)
                    {
                        var ngayPhatSinhTheoThe = groupNgayPhatSinhTheoThe[i];
                        var theBHYTChiTra = yeuCauTiepNhan.YeuCauTiepNhanTheBHYTs.First(o => o.MaSoThe == ngayPhatSinhTheoThe.Key);
                        var chiPhis = groupChiPhiTheoThe.FirstOrDefault(o => o.Key == ngayPhatSinhTheoThe.Key).ToList();
                        DateTime? ngayPhatSinhTiepTheo = i < groupNgayPhatSinhTheoThe.Count() - 1
                            ? groupNgayPhatSinhTheoThe[i + 1].NgayPhatSinh
                            : null;
                        chiPhis.AddRange(groupChiPhiTheoThe.FirstOrDefault(o => o.Key == string.Empty).Where(j => (i == 0 || j.NgayPhatSinh >= ngayPhatSinhTheoThe.NgayPhatSinh) && (ngayPhatSinhTiepTheo != null && j.NgayPhatSinh < ngayPhatSinhTiepTheo)).ToList());
                        var mucHuongPT = theBHYTChiTra != null && theBHYTChiTra?.MucHuong > 0 ? theBHYTChiTra?.MucHuong + "%" : string.Empty;

                        dateItemChiPhis += "<table style='width: 100 %;margin-bottom:-21px;  '>" +
                                           "<tbody>" +
                                           "<tr>" +
                                           $"<td style='padding-left:-5px; width: 40 %; '>Mã thẻ BHYT {i + 1}: <b>{theBHYTChiTra.MaSoThe}</b> " +
                                           $"<span style='padding-left:20px'>Giá trị từ: <b>{theBHYTChiTra.NgayHieuLuc.ApplyFormatDate()}</b> đến <b>{theBHYTChiTra.NgayHetHan?.ApplyFormatDate()}</b></span>" +
                                           $"<span style='padding-left:20px'>Mức hưởng: <b>{mucHuongPT}</b></span></td>" +
                                           "</tr>" +

                                          //Thêm dòng: (Chi phí KCB tính từ ngày...đến ngày...) BVHD-3792
                                          "<tr>" +
                                           $"<td>" +
                                           $"<span> (Chi phí KCB tính từ ngày <b>{ngayNhapVien}</b> đến ngày <b>{ngayRaVien}</b>) </span></td>" +
                                          "</tr>" +

                                           "</tbody>" +
                                           "</table>" +
                                           "</br>" +
                                           "<table style='width:100%;border: 1px solid #020000; border-collapse: collapse;'>" +
                                                "<tr style='border: 1px solid black;  border-collapse: collapse;'>" +
                                                "<th style='border: 1px solid #020000; border-collapse: collapse;text-align: center;' rowspan='2'>" +
                                                        "STT </th>" +
                                                    "<th style='border: 1px solid #020000; border-collapse: collapse;width:35%;text-align: center;' rowspan='2'>" +
                                                        "Nội dung </th>" +
                                                    "<th style='border: 1px solid #020000; border-collapse: collapse;width:5%;text-align: center;' rowspan='2'>" +
                                                        "Đơn vị tính</th>" +
                                                    "<th style='border: 1px solid #020000; border-collapse: collapse;width:3%; text-align: center;' rowspan='2'>" +
                                                        "Số lượng</th>" +
                                                    "<th style='border: 1px solid #020000; border-collapse: collapse;width:3%; text-align: center;' rowspan='2'>" +
                                                        "Đơn giá BV <span style='font-weight: 100;'>(đồng)</span></th>" +
                                                    "<th style='border: 1px solid #020000; border-collapse: collapse;width:3%; text-align: center;' rowspan='2'>" +
                                                        "Đơn giá BH  <span style='font-weight: 100;'>(đồng)</span></th>" +
                                                    "<th style='border: 1px solid #020000; border-collapse: collapse;width:200px; text-align: center;'" +
                                                        "rowspan='2'>" +
                                                        "Tỉ lệ thanh toán theo dich vụ   <span style='font-weight: 100;'>(%)</span></th>" +
                                                    "<th style='border: 1px solid #020000; border-collapse: collapse;width:8%;text-align: center;' rowspan='2'>" +
                                                        "Thành tiền BV  <span style='font-weight: 100;'>(đồng)</span>" +
                                                    "</th>" +
                                                    "<th style='border: 1px solid #020000; border-collapse: collapse;width:200px; text-align: center;'" +
                                                        "rowspan='2'>" +
                                                        "Tỷ lệ thanh toán BHYT <span style='font-weight: 100;'>(%)</span>" +
                                                    "</th>" +
                                                    "<th style='border: 1px solid #020000; border-collapse: collapse;width:8%;text-align: center;' rowspan='2'>" +
                                                        "Thành tiền BH  <span style='font-weight: 100;'>(đồng)</span>" +
                                                    "</th>" +
                                                    "<th style='border: 1px solid #020000; border-collapse: collapse;width:35%;text-align: center;' colspan='4'>" +
                                                        "Nguồn thanh toán  <span style='font-weight: 100;'>(đồng)</span></th>" +
                                                "</tr>" +
                                                "<tr style='border: 1px solid #020000; border-collapse: collapse;'>" +
                                                    "<td style='border: 1px solid #020000; border-collapse: collapse;text-align: center;'><b>Quỹ BHYT</b></td>" +
                                                    "<td style=' border: 1px solid #020000; border-collapse: collapse;width:80px;text-align: center;'>" +
                                                        "<b>Người bệnh cùng chi" +
                                                        " trả</b> (đồng)</td>" +
                                                    "<td style=' border: 1px solid #020000; border-collapse: collapse;text-align: center;'><b>Khác</b> (đồng)</td>" +
                                                    "<td style='border: 1px solid #020000; border-collapse: collapse;text-align: center;width: 90px;'>" +
                                                        "<b>Người bệnh" +
                                                        "tự trả </b>(đồng)" +
                                                    "</td>" +
                                                "</tr>" +
                                                "<tr style=' border: 1px solid #020000; '>" +
                                                  "<td style='border: 1px solid #020000;text-align: center;'><b> </b> </td>" +
                                                    "<td style='border: 1px solid #020000;text-align: center;'><b>(1)</b> </td>" +
                                                    "<td style='border: 1px solid #020000;text-align: center;'><b>(2)</b> </td>" +
                                                    "<td style='border: 1px solid #020000;text-align: center;'><b>(3)</b> </td>" +
                                                    "<td style='border: 1px solid #020000;text-align: center;'><b>(4)</b> </td>" +
                                                    "<td style='border: 1px solid #020000;text-align: center;'><b>(5)</b> </td>" +
                                                    "<td style='border: 1px solid #020000;text-align: center;'><b>(6)</b> </td>" +
                                                    "<td style='border: 1px solid #020000;text-align: center;'><b>(7)</b> </td>" +
                                                    "<td style='border: 1px solid #020000;text-align: center;'><b>(8)</b> </td>" +
                                                    "<td style='border: 1px solid #020000;text-align: center;'><b>(9)</b> </td>" +
                                                    "<td style='border: 1px solid #020000;text-align: center;'><b>(10)</b> </td>" +
                                                    "<td style='border: 1px solid #020000;text-align: center;'><b>(11)</b> </td>" +
                                                    "<td style='border: 1px solid #020000;text-align: center;'><b>(12)</b> </td>" +
                                                    "<td style='border: 1px solid #020000;text-align: center;'><b>(13)</b> </td>" +
                                                "</tr>";

                        var dsChiPhiBangKeTheoThe = new List<BangKeKhamBenhBenhVienVo>();

                        foreach (var chiPhi in chiPhis.Where(c => c.NhomChiPhiBangKe != NhomChiPhiBangKe.GoiVatTu && c.YeuCauGoiDichVuId == null).GroupBy(c => new { c.DonGia, c.SoTienMG, KhongTinhPhi = c.KhongTinhPhi.GetValueOrDefault(), c.NhomChiPhiBangKe, c.TenDichVu, c.DonViTinh, c.DuocHuongBHYT, c.DonGiaBHYT, c.MucHuongBaoHiem, c.TiLeBaoHiemThanhToan }).OrderByDescending(o => o.Key.DuocHuongBHYT))
                        {
                            var chiphiBangKe = new BangKeKhamBenhBenhVienVo
                            {
                                Nhom = chiPhi.Key.NhomChiPhiBangKe,
                                Id = chiPhi.FirstOrDefault().Id,
                                NoiDung = chiPhi.Key.TenDichVu,
                                DonViTinh = chiPhi.Key.DonViTinh,
                                SoLuong = (decimal)chiPhi.Sum(c => c.Soluong),
                                DuocHuongBaoHiem = chiPhi.Key.DuocHuongBHYT,
                                DonGiaBH = chiPhi.Key.DuocHuongBHYT ? chiPhi.Key.DonGiaBHYT : 0,
                                MucHuongBaoHiem = chiPhi.Key.MucHuongBaoHiem,
                                TiLeThanhToanTheoDV = chiPhi.Key.TiLeBaoHiemThanhToan,
                                BaoHiemChiTra = true,
                                DonGiaBV = chiPhi.Key.DonGia
                            };
                            if (chiPhi.Key.KhongTinhPhi == true)
                            {
                                chiphiBangKe.Khac = chiPhi.Key.MucHuongBaoHiem > 0
                                    ? (chiphiBangKe.ThanhTienBV.GetValueOrDefault() - chiphiBangKe.ThanhTienBH.GetValueOrDefault())
                                    : chiphiBangKe.ThanhTienBV.GetValueOrDefault();
                            }
                            else
                            {
                                chiphiBangKe.Khac = chiPhi.Sum(c => c.SoTienMG);
                            }
                            dsChiPhiBangKeTheoThe.Add(chiphiBangKe);
                        }

                        foreach (var chiPhi in chiPhis.Where(c => !(c.NhomChiPhiBangKe != NhomChiPhiBangKe.GoiVatTu && c.YeuCauGoiDichVuId == null)))
                        {
                            var chiphiBangKe = new BangKeKhamBenhBenhVienVo
                            {
                                Nhom = chiPhi.NhomChiPhiBangKe,
                                Id = chiPhi.Id,
                                NoiDung = chiPhi.TenDichVu,
                                DonViTinh = chiPhi.DonViTinh,
                                SoLuong = (decimal)chiPhi.Soluong,
                                DuocHuongBaoHiem = chiPhi.DuocHuongBHYT,
                                DonGiaBH = chiPhi.DuocHuongBHYT ? chiPhi.DonGiaBHYT : 0,
                                MucHuongBaoHiem = chiPhi.MucHuongBaoHiem,
                                TiLeThanhToanTheoDV = chiPhi.TiLeBaoHiemThanhToan,
                                BaoHiemChiTra = true,
                                DonGiaBV = chiPhi.DonGia
                            };
                            if (chiPhi.KhongTinhPhi == true || chiPhi.YeuCauGoiDichVuId != null)
                            {
                                chiphiBangKe.Khac = chiPhi.MucHuongBaoHiem > 0
                                    ? (chiphiBangKe.ThanhTienBV.GetValueOrDefault() - chiphiBangKe.ThanhTienBH.GetValueOrDefault())
                                    : chiphiBangKe.ThanhTienBV.GetValueOrDefault();
                            }
                            else
                            {
                                chiphiBangKe.Khac = chiPhi.SoTienMG;
                            }
                            dsChiPhiBangKeTheoThe.Add(chiphiBangKe);
                        }
                        //foreach (var chiPhi in chiPhis)
                        //{
                        //    dsChiPhiBangKeTheoThe.Add(new BangKeKhamBenhBenhVienVo
                        //    {
                        //        Nhom = chiPhi.NhomChiPhiBangKe,
                        //        Id = chiPhi.Id,
                        //        NoiDung = chiPhi.TenDichVu,
                        //        DonViTinh = chiPhi.DonViTinh,
                        //        SoLuong = (decimal)chiPhi.Soluong,
                        //        DuocHuongBaoHiem = chiPhi.DuocHuongBHYT,
                        //        DonGiaBH = chiPhi.DuocHuongBHYT ? chiPhi.DonGiaBHYT : 0,
                        //        MucHuongBaoHiem = chiPhi.MucHuongBaoHiem,
                        //        TiLeThanhToanTheoDV = chiPhi.TiLeBaoHiemThanhToan,
                        //        BaoHiemChiTra = true,
                        //        DonGiaBV = chiPhi.DonGia
                        //    });
                        //}
                        dsChiPhiBangKe.AddRange(dsChiPhiBangKeTheoThe);
                        var groupChiPhiBangKes = dsChiPhiBangKeTheoThe.GroupBy(x => x.Nhom).OrderBy(o => (int)o.Key * (o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay || o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriNoiTru ? 1 : 10));
                        foreach (var groupChiPhiBangKe in groupChiPhiBangKes)
                        {
                            if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay)
                            {

                                dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                                   "<td style='border: 1px solid #020000;' colspan='7'>" +
                                                   "<span style='float:left;'><b>2. Ngày giường:  </b></span>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                   "</tr>";
                                dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                                   "<td style='border: 1px solid #020000;' colspan='7'>" +
                                                   "<span style='float:left;'><b>2.1." + groupChiPhiBangKe.Key.GetDescription() + "  </b></span>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'><b> " + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true) + "</b> </td>" +
                                                   "</tr>";
                            }
                            else if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.NgayGiuongDieuTriNoiTru)
                            {
                                if (!groupChiPhiBangKes.Any(o => o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay))
                                {
                                    dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                                       "<td style='border: 1px solid #020000;' colspan='7'>" +
                                                       "<span style='float:left;'><b>2. Ngày giường:  </b></span>" +
                                                       "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                       "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                       "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                       "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                       "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                       "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                       "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                       "</tr>";
                                }
                                dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                                   "<td style='border: 1px solid #020000;' colspan='7'>" +
                                                   "<span style='float:left;'><b>2.2." + groupChiPhiBangKe.Key.GetDescription() + "  </b></span>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'><b> " + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true) + "</b> </td>" +
                                                   "</tr>";
                            }
                            else
                            {
                                dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                                   "<td style='border: 1px solid #020000;' colspan='7'>" +
                                                   "<span style='float:left;'><b>" + (int)groupChiPhiBangKe.Key + "." + groupChiPhiBangKe.Key.GetDescription() + "  </b></span>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                   "<td style='border: 1px solid #020000;text-align: right;'><b> " + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true) + "</b> </td>" +
                                                   "</tr>";
                            }
                            if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.GoiVatTu)
                            {
                                var groupGoiVatTus = groupChiPhiBangKe.ToList().GroupBy(o => o.SoGoiVatTu.GetValueOrDefault()).OrderBy(o => o.Key);
                                int sttGoiVatTu = 1;
                                foreach (var groupGoiVatTu in groupGoiVatTus)
                                {
                                    dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                                       "<td style='border: 1px solid #020000;' colspan='7'>" +
                                                       "<span style='float:left;'><b>10." + sttGoiVatTu + ". " + groupChiPhiBangKe.Key.GetDescription() + " " + sttGoiVatTu + "  </b></span>" +
                                                       "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                       "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                       "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                       "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                       "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                       "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.Khac)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                       "<td style='border: 1px solid #020000;text-align: right;'><b> " + Convert.ToDouble(groupGoiVatTu.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true) + "</b> </td>" +
                                                       "</tr>";
                                    foreach (var chiPhiBangKe in groupGoiVatTu)
                                    {
                                        dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                                        "<td style='border: 1px solid #020000; text-align: center;'> " + indexItem + "</td>" +
                                                        "<td style='border: 1px solid #020000;text-align: left;'> " + chiPhiBangKe.NoiDung + "</td>" +
                                                        "<td style='border: 1px solid #020000;text-align: center;'>  " + chiPhiBangKe.DonViTinh + " </td>" +
                                                        "<td style='border: 1px solid #020000;text-align: center;'> " + chiPhiBangKe.SoLuong + "</td>" +
                                                        "<td style='border: 1px solid #020000;text-align: center;'> " + Convert.ToDouble(chiPhiBangKe.DonGiaBV).ApplyFormatMoneyToDouble() + "</td>" +
                                                        "<td style='border: 1px solid #020000;text-align: center;'> " + Convert.ToDouble(chiPhiBangKe.DonGiaBH).ApplyFormatMoneyToDouble() + "</td>" +
                                                        "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.TiLeThanhToanTheoDV).ApplyFormatMoneyToDouble() + "</td>" +
                                                        "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.ThanhTienBV).ApplyFormatMoneyToDouble() + "</td>" +
                                                        "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.MucHuongBaoHiem > 0 ? 100 : 0).ApplyFormatMoneyToDouble() + "</td>" +
                                                        "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.ThanhTienBH).ApplyFormatMoneyToDouble() + "</td>" +
                                                        "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.QuyBHYT).ApplyFormatMoneyToDouble() + "</td>" +
                                                        "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.NguoiBenhCungChiTra).ApplyFormatMoneyToDouble() + "</td>" +
                                                        "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.Khac).ApplyFormatMoneyToDouble() + "</td>" +
                                                        "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.NguoiBenhTuTra).ApplyFormatMoneyToDouble(true) + "</td>" +
                                                        "</tr>";
                                        indexItem++;
                                    }
                                }
                            }
                            else
                            {
                                foreach (var chiPhiBangKe in groupChiPhiBangKe)
                                {
                                    dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                                    "<td style='border: 1px solid #020000; text-align: center;'> " + indexItem + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: left;'> " + chiPhiBangKe.NoiDung + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: center;'>  " + chiPhiBangKe.DonViTinh + " </td>" +
                                                    "<td style='border: 1px solid #020000;text-align: center;'> " + chiPhiBangKe.SoLuong + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: center;'> " + Convert.ToDouble(chiPhiBangKe.DonGiaBV).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: center;'> " + Convert.ToDouble(chiPhiBangKe.DonGiaBH).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.TiLeThanhToanTheoDV).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.ThanhTienBV).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.MucHuongBaoHiem > 0 ? 100 : 0).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.ThanhTienBH).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.QuyBHYT).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.NguoiBenhCungChiTra).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.Khac).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.NguoiBenhTuTra).ApplyFormatMoneyToDouble(true) + "</td>" +
                                                    "</tr>";
                                    indexItem++;
                                }
                            }

                        }

                        dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                           "<td style='border: 1px solid #020000;' colspan='7'></span>" +
                                           "<span style='float:right;padding-right: 50px;'><b>Tổng Cộng</b></span>" +
                                           "</td>" +
                                           $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKeTheoThe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                           $"<td style='border: 1px solid #020000;text-align: right;'><b></b> </td>" +
                                           $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKeTheoThe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                           $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKeTheoThe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                           $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKeTheoThe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                           $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKeTheoThe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                           $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKeTheoThe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true)}</b> </td>" +
                                           "</tr>" +
                                           "</table>";
                    }
                }
                else
                {
                    YeuCauTiepNhanTheBHYT theBHYTChiTra = null;
                    var maSoThe = groupChiPhiTheoThe.Where(o => o.Key != string.Empty).FirstOrDefault()?.Key;
                    if (!string.IsNullOrEmpty(maSoThe))
                    {
                        theBHYTChiTra = yeuCauTiepNhan.YeuCauTiepNhanTheBHYTs.First(o => o.MaSoThe == maSoThe);
                    }

                    var chiPhis = groupChiPhiTheoThe.SelectMany(o => o).ToList();
                    var mucHuongPT = theBHYTChiTra != null && theBHYTChiTra?.MucHuong > 0 ? theBHYTChiTra?.MucHuong + "%" : string.Empty;

                    dateItemChiPhis += "<table style='width: 100 %;margin-bottom:-21px;'>" +
                                        "<tbody>" +
                                        "<tr>" +
                                           $"<td style='padding-left:-5px; width: 40 %; '>Mã thẻ BHYT: <b>{theBHYTChiTra?.MaSoThe}</b> " +
                                           $"<span style='padding-left:20px'>Giá trị từ: <b>{theBHYTChiTra?.NgayHieuLuc.ApplyFormatDate()}</b> đến <b>{theBHYTChiTra?.NgayHetHan?.ApplyFormatDate()}</b></span>" +
                                           $"<span style='padding-left:20px'>Mức hưởng: <b>{mucHuongPT}</b></span></td>" +
                                           "</tr>" +

                                          //Thêm dòng: (Chi phí KCB tính từ ngày...đến ngày...) BVHD-3792
                                          "<tr>" +
                                           $"<td>" +
                                           $"<span> (Chi phí KCB tính từ ngày <b>{ngayNhapVien}</b> đến ngày <b>{ngayRaVien}</b>) </span></td>" +
                                          "</tr>" +

                                        "</tbody>" +
                                        "</table>" +
                                        "</br>" +
                                        "<table style='width:100%;border: 1px solid #020000; border-collapse: collapse;'>" +
                                            "<tr style='border: 1px solid black;  border-collapse: collapse;'>" +
                                            "<th style='border: 1px solid #020000; border-collapse: collapse;text-align: center;' rowspan='2'>" +
                                                    "STT </th>" +
                                                "<th style='border: 1px solid #020000; border-collapse: collapse;width:35%;text-align: center;' rowspan='2'>" +
                                                    "Nội dung </th>" +
                                                "<th style='border: 1px solid #020000; border-collapse: collapse;width:5%;text-align: center;' rowspan='2'>" +
                                                    "Đơn vị tính</th>" +
                                                "<th style='border: 1px solid #020000; border-collapse: collapse;width:3%; text-align: center;' rowspan='2'>" +
                                                    "Số lượng</th>" +
                                                "<th style='border: 1px solid #020000; border-collapse: collapse;width:3%; text-align: center;' rowspan='2'>" +
                                                    "Đơn giá BV <span style='font-weight: 100;'>(đồng)</span></th>" +
                                                "<th style='border: 1px solid #020000; border-collapse: collapse;width:3%; text-align: center;' rowspan='2'>" +
                                                    "Đơn giá BH  <span style='font-weight: 100;'>(đồng)</span></th>" +
                                                "<th style='border: 1px solid #020000; border-collapse: collapse;width:200px; text-align: center;'" +
                                                    "rowspan='2'>" +
                                                    "Tỉ lệ thanh toán theo dich vụ   <span style='font-weight: 100;'>(%)</span></th>" +
                                                "<th style='border: 1px solid #020000; border-collapse: collapse;width:8%;text-align: center;' rowspan='2'>" +
                                                    "Thành tiền BV  <span style='font-weight: 100;'>(đồng)</span>" +
                                                "</th>" +
                                                "<th style='border: 1px solid #020000; border-collapse: collapse;width:200px; text-align: center;'" +
                                                    "rowspan='2'>" +
                                                    "Tỷ lệ thanh toán BHYT <span style='font-weight: 100;'>(%)</span>" +
                                                "</th>" +
                                                "<th style='border: 1px solid #020000; border-collapse: collapse;width:8%;text-align: center;' rowspan='2'>" +
                                                    "Thành tiền BH  <span style='font-weight: 100;'>(đồng)</span>" +
                                                "</th>" +
                                                "<th style='border: 1px solid #020000; border-collapse: collapse;width:35%;text-align: center;' colspan='4'>" +
                                                    "Nguồn thanh toán  <span style='font-weight: 100;'>(đồng)</span></th>" +
                                            "</tr>" +
                                            "<tr style='border: 1px solid #020000; border-collapse: collapse;'>" +
                                                "<td style='border: 1px solid #020000; border-collapse: collapse;text-align: center;'><b>Quỹ BHYT</b></td>" +
                                                "<td style=' border: 1px solid #020000; border-collapse: collapse;width:80px;text-align: center;'>" +
                                                    "<b>Người bệnh cùng chi " +
                                                    " trả</b> (đồng)</td>" +
                                                "<td style=' border: 1px solid #020000; border-collapse: collapse;text-align: center;'><b>Khác</b> (đồng)</td>" +
                                                "<td style='border: 1px solid #020000; border-collapse: collapse;text-align: center;width: 90px;'>" +
                                                    "<b>Người bệnh" +
                                                    "tự trả </b>(đồng)" +
                                                "</td>" +
                                            "</tr>" +
                                            "<tr style=' border: 1px solid #020000; '>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b> </b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(1)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(2)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(3)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(4)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(5)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(6)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(7)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(8)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(9)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(10)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(11)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(12)</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'><b>(13)</b> </td>" +
                                            "</tr>";


                    //foreach (var chiPhi in chiPhis)
                    //{
                    //    dsChiPhiBangKe.Add(new BangKeKhamBenhBenhVienVo
                    //    {
                    //        Nhom = chiPhi.NhomChiPhiBangKe,
                    //        Id = chiPhi.Id,
                    //        NoiDung = chiPhi.TenDichVu,
                    //        DonViTinh = chiPhi.DonViTinh,
                    //        SoLuong = (decimal)chiPhi.Soluong,
                    //        DuocHuongBaoHiem = chiPhi.DuocHuongBHYT,
                    //        DonGiaBH = chiPhi.DuocHuongBHYT ? chiPhi.DonGiaBHYT : 0,
                    //        MucHuongBaoHiem = chiPhi.MucHuongBaoHiem,
                    //        TiLeThanhToanTheoDV = chiPhi.TiLeBaoHiemThanhToan,
                    //        BaoHiemChiTra = true,
                    //        DonGiaBV = chiPhi.DonGia
                    //    });
                    //}
                    foreach (var chiPhi in chiPhis.Where(c => c.NhomChiPhiBangKe != NhomChiPhiBangKe.GoiVatTu && c.YeuCauGoiDichVuId == null).GroupBy(c => new { c.DonGia, c.SoTienMG, KhongTinhPhi = c.KhongTinhPhi.GetValueOrDefault(), c.NhomChiPhiBangKe, c.TenDichVu, c.DonViTinh, c.DuocHuongBHYT, c.DonGiaBHYT, c.MucHuongBaoHiem, c.TiLeBaoHiemThanhToan }).OrderByDescending(o => o.Key.DuocHuongBHYT))
                    {
                        var chiphiBangKe = new BangKeKhamBenhBenhVienVo
                        {
                            Nhom = chiPhi.Key.NhomChiPhiBangKe,
                            Id = chiPhi.FirstOrDefault().Id,
                            NoiDung = chiPhi.Key.TenDichVu,
                            DonViTinh = chiPhi.Key.DonViTinh,
                            SoLuong = (decimal)chiPhi.Sum(c => c.Soluong),
                            DuocHuongBaoHiem = chiPhi.Key.DuocHuongBHYT,
                            DonGiaBH = chiPhi.Key.DuocHuongBHYT ? chiPhi.Key.DonGiaBHYT : 0,
                            MucHuongBaoHiem = chiPhi.Key.MucHuongBaoHiem,
                            TiLeThanhToanTheoDV = chiPhi.Key.TiLeBaoHiemThanhToan,
                            BaoHiemChiTra = true,
                            DonGiaBV = chiPhi.Key.DonGia
                        };
                        if (chiPhi.Key.KhongTinhPhi == true)
                        {
                            chiphiBangKe.Khac = chiPhi.Key.MucHuongBaoHiem > 0
                                ? (chiphiBangKe.ThanhTienBV.GetValueOrDefault() - chiphiBangKe.ThanhTienBH.GetValueOrDefault())
                                : chiphiBangKe.ThanhTienBV.GetValueOrDefault();
                        }
                        else
                        {
                            chiphiBangKe.Khac = chiPhi.Sum(c => c.SoTienMG);
                        }
                        dsChiPhiBangKe.Add(chiphiBangKe);
                    }


                    foreach (var chiPhi in chiPhis.Where(c => !(c.NhomChiPhiBangKe != NhomChiPhiBangKe.GoiVatTu && c.YeuCauGoiDichVuId == null)))
                    {
                        var chiphiBangKe = new BangKeKhamBenhBenhVienVo
                        {
                            Nhom = chiPhi.NhomChiPhiBangKe,
                            Id = chiPhi.Id,
                            NoiDung = chiPhi.TenDichVu,
                            DonViTinh = chiPhi.DonViTinh,
                            SoLuong = (decimal)chiPhi.Soluong,
                            DuocHuongBaoHiem = chiPhi.DuocHuongBHYT,
                            DonGiaBH = chiPhi.DuocHuongBHYT ? chiPhi.DonGiaBHYT : 0,
                            MucHuongBaoHiem = chiPhi.MucHuongBaoHiem,
                            TiLeThanhToanTheoDV = chiPhi.TiLeBaoHiemThanhToan,
                            BaoHiemChiTra = true,
                            DonGiaBV = chiPhi.DonGia
                        };
                        if (chiPhi.KhongTinhPhi == true || chiPhi.YeuCauGoiDichVuId != null)
                        {
                            chiphiBangKe.Khac = chiPhi.MucHuongBaoHiem > 0
                                ? (chiphiBangKe.ThanhTienBV.GetValueOrDefault() - chiphiBangKe.ThanhTienBH.GetValueOrDefault())
                                : chiphiBangKe.ThanhTienBV.GetValueOrDefault();
                        }
                        else
                        {
                            chiphiBangKe.Khac = chiPhi.SoTienMG;
                        }
                        dsChiPhiBangKe.Add(chiphiBangKe);
                    }

                    var groupChiPhiBangKes = dsChiPhiBangKe.GroupBy(x => x.Nhom).OrderBy(o => (int)o.Key * (o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay || o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriNoiTru ? 1 : 10));
                    foreach (var groupChiPhiBangKe in groupChiPhiBangKes)
                    {
                        if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay)
                        {

                            dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                                "<td style='border: 1px solid #020000;' colspan='7'>" +
                                                "<span style='float:left;'><b>2. Ngày giường:  </b></span>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                "</tr>";
                            dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                                "<td style='border: 1px solid #020000;' colspan='7'>" +
                                                "<span style='float:left;'><b>2.1." + groupChiPhiBangKe.Key.GetDescription() + "  </b></span>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'><b> " + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true) + "</b> </td>" +
                                                "</tr>";
                        }
                        else if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.NgayGiuongDieuTriNoiTru)
                        {
                            if (!groupChiPhiBangKes.Any(o => o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay))
                            {
                                dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                                    "<td style='border: 1px solid #020000;' colspan='7'>" +
                                                    "<span style='float:left;'><b>2. Ngày giường:  </b></span>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                    "</tr>";
                            }
                            dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                                "<td style='border: 1px solid #020000;' colspan='7'>" +
                                                "<span style='float:left;'><b>2.2." + groupChiPhiBangKe.Key.GetDescription() + "  </b></span>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'><b> " + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true) + "</b> </td>" +
                                                "</tr>";
                        }
                        else
                        {
                            dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                                "<td style='border: 1px solid #020000;' colspan='7'>" +
                                                "<span style='float:left;'><b>" + (int)groupChiPhiBangKe.Key + "." + groupChiPhiBangKe.Key.GetDescription() + "  </b></span>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'><b> " + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true) + "</b> </td>" +
                                                "</tr>";
                        }
                        if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.GoiVatTu)
                        {
                            var groupGoiVatTus = groupChiPhiBangKe.ToList().GroupBy(o => o.SoGoiVatTu.GetValueOrDefault()).OrderBy(o => o.Key);
                            int sttGoiVatTu = 1;
                            foreach (var groupGoiVatTu in groupGoiVatTus)
                            {
                                dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                                    "<td style='border: 1px solid #020000;' colspan='7'>" +
                                                    "<span style='float:left;'><b>10." + sttGoiVatTu + ". " + groupChiPhiBangKe.Key.GetDescription() + " " + sttGoiVatTu + "  </b></span>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.Khac)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'><b> " + Convert.ToDouble(groupGoiVatTu.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true) + "</b> </td>" +
                                                    "</tr>";
                                foreach (var chiPhiBangKe in groupGoiVatTu)
                                {
                                    dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                                    "<td style='border: 1px solid #020000; text-align: center;'> " + indexItem + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: left;'> " + chiPhiBangKe.NoiDung + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: center;'>  " + chiPhiBangKe.DonViTinh + " </td>" +
                                                    "<td style='border: 1px solid #020000;text-align: center;'> " + chiPhiBangKe.SoLuong + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: center;'> " + Convert.ToDouble(chiPhiBangKe.DonGiaBV).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: center;'> " + Convert.ToDouble(chiPhiBangKe.DonGiaBH).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.TiLeThanhToanTheoDV).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.ThanhTienBV).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.MucHuongBaoHiem > 0 ? 100 : 0).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.ThanhTienBH).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.QuyBHYT).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.NguoiBenhCungChiTra).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.Khac).ApplyFormatMoneyToDouble() + "</td>" +
                                                    "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.NguoiBenhTuTra).ApplyFormatMoneyToDouble(true) + "</td>" +
                                                    "</tr>";
                                    indexItem++;
                                }
                            }
                        }
                        else
                        {
                            foreach (var chiPhiBangKe in groupChiPhiBangKe)
                            {
                                dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                                "<td style='border: 1px solid #020000; text-align: center;'> " + indexItem + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: left;'> " + chiPhiBangKe.NoiDung + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'>  " + chiPhiBangKe.DonViTinh + " </td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'> " + chiPhiBangKe.SoLuong + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'> " + Convert.ToDouble(chiPhiBangKe.DonGiaBV).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: center;'> " + Convert.ToDouble(chiPhiBangKe.DonGiaBH).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.TiLeThanhToanTheoDV).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.ThanhTienBV).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.MucHuongBaoHiem > 0 ? 100 : 0).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.ThanhTienBH).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.QuyBHYT).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.NguoiBenhCungChiTra).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.Khac).ApplyFormatMoneyToDouble() + "</td>" +
                                                "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.NguoiBenhTuTra).ApplyFormatMoneyToDouble(true) + "</td>" +
                                                "</tr>";
                                indexItem++;
                            }
                        }

                    }

                    dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                        "<td style='border: 1px solid #020000;' colspan='7'></span>" +
                                        "<span style='float:right;padding-right: 50px;'><b>Tổng Cộng</b></span>" +
                                        "</td>" +
                                        $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                        $"<td style='border: 1px solid #020000;text-align: right;'><b></b> </td>" +
                                        $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                        $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                        $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                        $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                        $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true)}</b> </td>" +
                                        "</tr>" +
                                        "</table>";

                }

                var checkedLyDoVaoVien = "<input id='demo_box_2' class='css - checkbox' type='checkbox' checked  disabled='true'/>";
                var unCheckedLyDoVaoVien = "<input id='demo_box_2' class='css - checkbox' type='checkbox' disabled='true' />";

                var ktKhoa = danhSachChiPhi.Key.Contains("Khoa");
                var maKhoa = _khoaPhongRepository.TableNoTracking.Where(c => c.Ten.Contains(danhSachChiPhi.Key)).Select(s => s.Ma).FirstOrDefault();

                //BVHD-3792
                var KhoaPhongId = _khoaPhongRepository.TableNoTracking.Where(c => c.Ten.Contains(danhSachChiPhi.Key)).Select(s => s.Id).FirstOrDefault();
                var chuyenKhoa = GetChuyenKhoa(KhoaPhongId);

                var data = new
                {
                    TitleBangKe = "ĐIỀU TRỊ NỘI TRÚ",
                    SoBangKe = "3",
                    yeuCauTiepNhan.BenhNhan.MaBN,
                    MaTN = yeuCauTiepNhan.MaYeuCauTiepNhan,
                    SoBenhAn = "Số bệnh án: " + yeuCauTiepNhan.NoiTruBenhAn?.SoBenhAn,
                    yeuCauTiepNhan.HoTen,
                    DiaChi = yeuCauTiepNhan.DiaChiDayDu,
                    BarCodeImgBase64 = !string.IsNullOrEmpty(yeuCauTiepNhan.MaYeuCauTiepNhan) ? BarcodeHelper.GenerateBarCode(yeuCauTiepNhan.MaYeuCauTiepNhan) : "",
                    NamSinh = DateHelper.DOBFormat(yeuCauTiepNhan.NgaySinh, yeuCauTiepNhan.ThangSinh, yeuCauTiepNhan.NamSinh),
                    GioiTinh = yeuCauTiepNhan.GioiTinh != null ? yeuCauTiepNhan.GioiTinh.GetDescription() : "",

                    TenKhoa = ktKhoa ? "Khoa: " + danhSachChiPhi.Key.ToString().Replace("Khoa", "") : danhSachChiPhi.Key,
                    MaKhoa = "Mã khoa: " + chuyenKhoa?.Ma,

                    MaBHYT = theBHYT?.MaSoThe,
                    BHYTTuNgay = bHYTTuNgay,
                    BHYTDenNgay = bHYTDenNgay,
                    NoiDKKCBBanDau,
                    MaKCBBanDau,
                    NgayDenKham = yeuCauTiepNhan.YeuCauNhapVien?.YeuCauKhamBenh?.YeuCauTiepNhan.ThoiDiemTiepNhan.ApplyFormatGioPhutNgay(),
                    DieuTriKNT = yeuCauTiepNhan.NoiTruBenhAn?.ThoiDiemNhapVien.ApplyFormatGioPhutNgay(),
                    KetThucKhamNgoaiTru = yeuCauTiepNhan.NoiTruBenhAn?.ThoiDiemRaVien?.ApplyFormatGioPhutNgay(),
                    SoNgayDTri = NoiTruBenhAnHelper.TinhSoNgayDieuTri(yeuCauTiepNhan.NoiTruBenhAn)?.ToString() ?? string.Empty,//yeuCauTiepNhan.NoiTruBenhAn?.ThoiDiemRaVien == null ? "" : (yeuCauTiepNhan.NoiTruBenhAn.ThoiDiemRaVien.Value.Date.AddDays(1) - yeuCauTiepNhan.NoiTruBenhAn.ThoiDiemNhapVien.Date).Days.ToString(),
                    TinhTrangRaVien = yeuCauTiepNhan.NoiTruBenhAn?.TinhTrangRaVien == EnumTinhTrangRaVien.RaVien && (yeuCauTiepNhan.NoiTruBenhAn?.KetQuaDieuTri == EnumKetQuaDieuTri.Do || yeuCauTiepNhan.NoiTruBenhAn?.KetQuaDieuTri == EnumKetQuaDieuTri.Khoi) ? 1 : 2,
                    MucHuong = mucHuong,
                    NoiChuyenDen = yeuCauTiepNhan.NoiChuyen?.Ten,
                    NoiChuyenDi = yeuCauTiepNhan.NoiTruBenhAn?.ChuyenDenBenhVien?.Ten,
                    MKV = theBHYT?.MaKhuVuc,
                    NgayMiemCungTC = theBHYT?.NgayDuocMienCungChiTra?.ApplyFormatDate(),
                    ThoiGian5Nam = theBHYT?.NgayDu5Nam?.ApplyFormatDate(),
                    CoCapCuu = yeuCauTiepNhan.LyDoVaoVien == Enums.EnumLyDoVaoVien.CapCuu ? checkedLyDoVaoVien : unCheckedLyDoVaoVien,
                    CoDungTuyen = yeuCauTiepNhan.LyDoVaoVien == Enums.EnumLyDoVaoVien.DungTuyen ? checkedLyDoVaoVien : unCheckedLyDoVaoVien,
                    CoThongTuyen = yeuCauTiepNhan.LyDoVaoVien == Enums.EnumLyDoVaoVien.ThongTuyen ? checkedLyDoVaoVien : unCheckedLyDoVaoVien,
                    CoTraiTuyen = yeuCauTiepNhan.LyDoVaoVien == Enums.EnumLyDoVaoVien.TraiTuyen ? checkedLyDoVaoVien : unCheckedLyDoVaoVien,

                    ChuanDoanXacDinh = yeuCauTiepNhan.NoiTruBenhAn != null && (yeuCauTiepNhan.NoiTruBenhAn.LoaiBenhAn == LoaiBenhAn.SanKhoaMo || yeuCauTiepNhan.NoiTruBenhAn.LoaiBenhAn == LoaiBenhAn.SanKhoaThuong) ? chuanDoanXacDinhSanKhoa : yeuCauTiepNhan.NoiTruBenhAn?.ChanDoanChinhRaVienGhiChu,
                    MaICD10 = yeuCauTiepNhan.NoiTruBenhAn != null && (yeuCauTiepNhan.NoiTruBenhAn.LoaiBenhAn == LoaiBenhAn.SanKhoaMo || yeuCauTiepNhan.NoiTruBenhAn.LoaiBenhAn == LoaiBenhAn.SanKhoaThuong) ? maICD10 : yeuCauTiepNhan.NoiTruBenhAn?.ChanDoanChinhRaVienICD?.Ma,


                    BenhKemTheo = tenICDKemTheo,
                    ICDKemTheo10 = maICDKemTheo,

                    DateItemChiPhis = dateItemChiPhis,

                    TTDV = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble(),
                    TTTTBHYT = "",

                    TTTienBH = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble(),
                    TQBHYT = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble(),
                    TNCCTra = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble(),
                    TongSoKhac = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble(),
                    TNBTuTra = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true),

                    TongChiPhi = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble(),
                    SoTienBangChu = NumberHelper.ChuyenSoRaText(Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBV))),

                    NguoiBenhPhaiTra = (Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)) + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhTuTra))).ApplyFormatMoneyToDouble(),

                    TTQuyTT = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble(),
                    BHYTChiTra = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble(),
                    CacKhoanTraKhac = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true),
                    SoTienKhac = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble(),
                    NgayHienTai = DateTime.Now.ApplyFormatNgayThangNam()
                };

                var content = TemplateHelpper.FormatTemplateWithContentTemplate(result?.Body, data);
                inTheoKhoaChiDinh.Add(content);
            }
            return inTheoKhoaChiDinh;
        }
        public async Task<List<ChiPhiKhamChuaBenhNoiTruVo>> GetTatCaDichVuKhamChuaBenh(long yeuCauTiepNhanId)
        {
            var yeuCauTiepNhan = BaseRepository.GetById(yeuCauTiepNhanId,
                x => x.Include(o => o.CongTyUuDai)
                    //.Include(o => o.YeuCauKhamBenhs)
                    //.Include(o => o.YeuCauDichVuKyThuats)
                    .Include(o => o.NoiTruBenhAn)
                    .Include(o => o.YeuCauTiepNhanTheBHYTs)
                    .Include(o => o.YeuCauDichVuGiuongBenhViens).ThenInclude(dvg => dvg.NoiChiDinh).ThenInclude(gb => gb.KhoaPhong)
                    .Include(o => o.YeuCauDichVuGiuongBenhViens).ThenInclude(dvg => dvg.GiuongBenh).ThenInclude(gb => gb.PhongBenhVien).ThenInclude(gb => gb.KhoaPhong));
                    //.Include(o => o.DoiTuongUuDai).ThenInclude(ud => ud.DoiTuongUuDaiDichVuKhamBenhBenhViens)
                    //.Include(o => o.DoiTuongUuDai).ThenInclude(ud => ud.DoiTuongUuDaiDichVuKyThuatBenhViens)
                    //.Include(o => o.GiayMienGiamThem)
                    //.Include(o => o.NhanVienDuyetMienGiamThem).ThenInclude(v => v.User)
                    //.Include(o => o.TheVoucherYeuCauTiepNhans).ThenInclude(v => v.TheVoucher).ThenInclude(v => v.Voucher).ThenInclude(v => v.VoucherChiTietMienGiams));

            long? yeuCauTiepNhanNgoaiTruCanQuyetToanId = yeuCauTiepNhan.YeuCauTiepNhanNgoaiTruCanQuyetToanId;
            //YeuCauTiepNhan yeuCauTiepNhanNgoaiTruCanQuyetToan = null;
            //if (yeuCauTiepNhanNgoaiTruCanQuyetToanId != null)
            //{
            //    yeuCauTiepNhanNgoaiTruCanQuyetToan = BaseRepository.GetById(yeuCauTiepNhanNgoaiTruCanQuyetToanId.Value,
            //        x => x.Include(o => o.CongTyUuDai));
            //            //.Include(o => o.YeuCauKhamBenhs)
            //            //.Include(o => o.YeuCauDichVuKyThuats)
            //            //.Include(o => o.DoiTuongUuDai).ThenInclude(ud => ud.DoiTuongUuDaiDichVuKhamBenhBenhViens)
            //            //.Include(o => o.DoiTuongUuDai).ThenInclude(ud => ud.DoiTuongUuDaiDichVuKyThuatBenhViens)
            //            //.Include(o => o.GiayMienGiamThem)
            //            //.Include(o => o.NhanVienDuyetMienGiamThem).ThenInclude(v => v.User)
            //            //.Include(o => o.TheVoucherYeuCauTiepNhans).ThenInclude(v => v.TheVoucher)
            //            //.ThenInclude(v => v.Voucher).ThenInclude(v => v.VoucherChiTietMienGiams));
            //}


            var queryDichVuKhamBenh = BaseRepository.TableNoTracking.Where(o => o.Id == yeuCauTiepNhanId || o.Id == yeuCauTiepNhanNgoaiTruCanQuyetToanId)
                .SelectMany(o => o.YeuCauKhamBenhs).Include(cc => cc.CongTyBaoHiemTuNhanCongNos).Include(cc => cc.MienGiamChiPhis).Include(cc => cc.NoiDangKy).Include(cc => cc.BacSiDangKy).ThenInclude(cc => cc.User)
                .Where(yc => yc.TrangThai != Enums.EnumTrangThaiYeuCauKhamBenh.HuyKham)
                .Select(s => new ChiPhiKhamChuaBenhNoiTruVo
                {
                    Id = s.Id,
                    YeuCauGoiDichVuId = s.YeuCauGoiDichVuId,
                    DichVuNgoaiTru = s.YeuCauTiepNhanId != yeuCauTiepNhanId,
                    NgayPhatSinh = s.ThoiDiemChiDinh,
                    DichVuBenhVienId = s.DichVuKhamBenhBenhVienId,
                    LoaiNhom = NhomChiPhiNoiTru.DichVuKhamBenh,
                    Ma = s.DichVuKhamBenhBenhVien.Ma,
                    Nhom = NhomChiPhiNoiTru.DichVuKhamBenh.GetDescription(),
                    NhomChiPhiBangKe = NhomChiPhiBangKe.KhamBenh,
                    TenDichVu = s.DichVuKhamBenhBenhVien.Ten,
                    LoaiGia = s.NhomGiaDichVuKhamBenhBenhVien.Ten,
                    Soluong = 1,
                    DonViTinh = "Lần",
                    DonGia = s.YeuCauGoiDichVuId == null ? s.Gia : s.DonGiaSauChietKhau.GetValueOrDefault(),
                    KhongTinhPhi = s.KhongTinhPhi,
                    KiemTraBHYTXacNhan = s.BaoHiemChiTra != null,
                    DuocHuongBHYT = s.DuocHuongBaoHiem,
                    DonGiaBHYT = s.DonGiaBaoHiem.GetValueOrDefault(),
                    TiLeBaoHiemThanhToan = s.TiLeBaoHiemThanhToan.GetValueOrDefault(),
                    MucHuongBaoHiem = s.MucHuongBaoHiem.GetValueOrDefault(),
                    MaSoTheBHYT = s.MaSoTheBHYT ?? string.Empty,
                    SoTienMG = s.SoTienMienGiam.GetValueOrDefault(),
                    SoTienBaoHiemTuNhanChiTra = s.SoTienBaoHiemTuNhanChiTra.GetValueOrDefault(),
                    GhiChuMienGiamThem = s.GhiChuMienGiamThem,
                    NoiDungGhiChuMiemGiamId = s.NoiDungGhiChuMiemGiamId,
                    CapNhatThanhToan = s.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan,
                    DaThanhToan = s.SoTienBenhNhanDaChi.GetValueOrDefault(),
                    Khoa = s.NoiThucHien != null ? s.NoiThucHien.KhoaPhong.Ten : s.NoiChiDinh.KhoaPhong.Ten,
                    CheckedDefault = true,
                    TrangThaiThanhToan = s.TrangThaiThanhToan
                }).OrderBy(o => o.Id).ToListAsync();

            var queryDichVuKyThuat = BaseRepository.TableNoTracking.Where(o => o.Id == yeuCauTiepNhanId || o.Id == yeuCauTiepNhanNgoaiTruCanQuyetToanId)
                .SelectMany(o => o.YeuCauDichVuKyThuats).Include(cc => cc.CongTyBaoHiemTuNhanCongNos).Include(cc => cc.MienGiamChiPhis)
                .Where(yc => yc.TrangThai != Enums.EnumTrangThaiYeuCauDichVuKyThuat.DaHuy)
                .Select(s => new ChiPhiKhamChuaBenhNoiTruVo
                {
                    Id = s.Id,
                    YeuCauGoiDichVuId = s.YeuCauGoiDichVuId,
                    DichVuNgoaiTru = s.YeuCauTiepNhanId != yeuCauTiepNhanId,
                    NgayPhatSinh = s.NoiTruPhieuDieuTri != null ? s.NoiTruPhieuDieuTri.NgayDieuTri : s.ThoiDiemChiDinh,
                    DichVuBenhVienId = s.DichVuKyThuatBenhVienId,
                    LoaiNhom = NhomChiPhiNoiTru.DichVuKyThuat,
                    Ma = s.DichVuKyThuatBenhVien.Ma,
                    Nhom = NhomChiPhiNoiTru.DichVuKyThuat.GetDescription(),
                    NhomChiPhiBangKe = s.LoaiDichVuKyThuat == Enums.LoaiDichVuKyThuat.XetNghiem ? NhomChiPhiBangKe.XetNgiem
                                        : s.LoaiDichVuKyThuat == Enums.LoaiDichVuKyThuat.ChuanDoanHinhAnh ? NhomChiPhiBangKe.ChuanDoanHinhAnh
                                        : s.LoaiDichVuKyThuat == Enums.LoaiDichVuKyThuat.ThamDoChucNang ? NhomChiPhiBangKe.ThamDoChucNang
                                        : s.LoaiDichVuKyThuat == Enums.LoaiDichVuKyThuat.ThuThuatPhauThuat ? NhomChiPhiBangKe.ThuThuatPhauThuat
                                        : NhomChiPhiBangKe.DichVuKhac,
                    TenDichVu = s.DichVuKyThuatBenhVien.Ten,
                    LoaiGia = s.NhomGiaDichVuKyThuatBenhVien.Ten,
                    Soluong = s.SoLan,
                    DonViTinh = "Lần",
                    DonGia = s.YeuCauGoiDichVuId == null ? s.Gia : s.DonGiaSauChietKhau.GetValueOrDefault(),
                    KhongTinhPhi = s.KhongTinhPhi,
                    KiemTraBHYTXacNhan = s.BaoHiemChiTra != null,
                    DuocHuongBHYT = s.DuocHuongBaoHiem,
                    DonGiaBHYT = s.DonGiaBaoHiem.GetValueOrDefault(),
                    TiLeBaoHiemThanhToan = s.TiLeBaoHiemThanhToan.GetValueOrDefault(),
                    MucHuongBaoHiem = s.MucHuongBaoHiem.GetValueOrDefault(),
                    MaSoTheBHYT = s.MaSoTheBHYT ?? string.Empty,
                    SoTienMG = s.SoTienMienGiam.GetValueOrDefault(),
                    SoTienBaoHiemTuNhanChiTra = s.SoTienBaoHiemTuNhanChiTra.GetValueOrDefault(),
                    GhiChuMienGiamThem = s.GhiChuMienGiamThem,
                    NoiDungGhiChuMiemGiamId = s.NoiDungGhiChuMiemGiamId,
                    CapNhatThanhToan = s.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan,
                    DaThanhToan = s.SoTienBenhNhanDaChi.GetValueOrDefault(),
                    Khoa = s.NoiThucHien != null ? s.NoiThucHien.KhoaPhong.Ten : s.NoiChiDinh.KhoaPhong.Ten,
                    DoiTuongSuDung = s.DoiTuongSuDung,
                    CheckedDefault = true,
                    TrangThaiThanhToan = s.TrangThaiThanhToan
                }).ToListAsync();

            var queryDichVuTruyenMau = BaseRepository.TableNoTracking.Where(o => o.Id == yeuCauTiepNhanId)
                .SelectMany(o => o.YeuCauTruyenMaus).Include(cc => cc.CongTyBaoHiemTuNhanCongNos).Include(cc => cc.MienGiamChiPhis)
                .Where(yc => yc.TrangThai != Enums.EnumTrangThaiYeuCauTruyenMau.DaHuy)
                .Select(s => new ChiPhiKhamChuaBenhNoiTruVo
                {
                    Id = s.Id,
                    NgayPhatSinh = s.NoiTruPhieuDieuTri != null ? s.NoiTruPhieuDieuTri.NgayDieuTri : s.ThoiDiemChiDinh,
                    DichVuBenhVienId = s.MauVaChePhamId,
                    LoaiNhom = NhomChiPhiNoiTru.TruyenMau,
                    Ma = s.MaDichVu,
                    Nhom = NhomChiPhiNoiTru.TruyenMau.GetDescription(),
                    NhomChiPhiBangKe = NhomChiPhiBangKe.Mau,
                    TenDichVu = s.TenDichVu,
                    LoaiGia = string.Empty,
                    Soluong = 1,
                    DonViTinh = "Đơn vị",
                    DonGia = s.DonGiaBan.GetValueOrDefault(),
                    KiemTraBHYTXacNhan = s.BaoHiemChiTra != null,
                    DuocHuongBHYT = s.DuocHuongBaoHiem,
                    DonGiaBHYT = s.DonGiaBaoHiem.GetValueOrDefault(),
                    TiLeBaoHiemThanhToan = s.TiLeBaoHiemThanhToan.GetValueOrDefault(),
                    MucHuongBaoHiem = s.MucHuongBaoHiem.GetValueOrDefault(),
                    MaSoTheBHYT = s.MaSoTheBHYT ?? string.Empty,
                    SoTienMG = s.SoTienMienGiam.GetValueOrDefault(),
                    SoTienBaoHiemTuNhanChiTra = s.SoTienBaoHiemTuNhanChiTra.GetValueOrDefault(),
                    GhiChuMienGiamThem = s.GhiChuMienGiamThem,
                    NoiDungGhiChuMiemGiamId = s.NoiDungGhiChuMiemGiamId,
                    CapNhatThanhToan = s.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan,
                    DaThanhToan = s.SoTienBenhNhanDaChi.GetValueOrDefault(),
                    Khoa = s.NoiThucHien != null ? s.NoiThucHien.KhoaPhong.Ten : s.NoiChiDinh.KhoaPhong.Ten,
                    CheckedDefault = true,
                    TrangThaiThanhToan = s.TrangThaiThanhToan
                }).ToListAsync();

            var queryDichVuGiuongChiPhiBenhVien = BaseRepository.TableNoTracking.Where(o => o.Id == yeuCauTiepNhanId)
                .SelectMany(o => o.YeuCauDichVuGiuongBenhVienChiPhiBenhViens).Include(cc => cc.CongTyBaoHiemTuNhanCongNos).Include(cc => cc.MienGiamChiPhis)
                .Select(s => new ChiPhiKhamChuaBenhNoiTruVo
                {
                    Id = s.Id,
                    YeuCauGoiDichVuId = s.YeuCauGoiDichVuId,
                    NgayPhatSinh = s.NgayPhatSinh,
                    DichVuBenhVienId = s.DichVuGiuongBenhVienId,
                    LoaiNhom = NhomChiPhiNoiTru.DichVuGiuong,
                    Ma = s.Ma,
                    Nhom = NhomChiPhiNoiTru.DichVuGiuong.GetDescription(),
                    NhomChiPhiBangKe = NhomChiPhiBangKe.NgayGiuongDieuTriNoiTru,
                    TenDichVu = s.Ten,
                    LoaiGia = string.Empty,
                    Soluong = s.SoLuong,
                    DonGia = s.YeuCauGoiDichVuId == null ? s.Gia : s.DonGiaSauChietKhau.GetValueOrDefault(),
                    DonViTinh = "Ngày",
                    //KiemTraBHYTXacNhan = s.BaoHiemChiTra != null,
                    //DuocHuongBHYT = s.DuocHuongBaoHiem,
                    //DonGiaBHYT = s.DonGiaBaoHiem.GetValueOrDefault(),
                    //TiLeBaoHiemThanhToan = s.TiLeBaoHiemThanhToan.GetValueOrDefault(),
                    //MucHuongBaoHiem = s.MucHuongBaoHiem.GetValueOrDefault(),
                    MaSoTheBHYT = string.Empty,
                    SoTienMG = s.SoTienMienGiam.GetValueOrDefault(),
                    SoTienBaoHiemTuNhanChiTra = s.SoTienBaoHiemTuNhanChiTra.GetValueOrDefault(),
                    GhiChuMienGiamThem = s.GhiChuMienGiamThem,
                    NoiDungGhiChuMiemGiamId = s.NoiDungGhiChuMiemGiamId,
                    CapNhatThanhToan = s.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan,
                    DaThanhToan = s.SoTienBenhNhanDaChi.GetValueOrDefault(),
                    Khoa = s.KhoaPhong.Ten,
                    DoiTuongSuDung = s.DoiTuongSuDung,
                    CheckedDefault = true,
                    TrangThaiThanhToan = s.TrangThaiThanhToan
                }).ToListAsync();
            var queryDichVuGiuongChiPhiBHYT = BaseRepository.TableNoTracking.Where(o => o.Id == yeuCauTiepNhanId)
                .SelectMany(o => o.YeuCauDichVuGiuongBenhVienChiPhiBHYTs).ToListAsync();

            var queryDuocPham = BaseRepository.TableNoTracking.Where(o => o.Id == yeuCauTiepNhanId || o.Id == yeuCauTiepNhanNgoaiTruCanQuyetToanId)
                .SelectMany(o => o.YeuCauDuocPhamBenhViens).Include(cc => cc.CongTyBaoHiemTuNhanCongNos).Include(cc => cc.MienGiamChiPhis)
                .Where(yc => yc.TrangThai != Enums.EnumYeuCauDuocPhamBenhVien.DaHuy)
                .Select(s => new ChiPhiKhamChuaBenhNoiTruVo
                {
                    Id = s.Id,
                    DichVuNgoaiTru = s.YeuCauTiepNhanId != yeuCauTiepNhanId,
                    NgayPhatSinh = s.NoiTruPhieuDieuTri != null ? s.NoiTruPhieuDieuTri.NgayDieuTri : s.ThoiDiemChiDinh,
                    DichVuBenhVienId = s.DuocPhamBenhVienId,
                    LoaiNhom = NhomChiPhiNoiTru.DuocPham,
                    Nhom = NhomChiPhiNoiTru.DuocPham.GetDescription(),
                    NhomChiPhiBangKe = NhomChiPhiBangKe.ThuocDichTruyen,
                    Ma = s.DuocPhamBenhVien.Ma,
                    TenDichVu = s.DuocPhamBenhVien.DuocPham.Ten + " " + (s.HamLuong ?? ""), //BVHD-3873
                    LoaiGia = string.Empty,
                    Soluong = s.SoLuong,
                    DonViTinh = s.DonViTinh.Ten,
                    DonGia = s.DonGiaBan,
                    KhongTinhPhi = s.KhongTinhPhi,
                    KiemTraBHYTXacNhan = s.BaoHiemChiTra != null,
                    DuocHuongBHYT = s.DuocHuongBaoHiem,
                    DonGiaBHYT = s.DonGiaBaoHiem.GetValueOrDefault(),
                    TiLeBaoHiemThanhToan = s.TiLeBaoHiemThanhToan.GetValueOrDefault(),
                    MucHuongBaoHiem = s.MucHuongBaoHiem.GetValueOrDefault(),
                    MaSoTheBHYT = s.MaSoTheBHYT ?? string.Empty,
                    SoTienMG = s.SoTienMienGiam.GetValueOrDefault(),
                    GhiChuMienGiamThem = s.GhiChuMienGiamThem,
                    NoiDungGhiChuMiemGiamId = s.NoiDungGhiChuMiemGiamId,
                    SoTienBaoHiemTuNhanChiTra = s.SoTienBaoHiemTuNhanChiTra.GetValueOrDefault(),
                    CapNhatThanhToan = s.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan,
                    DaThanhToan = s.SoTienBenhNhanDaChi.GetValueOrDefault(),
                    Khoa = s.NoiCapThuoc != null ? s.NoiCapThuoc.KhoaPhong.Ten : s.NoiChiDinh.KhoaPhong.Ten,
                    CheckedDefault = true,
                    TrangThaiThanhToan = s.TrangThaiThanhToan
                }).ToListAsync();

            var queryVatTu = BaseRepository.TableNoTracking.Where(o => o.Id == yeuCauTiepNhanId || o.Id == yeuCauTiepNhanNgoaiTruCanQuyetToanId)
                .SelectMany(o => o.YeuCauVatTuBenhViens).Include(cc => cc.CongTyBaoHiemTuNhanCongNos).Include(cc => cc.MienGiamChiPhis)
                .Where(yc => yc.TrangThai != Enums.EnumYeuCauVatTuBenhVien.DaHuy)
                .Select(s => new ChiPhiKhamChuaBenhNoiTruVo
                {
                    Id = s.Id,
                    DichVuNgoaiTru = s.YeuCauTiepNhanId != yeuCauTiepNhanId,
                    NgayPhatSinh = s.NoiTruPhieuDieuTri != null ? s.NoiTruPhieuDieuTri.NgayDieuTri : s.ThoiDiemChiDinh,
                    DichVuBenhVienId = s.VatTuBenhVienId,
                    LoaiNhom = NhomChiPhiNoiTru.VatTuTieuHao,
                    Nhom = NhomChiPhiNoiTru.VatTuTieuHao.GetDescription(),
                    NhomChiPhiBangKe = s.YeuCauDichVuKyThuat != null && s.YeuCauDichVuKyThuat.LanThucHien != null ? NhomChiPhiBangKe.GoiVatTu : NhomChiPhiBangKe.VatTuYte,
                    SoThuTuGoiTrongNhomChiPhiBangKe = s.YeuCauDichVuKyThuat != null && s.YeuCauDichVuKyThuat.LanThucHien != null ? s.YeuCauDichVuKyThuat.LanThucHien.Value : 0,
                    Ma = s.VatTuBenhVien.Ma,
                    TenDichVu = s.VatTuBenhVien.VatTus.Ten,
                    LoaiGia = string.Empty,
                    Soluong = s.SoLuong,
                    DonViTinh = s.DonViTinh,
                    DonGia = s.DonGiaBan,
                    KhongTinhPhi = s.KhongTinhPhi,
                    KiemTraBHYTXacNhan = s.BaoHiemChiTra != null,
                    DuocHuongBHYT = s.DuocHuongBaoHiem,
                    DonGiaBHYT = s.DonGiaBaoHiem.GetValueOrDefault(),
                    TiLeBaoHiemThanhToan = s.TiLeBaoHiemThanhToan.GetValueOrDefault(),
                    MucHuongBaoHiem = s.MucHuongBaoHiem.GetValueOrDefault(),
                    MaSoTheBHYT = s.MaSoTheBHYT ?? string.Empty,
                    SoTienMG = s.SoTienMienGiam.GetValueOrDefault(),
                    SoTienBaoHiemTuNhanChiTra = s.SoTienBaoHiemTuNhanChiTra.GetValueOrDefault(),
                    GhiChuMienGiamThem = s.GhiChuMienGiamThem,
                    NoiDungGhiChuMiemGiamId = s.NoiDungGhiChuMiemGiamId,
                    CapNhatThanhToan = s.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan,
                    DaThanhToan = s.SoTienBenhNhanDaChi.GetValueOrDefault(),
                    Khoa = s.NoiCapVatTu != null ? s.NoiCapVatTu.KhoaPhong.Ten : s.NoiChiDinh.KhoaPhong.Ten,
                    CheckedDefault = true,
                    TrangThaiThanhToan = s.TrangThaiThanhToan
                }).ToListAsync();

            var queryToaThuoc = BaseRepository.TableNoTracking.Where(o => o.Id == yeuCauTiepNhanId || o.Id == yeuCauTiepNhanNgoaiTruCanQuyetToanId)
                .SelectMany(o => o.DonThuocThanhToans)
                .Where(dt => dt.LoaiDonThuoc == Enums.EnumLoaiDonThuoc.ThuocBHYT && dt.TrangThai != Enums.TrangThaiDonThuocThanhToan.DaHuy)
                .SelectMany(o => o.DonThuocThanhToanChiTiets).Include(cc => cc.CongTyBaoHiemTuNhanCongNos).Include(cc => cc.MienGiamChiPhis)
                .Select(s => new ChiPhiKhamChuaBenhNoiTruVo
                {
                    Id = s.Id,
                    DichVuNgoaiTru = s.DonThuocThanhToan.YeuCauTiepNhanId != yeuCauTiepNhanId,
                    NgayPhatSinh = s.CreatedOn,
                    DichVuBenhVienId = s.DuocPhamId,
                    LoaiNhom = NhomChiPhiNoiTru.ToaThuoc,
                    Nhom = $"{NhomChiPhiNoiTru.ToaThuoc.GetDescription()}: {s.DonThuocThanhToan.YeuCauKhamBenhDonThuoc.YeuCauKhamBenh.TenDichVu}",
                    NhomChiPhiBangKe = NhomChiPhiBangKe.ThuocDichTruyen,
                    Ma = string.Empty,
                    TenDichVu = s.Ten + " " + (s.HamLuong ?? ""),//BVHD-3873
                    LoaiGia = string.Empty,
                    Soluong = s.SoLuong,
                    DonGia = s.DonGiaBan,
                    DonViTinh = s.DonViTinh.Ten,
                    KiemTraBHYTXacNhan = s.BaoHiemChiTra != null,
                    DuocHuongBHYT = s.DuocHuongBaoHiem,
                    DonGiaBHYT = s.DonGiaBaoHiem.GetValueOrDefault(),
                    TiLeBaoHiemThanhToan = s.TiLeBaoHiemThanhToan.GetValueOrDefault(),
                    MucHuongBaoHiem = s.MucHuongBaoHiem.GetValueOrDefault(),
                    MaSoTheBHYT = s.MaSoTheBHYT ?? string.Empty,
                    SoTienMG = s.SoTienMienGiam.GetValueOrDefault(),
                    SoTienBaoHiemTuNhanChiTra = s.SoTienBaoHiemTuNhanChiTra.GetValueOrDefault(),
                    GhiChuMienGiamThem = s.GhiChuMienGiamThem,
                    NoiDungGhiChuMiemGiamId = s.NoiDungGhiChuMiemGiamId,
                    CapNhatThanhToan = s.DonThuocThanhToan.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan,
                    DaThanhToan = s.SoTienBenhNhanDaChi.GetValueOrDefault(),
                    Khoa = "Nhà thuốc",
                    CheckedDefault = true,
                    TrangThaiThanhToan = s.DonThuocThanhToan.TrangThaiThanhToan
                }).ToListAsync();


            await Task.WhenAll(queryDichVuKhamBenh, queryDichVuKyThuat, queryDichVuTruyenMau, queryDuocPham, queryVatTu, queryDichVuGiuongChiPhiBenhVien, queryDichVuGiuongChiPhiBHYT,
                queryToaThuoc);
            var result = new List<ChiPhiKhamChuaBenhNoiTruVo>();
            result.AddRange(queryDichVuKhamBenh.Result);
            result.AddRange(queryDichVuKyThuat.Result);
            result.AddRange(queryDichVuTruyenMau.Result);
            result.AddRange(queryDuocPham.Result);
            result.AddRange(queryVatTu.Result);
            result.AddRange(queryToaThuoc.Result);

            List<YeuCauDichVuGiuongBenhVienChiPhiBHYT> dichVuGiuongBenhVienChiPhiBhyts;
            List<ChiPhiKhamChuaBenhNoiTruVo> dichVuGiuongs;
            if (yeuCauTiepNhan.NoiTruBenhAn != null && yeuCauTiepNhan.NoiTruBenhAn.ThoiDiemRaVien == null)
            {
                var chiPhiGiuong = TinhChiPhiDichVuGiuong(yeuCauTiepNhan);
                dichVuGiuongBenhVienChiPhiBhyts = chiPhiGiuong.Item2;
                dichVuGiuongs = chiPhiGiuong.Item1.Select(s => new ChiPhiKhamChuaBenhNoiTruVo
                {
                    Id = s.Id,
                    YeuCauGoiDichVuId = s.YeuCauGoiDichVuId,
                    NgayPhatSinh = s.NgayPhatSinh,
                    DichVuBenhVienId = s.DichVuGiuongBenhVienId,
                    LoaiNhom = NhomChiPhiNoiTru.DichVuGiuong,
                    Ma = s.Ma,
                    Nhom = NhomChiPhiNoiTru.DichVuGiuong.GetDescription(),
                    NhomChiPhiBangKe = NhomChiPhiBangKe.NgayGiuongDieuTriNoiTru,
                    TenDichVu = s.Ten,
                    LoaiGia = string.Empty,
                    Soluong = s.SoLuong,
                    DonViTinh = "Ngày",
                    DonGia = s.YeuCauGoiDichVuId == null ? s.Gia : s.DonGiaSauChietKhau.GetValueOrDefault(),
                    DuocHuongBHYT = s.YeuCauDichVuGiuongBenhVienChiPhiBHYTs.Any(),
                    KiemTraBHYTXacNhan = false,
                    DonGiaBHYT = s.YeuCauDichVuGiuongBenhVienChiPhiBHYTs.FirstOrDefault()?.DonGiaBaoHiem.GetValueOrDefault() ?? 0,
                    TiLeBaoHiemThanhToan = s.YeuCauDichVuGiuongBenhVienChiPhiBHYTs.FirstOrDefault()?.TiLeBaoHiemThanhToan.GetValueOrDefault() ?? 0,
                    MucHuongBaoHiem = s.YeuCauDichVuGiuongBenhVienChiPhiBHYTs.FirstOrDefault()?.MucHuongBaoHiem.GetValueOrDefault() ?? 0,
                    MaSoTheBHYT = s.YeuCauDichVuGiuongBenhVienChiPhiBHYTs.FirstOrDefault()?.MaSoTheBHYT ?? string.Empty,
                    SoTienMG = s.SoTienMienGiam.GetValueOrDefault(),
                    GhiChuMienGiamThem = s.GhiChuMienGiamThem,
                    NoiDungGhiChuMiemGiamId = s.NoiDungGhiChuMiemGiamId,
                    CapNhatThanhToan = s.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan,
                    DaThanhToan = s.SoTienBenhNhanDaChi.GetValueOrDefault(),
                    Khoa = s.KhoaPhong.Ten,
                    DoiTuongSuDung = s.DoiTuongSuDung,
                    CheckedDefault = true,
                    TrangThaiThanhToan = s.TrangThaiThanhToan
                }).ToList();
            }
            else
            {
                dichVuGiuongBenhVienChiPhiBhyts = queryDichVuGiuongChiPhiBHYT.Result;
                dichVuGiuongs = queryDichVuGiuongChiPhiBenhVien.Result;
                foreach (var chiPhiKhamChuaBenhNoiTruVo in dichVuGiuongs.Where(o => o.DoiTuongSuDung == Enums.DoiTuongSuDung.BenhNhan))
                {
                    var chiPhiGiuongBHYT = dichVuGiuongBenhVienChiPhiBhyts.FirstOrDefault(o => o.ThanhToanTheoYeuCauDichVuGiuongBenhVienChiPhiBenhVienId == chiPhiKhamChuaBenhNoiTruVo.Id);
                    if (chiPhiGiuongBHYT != null)
                    {
                        chiPhiKhamChuaBenhNoiTruVo.DuocHuongBHYT = true;
                        chiPhiKhamChuaBenhNoiTruVo.KiemTraBHYTXacNhan = chiPhiGiuongBHYT.BaoHiemChiTra != null;
                        chiPhiKhamChuaBenhNoiTruVo.DonGiaBHYT = chiPhiGiuongBHYT.DonGiaBaoHiem.GetValueOrDefault();
                        chiPhiKhamChuaBenhNoiTruVo.TiLeBaoHiemThanhToan = chiPhiGiuongBHYT.TiLeBaoHiemThanhToan.GetValueOrDefault();
                        chiPhiKhamChuaBenhNoiTruVo.MucHuongBaoHiem = chiPhiGiuongBHYT.MucHuongBaoHiem.GetValueOrDefault();
                        chiPhiKhamChuaBenhNoiTruVo.MaSoTheBHYT = chiPhiGiuongBHYT.MaSoTheBHYT ?? string.Empty;
                        chiPhiKhamChuaBenhNoiTruVo.YeuCauDichVuGiuongBenhVienChiPhiBHYTIds = new List<long> { chiPhiGiuongBHYT.Id };
                    }
                }
            }

            result.AddRange(dichVuGiuongs);

            //set muc huong BHYT
            if (yeuCauTiepNhan.CoBHYT == true && yeuCauTiepNhan.YeuCauTiepNhanTheBHYTs.Any())
            {
                foreach (var chiPhiKhamChuaBenhVo in result.Where(o => o.DuocHuongBHYT && o.KiemTraBHYTXacNhan == false))
                {
                    var theBHYT = yeuCauTiepNhan.YeuCauTiepNhanTheBHYTs
                        .Where(o => o.NgayHieuLuc.Date <= chiPhiKhamChuaBenhVo.NgayPhatSinh.GetValueOrDefault().Date &&
                                    (o.NgayHetHan == null || o.NgayHetHan.Value.AddDays(o.DuocGiaHanThe == true ? 15 : 0).Date >= chiPhiKhamChuaBenhVo.NgayPhatSinh.GetValueOrDefault().Date))
                        .OrderByDescending(o => o.MucHuong).FirstOrDefault();
                    if (theBHYT != null)
                    {
                        chiPhiKhamChuaBenhVo.MucHuongBaoHiem = theBHYT.MucHuong;
                        chiPhiKhamChuaBenhVo.TiLeBaoHiemThanhToan = chiPhiKhamChuaBenhVo.TiLeBaoHiemThanhToan != 0 ? chiPhiKhamChuaBenhVo.TiLeBaoHiemThanhToan : 100;
                    }
                }
            }

            return result;
        }

        #endregion

        private Camino.Core.Domain.Entities.BenhVien.Khoas.Khoa GetChuyenKhoa(long? khoaPhongId)
        {
            if (khoaPhongId == null)
                return null;
            return _khoaPhongChuyenKhoaRepository.TableNoTracking.Include(c => c.Khoa).FirstOrDefault(o => o.KhoaPhongId == khoaPhongId)?.Khoa;
        }
    }
}
