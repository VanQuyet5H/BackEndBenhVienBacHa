using System;
using System.Collections.Generic;
using System.Linq;
using System.Linq.Dynamic.Core;
using System.Threading.Tasks;
using Camino.Core.Data;
using Camino.Core.Domain;
using Camino.Core.Domain.Entities.BenhNhans;
using Camino.Core.Domain.Entities.CongTyBaoHiemTuNhans;
using Camino.Core.Domain.Entities.DichVuGiuongBenhViens;
using Camino.Core.Domain.Entities.DichVuKhamBenhBenhViens;
using Camino.Core.Domain.Entities.DichVuKyThuats;
using Camino.Core.Domain.Entities.DonThuocThanhToans;
using Camino.Core.Domain.Entities.NoiGioiThieu;
using Camino.Core.Domain.Entities.Vouchers;
using Camino.Core.Domain.Entities.YeuCauKhamBenhs;
using Camino.Core.Domain.ValueObject;
using Camino.Core.Domain.ValueObject.CauHinh;
using Camino.Core.Domain.ValueObject.DanhSachBenhNhanChoThuNgan;
using Camino.Core.Domain.ValueObject.Grid;
using Camino.Core.Domain.ValueObject.YeuCauTiepNhans;
using Camino.Core.Helpers;
using Camino.Services.Helpers;
using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Internal;
using Newtonsoft.Json;
using RestSharp.Extensions;

namespace Camino.Services.YeuCauTiepNhans
{
    public partial class YeuCauTiepNhanService
    {
        public bool KiemTraYeuCauTiepNhanCoKhuyenMai(long yeuCauTiepNhanId)
        {
            var yeuCauTiepNhan = BaseRepository.GetById(yeuCauTiepNhanId,
                x => x.Include(o => o.BenhNhan).ThenInclude(o => o.YeuCauGoiDichVus));
            if (yeuCauTiepNhan.BenhNhan.YeuCauGoiDichVus.Any(o => o.TrangThai != Enums.EnumTrangThaiYeuCauGoiDichVu.DaHuy))
            {
                var goiDvIds = yeuCauTiepNhan.BenhNhan.YeuCauGoiDichVus.Where(gdv => gdv.TrangThai != Enums.EnumTrangThaiYeuCauGoiDichVu.DaHuy).Select(gdv => gdv.Id).ToList();
                var yeuCauGoiDichVus = _yeuCauGoiDichVuRepository.TableNoTracking
                    .Where(o => goiDvIds.Contains(o.Id))
                    .Include(o => o.ChuongTrinhGoiDichVu).ThenInclude(o => o.ChuongTrinhGoiDichVuKhuyenMaiDichVuKhamBenhs)
                    .Include(o => o.ChuongTrinhGoiDichVu).ThenInclude(o => o.ChuongTrinhGoiDichVuKhuyenMaiDichVuKyThuats)
                    .Include(o => o.MienGiamChiPhis).ThenInclude(o => o.YeuCauDichVuKyThuat)
                    .Include(o => o.MienGiamChiPhis).ThenInclude(o => o.YeuCauKhamBenh)
                    .ToList();
                var chiPhis = GetDanhSachChiPhiKhamChuaBenhChuaThu(yeuCauTiepNhanId);
                foreach (var chiPhi in chiPhis)
                {
                    if (chiPhi.LoaiNhom == NhomChiPhiKhamChuaBenh.DichVuKhamBenh)
                    {
                        foreach (var yeuCauGoiDichVu in yeuCauGoiDichVus)
                        {
                            var dvKhuyenMai = yeuCauGoiDichVu.ChuongTrinhGoiDichVu.ChuongTrinhGoiDichVuKhuyenMaiDichVuKhamBenhs
                                .FirstOrDefault(
                                    o => o.DichVuKhamBenhBenhVienId == chiPhi.DichVuBenhVienId &&
                                         o.NhomGiaDichVuKhamBenhBenhVienId == chiPhi.LoaiGiaId);
                            if (dvKhuyenMai != null)
                            {
                                var dvKhuyenMaiDaDung = yeuCauGoiDichVu.MienGiamChiPhis.Count(o =>
                                    o.YeuCauTiepNhanId != yeuCauTiepNhanId &&
                                    o.YeuCauKhamBenh != null &&
                                    o.YeuCauKhamBenh.DichVuKhamBenhBenhVienId == chiPhi.DichVuBenhVienId &&
                                    o.YeuCauKhamBenh.NhomGiaDichVuKhamBenhBenhVienId == chiPhi.LoaiGiaId);
                                if (dvKhuyenMai.SoLan > dvKhuyenMaiDaDung && DateTime.Now.Date <
                                    yeuCauGoiDichVu.ThoiDiemChiDinh.AddDays(dvKhuyenMai.SoNgaySuDung))
                                {
                                    return true;
                                }
                            }

                        }
                    }
                    if (chiPhi.LoaiNhom == NhomChiPhiKhamChuaBenh.DichVuKyThuat)
                    {
                        foreach (var yeuCauGoiDichVu in yeuCauGoiDichVus)
                        {
                            var dvKhuyenMai = yeuCauGoiDichVu.ChuongTrinhGoiDichVu.ChuongTrinhGoiDichVuKhuyenMaiDichVuKyThuats
                                .FirstOrDefault(
                                    o => o.DichVuKyThuatBenhVienId == chiPhi.DichVuBenhVienId &&
                                         o.NhomGiaDichVuKyThuatBenhVienId == chiPhi.LoaiGiaId);
                            if (dvKhuyenMai != null)
                            {
                                var dvKhuyenMaiDaDung = yeuCauGoiDichVu.MienGiamChiPhis.Where(o =>
                                    o.YeuCauTiepNhanId != yeuCauTiepNhanId &&
                                    o.YeuCauDichVuKyThuat != null &&
                                    o.YeuCauDichVuKyThuat.DichVuKyThuatBenhVienId == chiPhi.DichVuBenhVienId &&
                                    o.YeuCauDichVuKyThuat.NhomGiaDichVuKyThuatBenhVienId == chiPhi.LoaiGiaId).Select(o => o.YeuCauDichVuKyThuat.SoLan).DefaultIfEmpty().Sum();
                                if (dvKhuyenMai.SoLan > dvKhuyenMaiDaDung && DateTime.Now.Date <
                                    yeuCauGoiDichVu.ThoiDiemChiDinh.AddDays(dvKhuyenMai.SoNgaySuDung))
                                {
                                    return true;
                                }
                            }

                        }
                    }
                }
            }
            return false;
        }

        public async Task<List<DanhSachDichVuKhuyenMaiBenhNhanVo>> GetDanhSachDichVuKhuyenMaiForGrid(long yeuCauTiepNhanId)
        {
            List<DanhSachDichVuKhuyenMaiBenhNhanVo> danhSachDichVuKhuyenMaiBenhNhanVos = new List<DanhSachDichVuKhuyenMaiBenhNhanVo>();
            var yeuCauTiepNhan = await BaseRepository.GetByIdAsync(yeuCauTiepNhanId, x => x.Include(o => o.BenhNhan).ThenInclude(o => o.YeuCauGoiDichVus));

            if (yeuCauTiepNhan.BenhNhan.YeuCauGoiDichVus.Any(o => o.TrangThai != Enums.EnumTrangThaiYeuCauGoiDichVu.DaHuy))
            {
                var goiDvIds = yeuCauTiepNhan.BenhNhan.YeuCauGoiDichVus.Where(gdv => gdv.TrangThai != Enums.EnumTrangThaiYeuCauGoiDichVu.DaHuy).Select(gdv => gdv.Id).ToList();
                var yeuCauGoiDichVus = _yeuCauGoiDichVuRepository.TableNoTracking
                    .Where(o => goiDvIds.Contains(o.Id))
                    .Include(o => o.ChuongTrinhGoiDichVu).ThenInclude(o => o.ChuongTrinhGoiDichVuKhuyenMaiDichVuKhamBenhs)
                    .Include(o => o.ChuongTrinhGoiDichVu).ThenInclude(o => o.ChuongTrinhGoiDichVuKhuyenMaiDichVuKyThuats)
                    .Include(o => o.MienGiamChiPhis).ThenInclude(o => o.YeuCauDichVuKyThuat)
                    .Include(o => o.MienGiamChiPhis).ThenInclude(o => o.YeuCauKhamBenh)
                    .ToList();
                var chiPhis = GetDanhSachChiPhiKhamChuaBenhChuaThu(yeuCauTiepNhanId);
                foreach (var chiPhi in chiPhis)
                {
                    if (chiPhi.LoaiNhom == NhomChiPhiKhamChuaBenh.DichVuKhamBenh)
                    {
                        foreach (var yeuCauGoiDichVu in yeuCauGoiDichVus)
                        {


                            var dvKhuyenMai = yeuCauGoiDichVu.ChuongTrinhGoiDichVu.ChuongTrinhGoiDichVuKhuyenMaiDichVuKhamBenhs
                                .FirstOrDefault(
                                    o => o.DichVuKhamBenhBenhVienId == chiPhi.DichVuBenhVienId &&
                                         o.NhomGiaDichVuKhamBenhBenhVienId == chiPhi.LoaiGiaId);
                            if (dvKhuyenMai != null)
                            {
                                var dvKhuyenMaiDaDung = yeuCauGoiDichVu.MienGiamChiPhis.Count(o =>
                                    o.YeuCauTiepNhanId != yeuCauTiepNhanId &&
                                    o.YeuCauKhamBenh != null &&
                                    o.YeuCauKhamBenh.TrangThai != Enums.EnumTrangThaiYeuCauKhamBenh.HuyKham &&
                                    o.YeuCauKhamBenh.DichVuKhamBenhBenhVienId == chiPhi.DichVuBenhVienId &&
                                    o.YeuCauKhamBenh.NhomGiaDichVuKhamBenhBenhVienId == chiPhi.LoaiGiaId);
                                if (dvKhuyenMai.SoLan > dvKhuyenMaiDaDung && DateTime.Now.Date <
                                    yeuCauGoiDichVu.ThoiDiemChiDinh.AddDays(dvKhuyenMai.SoNgaySuDung))
                                {
                                    var dichVuTrongGoiKhuyenMaiVo = new DanhSachDichVuTrongGoiKhuyenMaiVo
                                    {
                                        Id = chiPhi.Id,
                                        DaChon = yeuCauGoiDichVu.MienGiamChiPhis.Any(o =>
                                            o.YeuCauKhamBenhId == chiPhi.Id),
                                        LoaiNhom = chiPhi.LoaiNhom,
                                        Ma = chiPhi.Ma,
                                        TenDichVu = chiPhi.TenDichVu,
                                        LoaiGia = chiPhi.LoaiGia,
                                        Soluong = chiPhi.Soluong,
                                        DonGia = chiPhi.DonGia,
                                        DonGiaKM = dvKhuyenMai.DonGiaKhuyenMai,
                                        HanSuDung = yeuCauGoiDichVu.ThoiDiemChiDinh.AddDays(dvKhuyenMai.SoNgaySuDung),
                                        SoLuongDaDung = dvKhuyenMaiDaDung,
                                        GhiChu = $"Khuyến mãi theo gói {dvKhuyenMai.ChuongTrinhGoiDichVu.Ten}"
                                    };

                                    var goiDichVuKhuyenMaiBenhNhan = danhSachDichVuKhuyenMaiBenhNhanVos.FirstOrDefault(o => o.Id == yeuCauGoiDichVu.Id);
                                    if (goiDichVuKhuyenMaiBenhNhan == null)
                                    {
                                        goiDichVuKhuyenMaiBenhNhan = new DanhSachDichVuKhuyenMaiBenhNhanVo
                                        {
                                            Id = yeuCauGoiDichVu.Id,
                                            TenGoi = yeuCauGoiDichVu.TenChuongTrinh,
                                            DanhSachDichVuTrongGoiKhuyenMais = new List<DanhSachDichVuTrongGoiKhuyenMaiVo> { dichVuTrongGoiKhuyenMaiVo }
                                        };
                                        danhSachDichVuKhuyenMaiBenhNhanVos.Add(goiDichVuKhuyenMaiBenhNhan);
                                    }
                                    else
                                    {
                                        goiDichVuKhuyenMaiBenhNhan.DanhSachDichVuTrongGoiKhuyenMais.Add(dichVuTrongGoiKhuyenMaiVo);
                                    }
                                }
                            }

                        }
                    }
                    if (chiPhi.LoaiNhom == NhomChiPhiKhamChuaBenh.DichVuKyThuat)
                    {
                        foreach (var yeuCauGoiDichVu in yeuCauGoiDichVus)
                        {
                            var dvKhuyenMai = yeuCauGoiDichVu.ChuongTrinhGoiDichVu.ChuongTrinhGoiDichVuKhuyenMaiDichVuKyThuats
                                .FirstOrDefault(
                                    o => o.DichVuKyThuatBenhVienId == chiPhi.DichVuBenhVienId &&
                                         o.NhomGiaDichVuKyThuatBenhVienId == chiPhi.LoaiGiaId);
                            if (dvKhuyenMai != null)
                            {
                                var dvKhuyenMaiDaDung = yeuCauGoiDichVu.MienGiamChiPhis.Where(o =>
                                    o.YeuCauTiepNhanId != yeuCauTiepNhanId &&
                                    o.YeuCauDichVuKyThuat != null &&
                                    o.YeuCauDichVuKyThuat.TrangThai != Enums.EnumTrangThaiYeuCauDichVuKyThuat.DaHuy &&
                                    o.YeuCauDichVuKyThuat.DichVuKyThuatBenhVienId == chiPhi.DichVuBenhVienId &&
                                    o.YeuCauDichVuKyThuat.NhomGiaDichVuKyThuatBenhVienId == chiPhi.LoaiGiaId).Select(o => o.YeuCauDichVuKyThuat.SoLan).DefaultIfEmpty().Sum();
                                if (dvKhuyenMai.SoLan > dvKhuyenMaiDaDung && DateTime.Now.Date <
                                    yeuCauGoiDichVu.ThoiDiemChiDinh.AddDays(dvKhuyenMai.SoNgaySuDung))
                                {
                                    var dichVuTrongGoiKhuyenMaiVo = new DanhSachDichVuTrongGoiKhuyenMaiVo
                                    {
                                        Id = chiPhi.Id,
                                        DaChon = yeuCauGoiDichVu.MienGiamChiPhis.Any(o => o.YeuCauDichVuKyThuatId == chiPhi.Id),
                                        LoaiNhom = chiPhi.LoaiNhom,
                                        Ma = chiPhi.Ma,
                                        TenDichVu = chiPhi.TenDichVu,
                                        LoaiGia = chiPhi.LoaiGia,
                                        Soluong = chiPhi.Soluong,
                                        DonGia = chiPhi.DonGia,
                                        DonGiaKM = dvKhuyenMai.DonGiaKhuyenMai,
                                        HanSuDung = yeuCauGoiDichVu.ThoiDiemChiDinh.AddDays(dvKhuyenMai.SoNgaySuDung),
                                        SoLuongDaDung = dvKhuyenMaiDaDung,
                                        GhiChu = $"Khuyến mãi theo gói {dvKhuyenMai.ChuongTrinhGoiDichVu.Ten}"
                                    };

                                    var goiDichVuKhuyenMaiBenhNhan = danhSachDichVuKhuyenMaiBenhNhanVos.FirstOrDefault(o => o.Id == yeuCauGoiDichVu.Id);
                                    if (goiDichVuKhuyenMaiBenhNhan == null)
                                    {
                                        goiDichVuKhuyenMaiBenhNhan = new DanhSachDichVuKhuyenMaiBenhNhanVo
                                        {
                                            Id = yeuCauGoiDichVu.Id,
                                            TenGoi = yeuCauGoiDichVu.TenChuongTrinh,
                                            DanhSachDichVuTrongGoiKhuyenMais = new List<DanhSachDichVuTrongGoiKhuyenMaiVo> { dichVuTrongGoiKhuyenMaiVo }
                                        };
                                        danhSachDichVuKhuyenMaiBenhNhanVos.Add(goiDichVuKhuyenMaiBenhNhan);
                                    }
                                    else
                                    {
                                        goiDichVuKhuyenMaiBenhNhan.DanhSachDichVuTrongGoiKhuyenMais.Add(dichVuTrongGoiKhuyenMaiVo);
                                    }
                                }
                            }

                        }
                    }
                }
            }
            return danhSachDichVuKhuyenMaiBenhNhanVos;
        }

        public void ApDungDichVuKhuyenMai(ApDungKhuyenMaiBenhNhan apDungKhuyenMaiBenhNhan)
        {
            var yeuCauTiepNhan = BaseRepository.GetById(apDungKhuyenMaiBenhNhan.YeuCauTiepNhanId,
                x => x.Include(o => o.YeuCauKhamBenhs).Include(o => o.YeuCauDichVuKyThuats)
                .Include(o => o.YeuCauDuocPhamBenhViens).Include(o => o.YeuCauVatTuBenhViens)
                .Include(o => o.DonThuocThanhToans).ThenInclude(o => o.DonThuocThanhToanChiTiets)
                .Include(o => o.BenhNhan).ThenInclude(o => o.YeuCauGoiDichVus));

            var isUpdated = false;
            if (yeuCauTiepNhan.BenhNhan.YeuCauGoiDichVus.Any(o => o.TrangThai != Enums.EnumTrangThaiYeuCauGoiDichVu.DaHuy))
            {
                var goiDvIds = yeuCauTiepNhan.BenhNhan.YeuCauGoiDichVus.Where(gdv => gdv.TrangThai != Enums.EnumTrangThaiYeuCauGoiDichVu.DaHuy).Select(gdv => gdv.Id).ToList();
                var yeuCauGoiDichVus = _yeuCauGoiDichVuRepository.Table
                    .Where(o => goiDvIds.Contains(o.Id))
                    .Include(o => o.ChuongTrinhGoiDichVu).ThenInclude(o => o.ChuongTrinhGoiDichVuKhuyenMaiDichVuKhamBenhs)
                    .Include(o => o.ChuongTrinhGoiDichVu).ThenInclude(o => o.ChuongTrinhGoiDichVuKhuyenMaiDichVuKyThuats)
                    .Include(o => o.MienGiamChiPhis).ThenInclude(o => o.YeuCauDichVuKyThuat)
                    .Include(o => o.MienGiamChiPhis).ThenInclude(o => o.YeuCauKhamBenh)
                    .ToList();
                foreach (var yeuCauGoiDichVu in yeuCauGoiDichVus)
                {
                    var chiPhiDuocKhuyenMais = apDungKhuyenMaiBenhNhan.DsKhuyenMaiBenhNhans.FirstOrDefault(o => o.Id == yeuCauGoiDichVu.Id)?.DanhSachDichVuTrongGoiKhuyenMais;
                    if (chiPhiDuocKhuyenMais != null)
                    {
                        foreach (var chiPhi in chiPhiDuocKhuyenMais)
                        {
                            if (chiPhi.LoaiNhom == NhomChiPhiKhamChuaBenh.DichVuKhamBenh)
                            {
                                if (chiPhi.DaChon == false)
                                {
                                    var mg = yeuCauGoiDichVu.MienGiamChiPhis.FirstOrDefault(o => o.YeuCauKhamBenhId == chiPhi.Id);
                                    if (mg != null)
                                    {
                                        mg.WillDelete = true;
                                        mg.YeuCauKhamBenh.SoTienMienGiam -= mg.SoTien;
                                        isUpdated = true;
                                    }
                                }
                                else if (yeuCauGoiDichVu.MienGiamChiPhis.All(o => o.YeuCauKhamBenhId != chiPhi.Id))
                                {
                                    var yc = yeuCauTiepNhan.YeuCauKhamBenhs.First(o => o.Id == chiPhi.Id);
                                    var dvKhuyenMai = yeuCauGoiDichVu.ChuongTrinhGoiDichVu
                                        .ChuongTrinhGoiDichVuKhuyenMaiDichVuKhamBenhs
                                        .FirstOrDefault(o =>
                                            o.DichVuKhamBenhBenhVienId == yc.DichVuKhamBenhBenhVienId &&
                                            o.NhomGiaDichVuKhamBenhBenhVienId == yc.NhomGiaDichVuKhamBenhBenhVienId);
                                    if (dvKhuyenMai != null)
                                    {
                                        var dvKhuyenMaiDaDung = yeuCauGoiDichVu.MienGiamChiPhis.Where(o => o.WillDelete != true).Count(o =>
                                              o.YeuCauKhamBenh != null &&
                                              o.YeuCauKhamBenh.TrangThai != Enums.EnumTrangThaiYeuCauKhamBenh.HuyKham &&
                                              o.YeuCauKhamBenh.DichVuKhamBenhBenhVienId == yc.DichVuKhamBenhBenhVienId &&
                                              o.YeuCauKhamBenh.NhomGiaDichVuKhamBenhBenhVienId == yc.NhomGiaDichVuKhamBenhBenhVienId);
                                        if (dvKhuyenMai.SoLan > dvKhuyenMaiDaDung && DateTime.Now.Date < yeuCauGoiDichVu.ThoiDiemChiDinh.AddDays(dvKhuyenMai.SoNgaySuDung))
                                        {
                                            yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                                            {
                                                YeuCauTiepNhanId = yeuCauTiepNhan.Id,
                                                LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                                                LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoSoTien,
                                                SoTien = chiPhi.SoTienMG,
                                                YeuCauGoiDichVuId = yeuCauGoiDichVu.Id
                                            });
                                            yc.SoTienMienGiam += chiPhi.SoTienMG;
                                            isUpdated = true;
                                        }
                                    }
                                }
                            }
                            if (chiPhi.LoaiNhom == NhomChiPhiKhamChuaBenh.DichVuKyThuat)
                            {
                                if (chiPhi.DaChon == false)
                                {
                                    var mg = yeuCauGoiDichVu.MienGiamChiPhis.FirstOrDefault(o => o.YeuCauDichVuKyThuatId == chiPhi.Id);
                                    if (mg != null)
                                    {
                                        mg.WillDelete = true;
                                        mg.YeuCauDichVuKyThuat.SoTienMienGiam -= mg.SoTien;
                                        isUpdated = true;
                                    }
                                }
                                else if (yeuCauGoiDichVu.MienGiamChiPhis.All(o => o.YeuCauDichVuKyThuatId != chiPhi.Id))
                                {
                                    var yc = yeuCauTiepNhan.YeuCauDichVuKyThuats.First(o => o.Id == chiPhi.Id);
                                    var dvKhuyenMai = yeuCauGoiDichVu.ChuongTrinhGoiDichVu
                                        .ChuongTrinhGoiDichVuKhuyenMaiDichVuKyThuats
                                        .FirstOrDefault(o =>
                                            o.DichVuKyThuatBenhVienId == yc.DichVuKyThuatBenhVienId &&
                                            o.NhomGiaDichVuKyThuatBenhVienId == yc.NhomGiaDichVuKyThuatBenhVienId);
                                    if (dvKhuyenMai != null)
                                    {
                                        var dvKhuyenMaiDaDung = yeuCauGoiDichVu.MienGiamChiPhis.Where(o => o.WillDelete != true).Where(o =>
                                              o.YeuCauDichVuKyThuat != null &&
                                              o.YeuCauDichVuKyThuat.TrangThai != Enums.EnumTrangThaiYeuCauDichVuKyThuat.DaHuy &&
                                              o.YeuCauDichVuKyThuat.DichVuKyThuatBenhVienId == yc.DichVuKyThuatBenhVienId &&
                                              o.YeuCauDichVuKyThuat.NhomGiaDichVuKyThuatBenhVienId == yc.NhomGiaDichVuKyThuatBenhVienId)
                                              .Select(o => o.YeuCauDichVuKyThuat.SoLan).DefaultIfEmpty().Sum();
                                        if (dvKhuyenMai.SoLan > dvKhuyenMaiDaDung && DateTime.Now.Date < yeuCauGoiDichVu.ThoiDiemChiDinh.AddDays(dvKhuyenMai.SoNgaySuDung))
                                        {
                                            yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                                            {
                                                YeuCauTiepNhanId = yeuCauTiepNhan.Id,
                                                LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                                                LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoSoTien,
                                                SoTien = chiPhi.SoTienMG,
                                                YeuCauGoiDichVuId = yeuCauGoiDichVu.Id
                                            });
                                            yc.SoTienMienGiam += chiPhi.SoTienMG;
                                            isUpdated = true;
                                        }
                                    }
                                }
                            }
                        }
                    }
                }

            }
            if (isUpdated)
            {
                var soTienTamUng = _taiKhoanBenhNhanService.GetSoTienDaTamUngAsync(yeuCauTiepNhan.Id).Result;
                BaoLanhDvNgoaiGoiMarketing(yeuCauTiepNhan, soTienTamUng - GetSoTienCanThanhToanNgoaiTru(yeuCauTiepNhan));
                BaseRepository.Update(yeuCauTiepNhan);
            }
        }

        public int KiemTraDichVuTrongGoiCoBHYT(long yeuCauTiepNhanId)
        {
            var yeuCauTiepNhan = BaseRepository.GetById(yeuCauTiepNhanId,
                x => x.Include(o => o.YeuCauKhamBenhs).Include(o => o.YeuCauDichVuKyThuats));
            var soDichVuKham = yeuCauTiepNhan.YeuCauKhamBenhs.Count(o =>
                o.TrangThai != Enums.EnumTrangThaiYeuCauKhamBenh.HuyKham &&
                o.TrangThaiThanhToan != Enums.TrangThaiThanhToan.DaThanhToan && o.YeuCauGoiDichVuId != null);
            var soDichVuKyThuat = yeuCauTiepNhan.YeuCauDichVuKyThuats.Count(o =>
                o.TrangThai != Enums.EnumTrangThaiYeuCauDichVuKyThuat.DaHuy &&
                o.TrangThaiThanhToan != Enums.TrangThaiThanhToan.DaThanhToan && o.YeuCauGoiDichVuId != null);
            return soDichVuKham + soDichVuKyThuat;
        }

        public async Task<bool> KiemTraConPhieuThuCongNo(long yeuCauTiepNhanId)
        {
            return await _taiKhoanBenhNhanService.KiemTraConPhieuThuCongNo(yeuCauTiepNhanId);
        }

        public List<ChiPhiKhamChuaBenhTrongGoiDichVuVo> GetDanhSachDichVuTrongGoiCoBHYTChuaQuyetToan(long yeuCauTiepNhanId)
        {
            var yeuCauTiepNhan = BaseRepository.GetById(yeuCauTiepNhanId, x => x
                .Include(o => o.YeuCauKhamBenhs).ThenInclude(o => o.DichVuKhamBenhBenhVien)
                .Include(o => o.YeuCauKhamBenhs).ThenInclude(o => o.YeuCauGoiDichVu)
                .Include(o => o.YeuCauKhamBenhs).ThenInclude(o => o.CongTyBaoHiemTuNhanCongNos)
                .Include(o => o.YeuCauKhamBenhs).ThenInclude(o => o.NhomGiaDichVuKhamBenhBenhVien)
                .Include(o => o.YeuCauKhamBenhs).ThenInclude(o => o.NoiDangKy)
                .Include(o => o.YeuCauKhamBenhs).ThenInclude(o => o.BacSiDangKy).ThenInclude(o => o.User)
                .Include(o => o.YeuCauDichVuKyThuats).ThenInclude(o => o.DichVuKyThuatBenhVien)
                .Include(o => o.YeuCauDichVuKyThuats).ThenInclude(o => o.YeuCauGoiDichVu)
                .Include(o => o.YeuCauDichVuKyThuats).ThenInclude(o => o.NhomGiaDichVuKyThuatBenhVien)
                .Include(o => o.YeuCauDichVuKyThuats).ThenInclude(o => o.NoiThucHien)
                .Include(o => o.YeuCauDichVuKyThuats).ThenInclude(o => o.CongTyBaoHiemTuNhanCongNos)
                .Include(o => o.YeuCauTiepNhanCongTyBaoHiemTuNhans)
                );
            var dichVuKhams = yeuCauTiepNhan.YeuCauKhamBenhs.Where(o =>
                o.TrangThai != Enums.EnumTrangThaiYeuCauKhamBenh.HuyKham &&
                o.TrangThaiThanhToan != Enums.TrangThaiThanhToan.DaThanhToan && o.YeuCauGoiDichVuId != null)
                .Select(s => new ChiPhiKhamChuaBenhTrongGoiDichVuVo
                {
                    Id = s.Id,
                    YeuCauGoiDichVuId = s.YeuCauGoiDichVuId.Value,
                    ChuongTrinhGoiDichVuId = s.YeuCauGoiDichVu.ChuongTrinhGoiDichVuId,
                    TenChuongTrinhGoiDichVu = s.YeuCauGoiDichVu.TenChuongTrinh,
                    LoaiNhom = NhomChiPhiKhamChuaBenh.DichVuKhamBenh,
                    Ma = s.DichVuKhamBenhBenhVien.Ma,
                    TenDichVu = s.DichVuKhamBenhBenhVien.Ten,
                    LoaiGia = s.NhomGiaDichVuKhamBenhBenhVien.Ten,
                    Soluong = 1,
                    DonGia = s.DonGiaSauChietKhau.GetValueOrDefault(),
                    KiemTraBHYTXacNhan = s.BaoHiemChiTra != null,
                    DuocHuongBHYT = s.DuocHuongBaoHiem,
                    DonGiaBHYT = s.DonGiaBaoHiem.GetValueOrDefault(),
                    TiLeBaoHiemThanhToan = s.TiLeBaoHiemThanhToan.GetValueOrDefault(),
                    MucHuongBaoHiem = s.MucHuongBaoHiem.GetValueOrDefault(),
                    DanhSachCongNoChoThus = s.CongTyBaoHiemTuNhanCongNos.Count == 0 ? new List<DanhSachCongNoVo>() : s.CongTyBaoHiemTuNhanCongNos.Where(o => o.TaiKhoanBenhNhanThuId == null).Select(o => new DanhSachCongNoVo { CongTyBaoHiemTuNhanId = o.CongTyBaoHiemTuNhanId, SoTienCongNoChoThu = o.SoTien }).ToList(),
                    NoiThucHien = (s.NoiDangKy != null ? $"{s.NoiDangKy.Ma}" : "") + (s.BacSiDangKy != null && s.BacSiDangKy.User.HoTen != null ? " - " + $"{s.BacSiDangKy.User.HoTen}" : ""),
                    CheckedDefault = true,
                });
            var dichVuKyThuats = yeuCauTiepNhan.YeuCauDichVuKyThuats.Where(o =>
                    o.TrangThai != Enums.EnumTrangThaiYeuCauDichVuKyThuat.DaHuy &&
                    o.TrangThaiThanhToan != Enums.TrangThaiThanhToan.DaThanhToan && o.YeuCauGoiDichVuId != null)
                .Select(s => new ChiPhiKhamChuaBenhTrongGoiDichVuVo
                {
                    Id = s.Id,
                    YeuCauGoiDichVuId = s.YeuCauGoiDichVuId.Value,
                    ChuongTrinhGoiDichVuId = s.YeuCauGoiDichVu.ChuongTrinhGoiDichVuId,
                    TenChuongTrinhGoiDichVu = s.YeuCauGoiDichVu.TenChuongTrinh,
                    LoaiNhom = NhomChiPhiKhamChuaBenh.DichVuKyThuat,
                    Ma = s.DichVuKyThuatBenhVien.Ma,
                    TenDichVu = s.DichVuKyThuatBenhVien.Ten,
                    LoaiGia = s.NhomGiaDichVuKyThuatBenhVien.Ten,
                    Soluong = s.SoLan,
                    DonGia = s.DonGiaSauChietKhau.GetValueOrDefault(),
                    DonGiaBHYT = s.DonGiaBaoHiem.GetValueOrDefault(),
                    KiemTraBHYTXacNhan = s.BaoHiemChiTra != null,
                    DuocHuongBHYT = s.DuocHuongBaoHiem,
                    TiLeBaoHiemThanhToan = s.TiLeBaoHiemThanhToan.GetValueOrDefault(),
                    MucHuongBaoHiem = s.MucHuongBaoHiem.GetValueOrDefault(),
                    DanhSachCongNoChoThus = s.CongTyBaoHiemTuNhanCongNos.Count == 0 ? new List<DanhSachCongNoVo>() : s.CongTyBaoHiemTuNhanCongNos.Where(o => o.TaiKhoanBenhNhanThuId == null).Select(o => new DanhSachCongNoVo { CongTyBaoHiemTuNhanId = o.CongTyBaoHiemTuNhanId, SoTienCongNoChoThu = o.SoTien }).ToList(),
                    NoiThucHien = s.NoiThucHien != null
                        ? $"{s.NoiThucHien.Ma} - {s.NoiThucHien.Ten}"
                        : string.Empty,
                    CheckedDefault = true,
                });

            var chiPhiTrongGois = dichVuKhams.Concat(dichVuKyThuats).ToList();

            foreach (var chiPhiTrongGoi in chiPhiTrongGois)
            {
                var congTyBaoHiemTuNhanBaoLanh = yeuCauTiepNhan.YeuCauTiepNhanCongTyBaoHiemTuNhans.FirstOrDefault(o => GetChuongTrinhGoiDichVuBHTNBaoLanhs().Any(ct => ct.CongTyBaoHiemTuNhanId == o.CongTyBaoHiemTuNhanId && ct.Id == chiPhiTrongGoi.ChuongTrinhGoiDichVuId));

                if (congTyBaoHiemTuNhanBaoLanh != null)
                {
                    chiPhiTrongGoi.DanhSachCongNoChoThus.Add(new DanhSachCongNoVo { CongTyBaoHiemTuNhanId = congTyBaoHiemTuNhanBaoLanh.CongTyBaoHiemTuNhanId, SoTienCongNoChoThu = chiPhiTrongGoi.SoTienQuyetToan });
                }
                //xoa BHTN va mien giam khi sl = 0
                if (chiPhiTrongGoi.Soluong.AlmostEqual(0))
                {
                    chiPhiTrongGoi.DanhSachCongNoChoThus = new List<DanhSachCongNoVo>();
                }
            }

            return chiPhiTrongGois;
        }

        public async Task<KetQuaQuyetToanDichVuTrongGoiCoBHYT> QuyetToanDichVuTrongGoiCoBHYT(QuyetToanDichVuTrongGoiVo chiTienQuyetToan)
        {
            var yeuCauTiepNhan = await BaseRepository.GetByIdAsync(chiTienQuyetToan.Id,
                x => x.Include(o => o.YeuCauKhamBenhs).ThenInclude(g => g.YeuCauNhapViens).ThenInclude(g => g.YeuCauTiepNhans)
                .Include(o => o.YeuCauKhamBenhs).ThenInclude(o => o.CongTyBaoHiemTuNhanCongNos)
                .Include(o => o.YeuCauTiepNhanCongTyBaoHiemTuNhans)
                .Include(o => o.YeuCauDichVuKyThuats).ThenInclude(o => o.CongTyBaoHiemTuNhanCongNos)
                .Include(o => o.BenhNhan).ThenInclude(o => o.TaiKhoanBenhNhan));
            var ycKhamBenhExcept = chiTienQuyetToan.DanhSachChiPhiKhamChuaBenhTrongGoiDichVus
                .Where(o => o.LoaiNhom == NhomChiPhiKhamChuaBenh.DichVuKhamBenh).Select(o => o.Id).Except(yeuCauTiepNhan
                    .YeuCauKhamBenhs
                    .Where(o => (!o.DuocHuongBaoHiem || o.BaoHiemChiTra != null) && o.TrangThai != Enums.EnumTrangThaiYeuCauKhamBenh.HuyKham &&
                        o.TrangThaiThanhToan != Enums.TrangThaiThanhToan.DaThanhToan && o.YeuCauGoiDichVuId != null)
                    .Select(o => o.Id));
            var ycKyThuatExcept = chiTienQuyetToan.DanhSachChiPhiKhamChuaBenhTrongGoiDichVus
                .Where(o => o.LoaiNhom == NhomChiPhiKhamChuaBenh.DichVuKyThuat).Select(o => o.Id).Except(yeuCauTiepNhan
                    .YeuCauDichVuKyThuats
                    .Where(o => (!o.DuocHuongBaoHiem || o.BaoHiemChiTra != null) && o.TrangThai != Enums.EnumTrangThaiYeuCauDichVuKyThuat.DaHuy &&
                        o.TrangThaiThanhToan != Enums.TrangThaiThanhToan.DaThanhToan && o.YeuCauGoiDichVuId != null)
                    .Select(o => o.Id));
            var congTyBaoHiemTuNhanIds = yeuCauTiepNhan.YeuCauTiepNhanCongTyBaoHiemTuNhans.Select(cty => cty.CongTyBaoHiemTuNhanId);

            if (ycKhamBenhExcept.Any() || ycKyThuatExcept.Any())
                return new KetQuaQuyetToanDichVuTrongGoiCoBHYT { Error = "Thông tin dịch vụ thanh toán không hợp lệ, vui lòng tải lại trang" };

            if (!chiTienQuyetToan.TienMat.GetValueOrDefault().Equals(Math.Round(chiTienQuyetToan.DanhSachChiPhiKhamChuaBenhTrongGoiDichVus.Sum(o => o.SoTienQuyetToan), MidpointRounding.AwayFromZero)))
                return new KetQuaQuyetToanDichVuTrongGoiCoBHYT { Error = "Số tiền thanh toán không hợp lệ" };

            var goiDvIds = chiTienQuyetToan.DanhSachChiPhiKhamChuaBenhTrongGoiDichVus.Select(o => o.YeuCauGoiDichVuId).Distinct();
            var goiDvs = await _yeuCauGoiDichVuRepository.Table.Where(o => goiDvIds.Contains(o.Id)).Include(o => o.ChuongTrinhGoiDichVu)
                .Include(o => o.TaiKhoanBenhNhanThus).Include(o => o.TaiKhoanBenhNhanChis).ToListAsync();

            //foreach (var goiDv in goiDvs)
            //{
            //    //update BVHD-3584
            //    //var soTienDaQuyetToan = goiDv.TaiKhoanBenhNhanThus
            //    //    .Where(o => o.DaHuy != true && o.LoaiThuTienBenhNhan == Enums.LoaiThuTienBenhNhan.ThuTheoChiPhi && o.ThuTienGoiDichVu == true)
            //    //    .Select(o => o.TienMat.GetValueOrDefault()).DefaultIfEmpty().Sum();
            //    var soTienQuyetToan = chiTienQuyetToan.DanhSachChiPhiKhamChuaBenhTrongGoiDichVus.Where(o => o.YeuCauGoiDichVuId == goiDv.Id)
            //        .Select(o => o.SoTienQuyetToan).DefaultIfEmpty().Sum();
            //    if (goiDv.SoTienBenhNhanDaChi.GetValueOrDefault() < soTienQuyetToan)
            //    {
            //        return new KetQuaQuyetToanDichVuTrongGoiCoBHYT { Error = $"Số tiền đã tạm ứng trong gói {goiDv.TenChuongTrinh} không đủ quyết toán" };
            //    }
            //}
            var userId = _userAgentHelper.GetCurrentUserId();
            var userThuNgan = _useRepository.GetById(_userAgentHelper.GetCurrentUserId());
            var maTaiKhoan = userId.ToString();
            if (userThuNgan.Email != null && userThuNgan.Email.IndexOf("@") > 0)
            {
                maTaiKhoan = userThuNgan.Email.Substring(0, userThuNgan.Email.IndexOf("@") > 10 ? 10 : userThuNgan.Email.IndexOf("@"));
            }

            var tk = yeuCauTiepNhan.BenhNhan.TaiKhoanBenhNhan ?? new TaiKhoanBenhNhan
            {
                BenhNhan = yeuCauTiepNhan.BenhNhan
            };

            var thuPhi = new TaiKhoanBenhNhanThu
            {
                TaiKhoanBenhNhan = tk,
                LoaiThuTienBenhNhan = Enums.LoaiThuTienBenhNhan.ThuTheoChiPhi,
                ThuTienGoiDichVu = true,
                LoaiNoiThu = Enums.LoaiNoiThu.ThuNgan,
                NoiDungThu = chiTienQuyetToan.NoiDungThu,
                NgayThu = chiTienQuyetToan.NgayThu,
                //update BVHD-3584
                TamUng = 0,
                //TamUng = chiTienQuyetToan.TienMat.GetValueOrDefault(),
                SoPhieuHienThi = ResourceHelper.CreateSoPhieuThu(userId, maTaiKhoan),
                NhanVienThucHienId = _userAgentHelper.GetCurrentUserId(),
                NoiThucHienId = _userAgentHelper.GetCurrentNoiLLamViecId()
            };
            foreach (var goiDvId in goiDvIds)
            {
                decimal tamUngTheoGoi = 0;
                var goiDv = goiDvs.First(o => o.Id == goiDvId);
                if (goiDv.ChuongTrinhGoiDichVu?.CongTyBaoHiemTuNhanId != null)
                    continue;

                var soTienQuyetToan = chiTienQuyetToan.DanhSachChiPhiKhamChuaBenhTrongGoiDichVus.Where(o => o.YeuCauGoiDichVuId == goiDv.Id)
                    .Select(o => o.SoTienQuyetToan).DefaultIfEmpty().Sum();
                if (soTienQuyetToan > 0)
                {
                    var phieuHoanUng = new TaiKhoanBenhNhanChi
                    {
                        TaiKhoanBenhNhan = tk,
                        LoaiChiTienBenhNhan = Enums.LoaiChiTienBenhNhan.HoanUng,
                        YeuCauGoiDichVuId = goiDv.Id,
                        TienMat = soTienQuyetToan,
                        NoiDungChi = Enums.LoaiChiTienBenhNhan.HoanUng.GetDescription(),
                        NgayChi = thuPhi.NgayThu.AddMilliseconds(-1),
                        YeuCauTiepNhanId = yeuCauTiepNhan.Id,
                        SoPhieuHienThi = ResourceHelper.CreateSoHoanUng(),
                        NhanVienThucHienId = _userAgentHelper.GetCurrentUserId(),
                        NoiThucHienId = _userAgentHelper.GetCurrentNoiLLamViecId()
                    };
                    thuPhi.TaiKhoanBenhNhanChis.Add(phieuHoanUng);
                    //update BVHD-3584
                    thuPhi.TamUng = thuPhi.TamUng.GetValueOrDefault() + soTienQuyetToan;
                    tamUngTheoGoi += soTienQuyetToan;
                }
                //hoan BHYT
                var soTienQBHYTTrongGoi = Math.Round(chiTienQuyetToan.DanhSachChiPhiKhamChuaBenhTrongGoiDichVus.Where(o => o.YeuCauGoiDichVuId == goiDv.Id).Select(o => o.BHYTThanhToan).DefaultIfEmpty().Sum(), MidpointRounding.AwayFromZero);
                if (!soTienQBHYTTrongGoi.AlmostEqual(0))
                {
                    var phieuHoanUngTrongGoi = new TaiKhoanBenhNhanChi
                    {
                        TaiKhoanBenhNhan = tk,
                        LoaiChiTienBenhNhan = Enums.LoaiChiTienBenhNhan.HoanUng,
                        YeuCauGoiDichVuId = goiDv.Id,
                        TienMat = soTienQBHYTTrongGoi,
                        NoiDungChi = Enums.LoaiChiTienBenhNhan.HoanUng.GetDescription() + " BHYT",
                        NgayChi = thuPhi.NgayThu.AddMilliseconds(-1),
                        YeuCauTiepNhanId = yeuCauTiepNhan.Id,
                        SoPhieuHienThi = ResourceHelper.CreateSoHoanUng(),
                        NhanVienThucHienId = _userAgentHelper.GetCurrentUserId(),
                        NoiThucHienId = _userAgentHelper.GetCurrentNoiLLamViecId()
                    };
                    thuPhi.TaiKhoanBenhNhanChis.Add(phieuHoanUngTrongGoi);
                    //update BVHD-3584
                    thuPhi.TamUng = thuPhi.TamUng.GetValueOrDefault() + soTienQBHYTTrongGoi;
                    tamUngTheoGoi += soTienQBHYTTrongGoi;
                }
                //hoan BHTN
                var soTienBHTNTrongGoi = Math.Round(chiTienQuyetToan.DanhSachChiPhiKhamChuaBenhTrongGoiDichVus.Where(o => o.YeuCauGoiDichVuId == goiDv.Id).Select(o => o.TongCongNo).DefaultIfEmpty().Sum(), MidpointRounding.AwayFromZero);
                if (!soTienBHTNTrongGoi.AlmostEqual(0))
                {
                    var phieuHoanUngTrongGoi = new TaiKhoanBenhNhanChi
                    {
                        TaiKhoanBenhNhan = tk,
                        LoaiChiTienBenhNhan = Enums.LoaiChiTienBenhNhan.HoanUng,
                        YeuCauGoiDichVuId = goiDv.Id,
                        TienMat = soTienBHTNTrongGoi,
                        NoiDungChi = Enums.LoaiChiTienBenhNhan.HoanUng.GetDescription() + " BHTN",
                        NgayChi = thuPhi.NgayThu.AddMilliseconds(-1),
                        YeuCauTiepNhanId = yeuCauTiepNhan.Id,
                        SoPhieuHienThi = ResourceHelper.CreateSoHoanUng(),
                        NhanVienThucHienId = _userAgentHelper.GetCurrentUserId(),
                        NoiThucHienId = _userAgentHelper.GetCurrentNoiLLamViecId()
                    };
                    thuPhi.TaiKhoanBenhNhanChis.Add(phieuHoanUngTrongGoi);
                    //update BVHD-3584
                    thuPhi.TamUng = thuPhi.TamUng.GetValueOrDefault() + soTienBHTNTrongGoi;
                    tamUngTheoGoi += soTienBHTNTrongGoi;
                }

                var soTienDaHoan = goiDv.TaiKhoanBenhNhanChis.Where(o =>
                        o.CreatedOn != null && o.LoaiChiTienBenhNhan == Enums.LoaiChiTienBenhNhan.HoanUng && o.TaiKhoanBenhNhanThuId != null &&
                        o.DaHuy != true)
                    .Select(o => o.TienMat.GetValueOrDefault()).DefaultIfEmpty().Sum();

                if (goiDv.SoTienBenhNhanDaChi.GetValueOrDefault() + 100 < tamUngTheoGoi + soTienDaHoan)
                {
                    return new KetQuaQuyetToanDichVuTrongGoiCoBHYT { Error = $"Số tiền đã tạm ứng trong gói {goiDv.TenChuongTrinh} không đủ quyết toán" };
                }
            }

            foreach (var chiphi in chiTienQuyetToan.DanhSachChiPhiKhamChuaBenhTrongGoiDichVus.Where(o => o.LoaiNhom == NhomChiPhiKhamChuaBenh.DichVuKhamBenh))
            {
                var yc = yeuCauTiepNhan.YeuCauKhamBenhs.First(o => o.Id == chiphi.Id);
                if (yc.NoiDangKyId != null && yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan)
                {
                    yc.PhongBenhVienHangDois.Add(XepVaoHangDoi(yeuCauTiepNhan, yc.NoiDangKyId.Value));
                }

                foreach (var ycCongTyBaoHiemTuNhanCongNo in yc.CongTyBaoHiemTuNhanCongNos.Where(o => o.TaiKhoanBenhNhanThuId == null))
                {
                    ycCongTyBaoHiemTuNhanCongNo.WillDelete = true;
                }
                if (chiphi.TongCongNo > 0)
                {
                    foreach (var chiphiDanhSachCongNoChoThu in chiphi.DanhSachCongNoChoThus)
                    {
                        if (chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu.AlmostEqual(0))
                            continue;
                        yc.CongTyBaoHiemTuNhanCongNos.Add(new CongTyBaoHiemTuNhanCongNo
                        {
                            TaiKhoanBenhNhanThu = thuPhi,
                            CongTyBaoHiemTuNhanId = chiphiDanhSachCongNoChoThu.CongTyBaoHiemTuNhanId,
                            SoTien = chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu
                        });
                    }
                }
                yc.SoTienBaoHiemTuNhanChiTra = chiphi.TongCongNo;

                yc.SoTienBenhNhanDaChi = chiphi.SoTienQuyetToan;
                yc.TrangThaiThanhToan = Enums.TrangThaiThanhToan.DaThanhToan;

                thuPhi.TaiKhoanBenhNhanChis.Add(new TaiKhoanBenhNhanChi
                {
                    TaiKhoanBenhNhan = tk,
                    LoaiChiTienBenhNhan = Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi,
                    TienChiPhi = yc.SoTienBenhNhanDaChi,
                    NoiDungChi = Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi.GetDescription(),
                    NgayChi = DateTime.Now,
                    SoPhieuHienThi = thuPhi.SoPhieuHienThi,
                    YeuCauKhamBenh = yc,
                    Gia = yc.DonGiaSauChietKhau.GetValueOrDefault(),
                    SoLuong = 1,
                    DonGiaBaoHiem = yc.DonGiaBaoHiem,
                    MucHuongBaoHiem = yc.DuocHuongBaoHiem ? yc.MucHuongBaoHiem : 0,
                    TiLeBaoHiemThanhToan = yc.TiLeBaoHiemThanhToan,
                    SoTienMienGiam = yc.SoTienMienGiam,
                    SoTienBaoHiemTuNhanChiTra = yc.SoTienBaoHiemTuNhanChiTra,
                    YeuCauTiepNhanId = yeuCauTiepNhan.Id,
                    NhanVienThucHienId = _userAgentHelper.GetCurrentUserId(),
                    NoiThucHienId = _userAgentHelper.GetCurrentNoiLLamViecId()
                });
            }
            foreach (var chiphi in chiTienQuyetToan.DanhSachChiPhiKhamChuaBenhTrongGoiDichVus.Where(o => o.LoaiNhom == NhomChiPhiKhamChuaBenh.DichVuKyThuat))
            {
                var yc = yeuCauTiepNhan.YeuCauDichVuKyThuats.First(o => o.Id == chiphi.Id);
                if (yc.NoiThucHienId != null && yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan)
                {
                    yc.PhongBenhVienHangDois.Add(XepVaoHangDoi(yeuCauTiepNhan, yc.NoiThucHienId.Value));
                }
                foreach (var ycCongTyBaoHiemTuNhanCongNo in yc.CongTyBaoHiemTuNhanCongNos.Where(o => o.TaiKhoanBenhNhanThuId == null))
                {
                    ycCongTyBaoHiemTuNhanCongNo.WillDelete = true;
                }
                if (chiphi.TongCongNo > 0)
                {
                    foreach (var chiphiDanhSachCongNoChoThu in chiphi.DanhSachCongNoChoThus)
                    {
                        if (chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu.AlmostEqual(0))
                            continue;
                        yc.CongTyBaoHiemTuNhanCongNos.Add(new CongTyBaoHiemTuNhanCongNo
                        {
                            TaiKhoanBenhNhanThu = thuPhi,
                            CongTyBaoHiemTuNhanId = chiphiDanhSachCongNoChoThu.CongTyBaoHiemTuNhanId,
                            SoTien = chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu
                        });
                    }
                }
                yc.SoTienBaoHiemTuNhanChiTra = chiphi.TongCongNo;

                yc.SoTienBenhNhanDaChi = chiphi.SoTienQuyetToan;
                yc.TrangThaiThanhToan = Enums.TrangThaiThanhToan.DaThanhToan;
                thuPhi.TaiKhoanBenhNhanChis.Add(new TaiKhoanBenhNhanChi
                {
                    TaiKhoanBenhNhan = tk,
                    LoaiChiTienBenhNhan = Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi,
                    TienChiPhi = yc.SoTienBenhNhanDaChi,
                    NoiDungChi = Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi.GetDescription(),
                    NgayChi = DateTime.Now,
                    SoPhieuHienThi = thuPhi.SoPhieuHienThi,
                    YeuCauDichVuKyThuat = yc,
                    Gia = yc.DonGiaSauChietKhau.GetValueOrDefault(),
                    SoLuong = yc.SoLan,
                    DonGiaBaoHiem = yc.DonGiaBaoHiem,
                    MucHuongBaoHiem = yc.DuocHuongBaoHiem ? yc.MucHuongBaoHiem : 0,
                    TiLeBaoHiemThanhToan = yc.TiLeBaoHiemThanhToan,
                    SoTienMienGiam = yc.SoTienMienGiam,
                    SoTienBaoHiemTuNhanChiTra = yc.SoTienBaoHiemTuNhanChiTra,
                    YeuCauTiepNhanId = yeuCauTiepNhan.Id,
                    NhanVienThucHienId = _userAgentHelper.GetCurrentUserId(),
                    NoiThucHienId = _userAgentHelper.GetCurrentNoiLLamViecId()
                });
            }
            yeuCauTiepNhan.TaiKhoanBenhNhanThus.Add(thuPhi);

            //bỏ tự động nhập viện
            //if (yeuCauTiepNhan.YeuCauKhamBenhs.All(o =>
            //        o.TrangThai == Enums.EnumTrangThaiYeuCauKhamBenh.HuyKham ||
            //        o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.DaThanhToan)
            //    && yeuCauTiepNhan.YeuCauDichVuKyThuats.All(o =>
            //        o.TrangThai == Enums.EnumTrangThaiYeuCauDichVuKyThuat.DaHuy ||
            //        o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.DaThanhToan))
            //{
            //    foreach (var yeuCauKhamBenh in yeuCauTiepNhan.YeuCauKhamBenhs)
            //    {
            //        var yeuCauNhapVien = yeuCauKhamBenh.YeuCauNhapViens.FirstOrDefault(o => !o.YeuCauTiepNhans.Any());
            //        if (yeuCauNhapVien != null)
            //        {
            //            var yeuCauTiepNhanNoiTru = GetYeuCauTiepNhanNoiTru(yeuCauTiepNhan, yeuCauNhapVien);
            //            await BaseRepository.AddAsync(yeuCauTiepNhanNoiTru);
            //            return new KetQuaQuyetToanDichVuTrongGoiCoBHYT { PhieuQuyetToanId = thuPhi.Id, PhieuHoanUngIds = thuPhi.TaiKhoanBenhNhanChis.Where(o => o.LoaiChiTienBenhNhan == Enums.LoaiChiTienBenhNhan.HoanUng).Select(o => o.Id).ToList() };
            //        }
            //    }
            //}

            //await BaseRepository.UpdateAsync(yeuCauTiepNhan);
            BaseRepository.Context.SaveChanges();
            return new KetQuaQuyetToanDichVuTrongGoiCoBHYT { PhieuQuyetToanId = thuPhi.Id, PhieuHoanUngIds = thuPhi.TaiKhoanBenhNhanChis.Where(o => o.LoaiChiTienBenhNhan == Enums.LoaiChiTienBenhNhan.HoanUng).Select(o => o.Id).ToList() };
        }
        public decimal GetSoTienHoanUngTrongGoi(long yeuCauTiepNhanId)
        {
            var dsDichVu = GetDanhSachDichVuTrongGoiCoBHYTChuaQuyetToan(yeuCauTiepNhanId);
            var goiDvIds = dsDichVu.Select(o => o.YeuCauGoiDichVuId).Distinct().ToList();
            var goiDvs = _yeuCauGoiDichVuRepository.Table.Where(o => goiDvIds.Contains(o.Id)).Include(o => o.ChuongTrinhGoiDichVu).ToList();
            decimal soTienHoanUng = 0;
            foreach (var goiDv in goiDvs)
            {
                if (goiDv.ChuongTrinhGoiDichVu?.CongTyBaoHiemTuNhanId != null)
                    continue;
                soTienHoanUng += Math.Round(dsDichVu.Where(o => o.YeuCauGoiDichVuId == goiDv.Id).Select(o => o.BHYTThanhToan).DefaultIfEmpty().Sum(), MidpointRounding.AwayFromZero);
                soTienHoanUng += Math.Round(dsDichVu.Where(o => o.YeuCauGoiDichVuId == goiDv.Id).Select(o => o.TongCongNo).DefaultIfEmpty().Sum(), MidpointRounding.AwayFromZero);
            }
            return soTienHoanUng;
        }
        public async Task LuuTamChiPhiNgoaiTruTrongGoi(QuyetToanDichVuTrongGoiVo chiTienQuyetToan)
        {
            var yeuCauTiepNhan = BaseRepository.GetById(chiTienQuyetToan.Id,
                x => x.Include(o => o.YeuCauKhamBenhs).ThenInclude(g => g.YeuCauNhapViens).ThenInclude(g => g.YeuCauTiepNhans)
                .Include(o => o.YeuCauKhamBenhs).ThenInclude(o => o.CongTyBaoHiemTuNhanCongNos)
                .Include(o => o.YeuCauTiepNhanCongTyBaoHiemTuNhans)
                .Include(o => o.YeuCauDichVuKyThuats).ThenInclude(o => o.CongTyBaoHiemTuNhanCongNos)
                .Include(o => o.BenhNhan).ThenInclude(o => o.TaiKhoanBenhNhan));
            var ycKhamBenhExcept = chiTienQuyetToan.DanhSachChiPhiKhamChuaBenhTrongGoiDichVus
                .Where(o => o.LoaiNhom == NhomChiPhiKhamChuaBenh.DichVuKhamBenh).Select(o => o.Id).Except(yeuCauTiepNhan
                    .YeuCauKhamBenhs
                    .Where(o => (!o.DuocHuongBaoHiem || o.BaoHiemChiTra != null) && o.TrangThai != Enums.EnumTrangThaiYeuCauKhamBenh.HuyKham &&
                        o.TrangThaiThanhToan != Enums.TrangThaiThanhToan.DaThanhToan && o.YeuCauGoiDichVuId != null)
                    .Select(o => o.Id));
            var ycKyThuatExcept = chiTienQuyetToan.DanhSachChiPhiKhamChuaBenhTrongGoiDichVus
                .Where(o => o.LoaiNhom == NhomChiPhiKhamChuaBenh.DichVuKyThuat).Select(o => o.Id).Except(yeuCauTiepNhan
                    .YeuCauDichVuKyThuats
                    .Where(o => (!o.DuocHuongBaoHiem || o.BaoHiemChiTra != null) && o.TrangThai != Enums.EnumTrangThaiYeuCauDichVuKyThuat.DaHuy &&
                        o.TrangThaiThanhToan != Enums.TrangThaiThanhToan.DaThanhToan && o.YeuCauGoiDichVuId != null)
                    .Select(o => o.Id));
            var congTyBaoHiemTuNhanIds = yeuCauTiepNhan.YeuCauTiepNhanCongTyBaoHiemTuNhans.Select(cty => cty.CongTyBaoHiemTuNhanId);
            if (ycKhamBenhExcept.Any() || ycKyThuatExcept.Any())
                throw new Exception("Thông tin dịch vụ thanh toán không hợp lệ, vui lòng tải lại trang");

            var dsChiPhi = GetDanhSachDichVuTrongGoiCoBHYTChuaQuyetToan(chiTienQuyetToan.Id);
            var dsChiPhiDaChon = chiTienQuyetToan.DanhSachChiPhiKhamChuaBenhTrongGoiDichVus;

            foreach (var chiPhiKhamChuaBenhVo in dsChiPhiDaChon)
            {
                var chiphi = dsChiPhi.FirstOrDefault(o => o.LoaiNhom == chiPhiKhamChuaBenhVo.LoaiNhom && o.Id == chiPhiKhamChuaBenhVo.Id);
                if (chiphi == null || !chiphi.ThanhTien.AlmostEqual(chiPhiKhamChuaBenhVo.ThanhTien) || !chiphi.BHYTThanhToan.AlmostEqual(chiPhiKhamChuaBenhVo.BHYTThanhToan))
                {
                    throw new Exception("Thông tin dịch vụ thanh toán không hợp lệ, vui lòng tải lại trang");
                }
                if (chiPhiKhamChuaBenhVo.TongCongNo > chiPhiKhamChuaBenhVo.ThanhTien && chiPhiKhamChuaBenhVo.TongCongNo > Math.Round(chiPhiKhamChuaBenhVo.ThanhTien, 2, MidpointRounding.AwayFromZero))
                {
                    throw new Exception("Số tiền BHTN thanh toán lớn hơn thành tiền");
                }
            }

            var goiDvIds = chiTienQuyetToan.DanhSachChiPhiKhamChuaBenhTrongGoiDichVus.Select(o => o.YeuCauGoiDichVuId).Distinct();
            var goiDvs = _yeuCauGoiDichVuRepository.Table.Where(o => goiDvIds.Contains(o.Id)).Include(o => o.ChuongTrinhGoiDichVu)
                .Include(o => o.TaiKhoanBenhNhanThus).Include(o => o.TaiKhoanBenhNhanChis).ToList();

            foreach (var chiphi in chiTienQuyetToan.DanhSachChiPhiKhamChuaBenhTrongGoiDichVus.Where(o => o.LoaiNhom == NhomChiPhiKhamChuaBenh.DichVuKhamBenh))
            {
                var yc = yeuCauTiepNhan.YeuCauKhamBenhs.First(o => o.Id == chiphi.Id);
                //kiem tra goi BHTN khong phai goi bao lanh
                if (goiDvs.FirstOrDefault(o => o.Id == yc.YeuCauGoiDichVuId)?.ChuongTrinhGoiDichVu.CongTyBaoHiemTuNhanId == null)
                {
                    foreach (var ycCongTyBaoHiemTuNhanCongNo in yc.CongTyBaoHiemTuNhanCongNos.Where(o => o.TaiKhoanBenhNhanThuId == null))
                    {
                        ycCongTyBaoHiemTuNhanCongNo.WillDelete = true;
                    }
                    if (chiphi.TongCongNo > 0)
                    {                        
                        foreach (var chiphiDanhSachCongNoChoThu in chiphi.DanhSachCongNoChoThus)
                        {
                            if (chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu.AlmostEqual(0))
                                continue;
                            yc.CongTyBaoHiemTuNhanCongNos.Add(new CongTyBaoHiemTuNhanCongNo
                            {
                                CongTyBaoHiemTuNhanId = chiphiDanhSachCongNoChoThu.CongTyBaoHiemTuNhanId,
                                SoTien = chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu
                            });
                        }
                    }
                    yc.SoTienBaoHiemTuNhanChiTra = chiphi.TongCongNo;
                }
            }
            foreach (var chiphi in chiTienQuyetToan.DanhSachChiPhiKhamChuaBenhTrongGoiDichVus.Where(o => o.LoaiNhom == NhomChiPhiKhamChuaBenh.DichVuKyThuat))
            {
                var yc = yeuCauTiepNhan.YeuCauDichVuKyThuats.First(o => o.Id == chiphi.Id);
                //kiem tra goi BHTN khong phai goi bao lanh
                if (goiDvs.FirstOrDefault(o => o.Id == yc.YeuCauGoiDichVuId)?.ChuongTrinhGoiDichVu.CongTyBaoHiemTuNhanId == null)
                {
                    foreach (var ycCongTyBaoHiemTuNhanCongNo in yc.CongTyBaoHiemTuNhanCongNos.Where(o => o.TaiKhoanBenhNhanThuId == null))
                    {
                        ycCongTyBaoHiemTuNhanCongNo.WillDelete = true;
                    }
                    if (chiphi.TongCongNo > 0)
                    {
                        foreach (var chiphiDanhSachCongNoChoThu in chiphi.DanhSachCongNoChoThus)
                        {
                            if (chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu.AlmostEqual(0))
                                continue;
                            yc.CongTyBaoHiemTuNhanCongNos.Add(new CongTyBaoHiemTuNhanCongNo
                            {
                                CongTyBaoHiemTuNhanId = chiphiDanhSachCongNoChoThu.CongTyBaoHiemTuNhanId,
                                SoTien = chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu
                            });
                        }
                    }
                    yc.SoTienBaoHiemTuNhanChiTra = chiphi.TongCongNo;
                }
            }

            //await BaseRepository.UpdateAsync(yeuCauTiepNhan);
            BaseRepository.Context.SaveChanges();
        }

        #region update 02/03/2021

        public async Task<GridDataSource> GetDanhSachThuPhiNgoaiTruAsync(ThuNganQueryInfo queryInfo, bool isAllData)
        {
            ReplaceDisplayValueSortExpression(queryInfo);
            var sreachString = JsonConvert.DeserializeObject<DanhSachBenhNhanChoThuNganGridVo>(queryInfo.AdditionalSearchString);

            //Build Default Sort
            if (queryInfo.Sort == null || queryInfo.Sort.Count == 0)
            {
                queryInfo.Sort = new List<Sort> { new Sort { Field = "Id", Dir = "asc" } };
            }
            var queryTheoDanhSach = BaseRepository.TableNoTracking.Where(o => (o.LoaiYeuCauTiepNhan == Enums.EnumLoaiYeuCauTiepNhan.KhamChuaBenhNgoaiTru || o.LoaiYeuCauTiepNhan == Enums.EnumLoaiYeuCauTiepNhan.KhamSucKhoe)
                                                                        && o.TrangThaiYeuCauTiepNhan != Enums.EnumTrangThaiYeuCauTiepNhan.DaHuy);


            var query = queryTheoDanhSach.Select(s => new DanhSachBenhNhanChoThuNganGridVo
            {
                Id = s.Id,
                MaTN = s.MaYeuCauTiepNhan,
                HoTen = s.HoTen,
                DienThoaiStr = s.SoDienThoaiDisplay,
                DienThoai = s.SoDienThoai,
                GioiTinh = s.GioiTinh,
                MaBN = s.BenhNhan != null ? s.BenhNhan.MaBN : "",
                NamSinh = s.NamSinh,
                ThoiDiemTiepNhanDisplay = s.ThoiDiemTiepNhan.ApplyFormatDateTimeSACH(),
                ThoiDiemTiepNhan = s.ThoiDiemTiepNhan,
                DoiTuong = s.CoBHYT != true ? "Viện phí" : "BHYT (" + s.BHYTMucHuong.ToString() + "%)"
            });

            if (!string.IsNullOrEmpty(queryInfo.AdditionalSearchString))
            {
                var queryString = JsonConvert.DeserializeObject<DanhSachBenhNhanChoThuNganGridVo>(queryInfo.AdditionalSearchString);
                if (!string.IsNullOrEmpty(queryString.FromDate) || !string.IsNullOrEmpty(queryString.ToDate))
                {
                    DateTime denNgay;
                    queryString.FromDate.TryParseExactCustom(out var tuNgay);
                    if (string.IsNullOrEmpty(queryString.ToDate))
                    {
                        denNgay = DateTime.Now;
                    }
                    else
                    {
                        queryString.ToDate.TryParseExactCustom(out denNgay);
                    }
                    denNgay = denNgay.AddSeconds(59).AddMilliseconds(999);
                    query = query.Where(p => p.ThoiDiemTiepNhan >= tuNgay && p.ThoiDiemTiepNhan <= denNgay);
                }
                if (queryString.NamSinh.GetValueOrDefault() != 0)
                    query = query.Where(p => p.NamSinh == queryString.NamSinh);
                if (!string.IsNullOrEmpty(queryString.DienThoaiStr))
                    query = query.Where(p => p.DienThoai.Contains(queryString.DienThoaiStr.Trim()) || p.DienThoaiStr.Contains(queryString.DienThoaiStr.Trim()));
            }

            if (!string.IsNullOrEmpty(sreachString.SearchString))
            {
                query = query.ApplyLike(sreachString.SearchString.Trim(),
                   g => g.MaBN,
                   g => g.HoTen,
                   g => g.MaTN);
            }

            var queryResult = isAllData == true ? query.OrderBy(queryInfo.SortString).ToArray()
                : query.OrderBy(queryInfo.SortString).Skip(queryInfo.Skip).Take(queryInfo.Take).ToArray();

            if (queryResult.Length > 0)
            {
                var yctnIds = queryResult.Select(o => o.Id).ToList();
                var phieuThus = _taiKhoanBenhNhanThu.TableNoTracking
                    .Include(o => o.TaiKhoanBenhNhanChis)
                    .Where(o => yctnIds.Contains(o.YeuCauTiepNhanId) &&
                                    (o.LoaiThuTienBenhNhan == Enums.LoaiThuTienBenhNhan.ThuTamUng || o.LoaiThuTienBenhNhan == Enums.LoaiThuTienBenhNhan.ThuTheoChiPhi) &&
                                    o.ThuTienGoiDichVu != true && o.DaHuy != true && o.PhieuHoanUngId == null)
                    .ToList();
                var yeuCauTiepNhanCoNhapVienIds = _yeuCauKhamBenhRepository.TableNoTracking
                    .Where(o => yctnIds.Contains(o.YeuCauTiepNhanId) && o.TrangThai != Enums.EnumTrangThaiYeuCauKhamBenh.HuyKham && o.YeuCauNhapViens.Any())
                    .Select(o => o.YeuCauTiepNhanId)
                    .ToList();

                foreach (var danhSachBenhNhanChoThuNganGridVo in queryResult)
                {
                    danhSachBenhNhanChoThuNganGridVo.SoTienDaThu = phieuThus
                        .Where(o => o.YeuCauTiepNhanId == danhSachBenhNhanChoThuNganGridVo.Id && o.LoaiThuTienBenhNhan == Enums.LoaiThuTienBenhNhan.ThuTheoChiPhi)
                        .SelectMany(o => o.TaiKhoanBenhNhanChis).Where(o => o.LoaiChiTienBenhNhan == Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi && o.DaHuy != true).Select(o => o.TienChiPhi.GetValueOrDefault()).DefaultIfEmpty().Sum();
                    danhSachBenhNhanChoThuNganGridVo.SoTienTamUng = phieuThus.Where(o => o.YeuCauTiepNhanId == danhSachBenhNhanChoThuNganGridVo.Id && o.LoaiThuTienBenhNhan == Enums.LoaiThuTienBenhNhan.ThuTamUng).Select(o => o.TienMat.GetValueOrDefault() + o.ChuyenKhoan.GetValueOrDefault() + o.POS.GetValueOrDefault()).DefaultIfEmpty().Sum();
                    danhSachBenhNhanChoThuNganGridVo.YeuCauNhapVien = yeuCauTiepNhanCoNhapVienIds.Contains(danhSachBenhNhanChoThuNganGridVo.Id);
                }
            }
            return new GridDataSource { Data = queryResult };
        }

        public async Task<GridDataSource> GetTotalPageDanhSachThuPhiNgoaiTruAsync(ThuNganQueryInfo queryInfo)
        {
            ReplaceDisplayValueSortExpression(queryInfo);
            var sreachString = JsonConvert.DeserializeObject<DanhSachBenhNhanChoThuNganGridVo>(queryInfo.AdditionalSearchString);

            var queryTheoDanhSach = BaseRepository.TableNoTracking.Where(o => (o.LoaiYeuCauTiepNhan == Enums.EnumLoaiYeuCauTiepNhan.KhamChuaBenhNgoaiTru || o.LoaiYeuCauTiepNhan == Enums.EnumLoaiYeuCauTiepNhan.KhamSucKhoe)
                                                                        && o.TrangThaiYeuCauTiepNhan != Enums.EnumTrangThaiYeuCauTiepNhan.DaHuy);


            var query = queryTheoDanhSach.Select(s => new DanhSachBenhNhanChoThuNganGridVo
            {
                Id = s.Id,
                MaTN = s.MaYeuCauTiepNhan,
                HoTen = s.HoTen,
                DienThoaiStr = s.SoDienThoaiDisplay,
                DienThoai = s.SoDienThoai,
                GioiTinh = s.GioiTinh,
                MaBN = s.BenhNhan != null ? s.BenhNhan.MaBN : "",
                NamSinh = s.NamSinh,
                ThoiDiemTiepNhanDisplay = s.ThoiDiemTiepNhan.ApplyFormatDateTimeSACH(),
                ThoiDiemTiepNhan = s.ThoiDiemTiepNhan,
                DoiTuong = s.CoBHYT != true ? "Viện phí" : "BHYT (" + s.BHYTMucHuong.ToString() + "%)"
            });

            if (!string.IsNullOrEmpty(queryInfo.AdditionalSearchString))
            {
                var queryString = JsonConvert.DeserializeObject<DanhSachBenhNhanChoThuNganGridVo>(queryInfo.AdditionalSearchString);
                if (!string.IsNullOrEmpty(queryString.FromDate) || !string.IsNullOrEmpty(queryString.ToDate))
                {
                    DateTime denNgay;
                    queryString.FromDate.TryParseExactCustom(out var tuNgay);
                    if (string.IsNullOrEmpty(queryString.ToDate))
                    {
                        denNgay = DateTime.Now;
                    }
                    else
                    {
                        queryString.ToDate.TryParseExactCustom(out denNgay);
                    }
                    denNgay = denNgay.AddSeconds(59).AddMilliseconds(999);
                    query = query.Where(p => p.ThoiDiemTiepNhan >= tuNgay && p.ThoiDiemTiepNhan <= denNgay);
                }
                if (queryString.NamSinh.GetValueOrDefault() != 0)
                    query = query.Where(p => p.NamSinh == queryString.NamSinh);
                if (!string.IsNullOrEmpty(queryString.DienThoaiStr))
                    query = query.Where(p => p.DienThoai.Contains(queryString.DienThoaiStr.Trim()) || p.DienThoaiStr.Contains(queryString.DienThoaiStr.Trim()));
            }

            if (!string.IsNullOrEmpty(sreachString.SearchString))
            {
                query = query.ApplyLike(sreachString.SearchString.Trim(),
                   g => g.MaBN,
                   g => g.HoTen,
                   g => g.MaTN);
            }

            var totalRow = await query.CountAsync();

            return new GridDataSource { TotalRowCount = totalRow };
        }
        public async Task<GridDataSource> GetDanhSachChuaThuNgoaiTruAsync(ThuNganQueryInfo queryInfo, bool isAllData)
        {
            ReplaceDisplayValueSortExpression(queryInfo);
            var sreachString = JsonConvert.DeserializeObject<DanhSachBenhNhanChoThuNganGridVo>(queryInfo.AdditionalSearchString);

            //Build Default Sort
            if (queryInfo.Sort == null || queryInfo.Sort.Count == 0)
            {
                queryInfo.Sort = new List<Sort> { new Sort { Field = "Id", Dir = "asc" } };
            }
            var queryTheoDanhSach = BaseRepository.TableNoTracking.Where(o => o.QuyetToanTheoNoiTru != true && (o.LoaiYeuCauTiepNhan == Enums.EnumLoaiYeuCauTiepNhan.KhamChuaBenhNgoaiTru || o.LoaiYeuCauTiepNhan == Enums.EnumLoaiYeuCauTiepNhan.KhamSucKhoe)
                                                                        && o.TrangThaiYeuCauTiepNhan == Enums.EnumTrangThaiYeuCauTiepNhan.DangThucHien
                                                                                && (o.YeuCauKhamBenhs.Any(k => k.GoiKhamSucKhoeId == null && k.TrangThai != Enums.EnumTrangThaiYeuCauKhamBenh.HuyKham && (k.TrangThaiThanhToan != Enums.TrangThaiThanhToan.DaThanhToan || k.YeuCauNhapViens.Any()))
                                                                                    || o.YeuCauDichVuKyThuats.Any(k => k.GoiKhamSucKhoeId == null && k.TrangThai != Enums.EnumTrangThaiYeuCauDichVuKyThuat.DaHuy && k.TrangThaiThanhToan != Enums.TrangThaiThanhToan.DaThanhToan)
                                                                                    || o.YeuCauDuocPhamBenhViens.Any(k => k.TrangThai != Enums.EnumYeuCauDuocPhamBenhVien.DaHuy && k.TrangThaiThanhToan != Enums.TrangThaiThanhToan.DaThanhToan)
                                                                                    || o.YeuCauVatTuBenhViens.Any(k => k.TrangThai != Enums.EnumYeuCauVatTuBenhVien.DaHuy && k.TrangThaiThanhToan != Enums.TrangThaiThanhToan.DaThanhToan)
                                                                                    || o.DonThuocThanhToans.Any(k => k.LoaiDonThuoc == Enums.EnumLoaiDonThuoc.ThuocBHYT && k.TrangThai != Enums.TrangThaiDonThuocThanhToan.DaHuy && k.TrangThaiThanhToan != Enums.TrangThaiThanhToan.DaThanhToan)));


            var query = queryTheoDanhSach.Select(s => new DanhSachBenhNhanChoThuNganGridVo
            {
                Id = s.Id,
                MaTN = s.MaYeuCauTiepNhan,
                HoTen = s.HoTen,
                DienThoaiStr = s.SoDienThoaiDisplay,
                DienThoai = s.SoDienThoai,
                GioiTinh = s.GioiTinh,
                MaBN = s.BenhNhan != null ? s.BenhNhan.MaBN : "",
                NamSinh = s.NamSinh,
                ThoiDiemTiepNhanDisplay = s.ThoiDiemTiepNhan.ApplyFormatDateTimeSACH(),
                ThoiDiemTiepNhan = s.ThoiDiemTiepNhan,
                DoiTuong = s.CoBHYT != true ? "Viện phí" : "BHYT (" + s.BHYTMucHuong.ToString() + "%)"
            });

            if (!string.IsNullOrEmpty(queryInfo.AdditionalSearchString))
            {
                var queryString = JsonConvert.DeserializeObject<DanhSachBenhNhanChoThuNganGridVo>(queryInfo.AdditionalSearchString);
                if (!string.IsNullOrEmpty(queryString.FromDate) || !string.IsNullOrEmpty(queryString.ToDate))
                {
                    DateTime denNgay;
                    queryString.FromDate.TryParseExactCustom(out var tuNgay);
                    //DateTime.TryParseExact(queryString.FromDate, "dd/MM/yyyy hh:mm tt", null, DateTimeStyles.None,
                    //    out var tuNgay);
                    if (string.IsNullOrEmpty(queryString.ToDate))
                    {
                        denNgay = DateTime.Now;
                    }
                    else
                    {
                        queryString.ToDate.TryParseExactCustom(out denNgay);
                        //DateTime.TryParseExact(queryString.ToDate, "dd/MM/yyyy hh:mm tt", null, DateTimeStyles.None, out denNgay);
                    }
                    denNgay = denNgay.AddSeconds(59).AddMilliseconds(999);
                    query = query.Where(p => p.ThoiDiemTiepNhan >= tuNgay && p.ThoiDiemTiepNhan <= denNgay);
                }

                if (!string.IsNullOrEmpty(queryString.MaTN))
                    query = query.Where(p => p.MaTN.Contains(queryString.MaTN.Trim()));
                if (!string.IsNullOrEmpty(queryString.MaBN))
                    query = query.Where(p => p.MaBN.Contains(queryString.MaBN.Trim()));
                if (!string.IsNullOrEmpty(queryString.HoTen))
                    query = query.Where(p => p.HoTen.Contains(queryString.HoTen.Trim()));
                if (queryString.NamSinh.GetValueOrDefault() != 0)
                    query = query.Where(p => p.NamSinh == queryString.NamSinh);
                if (!string.IsNullOrEmpty(queryString.DienThoaiStr))
                    query = query.Where(p => p.DienThoaiStr.Contains(queryString.DienThoaiStr.Trim()));
            }

            if (!string.IsNullOrEmpty(sreachString.SearchString))
            {
                query = query.ApplyLike(sreachString.SearchString.Trim(),
                   g => g.MaBN,
                   g => g.HoTen,
                   g => g.DienThoai, g => g.DienThoaiStr,
                   g => g.MaTN);
            }

            var queryResult = isAllData == true ? await query.OrderBy(queryInfo.SortString).ToArrayAsync()
                : await query.OrderBy(queryInfo.SortString).Skip(queryInfo.Skip).Take(queryInfo.Take).ToArrayAsync();

            if (queryResult.Length > 0)
            {
                var yctnIds = queryResult.Select(o => o.Id).ToList();
                var danhSachChiPhiDichVus = BaseRepository.TableNoTracking.Where(tn => yctnIds.Contains(tn.Id)).Select(tn =>
                    new DanhSachChiPhiDichVuVo
                    {
                        YeuCauTiepNhanId = tn.Id,
                        ChiPhiDichVuKhamBenh = tn.YeuCauKhamBenhs.Where(o => o.GoiKhamSucKhoeId == null && o.TrangThai != Enums.EnumTrangThaiYeuCauKhamBenh.HuyKham).Select(yc => new ChiPhiDichVuVo
                        {
                            Soluong = 1,
                            DonGia = yc.YeuCauGoiDichVuId == null ? yc.Gia : yc.DonGiaSauChietKhau.GetValueOrDefault(),
                            KhongTinhPhi = yc.KhongTinhPhi,
                            DuocHuongBHYT = yc.DuocHuongBaoHiem,
                            DonGiaBHYT = yc.DonGiaBaoHiem.GetValueOrDefault(),
                            TiLeBaoHiemThanhToan = yc.TiLeBaoHiemThanhToan.GetValueOrDefault(),
                            MucHuongBaoHiem = yc.MucHuongBaoHiem.GetValueOrDefault(),
                            SoTienMG = yc.SoTienMienGiam.GetValueOrDefault(),
                            DaThanhToan = yc.SoTienBenhNhanDaChi.GetValueOrDefault(),
                            TongCongNo = yc.SoTienBaoHiemTuNhanChiTra.GetValueOrDefault(),
                            YeuCauNhapVien = yc.YeuCauNhapViens.Any()
                        }).ToList(),
                        ChiPhiDichVuKyThuat = tn.YeuCauDichVuKyThuats.Where(o => o.GoiKhamSucKhoeId == null && o.TrangThai != Enums.EnumTrangThaiYeuCauDichVuKyThuat.DaHuy).Select(yc => new ChiPhiDichVuVo
                        {
                            Soluong = yc.SoLan,
                            DonGia = yc.YeuCauGoiDichVuId == null ? yc.Gia : yc.DonGiaSauChietKhau.GetValueOrDefault(),
                            KhongTinhPhi = yc.KhongTinhPhi,
                            DuocHuongBHYT = yc.DuocHuongBaoHiem,
                            DonGiaBHYT = yc.DonGiaBaoHiem.GetValueOrDefault(),
                            TiLeBaoHiemThanhToan = yc.TiLeBaoHiemThanhToan.GetValueOrDefault(),
                            MucHuongBaoHiem = yc.MucHuongBaoHiem.GetValueOrDefault(),
                            SoTienMG = yc.SoTienMienGiam.GetValueOrDefault(),
                            DaThanhToan = yc.SoTienBenhNhanDaChi.GetValueOrDefault(),
                            TongCongNo = yc.SoTienBaoHiemTuNhanChiTra.GetValueOrDefault()
                        }).ToList(),
                        ChiPhiDuocPham = tn.YeuCauDuocPhamBenhViens.Where(o => o.TrangThai != Enums.EnumYeuCauDuocPhamBenhVien.DaHuy).Select(yc => new ChiPhiDichVuVo
                        {
                            Soluong = yc.SoLuong,
                            DonGia = yc.DonGiaBan,
                            KhongTinhPhi = yc.KhongTinhPhi,
                            DuocHuongBHYT = yc.DuocHuongBaoHiem,
                            DonGiaBHYT = yc.DonGiaBaoHiem.GetValueOrDefault(),
                            TiLeBaoHiemThanhToan = yc.TiLeBaoHiemThanhToan.GetValueOrDefault(),
                            MucHuongBaoHiem = yc.MucHuongBaoHiem.GetValueOrDefault(),
                            SoTienMG = yc.SoTienMienGiam.GetValueOrDefault(),
                            DaThanhToan = yc.SoTienBenhNhanDaChi.GetValueOrDefault(),
                            TongCongNo = yc.SoTienBaoHiemTuNhanChiTra.GetValueOrDefault()
                        }).ToList(),
                        ChiPhiVatTu = tn.YeuCauVatTuBenhViens.Where(o => o.TrangThai != Enums.EnumYeuCauVatTuBenhVien.DaHuy).Select(yc => new ChiPhiDichVuVo
                        {
                            Soluong = yc.SoLuong,
                            DonGia = yc.DonGiaBan,
                            KhongTinhPhi = yc.KhongTinhPhi,
                            DuocHuongBHYT = yc.DuocHuongBaoHiem,
                            DonGiaBHYT = yc.DonGiaBaoHiem.GetValueOrDefault(),
                            TiLeBaoHiemThanhToan = yc.TiLeBaoHiemThanhToan.GetValueOrDefault(),
                            MucHuongBaoHiem = yc.MucHuongBaoHiem.GetValueOrDefault(),
                            SoTienMG = yc.SoTienMienGiam.GetValueOrDefault(),
                            DaThanhToan = yc.SoTienBenhNhanDaChi.GetValueOrDefault(),
                            TongCongNo = yc.SoTienBaoHiemTuNhanChiTra.GetValueOrDefault()
                        }).ToList(),
                        ChiPhiToaThuoc = tn.DonThuocThanhToans.Where(o => o.LoaiDonThuoc == Enums.EnumLoaiDonThuoc.ThuocBHYT && o.TrangThai != Enums.TrangThaiDonThuocThanhToan.DaHuy).SelectMany(o => o.DonThuocThanhToanChiTiets).Select(yc => new ChiPhiDichVuVo
                        {
                            Soluong = yc.SoLuong,
                            DonGia = yc.DonGiaBan,
                            KhongTinhPhi = false,
                            DuocHuongBHYT = yc.DuocHuongBaoHiem,
                            DonGiaBHYT = yc.DonGiaBaoHiem.GetValueOrDefault(),
                            TiLeBaoHiemThanhToan = yc.TiLeBaoHiemThanhToan.GetValueOrDefault(),
                            MucHuongBaoHiem = yc.MucHuongBaoHiem.GetValueOrDefault(),
                            SoTienMG = yc.SoTienMienGiam.GetValueOrDefault(),
                            DaThanhToan = yc.SoTienBenhNhanDaChi.GetValueOrDefault(),
                            TongCongNo = yc.SoTienBaoHiemTuNhanChiTra.GetValueOrDefault()
                        }),
                        ChiPhiGoiDichVu = new ChiPhiDichVuVo[0]
                    }
                ).ToList();
                var danhSachThuTamUng = BaseRepository.TableNoTracking.Where(tn => yctnIds.Contains(tn.Id)).Select(tn =>
                    new
                    {
                        YeuCauTiepNhanId = tn.Id,
                        TienTamUng = tn.TaiKhoanBenhNhanThus.Where(o => o.LoaiThuTienBenhNhan == Enums.LoaiThuTienBenhNhan.ThuTamUng && o.ThuTienGoiDichVu != true && o.DaHuy != true && o.PhieuHoanUngId == null).Select(o => o.TienMat.GetValueOrDefault() + o.ChuyenKhoan.GetValueOrDefault() + o.POS.GetValueOrDefault()).DefaultIfEmpty().Sum()
                    }
                ).ToList();

                foreach (var danhSachBenhNhanChoThuNganGridVo in queryResult)
                {
                    danhSachBenhNhanChoThuNganGridVo.DanhSachChiPhiDichVu = danhSachChiPhiDichVus.FirstOrDefault(o => o.YeuCauTiepNhanId == danhSachBenhNhanChoThuNganGridVo.Id);
                    danhSachBenhNhanChoThuNganGridVo.SoTienTamUng = danhSachThuTamUng.FirstOrDefault(o => o.YeuCauTiepNhanId == danhSachBenhNhanChoThuNganGridVo.Id)?.TienTamUng ?? 0;
                    danhSachBenhNhanChoThuNganGridVo.YeuCauNhapVien = danhSachChiPhiDichVus.FirstOrDefault(o => o.YeuCauTiepNhanId == danhSachBenhNhanChoThuNganGridVo.Id)?.ChiPhiDichVuKhamBenh.Any(o => o.YeuCauNhapVien) ?? false;
                }
            }

            return new GridDataSource { Data = queryResult };

        }
        public async Task<GridDataSource> GetTotalPageDanhSachChuaThuNgoaiTruAsync(ThuNganQueryInfo queryInfo)
        {
            //chỉ trả về 1 trang
            return new GridDataSource { TotalRowCount = 20 };
            //var queryTheoDanhSach = BaseRepository.TableNoTracking.Where(o => o.QuyetToanTheoNoiTru != true && (o.LoaiYeuCauTiepNhan == Enums.EnumLoaiYeuCauTiepNhan.KhamChuaBenhNgoaiTru || o.LoaiYeuCauTiepNhan == Enums.EnumLoaiYeuCauTiepNhan.KhamSucKhoe)
            //                                                            && o.TrangThaiYeuCauTiepNhan == Enums.EnumTrangThaiYeuCauTiepNhan.DangThucHien
            //                                                                    && (o.YeuCauKhamBenhs.Any(k => k.GoiKhamSucKhoeId == null && k.TrangThai != Enums.EnumTrangThaiYeuCauKhamBenh.HuyKham && (k.TrangThaiThanhToan != Enums.TrangThaiThanhToan.DaThanhToan || k.YeuCauNhapViens.Any()))
            //                                                                        || o.YeuCauDichVuKyThuats.Any(k => k.GoiKhamSucKhoeId == null && k.TrangThai != Enums.EnumTrangThaiYeuCauDichVuKyThuat.DaHuy && k.TrangThaiThanhToan != Enums.TrangThaiThanhToan.DaThanhToan)
            //                                                                        || o.YeuCauDuocPhamBenhViens.Any(k => k.TrangThai != Enums.EnumYeuCauDuocPhamBenhVien.DaHuy && k.TrangThaiThanhToan != Enums.TrangThaiThanhToan.DaThanhToan)
            //                                                                        || o.YeuCauVatTuBenhViens.Any(k => k.TrangThai != Enums.EnumYeuCauVatTuBenhVien.DaHuy && k.TrangThaiThanhToan != Enums.TrangThaiThanhToan.DaThanhToan)
            //                                                                        || o.DonThuocThanhToans.Any(k => k.LoaiDonThuoc == Enums.EnumLoaiDonThuoc.ThuocBHYT && k.TrangThai != Enums.TrangThaiDonThuocThanhToan.DaHuy && k.TrangThaiThanhToan != Enums.TrangThaiThanhToan.DaThanhToan)));


            //var query = queryTheoDanhSach.Select(s => new DanhSachBenhNhanChoThuNganGridVo
            //{
            //    Id = s.Id,
            //    MaTN = s.MaYeuCauTiepNhan,
            //    HoTen = s.HoTen,
            //    DienThoaiStr = s.SoDienThoaiDisplay,
            //    DienThoai = s.SoDienThoai,
            //    GioiTinh = s.GioiTinh,
            //    MaBN = s.BenhNhan != null ? s.BenhNhan.MaBN : "",
            //    NamSinh = s.NamSinh,

            //    ThoiDiemTiepNhanDisplay = s.ThoiDiemTiepNhan.ApplyFormatDateTimeSACH(),
            //    ThoiDiemTiepNhan = s.ThoiDiemTiepNhan,
            //    DoiTuong = s.CoBHYT != true ? "Viện phí" : "BHYT (" + s.BHYTMucHuong.ToString() + "%)"
            //});
            //if (!string.IsNullOrEmpty(queryInfo.AdditionalSearchString))
            //{
            //    var queryString = JsonConvert.DeserializeObject<DanhSachBenhNhanChoThuNganGridVo>(queryInfo.AdditionalSearchString);

            //    if (!string.IsNullOrEmpty(queryString.FromDate) || !string.IsNullOrEmpty(queryString.ToDate))
            //    {
            //        DateTime denNgay;
            //        queryString.FromDate.TryParseExactCustom(out var tuNgay);
            //        //DateTime.TryParseExact(queryString.FromDate, "dd/MM/yyyy hh:mm tt", null, DateTimeStyles.None,
            //        //out var tuNgay);
            //        if (string.IsNullOrEmpty(queryString.ToDate))
            //        {
            //            denNgay = DateTime.Now;
            //        }
            //        else
            //        {
            //            queryString.ToDate.TryParseExactCustom(out denNgay);
            //            //DateTime.TryParseExact(queryString.ToDate, "dd/MM/yyyy hh:mm tt", null, DateTimeStyles.None, out denNgay);
            //        }
            //        denNgay = denNgay.AddSeconds(59).AddMilliseconds(999);
            //        query = query.Where(p => p.ThoiDiemTiepNhan >= tuNgay && p.ThoiDiemTiepNhan <= denNgay);
            //    }


            //    if (!string.IsNullOrEmpty(queryString.MaTN))
            //        query = query.Where(p => p.MaTN.Contains(queryString.MaTN.Trim()));
            //    if (!string.IsNullOrEmpty(queryString.MaBN))
            //        query = query.Where(p => p.MaBN.Contains(queryString.MaBN.Trim()));
            //    if (!string.IsNullOrEmpty(queryString.HoTen))
            //        query = query.Where(p => p.HoTen.Contains(queryString.HoTen.Trim()));
            //    if (queryString.NamSinh.GetValueOrDefault() != 0)
            //        query = query.Where(p => p.NamSinh == queryString.NamSinh);
            //    if (!string.IsNullOrEmpty(queryString.DienThoaiStr))
            //        query = query.Where(p => p.DienThoaiStr.Contains(queryString.DienThoaiStr.Trim()));
            //}
            //if (!string.IsNullOrEmpty(queryInfo.SearchTerms))
            //{
            //    query = query.ApplyLike(queryInfo.SearchTerms,
            //       g => g.MaBN,
            //       g => g.HoTen,
            //       g => g.DienThoai, g => g.DienThoaiStr,
            //       g => g.MaTN);
            //}

            //var totalRow = await query.CountAsync();
            //return new GridDataSource { TotalRowCount = totalRow };
        }

        public async Task<GridDataSource> GetDanhSachDaThuNgoaiTruAsync(ThuNganQueryInfo queryInfo, bool isAllData)
        {
            ReplaceDisplayValueSortExpression(queryInfo);
            var sreachString = JsonConvert.DeserializeObject<DanhSachBenhNhanChoThuNganGridVo>(queryInfo.AdditionalSearchString);

            //Build Default Sort
            if (queryInfo.Sort == null || queryInfo.Sort.Count == 0)
            {
                queryInfo.Sort = new List<Sort> { new Sort { Field = "Id", Dir = "asc" } };
            }

            //o.QuyetToanTheoNoiTru != true && note case lại vi muốn chuyên vô nội trú thì phần thu tiền ngoại trú vẫn xem dc
            var queryTheoDanhSach = BaseRepository.TableNoTracking.Where(o => (o.LoaiYeuCauTiepNhan == Enums.EnumLoaiYeuCauTiepNhan.KhamChuaBenhNgoaiTru || o.LoaiYeuCauTiepNhan == Enums.EnumLoaiYeuCauTiepNhan.KhamSucKhoe)
                                                                              && o.TaiKhoanBenhNhanThus.Any(k => k.LoaiNoiThu == Enums.LoaiNoiThu.ThuNgan && k.LoaiThuTienBenhNhan == Enums.LoaiThuTienBenhNhan.ThuTheoChiPhi && k.DaHuy != true));
            //&& (o.YeuCauKhamBenhs.Any(k => k.GoiKhamSucKhoeId == null && (k.TrangThai == Enums.EnumTrangThaiYeuCauKhamBenh.HuyKham || k.TrangThaiThanhToan == Enums.TrangThaiThanhToan.DaThanhToan))
            //|| o.YeuCauDichVuKyThuats.Any(k => k.GoiKhamSucKhoeId == null && (k.TrangThai == Enums.EnumTrangThaiYeuCauDichVuKyThuat.DaHuy || k.TrangThaiThanhToan == Enums.TrangThaiThanhToan.DaThanhToan))
            //|| o.YeuCauDuocPhamBenhViens.Any(k => (k.TrangThai == Enums.EnumYeuCauDuocPhamBenhVien.DaHuy || k.TrangThaiThanhToan == Enums.TrangThaiThanhToan.DaThanhToan))
            //|| o.YeuCauVatTuBenhViens.Any(k => (k.TrangThai == Enums.EnumYeuCauVatTuBenhVien.DaHuy || k.TrangThaiThanhToan == Enums.TrangThaiThanhToan.DaThanhToan))
            //|| o.DonThuocThanhToans.Any(k => k.LoaiDonThuoc != Enums.EnumLoaiDonThuoc.ThuocBHYT && k.TrangThai == Enums.TrangThaiDonThuocThanhToan.DaHuy || k.TrangThaiThanhToan == Enums.TrangThaiThanhToan.DaThanhToan)));


            var query = queryTheoDanhSach.Select(s => new DanhSachBenhNhanChoThuNganGridVo
            {
                Id = s.Id,
                MaTN = s.MaYeuCauTiepNhan,
                HoTen = s.HoTen,
                DienThoaiStr = s.SoDienThoaiDisplay,
                DienThoai = s.SoDienThoai,
                GioiTinh = s.GioiTinh,
                MaBN = s.BenhNhan != null ? s.BenhNhan.MaBN : "",
                NamSinh = s.NamSinh,
                ThoiDiemTiepNhanDisplay = s.ThoiDiemTiepNhan.ApplyFormatDateTimeSACH(),
                ThoiDiemTiepNhan = s.ThoiDiemTiepNhan,
                DoiTuong = s.CoBHYT != true ? "Viện phí" : "BHYT (" + s.BHYTMucHuong.ToString() + "%)"
            });

            if (!string.IsNullOrEmpty(queryInfo.AdditionalSearchString))
            {
                var queryString = JsonConvert.DeserializeObject<DanhSachBenhNhanChoThuNganGridVo>(queryInfo.AdditionalSearchString);
                if (!string.IsNullOrEmpty(queryString.FromDate) || !string.IsNullOrEmpty(queryString.ToDate))
                {
                    DateTime denNgay;
                    queryString.FromDate.TryParseExactCustom(out var tuNgay);
                    //DateTime.TryParseExact(queryString.FromDate, "dd/MM/yyyy hh:mm tt", null, DateTimeStyles.None,
                    //    out var tuNgay);
                    if (string.IsNullOrEmpty(queryString.ToDate))
                    {
                        denNgay = DateTime.Now;
                    }
                    else
                    {
                        queryString.ToDate.TryParseExactCustom(out denNgay);
                        //DateTime.TryParseExact(queryString.ToDate, "dd/MM/yyyy hh:mm tt", null, DateTimeStyles.None, out denNgay);
                    }
                    denNgay = denNgay.AddSeconds(59).AddMilliseconds(999);
                    query = query.Where(p => p.ThoiDiemTiepNhan >= tuNgay && p.ThoiDiemTiepNhan <= denNgay);
                }

                if (!string.IsNullOrEmpty(queryString.MaTN))
                    query = query.Where(p => p.MaTN.Contains(queryString.MaTN.Trim()));
                if (!string.IsNullOrEmpty(queryString.MaBN))
                    query = query.Where(p => p.MaBN.Contains(queryString.MaBN.Trim()));
                if (!string.IsNullOrEmpty(queryString.HoTen))
                    query = query.Where(p => p.HoTen.Contains(queryString.HoTen.Trim()));
                if (queryString.NamSinh.GetValueOrDefault() != 0)
                    query = query.Where(p => p.NamSinh == queryString.NamSinh);
                if (!string.IsNullOrEmpty(queryString.DienThoaiStr))
                    query = query.Where(p => p.DienThoaiStr.Contains(queryString.DienThoaiStr.Trim()));
            }
            if (!string.IsNullOrEmpty(sreachString.SearchString))
            {
                query = query.ApplyLike(sreachString.SearchString.Trim(),
                   g => g.MaBN,
                   g => g.HoTen,
                   g => g.DienThoai, g => g.DienThoaiStr,
                   g => g.MaTN);
            }

            var queryResult = isAllData == true ? query.OrderBy(queryInfo.SortString).ToArray()
                : query.OrderBy(queryInfo.SortString).Skip(queryInfo.Skip).Take(queryInfo.Take).ToArray();

            if (queryResult.Length > 0)
            {
                var yctnIds = queryResult.Select(o => o.Id).ToList();
                var danhSachChiPhiDichVus = BaseRepository.TableNoTracking.Where(tn => yctnIds.Contains(tn.Id)).Select(tn =>
                    new DanhSachChiPhiDichVuVo
                    {
                        YeuCauTiepNhanId = tn.Id,
                        ChiPhiDichVuKhamBenh = tn.YeuCauKhamBenhs.Where(o => o.GoiKhamSucKhoeId == null && o.TrangThai != Enums.EnumTrangThaiYeuCauKhamBenh.HuyKham).Select(yc => new ChiPhiDichVuVo
                        {
                            Soluong = 1,
                            DonGia = yc.YeuCauGoiDichVuId == null ? yc.Gia : yc.DonGiaSauChietKhau.GetValueOrDefault(),
                            KhongTinhPhi = yc.KhongTinhPhi,
                            DuocHuongBHYT = yc.DuocHuongBaoHiem,
                            DonGiaBHYT = yc.DonGiaBaoHiem.GetValueOrDefault(),
                            TiLeBaoHiemThanhToan = yc.TiLeBaoHiemThanhToan.GetValueOrDefault(),
                            MucHuongBaoHiem = yc.MucHuongBaoHiem.GetValueOrDefault(),
                            SoTienMG = yc.SoTienMienGiam.GetValueOrDefault(),
                            DaThanhToan = yc.SoTienBenhNhanDaChi.GetValueOrDefault(),
                            TongCongNo = yc.SoTienBaoHiemTuNhanChiTra.GetValueOrDefault()
                        }).ToList(),
                        ChiPhiDichVuKyThuat = tn.YeuCauDichVuKyThuats.Where(o => o.GoiKhamSucKhoeId == null && o.TrangThai != Enums.EnumTrangThaiYeuCauDichVuKyThuat.DaHuy).Select(yc => new ChiPhiDichVuVo
                        {
                            Soluong = yc.SoLan,
                            DonGia = yc.YeuCauGoiDichVuId == null ? yc.Gia : yc.DonGiaSauChietKhau.GetValueOrDefault(),
                            KhongTinhPhi = yc.KhongTinhPhi,
                            DuocHuongBHYT = yc.DuocHuongBaoHiem,
                            DonGiaBHYT = yc.DonGiaBaoHiem.GetValueOrDefault(),
                            TiLeBaoHiemThanhToan = yc.TiLeBaoHiemThanhToan.GetValueOrDefault(),
                            MucHuongBaoHiem = yc.MucHuongBaoHiem.GetValueOrDefault(),
                            SoTienMG = yc.SoTienMienGiam.GetValueOrDefault(),
                            DaThanhToan = yc.SoTienBenhNhanDaChi.GetValueOrDefault(),
                            TongCongNo = yc.SoTienBaoHiemTuNhanChiTra.GetValueOrDefault()
                        }).ToList(),
                        ChiPhiDuocPham = tn.YeuCauDuocPhamBenhViens.Where(o => o.TrangThai != Enums.EnumYeuCauDuocPhamBenhVien.DaHuy).Select(yc => new ChiPhiDichVuVo
                        {
                            Soluong = yc.SoLuong,
                            DonGia = yc.DonGiaBan,
                            KhongTinhPhi = yc.KhongTinhPhi,
                            DuocHuongBHYT = yc.DuocHuongBaoHiem,
                            DonGiaBHYT = yc.DonGiaBaoHiem.GetValueOrDefault(),
                            TiLeBaoHiemThanhToan = yc.TiLeBaoHiemThanhToan.GetValueOrDefault(),
                            MucHuongBaoHiem = yc.MucHuongBaoHiem.GetValueOrDefault(),
                            SoTienMG = yc.SoTienMienGiam.GetValueOrDefault(),
                            DaThanhToan = yc.SoTienBenhNhanDaChi.GetValueOrDefault(),
                            TongCongNo = yc.SoTienBaoHiemTuNhanChiTra.GetValueOrDefault()
                        }).ToList(),
                        ChiPhiVatTu = tn.YeuCauVatTuBenhViens.Where(o => o.TrangThai != Enums.EnumYeuCauVatTuBenhVien.DaHuy).Select(yc => new ChiPhiDichVuVo
                        {
                            Soluong = yc.SoLuong,
                            DonGia = yc.DonGiaBan,
                            KhongTinhPhi = yc.KhongTinhPhi,
                            DuocHuongBHYT = yc.DuocHuongBaoHiem,
                            DonGiaBHYT = yc.DonGiaBaoHiem.GetValueOrDefault(),
                            TiLeBaoHiemThanhToan = yc.TiLeBaoHiemThanhToan.GetValueOrDefault(),
                            MucHuongBaoHiem = yc.MucHuongBaoHiem.GetValueOrDefault(),
                            SoTienMG = yc.SoTienMienGiam.GetValueOrDefault(),
                            DaThanhToan = yc.SoTienBenhNhanDaChi.GetValueOrDefault(),
                            TongCongNo = yc.SoTienBaoHiemTuNhanChiTra.GetValueOrDefault()
                        }).ToList(),
                        ChiPhiToaThuoc = tn.DonThuocThanhToans.Where(o => o.LoaiDonThuoc == Enums.EnumLoaiDonThuoc.ThuocBHYT && o.TrangThai != Enums.TrangThaiDonThuocThanhToan.DaHuy).SelectMany(o => o.DonThuocThanhToanChiTiets).Select(yc => new ChiPhiDichVuVo
                        {
                            Soluong = yc.SoLuong,
                            DonGia = yc.DonGiaBan,
                            KhongTinhPhi = false,
                            DuocHuongBHYT = yc.DuocHuongBaoHiem,
                            DonGiaBHYT = yc.DonGiaBaoHiem.GetValueOrDefault(),
                            TiLeBaoHiemThanhToan = yc.TiLeBaoHiemThanhToan.GetValueOrDefault(),
                            MucHuongBaoHiem = yc.MucHuongBaoHiem.GetValueOrDefault(),
                            SoTienMG = yc.SoTienMienGiam.GetValueOrDefault(),
                            DaThanhToan = yc.SoTienBenhNhanDaChi.GetValueOrDefault(),
                            TongCongNo = yc.SoTienBaoHiemTuNhanChiTra.GetValueOrDefault()
                        }),
                        ChiPhiGoiDichVu = new ChiPhiDichVuVo[0]
                    }
                ).ToList();

                var danhSachThuTamUng = BaseRepository.TableNoTracking.Where(tn => yctnIds.Contains(tn.Id)).Select(tn =>
                   new
                   {
                       YeuCauTiepNhanId = tn.Id,
                       TienTamUng = tn.TaiKhoanBenhNhanThus.Where(o => o.LoaiThuTienBenhNhan == Enums.LoaiThuTienBenhNhan.ThuTamUng && o.ThuTienGoiDichVu != true && o.DaHuy != true)
                                .Select(o => o.TienMat.GetValueOrDefault() + o.ChuyenKhoan.GetValueOrDefault() + o.POS.GetValueOrDefault()).DefaultIfEmpty().Sum()
                   }
               ).ToList();

                foreach (var danhSachBenhNhanChoThuNganGridVo in queryResult)
                {
                    danhSachBenhNhanChoThuNganGridVo.DanhSachChiPhiDichVu = danhSachChiPhiDichVus.FirstOrDefault(o => o.YeuCauTiepNhanId == danhSachBenhNhanChoThuNganGridVo.Id);
                    danhSachBenhNhanChoThuNganGridVo.SoTienTamUng = danhSachThuTamUng.Where(o => o.YeuCauTiepNhanId == danhSachBenhNhanChoThuNganGridVo.Id).Select(c => c.TienTamUng).Sum();
                }
            }

            return new GridDataSource { Data = queryResult };

        }
        public async Task<GridDataSource> GetTotalPageDanhSachDaThuNgoaiTruAsync(ThuNganQueryInfo queryInfo)
        {
            var queryTheoDanhSach = BaseRepository.TableNoTracking.Where(o => (o.LoaiYeuCauTiepNhan == Enums.EnumLoaiYeuCauTiepNhan.KhamChuaBenhNgoaiTru || o.LoaiYeuCauTiepNhan == Enums.EnumLoaiYeuCauTiepNhan.KhamSucKhoe)
                                                                              && o.TaiKhoanBenhNhanThus.Any(k => k.LoaiNoiThu == Enums.LoaiNoiThu.ThuNgan && k.LoaiThuTienBenhNhan == Enums.LoaiThuTienBenhNhan.ThuTheoChiPhi && k.DaHuy != true));
            //&& (o.YeuCauKhamBenhs.Any(k => k.GoiKhamSucKhoeId == null && (k.TrangThai == Enums.EnumTrangThaiYeuCauKhamBenh.HuyKham || k.TrangThaiThanhToan == Enums.TrangThaiThanhToan.DaThanhToan))
            //   || o.YeuCauDichVuKyThuats.Any(k => k.GoiKhamSucKhoeId == null && (k.TrangThai == Enums.EnumTrangThaiYeuCauDichVuKyThuat.DaHuy || k.TrangThaiThanhToan == Enums.TrangThaiThanhToan.DaThanhToan))
            //   || o.YeuCauDuocPhamBenhViens.Any(k => (k.TrangThai == Enums.EnumYeuCauDuocPhamBenhVien.DaHuy || k.TrangThaiThanhToan == Enums.TrangThaiThanhToan.DaThanhToan))
            //   || o.YeuCauVatTuBenhViens.Any(k => (k.TrangThai == Enums.EnumYeuCauVatTuBenhVien.DaHuy || k.TrangThaiThanhToan == Enums.TrangThaiThanhToan.DaThanhToan))
            //   || o.DonThuocThanhToans.Any(k => k.LoaiDonThuoc != Enums.EnumLoaiDonThuoc.ThuocBHYT && k.TrangThai == Enums.TrangThaiDonThuocThanhToan.DaHuy || k.TrangThaiThanhToan == Enums.TrangThaiThanhToan.DaThanhToan)));


            var query = queryTheoDanhSach.Select(s => new DanhSachBenhNhanChoThuNganGridVo
            {
                Id = s.Id,
                MaTN = s.MaYeuCauTiepNhan,
                HoTen = s.HoTen,
                DienThoaiStr = s.SoDienThoaiDisplay,
                DienThoai = s.SoDienThoai,
                GioiTinh = s.GioiTinh,
                MaBN = s.BenhNhan != null ? s.BenhNhan.MaBN : "",
                NamSinh = s.NamSinh,
                ThoiDiemTiepNhanDisplay = s.ThoiDiemTiepNhan.ApplyFormatDateTimeSACH(),
                ThoiDiemTiepNhan = s.ThoiDiemTiepNhan,
                DoiTuong = s.CoBHYT != true ? "Viện phí" : "BHYT (" + s.BHYTMucHuong.ToString() + "%)"
            });
            if (!string.IsNullOrEmpty(queryInfo.AdditionalSearchString))
            {
                var queryString = JsonConvert.DeserializeObject<DanhSachBenhNhanChoThuNganGridVo>(queryInfo.AdditionalSearchString);

                if (!string.IsNullOrEmpty(queryString.FromDate) || !string.IsNullOrEmpty(queryString.ToDate))
                {
                    DateTime denNgay;
                    queryString.FromDate.TryParseExactCustom(out var tuNgay);
                    //DateTime.TryParseExact(queryString.FromDate, "dd/MM/yyyy hh:mm tt", null, DateTimeStyles.None,
                    //    out var tuNgay);
                    if (string.IsNullOrEmpty(queryString.ToDate))
                    {
                        denNgay = DateTime.Now;
                    }
                    else
                    {
                        queryString.ToDate.TryParseExactCustom(out denNgay);
                        //DateTime.TryParseExact(queryString.ToDate, "dd/MM/yyyy hh:mm tt", null, DateTimeStyles.None, out denNgay);
                    }
                    denNgay = denNgay.AddSeconds(59).AddMilliseconds(999);
                    query = query.Where(p => p.ThoiDiemTiepNhan >= tuNgay && p.ThoiDiemTiepNhan <= denNgay);
                }


                if (!string.IsNullOrEmpty(queryString.MaTN))
                    query = query.Where(p => p.MaTN.Contains(queryString.MaTN.Trim()));
                if (!string.IsNullOrEmpty(queryString.MaBN))
                    query = query.Where(p => p.MaBN.Contains(queryString.MaBN.Trim()));
                if (!string.IsNullOrEmpty(queryString.HoTen))
                    query = query.Where(p => p.HoTen.Contains(queryString.HoTen.Trim()));
                if (queryString.NamSinh.GetValueOrDefault() != 0)
                    query = query.Where(p => p.NamSinh == queryString.NamSinh);
                if (!string.IsNullOrEmpty(queryString.DienThoaiStr))
                    query = query.Where(p => p.DienThoaiStr.Contains(queryString.DienThoaiStr.Trim()));
            }
            if (!string.IsNullOrEmpty(queryInfo.SearchTerms))
            {
                query = query.ApplyLike(queryInfo.SearchTerms,
                   g => g.MaBN,
                   g => g.HoTen,
                   g => g.DienThoai, g => g.DienThoaiStr,
                   g => g.MaTN);
            }

            var totalRow = query.Count();
            return new GridDataSource { TotalRowCount = totalRow };
        }

        public List<ChiPhiKhamChuaBenhVo> GetDanhSachChiPhiKhamChuaBenhChuaThu(long yeuCauTiepNhanId)
        {
            var queryDichVuKhamBenh = BaseRepository.TableNoTracking.Where(o => o.Id == yeuCauTiepNhanId)
                .SelectMany(o => o.YeuCauKhamBenhs).Include(cc => cc.CongTyBaoHiemTuNhanCongNos).Include(cc => cc.MienGiamChiPhis).Include(cc => cc.NoiDangKy).Include(cc => cc.BacSiDangKy).ThenInclude(cc => cc.User)
                .Where(yc => yc.YeuCauGoiDichVuId == null && yc.GoiKhamSucKhoeId == null && yc.TrangThai != Enums.EnumTrangThaiYeuCauKhamBenh.HuyKham &&
                             (yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                              yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                .Select(s => new ChiPhiKhamChuaBenhVo
                {
                    Id = s.Id,
                    DichVuBenhVienId = s.DichVuKhamBenhBenhVienId,
                    LoaiNhom = NhomChiPhiKhamChuaBenh.DichVuKhamBenh,
                    Ma = s.DichVuKhamBenhBenhVien.Ma,
                    Nhom = NhomChiPhiKhamChuaBenh.DichVuKhamBenh.GetDescription(),
                    TenDichVu = s.DichVuKhamBenhBenhVien.Ten,
                    LoaiGia = s.NhomGiaDichVuKhamBenhBenhVien.Ten,
                    LoaiGiaId = s.NhomGiaDichVuKhamBenhBenhVienId,
                    Soluong = 1,
                    DonGia = s.Gia,
                    KhongTinhPhi = s.KhongTinhPhi,
                    KiemTraBHYTXacNhan = s.BaoHiemChiTra != null,
                    DuocHuongBHYT = s.DuocHuongBaoHiem,
                    DonGiaBHYT = s.DonGiaBaoHiem.GetValueOrDefault(),
                    TiLeBaoHiemThanhToan = s.TiLeBaoHiemThanhToan.GetValueOrDefault(),
                    MucHuongBaoHiem = s.MucHuongBaoHiem.GetValueOrDefault(),
                    DanhSachCongNoChoThus = s.CongTyBaoHiemTuNhanCongNos.Count == 0 ? new List<DanhSachCongNoVo>() : s.CongTyBaoHiemTuNhanCongNos.Where(o => o.TaiKhoanBenhNhanThuId == null).Select(o => new DanhSachCongNoVo { CongTyBaoHiemTuNhanId = o.CongTyBaoHiemTuNhanId, SoTienCongNoChoThu = o.SoTien }),
                    DanhSachMienGiamVos = s.MienGiamChiPhis.Count == 0 ? new List<DanhSachMienGiamVo>() : s.MienGiamChiPhis.Where(o => o.TaiKhoanBenhNhanThuId == null).GroupBy(o => new { o.LoaiMienGiam, o.NoiGioiThieuId, o.YeuCauGoiDichVuId, o.TheVoucherId, o.MaTheVoucher, o.DoiTuongUuDaiId, o.LoaiChietKhau }, o => o,
                        (k, v) => new DanhSachMienGiamVo
                        {
                            LoaiMienGiam = k.LoaiMienGiam,
                            NoiGioiThieuId = k.NoiGioiThieuId,
                            YeuCauGoiDichVuId = k.YeuCauGoiDichVuId,
                            LoaiChietKhau = k.LoaiChietKhau,
                            TheVoucherId = k.TheVoucherId,
                            MaTheVoucher = k.MaTheVoucher,
                            DoiTuongUuDaiId = k.DoiTuongUuDaiId,
                            TiLe = v.Select(o => o.TiLe).DefaultIfEmpty().Sum(),
                            SoTien = v.Select(o => o.SoTien).DefaultIfEmpty().Sum()
                        }).Where(o => o.SoTien != 0),

                    GhiChuMienGiamThem = s.GhiChuMienGiamThem,
                    NoiDungGhiChuMiemGiamId = s.NoiDungGhiChuMiemGiamId,

                    CapNhatThanhToan = s.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan,
                    TrangThaiThanhToan = s.TrangThaiThanhToan,
                    DaThanhToan = s.SoTienBenhNhanDaChi.GetValueOrDefault(),
                    NoiThucHien = (s.NoiDangKy != null ? $"{s.NoiDangKy.Ma}" : "") + (s.BacSiDangKy != null && s.BacSiDangKy.User.HoTen != null ? " - " + $"{s.BacSiDangKy.User.HoTen}" : ""),
                    CheckedDefault = true,
                    ThoiDiemChiDinh = s.ThoiDiemChiDinh,
                }).OrderBy(o => o.Id).ToList();

            var queryDichVuKyThuat = BaseRepository.TableNoTracking.Where(o => o.Id == yeuCauTiepNhanId)
                .SelectMany(o => o.YeuCauDichVuKyThuats).Include(cc => cc.CongTyBaoHiemTuNhanCongNos).Include(cc => cc.MienGiamChiPhis)
                .Where(yc => yc.YeuCauGoiDichVuId == null && yc.GoiKhamSucKhoeId == null && yc.TrangThai != Enums.EnumTrangThaiYeuCauDichVuKyThuat.DaHuy &&
                             (yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                              yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                .Select(s => new ChiPhiKhamChuaBenhVo
                {
                    Id = s.Id,
                    DichVuBenhVienId = s.DichVuKyThuatBenhVienId,
                    LoaiNhom = NhomChiPhiKhamChuaBenh.DichVuKyThuat,
                    Ma = s.DichVuKyThuatBenhVien.Ma,
                    Nhom = NhomChiPhiKhamChuaBenh.DichVuKyThuat.GetDescription(),
                    TenDichVu = s.DichVuKyThuatBenhVien.Ten,
                    LoaiGia = s.NhomGiaDichVuKyThuatBenhVien.Ten,
                    LoaiGiaId = s.NhomGiaDichVuKyThuatBenhVienId,
                    Soluong = s.SoLan,
                    DonGia = s.Gia,
                    KhongTinhPhi = s.KhongTinhPhi,
                    KiemTraBHYTXacNhan = s.BaoHiemChiTra != null,
                    DuocHuongBHYT = s.DuocHuongBaoHiem,
                    DonGiaBHYT = s.DonGiaBaoHiem.GetValueOrDefault(),
                    TiLeBaoHiemThanhToan = s.TiLeBaoHiemThanhToan.GetValueOrDefault(),
                    MucHuongBaoHiem = s.MucHuongBaoHiem.GetValueOrDefault(),
                    DanhSachCongNoChoThus = s.CongTyBaoHiemTuNhanCongNos.Count == 0 ? new List<DanhSachCongNoVo>() : s.CongTyBaoHiemTuNhanCongNos.Where(o => o.TaiKhoanBenhNhanThuId == null).Select(o => new DanhSachCongNoVo { CongTyBaoHiemTuNhanId = o.CongTyBaoHiemTuNhanId, SoTienCongNoChoThu = o.SoTien }),
                    DanhSachMienGiamVos = s.MienGiamChiPhis.Count == 0 ? new List<DanhSachMienGiamVo>() : s.MienGiamChiPhis.Where(o => o.TaiKhoanBenhNhanThuId == null).GroupBy(o => new { o.LoaiMienGiam, o.NoiGioiThieuId, o.YeuCauGoiDichVuId, o.TheVoucherId, o.MaTheVoucher, o.DoiTuongUuDaiId, o.LoaiChietKhau }, o => o,
                        (k, v) => new DanhSachMienGiamVo
                        {
                            LoaiMienGiam = k.LoaiMienGiam,
                            NoiGioiThieuId = k.NoiGioiThieuId,
                            YeuCauGoiDichVuId = k.YeuCauGoiDichVuId,
                            LoaiChietKhau = k.LoaiChietKhau,
                            TheVoucherId = k.TheVoucherId,
                            MaTheVoucher = k.MaTheVoucher,
                            DoiTuongUuDaiId = k.DoiTuongUuDaiId,
                            TiLe = v.Select(o => o.TiLe).DefaultIfEmpty().Sum(),
                            SoTien = v.Select(o => o.SoTien).DefaultIfEmpty().Sum()
                        }).Where(o => o.SoTien != 0),
                    GhiChuMienGiamThem = s.GhiChuMienGiamThem,
                    NoiDungGhiChuMiemGiamId = s.NoiDungGhiChuMiemGiamId,
                    CapNhatThanhToan = s.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan,
                    TrangThaiThanhToan = s.TrangThaiThanhToan,
                    DaThanhToan = s.SoTienBenhNhanDaChi.GetValueOrDefault(),
                    NoiThucHien = s.NoiThucHien != null
                        ? $"{s.NoiThucHien.Ma} - {s.NoiThucHien.Ten}"
                        : string.Empty,
                    CheckedDefault = true,
                    ThoiDiemChiDinh = s.ThoiDiemChiDinh,
                }).ToList();

            var queryDuocPham = BaseRepository.TableNoTracking.Where(o => o.Id == yeuCauTiepNhanId)
                .SelectMany(o => o.YeuCauDuocPhamBenhViens).Include(cc => cc.CongTyBaoHiemTuNhanCongNos).Include(cc => cc.MienGiamChiPhis)
                .Where(yc => yc.YeuCauGoiDichVuId == null && yc.TrangThai != Enums.EnumYeuCauDuocPhamBenhVien.DaHuy &&
                             (yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                              yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                .Select(s => new ChiPhiKhamChuaBenhVo
                {
                    Id = s.Id,
                    DichVuBenhVienId = s.DuocPhamBenhVienId,
                    LoaiNhom = NhomChiPhiKhamChuaBenh.DuocPham,
                    Nhom = NhomChiPhiKhamChuaBenh.DuocPham.GetDescription(),
                    Ma = s.DuocPhamBenhVien.Ma,
                    TenDichVu = s.DuocPhamBenhVien.DuocPham.Ten,
                    LoaiGia = string.Empty,
                    Soluong = s.SoLuong,
                    DonGia = s.DonGiaBan,
                    KhongTinhPhi = s.KhongTinhPhi,
                    KiemTraBHYTXacNhan = s.BaoHiemChiTra != null,
                    DuocHuongBHYT = s.DuocHuongBaoHiem,
                    DonGiaBHYT = s.DonGiaBaoHiem.GetValueOrDefault(),
                    TiLeBaoHiemThanhToan = s.TiLeBaoHiemThanhToan.GetValueOrDefault(),
                    MucHuongBaoHiem = s.MucHuongBaoHiem.GetValueOrDefault(),
                    DanhSachCongNoChoThus = s.CongTyBaoHiemTuNhanCongNos.Count == 0 ? new List<DanhSachCongNoVo>() : s.CongTyBaoHiemTuNhanCongNos.Where(o => o.TaiKhoanBenhNhanThuId == null).Select(o => new DanhSachCongNoVo { CongTyBaoHiemTuNhanId = o.CongTyBaoHiemTuNhanId, SoTienCongNoChoThu = o.SoTien }),
                    DanhSachMienGiamVos = s.MienGiamChiPhis.Count == 0 ? new List<DanhSachMienGiamVo>() : s.MienGiamChiPhis.Where(o => o.TaiKhoanBenhNhanThuId == null).GroupBy(o => new { o.LoaiMienGiam, o.NoiGioiThieuId, o.TheVoucherId, o.MaTheVoucher, o.DoiTuongUuDaiId, o.LoaiChietKhau }, o => o,
                        (k, v) => new DanhSachMienGiamVo
                        {
                            LoaiMienGiam = k.LoaiMienGiam,
                            NoiGioiThieuId = k.NoiGioiThieuId,
                            LoaiChietKhau = k.LoaiChietKhau,
                            TheVoucherId = k.TheVoucherId,
                            MaTheVoucher = k.MaTheVoucher,
                            DoiTuongUuDaiId = k.DoiTuongUuDaiId,
                            TiLe = v.Select(o => o.TiLe).DefaultIfEmpty().Sum(),
                            SoTien = v.Select(o => o.SoTien).DefaultIfEmpty().Sum()
                        }).Where(o => o.SoTien != 0),
                    GhiChuMienGiamThem = s.GhiChuMienGiamThem,
                    NoiDungGhiChuMiemGiamId = s.NoiDungGhiChuMiemGiamId,
                    CapNhatThanhToan = s.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan,
                    TrangThaiThanhToan = s.TrangThaiThanhToan,
                    DaThanhToan = s.SoTienBenhNhanDaChi.GetValueOrDefault(),
                    NoiThucHien = string.Empty,
                    CheckedDefault = true,
                    ThoiDiemChiDinh = s.ThoiDiemChiDinh,
                }).ToList();

            var queryVatTu = BaseRepository.TableNoTracking.Where(o => o.Id == yeuCauTiepNhanId)
                .SelectMany(o => o.YeuCauVatTuBenhViens).Include(cc => cc.CongTyBaoHiemTuNhanCongNos).Include(cc => cc.MienGiamChiPhis)
                .Where(yc => yc.YeuCauGoiDichVuId == null && yc.TrangThai != Enums.EnumYeuCauVatTuBenhVien.DaHuy &&
                             (yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                              yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                .Select(s => new ChiPhiKhamChuaBenhVo
                {
                    Id = s.Id,
                    DichVuBenhVienId = s.VatTuBenhVienId,
                    LoaiNhom = NhomChiPhiKhamChuaBenh.VatTuTieuHao,
                    Nhom = NhomChiPhiKhamChuaBenh.VatTuTieuHao.GetDescription(),
                    Ma = s.VatTuBenhVien.Ma,
                    TenDichVu = s.VatTuBenhVien.VatTus.Ten,
                    LoaiGia = string.Empty,
                    Soluong = s.SoLuong,
                    DonGia = s.DonGiaBan,
                    KhongTinhPhi = s.KhongTinhPhi,
                    KiemTraBHYTXacNhan = s.BaoHiemChiTra != null,
                    DuocHuongBHYT = s.DuocHuongBaoHiem,
                    DonGiaBHYT = s.DonGiaBaoHiem.GetValueOrDefault(),
                    TiLeBaoHiemThanhToan = s.TiLeBaoHiemThanhToan.GetValueOrDefault(),
                    MucHuongBaoHiem = s.MucHuongBaoHiem.GetValueOrDefault(),
                    DanhSachCongNoChoThus = s.CongTyBaoHiemTuNhanCongNos.Count == 0 ? new List<DanhSachCongNoVo>() : s.CongTyBaoHiemTuNhanCongNos.Where(o => o.TaiKhoanBenhNhanThuId == null).Select(o => new DanhSachCongNoVo { CongTyBaoHiemTuNhanId = o.CongTyBaoHiemTuNhanId, SoTienCongNoChoThu = o.SoTien }),
                    DanhSachMienGiamVos = s.MienGiamChiPhis.Count == 0 ? new List<DanhSachMienGiamVo>() : s.MienGiamChiPhis.Where(o => o.TaiKhoanBenhNhanThuId == null).GroupBy(o => new { o.LoaiMienGiam, o.NoiGioiThieuId, o.TheVoucherId, o.MaTheVoucher, o.DoiTuongUuDaiId, o.LoaiChietKhau }, o => o,
                        (k, v) => new DanhSachMienGiamVo
                        {
                            LoaiMienGiam = k.LoaiMienGiam,
                            NoiGioiThieuId = k.NoiGioiThieuId,
                            LoaiChietKhau = k.LoaiChietKhau,
                            TheVoucherId = k.TheVoucherId,
                            MaTheVoucher = k.MaTheVoucher,
                            DoiTuongUuDaiId = k.DoiTuongUuDaiId,
                            TiLe = v.Select(o => o.TiLe).DefaultIfEmpty().Sum(),
                            SoTien = v.Select(o => o.SoTien).DefaultIfEmpty().Sum()
                        }).Where(o => o.SoTien != 0),
                    GhiChuMienGiamThem = s.GhiChuMienGiamThem,
                    NoiDungGhiChuMiemGiamId = s.NoiDungGhiChuMiemGiamId,
                    CapNhatThanhToan = s.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan,
                    TrangThaiThanhToan = s.TrangThaiThanhToan,
                    DaThanhToan = s.SoTienBenhNhanDaChi.GetValueOrDefault(),
                    NoiThucHien = string.Empty,
                    CheckedDefault = true,
                    ThoiDiemChiDinh = s.ThoiDiemChiDinh,
                }).ToList();

            var queryToaThuoc = BaseRepository.TableNoTracking.Where(o => o.Id == yeuCauTiepNhanId)
                .SelectMany(o => o.DonThuocThanhToans)
                .Where(dt =>
                    dt.LoaiDonThuoc == Enums.EnumLoaiDonThuoc.ThuocBHYT && dt.TrangThai != Enums.TrangThaiDonThuocThanhToan.DaHuy &&
                    (dt.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || dt.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                     dt.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                .SelectMany(o => o.DonThuocThanhToanChiTiets).Include(cc => cc.CongTyBaoHiemTuNhanCongNos).Include(cc => cc.MienGiamChiPhis)
                .Select(s => new ChiPhiKhamChuaBenhVo
                {
                    Id = s.Id,
                    DichVuBenhVienId = s.DuocPhamId,
                    LoaiNhom = NhomChiPhiKhamChuaBenh.ToaThuoc,
                    Nhom = $"{NhomChiPhiKhamChuaBenh.ToaThuoc.GetDescription()}: {s.DonThuocThanhToan.YeuCauKhamBenhDonThuoc.YeuCauKhamBenh.TenDichVu}",
                    Ma = string.Empty,
                    TenDichVu = s.Ten,
                    LoaiGia = string.Empty,
                    Soluong = s.SoLuong,
                    DonGia = s.DonGiaBan,
                    KiemTraBHYTXacNhan = s.BaoHiemChiTra != null,
                    DuocHuongBHYT = s.DuocHuongBaoHiem,
                    DonGiaBHYT = s.DonGiaBaoHiem.GetValueOrDefault(),
                    TiLeBaoHiemThanhToan = s.TiLeBaoHiemThanhToan.GetValueOrDefault(),
                    MucHuongBaoHiem = s.MucHuongBaoHiem.GetValueOrDefault(),
                    DanhSachCongNoChoThus = s.CongTyBaoHiemTuNhanCongNos.Count == 0 ? new List<DanhSachCongNoVo>() : s.CongTyBaoHiemTuNhanCongNos.Where(o => o.TaiKhoanBenhNhanThuId == null).Select(o => new DanhSachCongNoVo { CongTyBaoHiemTuNhanId = o.CongTyBaoHiemTuNhanId, SoTienCongNoChoThu = o.SoTien }),
                    DanhSachMienGiamVos = s.MienGiamChiPhis.Count == 0 ? new List<DanhSachMienGiamVo>() : s.MienGiamChiPhis.Where(o => o.TaiKhoanBenhNhanThuId == null).GroupBy(o => new { o.LoaiMienGiam, o.NoiGioiThieuId, o.TheVoucherId, o.MaTheVoucher, o.DoiTuongUuDaiId, o.LoaiChietKhau }, o => o,
                        (k, v) => new DanhSachMienGiamVo
                        {
                            LoaiMienGiam = k.LoaiMienGiam,
                            NoiGioiThieuId = k.NoiGioiThieuId,
                            LoaiChietKhau = k.LoaiChietKhau,
                            TheVoucherId = k.TheVoucherId,
                            MaTheVoucher = k.MaTheVoucher,
                            DoiTuongUuDaiId = k.DoiTuongUuDaiId,
                            TiLe = v.Select(o => o.TiLe).DefaultIfEmpty().Sum(),
                            SoTien = v.Select(o => o.SoTien).DefaultIfEmpty().Sum()
                        }).Where(o => o.SoTien != 0),
                    GhiChuMienGiamThem = s.GhiChuMienGiamThem,
                    NoiDungGhiChuMiemGiamId = s.NoiDungGhiChuMiemGiamId,
                    CapNhatThanhToan = s.DonThuocThanhToan.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan,
                    TrangThaiThanhToan = s.DonThuocThanhToan.TrangThaiThanhToan,
                    DaThanhToan = s.SoTienBenhNhanDaChi.GetValueOrDefault(),
                    NoiThucHien = string.Empty,
                    CheckedDefault = true,
                    ThoiDiemChiDinh = s.DonThuocThanhToan.CreatedOn.Value,
                }).ToList();

            //Task.WhenAll(queryDichVuKhamBenh, queryDichVuKyThuat, queryDuocPham, queryVatTu, queryToaThuoc);
            var result = new List<ChiPhiKhamChuaBenhVo>();
            result.AddRange(queryDichVuKhamBenh);
            result.AddRange(queryDichVuKyThuat);
            result.AddRange(queryDuocPham);
            result.AddRange(queryVatTu);
            result.AddRange(queryToaThuoc);
            foreach (var chiPhiKhamChuaBenhVo in result)
            {
                if (chiPhiKhamChuaBenhVo.CapNhatThanhToan)
                {
                    if (chiPhiKhamChuaBenhVo.TongCongNo > chiPhiKhamChuaBenhVo.ThanhTien - chiPhiKhamChuaBenhVo.BHYTThanhToan)
                    {
                        var maxCongNo = chiPhiKhamChuaBenhVo.ThanhTien - chiPhiKhamChuaBenhVo.BHYTThanhToan;
                        foreach (var danhSachCongNoChoThu in chiPhiKhamChuaBenhVo.DanhSachCongNoChoThus)
                        {
                            if (chiPhiKhamChuaBenhVo.TongCongNo > maxCongNo)
                            {
                                var giam = chiPhiKhamChuaBenhVo.TongCongNo - maxCongNo;
                                danhSachCongNoChoThu.SoTienCongNoChoThu = giam > danhSachCongNoChoThu.SoTienCongNoChoThu ? 0 : danhSachCongNoChoThu.SoTienCongNoChoThu - giam;
                            }
                        }
                    }
                }
            }
            //set mien giam
            var yeuCauTiepNhan = BaseRepository.GetById(yeuCauTiepNhanId,
                x => x.Include(o => o.CongTyUuDai)
                    .Include(o => o.YeuCauKhamBenhs)
                    .Include(o => o.YeuCauDichVuKyThuats)
                    .Include(o => o.DoiTuongUuDai).ThenInclude(ud => ud.DoiTuongUuDaiDichVuKhamBenhBenhViens)
                    .Include(o => o.DoiTuongUuDai).ThenInclude(ud => ud.DoiTuongUuDaiDichVuKyThuatBenhViens)
                    .Include(o => o.GiayMienGiamThem)
                    .Include(o => o.NhanVienDuyetMienGiamThem).ThenInclude(v => v.User)
                    .Include(o => o.TheVoucherYeuCauTiepNhans).ThenInclude(v => v.TheVoucher).ThenInclude(v => v.Voucher).ThenInclude(v => v.VoucherChiTietMienGiams));

            var noiGioiThieus = _noiGioiThieuRepository.TableNoTracking.ToList();

            foreach (var chiPhiKhamChuaBenhVo in result)
            {

                var danhSachMienGiamVos = chiPhiKhamChuaBenhVo.DanhSachMienGiamVos.ToList();
                if (chiPhiKhamChuaBenhVo.CapNhatThanhToan)
                {
                    //remove DoiTuongUuDai
                    foreach (var danhSachMienGiamVo in danhSachMienGiamVos.Where(o => o.DoiTuongUuDaiId != null))
                    {
                        if (danhSachMienGiamVo.DoiTuongUuDaiId != yeuCauTiepNhan.DoiTuongUuDaiId)
                        {
                            danhSachMienGiamVos.Remove(danhSachMienGiamVo);
                        }
                        else
                        {
                            danhSachMienGiamVo.DoiTuongUuDai = yeuCauTiepNhan.DoiTuongUuDai.Ten;

                            if (chiPhiKhamChuaBenhVo.LoaiNhom == NhomChiPhiKhamChuaBenh.DichVuKhamBenh)
                            {
                                var uuDai = yeuCauTiepNhan.DoiTuongUuDai.DoiTuongUuDaiDichVuKhamBenhBenhViens.FirstOrDefault(o => o.DichVuKhamBenhBenhVienId == chiPhiKhamChuaBenhVo.DichVuBenhVienId);
                                if (uuDai != null)
                                {
                                    danhSachMienGiamVo.TiLe = uuDai.TiLeUuDai;
                                }
                                else
                                {
                                    danhSachMienGiamVos.Remove(danhSachMienGiamVo);
                                }
                            }
                            else if (chiPhiKhamChuaBenhVo.LoaiNhom == NhomChiPhiKhamChuaBenh.DichVuKyThuat)
                            {
                                var uuDai = yeuCauTiepNhan.DoiTuongUuDai.DoiTuongUuDaiDichVuKyThuatBenhViens.FirstOrDefault(o => o.DichVuKyThuatBenhVienId == chiPhiKhamChuaBenhVo.DichVuBenhVienId);
                                if (uuDai != null)
                                {
                                    danhSachMienGiamVo.TiLe = uuDai.TiLeUuDai;
                                }
                                else
                                {
                                    danhSachMienGiamVos.Remove(danhSachMienGiamVo);
                                }
                            }
                        }
                    }
                    //remove TheVoucher
                    foreach (var danhSachMienGiamVo in danhSachMienGiamVos.Where(o => o.TheVoucherId != null))
                    {
                        if (!yeuCauTiepNhan.TheVoucherYeuCauTiepNhans.Select(o => o.TheVoucherId).Contains(danhSachMienGiamVo.TheVoucherId.GetValueOrDefault()))
                        {
                            danhSachMienGiamVos.Remove(danhSachMienGiamVo);
                        }
                    }
                }
                //add DoiTuongUuDai
                if (yeuCauTiepNhan.DoiTuongUuDaiId != null && danhSachMienGiamVos.All(o => o.DoiTuongUuDaiId != yeuCauTiepNhan.DoiTuongUuDaiId))
                {
                    if (chiPhiKhamChuaBenhVo.LoaiNhom == NhomChiPhiKhamChuaBenh.DichVuKhamBenh)
                    {
                        var uuDai = yeuCauTiepNhan.DoiTuongUuDai.DoiTuongUuDaiDichVuKhamBenhBenhViens.FirstOrDefault(o => o.DichVuKhamBenhBenhVienId == chiPhiKhamChuaBenhVo.DichVuBenhVienId);
                        if (uuDai != null)
                        {
                            danhSachMienGiamVos.Add(new DanhSachMienGiamVo
                            {
                                LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                                DoiTuongUuDaiId = yeuCauTiepNhan.DoiTuongUuDaiId,
                                DoiTuongUuDai = yeuCauTiepNhan.DoiTuongUuDai.Ten,
                                LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                                TiLe = uuDai.TiLeUuDai
                            });
                        }
                    }
                    else if (chiPhiKhamChuaBenhVo.LoaiNhom == NhomChiPhiKhamChuaBenh.DichVuKyThuat)
                    {
                        var uuDai = yeuCauTiepNhan.DoiTuongUuDai.DoiTuongUuDaiDichVuKyThuatBenhViens.FirstOrDefault(o => o.DichVuKyThuatBenhVienId == chiPhiKhamChuaBenhVo.DichVuBenhVienId);
                        if (uuDai != null)
                        {
                            danhSachMienGiamVos.Add(new DanhSachMienGiamVo
                            {
                                LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                                DoiTuongUuDaiId = yeuCauTiepNhan.DoiTuongUuDaiId,
                                DoiTuongUuDai = yeuCauTiepNhan.DoiTuongUuDai.Ten,
                                LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                                TiLe = uuDai.TiLeUuDai
                            });
                        }
                    }
                }
                //add TheVoucher
                foreach (var theVoucherYeuCauTiepNhan in yeuCauTiepNhan.TheVoucherYeuCauTiepNhans)
                {
                    if (danhSachMienGiamVos.All(o => o.TheVoucherId != theVoucherYeuCauTiepNhan.TheVoucherId))
                    {
                        var voucher = theVoucherYeuCauTiepNhan.TheVoucher.Voucher;
                        if (chiPhiKhamChuaBenhVo.LoaiNhom == NhomChiPhiKhamChuaBenh.DichVuKhamBenh)
                        {
                            if (voucher.ChietKhauTatCaDichVu == true)
                            {
                                danhSachMienGiamVos.Add(new DanhSachMienGiamVo
                                {
                                    LoaiMienGiam = Enums.LoaiMienGiam.Voucher,
                                    TheVoucherId = theVoucherYeuCauTiepNhan.TheVoucherId,
                                    MaTheVoucher = theVoucherYeuCauTiepNhan.TheVoucher.Ma,
                                    LoaiChietKhau = voucher.LoaiChietKhau.Value,
                                    TiLe = voucher.TiLeChietKhau,
                                    SoTien = voucher.SoTienChietKhau.GetValueOrDefault()
                                });
                            }
                            else
                            {
                                var ycKhamBenh = yeuCauTiepNhan.YeuCauKhamBenhs.First(o => o.Id == chiPhiKhamChuaBenhVo.Id);
                                var voucherKhamBenh = voucher.VoucherChiTietMienGiams.FirstOrDefault(o => o.NhomDichVuKhamBenh == true || (o.DichVuKhamBenhBenhVienId == ycKhamBenh.DichVuKhamBenhBenhVienId && o.NhomGiaDichVuKhamBenhBenhVienId == ycKhamBenh.NhomGiaDichVuKhamBenhBenhVienId));
                                if (voucherKhamBenh != null)
                                {
                                    danhSachMienGiamVos.Add(new DanhSachMienGiamVo
                                    {
                                        LoaiMienGiam = Enums.LoaiMienGiam.Voucher,
                                        TheVoucherId = theVoucherYeuCauTiepNhan.TheVoucherId,
                                        MaTheVoucher = theVoucherYeuCauTiepNhan.TheVoucher.Ma,
                                        LoaiChietKhau = voucherKhamBenh.LoaiChietKhau,
                                        TiLe = voucherKhamBenh.TiLeChietKhau,
                                        SoTien = voucherKhamBenh.SoTienChietKhau.GetValueOrDefault()
                                    });
                                }
                            }
                        }
                        else if (chiPhiKhamChuaBenhVo.LoaiNhom == NhomChiPhiKhamChuaBenh.DichVuKyThuat)
                        {
                            if (voucher.ChietKhauTatCaDichVu == true)
                            {
                                danhSachMienGiamVos.Add(new DanhSachMienGiamVo
                                {
                                    LoaiMienGiam = Enums.LoaiMienGiam.Voucher,
                                    TheVoucherId = theVoucherYeuCauTiepNhan.TheVoucherId,
                                    MaTheVoucher = theVoucherYeuCauTiepNhan.TheVoucher.Ma,
                                    LoaiChietKhau = voucher.LoaiChietKhau.Value,
                                    TiLe = voucher.TiLeChietKhau,
                                    SoTien = voucher.SoTienChietKhau.GetValueOrDefault()
                                });
                            }
                            else
                            {
                                var ycDichVuKyThuat = yeuCauTiepNhan.YeuCauDichVuKyThuats.First(o => o.Id == chiPhiKhamChuaBenhVo.Id);
                                var voucherDichVuKyThuat = voucher.VoucherChiTietMienGiams.FirstOrDefault(o => (o.NhomDichVuBenhVienId != null && o.NhomDichVuBenhVienId == ycDichVuKyThuat.NhomDichVuBenhVienId)
                                                                                            || (o.DichVuKyThuatBenhVienId == ycDichVuKyThuat.DichVuKyThuatBenhVienId && o.NhomGiaDichVuKyThuatBenhVienId == ycDichVuKyThuat.NhomGiaDichVuKyThuatBenhVienId));
                                if (voucherDichVuKyThuat != null)
                                {
                                    danhSachMienGiamVos.Add(new DanhSachMienGiamVo
                                    {
                                        LoaiMienGiam = Enums.LoaiMienGiam.Voucher,
                                        TheVoucherId = theVoucherYeuCauTiepNhan.TheVoucherId,
                                        MaTheVoucher = theVoucherYeuCauTiepNhan.TheVoucher.Ma,
                                        LoaiChietKhau = voucherDichVuKyThuat.LoaiChietKhau,
                                        TiLe = voucherDichVuKyThuat.TiLeChietKhau,
                                        SoTien = voucherDichVuKyThuat.SoTienChietKhau.GetValueOrDefault()
                                    });
                                }
                            }
                        }
                    }
                }

                //xoa BHTN va mien giam khi sl = 0
                if (chiPhiKhamChuaBenhVo.Soluong.AlmostEqual(0))
                {
                    danhSachMienGiamVos = new List<DanhSachMienGiamVo>();
                    chiPhiKhamChuaBenhVo.DanhSachCongNoChoThus = new List<DanhSachCongNoVo>();
                }

                //add MienGiamThem
                if (!danhSachMienGiamVos.Exists(o =>
                    o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem &&
                    o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoTiLe))
                {
                    danhSachMienGiamVos.Add(new DanhSachMienGiamVo
                    {
                        LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                        TiLe = 0,
                        SoTien = 0
                    });
                }
                if (!danhSachMienGiamVos.Exists(o =>
                    o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem &&
                    o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoSoTien))
                {
                    danhSachMienGiamVos.Add(new DanhSachMienGiamVo
                    {
                        LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoSoTien,
                        SoTien = 0
                    });
                }

                foreach(var mg in danhSachMienGiamVos)
                {
                    if(mg.NoiGioiThieuId != null)
                    {
                        mg.DoiTuongUuDai = noiGioiThieus.FirstOrDefault(o => o.Id == mg.NoiGioiThieuId)?.Ten;
                    }
                }

                chiPhiKhamChuaBenhVo.DanhSachMienGiamVos = danhSachMienGiamVos;
                
                var soTienTruocMienGiam = chiPhiKhamChuaBenhVo.ThanhTien - chiPhiKhamChuaBenhVo.BHYTThanhToan;
                decimal soTienMienGiamTheoDv = 0;
                foreach (var mienGiamTheoTiLe in chiPhiKhamChuaBenhVo.DanhSachMienGiamVos.Where(o => o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoTiLe))
                {
                    mienGiamTheoTiLe.SoTien = Math.Round((soTienTruocMienGiam * mienGiamTheoTiLe.TiLe.GetValueOrDefault() / 100), 2, MidpointRounding.AwayFromZero);
                    soTienMienGiamTheoDv += mienGiamTheoTiLe.SoTien;
                }
                foreach (var mienGiamTheoTiLe in chiPhiKhamChuaBenhVo.DanhSachMienGiamVos.Where(o => o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoSoTien))
                {
                    soTienMienGiamTheoDv += mienGiamTheoTiLe.SoTien;
                }
                chiPhiKhamChuaBenhVo.SoTienMG = soTienMienGiamTheoDv;               

                //chiPhiKhamChuaBenhVo.SoTienMG = danhSachMienGiamVos.Sum(o => o.SoTien);
            }

            return result;
        }

        public async Task<(long, string)> ThuTienTamUng(ThuPhiTamUngVo thuPhiTamUnghVo)
        {
            var ycTiepNhan = BaseRepository.GetById(thuPhiTamUnghVo.Id,
                x => x.Include(o => o.YeuCauKhamBenhs).ThenInclude(yck => yck.DichVuKhamBenhBenhVien).ThenInclude(yck => yck.DichVuKhamBenhBenhVienNoiThucHiens)
                    .Include(o => o.YeuCauDichVuKyThuats).ThenInclude(yckt => yckt.DichVuKyThuatBenhVien).ThenInclude(yckt => yckt.DichVuKyThuatBenhVienNoiThucHiens)
                    .Include(o => o.YeuCauDuocPhamBenhViens).Include(o => o.YeuCauVatTuBenhViens).Include(o => o.YeuCauDichVuGiuongBenhViens)
                    .Include(o => o.DonThuocThanhToans).ThenInclude(o => o.DonThuocThanhToanChiTiets)
                    .Include(o => o.BenhNhan).ThenInclude(o => o.TaiKhoanBenhNhan)
                    .Include(o => o.BenhNhan).ThenInclude(o => o.YeuCauGoiDichVus).ThenInclude(g => g.YeuCauDichVuKyThuats)
                    .Include(o => o.BenhNhan).ThenInclude(o => o.YeuCauGoiDichVus).ThenInclude(g => g.YeuCauKhamBenhs));

            if (ycTiepNhan.BenhNhan == null)
                return (0, "Không có người bệnh");

            var tongThu = thuPhiTamUnghVo.TienMat.GetValueOrDefault() +
                          thuPhiTamUnghVo.ChuyenKhoan.GetValueOrDefault() +
                          thuPhiTamUnghVo.POS.GetValueOrDefault();

            var chiphi = GetDanhSachChiPhiKhamChuaBenhChuaThu(thuPhiTamUnghVo.Id);
            chiphi.ForEach(o => o.SoTienMG = o.DanhSachMienGiamVos?.Sum(mg => mg.SoTien) ?? 0);
            var tienBNPhaiTT = chiphi.Sum(o => o.BNConPhaiThanhToan);
            var soTienDaTamUng = await GetSoTienDaTamUngAsync(thuPhiTamUnghVo.Id);

            if (tongThu + soTienDaTamUng < tienBNPhaiTT)
                return (0, "Số tiền thanh toán không hợp lệ");

            var tk = ycTiepNhan.BenhNhan.TaiKhoanBenhNhan ?? new TaiKhoanBenhNhan
            {
                BenhNhan = ycTiepNhan.BenhNhan,
                SoDuTaiKhoan = 0
            };

            var thuPhi = new TaiKhoanBenhNhanThu
            {
                TaiKhoanBenhNhan = tk,
                LoaiThuTienBenhNhan = Enums.LoaiThuTienBenhNhan.ThuTamUng,
                LoaiNoiThu = Enums.LoaiNoiThu.ThuNgan,
                TienMat = thuPhiTamUnghVo.TienMat,
                ChuyenKhoan = thuPhiTamUnghVo.ChuyenKhoan,
                POS = thuPhiTamUnghVo.POS,
                NoiDungThu = thuPhiTamUnghVo.NoiDungThuTamUng,
                NgayThu = thuPhiTamUnghVo.NgayThuTamUng,
                SoPhieuHienThi = ResourceHelper.CreateSoTamUng(),
                NhanVienThucHienId = _userAgentHelper.GetCurrentUserId(),
                NoiThucHienId = _userAgentHelper.GetCurrentNoiLLamViecId()
            };
            tk.SoDuTaiKhoan += tongThu;
            //bao lanh thanh toan
            foreach (var yeuCauKhamBenh in ycTiepNhan.YeuCauKhamBenhs.Where(o => o.YeuCauGoiDichVuId == null && o.GoiKhamSucKhoeId == null))
            {
                if (yeuCauKhamBenh.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan)
                {
                    yeuCauKhamBenh.TrangThaiThanhToan = Enums.TrangThaiThanhToan.BaoLanhThanhToan;
                    if (yeuCauKhamBenh.NoiDangKyId != null)
                    {
                        yeuCauKhamBenh.PhongBenhVienHangDois.Add(XepVaoHangDoi(ycTiepNhan, yeuCauKhamBenh.NoiDangKyId.Value));
                    }
                }
            }
            foreach (var yeuCauDichVuKyThuat in ycTiepNhan.YeuCauDichVuKyThuats.Where(o => o.YeuCauGoiDichVuId == null && o.GoiKhamSucKhoeId == null))
            {
                if (yeuCauDichVuKyThuat.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan)
                {
                    yeuCauDichVuKyThuat.TrangThaiThanhToan = Enums.TrangThaiThanhToan.BaoLanhThanhToan;
                    if (yeuCauDichVuKyThuat.NoiThucHienId != null)
                    {
                        yeuCauDichVuKyThuat.PhongBenhVienHangDois.Add(XepVaoHangDoi(ycTiepNhan, yeuCauDichVuKyThuat.NoiThucHienId.Value));
                    }
                }
            }

            ycTiepNhan.TaiKhoanBenhNhanThus.Add(thuPhi);
            //await BaseRepository.UpdateAsync(ycTiepNhan);
            BaseRepository.Context.SaveChanges();
            return (thuPhi.Id, string.Empty);
        }

        public async Task<KetQuaThuPhiKhamChuaBenhNgoaiTruVo> ThuPhiKhamChuaBenh(ThuPhiKhamChuaBenhVo thuPhiKhamChuaBenhVo)
        {
            var ycTiepNhan = BaseRepository.GetById(thuPhiKhamChuaBenhVo.Id,
                x => x.Include(o => o.TaiKhoanBenhNhanThus).Include(o => o.TheVoucherYeuCauTiepNhans).ThenInclude(g => g.TheVoucher).ThenInclude(v => v.Voucher).ThenInclude(v => v.VoucherChiTietMienGiams)
                    .Include(o => o.YeuCauKhamBenhs).ThenInclude(g => g.CongTyBaoHiemTuNhanCongNos)
                    .Include(o => o.YeuCauKhamBenhs).ThenInclude(g => g.YeuCauNhapViens).ThenInclude(g => g.YeuCauTiepNhans)
                    .Include(o => o.YeuCauDichVuKyThuats).ThenInclude(g => g.CongTyBaoHiemTuNhanCongNos)
                    .Include(o => o.YeuCauDuocPhamBenhViens).ThenInclude(g => g.CongTyBaoHiemTuNhanCongNos)
                    .Include(o => o.YeuCauVatTuBenhViens).ThenInclude(g => g.CongTyBaoHiemTuNhanCongNos)
                    .Include(o => o.DonThuocThanhToans).ThenInclude(g => g.DonThuocThanhToanChiTiets).ThenInclude(g => g.CongTyBaoHiemTuNhanCongNos)
                    .Include(o => o.DonThuocThanhToans).ThenInclude(g => g.DonThuocThanhToanChiTiets).ThenInclude(g => g.XuatKhoDuocPhamChiTietViTri).ThenInclude(g => g.NhapKhoDuocPhamChiTiet)
                    .Include(o => o.DonThuocThanhToans).ThenInclude(g => g.DonThuocThanhToanChiTiets).ThenInclude(g => g.YeuCauKhamBenhDonThuocChiTiet).ThenInclude(g => g.YeuCauKhamBenhDonThuoc)
                    .Include(o => o.BenhNhan).ThenInclude(o => o.TaiKhoanBenhNhan)
                    .Include(o => o.DoiTuongUuDai).ThenInclude(ud => ud.DoiTuongUuDaiDichVuKhamBenhBenhViens)
                    .Include(o => o.DoiTuongUuDai).ThenInclude(ud => ud.DoiTuongUuDaiDichVuKyThuatBenhViens)
                    .Include(o => o.YeuCauTiepNhanCongTyBaoHiemTuNhans)
                    .Include(o => o.MienGiamChiPhis));

            if (ycTiepNhan.BenhNhan == null)
                return new KetQuaThuPhiKhamChuaBenhNgoaiTruVo { Error = "Không có người bệnh" };

            //kiem tra thong tin truoc khi thanh toan
            var ycKhamBenhExcept = thuPhiKhamChuaBenhVo.DanhSachChiPhiKhamChuaBenhDaChons
                .Where(o => o.LoaiNhom == NhomChiPhiKhamChuaBenh.DichVuKhamBenh).Select(o => o.Id).Except(ycTiepNhan
                    .YeuCauKhamBenhs
                    .Where(o => o.YeuCauGoiDichVuId == null && o.GoiKhamSucKhoeId == null && (!o.DuocHuongBaoHiem || o.BaoHiemChiTra != null) &&
                                (o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                                 o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                    .Select(o => o.Id));
            var ycKyThuatExcept = thuPhiKhamChuaBenhVo.DanhSachChiPhiKhamChuaBenhDaChons
                .Where(o => o.LoaiNhom == NhomChiPhiKhamChuaBenh.DichVuKyThuat).Select(o => o.Id).Except(ycTiepNhan
                    .YeuCauDichVuKyThuats
                    .Where(o => o.YeuCauGoiDichVuId == null && o.GoiKhamSucKhoeId == null && (!o.DuocHuongBaoHiem || o.BaoHiemChiTra != null) &&
                                (o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                                 o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                    .Select(o => o.Id));
            var ycDuocPhamExcept = thuPhiKhamChuaBenhVo.DanhSachChiPhiKhamChuaBenhDaChons
                .Where(o => o.LoaiNhom == NhomChiPhiKhamChuaBenh.DuocPham).Select(o => o.Id).Except(ycTiepNhan
                    .YeuCauDuocPhamBenhViens
                    .Where(o => o.YeuCauGoiDichVuId == null && (!o.DuocHuongBaoHiem || o.BaoHiemChiTra != null) &&
                                (o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                                 o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                    .Select(o => o.Id));
            var ycVatTuExcept = thuPhiKhamChuaBenhVo.DanhSachChiPhiKhamChuaBenhDaChons
                .Where(o => o.LoaiNhom == NhomChiPhiKhamChuaBenh.VatTuTieuHao).Select(o => o.Id).Except(ycTiepNhan
                    .YeuCauVatTuBenhViens
                    .Where(o => o.YeuCauGoiDichVuId == null && (!o.DuocHuongBaoHiem || o.BaoHiemChiTra != null) &&
                                (o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                                 o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                    .Select(o => o.Id));
            var ycToaThuocExcept = thuPhiKhamChuaBenhVo.DanhSachChiPhiKhamChuaBenhDaChons
                .Where(o => o.LoaiNhom == NhomChiPhiKhamChuaBenh.ToaThuoc).Select(o => o.Id).Except(ycTiepNhan
                    .DonThuocThanhToans
                    .Where(o => o.LoaiDonThuoc == Enums.EnumLoaiDonThuoc.ThuocBHYT &&
                                (o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                                 o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                    .SelectMany(o => o.DonThuocThanhToanChiTiets).Where(o => o.BaoHiemChiTra != null)
                    .Select(o => o.Id));

            if (ycKhamBenhExcept.Any() || ycKyThuatExcept.Any() || ycDuocPhamExcept.Any() || ycVatTuExcept.Any() ||
                ycToaThuocExcept.Any()) return new KetQuaThuPhiKhamChuaBenhNgoaiTruVo { Error = "Thông tin dịch vụ thanh toán không hợp lệ, vui lòng tải lại trang" };

            //var tongThu = thuPhiKhamChuaBenhVo.TienMat.GetValueOrDefault() +
            //              thuPhiKhamChuaBenhVo.ChuyenKhoan.GetValueOrDefault() +
            //              thuPhiKhamChuaBenhVo.POS.GetValueOrDefault() + thuPhiKhamChuaBenhVo.SoTienCongNo.GetValueOrDefault();
            var tongThuBenhNhan = thuPhiKhamChuaBenhVo.TienMat.GetValueOrDefault() +
                                  thuPhiKhamChuaBenhVo.ChuyenKhoan.GetValueOrDefault() +
                                  thuPhiKhamChuaBenhVo.POS.GetValueOrDefault();

            var dsChiPhi = GetDanhSachChiPhiKhamChuaBenhChuaThu(thuPhiKhamChuaBenhVo.Id);
            var dsChiPhiDaChon = thuPhiKhamChuaBenhVo.DanhSachChiPhiKhamChuaBenhDaChons;

            foreach (var chiPhiKhamChuaBenhVo in dsChiPhiDaChon)
            {
                var chiphi = dsChiPhi.FirstOrDefault(o => o.LoaiNhom == chiPhiKhamChuaBenhVo.LoaiNhom && o.Id == chiPhiKhamChuaBenhVo.Id);
                if (chiphi == null || !chiphi.ThanhTien.AlmostEqual(chiPhiKhamChuaBenhVo.ThanhTien) || !chiphi.BHYTThanhToan.AlmostEqual(chiPhiKhamChuaBenhVo.BHYTThanhToan))
                {
                    return new KetQuaThuPhiKhamChuaBenhNgoaiTruVo { Error = "Thông tin dịch vụ thanh toán không hợp lệ, vui lòng tải lại trang" };
                }
                if (chiPhiKhamChuaBenhVo.TongCongNo > chiPhiKhamChuaBenhVo.ThanhTien && chiPhiKhamChuaBenhVo.TongCongNo > Math.Round(chiPhiKhamChuaBenhVo.ThanhTien, 2, MidpointRounding.AwayFromZero))
                {
                    return new KetQuaThuPhiKhamChuaBenhNgoaiTruVo { Error = "Số tiền BHTN thanh toán lớn hơn thành tiền" };
                }
                var soTienTruocMienGiam = chiPhiKhamChuaBenhVo.ThanhTien - chiPhiKhamChuaBenhVo.BHYTThanhToan;

                decimal soTienMienGiamTheoDv = 0;

                foreach (var mienGiamTheoTiLe in chiPhiKhamChuaBenhVo.DanhSachMienGiamVos.Where(o => o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoTiLe))
                {
                    mienGiamTheoTiLe.SoTien = Math.Round((soTienTruocMienGiam * mienGiamTheoTiLe.TiLe.GetValueOrDefault() / 100), 2, MidpointRounding.AwayFromZero);
                    soTienMienGiamTheoDv += mienGiamTheoTiLe.SoTien;
                }
                foreach (var mienGiamTheoTiLe in chiPhiKhamChuaBenhVo.DanhSachMienGiamVos.Where(o => o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoSoTien))
                {
                    soTienMienGiamTheoDv += mienGiamTheoTiLe.SoTien;
                }
                if (soTienMienGiamTheoDv > chiPhiKhamChuaBenhVo.ThanhTien && soTienMienGiamTheoDv > Math.Round(chiPhiKhamChuaBenhVo.ThanhTien, 2, MidpointRounding.AwayFromZero))
                {
                    return new KetQuaThuPhiKhamChuaBenhNgoaiTruVo { Error = "Số tiền miễn giảm lớn hơn thành tiền" };
                }
                chiPhiKhamChuaBenhVo.SoTienMG = soTienMienGiamTheoDv;
            }

            var thuTamUng = ycTiepNhan.TaiKhoanBenhNhanThus.Where(o => o.DaHuy != true && o.LoaiThuTienBenhNhan == Enums.LoaiThuTienBenhNhan.ThuTamUng && o.ThuTienGoiDichVu != true && o.PhieuHoanUngId == null).ToList();

            var soTienDaTamUng = thuTamUng.Select(o => o.TienMat.GetValueOrDefault(0) + o.ChuyenKhoan.GetValueOrDefault(0) + o.POS.GetValueOrDefault(0)).DefaultIfEmpty(0).Sum();
            var soTienCanThu = Math.Round(dsChiPhiDaChon.Sum(o => o.BNConPhaiThanhToan), MidpointRounding.AwayFromZero);

            if (thuPhiKhamChuaBenhVo.SoTienCongNo.GetValueOrDefault() > soTienCanThu
                || (soTienDaTamUng + thuPhiKhamChuaBenhVo.SoTienCongNo.GetValueOrDefault() >= soTienCanThu && !tongThuBenhNhan.SoTienTuongDuong(0))
                || soTienDaTamUng.SoTienTuongDuong(0) && !soTienCanThu.SoTienTuongDuong(tongThuBenhNhan + thuPhiKhamChuaBenhVo.SoTienCongNo.GetValueOrDefault())
                || soTienDaTamUng + thuPhiKhamChuaBenhVo.SoTienCongNo.GetValueOrDefault() < soTienCanThu && !soTienCanThu.SoTienTuongDuong(tongThuBenhNhan + thuPhiKhamChuaBenhVo.SoTienCongNo.GetValueOrDefault() + soTienDaTamUng))
                return new KetQuaThuPhiKhamChuaBenhNgoaiTruVo { Error = "Số tiền thanh toán không hợp lệ" };
            var soTienMienGiam = dsChiPhiDaChon.Sum(o => o.SoTienMG);
            var tk = ycTiepNhan.BenhNhan.TaiKhoanBenhNhan ?? new TaiKhoanBenhNhan
            {
                BenhNhan = ycTiepNhan.BenhNhan
            };

            var userId = _userAgentHelper.GetCurrentUserId();
            var userThuNgan = _useRepository.GetById(_userAgentHelper.GetCurrentUserId());
            var maTaiKhoan = userId.ToString();
            if (userThuNgan.Email != null && userThuNgan.Email.IndexOf("@") > 0)
            {
                maTaiKhoan = userThuNgan.Email.Substring(0, userThuNgan.Email.IndexOf("@") > 10 ? 10 : userThuNgan.Email.IndexOf("@"));
            }

            var thuPhi = new TaiKhoanBenhNhanThu
            {
                TaiKhoanBenhNhan = tk,
                LoaiThuTienBenhNhan = Enums.LoaiThuTienBenhNhan.ThuTheoChiPhi,
                LoaiNoiThu = Enums.LoaiNoiThu.ThuNgan,
                TienMat = thuPhiKhamChuaBenhVo.TienMat,
                ChuyenKhoan = thuPhiKhamChuaBenhVo.ChuyenKhoan,
                POS = thuPhiKhamChuaBenhVo.POS,
                CongNo = thuPhiKhamChuaBenhVo.SoTienCongNo,
                NoiDungThu = thuPhiKhamChuaBenhVo.NoiDungThu,
                NgayThu = thuPhiKhamChuaBenhVo.NgayThu,
                SoPhieuHienThi = ResourceHelper.CreateSoPhieuThu(userId, maTaiKhoan),
                NhanVienThucHienId = _userAgentHelper.GetCurrentUserId(),
                NoiThucHienId = _userAgentHelper.GetCurrentNoiLLamViecId()
            };




            foreach (var chiphi in dsChiPhiDaChon.Where(o => o.LoaiNhom == NhomChiPhiKhamChuaBenh.DichVuKhamBenh))
            {
                var yc = ycTiepNhan.YeuCauKhamBenhs.First(o => o.Id == chiphi.Id);
                if (yc.NoiDangKyId != null && yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan)
                {
                    yc.PhongBenhVienHangDois.Add(XepVaoHangDoi(ycTiepNhan, yc.NoiDangKyId.Value));
                }
                #region cong no update 02/02/2021
                foreach (var ycCongTyBaoHiemTuNhanCongNo in yc.CongTyBaoHiemTuNhanCongNos.Where(o => o.TaiKhoanBenhNhanThuId == null))
                {
                    ycCongTyBaoHiemTuNhanCongNo.WillDelete = true;
                }
                if (chiphi.TongCongNo > 0)
                {
                    foreach (var chiphiDanhSachCongNoChoThu in chiphi.DanhSachCongNoChoThus)
                    {
                        if (chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu.AlmostEqual(0))
                            continue;
                        yc.CongTyBaoHiemTuNhanCongNos.Add(new CongTyBaoHiemTuNhanCongNo
                        {
                            TaiKhoanBenhNhanThu = thuPhi,
                            CongTyBaoHiemTuNhanId = chiphiDanhSachCongNoChoThu.CongTyBaoHiemTuNhanId,
                            SoTien = chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu
                        });
                    }
                }
                yc.SoTienBaoHiemTuNhanChiTra = chiphi.TongCongNo;
                #endregion
                #region mien giam update 02/02/2021
                foreach (var mienGiam in yc.MienGiamChiPhis.Where(o => o.TaiKhoanBenhNhanThuId == null))
                {
                    mienGiam.WillDelete = true;
                }
                //mien giam theo uu dai noi gioi thieu: BVHD-3882
                var mienGiamNoiGioiThieu = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.NoiGioiThieuId != null);
                if (mienGiamNoiGioiThieu != null)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                        NoiGioiThieuId = mienGiamNoiGioiThieu.NoiGioiThieuId,
                        LoaiChietKhau = mienGiamNoiGioiThieu.LoaiChietKhau,
                        TiLe = mienGiamNoiGioiThieu.TiLe,
                        SoTien = mienGiamNoiGioiThieu.SoTien
                    });
                }
                //mien giam theo uu dai
                var mienGiamUuDai = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.DoiTuongUuDaiId != null && o.TiLe != 0);
                if (mienGiamUuDai != null)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                        DoiTuongUuDaiId = mienGiamUuDai.DoiTuongUuDaiId,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                        TiLe = mienGiamUuDai.TiLe.GetValueOrDefault(),
                        SoTien = mienGiamUuDai.SoTien
                    });
                }
                //mien giam theo voucher
                var mienGiamVouchers = chiphi.DanhSachMienGiamVos.Where(o => o.TheVoucherId != null).ToList();
                foreach (var voucher in mienGiamVouchers)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.Voucher,
                        TheVoucherId = voucher.TheVoucherId,
                        LoaiChietKhau = voucher.LoaiChietKhau,
                        MaTheVoucher = voucher.MaTheVoucher,
                        TiLe = voucher.TiLe.GetValueOrDefault(),
                        SoTien = voucher.SoTien
                    });
                }
                //mien giam them theo ti le
                var mienGiamThemTiLe = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoTiLe);
                if (mienGiamThemTiLe != null && mienGiamThemTiLe.TiLe.GetValueOrDefault() != 0)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                        TiLe = mienGiamThemTiLe.TiLe,
                        SoTien = mienGiamThemTiLe.SoTien
                    });
                }
                //mien giam them theo so tien
                var mienGiamThemSoTien = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoSoTien);
                if (mienGiamThemSoTien != null && !mienGiamThemSoTien.SoTien.AlmostEqual(0))
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        YeuCauGoiDichVuId = mienGiamThemSoTien.YeuCauGoiDichVuId,
                        LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoSoTien,
                        SoTien = mienGiamThemSoTien.SoTien
                    });
                }

                yc.SoTienMienGiam = chiphi.SoTienMG;
                if ((mienGiamThemTiLe?.SoTien ?? 0).AlmostEqual(0) && (mienGiamThemSoTien?.SoTien ?? 0).AlmostEqual(0))
                {
                    yc.GhiChuMienGiamThem = null;
                    yc.NoiDungGhiChuMiemGiamId = null;
                }
                else
                {
                    yc.GhiChuMienGiamThem = chiphi.GhiChuMienGiamThem;
                    yc.NoiDungGhiChuMiemGiamId = chiphi.NoiDungGhiChuMiemGiamId;
                }
                #endregion
                yc.SoTienBenhNhanDaChi = yc.SoTienBenhNhanDaChi.GetValueOrDefault() + chiphi.BNConPhaiThanhToan;
                yc.TrangThaiThanhToan = Enums.TrangThaiThanhToan.DaThanhToan;
                thuPhi.TaiKhoanBenhNhanChis.Add(new TaiKhoanBenhNhanChi
                {
                    TaiKhoanBenhNhan = tk,
                    LoaiChiTienBenhNhan = Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi,
                    TienChiPhi = chiphi.BNConPhaiThanhToan,
                    NoiDungChi = Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi.GetDescription(),
                    NgayChi = DateTime.Now,
                    SoPhieuHienThi = thuPhi.SoPhieuHienThi,
                    YeuCauKhamBenh = yc,
                    Gia = yc.Gia,
                    SoLuong = 1,
                    DonGiaBaoHiem = yc.DonGiaBaoHiem,
                    MucHuongBaoHiem = yc.DuocHuongBaoHiem ? yc.MucHuongBaoHiem : 0,
                    TiLeBaoHiemThanhToan = yc.TiLeBaoHiemThanhToan,
                    SoTienMienGiam = yc.SoTienMienGiam,
                    SoTienBaoHiemTuNhanChiTra = yc.SoTienBaoHiemTuNhanChiTra,
                    YeuCauTiepNhanId = ycTiepNhan.Id,
                    NhanVienThucHienId = _userAgentHelper.GetCurrentUserId(),
                    NoiThucHienId = _userAgentHelper.GetCurrentNoiLLamViecId()
                });
            }

            foreach (var chiphi in dsChiPhiDaChon.Where(o => o.LoaiNhom == NhomChiPhiKhamChuaBenh.DichVuKyThuat))
            {
                var yc = ycTiepNhan.YeuCauDichVuKyThuats.First(o => o.Id == chiphi.Id);
                if (yc.NoiThucHienId != null && yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan)
                {
                    yc.PhongBenhVienHangDois.Add(XepVaoHangDoi(ycTiepNhan, yc.NoiThucHienId.Value));
                }
                #region cong no update 02/02/2021
                foreach (var ycCongTyBaoHiemTuNhanCongNo in yc.CongTyBaoHiemTuNhanCongNos.Where(o => o.TaiKhoanBenhNhanThuId == null))
                {
                    ycCongTyBaoHiemTuNhanCongNo.WillDelete = true;
                }
                if (chiphi.TongCongNo > 0)
                {
                    foreach (var chiphiDanhSachCongNoChoThu in chiphi.DanhSachCongNoChoThus)
                    {
                        if (chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu.AlmostEqual(0))
                            continue;
                        yc.CongTyBaoHiemTuNhanCongNos.Add(new CongTyBaoHiemTuNhanCongNo
                        {
                            TaiKhoanBenhNhanThu = thuPhi,
                            CongTyBaoHiemTuNhanId = chiphiDanhSachCongNoChoThu.CongTyBaoHiemTuNhanId,
                            SoTien = chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu
                        });
                    }
                }
                yc.SoTienBaoHiemTuNhanChiTra = chiphi.TongCongNo;
                #endregion
                #region mien giam update 02/02/2021
                foreach (var mienGiam in yc.MienGiamChiPhis.Where(o => o.TaiKhoanBenhNhanThuId == null))
                {
                    mienGiam.WillDelete = true;
                }
                //mien giam theo uu dai noi gioi thieu: BVHD-3882
                var mienGiamNoiGioiThieu = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.NoiGioiThieuId != null);
                if (mienGiamNoiGioiThieu != null)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                        NoiGioiThieuId = mienGiamNoiGioiThieu.NoiGioiThieuId,
                        LoaiChietKhau = mienGiamNoiGioiThieu.LoaiChietKhau,
                        TiLe = mienGiamNoiGioiThieu.TiLe,
                        SoTien = mienGiamNoiGioiThieu.SoTien
                    });
                }
                //mien giam theo uu dai
                var mienGiamUuDai = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.DoiTuongUuDaiId != null && o.TiLe != 0);
                if (mienGiamUuDai != null)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                        DoiTuongUuDaiId = mienGiamUuDai.DoiTuongUuDaiId,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                        TiLe = mienGiamUuDai.TiLe.GetValueOrDefault(),
                        SoTien = mienGiamUuDai.SoTien
                    });
                }
                //mien giam theo voucher
                var mienGiamVouchers = chiphi.DanhSachMienGiamVos.Where(o => o.TheVoucherId != null).ToList();
                foreach (var voucher in mienGiamVouchers)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.Voucher,
                        TheVoucherId = voucher.TheVoucherId,
                        LoaiChietKhau = voucher.LoaiChietKhau,
                        MaTheVoucher = voucher.MaTheVoucher,
                        TiLe = voucher.TiLe.GetValueOrDefault(),
                        SoTien = voucher.SoTien
                    });
                }
                //mien giam them theo ti le
                var mienGiamThemTiLe = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoTiLe);
                if (mienGiamThemTiLe != null && mienGiamThemTiLe.TiLe.GetValueOrDefault() != 0)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                        TiLe = mienGiamThemTiLe.TiLe,
                        SoTien = mienGiamThemTiLe.SoTien
                    });
                }
                //mien giam them theo so tien
                var mienGiamThemSoTien = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoSoTien);
                if (mienGiamThemSoTien != null && !mienGiamThemSoTien.SoTien.AlmostEqual(0))
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhi,
                        YeuCauGoiDichVuId = mienGiamThemSoTien.YeuCauGoiDichVuId,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoSoTien,
                        SoTien = mienGiamThemSoTien.SoTien
                    });
                }

                yc.SoTienMienGiam = chiphi.SoTienMG;
                if ((mienGiamThemTiLe?.SoTien ?? 0).AlmostEqual(0) && (mienGiamThemSoTien?.SoTien ?? 0).AlmostEqual(0))
                {
                    yc.GhiChuMienGiamThem = null;
                    yc.NoiDungGhiChuMiemGiamId = null;
                }
                else
                {
                    yc.GhiChuMienGiamThem = chiphi.GhiChuMienGiamThem;
                    yc.NoiDungGhiChuMiemGiamId = chiphi.NoiDungGhiChuMiemGiamId;
                }
                #endregion
                yc.SoTienBenhNhanDaChi = yc.SoTienBenhNhanDaChi.GetValueOrDefault() + chiphi.BNConPhaiThanhToan;
                yc.TrangThaiThanhToan = Enums.TrangThaiThanhToan.DaThanhToan;
                thuPhi.TaiKhoanBenhNhanChis.Add(new TaiKhoanBenhNhanChi
                {
                    TaiKhoanBenhNhan = tk,
                    LoaiChiTienBenhNhan = Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi,
                    TienChiPhi = chiphi.BNConPhaiThanhToan,
                    NoiDungChi = Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi.GetDescription(),
                    NgayChi = DateTime.Now,
                    SoPhieuHienThi = thuPhi.SoPhieuHienThi,
                    YeuCauDichVuKyThuat = yc,
                    Gia = yc.Gia,
                    SoLuong = yc.SoLan,
                    DonGiaBaoHiem = yc.DonGiaBaoHiem,
                    MucHuongBaoHiem = yc.DuocHuongBaoHiem ? yc.MucHuongBaoHiem : 0,
                    TiLeBaoHiemThanhToan = yc.TiLeBaoHiemThanhToan,
                    SoTienMienGiam = yc.SoTienMienGiam,
                    SoTienBaoHiemTuNhanChiTra = yc.SoTienBaoHiemTuNhanChiTra,
                    YeuCauTiepNhanId = ycTiepNhan.Id,
                    NhanVienThucHienId = _userAgentHelper.GetCurrentUserId(),
                    NoiThucHienId = _userAgentHelper.GetCurrentNoiLLamViecId()
                });
            }

            foreach (var chiphi in dsChiPhiDaChon.Where(o => o.LoaiNhom == NhomChiPhiKhamChuaBenh.DuocPham))
            {
                var yc = ycTiepNhan.YeuCauDuocPhamBenhViens.First(o => o.Id == chiphi.Id);
                #region cong no update 02/02/2021
                foreach (var ycCongTyBaoHiemTuNhanCongNo in yc.CongTyBaoHiemTuNhanCongNos.Where(o => o.TaiKhoanBenhNhanThuId == null))
                {
                    ycCongTyBaoHiemTuNhanCongNo.WillDelete = true;
                }
                if (chiphi.TongCongNo > 0)
                {
                    foreach (var chiphiDanhSachCongNoChoThu in chiphi.DanhSachCongNoChoThus)
                    {
                        if (chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu.AlmostEqual(0))
                            continue;
                        yc.CongTyBaoHiemTuNhanCongNos.Add(new CongTyBaoHiemTuNhanCongNo
                        {
                            TaiKhoanBenhNhanThu = thuPhi,
                            CongTyBaoHiemTuNhanId = chiphiDanhSachCongNoChoThu.CongTyBaoHiemTuNhanId,
                            SoTien = chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu
                        });
                    }
                }
                yc.SoTienBaoHiemTuNhanChiTra = chiphi.TongCongNo;
                #endregion
                #region mien giam update 02/02/2021
                foreach (var mienGiam in yc.MienGiamChiPhis.Where(o => o.TaiKhoanBenhNhanThuId == null))
                {
                    mienGiam.WillDelete = true;
                }
                //mien giam theo uu dai noi gioi thieu: BVHD-3882
                var mienGiamNoiGioiThieu = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.NoiGioiThieuId != null);
                if (mienGiamNoiGioiThieu != null)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                        NoiGioiThieuId = mienGiamNoiGioiThieu.NoiGioiThieuId,
                        LoaiChietKhau = mienGiamNoiGioiThieu.LoaiChietKhau,
                        TiLe = mienGiamNoiGioiThieu.TiLe,
                        SoTien = mienGiamNoiGioiThieu.SoTien
                    });
                }
                //mien giam theo uu dai
                var mienGiamUuDai = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.DoiTuongUuDaiId != null && o.TiLe != 0);
                if (mienGiamUuDai != null)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                        DoiTuongUuDaiId = mienGiamUuDai.DoiTuongUuDaiId,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                        TiLe = mienGiamUuDai.TiLe.GetValueOrDefault(),
                        SoTien = mienGiamUuDai.SoTien
                    });
                }
                //mien giam theo voucher
                var mienGiamVouchers = chiphi.DanhSachMienGiamVos.Where(o => o.TheVoucherId != null).ToList();
                foreach (var voucher in mienGiamVouchers)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.Voucher,
                        TheVoucherId = voucher.TheVoucherId,
                        LoaiChietKhau = voucher.LoaiChietKhau,
                        MaTheVoucher = voucher.MaTheVoucher,
                        TiLe = voucher.TiLe.GetValueOrDefault(),
                        SoTien = voucher.SoTien
                    });
                }
                //mien giam them theo ti le
                var mienGiamThemTiLe = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoTiLe);
                if (mienGiamThemTiLe != null && mienGiamThemTiLe.TiLe.GetValueOrDefault() != 0)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                        TiLe = mienGiamThemTiLe.TiLe,
                        SoTien = mienGiamThemTiLe.SoTien
                    });
                }
                //mien giam them theo so tien
                var mienGiamThemSoTien = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoSoTien);
                if (mienGiamThemSoTien != null && !mienGiamThemSoTien.SoTien.AlmostEqual(0))
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoSoTien,
                        SoTien = mienGiamThemSoTien.SoTien
                    });
                }

                yc.SoTienMienGiam = chiphi.SoTienMG;
                if ((mienGiamThemTiLe?.SoTien ?? 0).AlmostEqual(0) && (mienGiamThemSoTien?.SoTien ?? 0).AlmostEqual(0))
                {
                    yc.GhiChuMienGiamThem = null;
                    yc.NoiDungGhiChuMiemGiamId = null;
                }
                else
                {
                    yc.GhiChuMienGiamThem = chiphi.GhiChuMienGiamThem;
                    yc.NoiDungGhiChuMiemGiamId = chiphi.NoiDungGhiChuMiemGiamId;
                }
                #endregion
                yc.SoTienBenhNhanDaChi = yc.SoTienBenhNhanDaChi.GetValueOrDefault() + chiphi.BNConPhaiThanhToan;
                yc.TrangThaiThanhToan = Enums.TrangThaiThanhToan.DaThanhToan;
                thuPhi.TaiKhoanBenhNhanChis.Add(new TaiKhoanBenhNhanChi
                {
                    TaiKhoanBenhNhan = tk,
                    LoaiChiTienBenhNhan = Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi,
                    TienChiPhi = chiphi.BNConPhaiThanhToan,
                    NoiDungChi = Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi.GetDescription(),
                    NgayChi = DateTime.Now,
                    SoPhieuHienThi = thuPhi.SoPhieuHienThi,
                    YeuCauDuocPhamBenhVien = yc,
                    Gia = yc.DonGiaBan,
                    SoLuong = yc.SoLuong,
                    DonGiaBaoHiem = yc.DonGiaBaoHiem,
                    MucHuongBaoHiem = yc.DuocHuongBaoHiem ? yc.MucHuongBaoHiem : 0,
                    TiLeBaoHiemThanhToan = yc.TiLeBaoHiemThanhToan,
                    SoTienMienGiam = yc.SoTienMienGiam,
                    SoTienBaoHiemTuNhanChiTra = yc.SoTienBaoHiemTuNhanChiTra,
                    YeuCauTiepNhanId = ycTiepNhan.Id,
                    NhanVienThucHienId = _userAgentHelper.GetCurrentUserId(),
                    NoiThucHienId = _userAgentHelper.GetCurrentNoiLLamViecId()
                });
            }

            foreach (var chiphi in dsChiPhiDaChon.Where(o => o.LoaiNhom == NhomChiPhiKhamChuaBenh.VatTuTieuHao))
            {
                var yc = ycTiepNhan.YeuCauVatTuBenhViens.First(o => o.Id == chiphi.Id);
                #region cong no update 02/02/2021
                foreach (var ycCongTyBaoHiemTuNhanCongNo in yc.CongTyBaoHiemTuNhanCongNos.Where(o => o.TaiKhoanBenhNhanThuId == null))
                {
                    ycCongTyBaoHiemTuNhanCongNo.WillDelete = true;
                }
                if (chiphi.TongCongNo > 0)
                {
                    foreach (var chiphiDanhSachCongNoChoThu in chiphi.DanhSachCongNoChoThus)
                    {
                        if (chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu.AlmostEqual(0))
                            continue;
                        yc.CongTyBaoHiemTuNhanCongNos.Add(new CongTyBaoHiemTuNhanCongNo
                        {
                            TaiKhoanBenhNhanThu = thuPhi,
                            CongTyBaoHiemTuNhanId = chiphiDanhSachCongNoChoThu.CongTyBaoHiemTuNhanId,
                            SoTien = chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu
                        });
                    }
                }
                yc.SoTienBaoHiemTuNhanChiTra = chiphi.TongCongNo;
                #endregion
                #region mien giam update 02/02/2021
                foreach (var mienGiam in yc.MienGiamChiPhis.Where(o => o.TaiKhoanBenhNhanThuId == null))
                {
                    mienGiam.WillDelete = true;
                }
                //mien giam theo uu dai noi gioi thieu: BVHD-3882
                var mienGiamNoiGioiThieu = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.NoiGioiThieuId != null);
                if (mienGiamNoiGioiThieu != null)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                        NoiGioiThieuId = mienGiamNoiGioiThieu.NoiGioiThieuId,
                        LoaiChietKhau = mienGiamNoiGioiThieu.LoaiChietKhau,
                        TiLe = mienGiamNoiGioiThieu.TiLe,
                        SoTien = mienGiamNoiGioiThieu.SoTien
                    });
                }
                //mien giam theo uu dai
                var mienGiamUuDai = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.DoiTuongUuDaiId != null && o.TiLe != 0);
                if (mienGiamUuDai != null)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                        DoiTuongUuDaiId = mienGiamUuDai.DoiTuongUuDaiId,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                        TiLe = mienGiamUuDai.TiLe.GetValueOrDefault(),
                        SoTien = mienGiamUuDai.SoTien
                    });
                }
                //mien giam theo voucher
                var mienGiamVouchers = chiphi.DanhSachMienGiamVos.Where(o => o.TheVoucherId != null).ToList();
                foreach (var voucher in mienGiamVouchers)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.Voucher,
                        TheVoucherId = voucher.TheVoucherId,
                        LoaiChietKhau = voucher.LoaiChietKhau,
                        MaTheVoucher = voucher.MaTheVoucher,
                        TiLe = voucher.TiLe.GetValueOrDefault(),
                        SoTien = voucher.SoTien
                    });
                }
                //mien giam them theo ti le
                var mienGiamThemTiLe = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoTiLe);
                if (mienGiamThemTiLe != null && mienGiamThemTiLe.TiLe.GetValueOrDefault() != 0)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                        TiLe = mienGiamThemTiLe.TiLe,
                        SoTien = mienGiamThemTiLe.SoTien
                    });
                }
                //mien giam them theo so tien
                var mienGiamThemSoTien = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoSoTien);
                if (mienGiamThemSoTien != null && !mienGiamThemSoTien.SoTien.AlmostEqual(0))
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoSoTien,
                        SoTien = mienGiamThemSoTien.SoTien
                    });
                }

                yc.SoTienMienGiam = chiphi.SoTienMG;
                if ((mienGiamThemTiLe?.SoTien ?? 0).AlmostEqual(0) && (mienGiamThemSoTien?.SoTien ?? 0).AlmostEqual(0))
                {
                    yc.GhiChuMienGiamThem = null;
                    yc.NoiDungGhiChuMiemGiamId = null;
                }
                else
                {
                    yc.GhiChuMienGiamThem = chiphi.GhiChuMienGiamThem;
                    yc.NoiDungGhiChuMiemGiamId = chiphi.NoiDungGhiChuMiemGiamId;
                }
                #endregion
                yc.SoTienBenhNhanDaChi = yc.SoTienBenhNhanDaChi.GetValueOrDefault() + chiphi.BNConPhaiThanhToan;
                yc.TrangThaiThanhToan = Enums.TrangThaiThanhToan.DaThanhToan;
                thuPhi.TaiKhoanBenhNhanChis.Add(new TaiKhoanBenhNhanChi
                {
                    TaiKhoanBenhNhan = tk,
                    LoaiChiTienBenhNhan = Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi,
                    TienChiPhi = chiphi.BNConPhaiThanhToan,
                    NoiDungChi = Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi.GetDescription(),
                    NgayChi = DateTime.Now,
                    SoPhieuHienThi = thuPhi.SoPhieuHienThi,
                    YeuCauVatTuBenhVien = yc,
                    Gia = yc.DonGiaBan,
                    SoLuong = yc.SoLuong,
                    DonGiaBaoHiem = yc.DonGiaBaoHiem,
                    MucHuongBaoHiem = yc.DuocHuongBaoHiem ? yc.MucHuongBaoHiem : 0,
                    TiLeBaoHiemThanhToan = yc.TiLeBaoHiemThanhToan,
                    SoTienMienGiam = yc.SoTienMienGiam,
                    SoTienBaoHiemTuNhanChiTra = yc.SoTienBaoHiemTuNhanChiTra,
                    YeuCauTiepNhanId = ycTiepNhan.Id,
                    NhanVienThucHienId = _userAgentHelper.GetCurrentUserId(),
                    NoiThucHienId = _userAgentHelper.GetCurrentNoiLLamViecId()
                });
            }

            foreach (var chiphi in dsChiPhiDaChon.Where(o => o.LoaiNhom == NhomChiPhiKhamChuaBenh.ToaThuoc))
            {
                var yc = ycTiepNhan.DonThuocThanhToans.SelectMany(o => o.DonThuocThanhToanChiTiets).First(o => o.Id == chiphi.Id);
                #region cong no update 02/02/2021
                foreach (var ycCongTyBaoHiemTuNhanCongNo in yc.CongTyBaoHiemTuNhanCongNos.Where(o => o.TaiKhoanBenhNhanThuId == null))
                {
                    ycCongTyBaoHiemTuNhanCongNo.WillDelete = true;
                }
                if (chiphi.TongCongNo > 0)
                {
                    foreach (var chiphiDanhSachCongNoChoThu in chiphi.DanhSachCongNoChoThus)
                    {
                        if (chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu.AlmostEqual(0))
                            continue;
                        yc.CongTyBaoHiemTuNhanCongNos.Add(new CongTyBaoHiemTuNhanCongNo
                        {
                            TaiKhoanBenhNhanThu = thuPhi,
                            CongTyBaoHiemTuNhanId = chiphiDanhSachCongNoChoThu.CongTyBaoHiemTuNhanId,
                            SoTien = chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu
                        });
                    }
                }
                yc.SoTienBaoHiemTuNhanChiTra = chiphi.TongCongNo;
                #endregion
                #region mien giam update 02/02/2021
                foreach (var mienGiam in yc.MienGiamChiPhis.Where(o => o.TaiKhoanBenhNhanThuId == null))
                {
                    mienGiam.WillDelete = true;
                }
                //mien giam theo uu dai noi gioi thieu: BVHD-3882
                var mienGiamNoiGioiThieu = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.NoiGioiThieuId != null);
                if (mienGiamNoiGioiThieu != null)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                        NoiGioiThieuId = mienGiamNoiGioiThieu.NoiGioiThieuId,
                        LoaiChietKhau = mienGiamNoiGioiThieu.LoaiChietKhau,
                        TiLe = mienGiamNoiGioiThieu.TiLe,
                        SoTien = mienGiamNoiGioiThieu.SoTien
                    });
                }
                //mien giam theo uu dai
                var mienGiamUuDai = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.DoiTuongUuDaiId != null && o.TiLe != 0);
                if (mienGiamUuDai != null)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                        DoiTuongUuDaiId = mienGiamUuDai.DoiTuongUuDaiId,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                        TiLe = mienGiamUuDai.TiLe.GetValueOrDefault(),
                        SoTien = mienGiamUuDai.SoTien
                    });
                }
                //mien giam theo voucher
                var mienGiamVouchers = chiphi.DanhSachMienGiamVos.Where(o => o.TheVoucherId != null).ToList();
                foreach (var voucher in mienGiamVouchers)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.Voucher,
                        TheVoucherId = voucher.TheVoucherId,
                        LoaiChietKhau = voucher.LoaiChietKhau,
                        MaTheVoucher = voucher.MaTheVoucher,
                        TiLe = voucher.TiLe.GetValueOrDefault(),
                        SoTien = voucher.SoTien
                    });
                }
                //mien giam them theo ti le
                var mienGiamThemTiLe = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoTiLe);
                if (mienGiamThemTiLe != null && mienGiamThemTiLe.TiLe.GetValueOrDefault() != 0)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                        TiLe = mienGiamThemTiLe.TiLe,
                        SoTien = mienGiamThemTiLe.SoTien
                    });
                }
                //mien giam them theo so tien
                var mienGiamThemSoTien = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoSoTien);
                if (mienGiamThemSoTien != null && !mienGiamThemSoTien.SoTien.AlmostEqual(0))
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoSoTien,
                        SoTien = mienGiamThemSoTien.SoTien
                    });
                }

                yc.SoTienMienGiam = chiphi.SoTienMG;
                if ((mienGiamThemTiLe?.SoTien ?? 0).AlmostEqual(0) && (mienGiamThemSoTien?.SoTien ?? 0).AlmostEqual(0))
                {
                    yc.GhiChuMienGiamThem = null;
                    yc.NoiDungGhiChuMiemGiamId = null;
                }
                else
                {
                    yc.GhiChuMienGiamThem = chiphi.GhiChuMienGiamThem;
                    yc.NoiDungGhiChuMiemGiamId = chiphi.NoiDungGhiChuMiemGiamId;
                }
                #endregion
                yc.SoTienBenhNhanDaChi = yc.SoTienBenhNhanDaChi.GetValueOrDefault() + chiphi.BNConPhaiThanhToan;
                yc.DonThuocThanhToan.TrangThaiThanhToan = Enums.TrangThaiThanhToan.DaThanhToan;
                var donThuocThanhToanChiTietTheoPhieuThu = yc.Map<DonThuocThanhToanChiTietTheoPhieuThu>();
                donThuocThanhToanChiTietTheoPhieuThu.NgayPhatSinh = yc.CreatedOn ?? DateTime.Now;
                donThuocThanhToanChiTietTheoPhieuThu.LoaiDonThuoc = yc.DonThuocThanhToan.LoaiDonThuoc;
                var ttNhapThuoc = yc.XuatKhoDuocPhamChiTietViTri.NhapKhoDuocPhamChiTiet;
                donThuocThanhToanChiTietTheoPhieuThu.Solo = ttNhapThuoc.Solo;
                donThuocThanhToanChiTietTheoPhieuThu.MaVach = ttNhapThuoc.MaVach;
                donThuocThanhToanChiTietTheoPhieuThu.HanSuDung = ttNhapThuoc.HanSuDung;
                donThuocThanhToanChiTietTheoPhieuThu.NgayNhapVaoBenhVien = ttNhapThuoc.NgayNhapVaoBenhVien;
                donThuocThanhToanChiTietTheoPhieuThu.SoLuongToa = yc.YeuCauKhamBenhDonThuocChiTiet?.SoLuong;
                donThuocThanhToanChiTietTheoPhieuThu.BacSiKeDonId = yc.YeuCauKhamBenhDonThuocChiTiet?.YeuCauKhamBenhDonThuoc.BacSiKeDonId;
                donThuocThanhToanChiTietTheoPhieuThu.ThoiDiemKeDon = yc.YeuCauKhamBenhDonThuocChiTiet?.YeuCauKhamBenhDonThuoc.ThoiDiemKeDon;

                thuPhi.TaiKhoanBenhNhanChis.Add(new TaiKhoanBenhNhanChi
                {
                    TaiKhoanBenhNhan = tk,
                    LoaiChiTienBenhNhan = Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi,
                    TienChiPhi = chiphi.BNConPhaiThanhToan,
                    NoiDungChi = Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi.GetDescription(),
                    NgayChi = DateTime.Now,
                    SoPhieuHienThi = thuPhi.SoPhieuHienThi,
                    DonThuocThanhToanChiTiet = yc,
                    DonThuocThanhToanChiTietTheoPhieuThu = donThuocThanhToanChiTietTheoPhieuThu,
                    Gia = yc.DonGiaBan,
                    SoLuong = yc.SoLuong,
                    DonGiaBaoHiem = yc.DonGiaBaoHiem,
                    MucHuongBaoHiem = yc.DuocHuongBaoHiem ? yc.MucHuongBaoHiem : 0,
                    TiLeBaoHiemThanhToan = yc.TiLeBaoHiemThanhToan,
                    SoTienMienGiam = yc.SoTienMienGiam,
                    SoTienBaoHiemTuNhanChiTra = yc.SoTienBaoHiemTuNhanChiTra,
                    YeuCauTiepNhanId = ycTiepNhan.Id,
                    NhanVienThucHienId = _userAgentHelper.GetCurrentUserId(),
                    NoiThucHienId = _userAgentHelper.GetCurrentNoiLLamViecId()
                });
            }

            TaiKhoanBenhNhanChi phieuHoanUng = null;
            if (thuTamUng.Any())
            {
                thuPhi.TamUng = soTienDaTamUng;
                phieuHoanUng = new TaiKhoanBenhNhanChi
                {
                    TaiKhoanBenhNhan = tk,
                    LoaiChiTienBenhNhan = Enums.LoaiChiTienBenhNhan.HoanUng,
                    TienMat = soTienDaTamUng,
                    NoiDungChi = Enums.LoaiChiTienBenhNhan.HoanUng.GetDescription(),
                    NgayChi = thuPhi.NgayThu.AddMilliseconds(-1),
                    YeuCauTiepNhanId = ycTiepNhan.Id,
                    SoPhieuHienThi = ResourceHelper.CreateSoHoanUng(),
                    NhanVienThucHienId = _userAgentHelper.GetCurrentUserId(),
                    NoiThucHienId = _userAgentHelper.GetCurrentNoiLLamViecId()
                };
                thuPhi.TaiKhoanBenhNhanChis.Add(phieuHoanUng);

                foreach (var taiKhoanBenhNhanThu in ycTiepNhan.TaiKhoanBenhNhanThus.Where(o => o.DaHuy != true && o.LoaiThuTienBenhNhan == Enums.LoaiThuTienBenhNhan.ThuTamUng && o.ThuTienGoiDichVu != true && o.PhieuHoanUngId == null))
                {
                    taiKhoanBenhNhanThu.PhieuHoanUng = phieuHoanUng;
                }
            }
            tk.SoDuTaiKhoan -= soTienDaTamUng;
            ycTiepNhan.TaiKhoanBenhNhanThus.Add(thuPhi);

            //bỏ tự động nhập viện
            //if (ycTiepNhan.YeuCauKhamBenhs.All(o =>
            //        o.TrangThai == Enums.EnumTrangThaiYeuCauKhamBenh.HuyKham ||
            //        o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.DaThanhToan)
            //    && ycTiepNhan.YeuCauDichVuKyThuats.All(o =>
            //        o.TrangThai == Enums.EnumTrangThaiYeuCauDichVuKyThuat.DaHuy ||
            //        o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.DaThanhToan))
            //{
            //    foreach (var yeuCauKhamBenh in ycTiepNhan.YeuCauKhamBenhs)
            //    {
            //        var yeuCauNhapVien = yeuCauKhamBenh.YeuCauNhapViens.FirstOrDefault(o => !o.YeuCauTiepNhans.Any());
            //        if (yeuCauNhapVien != null)
            //        {
            //            var yeuCauTiepNhanNoiTru = GetYeuCauTiepNhanNoiTru(ycTiepNhan, yeuCauNhapVien);
            //            await BaseRepository.AddAsync(yeuCauTiepNhanNoiTru);
            //            return new KetQuaThuPhiKhamChuaBenhNgoaiTruVo { PhieuThuId = thuPhi.Id, LaPhieuChi = soTienDaTamUng + thuPhiKhamChuaBenhVo.SoTienCongNo.GetValueOrDefault() > soTienCanThu, PhieuHoanUngId = phieuHoanUng?.Id ?? 0 };
            //        }
            //    }
            //}

            //await BaseRepository.UpdateAsync(ycTiepNhan);
            BaseRepository.Context.SaveChanges();
            return new KetQuaThuPhiKhamChuaBenhNgoaiTruVo { PhieuThuId = thuPhi.Id, LaPhieuChi = soTienDaTamUng + thuPhiKhamChuaBenhVo.SoTienCongNo.GetValueOrDefault() > soTienCanThu, PhieuHoanUngId = phieuHoanUng?.Id ?? 0 };
        }

        public async Task<KetQuaThuPhiKhamChuaBenhNgoaiTruVaQuyetToanDichVuTrongGoiVo> ThuPhiKhamChuaBenhVaQuyetToanDichVuTrongGoi(ThuPhiKhamChuaBenhVo thuPhiKhamChuaBenhVo)
        {
            var ycTiepNhan = BaseRepository.GetById(thuPhiKhamChuaBenhVo.Id,
                x => x.Include(o => o.TaiKhoanBenhNhanThus).Include(o => o.TheVoucherYeuCauTiepNhans).ThenInclude(g => g.TheVoucher).ThenInclude(v => v.Voucher).ThenInclude(v => v.VoucherChiTietMienGiams)
                    .Include(o => o.YeuCauKhamBenhs).ThenInclude(g => g.CongTyBaoHiemTuNhanCongNos)
                    .Include(o => o.YeuCauKhamBenhs).ThenInclude(o => o.YeuCauGoiDichVu)
                    .Include(o => o.YeuCauKhamBenhs).ThenInclude(g => g.YeuCauNhapViens).ThenInclude(g => g.YeuCauTiepNhans)
                    .Include(o => o.YeuCauDichVuKyThuats).ThenInclude(g => g.CongTyBaoHiemTuNhanCongNos)
                    .Include(o => o.YeuCauDichVuKyThuats).ThenInclude(o => o.YeuCauGoiDichVu)
                    .Include(o => o.YeuCauDuocPhamBenhViens).ThenInclude(g => g.CongTyBaoHiemTuNhanCongNos)
                    .Include(o => o.YeuCauVatTuBenhViens).ThenInclude(g => g.CongTyBaoHiemTuNhanCongNos)
                    .Include(o => o.DonThuocThanhToans).ThenInclude(g => g.DonThuocThanhToanChiTiets).ThenInclude(g => g.CongTyBaoHiemTuNhanCongNos)
                    .Include(o => o.DonThuocThanhToans).ThenInclude(g => g.DonThuocThanhToanChiTiets).ThenInclude(g => g.XuatKhoDuocPhamChiTietViTri).ThenInclude(g => g.NhapKhoDuocPhamChiTiet)
                    .Include(o => o.DonThuocThanhToans).ThenInclude(g => g.DonThuocThanhToanChiTiets).ThenInclude(g => g.YeuCauKhamBenhDonThuocChiTiet).ThenInclude(g => g.YeuCauKhamBenhDonThuoc)
                    .Include(o => o.BenhNhan).ThenInclude(o => o.TaiKhoanBenhNhan)
                    .Include(o => o.DoiTuongUuDai).ThenInclude(ud => ud.DoiTuongUuDaiDichVuKhamBenhBenhViens)
                    .Include(o => o.DoiTuongUuDai).ThenInclude(ud => ud.DoiTuongUuDaiDichVuKyThuatBenhViens)
                    .Include(o => o.YeuCauTiepNhanCongTyBaoHiemTuNhans)
                    .Include(o => o.MienGiamChiPhis));

            if (ycTiepNhan.BenhNhan == null)
                return new KetQuaThuPhiKhamChuaBenhNgoaiTruVaQuyetToanDichVuTrongGoiVo { Error = "Không có người bệnh" };

            //kiem tra thong tin truoc khi thanh toan
            var ycKhamBenhExcept = thuPhiKhamChuaBenhVo.DanhSachChiPhiKhamChuaBenhDaChons
                .Where(o => o.LoaiNhom == NhomChiPhiKhamChuaBenh.DichVuKhamBenh).Select(o => o.Id).Except(ycTiepNhan
                    .YeuCauKhamBenhs
                    .Where(o => o.YeuCauGoiDichVuId == null && o.GoiKhamSucKhoeId == null && (!o.DuocHuongBaoHiem || o.BaoHiemChiTra != null) &&
                                (o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                                 o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                    .Select(o => o.Id));
            var ycKyThuatExcept = thuPhiKhamChuaBenhVo.DanhSachChiPhiKhamChuaBenhDaChons
                .Where(o => o.LoaiNhom == NhomChiPhiKhamChuaBenh.DichVuKyThuat).Select(o => o.Id).Except(ycTiepNhan
                    .YeuCauDichVuKyThuats
                    .Where(o => o.YeuCauGoiDichVuId == null && o.GoiKhamSucKhoeId == null && (!o.DuocHuongBaoHiem || o.BaoHiemChiTra != null) &&
                                (o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                                 o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                    .Select(o => o.Id));
            var ycDuocPhamExcept = thuPhiKhamChuaBenhVo.DanhSachChiPhiKhamChuaBenhDaChons
                .Where(o => o.LoaiNhom == NhomChiPhiKhamChuaBenh.DuocPham).Select(o => o.Id).Except(ycTiepNhan
                    .YeuCauDuocPhamBenhViens
                    .Where(o => o.YeuCauGoiDichVuId == null && (!o.DuocHuongBaoHiem || o.BaoHiemChiTra != null) &&
                                (o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                                 o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                    .Select(o => o.Id));
            var ycVatTuExcept = thuPhiKhamChuaBenhVo.DanhSachChiPhiKhamChuaBenhDaChons
                .Where(o => o.LoaiNhom == NhomChiPhiKhamChuaBenh.VatTuTieuHao).Select(o => o.Id).Except(ycTiepNhan
                    .YeuCauVatTuBenhViens
                    .Where(o => o.YeuCauGoiDichVuId == null && (!o.DuocHuongBaoHiem || o.BaoHiemChiTra != null) &&
                                (o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                                 o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                    .Select(o => o.Id));
            var ycToaThuocExcept = thuPhiKhamChuaBenhVo.DanhSachChiPhiKhamChuaBenhDaChons
                .Where(o => o.LoaiNhom == NhomChiPhiKhamChuaBenh.ToaThuoc).Select(o => o.Id).Except(ycTiepNhan
                    .DonThuocThanhToans
                    .Where(o => o.LoaiDonThuoc == Enums.EnumLoaiDonThuoc.ThuocBHYT &&
                                (o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                                 o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                    .SelectMany(o => o.DonThuocThanhToanChiTiets).Where(o => o.BaoHiemChiTra != null)
                    .Select(o => o.Id));

            if (ycKhamBenhExcept.Any() || ycKyThuatExcept.Any() || ycDuocPhamExcept.Any() || ycVatTuExcept.Any() ||
                ycToaThuocExcept.Any()) return new KetQuaThuPhiKhamChuaBenhNgoaiTruVaQuyetToanDichVuTrongGoiVo { Error = "Thông tin dịch vụ thanh toán không hợp lệ, vui lòng tải lại trang" };

            var userId = _userAgentHelper.GetCurrentUserId();
            var userThuNgan = _useRepository.GetById(_userAgentHelper.GetCurrentUserId());
            var maTaiKhoan = userId.ToString();
            if (userThuNgan.Email != null && userThuNgan.Email.IndexOf("@") > 0)
            {
                maTaiKhoan = userThuNgan.Email.Substring(0, userThuNgan.Email.IndexOf("@") > 10 ? 10 : userThuNgan.Email.IndexOf("@"));
            }

            var tk = ycTiepNhan.BenhNhan.TaiKhoanBenhNhan ?? new TaiKhoanBenhNhan
            {
                BenhNhan = ycTiepNhan.BenhNhan
            };

            var tongThuBenhNhan = thuPhiKhamChuaBenhVo.TienMat.GetValueOrDefault() +
                                  thuPhiKhamChuaBenhVo.ChuyenKhoan.GetValueOrDefault() +
                                  thuPhiKhamChuaBenhVo.POS.GetValueOrDefault();

            var dsChiPhi = GetDanhSachChiPhiKhamChuaBenhChuaThu(thuPhiKhamChuaBenhVo.Id);
            var dsChiPhiDaChon = thuPhiKhamChuaBenhVo.DanhSachChiPhiKhamChuaBenhDaChons;

            foreach (var chiPhiKhamChuaBenhVo in dsChiPhiDaChon)
            {
                var chiphi = dsChiPhi.FirstOrDefault(o => o.LoaiNhom == chiPhiKhamChuaBenhVo.LoaiNhom && o.Id == chiPhiKhamChuaBenhVo.Id);
                if (chiphi == null || !chiphi.ThanhTien.AlmostEqual(chiPhiKhamChuaBenhVo.ThanhTien) || !chiphi.BHYTThanhToan.AlmostEqual(chiPhiKhamChuaBenhVo.BHYTThanhToan))
                {
                    return new KetQuaThuPhiKhamChuaBenhNgoaiTruVaQuyetToanDichVuTrongGoiVo { Error = "Thông tin dịch vụ thanh toán không hợp lệ, vui lòng tải lại trang" };
                }
                if (chiPhiKhamChuaBenhVo.TongCongNo > chiPhiKhamChuaBenhVo.ThanhTien && chiPhiKhamChuaBenhVo.TongCongNo > Math.Round(chiPhiKhamChuaBenhVo.ThanhTien, 2, MidpointRounding.AwayFromZero))
                {
                    return new KetQuaThuPhiKhamChuaBenhNgoaiTruVaQuyetToanDichVuTrongGoiVo { Error = "Số tiền BHTN thanh toán lớn hơn thành tiền" };
                }
                var soTienTruocMienGiam = chiPhiKhamChuaBenhVo.ThanhTien - chiPhiKhamChuaBenhVo.BHYTThanhToan;

                decimal soTienMienGiamTheoDv = 0;

                foreach (var mienGiamTheoTiLe in chiPhiKhamChuaBenhVo.DanhSachMienGiamVos.Where(o => o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoTiLe))
                {
                    mienGiamTheoTiLe.SoTien = Math.Round((soTienTruocMienGiam * mienGiamTheoTiLe.TiLe.GetValueOrDefault() / 100), 2, MidpointRounding.AwayFromZero);
                    soTienMienGiamTheoDv += mienGiamTheoTiLe.SoTien;
                }
                foreach (var mienGiamTheoTiLe in chiPhiKhamChuaBenhVo.DanhSachMienGiamVos.Where(o => o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoSoTien))
                {
                    soTienMienGiamTheoDv += mienGiamTheoTiLe.SoTien;
                }
                if (soTienMienGiamTheoDv > chiPhiKhamChuaBenhVo.ThanhTien && soTienMienGiamTheoDv > Math.Round(chiPhiKhamChuaBenhVo.ThanhTien, 2, MidpointRounding.AwayFromZero))
                {
                    return new KetQuaThuPhiKhamChuaBenhNgoaiTruVaQuyetToanDichVuTrongGoiVo { Error = "Số tiền miễn giảm lớn hơn thành tiền" };
                }
                chiPhiKhamChuaBenhVo.SoTienMG = soTienMienGiamTheoDv;
            }

            var thuTamUng = ycTiepNhan.TaiKhoanBenhNhanThus.Where(o => o.DaHuy != true && o.LoaiThuTienBenhNhan == Enums.LoaiThuTienBenhNhan.ThuTamUng && o.ThuTienGoiDichVu != true && o.PhieuHoanUngId == null).ToList();

            var soTienDaTamUng = thuTamUng.Select(o => o.TienMat.GetValueOrDefault(0) + o.ChuyenKhoan.GetValueOrDefault(0) + o.POS.GetValueOrDefault(0)).DefaultIfEmpty(0).Sum();
            var soTienCanThu = Math.Round(dsChiPhiDaChon.Sum(o => o.BNConPhaiThanhToan), MidpointRounding.AwayFromZero);

            //thu trong goi
            var dichVuKhams = ycTiepNhan.YeuCauKhamBenhs.Where(o =>
                o.TrangThai != Enums.EnumTrangThaiYeuCauKhamBenh.HuyKham &&
                o.TrangThaiThanhToan != Enums.TrangThaiThanhToan.DaThanhToan && o.YeuCauGoiDichVuId != null)
                .Select(s => new ChiPhiKhamChuaBenhTrongGoiDichVuVo
                {
                    Id = s.Id,
                    YeuCauGoiDichVuId = s.YeuCauGoiDichVuId.Value,
                    ChuongTrinhGoiDichVuId = s.YeuCauGoiDichVu.ChuongTrinhGoiDichVuId,
                    TenChuongTrinhGoiDichVu = s.YeuCauGoiDichVu.TenChuongTrinh,
                    LoaiNhom = NhomChiPhiKhamChuaBenh.DichVuKhamBenh,
                    Soluong = 1,
                    DonGia = s.DonGiaSauChietKhau.GetValueOrDefault(),
                    KiemTraBHYTXacNhan = s.BaoHiemChiTra != null,
                    DuocHuongBHYT = s.DuocHuongBaoHiem,
                    DonGiaBHYT = s.DonGiaBaoHiem.GetValueOrDefault(),
                    TiLeBaoHiemThanhToan = s.TiLeBaoHiemThanhToan.GetValueOrDefault(),
                    MucHuongBaoHiem = s.MucHuongBaoHiem.GetValueOrDefault(),
                    DanhSachCongNoChoThus = s.CongTyBaoHiemTuNhanCongNos.Count == 0 ? new List<DanhSachCongNoVo>() : s.CongTyBaoHiemTuNhanCongNos.Where(o => o.TaiKhoanBenhNhanThuId == null).Select(o => new DanhSachCongNoVo { CongTyBaoHiemTuNhanId = o.CongTyBaoHiemTuNhanId, SoTienCongNoChoThu = o.SoTien }).ToList(),
                    CheckedDefault = true,
                });
            var dichVuKyThuats = ycTiepNhan.YeuCauDichVuKyThuats.Where(o =>
                    o.TrangThai != Enums.EnumTrangThaiYeuCauDichVuKyThuat.DaHuy &&
                    o.TrangThaiThanhToan != Enums.TrangThaiThanhToan.DaThanhToan && o.YeuCauGoiDichVuId != null)
                .Select(s => new ChiPhiKhamChuaBenhTrongGoiDichVuVo
                {
                    Id = s.Id,
                    YeuCauGoiDichVuId = s.YeuCauGoiDichVuId.Value,
                    ChuongTrinhGoiDichVuId = s.YeuCauGoiDichVu.ChuongTrinhGoiDichVuId,
                    TenChuongTrinhGoiDichVu = s.YeuCauGoiDichVu.TenChuongTrinh,
                    LoaiNhom = NhomChiPhiKhamChuaBenh.DichVuKyThuat,
                    Soluong = s.SoLan,
                    DonGia = s.DonGiaSauChietKhau.GetValueOrDefault(),
                    DonGiaBHYT = s.DonGiaBaoHiem.GetValueOrDefault(),
                    KiemTraBHYTXacNhan = s.BaoHiemChiTra != null,
                    DuocHuongBHYT = s.DuocHuongBaoHiem,
                    TiLeBaoHiemThanhToan = s.TiLeBaoHiemThanhToan.GetValueOrDefault(),
                    MucHuongBaoHiem = s.MucHuongBaoHiem.GetValueOrDefault(),
                    DanhSachCongNoChoThus = s.CongTyBaoHiemTuNhanCongNos.Count == 0 ? new List<DanhSachCongNoVo>() : s.CongTyBaoHiemTuNhanCongNos.Where(o => o.TaiKhoanBenhNhanThuId == null).Select(o => new DanhSachCongNoVo { CongTyBaoHiemTuNhanId = o.CongTyBaoHiemTuNhanId, SoTienCongNoChoThu = o.SoTien }).ToList(),
                    CheckedDefault = true,
                });

            var chiPhiTrongGois = dichVuKhams.Concat(dichVuKyThuats).ToList();

            var goiDvIds = chiPhiTrongGois.Select(o => o.YeuCauGoiDichVuId).Distinct().ToList();
            var goiDvs = goiDvIds.Any() ?
                _yeuCauGoiDichVuRepository.Table.Where(o => goiDvIds.Contains(o.Id)).Include(o => o.ChuongTrinhGoiDichVu).Include(o => o.TaiKhoanBenhNhanThus).Include(o => o.TaiKhoanBenhNhanChis).ToList()
                : new List<YeuCauGoiDichVu>();
            //var tongSoTienQBHYTTrongGoi = Math.Round(chiPhiTrongGois.Where(o => o.KiemTraBHYTXacNhan).Select(o => o.BHYTThanhToan).DefaultIfEmpty().Sum(), MidpointRounding.AwayFromZero);

            decimal soTienHoanUng = 0;
            foreach (var goiDv in goiDvs)
            {
                if (goiDv.ChuongTrinhGoiDichVu?.CongTyBaoHiemTuNhanId != null)
                    continue;
                soTienHoanUng += Math.Round(chiPhiTrongGois.Where(o => o.YeuCauGoiDichVuId == goiDv.Id).Select(o => o.BHYTThanhToan).DefaultIfEmpty().Sum(), MidpointRounding.AwayFromZero);
                soTienHoanUng += Math.Round(chiPhiTrongGois.Where(o => o.YeuCauGoiDichVuId == goiDv.Id).Select(o => o.TongCongNo).DefaultIfEmpty().Sum(), MidpointRounding.AwayFromZero);
            }

            if ((!thuPhiKhamChuaBenhVo.SoTienCongNo.GetValueOrDefault().SoTienTuongDuong(0) && thuPhiKhamChuaBenhVo.SoTienCongNo.GetValueOrDefault() > soTienCanThu)
                || (soTienDaTamUng + thuPhiKhamChuaBenhVo.SoTienCongNo.GetValueOrDefault() + soTienHoanUng >= soTienCanThu && !tongThuBenhNhan.SoTienTuongDuong(0))
                || (soTienDaTamUng + thuPhiKhamChuaBenhVo.SoTienCongNo.GetValueOrDefault() + soTienHoanUng < soTienCanThu && !soTienCanThu.SoTienTuongDuong(tongThuBenhNhan + thuPhiKhamChuaBenhVo.SoTienCongNo.GetValueOrDefault() + soTienDaTamUng + soTienHoanUng)))
                return new KetQuaThuPhiKhamChuaBenhNgoaiTruVaQuyetToanDichVuTrongGoiVo { Error = "Số tiền thanh toán không hợp lệ" };
            //var soTienMienGiam = dsChiPhiDaChon.Sum(o => o.SoTienMG);



            //thu trong goi
            TaiKhoanBenhNhanThu thuPhi = null;
            if (chiPhiTrongGois.Any())
            {
                if (chiPhiTrongGois.Any(o => o.DuocHuongBHYT && !o.KiemTraBHYTXacNhan))
                {
                    return new KetQuaThuPhiKhamChuaBenhNgoaiTruVaQuyetToanDichVuTrongGoiVo { Error = "Có dịch vụ trong gói chưa được duyệt BHYT" };
                }

                foreach (var chiPhiTrongGoi in chiPhiTrongGois)
                {
                    var congTyBaoHiemTuNhanBaoLanh = ycTiepNhan.YeuCauTiepNhanCongTyBaoHiemTuNhans.FirstOrDefault(o => GetChuongTrinhGoiDichVuBHTNBaoLanhs().Any(ct => ct.CongTyBaoHiemTuNhanId == o.CongTyBaoHiemTuNhanId && ct.Id == chiPhiTrongGoi.ChuongTrinhGoiDichVuId));

                    if (congTyBaoHiemTuNhanBaoLanh != null)
                    {
                        chiPhiTrongGoi.DanhSachCongNoChoThus.Add(new DanhSachCongNoVo { CongTyBaoHiemTuNhanId = congTyBaoHiemTuNhanBaoLanh.CongTyBaoHiemTuNhanId, SoTienCongNoChoThu = chiPhiTrongGoi.SoTienQuyetToan });
                    }
                }

                //var goiDvIds = chiPhiTrongGois.Select(o => o.YeuCauGoiDichVuId).Distinct();
                //var goiDvs = await _yeuCauGoiDichVuRepository.Table.Where(o => goiDvIds.Contains(o.Id))
                //    .Include(o => o.TaiKhoanBenhNhanThus).Include(o => o.TaiKhoanBenhNhanChis).ToListAsync();

                //foreach (var goiDv in goiDvs)
                //{
                //    //update BVHD-3584
                //    //var soTienDaQuyetToan = goiDv.TaiKhoanBenhNhanThus
                //    //    .Where(o => o.DaHuy != true && o.LoaiThuTienBenhNhan == Enums.LoaiThuTienBenhNhan.ThuTheoChiPhi && o.ThuTienGoiDichVu == true)
                //    //    .Select(o => o.TienMat.GetValueOrDefault()).DefaultIfEmpty().Sum();
                //    var soTienQuyetToan = chiPhiTrongGois.Where(o => o.YeuCauGoiDichVuId == goiDv.Id)
                //        .Select(o => o.SoTienQuyetToan).DefaultIfEmpty().Sum();
                //    if (goiDv.SoTienBenhNhanDaChi.GetValueOrDefault() < soTienQuyetToan)
                //    {
                //        return new KetQuaThuPhiKhamChuaBenhNgoaiTruVaQuyetToanDichVuTrongGoiVo { Error = $"Số tiền đã tạm ứng trong gói {goiDv.TenChuongTrinh} không đủ quyết toán" };
                //    }
                //}

                thuPhi = new TaiKhoanBenhNhanThu
                {
                    TaiKhoanBenhNhan = tk,
                    LoaiThuTienBenhNhan = Enums.LoaiThuTienBenhNhan.ThuTheoChiPhi,
                    ThuTienGoiDichVu = true,
                    LoaiNoiThu = Enums.LoaiNoiThu.ThuNgan,
                    NoiDungThu = thuPhiKhamChuaBenhVo.NoiDungThu,
                    NgayThu = thuPhiKhamChuaBenhVo.NgayThu,
                    //update BVHD-3584
                    TamUng = 0,
                    //TamUng = chiPhiTrongGois.Sum(o => o.SoTienQuyetToan),
                    SoPhieuHienThi = ResourceHelper.CreateSoPhieuThu(userId, maTaiKhoan),
                    NhanVienThucHienId = _userAgentHelper.GetCurrentUserId(),
                    NoiThucHienId = _userAgentHelper.GetCurrentNoiLLamViecId()
                };
                foreach (var goiDvId in goiDvIds)
                {
                    decimal tamUngTheoGoi = 0;
                    var goiDv = goiDvs.First(o => o.Id == goiDvId);
                    if (goiDv.ChuongTrinhGoiDichVu?.CongTyBaoHiemTuNhanId != null)
                        continue;
                    var soTienQuyetToan = chiPhiTrongGois.Where(o => o.YeuCauGoiDichVuId == goiDv.Id)
                        .Select(o => o.SoTienQuyetToan).DefaultIfEmpty().Sum();
                    if (soTienQuyetToan > 0)
                    {
                        var phieuHoanUngTrongGoi = new TaiKhoanBenhNhanChi
                        {
                            TaiKhoanBenhNhan = tk,
                            LoaiChiTienBenhNhan = Enums.LoaiChiTienBenhNhan.HoanUng,
                            YeuCauGoiDichVuId = goiDv.Id,
                            TienMat = soTienQuyetToan,
                            NoiDungChi = Enums.LoaiChiTienBenhNhan.HoanUng.GetDescription(),
                            NgayChi = thuPhi.NgayThu.AddMilliseconds(-1),
                            YeuCauTiepNhanId = ycTiepNhan.Id,
                            SoPhieuHienThi = ResourceHelper.CreateSoHoanUng(),
                            NhanVienThucHienId = _userAgentHelper.GetCurrentUserId(),
                            NoiThucHienId = _userAgentHelper.GetCurrentNoiLLamViecId()
                        };
                        thuPhi.TaiKhoanBenhNhanChis.Add(phieuHoanUngTrongGoi);
                        //update BVHD-3584
                        thuPhi.TamUng = thuPhi.TamUng.GetValueOrDefault() + soTienQuyetToan;
                        tamUngTheoGoi += soTienQuyetToan;
                    }
                    //hoan BHYT
                    var soTienQBHYTTrongGoi = Math.Round(chiPhiTrongGois.Where(o => o.YeuCauGoiDichVuId == goiDv.Id).Select(o => o.BHYTThanhToan).DefaultIfEmpty().Sum(), MidpointRounding.AwayFromZero);
                    if (!soTienQBHYTTrongGoi.AlmostEqual(0))
                    {
                        var phieuHoanUngTrongGoi = new TaiKhoanBenhNhanChi
                        {
                            TaiKhoanBenhNhan = tk,
                            LoaiChiTienBenhNhan = Enums.LoaiChiTienBenhNhan.HoanUng,
                            YeuCauGoiDichVuId = goiDv.Id,
                            TienMat = soTienQBHYTTrongGoi,
                            NoiDungChi = Enums.LoaiChiTienBenhNhan.HoanUng.GetDescription() + " BHYT",
                            NgayChi = thuPhi.NgayThu.AddMilliseconds(-1),
                            YeuCauTiepNhanId = ycTiepNhan.Id,
                            SoPhieuHienThi = ResourceHelper.CreateSoHoanUng(),
                            NhanVienThucHienId = _userAgentHelper.GetCurrentUserId(),
                            NoiThucHienId = _userAgentHelper.GetCurrentNoiLLamViecId()
                        };
                        thuPhi.TaiKhoanBenhNhanChis.Add(phieuHoanUngTrongGoi);
                        //update BVHD-3584
                        thuPhi.TamUng = thuPhi.TamUng.GetValueOrDefault() + soTienQBHYTTrongGoi;
                        tamUngTheoGoi += soTienQBHYTTrongGoi;
                    }
                    //hoan BHTN
                    var soTienBHTNTrongGoi = Math.Round(chiPhiTrongGois.Where(o => o.YeuCauGoiDichVuId == goiDv.Id).Select(o => o.TongCongNo).DefaultIfEmpty().Sum(), MidpointRounding.AwayFromZero);
                    if (!soTienBHTNTrongGoi.AlmostEqual(0))
                    {
                        var phieuHoanUngTrongGoi = new TaiKhoanBenhNhanChi
                        {
                            TaiKhoanBenhNhan = tk,
                            LoaiChiTienBenhNhan = Enums.LoaiChiTienBenhNhan.HoanUng,
                            YeuCauGoiDichVuId = goiDv.Id,
                            TienMat = soTienBHTNTrongGoi,
                            NoiDungChi = Enums.LoaiChiTienBenhNhan.HoanUng.GetDescription() + " BHTN",
                            NgayChi = thuPhi.NgayThu.AddMilliseconds(-1),
                            YeuCauTiepNhanId = ycTiepNhan.Id,
                            SoPhieuHienThi = ResourceHelper.CreateSoHoanUng(),
                            NhanVienThucHienId = _userAgentHelper.GetCurrentUserId(),
                            NoiThucHienId = _userAgentHelper.GetCurrentNoiLLamViecId()
                        };
                        thuPhi.TaiKhoanBenhNhanChis.Add(phieuHoanUngTrongGoi);
                        //update BVHD-3584
                        thuPhi.TamUng = thuPhi.TamUng.GetValueOrDefault() + soTienBHTNTrongGoi;
                        tamUngTheoGoi += soTienBHTNTrongGoi;
                    }
                    var soTienDaHoan = goiDv.TaiKhoanBenhNhanChis.Where(o =>
                            o.CreatedOn != null && o.LoaiChiTienBenhNhan == Enums.LoaiChiTienBenhNhan.HoanUng && o.TaiKhoanBenhNhanThuId != null &&
                            o.DaHuy != true)
                        .Select(o => o.TienMat.GetValueOrDefault()).DefaultIfEmpty().Sum();

                    if (goiDv.SoTienBenhNhanDaChi.GetValueOrDefault() + 100 < tamUngTheoGoi + soTienDaHoan)
                    {
                        return new KetQuaThuPhiKhamChuaBenhNgoaiTruVaQuyetToanDichVuTrongGoiVo { Error = $"Số tiền đã tạm ứng trong gói {goiDv.TenChuongTrinh} không đủ quyết toán" };
                    }
                }

                foreach (var chiphi in chiPhiTrongGois.Where(o => o.LoaiNhom == NhomChiPhiKhamChuaBenh.DichVuKhamBenh))
                {
                    var yc = ycTiepNhan.YeuCauKhamBenhs.First(o => o.Id == chiphi.Id);
                    if (yc.NoiDangKyId != null && yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan)
                    {
                        yc.PhongBenhVienHangDois.Add(XepVaoHangDoi(ycTiepNhan, yc.NoiDangKyId.Value));
                    }
                    foreach (var ycCongTyBaoHiemTuNhanCongNo in yc.CongTyBaoHiemTuNhanCongNos.Where(o => o.TaiKhoanBenhNhanThuId == null))
                    {
                        ycCongTyBaoHiemTuNhanCongNo.WillDelete = true;
                    }
                    if (chiphi.TongCongNo > 0)
                    {
                        foreach (var chiphiDanhSachCongNoChoThu in chiphi.DanhSachCongNoChoThus)
                        {
                            if (chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu.AlmostEqual(0))
                                continue;
                            yc.CongTyBaoHiemTuNhanCongNos.Add(new CongTyBaoHiemTuNhanCongNo
                            {
                                TaiKhoanBenhNhanThu = thuPhi,
                                CongTyBaoHiemTuNhanId = chiphiDanhSachCongNoChoThu.CongTyBaoHiemTuNhanId,
                                SoTien = chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu
                            });
                        }
                    }
                    yc.SoTienBaoHiemTuNhanChiTra = chiphi.TongCongNo;

                    yc.SoTienBenhNhanDaChi = chiphi.SoTienQuyetToan;
                    yc.TrangThaiThanhToan = Enums.TrangThaiThanhToan.DaThanhToan;
                    thuPhi.TaiKhoanBenhNhanChis.Add(new TaiKhoanBenhNhanChi
                    {
                        TaiKhoanBenhNhan = tk,
                        LoaiChiTienBenhNhan = Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi,
                        TienChiPhi = yc.SoTienBenhNhanDaChi,
                        NoiDungChi = Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi.GetDescription(),
                        NgayChi = DateTime.Now,
                        SoPhieuHienThi = thuPhi.SoPhieuHienThi,
                        YeuCauKhamBenh = yc,
                        Gia = yc.DonGiaSauChietKhau.GetValueOrDefault(),
                        SoLuong = 1,
                        DonGiaBaoHiem = yc.DonGiaBaoHiem,
                        MucHuongBaoHiem = yc.DuocHuongBaoHiem ? yc.MucHuongBaoHiem : 0,
                        TiLeBaoHiemThanhToan = yc.TiLeBaoHiemThanhToan,
                        SoTienMienGiam = yc.SoTienMienGiam,
                        SoTienBaoHiemTuNhanChiTra = yc.SoTienBaoHiemTuNhanChiTra,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        NhanVienThucHienId = _userAgentHelper.GetCurrentUserId(),
                        NoiThucHienId = _userAgentHelper.GetCurrentNoiLLamViecId()
                    });
                }
                foreach (var chiphi in chiPhiTrongGois.Where(o => o.LoaiNhom == NhomChiPhiKhamChuaBenh.DichVuKyThuat))
                {
                    var yc = ycTiepNhan.YeuCauDichVuKyThuats.First(o => o.Id == chiphi.Id);
                    if (yc.NoiThucHienId != null && yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan)
                    {
                        yc.PhongBenhVienHangDois.Add(XepVaoHangDoi(ycTiepNhan, yc.NoiThucHienId.Value));
                    }
                    foreach (var ycCongTyBaoHiemTuNhanCongNo in yc.CongTyBaoHiemTuNhanCongNos.Where(o => o.TaiKhoanBenhNhanThuId == null))
                    {
                        ycCongTyBaoHiemTuNhanCongNo.WillDelete = true;
                    }
                    if (chiphi.TongCongNo > 0)
                    {
                        foreach (var chiphiDanhSachCongNoChoThu in chiphi.DanhSachCongNoChoThus)
                        {
                            if (chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu.AlmostEqual(0))
                                continue;
                            yc.CongTyBaoHiemTuNhanCongNos.Add(new CongTyBaoHiemTuNhanCongNo
                            {
                                TaiKhoanBenhNhanThu = thuPhi,
                                CongTyBaoHiemTuNhanId = chiphiDanhSachCongNoChoThu.CongTyBaoHiemTuNhanId,
                                SoTien = chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu
                            });
                        }
                    }
                    yc.SoTienBaoHiemTuNhanChiTra = chiphi.TongCongNo;

                    yc.SoTienBenhNhanDaChi = chiphi.SoTienQuyetToan;
                    yc.TrangThaiThanhToan = Enums.TrangThaiThanhToan.DaThanhToan;
                    thuPhi.TaiKhoanBenhNhanChis.Add(new TaiKhoanBenhNhanChi
                    {
                        TaiKhoanBenhNhan = tk,
                        LoaiChiTienBenhNhan = Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi,
                        TienChiPhi = yc.SoTienBenhNhanDaChi,
                        NoiDungChi = Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi.GetDescription(),
                        NgayChi = DateTime.Now,
                        SoPhieuHienThi = thuPhi.SoPhieuHienThi,
                        YeuCauDichVuKyThuat = yc,
                        Gia = yc.DonGiaSauChietKhau.GetValueOrDefault(),
                        SoLuong = yc.SoLan,
                        DonGiaBaoHiem = yc.DonGiaBaoHiem,
                        MucHuongBaoHiem = yc.DuocHuongBaoHiem ? yc.MucHuongBaoHiem : 0,
                        TiLeBaoHiemThanhToan = yc.TiLeBaoHiemThanhToan,
                        SoTienMienGiam = yc.SoTienMienGiam,
                        SoTienBaoHiemTuNhanChiTra = yc.SoTienBaoHiemTuNhanChiTra,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        NhanVienThucHienId = _userAgentHelper.GetCurrentUserId(),
                        NoiThucHienId = _userAgentHelper.GetCurrentNoiLLamViecId()
                    });
                }
                ycTiepNhan.TaiKhoanBenhNhanThus.Add(thuPhi);
            }



            var thuPhiNgoaiGoi = new TaiKhoanBenhNhanThu
            {
                TaiKhoanBenhNhan = tk,
                LoaiThuTienBenhNhan = Enums.LoaiThuTienBenhNhan.ThuTheoChiPhi,
                LoaiNoiThu = Enums.LoaiNoiThu.ThuNgan,
                TienMat = thuPhiKhamChuaBenhVo.TienMat,
                ChuyenKhoan = thuPhiKhamChuaBenhVo.ChuyenKhoan,
                POS = thuPhiKhamChuaBenhVo.POS,
                CongNo = thuPhiKhamChuaBenhVo.SoTienCongNo,
                NoiDungThu = thuPhiKhamChuaBenhVo.NoiDungThu,
                NgayThu = thuPhiKhamChuaBenhVo.NgayThu,
                SoPhieuHienThi = ResourceHelper.CreateSoPhieuThu(userId, maTaiKhoan),
                NhanVienThucHienId = _userAgentHelper.GetCurrentUserId(),
                NoiThucHienId = _userAgentHelper.GetCurrentNoiLLamViecId()
            };

            foreach (var chiphi in dsChiPhiDaChon.Where(o => o.LoaiNhom == NhomChiPhiKhamChuaBenh.DichVuKhamBenh))
            {
                var yc = ycTiepNhan.YeuCauKhamBenhs.First(o => o.Id == chiphi.Id);
                if (yc.NoiDangKyId != null && yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan)
                {
                    yc.PhongBenhVienHangDois.Add(XepVaoHangDoi(ycTiepNhan, yc.NoiDangKyId.Value));
                }
                #region cong no update 02/02/2021
                foreach (var ycCongTyBaoHiemTuNhanCongNo in yc.CongTyBaoHiemTuNhanCongNos.Where(o => o.TaiKhoanBenhNhanThuId == null))
                {
                    ycCongTyBaoHiemTuNhanCongNo.WillDelete = true;
                }
                if (chiphi.TongCongNo > 0)
                {
                    foreach (var chiphiDanhSachCongNoChoThu in chiphi.DanhSachCongNoChoThus)
                    {
                        if (chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu.AlmostEqual(0))
                            continue;
                        yc.CongTyBaoHiemTuNhanCongNos.Add(new CongTyBaoHiemTuNhanCongNo
                        {
                            TaiKhoanBenhNhanThu = thuPhiNgoaiGoi,
                            CongTyBaoHiemTuNhanId = chiphiDanhSachCongNoChoThu.CongTyBaoHiemTuNhanId,
                            SoTien = chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu
                        });
                    }
                }
                yc.SoTienBaoHiemTuNhanChiTra = chiphi.TongCongNo;
                #endregion
                #region mien giam update 02/02/2021
                foreach (var mienGiam in yc.MienGiamChiPhis.Where(o => o.TaiKhoanBenhNhanThuId == null))
                {
                    mienGiam.WillDelete = true;
                }
                //mien giam theo uu dai noi gioi thieu: BVHD-3882
                var mienGiamNoiGioiThieu = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.NoiGioiThieuId != null);
                if (mienGiamNoiGioiThieu != null)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhiNgoaiGoi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                        NoiGioiThieuId = mienGiamNoiGioiThieu.NoiGioiThieuId,
                        LoaiChietKhau = mienGiamNoiGioiThieu.LoaiChietKhau,
                        TiLe = mienGiamNoiGioiThieu.TiLe,
                        SoTien = mienGiamNoiGioiThieu.SoTien
                    });
                }
                //mien giam theo uu dai
                var mienGiamUuDai = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.DoiTuongUuDaiId != null && o.TiLe != 0);
                if (mienGiamUuDai != null)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhiNgoaiGoi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                        DoiTuongUuDaiId = mienGiamUuDai.DoiTuongUuDaiId,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                        TiLe = mienGiamUuDai.TiLe.GetValueOrDefault(),
                        SoTien = mienGiamUuDai.SoTien
                    });
                }
                //mien giam theo voucher
                var mienGiamVouchers = chiphi.DanhSachMienGiamVos.Where(o => o.TheVoucherId != null).ToList();
                foreach (var voucher in mienGiamVouchers)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhiNgoaiGoi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.Voucher,
                        TheVoucherId = voucher.TheVoucherId,
                        LoaiChietKhau = voucher.LoaiChietKhau,
                        MaTheVoucher = voucher.MaTheVoucher,
                        TiLe = voucher.TiLe.GetValueOrDefault(),
                        SoTien = voucher.SoTien
                    });
                }
                //mien giam them theo ti le
                var mienGiamThemTiLe = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoTiLe);
                if (mienGiamThemTiLe != null && mienGiamThemTiLe.TiLe.GetValueOrDefault() != 0)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhiNgoaiGoi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                        TiLe = mienGiamThemTiLe.TiLe,
                        SoTien = mienGiamThemTiLe.SoTien
                    });
                }
                //mien giam them theo so tien
                var mienGiamThemSoTien = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoSoTien);
                if (mienGiamThemSoTien != null && !mienGiamThemSoTien.SoTien.AlmostEqual(0))
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhiNgoaiGoi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        YeuCauGoiDichVuId = mienGiamThemSoTien.YeuCauGoiDichVuId,
                        LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoSoTien,
                        SoTien = mienGiamThemSoTien.SoTien
                    });
                }

                yc.SoTienMienGiam = chiphi.SoTienMG;
                if ((mienGiamThemTiLe?.SoTien ?? 0).AlmostEqual(0) && (mienGiamThemSoTien?.SoTien ?? 0).AlmostEqual(0))
                {
                    yc.GhiChuMienGiamThem = null;
                    yc.NoiDungGhiChuMiemGiamId = null;
                }
                else
                {
                    yc.GhiChuMienGiamThem = chiphi.GhiChuMienGiamThem;
                    yc.NoiDungGhiChuMiemGiamId = chiphi.NoiDungGhiChuMiemGiamId;
                }
                #endregion
                yc.SoTienBenhNhanDaChi = yc.SoTienBenhNhanDaChi.GetValueOrDefault() + chiphi.BNConPhaiThanhToan;
                yc.TrangThaiThanhToan = Enums.TrangThaiThanhToan.DaThanhToan;
                thuPhiNgoaiGoi.TaiKhoanBenhNhanChis.Add(new TaiKhoanBenhNhanChi
                {
                    TaiKhoanBenhNhan = tk,
                    LoaiChiTienBenhNhan = Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi,
                    TienChiPhi = chiphi.BNConPhaiThanhToan,
                    NoiDungChi = Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi.GetDescription(),
                    NgayChi = DateTime.Now,
                    SoPhieuHienThi = thuPhiNgoaiGoi.SoPhieuHienThi,
                    YeuCauKhamBenh = yc,
                    Gia = yc.Gia,
                    SoLuong = 1,
                    DonGiaBaoHiem = yc.DonGiaBaoHiem,
                    MucHuongBaoHiem = yc.DuocHuongBaoHiem ? yc.MucHuongBaoHiem : 0,
                    TiLeBaoHiemThanhToan = yc.TiLeBaoHiemThanhToan,
                    SoTienMienGiam = yc.SoTienMienGiam,
                    SoTienBaoHiemTuNhanChiTra = yc.SoTienBaoHiemTuNhanChiTra,
                    YeuCauTiepNhanId = ycTiepNhan.Id,
                    NhanVienThucHienId = _userAgentHelper.GetCurrentUserId(),
                    NoiThucHienId = _userAgentHelper.GetCurrentNoiLLamViecId()
                });
            }

            foreach (var chiphi in dsChiPhiDaChon.Where(o => o.LoaiNhom == NhomChiPhiKhamChuaBenh.DichVuKyThuat))
            {
                var yc = ycTiepNhan.YeuCauDichVuKyThuats.First(o => o.Id == chiphi.Id);
                if (yc.NoiThucHienId != null && yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan)
                {
                    yc.PhongBenhVienHangDois.Add(XepVaoHangDoi(ycTiepNhan, yc.NoiThucHienId.Value));
                }
                #region cong no update 02/02/2021
                foreach (var ycCongTyBaoHiemTuNhanCongNo in yc.CongTyBaoHiemTuNhanCongNos.Where(o => o.TaiKhoanBenhNhanThuId == null))
                {
                    ycCongTyBaoHiemTuNhanCongNo.WillDelete = true;
                }
                if (chiphi.TongCongNo > 0)
                {
                    foreach (var chiphiDanhSachCongNoChoThu in chiphi.DanhSachCongNoChoThus)
                    {
                        if (chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu.AlmostEqual(0))
                            continue;
                        yc.CongTyBaoHiemTuNhanCongNos.Add(new CongTyBaoHiemTuNhanCongNo
                        {
                            TaiKhoanBenhNhanThu = thuPhiNgoaiGoi,
                            CongTyBaoHiemTuNhanId = chiphiDanhSachCongNoChoThu.CongTyBaoHiemTuNhanId,
                            SoTien = chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu
                        });
                    }
                }
                yc.SoTienBaoHiemTuNhanChiTra = chiphi.TongCongNo;
                #endregion
                #region mien giam update 02/02/2021
                foreach (var mienGiam in yc.MienGiamChiPhis.Where(o => o.TaiKhoanBenhNhanThuId == null))
                {
                    mienGiam.WillDelete = true;
                }
                //mien giam theo uu dai noi gioi thieu: BVHD-3882
                var mienGiamNoiGioiThieu = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.NoiGioiThieuId != null);
                if (mienGiamNoiGioiThieu != null)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhiNgoaiGoi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                        NoiGioiThieuId = mienGiamNoiGioiThieu.NoiGioiThieuId,
                        LoaiChietKhau = mienGiamNoiGioiThieu.LoaiChietKhau,
                        TiLe = mienGiamNoiGioiThieu.TiLe,
                        SoTien = mienGiamNoiGioiThieu.SoTien
                    });
                }
                //mien giam theo uu dai
                var mienGiamUuDai = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.DoiTuongUuDaiId != null && o.TiLe != 0);
                if (mienGiamUuDai != null)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhiNgoaiGoi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                        DoiTuongUuDaiId = mienGiamUuDai.DoiTuongUuDaiId,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                        TiLe = mienGiamUuDai.TiLe.GetValueOrDefault(),
                        SoTien = mienGiamUuDai.SoTien
                    });
                }
                //mien giam theo voucher
                var mienGiamVouchers = chiphi.DanhSachMienGiamVos.Where(o => o.TheVoucherId != null).ToList();
                foreach (var voucher in mienGiamVouchers)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhiNgoaiGoi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.Voucher,
                        TheVoucherId = voucher.TheVoucherId,
                        LoaiChietKhau = voucher.LoaiChietKhau,
                        MaTheVoucher = voucher.MaTheVoucher,
                        TiLe = voucher.TiLe.GetValueOrDefault(),
                        SoTien = voucher.SoTien
                    });
                }
                //mien giam them theo ti le
                var mienGiamThemTiLe = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoTiLe);
                if (mienGiamThemTiLe != null && mienGiamThemTiLe.TiLe.GetValueOrDefault() != 0)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhiNgoaiGoi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                        TiLe = mienGiamThemTiLe.TiLe,
                        SoTien = mienGiamThemTiLe.SoTien
                    });
                }
                //mien giam them theo so tien
                var mienGiamThemSoTien = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoSoTien);
                if (mienGiamThemSoTien != null && !mienGiamThemSoTien.SoTien.AlmostEqual(0))
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhiNgoaiGoi,
                        YeuCauGoiDichVuId = mienGiamThemSoTien.YeuCauGoiDichVuId,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoSoTien,
                        SoTien = mienGiamThemSoTien.SoTien
                    });
                }

                yc.SoTienMienGiam = chiphi.SoTienMG;
                if ((mienGiamThemTiLe?.SoTien ?? 0).AlmostEqual(0) && (mienGiamThemSoTien?.SoTien ?? 0).AlmostEqual(0))
                {
                    yc.GhiChuMienGiamThem = null;
                    yc.NoiDungGhiChuMiemGiamId = null;
                }
                else
                {
                    yc.GhiChuMienGiamThem = chiphi.GhiChuMienGiamThem;
                    yc.NoiDungGhiChuMiemGiamId = chiphi.NoiDungGhiChuMiemGiamId;
                }
                #endregion
                yc.SoTienBenhNhanDaChi = yc.SoTienBenhNhanDaChi.GetValueOrDefault() + chiphi.BNConPhaiThanhToan;
                yc.TrangThaiThanhToan = Enums.TrangThaiThanhToan.DaThanhToan;
                thuPhiNgoaiGoi.TaiKhoanBenhNhanChis.Add(new TaiKhoanBenhNhanChi
                {
                    TaiKhoanBenhNhan = tk,
                    LoaiChiTienBenhNhan = Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi,
                    TienChiPhi = chiphi.BNConPhaiThanhToan,
                    NoiDungChi = Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi.GetDescription(),
                    NgayChi = DateTime.Now,
                    SoPhieuHienThi = thuPhiNgoaiGoi.SoPhieuHienThi,
                    YeuCauDichVuKyThuat = yc,
                    Gia = yc.Gia,
                    SoLuong = yc.SoLan,
                    DonGiaBaoHiem = yc.DonGiaBaoHiem,
                    MucHuongBaoHiem = yc.DuocHuongBaoHiem ? yc.MucHuongBaoHiem : 0,
                    TiLeBaoHiemThanhToan = yc.TiLeBaoHiemThanhToan,
                    SoTienMienGiam = yc.SoTienMienGiam,
                    SoTienBaoHiemTuNhanChiTra = yc.SoTienBaoHiemTuNhanChiTra,
                    YeuCauTiepNhanId = ycTiepNhan.Id,
                    NhanVienThucHienId = _userAgentHelper.GetCurrentUserId(),
                    NoiThucHienId = _userAgentHelper.GetCurrentNoiLLamViecId()
                });
            }

            foreach (var chiphi in dsChiPhiDaChon.Where(o => o.LoaiNhom == NhomChiPhiKhamChuaBenh.DuocPham))
            {
                var yc = ycTiepNhan.YeuCauDuocPhamBenhViens.First(o => o.Id == chiphi.Id);
                #region cong no update 02/02/2021
                foreach (var ycCongTyBaoHiemTuNhanCongNo in yc.CongTyBaoHiemTuNhanCongNos.Where(o => o.TaiKhoanBenhNhanThuId == null))
                {
                    ycCongTyBaoHiemTuNhanCongNo.WillDelete = true;
                }
                if (chiphi.TongCongNo > 0)
                {
                    foreach (var chiphiDanhSachCongNoChoThu in chiphi.DanhSachCongNoChoThus)
                    {
                        if (chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu.AlmostEqual(0))
                            continue;
                        yc.CongTyBaoHiemTuNhanCongNos.Add(new CongTyBaoHiemTuNhanCongNo
                        {
                            TaiKhoanBenhNhanThu = thuPhiNgoaiGoi,
                            CongTyBaoHiemTuNhanId = chiphiDanhSachCongNoChoThu.CongTyBaoHiemTuNhanId,
                            SoTien = chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu
                        });
                    }
                }
                yc.SoTienBaoHiemTuNhanChiTra = chiphi.TongCongNo;
                #endregion
                #region mien giam update 02/02/2021
                foreach (var mienGiam in yc.MienGiamChiPhis.Where(o => o.TaiKhoanBenhNhanThuId == null))
                {
                    mienGiam.WillDelete = true;
                }
                //mien giam theo uu dai noi gioi thieu: BVHD-3882
                var mienGiamNoiGioiThieu = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.NoiGioiThieuId != null);
                if (mienGiamNoiGioiThieu != null)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhiNgoaiGoi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                        NoiGioiThieuId = mienGiamNoiGioiThieu.NoiGioiThieuId,
                        LoaiChietKhau = mienGiamNoiGioiThieu.LoaiChietKhau,
                        TiLe = mienGiamNoiGioiThieu.TiLe,
                        SoTien = mienGiamNoiGioiThieu.SoTien
                    });
                }
                //mien giam theo uu dai
                var mienGiamUuDai = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.DoiTuongUuDaiId != null && o.TiLe != 0);
                if (mienGiamUuDai != null)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhiNgoaiGoi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                        DoiTuongUuDaiId = mienGiamUuDai.DoiTuongUuDaiId,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                        TiLe = mienGiamUuDai.TiLe.GetValueOrDefault(),
                        SoTien = mienGiamUuDai.SoTien
                    });
                }
                //mien giam theo voucher
                var mienGiamVouchers = chiphi.DanhSachMienGiamVos.Where(o => o.TheVoucherId != null).ToList();
                foreach (var voucher in mienGiamVouchers)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhiNgoaiGoi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.Voucher,
                        TheVoucherId = voucher.TheVoucherId,
                        LoaiChietKhau = voucher.LoaiChietKhau,
                        MaTheVoucher = voucher.MaTheVoucher,
                        TiLe = voucher.TiLe.GetValueOrDefault(),
                        SoTien = voucher.SoTien
                    });
                }
                //mien giam them theo ti le
                var mienGiamThemTiLe = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoTiLe);
                if (mienGiamThemTiLe != null && mienGiamThemTiLe.TiLe.GetValueOrDefault() != 0)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhiNgoaiGoi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                        TiLe = mienGiamThemTiLe.TiLe,
                        SoTien = mienGiamThemTiLe.SoTien
                    });
                }
                //mien giam them theo so tien
                var mienGiamThemSoTien = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoSoTien);
                if (mienGiamThemSoTien != null && !mienGiamThemSoTien.SoTien.AlmostEqual(0))
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhiNgoaiGoi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoSoTien,
                        SoTien = mienGiamThemSoTien.SoTien
                    });
                }

                yc.SoTienMienGiam = chiphi.SoTienMG;
                if ((mienGiamThemTiLe?.SoTien ?? 0).AlmostEqual(0) && (mienGiamThemSoTien?.SoTien ?? 0).AlmostEqual(0))
                {
                    yc.GhiChuMienGiamThem = null;
                    yc.NoiDungGhiChuMiemGiamId = null;
                }
                else
                {
                    yc.GhiChuMienGiamThem = chiphi.GhiChuMienGiamThem;
                    yc.NoiDungGhiChuMiemGiamId = chiphi.NoiDungGhiChuMiemGiamId;
                }
                #endregion
                yc.SoTienBenhNhanDaChi = yc.SoTienBenhNhanDaChi.GetValueOrDefault() + chiphi.BNConPhaiThanhToan;
                yc.TrangThaiThanhToan = Enums.TrangThaiThanhToan.DaThanhToan;
                thuPhiNgoaiGoi.TaiKhoanBenhNhanChis.Add(new TaiKhoanBenhNhanChi
                {
                    TaiKhoanBenhNhan = tk,
                    LoaiChiTienBenhNhan = Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi,
                    TienChiPhi = chiphi.BNConPhaiThanhToan,
                    NoiDungChi = Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi.GetDescription(),
                    NgayChi = DateTime.Now,
                    SoPhieuHienThi = thuPhiNgoaiGoi.SoPhieuHienThi,
                    YeuCauDuocPhamBenhVien = yc,
                    Gia = yc.DonGiaBan,
                    SoLuong = yc.SoLuong,
                    DonGiaBaoHiem = yc.DonGiaBaoHiem,
                    MucHuongBaoHiem = yc.DuocHuongBaoHiem ? yc.MucHuongBaoHiem : 0,
                    TiLeBaoHiemThanhToan = yc.TiLeBaoHiemThanhToan,
                    SoTienMienGiam = yc.SoTienMienGiam,
                    SoTienBaoHiemTuNhanChiTra = yc.SoTienBaoHiemTuNhanChiTra,
                    YeuCauTiepNhanId = ycTiepNhan.Id,
                    NhanVienThucHienId = _userAgentHelper.GetCurrentUserId(),
                    NoiThucHienId = _userAgentHelper.GetCurrentNoiLLamViecId()
                });
            }

            foreach (var chiphi in dsChiPhiDaChon.Where(o => o.LoaiNhom == NhomChiPhiKhamChuaBenh.VatTuTieuHao))
            {
                var yc = ycTiepNhan.YeuCauVatTuBenhViens.First(o => o.Id == chiphi.Id);
                #region cong no update 02/02/2021
                foreach (var ycCongTyBaoHiemTuNhanCongNo in yc.CongTyBaoHiemTuNhanCongNos.Where(o => o.TaiKhoanBenhNhanThuId == null))
                {
                    ycCongTyBaoHiemTuNhanCongNo.WillDelete = true;
                }
                if (chiphi.TongCongNo > 0)
                {
                    foreach (var chiphiDanhSachCongNoChoThu in chiphi.DanhSachCongNoChoThus)
                    {
                        if (chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu.AlmostEqual(0))
                            continue;
                        yc.CongTyBaoHiemTuNhanCongNos.Add(new CongTyBaoHiemTuNhanCongNo
                        {
                            TaiKhoanBenhNhanThu = thuPhiNgoaiGoi,
                            CongTyBaoHiemTuNhanId = chiphiDanhSachCongNoChoThu.CongTyBaoHiemTuNhanId,
                            SoTien = chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu
                        });
                    }
                }
                yc.SoTienBaoHiemTuNhanChiTra = chiphi.TongCongNo;
                #endregion
                #region mien giam update 02/02/2021
                foreach (var mienGiam in yc.MienGiamChiPhis.Where(o => o.TaiKhoanBenhNhanThuId == null))
                {
                    mienGiam.WillDelete = true;
                }
                //mien giam theo uu dai noi gioi thieu: BVHD-3882
                var mienGiamNoiGioiThieu = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.NoiGioiThieuId != null);
                if (mienGiamNoiGioiThieu != null)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhiNgoaiGoi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                        NoiGioiThieuId = mienGiamNoiGioiThieu.NoiGioiThieuId,
                        LoaiChietKhau = mienGiamNoiGioiThieu.LoaiChietKhau,
                        TiLe = mienGiamNoiGioiThieu.TiLe,
                        SoTien = mienGiamNoiGioiThieu.SoTien
                    });
                }
                //mien giam theo uu dai
                var mienGiamUuDai = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.DoiTuongUuDaiId != null && o.TiLe != 0);
                if (mienGiamUuDai != null)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhiNgoaiGoi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                        DoiTuongUuDaiId = mienGiamUuDai.DoiTuongUuDaiId,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                        TiLe = mienGiamUuDai.TiLe.GetValueOrDefault(),
                        SoTien = mienGiamUuDai.SoTien
                    });
                }
                //mien giam theo voucher
                var mienGiamVouchers = chiphi.DanhSachMienGiamVos.Where(o => o.TheVoucherId != null).ToList();
                foreach (var voucher in mienGiamVouchers)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhiNgoaiGoi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.Voucher,
                        TheVoucherId = voucher.TheVoucherId,
                        LoaiChietKhau = voucher.LoaiChietKhau,
                        MaTheVoucher = voucher.MaTheVoucher,
                        TiLe = voucher.TiLe.GetValueOrDefault(),
                        SoTien = voucher.SoTien
                    });
                }
                //mien giam them theo ti le
                var mienGiamThemTiLe = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoTiLe);
                if (mienGiamThemTiLe != null && mienGiamThemTiLe.TiLe.GetValueOrDefault() != 0)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhiNgoaiGoi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                        TiLe = mienGiamThemTiLe.TiLe,
                        SoTien = mienGiamThemTiLe.SoTien
                    });
                }
                //mien giam them theo so tien
                var mienGiamThemSoTien = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoSoTien);
                if (mienGiamThemSoTien != null && !mienGiamThemSoTien.SoTien.AlmostEqual(0))
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhiNgoaiGoi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoSoTien,
                        SoTien = mienGiamThemSoTien.SoTien
                    });
                }

                yc.SoTienMienGiam = chiphi.SoTienMG;
                if ((mienGiamThemTiLe?.SoTien ?? 0).AlmostEqual(0) && (mienGiamThemSoTien?.SoTien ?? 0).AlmostEqual(0))
                {
                    yc.GhiChuMienGiamThem = null;
                    yc.NoiDungGhiChuMiemGiamId = null;
                }
                else
                {
                    yc.GhiChuMienGiamThem = chiphi.GhiChuMienGiamThem;
                    yc.NoiDungGhiChuMiemGiamId = chiphi.NoiDungGhiChuMiemGiamId;
                }
                #endregion
                yc.SoTienBenhNhanDaChi = yc.SoTienBenhNhanDaChi.GetValueOrDefault() + chiphi.BNConPhaiThanhToan;
                yc.TrangThaiThanhToan = Enums.TrangThaiThanhToan.DaThanhToan;
                thuPhiNgoaiGoi.TaiKhoanBenhNhanChis.Add(new TaiKhoanBenhNhanChi
                {
                    TaiKhoanBenhNhan = tk,
                    LoaiChiTienBenhNhan = Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi,
                    TienChiPhi = chiphi.BNConPhaiThanhToan,
                    NoiDungChi = Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi.GetDescription(),
                    NgayChi = DateTime.Now,
                    SoPhieuHienThi = thuPhiNgoaiGoi.SoPhieuHienThi,
                    YeuCauVatTuBenhVien = yc,
                    Gia = yc.DonGiaBan,
                    SoLuong = yc.SoLuong,
                    DonGiaBaoHiem = yc.DonGiaBaoHiem,
                    MucHuongBaoHiem = yc.DuocHuongBaoHiem ? yc.MucHuongBaoHiem : 0,
                    TiLeBaoHiemThanhToan = yc.TiLeBaoHiemThanhToan,
                    SoTienMienGiam = yc.SoTienMienGiam,
                    SoTienBaoHiemTuNhanChiTra = yc.SoTienBaoHiemTuNhanChiTra,
                    YeuCauTiepNhanId = ycTiepNhan.Id,
                    NhanVienThucHienId = _userAgentHelper.GetCurrentUserId(),
                    NoiThucHienId = _userAgentHelper.GetCurrentNoiLLamViecId()
                });
            }

            foreach (var chiphi in dsChiPhiDaChon.Where(o => o.LoaiNhom == NhomChiPhiKhamChuaBenh.ToaThuoc))
            {
                var yc = ycTiepNhan.DonThuocThanhToans.SelectMany(o => o.DonThuocThanhToanChiTiets).First(o => o.Id == chiphi.Id);
                #region cong no update 02/02/2021
                foreach (var ycCongTyBaoHiemTuNhanCongNo in yc.CongTyBaoHiemTuNhanCongNos.Where(o => o.TaiKhoanBenhNhanThuId == null))
                {
                    ycCongTyBaoHiemTuNhanCongNo.WillDelete = true;
                }
                if (chiphi.TongCongNo > 0)
                {
                    foreach (var chiphiDanhSachCongNoChoThu in chiphi.DanhSachCongNoChoThus)
                    {
                        if (chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu.AlmostEqual(0))
                            continue;
                        yc.CongTyBaoHiemTuNhanCongNos.Add(new CongTyBaoHiemTuNhanCongNo
                        {
                            TaiKhoanBenhNhanThu = thuPhiNgoaiGoi,
                            CongTyBaoHiemTuNhanId = chiphiDanhSachCongNoChoThu.CongTyBaoHiemTuNhanId,
                            SoTien = chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu
                        });
                    }
                }
                yc.SoTienBaoHiemTuNhanChiTra = chiphi.TongCongNo;
                #endregion
                #region mien giam update 02/02/2021
                foreach (var mienGiam in yc.MienGiamChiPhis.Where(o => o.TaiKhoanBenhNhanThuId == null))
                {
                    mienGiam.WillDelete = true;
                }
                //mien giam theo uu dai noi gioi thieu: BVHD-3882
                var mienGiamNoiGioiThieu = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.NoiGioiThieuId != null);
                if (mienGiamNoiGioiThieu != null)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhiNgoaiGoi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                        NoiGioiThieuId = mienGiamNoiGioiThieu.NoiGioiThieuId,
                        LoaiChietKhau = mienGiamNoiGioiThieu.LoaiChietKhau,
                        TiLe = mienGiamNoiGioiThieu.TiLe,
                        SoTien = mienGiamNoiGioiThieu.SoTien
                    });
                }
                //mien giam theo uu dai
                var mienGiamUuDai = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.DoiTuongUuDaiId != null && o.TiLe != 0);
                if (mienGiamUuDai != null)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhiNgoaiGoi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                        DoiTuongUuDaiId = mienGiamUuDai.DoiTuongUuDaiId,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                        TiLe = mienGiamUuDai.TiLe.GetValueOrDefault(),
                        SoTien = mienGiamUuDai.SoTien
                    });
                }
                //mien giam theo voucher
                var mienGiamVouchers = chiphi.DanhSachMienGiamVos.Where(o => o.TheVoucherId != null).ToList();
                foreach (var voucher in mienGiamVouchers)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhiNgoaiGoi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.Voucher,
                        TheVoucherId = voucher.TheVoucherId,
                        LoaiChietKhau = voucher.LoaiChietKhau,
                        MaTheVoucher = voucher.MaTheVoucher,
                        TiLe = voucher.TiLe.GetValueOrDefault(),
                        SoTien = voucher.SoTien
                    });
                }
                //mien giam them theo ti le
                var mienGiamThemTiLe = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoTiLe);
                if (mienGiamThemTiLe != null && mienGiamThemTiLe.TiLe.GetValueOrDefault() != 0)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhiNgoaiGoi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                        TiLe = mienGiamThemTiLe.TiLe,
                        SoTien = mienGiamThemTiLe.SoTien
                    });
                }
                //mien giam them theo so tien
                var mienGiamThemSoTien = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoSoTien);
                if (mienGiamThemSoTien != null && !mienGiamThemSoTien.SoTien.AlmostEqual(0))
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhiNgoaiGoi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoSoTien,
                        SoTien = mienGiamThemSoTien.SoTien
                    });
                }

                yc.SoTienMienGiam = chiphi.SoTienMG;
                if ((mienGiamThemTiLe?.SoTien ?? 0).AlmostEqual(0) && (mienGiamThemSoTien?.SoTien ?? 0).AlmostEqual(0))
                {
                    yc.GhiChuMienGiamThem = null;
                    yc.NoiDungGhiChuMiemGiamId = null;
                }
                else
                {
                    yc.GhiChuMienGiamThem = chiphi.GhiChuMienGiamThem;
                    yc.NoiDungGhiChuMiemGiamId = chiphi.NoiDungGhiChuMiemGiamId;
                }
                #endregion
                yc.SoTienBenhNhanDaChi = yc.SoTienBenhNhanDaChi.GetValueOrDefault() + chiphi.BNConPhaiThanhToan;
                yc.DonThuocThanhToan.TrangThaiThanhToan = Enums.TrangThaiThanhToan.DaThanhToan;
                var donThuocThanhToanChiTietTheoPhieuThu = yc.Map<DonThuocThanhToanChiTietTheoPhieuThu>();
                donThuocThanhToanChiTietTheoPhieuThu.NgayPhatSinh = yc.CreatedOn ?? DateTime.Now;
                donThuocThanhToanChiTietTheoPhieuThu.LoaiDonThuoc = yc.DonThuocThanhToan.LoaiDonThuoc;
                var ttNhapThuoc = yc.XuatKhoDuocPhamChiTietViTri.NhapKhoDuocPhamChiTiet;
                donThuocThanhToanChiTietTheoPhieuThu.Solo = ttNhapThuoc.Solo;
                donThuocThanhToanChiTietTheoPhieuThu.MaVach = ttNhapThuoc.MaVach;
                donThuocThanhToanChiTietTheoPhieuThu.HanSuDung = ttNhapThuoc.HanSuDung;
                donThuocThanhToanChiTietTheoPhieuThu.NgayNhapVaoBenhVien = ttNhapThuoc.NgayNhapVaoBenhVien;
                donThuocThanhToanChiTietTheoPhieuThu.SoLuongToa = yc.YeuCauKhamBenhDonThuocChiTiet?.SoLuong;
                donThuocThanhToanChiTietTheoPhieuThu.BacSiKeDonId = yc.YeuCauKhamBenhDonThuocChiTiet?.YeuCauKhamBenhDonThuoc.BacSiKeDonId;
                donThuocThanhToanChiTietTheoPhieuThu.ThoiDiemKeDon = yc.YeuCauKhamBenhDonThuocChiTiet?.YeuCauKhamBenhDonThuoc.ThoiDiemKeDon;

                thuPhiNgoaiGoi.TaiKhoanBenhNhanChis.Add(new TaiKhoanBenhNhanChi
                {
                    TaiKhoanBenhNhan = tk,
                    LoaiChiTienBenhNhan = Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi,
                    TienChiPhi = chiphi.BNConPhaiThanhToan,
                    NoiDungChi = Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi.GetDescription(),
                    NgayChi = DateTime.Now,
                    SoPhieuHienThi = thuPhiNgoaiGoi.SoPhieuHienThi,
                    DonThuocThanhToanChiTiet = yc,
                    DonThuocThanhToanChiTietTheoPhieuThu = donThuocThanhToanChiTietTheoPhieuThu,
                    Gia = yc.DonGiaBan,
                    SoLuong = yc.SoLuong,
                    DonGiaBaoHiem = yc.DonGiaBaoHiem,
                    MucHuongBaoHiem = yc.DuocHuongBaoHiem ? yc.MucHuongBaoHiem : 0,
                    TiLeBaoHiemThanhToan = yc.TiLeBaoHiemThanhToan,
                    SoTienMienGiam = yc.SoTienMienGiam,
                    SoTienBaoHiemTuNhanChiTra = yc.SoTienBaoHiemTuNhanChiTra,
                    YeuCauTiepNhanId = ycTiepNhan.Id,
                    NhanVienThucHienId = _userAgentHelper.GetCurrentUserId(),
                    NoiThucHienId = _userAgentHelper.GetCurrentNoiLLamViecId()
                });
            }

            TaiKhoanBenhNhanChi phieuHoanUng = null;
            if (thuTamUng.Any())
            {
                thuPhiNgoaiGoi.TamUng = soTienDaTamUng;
                phieuHoanUng = new TaiKhoanBenhNhanChi
                {
                    TaiKhoanBenhNhan = tk,
                    LoaiChiTienBenhNhan = Enums.LoaiChiTienBenhNhan.HoanUng,
                    TienMat = soTienDaTamUng,
                    NoiDungChi = Enums.LoaiChiTienBenhNhan.HoanUng.GetDescription(),
                    NgayChi = thuPhiNgoaiGoi.NgayThu.AddMilliseconds(-1),
                    YeuCauTiepNhanId = ycTiepNhan.Id,
                    SoPhieuHienThi = ResourceHelper.CreateSoHoanUng(),
                    NhanVienThucHienId = _userAgentHelper.GetCurrentUserId(),
                    NoiThucHienId = _userAgentHelper.GetCurrentNoiLLamViecId()
                };
                thuPhiNgoaiGoi.TaiKhoanBenhNhanChis.Add(phieuHoanUng);

                foreach (var taiKhoanBenhNhanThu in ycTiepNhan.TaiKhoanBenhNhanThus.Where(o => o.DaHuy != true && o.LoaiThuTienBenhNhan == Enums.LoaiThuTienBenhNhan.ThuTamUng && o.ThuTienGoiDichVu != true && o.PhieuHoanUngId == null))
                {
                    taiKhoanBenhNhanThu.PhieuHoanUng = phieuHoanUng;
                }
            }
            tk.SoDuTaiKhoan -= soTienDaTamUng;
            ycTiepNhan.TaiKhoanBenhNhanThus.Add(thuPhiNgoaiGoi);

            //bỏ tự động nhập viện
            //if (ycTiepNhan.YeuCauKhamBenhs.All(o =>
            //        o.TrangThai == Enums.EnumTrangThaiYeuCauKhamBenh.HuyKham ||
            //        o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.DaThanhToan)
            //    && ycTiepNhan.YeuCauDichVuKyThuats.All(o =>
            //        o.TrangThai == Enums.EnumTrangThaiYeuCauDichVuKyThuat.DaHuy ||
            //        o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.DaThanhToan))
            //{
            //    foreach (var yeuCauKhamBenh in ycTiepNhan.YeuCauKhamBenhs)
            //    {
            //        var yeuCauNhapVien = yeuCauKhamBenh.YeuCauNhapViens.FirstOrDefault(o => !o.YeuCauTiepNhans.Any());
            //        if (yeuCauNhapVien != null)
            //        {
            //            var yeuCauTiepNhanNoiTru = GetYeuCauTiepNhanNoiTru(ycTiepNhan, yeuCauNhapVien);
            //            await BaseRepository.AddAsync(yeuCauTiepNhanNoiTru);
            //            return new KetQuaThuPhiKhamChuaBenhNgoaiTruVo { PhieuThuId = thuPhi.Id, LaPhieuChi = soTienDaTamUng + thuPhiKhamChuaBenhVo.SoTienCongNo.GetValueOrDefault() > soTienCanThu, PhieuHoanUngId = phieuHoanUng?.Id ?? 0 };
            //        }
            //    }
            //}

            //await BaseRepository.UpdateAsync(ycTiepNhan);
            BaseRepository.Context.SaveChanges();
            var phieuThuIds = new List<long>();
            var phieuHoanUngIds = new List<long>();
            if (thuPhi != null)
            {
                phieuThuIds.Add(thuPhi.Id);
                phieuHoanUngIds = thuPhi.TaiKhoanBenhNhanChis.Where(o => o.LoaiChiTienBenhNhan == Enums.LoaiChiTienBenhNhan.HoanUng).Select(o => o.Id).ToList();
            }
            phieuThuIds.Add(thuPhiNgoaiGoi.Id);
            if (phieuHoanUng != null)
            {
                phieuHoanUngIds.Add(phieuHoanUng.Id);
            }
            return new KetQuaThuPhiKhamChuaBenhNgoaiTruVaQuyetToanDichVuTrongGoiVo
            {
                PhieuThuIds = phieuThuIds,
                LaPhieuChi = soTienDaTamUng + thuPhiKhamChuaBenhVo.SoTienCongNo.GetValueOrDefault() > soTienCanThu,
                PhieuHoanUngIds = phieuHoanUngIds
            };
        }

        public async Task<List<ThongTinPhieuThuVo>> GetSoPhieu(DropDownListRequestModel model, long yeuCauTiepNhanId)
        {
            var yeuCauTiepNhan = await BaseRepository.GetByIdAsync(yeuCauTiepNhanId,
                o => o.Include(x => x.TaiKhoanBenhNhanThus).ThenInclude(c => c.PhieuHoanUng)
                    .Include(x => x.TaiKhoanBenhNhanThus).ThenInclude(c => c.NhanVienThucHien).ThenInclude(c => c.User)
                    .Include(x => x.TaiKhoanBenhNhanChis).ThenInclude(c => c.TaiKhoanBenhNhanThu)
                    .Include(x => x.TaiKhoanBenhNhanChis).ThenInclude(c => c.NhanVienThucHien).ThenInclude(c => c.User));
            var phieuThuKhacCuaGoiId = yeuCauTiepNhan.TaiKhoanBenhNhanThus.FirstOrDefault(o =>
                o.LoaiNoiThu == Enums.LoaiNoiThu.ThuNgan &&
                o.LoaiThuTienBenhNhan == Enums.LoaiThuTienBenhNhan.ThuTheoChiPhi &&
                o.TaiKhoanBenhNhanChis.Any(c => c.YeuCauGoiDichVuId != null && c.LoaiChiTienBenhNhan == Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi))?.Id;
            var dsPhieuThu = yeuCauTiepNhan.TaiKhoanBenhNhanThus.Where(o =>
                o.LoaiNoiThu == Enums.LoaiNoiThu.ThuNgan &&
                ((o.LoaiThuTienBenhNhan == Enums.LoaiThuTienBenhNhan.ThuTheoChiPhi && o.Id != phieuThuKhacCuaGoiId.GetValueOrDefault()) || (o.LoaiThuTienBenhNhan == Enums.LoaiThuTienBenhNhan.ThuTamUng && o.ThuTienGoiDichVu != true)));
            var dsPhieuChi = yeuCauTiepNhan.TaiKhoanBenhNhanChis.Where(o =>
                ((o.LoaiChiTienBenhNhan == Enums.LoaiChiTienBenhNhan.HoanUng && o.TaiKhoanBenhNhanThuId != null && o.TaiKhoanBenhNhanThuId != phieuThuKhacCuaGoiId.GetValueOrDefault()) || (o.LoaiChiTienBenhNhan == Enums.LoaiChiTienBenhNhan.HoanUng && o.TaiKhoanBenhNhanThus.Any()) ||
                 (o.LoaiChiTienBenhNhan == Enums.LoaiChiTienBenhNhan.HoanThu && o.TaiKhoanBenhNhanThu?.LoaiNoiThu == Enums.LoaiNoiThu.ThuNgan)));

            var dsPhieu = dsPhieuThu.Select(o => new ThongTinPhieuThuVo
            {
                KeyId = o.Id,
                LoaiPhieuThuChiThuNgan = GetLoaiPhieuThuChi(o.LoaiThuTienBenhNhan),
                LaPhieuChi = o.TamUng.GetValueOrDefault() > o.TienMat.GetValueOrDefault(),
                DisplayName = o.SoPhieuHienThi,
                DaHuy = o.DaHuy,
                DaHoanUng = o.PhieuHoanUngId != null,
                PhieuHoanUng = o.PhieuHoanUng?.SoPhieuHienThi,
                DaThuHoi = o.DaThuHoi,
                NgayLap = o.NgayThu,
                NguoiLap = o.NhanVienThucHien.User.HoTen,
                TrongGoi = o.ThuTienGoiDichVu != null && o.ThuTienGoiDichVu == true,
            })
                .Union(dsPhieuChi.Select(o => new ThongTinPhieuThuVo
                {
                    KeyId = o.Id,
                    LoaiPhieuThuChiThuNgan = GetLoaiPhieuThuChi(o.LoaiChiTienBenhNhan),
                    DisplayName = o.SoPhieuHienThi,
                    DaHuy = o.DaHuy,
                    DaThuHoi = o.DaThuHoi,
                    NgayLap = o.NgayChi,
                    NguoiLap = o.NhanVienThucHien?.User.HoTen
                })).OrderByDescending(o => o.NgayLap).ToList();
            return dsPhieu;
        }
        private LoaiPhieuThuChiThuNgan? GetLoaiPhieuThuChi(Enums.LoaiThuTienBenhNhan loaiThuTienBenhNhan)
        {
            switch (loaiThuTienBenhNhan)
            {
                case Enums.LoaiThuTienBenhNhan.ThuTamUng:
                    return LoaiPhieuThuChiThuNgan.ThuTamUng;
                case Enums.LoaiThuTienBenhNhan.ThuTheoChiPhi:
                    return LoaiPhieuThuChiThuNgan.ThuTheoChiPhi;
            }
            return null;
        }
        private LoaiPhieuThuChiThuNgan? GetLoaiPhieuThuChi(Enums.LoaiChiTienBenhNhan loaiChiTienBenhNhan)
        {
            switch (loaiChiTienBenhNhan)
            {
                case Enums.LoaiChiTienBenhNhan.HoanUng:
                    return LoaiPhieuThuChiThuNgan.HoanUng;
                case Enums.LoaiChiTienBenhNhan.HoanThu:
                    return LoaiPhieuThuChiThuNgan.HoanThu;
            }
            return null;
        }

        public async Task<List<ChiPhiKhamChuaBenhVo>> GetTatCaDichVuKhamChuaBenh(long yeuCauTiepNhanId)
        {
            var queryDichVuKhamBenh = BaseRepository.TableNoTracking.Where(o => o.Id == yeuCauTiepNhanId)
                .SelectMany(o => o.YeuCauKhamBenhs).Include(cc => cc.CongTyBaoHiemTuNhanCongNos).Include(cc => cc.MienGiamChiPhis).Include(cc => cc.NoiDangKy).Include(cc => cc.BacSiDangKy).ThenInclude(cc => cc.User)
                .Where(yc => yc.GoiKhamSucKhoeId == null && yc.TrangThai != Enums.EnumTrangThaiYeuCauKhamBenh.HuyKham)
                .Select(s => new ChiPhiKhamChuaBenhVo
                {
                    Id = s.Id,
                    YeuCauGoiDichVuId = s.YeuCauGoiDichVuId,
                    DichVuBenhVienId = s.DichVuKhamBenhBenhVienId,
                    LoaiNhom = NhomChiPhiKhamChuaBenh.DichVuKhamBenh,
                    Ma = s.DichVuKhamBenhBenhVien.Ma,
                    Nhom = NhomChiPhiKhamChuaBenh.DichVuKhamBenh.GetDescription(),
                    NhomChiPhiBangKe = NhomChiPhiBangKe.KhamBenh,
                    TenDichVu = s.DichVuKhamBenhBenhVien.Ten,
                    LoaiGia = s.NhomGiaDichVuKhamBenhBenhVien.Ten,
                    Soluong = 1,
                    DonViTinh = "Lần",
                    DonGia = s.YeuCauGoiDichVuId == null ? s.Gia : s.DonGiaSauChietKhau.GetValueOrDefault(),
                    KhongTinhPhi = s.KhongTinhPhi,
                    KiemTraBHYTXacNhan = s.BaoHiemChiTra != null,
                    DuocHuongBHYT = s.DuocHuongBaoHiem,
                    DonGiaBHYT = s.DonGiaBaoHiem.GetValueOrDefault(),
                    TiLeBaoHiemThanhToan = s.TiLeBaoHiemThanhToan.GetValueOrDefault(),
                    MucHuongBaoHiem = s.MucHuongBaoHiem.GetValueOrDefault(),
                    SoTienMG = s.SoTienMienGiam.GetValueOrDefault(),
                    SoTienBaoHiemTuNhanChiTra = s.SoTienBaoHiemTuNhanChiTra.GetValueOrDefault(),
                    GhiChuMienGiamThem = s.GhiChuMienGiamThem,
                    NoiDungGhiChuMiemGiamId = s.NoiDungGhiChuMiemGiamId,
                    CapNhatThanhToan = s.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan,
                    TrangThaiThanhToan = s.TrangThaiThanhToan,
                    DaThanhToan = s.SoTienBenhNhanDaChi.GetValueOrDefault(),
                    NoiThucHien = (s.NoiDangKy != null ? $"{s.NoiDangKy.Ma}" : "") + (s.BacSiDangKy != null && s.BacSiDangKy.User.HoTen != null ? " - " + $"{s.BacSiDangKy.User.HoTen}" : ""),
                    CheckedDefault = true,
                    ThoiDiemChiDinh = s.ThoiDiemChiDinh,
                }).OrderBy(o => o.Id).ToListAsync();

            var queryDichVuKyThuat = BaseRepository.TableNoTracking.Where(o => o.Id == yeuCauTiepNhanId)
                .SelectMany(o => o.YeuCauDichVuKyThuats).Include(cc => cc.CongTyBaoHiemTuNhanCongNos).Include(cc => cc.MienGiamChiPhis)
                .Where(yc => yc.GoiKhamSucKhoeId == null && yc.TrangThai != Enums.EnumTrangThaiYeuCauDichVuKyThuat.DaHuy)
                .Select(s => new ChiPhiKhamChuaBenhVo
                {
                    Id = s.Id,
                    YeuCauGoiDichVuId = s.YeuCauGoiDichVuId,
                    DichVuBenhVienId = s.DichVuKyThuatBenhVienId,
                    LoaiNhom = NhomChiPhiKhamChuaBenh.DichVuKyThuat,
                    Ma = s.DichVuKyThuatBenhVien.Ma,
                    Nhom = NhomChiPhiKhamChuaBenh.DichVuKyThuat.GetDescription(),
                    NhomChiPhiBangKe = s.LoaiDichVuKyThuat == Enums.LoaiDichVuKyThuat.XetNghiem ? NhomChiPhiBangKe.XetNgiem :
                                            s.LoaiDichVuKyThuat == Enums.LoaiDichVuKyThuat.ChuanDoanHinhAnh ? NhomChiPhiBangKe.ChuanDoanHinhAnh :
                                                s.LoaiDichVuKyThuat == Enums.LoaiDichVuKyThuat.ThamDoChucNang ? NhomChiPhiBangKe.ThamDoChucNang :
                                                    s.LoaiDichVuKyThuat == Enums.LoaiDichVuKyThuat.ThuThuatPhauThuat ? NhomChiPhiBangKe.ThuThuatPhauThuat : NhomChiPhiBangKe.DichVuKhac,
                    TenDichVu = s.DichVuKyThuatBenhVien.Ten,
                    LoaiGia = s.NhomGiaDichVuKyThuatBenhVien.Ten,
                    Soluong = s.SoLan,
                    DonViTinh = "Lần",
                    DonGia = s.YeuCauGoiDichVuId == null ? s.Gia : s.DonGiaSauChietKhau.GetValueOrDefault(),
                    KhongTinhPhi = s.KhongTinhPhi,
                    KiemTraBHYTXacNhan = s.BaoHiemChiTra != null,
                    DuocHuongBHYT = s.DuocHuongBaoHiem,
                    DonGiaBHYT = s.DonGiaBaoHiem.GetValueOrDefault(),
                    TiLeBaoHiemThanhToan = s.TiLeBaoHiemThanhToan.GetValueOrDefault(),
                    MucHuongBaoHiem = s.MucHuongBaoHiem.GetValueOrDefault(),
                    SoTienMG = s.SoTienMienGiam.GetValueOrDefault(),
                    SoTienBaoHiemTuNhanChiTra = s.SoTienBaoHiemTuNhanChiTra.GetValueOrDefault(),
                    GhiChuMienGiamThem = s.GhiChuMienGiamThem,
                    NoiDungGhiChuMiemGiamId = s.NoiDungGhiChuMiemGiamId,
                    CapNhatThanhToan = s.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan,
                    TrangThaiThanhToan = s.TrangThaiThanhToan,
                    DaThanhToan = s.SoTienBenhNhanDaChi.GetValueOrDefault(),
                    NoiThucHien = s.NoiThucHien != null
                        ? $"{s.NoiThucHien.Ma} - {s.NoiThucHien.Ten}"
                        : string.Empty,
                    CheckedDefault = true,
                    ThoiDiemChiDinh = s.ThoiDiemChiDinh,
                }).ToListAsync();

            var queryDuocPham = BaseRepository.TableNoTracking.Where(o => o.Id == yeuCauTiepNhanId)
                .SelectMany(o => o.YeuCauDuocPhamBenhViens).Include(cc => cc.CongTyBaoHiemTuNhanCongNos).Include(cc => cc.MienGiamChiPhis)
                .Where(yc => yc.TrangThai != Enums.EnumYeuCauDuocPhamBenhVien.DaHuy)
                .Select(s => new ChiPhiKhamChuaBenhVo
                {
                    Id = s.Id,
                    DichVuBenhVienId = s.DuocPhamBenhVienId,
                    LoaiNhom = NhomChiPhiKhamChuaBenh.DuocPham,
                    Nhom = NhomChiPhiKhamChuaBenh.DuocPham.GetDescription(),
                    NhomChiPhiBangKe = NhomChiPhiBangKe.ThuocDichTruyen,
                    Ma = s.DuocPhamBenhVien.Ma,
                    TenDichVu = s.DuocPhamBenhVien.DuocPham.Ten + " " + (s.HamLuong ?? ""),//BVHD-3873
                    LoaiGia = string.Empty,
                    Soluong = s.SoLuong,
                    DonGia = s.DonGiaBan,
                    DonViTinh = s.DonViTinh.Ten,
                    KhongTinhPhi = s.KhongTinhPhi,
                    KiemTraBHYTXacNhan = s.BaoHiemChiTra != null,
                    DuocHuongBHYT = s.DuocHuongBaoHiem,
                    DonGiaBHYT = s.DonGiaBaoHiem.GetValueOrDefault(),
                    TiLeBaoHiemThanhToan = s.TiLeBaoHiemThanhToan.GetValueOrDefault(),
                    MucHuongBaoHiem = s.MucHuongBaoHiem.GetValueOrDefault(),
                    SoTienMG = s.SoTienMienGiam.GetValueOrDefault(),
                    SoTienBaoHiemTuNhanChiTra = s.SoTienBaoHiemTuNhanChiTra.GetValueOrDefault(),
                    GhiChuMienGiamThem = s.GhiChuMienGiamThem,
                    NoiDungGhiChuMiemGiamId = s.NoiDungGhiChuMiemGiamId,
                    CapNhatThanhToan = s.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan,
                    TrangThaiThanhToan = s.TrangThaiThanhToan,
                    DaThanhToan = s.SoTienBenhNhanDaChi.GetValueOrDefault(),
                    NoiThucHien = string.Empty,
                    CheckedDefault = true,
                    ThoiDiemChiDinh = s.ThoiDiemChiDinh,
                }).ToListAsync();

            var queryVatTu = BaseRepository.TableNoTracking.Where(o => o.Id == yeuCauTiepNhanId)
                .SelectMany(o => o.YeuCauVatTuBenhViens).Include(cc => cc.CongTyBaoHiemTuNhanCongNos).Include(cc => cc.MienGiamChiPhis)
                .Where(yc => yc.TrangThai != Enums.EnumYeuCauVatTuBenhVien.DaHuy)
                .Select(s => new ChiPhiKhamChuaBenhVo
                {
                    Id = s.Id,
                    DichVuBenhVienId = s.VatTuBenhVienId,
                    LoaiNhom = NhomChiPhiKhamChuaBenh.VatTuTieuHao,
                    Nhom = NhomChiPhiKhamChuaBenh.VatTuTieuHao.GetDescription(),
                    NhomChiPhiBangKe = s.YeuCauDichVuKyThuat != null && s.YeuCauDichVuKyThuat.LanThucHien != null ? NhomChiPhiBangKe.GoiVatTu : NhomChiPhiBangKe.VatTuYte,
                    SoThuTuGoiTrongNhomChiPhiBangKe = s.YeuCauDichVuKyThuat != null ? s.YeuCauDichVuKyThuat.LanThucHien.GetValueOrDefault(0) : 0,
                    Ma = s.VatTuBenhVien.Ma,
                    TenDichVu = s.VatTuBenhVien.VatTus.Ten,
                    LoaiGia = string.Empty,
                    Soluong = s.SoLuong,
                    DonGia = s.DonGiaBan,
                    DonViTinh = s.DonViTinh,
                    KhongTinhPhi = s.KhongTinhPhi,
                    KiemTraBHYTXacNhan = s.BaoHiemChiTra != null,
                    DuocHuongBHYT = s.DuocHuongBaoHiem,
                    DonGiaBHYT = s.DonGiaBaoHiem.GetValueOrDefault(),
                    TiLeBaoHiemThanhToan = s.TiLeBaoHiemThanhToan.GetValueOrDefault(),
                    MucHuongBaoHiem = s.MucHuongBaoHiem.GetValueOrDefault(),
                    SoTienMG = s.SoTienMienGiam.GetValueOrDefault(),
                    SoTienBaoHiemTuNhanChiTra = s.SoTienBaoHiemTuNhanChiTra.GetValueOrDefault(),
                    GhiChuMienGiamThem = s.GhiChuMienGiamThem,
                    NoiDungGhiChuMiemGiamId = s.NoiDungGhiChuMiemGiamId,
                    CapNhatThanhToan = s.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan,
                    TrangThaiThanhToan = s.TrangThaiThanhToan,
                    DaThanhToan = s.SoTienBenhNhanDaChi.GetValueOrDefault(),
                    NoiThucHien = string.Empty,
                    CheckedDefault = true,
                    ThoiDiemChiDinh = s.ThoiDiemChiDinh,
                }).ToListAsync();

            var queryToaThuoc = BaseRepository.TableNoTracking.Where(o => o.Id == yeuCauTiepNhanId)
                .SelectMany(o => o.DonThuocThanhToans)
                .Where(dt =>
                    dt.LoaiDonThuoc == Enums.EnumLoaiDonThuoc.ThuocBHYT && dt.TrangThai != Enums.TrangThaiDonThuocThanhToan.DaHuy)
                .SelectMany(o => o.DonThuocThanhToanChiTiets).Include(cc => cc.CongTyBaoHiemTuNhanCongNos).Include(cc => cc.MienGiamChiPhis)
                .Select(s => new ChiPhiKhamChuaBenhVo
                {
                    Id = s.Id,
                    DichVuBenhVienId = s.DuocPhamId,
                    LoaiNhom = NhomChiPhiKhamChuaBenh.ToaThuoc,
                    Nhom = $"{NhomChiPhiKhamChuaBenh.ToaThuoc.GetDescription()}: {s.DonThuocThanhToan.YeuCauKhamBenhDonThuoc.YeuCauKhamBenh.TenDichVu}",
                    NhomChiPhiBangKe = NhomChiPhiBangKe.ThuocDichTruyen,
                    Ma = string.Empty,
                    TenDichVu = s.Ten + " " + (s.HamLuong ?? ""),//BVHD-3873
                    LoaiGia = string.Empty,
                    Soluong = s.SoLuong,
                    DonGia = s.DonGiaBan,
                    DonViTinh = s.DonViTinh.Ten,
                    KiemTraBHYTXacNhan = s.BaoHiemChiTra != null,
                    DuocHuongBHYT = s.DuocHuongBaoHiem,
                    DonGiaBHYT = s.DonGiaBaoHiem.GetValueOrDefault(),
                    TiLeBaoHiemThanhToan = s.TiLeBaoHiemThanhToan.GetValueOrDefault(),
                    MucHuongBaoHiem = s.MucHuongBaoHiem.GetValueOrDefault(),
                    SoTienMG = s.SoTienMienGiam.GetValueOrDefault(),
                    SoTienBaoHiemTuNhanChiTra = s.SoTienBaoHiemTuNhanChiTra.GetValueOrDefault(),
                    GhiChuMienGiamThem = s.GhiChuMienGiamThem,
                    NoiDungGhiChuMiemGiamId = s.NoiDungGhiChuMiemGiamId,
                    CapNhatThanhToan = s.DonThuocThanhToan.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan,
                    TrangThaiThanhToan = s.DonThuocThanhToan.TrangThaiThanhToan,
                    DaThanhToan = s.SoTienBenhNhanDaChi.GetValueOrDefault(),
                    NoiThucHien = string.Empty,
                    CheckedDefault = true,
                    ThoiDiemChiDinh = s.DonThuocThanhToan.CreatedOn.Value,
                }).ToListAsync();

            await Task.WhenAll(queryDichVuKhamBenh, queryDichVuKyThuat, queryDuocPham, queryVatTu, queryToaThuoc);
            var result = new List<ChiPhiKhamChuaBenhVo>();
            result.AddRange(queryDichVuKhamBenh.Result);
            result.AddRange(queryDichVuKyThuat.Result);
            result.AddRange(queryDuocPham.Result);
            result.AddRange(queryVatTu.Result);
            result.AddRange(queryToaThuoc.Result);

            return result;
        }
        /*
        private List<ChiPhiKhamChuaBenhVo> GetThongTinChiPhi(long yeuCauTiepNhanId)
        {
            var chiPhiKhamChuaBenhVos = new List<ChiPhiKhamChuaBenhVo>();
            var taiKhoanBenhNhanThus = _taiKhoanBenhNhanThu.TableNoTracking.Where(o => o.YeuCauTiepNhanId == yeuCauTiepNhanId && o.DaHuy != true && o.LoaiThuTienBenhNhan == Enums.LoaiThuTienBenhNhan.ThuTheoChiPhi)
                    .Include(o => o.TaiKhoanBenhNhanChis)
                    .Include(o => o.TaiKhoanBenhNhanChis).ThenInclude(o => o.YeuCauKhamBenh).ThenInclude(o => o.NhomGiaDichVuKhamBenhBenhVien)
                    .Include(o => o.TaiKhoanBenhNhanChis).ThenInclude(o => o.YeuCauKhamBenh).ThenInclude(o => o.NoiThucHien).ThenInclude(o => o.KhoaPhong)
                    .Include(o => o.TaiKhoanBenhNhanChis).ThenInclude(o => o.YeuCauKhamBenh).ThenInclude(o => o.NoiChiDinh).ThenInclude(o => o.KhoaPhong)
                    .Include(o => o.TaiKhoanBenhNhanChis).ThenInclude(o => o.YeuCauDichVuKyThuat).ThenInclude(o => o.NhomGiaDichVuKyThuatBenhVien)
                    .Include(o => o.TaiKhoanBenhNhanChis).ThenInclude(o => o.YeuCauDichVuKyThuat).ThenInclude(o => o.NoiThucHien).ThenInclude(o => o.KhoaPhong)
                    .Include(o => o.TaiKhoanBenhNhanChis).ThenInclude(o => o.YeuCauDichVuKyThuat).ThenInclude(o => o.NoiChiDinh).ThenInclude(o => o.KhoaPhong)
                    .Include(o => o.TaiKhoanBenhNhanChis).ThenInclude(o => o.YeuCauDuocPhamBenhVien).ThenInclude(o => o.DuocPhamBenhVien)
                    .Include(o => o.TaiKhoanBenhNhanChis).ThenInclude(o => o.YeuCauDuocPhamBenhVien).ThenInclude(o => o.DonViTinh)
                    .Include(o => o.TaiKhoanBenhNhanChis).ThenInclude(o => o.YeuCauDuocPhamBenhVien).ThenInclude(o => o.NoiCapThuoc).ThenInclude(o => o.KhoaPhong)
                    .Include(o => o.TaiKhoanBenhNhanChis).ThenInclude(o => o.YeuCauDuocPhamBenhVien).ThenInclude(o => o.NoiChiDinh).ThenInclude(o => o.KhoaPhong)
                    .Include(o => o.TaiKhoanBenhNhanChis).ThenInclude(o => o.YeuCauVatTuBenhVien).ThenInclude(o => o.VatTuBenhVien)
                    .Include(o => o.TaiKhoanBenhNhanChis).ThenInclude(o => o.YeuCauVatTuBenhVien).ThenInclude(o => o.YeuCauDichVuKyThuat)
                    .Include(o => o.TaiKhoanBenhNhanChis).ThenInclude(o => o.YeuCauVatTuBenhVien).ThenInclude(o => o.NoiCapVatTu).ThenInclude(o => o.KhoaPhong)
                    .Include(o => o.TaiKhoanBenhNhanChis).ThenInclude(o => o.YeuCauVatTuBenhVien).ThenInclude(o => o.NoiChiDinh).ThenInclude(o => o.KhoaPhong)
                    .Include(o => o.TaiKhoanBenhNhanChis).ThenInclude(o => o.YeuCauTruyenMau).ThenInclude(o => o.NoiThucHien).ThenInclude(o => o.KhoaPhong)
                    .Include(o => o.TaiKhoanBenhNhanChis).ThenInclude(o => o.YeuCauTruyenMau).ThenInclude(o => o.NoiChiDinh).ThenInclude(o => o.KhoaPhong)
                    .Include(o => o.TaiKhoanBenhNhanChis).ThenInclude(o => o.DonThuocThanhToanChiTiet).ThenInclude(o => o.DonViTinh)
                    .Include(o => o.TaiKhoanBenhNhanChis).ThenInclude(o => o.YeuCauDichVuGiuongBenhVienChiPhiBenhVien).ThenInclude(o => o.KhoaPhong)
                    .Include(o => o.TaiKhoanBenhNhanChis).ThenInclude(o => o.YeuCauDichVuGiuongBenhVienChiPhiBenhVien).ThenInclude(o => o.YeuCauDichVuGiuongBenhVienChiPhiBHYTs)
                    .Include(o => o.MienGiamChiPhis)
                    .Include(o => o.CongTyBaoHiemTuNhanCongNos)
                    .Include(o => o.NhanVienThuHoi).ThenInclude(o => o.User).ToList();
            if (taiKhoanBenhNhanThus.Any())
            {
                foreach (var taiKhoanBenhNhanThu in taiKhoanBenhNhanThus)
                {
                    foreach (var taiKhoanBenhNhanChi in taiKhoanBenhNhanThu.TaiKhoanBenhNhanChis.Where(o => o.LoaiChiTienBenhNhan == Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi))
                    {
                        var chiPhiDichVu = new ChiPhiKhamChuaBenhVo
                        {
                            TaiKhoanBenhNhanChiId = taiKhoanBenhNhanChi.Id,
                            Soluong = taiKhoanBenhNhanChi.SoLuong.GetValueOrDefault(),
                            DonGia = taiKhoanBenhNhanChi.Gia.GetValueOrDefault(),
                            KhongTinhPhi = false,
                            KiemTraBHYTXacNhan = true,
                            DuocHuongBHYT = taiKhoanBenhNhanChi.MucHuongBaoHiem.GetValueOrDefault() > 0,
                            DonGiaBHYT = taiKhoanBenhNhanChi.DonGiaBaoHiem.GetValueOrDefault(),
                            TiLeBaoHiemThanhToan = taiKhoanBenhNhanChi.TiLeBaoHiemThanhToan.GetValueOrDefault(),
                            MucHuongBaoHiem = taiKhoanBenhNhanChi.MucHuongBaoHiem.GetValueOrDefault(),
                            SoTienMG = taiKhoanBenhNhanChi.SoTienMienGiam.GetValueOrDefault(),

                            DaThanhToan = taiKhoanBenhNhanChi.TienChiPhi.GetValueOrDefault(),
                            DaHoanThu = taiKhoanBenhNhanThu.DaHuy != true && taiKhoanBenhNhanChi.DaHuy == true,
                            NgayThu = taiKhoanBenhNhanThu.NgayThu
                        };
                        if (taiKhoanBenhNhanChi.YeuCauKhamBenh != null)
                        {
                            chiPhiDichVu.Id = taiKhoanBenhNhanChi.YeuCauKhamBenh.Id;
                            chiPhiDichVu.NgayPhatSinh = taiKhoanBenhNhanChi.YeuCauKhamBenh.ThoiDiemChiDinh;
                            chiPhiDichVu.DichVuBenhVienId = taiKhoanBenhNhanChi.YeuCauKhamBenh.DichVuKhamBenhBenhVienId;
                            chiPhiDichVu.LoaiNhom = NhomChiPhiKhamChuaBenh.DichVuKhamBenh;
                            chiPhiDichVu.NhomChiPhiBangKe = NhomChiPhiBangKe.KhamBenh;
                            chiPhiDichVu.Ma = taiKhoanBenhNhanChi.YeuCauKhamBenh.MaDichVu;
                            chiPhiDichVu.Nhom = NhomChiPhiKhamChuaBenh.DichVuKhamBenh.GetDescription();
                            chiPhiDichVu.TenDichVu = taiKhoanBenhNhanChi.YeuCauKhamBenh.TenDichVu;
                            chiPhiDichVu.DonViTinh = "Lần";
                            chiPhiDichVu.LoaiGia = taiKhoanBenhNhanChi.YeuCauKhamBenh.NhomGiaDichVuKhamBenhBenhVien.Ten;
                            chiPhiDichVu.DanhSachCongNoChoThus = taiKhoanBenhNhanThu
                                .CongTyBaoHiemTuNhanCongNos.Where(o => o.YeuCauKhamBenhId == taiKhoanBenhNhanChi.YeuCauKhamBenh.Id).Select(o => new DanhSachCongNoVo { CongTyBaoHiemTuNhanId = o.CongTyBaoHiemTuNhanId, SoTienCongNoChoThu = o.SoTien })
                                .ToList();
                            chiPhiDichVu.DanhSachMienGiamVos = taiKhoanBenhNhanThu.MienGiamChiPhis
                                .Where(o => o.YeuCauKhamBenhId == taiKhoanBenhNhanChi.YeuCauKhamBenh.Id).GroupBy(
                                    o => new
                                    {
                                        o.LoaiMienGiam,
                                        o.TheVoucherId,
                                        o.MaTheVoucher,
                                        o.DoiTuongUuDaiId,
                                        o.LoaiChietKhau
                                    }, o => o,
                                    (k, v) => new DanhSachMienGiamVo
                                    {
                                        LoaiMienGiam = k.LoaiMienGiam,
                                        LoaiChietKhau = k.LoaiChietKhau,
                                        TheVoucherId = k.TheVoucherId,
                                        MaTheVoucher = k.MaTheVoucher,
                                        DoiTuongUuDaiId = k.DoiTuongUuDaiId,
                                        TiLe = v.Select(o => o.TiLe).DefaultIfEmpty().Sum(),
                                        SoTien = v.Select(o => o.SoTien).DefaultIfEmpty().Sum()
                                    }).ToList();
                            chiPhiDichVu.Khoa = taiKhoanBenhNhanChi.YeuCauKhamBenh.NoiThucHien != null
                                ? taiKhoanBenhNhanChi.YeuCauKhamBenh.NoiThucHien.KhoaPhong.Ten
                                : taiKhoanBenhNhanChi.YeuCauKhamBenh.NoiChiDinh.KhoaPhong.Ten;
                        }
                        else if (taiKhoanBenhNhanChi.YeuCauDichVuKyThuat != null)
                        {
                            chiPhiDichVu.Id = taiKhoanBenhNhanChi.YeuCauDichVuKyThuat.Id;
                            chiPhiDichVu.NgayPhatSinh = taiKhoanBenhNhanChi.YeuCauDichVuKyThuat.ThoiDiemChiDinh;
                            chiPhiDichVu.DichVuBenhVienId = taiKhoanBenhNhanChi.YeuCauDichVuKyThuat.DichVuKyThuatBenhVienId;
                            chiPhiDichVu.LoaiNhom = NhomChiPhiKhamChuaBenh.DichVuKyThuat;


                            switch (taiKhoanBenhNhanChi.YeuCauDichVuKyThuat.LoaiDichVuKyThuat)
                            {
                                case Enums.LoaiDichVuKyThuat.XetNghiem:
                                    chiPhiDichVu.NhomChiPhiBangKe = NhomChiPhiBangKe.XetNgiem;
                                    break;
                                case Enums.LoaiDichVuKyThuat.ChuanDoanHinhAnh:
                                    chiPhiDichVu.NhomChiPhiBangKe = NhomChiPhiBangKe.ChuanDoanHinhAnh;
                                    break;
                                case Enums.LoaiDichVuKyThuat.ThamDoChucNang:
                                    chiPhiDichVu.NhomChiPhiBangKe = NhomChiPhiBangKe.ThamDoChucNang;
                                    break;
                                case Enums.LoaiDichVuKyThuat.ThuThuatPhauThuat:
                                    chiPhiDichVu.NhomChiPhiBangKe = NhomChiPhiBangKe.ThuThuatPhauThuat;
                                    break;
                                default:
                                    chiPhiDichVu.NhomChiPhiBangKe = NhomChiPhiBangKe.DichVuKhac;
                                    break;
                            }

                            chiPhiDichVu.Ma = taiKhoanBenhNhanChi.YeuCauDichVuKyThuat.MaDichVu;
                            chiPhiDichVu.Nhom = NhomChiPhiKhamChuaBenh.DichVuKyThuat.GetDescription();
                            chiPhiDichVu.TenDichVu = taiKhoanBenhNhanChi.YeuCauDichVuKyThuat.TenDichVu;
                            chiPhiDichVu.DonViTinh = "Lần";
                            chiPhiDichVu.LoaiGia = taiKhoanBenhNhanChi.YeuCauDichVuKyThuat.NhomGiaDichVuKyThuatBenhVien.Ten;
                            chiPhiDichVu.DanhSachCongNoChoThus = taiKhoanBenhNhanThu
                                .CongTyBaoHiemTuNhanCongNos.Where(o => o.YeuCauDichVuKyThuatId == taiKhoanBenhNhanChi.YeuCauDichVuKyThuat.Id).Select(o => new DanhSachCongNoVo { CongTyBaoHiemTuNhanId = o.CongTyBaoHiemTuNhanId, SoTienCongNoChoThu = o.SoTien })
                                .ToList();
                            chiPhiDichVu.DanhSachMienGiamVos = taiKhoanBenhNhanThu.MienGiamChiPhis
                                .Where(o => o.YeuCauDichVuKyThuatId == taiKhoanBenhNhanChi.YeuCauDichVuKyThuat.Id).GroupBy(
                                    o => new
                                    {
                                        o.LoaiMienGiam,
                                        o.TheVoucherId,
                                        o.MaTheVoucher,
                                        o.DoiTuongUuDaiId,
                                        o.LoaiChietKhau
                                    }, o => o,
                                    (k, v) => new DanhSachMienGiamVo
                                    {
                                        LoaiMienGiam = k.LoaiMienGiam,
                                        LoaiChietKhau = k.LoaiChietKhau,
                                        TheVoucherId = k.TheVoucherId,
                                        MaTheVoucher = k.MaTheVoucher,
                                        DoiTuongUuDaiId = k.DoiTuongUuDaiId,
                                        TiLe = v.Select(o => o.TiLe).DefaultIfEmpty().Sum(),
                                        SoTien = v.Select(o => o.SoTien).DefaultIfEmpty().Sum()
                                    }).ToList();
                            chiPhiDichVu.Khoa = taiKhoanBenhNhanChi.YeuCauDichVuKyThuat.NoiThucHien != null
                                ? taiKhoanBenhNhanChi.YeuCauDichVuKyThuat.NoiThucHien.KhoaPhong.Ten
                                : taiKhoanBenhNhanChi.YeuCauDichVuKyThuat.NoiChiDinh.KhoaPhong.Ten;
                        }
                        else if (taiKhoanBenhNhanChi.YeuCauDuocPhamBenhVien != null)
                        {
                            chiPhiDichVu.Id = taiKhoanBenhNhanChi.YeuCauDuocPhamBenhVien.Id;
                            chiPhiDichVu.NgayPhatSinh = taiKhoanBenhNhanChi.YeuCauDuocPhamBenhVien.ThoiDiemChiDinh;
                            chiPhiDichVu.DichVuBenhVienId = taiKhoanBenhNhanChi.YeuCauDuocPhamBenhVien.DuocPhamBenhVienId;
                            chiPhiDichVu.LoaiNhom = NhomChiPhiKhamChuaBenh.DuocPham;
                            chiPhiDichVu.NhomChiPhiBangKe = NhomChiPhiBangKe.ThuocDichTruyen;
                            chiPhiDichVu.Ma = taiKhoanBenhNhanChi.YeuCauDuocPhamBenhVien.DuocPhamBenhVien.Ma;
                            chiPhiDichVu.Nhom = NhomChiPhiKhamChuaBenh.DuocPham.GetDescription();
                            chiPhiDichVu.TenDichVu = taiKhoanBenhNhanChi.YeuCauDuocPhamBenhVien.Ten;
                            chiPhiDichVu.DonViTinh = taiKhoanBenhNhanChi.YeuCauDuocPhamBenhVien.DonViTinh?.Ten;
                            chiPhiDichVu.LoaiGia = string.Empty;
                            chiPhiDichVu.DanhSachCongNoChoThus = taiKhoanBenhNhanThu
                                .CongTyBaoHiemTuNhanCongNos.Where(o => o.YeuCauDuocPhamBenhVienId == taiKhoanBenhNhanChi.YeuCauDuocPhamBenhVien.Id).Select(o => new DanhSachCongNoVo { CongTyBaoHiemTuNhanId = o.CongTyBaoHiemTuNhanId, SoTienCongNoChoThu = o.SoTien })
                                .ToList();
                            chiPhiDichVu.DanhSachMienGiamVos = taiKhoanBenhNhanThu.MienGiamChiPhis
                                .Where(o => o.YeuCauDuocPhamBenhVienId == taiKhoanBenhNhanChi.YeuCauDuocPhamBenhVien.Id).GroupBy(
                                    o => new
                                    {
                                        o.LoaiMienGiam,
                                        o.TheVoucherId,
                                        o.MaTheVoucher,
                                        o.DoiTuongUuDaiId,
                                        o.LoaiChietKhau
                                    }, o => o,
                                    (k, v) => new DanhSachMienGiamVo
                                    {
                                        LoaiMienGiam = k.LoaiMienGiam,
                                        LoaiChietKhau = k.LoaiChietKhau,
                                        TheVoucherId = k.TheVoucherId,
                                        MaTheVoucher = k.MaTheVoucher,
                                        DoiTuongUuDaiId = k.DoiTuongUuDaiId,
                                        TiLe = v.Select(o => o.TiLe).DefaultIfEmpty().Sum(),
                                        SoTien = v.Select(o => o.SoTien).DefaultIfEmpty().Sum()
                                    }).ToList();
                            chiPhiDichVu.Khoa = taiKhoanBenhNhanChi.YeuCauDuocPhamBenhVien.NoiCapThuoc != null
                                ? taiKhoanBenhNhanChi.YeuCauDuocPhamBenhVien.NoiCapThuoc.KhoaPhong.Ten
                                : taiKhoanBenhNhanChi.YeuCauDuocPhamBenhVien.NoiChiDinh.KhoaPhong.Ten;
                        }
                        else if (taiKhoanBenhNhanChi.YeuCauVatTuBenhVien != null)
                        {
                            chiPhiDichVu.Id = taiKhoanBenhNhanChi.YeuCauVatTuBenhVien.Id;
                            chiPhiDichVu.NgayPhatSinh = taiKhoanBenhNhanChi.YeuCauVatTuBenhVien.ThoiDiemChiDinh;
                            chiPhiDichVu.DichVuBenhVienId = taiKhoanBenhNhanChi.YeuCauVatTuBenhVien.VatTuBenhVienId;
                            chiPhiDichVu.LoaiNhom = NhomChiPhiKhamChuaBenh.VatTuTieuHao;
                            chiPhiDichVu.NhomChiPhiBangKe = taiKhoanBenhNhanChi.YeuCauVatTuBenhVien.YeuCauDichVuKyThuat?.LanThucHien != null ? NhomChiPhiBangKe.GoiVatTu : NhomChiPhiBangKe.VatTuYte;
                            chiPhiDichVu.SoThuTuGoiTrongNhomChiPhiBangKe = taiKhoanBenhNhanChi.YeuCauVatTuBenhVien.YeuCauDichVuKyThuat?.LanThucHien ?? 0;
                            chiPhiDichVu.Ma = taiKhoanBenhNhanChi.YeuCauVatTuBenhVien.Ma;
                            chiPhiDichVu.Nhom = NhomChiPhiKhamChuaBenh.VatTuTieuHao.GetDescription();
                            chiPhiDichVu.TenDichVu = taiKhoanBenhNhanChi.YeuCauVatTuBenhVien.Ten;
                            chiPhiDichVu.DonViTinh = taiKhoanBenhNhanChi.YeuCauVatTuBenhVien.DonViTinh;
                            chiPhiDichVu.LoaiGia = string.Empty;
                            chiPhiDichVu.DanhSachCongNoChoThus = taiKhoanBenhNhanThu
                                .CongTyBaoHiemTuNhanCongNos.Where(o => o.YeuCauVatTuBenhVienId == taiKhoanBenhNhanChi.YeuCauVatTuBenhVien.Id).Select(o => new DanhSachCongNoVo { CongTyBaoHiemTuNhanId = o.CongTyBaoHiemTuNhanId, SoTienCongNoChoThu = o.SoTien })
                                .ToList();
                            chiPhiDichVu.DanhSachMienGiamVos = taiKhoanBenhNhanThu.MienGiamChiPhis
                                .Where(o => o.YeuCauVatTuBenhVienId == taiKhoanBenhNhanChi.YeuCauVatTuBenhVien.Id).GroupBy(
                                    o => new
                                    {
                                        o.LoaiMienGiam,
                                        o.TheVoucherId,
                                        o.MaTheVoucher,
                                        o.DoiTuongUuDaiId,
                                        o.LoaiChietKhau
                                    }, o => o,
                                    (k, v) => new DanhSachMienGiamVo
                                    {
                                        LoaiMienGiam = k.LoaiMienGiam,
                                        LoaiChietKhau = k.LoaiChietKhau,
                                        TheVoucherId = k.TheVoucherId,
                                        MaTheVoucher = k.MaTheVoucher,
                                        DoiTuongUuDaiId = k.DoiTuongUuDaiId,
                                        TiLe = v.Select(o => o.TiLe).DefaultIfEmpty().Sum(),
                                        SoTien = v.Select(o => o.SoTien).DefaultIfEmpty().Sum()
                                    }).ToList();
                            chiPhiDichVu.Khoa = taiKhoanBenhNhanChi.YeuCauVatTuBenhVien.NoiCapVatTu != null
                                ? taiKhoanBenhNhanChi.YeuCauVatTuBenhVien.NoiCapVatTu.KhoaPhong.Ten
                                : taiKhoanBenhNhanChi.YeuCauVatTuBenhVien.NoiChiDinh.KhoaPhong.Ten;
                        }
                        else if (taiKhoanBenhNhanChi.DonThuocThanhToanChiTiet != null)
                        {
                            chiPhiDichVu.Id = taiKhoanBenhNhanChi.DonThuocThanhToanChiTiet.Id;
                            chiPhiDichVu.NgayPhatSinh = taiKhoanBenhNhanChi.DonThuocThanhToanChiTiet.CreatedOn;
                            chiPhiDichVu.DichVuBenhVienId = taiKhoanBenhNhanChi.DonThuocThanhToanChiTiet.DuocPhamId;
                            chiPhiDichVu.LoaiNhom = NhomChiPhiKhamChuaBenh.ToaThuoc;
                            chiPhiDichVu.NhomChiPhiBangKe = NhomChiPhiBangKe.ThuocDichTruyen;
                            chiPhiDichVu.Ma = string.Empty;
                            chiPhiDichVu.Nhom = NhomChiPhiKhamChuaBenh.ToaThuoc.GetDescription();
                            chiPhiDichVu.TenDichVu = taiKhoanBenhNhanChi.DonThuocThanhToanChiTiet.Ten;
                            chiPhiDichVu.DonViTinh = taiKhoanBenhNhanChi.DonThuocThanhToanChiTiet.DonViTinh?.Ten;
                            chiPhiDichVu.LoaiGia = string.Empty;
                            chiPhiDichVu.DanhSachCongNoChoThus = taiKhoanBenhNhanThu
                                .CongTyBaoHiemTuNhanCongNos.Where(o => o.DonThuocThanhToanChiTietId == taiKhoanBenhNhanChi.DonThuocThanhToanChiTiet.Id).Select(o => new DanhSachCongNoVo { CongTyBaoHiemTuNhanId = o.CongTyBaoHiemTuNhanId, SoTienCongNoChoThu = o.SoTien })
                                .ToList();
                            chiPhiDichVu.DanhSachMienGiamVos = taiKhoanBenhNhanThu.MienGiamChiPhis
                                .Where(o => o.DonThuocThanhToanChiTietId == taiKhoanBenhNhanChi.DonThuocThanhToanChiTiet.Id).GroupBy(
                                    o => new
                                    {
                                        o.LoaiMienGiam,
                                        o.TheVoucherId,
                                        o.MaTheVoucher,
                                        o.DoiTuongUuDaiId,
                                        o.LoaiChietKhau
                                    }, o => o,
                                    (k, v) => new DanhSachMienGiamVo
                                    {
                                        LoaiMienGiam = k.LoaiMienGiam,
                                        LoaiChietKhau = k.LoaiChietKhau,
                                        TheVoucherId = k.TheVoucherId,
                                        MaTheVoucher = k.MaTheVoucher,
                                        DoiTuongUuDaiId = k.DoiTuongUuDaiId,
                                        TiLe = v.Select(o => o.TiLe).DefaultIfEmpty().Sum(),
                                        SoTien = v.Select(o => o.SoTien).DefaultIfEmpty().Sum()
                                    }).ToList();
                            chiPhiDichVu.Khoa = "Nhà thuốc";
                        }
                        chiPhiKhamChuaBenhVos.Add(chiPhiDichVu);
                    }
                }
            }

            return chiPhiKhamChuaBenhVos;
        }
        */
        public ThongTinPhieuThu GetThongTinPhieuThu(long soPhieuId, LoaiPhieuThuChiThuNgan loaiPhieu)
        {
            ThongTinPhieuThu thongTinPhieuThu = null;
            if (loaiPhieu == LoaiPhieuThuChiThuNgan.HoanUng || loaiPhieu == LoaiPhieuThuChiThuNgan.HoanThu)
            {
                var taiKhoanBenhNhanChi = _taiKhoanBenhNhanChi.TableNoTracking.Include(o => o.YeuCauTiepNhan)
                                        .Include(o => o.NhanVienHuy).ThenInclude(o => o.User)
                                        .Include(o => o.NhanVienThuHoi).ThenInclude(o => o.User).FirstOrDefault(o => o.Id == soPhieuId);
                if (taiKhoanBenhNhanChi != null)
                {
                    thongTinPhieuThu = new ThongTinPhieuThu
                    {
                        Id = taiKhoanBenhNhanChi.Id,
                        SoPhieu = taiKhoanBenhNhanChi.SoPhieuHienThi,
                        LoaiPhieuThuChiThuNgan = loaiPhieu,
                        DaHuy = taiKhoanBenhNhanChi.DaHuy,
                        TienMat = taiKhoanBenhNhanChi.TienMat,
                        HinhThucThanhToan = "Tiền mặt",

                        NgayThu = taiKhoanBenhNhanChi.NgayChi,
                        NoiDungThu = taiKhoanBenhNhanChi.NoiDungChi,
                        DaThuHoi = taiKhoanBenhNhanChi.DaThuHoi.GetValueOrDefault(),
                        NgayThuHoi = taiKhoanBenhNhanChi.NgayThuHoi,
                        NguoiThuHoiId = taiKhoanBenhNhanChi.NhanVienThuHoiId,
                        NguoiThuHoi = taiKhoanBenhNhanChi.NhanVienThuHoi?.User?.HoTen,
                        NhanVienHuyPhieu = taiKhoanBenhNhanChi.NhanVienHuy?.User?.HoTen,
                        NgayHuy = taiKhoanBenhNhanChi.NgayHuy,
                        DaChuyenVoNoiTru = taiKhoanBenhNhanChi.YeuCauTiepNhan.QuyetToanTheoNoiTru
                    };
                }
            }
            else if (loaiPhieu == LoaiPhieuThuChiThuNgan.ThuTamUng)
            {
                var taiKhoanBenhNhanThu = _taiKhoanBenhNhanThu.TableNoTracking.Include(o => o.YeuCauTiepNhan).Include(o => o.PhieuHoanUng)
                                                              .Include(o => o.NhanVienHuy).ThenInclude(o => o.User)
                                                              .Include(o => o.NhanVienThuHoi).ThenInclude(o => o.User)
                                                              .FirstOrDefault(o => o.Id == soPhieuId);
                if (taiKhoanBenhNhanThu != null)
                {
                    var hinhThucThanhToans = new List<string>();
                    if (taiKhoanBenhNhanThu.TienMat.GetValueOrDefault(0) != 0)
                    {
                        hinhThucThanhToans.Add("Tiền mặt");
                    }
                    if (taiKhoanBenhNhanThu.ChuyenKhoan.GetValueOrDefault(0) != 0)
                    {
                        hinhThucThanhToans.Add("Chuyển khoản");
                    }
                    if (taiKhoanBenhNhanThu.POS.GetValueOrDefault(0) != 0)
                    {
                        hinhThucThanhToans.Add("POS");
                    }
                    if (taiKhoanBenhNhanThu.CongNo.GetValueOrDefault(0) != 0)
                    {
                        hinhThucThanhToans.Add("Công nợ");
                    }
                    thongTinPhieuThu = new ThongTinPhieuThu
                    {
                        Id = taiKhoanBenhNhanThu.Id,
                        SoPhieu = taiKhoanBenhNhanThu.SoPhieuHienThi,
                        LoaiPhieuThuChiThuNgan = loaiPhieu,
                        DaHoanUng = taiKhoanBenhNhanThu.PhieuHoanUngId != null,
                        PhieuHoanUng = taiKhoanBenhNhanThu.PhieuHoanUng?.SoPhieuHienThi,
                        DaHuy = taiKhoanBenhNhanThu.DaHuy,
                        TienMat = taiKhoanBenhNhanThu.TienMat,
                        ChuyenKhoan = taiKhoanBenhNhanThu.ChuyenKhoan,
                        Pos = taiKhoanBenhNhanThu.POS,
                        CongNo = taiKhoanBenhNhanThu.CongNo,
                        HinhThucThanhToan = string.Join(", ", hinhThucThanhToans),
                        NgayThu = taiKhoanBenhNhanThu.NgayThu,
                        NoiDungThu = taiKhoanBenhNhanThu.NoiDungThu,
                        DaThuHoi = taiKhoanBenhNhanThu.DaThuHoi.GetValueOrDefault(),
                        NgayThuHoi = taiKhoanBenhNhanThu.NgayThuHoi,
                        NguoiThuHoiId = taiKhoanBenhNhanThu.NhanVienThuHoiId,
                        NguoiThuHoi = taiKhoanBenhNhanThu.NhanVienThuHoi?.User.HoTen,
                        NhanVienHuyPhieu = taiKhoanBenhNhanThu.NhanVienHuy?.User.HoTen,
                        NgayHuy = taiKhoanBenhNhanThu.NgayHuy,
                        DaChuyenVoNoiTru = taiKhoanBenhNhanThu.YeuCauTiepNhan.QuyetToanTheoNoiTru
                    };
                }
            }
            else if (loaiPhieu == LoaiPhieuThuChiThuNgan.ThuTheoChiPhi)
            {
                var taiKhoanBenhNhanThu = _taiKhoanBenhNhanThu.TableNoTracking
                    .Include(o => o.YeuCauTiepNhan)
                    .Include(o => o.TaiKhoanBenhNhanChis)
                    .Include(o => o.TaiKhoanBenhNhanChis).ThenInclude(o => o.YeuCauKhamBenh).ThenInclude(o => o.NhomGiaDichVuKhamBenhBenhVien)
                    .Include(o => o.TaiKhoanBenhNhanChis).ThenInclude(o => o.YeuCauKhamBenh).ThenInclude(o => o.NoiThucHien).ThenInclude(o => o.KhoaPhong)
                    .Include(o => o.TaiKhoanBenhNhanChis).ThenInclude(o => o.YeuCauKhamBenh).ThenInclude(o => o.NoiChiDinh).ThenInclude(o => o.KhoaPhong)
                    .Include(o => o.TaiKhoanBenhNhanChis).ThenInclude(o => o.YeuCauKhamBenh).ThenInclude(o => o.NoiDangKy).ThenInclude(o => o.KhoaPhong)
                    .Include(o => o.TaiKhoanBenhNhanChis).ThenInclude(o => o.YeuCauDichVuKyThuat).ThenInclude(o => o.NhomGiaDichVuKyThuatBenhVien)
                    .Include(o => o.TaiKhoanBenhNhanChis).ThenInclude(o => o.YeuCauDichVuKyThuat).ThenInclude(o => o.NoiThucHien).ThenInclude(o => o.KhoaPhong)
                    .Include(o => o.TaiKhoanBenhNhanChis).ThenInclude(o => o.YeuCauDichVuKyThuat).ThenInclude(o => o.NoiChiDinh).ThenInclude(o => o.KhoaPhong)
                    .Include(o => o.TaiKhoanBenhNhanChis).ThenInclude(o => o.YeuCauDuocPhamBenhVien).ThenInclude(o => o.DuocPhamBenhVien)
                    .Include(o => o.TaiKhoanBenhNhanChis).ThenInclude(o => o.YeuCauDuocPhamBenhVien).ThenInclude(o => o.DonViTinh)
                    .Include(o => o.TaiKhoanBenhNhanChis).ThenInclude(o => o.YeuCauDuocPhamBenhVien).ThenInclude(o => o.NoiCapThuoc).ThenInclude(o => o.KhoaPhong)
                    .Include(o => o.TaiKhoanBenhNhanChis).ThenInclude(o => o.YeuCauDuocPhamBenhVien).ThenInclude(o => o.NoiChiDinh).ThenInclude(o => o.KhoaPhong)
                    .Include(o => o.TaiKhoanBenhNhanChis).ThenInclude(o => o.YeuCauVatTuBenhVien).ThenInclude(o => o.VatTuBenhVien)
                    .Include(o => o.TaiKhoanBenhNhanChis).ThenInclude(o => o.YeuCauVatTuBenhVien).ThenInclude(o => o.YeuCauDichVuKyThuat)
                    .Include(o => o.TaiKhoanBenhNhanChis).ThenInclude(o => o.YeuCauVatTuBenhVien).ThenInclude(o => o.NoiCapVatTu).ThenInclude(o => o.KhoaPhong)
                    .Include(o => o.TaiKhoanBenhNhanChis).ThenInclude(o => o.YeuCauVatTuBenhVien).ThenInclude(o => o.NoiChiDinh).ThenInclude(o => o.KhoaPhong)
                    .Include(o => o.TaiKhoanBenhNhanChis).ThenInclude(o => o.YeuCauTruyenMau).ThenInclude(o => o.NoiThucHien).ThenInclude(o => o.KhoaPhong)
                    .Include(o => o.TaiKhoanBenhNhanChis).ThenInclude(o => o.YeuCauTruyenMau).ThenInclude(o => o.NoiChiDinh).ThenInclude(o => o.KhoaPhong)
                    .Include(o => o.TaiKhoanBenhNhanChis).ThenInclude(o => o.DonThuocThanhToanChiTiet).ThenInclude(o => o.DonViTinh)
                    .Include(o => o.TaiKhoanBenhNhanChis).ThenInclude(o => o.DonThuocThanhToanChiTietTheoPhieuThu).ThenInclude(o => o.DonViTinh)
                    .Include(o => o.TaiKhoanBenhNhanChis).ThenInclude(o => o.YeuCauDichVuGiuongBenhVienChiPhiBenhVien).ThenInclude(o => o.KhoaPhong)
                    .Include(o => o.TaiKhoanBenhNhanChis).ThenInclude(o => o.YeuCauDichVuGiuongBenhVienChiPhiBenhVien).ThenInclude(o => o.YeuCauDichVuGiuongBenhVienChiPhiBHYTs)
                    .Include(o => o.MienGiamChiPhis)
                    .Include(o => o.CongTyBaoHiemTuNhanCongNos)
                    .Include(o => o.NhanVienThuHoi).ThenInclude(o => o.User)
                    .Include(o => o.NhanVienHuy).ThenInclude(o => o.User).FirstOrDefault(o => o.Id == soPhieuId);
                if (taiKhoanBenhNhanThu != null)
                {
                    var tongBHYTTT = taiKhoanBenhNhanThu.TaiKhoanBenhNhanChis.Where(o => o.LoaiChiTienBenhNhan == Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi).Select(o => (decimal)o.SoLuong.GetValueOrDefault() * o.DonGiaBaoHiem.GetValueOrDefault() * o.TiLeBaoHiemThanhToan.GetValueOrDefault() / 100 * o.MucHuongBaoHiem.GetValueOrDefault() / 100).DefaultIfEmpty().Sum();
                    var tongChiPhiBNTT = taiKhoanBenhNhanThu.TaiKhoanBenhNhanChis.Where(o => o.LoaiChiTienBenhNhan == Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi).Select(o => o.TienChiPhi.GetValueOrDefault()).DefaultIfEmpty().Sum();
                    var tongMienGiam = taiKhoanBenhNhanThu.MienGiamChiPhis.Select(o => o.SoTien).DefaultIfEmpty().Sum();
                    var tongCongNoBaoHiemTuNhan = taiKhoanBenhNhanThu.CongTyBaoHiemTuNhanCongNos.Select(o => o.SoTien).DefaultIfEmpty().Sum();

                    var tongChiPhi = tongChiPhiBNTT + tongMienGiam + tongCongNoBaoHiemTuNhan + tongBHYTTT;
                    var benhNhanThanhToan = tongChiPhiBNTT + tongCongNoBaoHiemTuNhan;
                    decimal tienChuyenTuTrongGoi = 0;
                    if (tongChiPhiBNTT > (taiKhoanBenhNhanThu.TamUng.GetValueOrDefault() + taiKhoanBenhNhanThu.CongNo.GetValueOrDefault() + taiKhoanBenhNhanThu.TienMat.GetValueOrDefault() + taiKhoanBenhNhanThu.ChuyenKhoan.GetValueOrDefault() + taiKhoanBenhNhanThu.POS.GetValueOrDefault()))
                    {
                        tienChuyenTuTrongGoi = tongChiPhiBNTT - (taiKhoanBenhNhanThu.TamUng.GetValueOrDefault() +
                                                                 taiKhoanBenhNhanThu.CongNo.GetValueOrDefault() +
                                                                 taiKhoanBenhNhanThu.TienMat.GetValueOrDefault() +
                                                                 taiKhoanBenhNhanThu.ChuyenKhoan.GetValueOrDefault() +
                                                                 taiKhoanBenhNhanThu.POS.GetValueOrDefault());
                    }

                    thongTinPhieuThu = new ThongTinPhieuThu
                    {
                        Id = taiKhoanBenhNhanThu.Id,
                        SoPhieu = taiKhoanBenhNhanThu.SoPhieuHienThi,
                        LoaiPhieuThuChiThuNgan = loaiPhieu,
                        DaHuy = taiKhoanBenhNhanThu.DaHuy,
                        TongChiPhi = tongChiPhi,
                        BHYTThanhToan = tongBHYTTT,
                        MienGiam = tongMienGiam,
                        BenhNhanThanhToan = benhNhanThanhToan,
                        TienMat = tongChiPhiBNTT < (taiKhoanBenhNhanThu.TamUng.GetValueOrDefault() + taiKhoanBenhNhanThu.CongNo.GetValueOrDefault())
                                              ? (tongChiPhiBNTT - taiKhoanBenhNhanThu.CongNo.GetValueOrDefault())
                                                : taiKhoanBenhNhanThu.TamUng.GetValueOrDefault() + taiKhoanBenhNhanThu.TienMat.GetValueOrDefault() + tienChuyenTuTrongGoi,
                        ChuyenKhoan = taiKhoanBenhNhanThu.ChuyenKhoan.GetValueOrDefault(),
                        Pos = taiKhoanBenhNhanThu.POS.GetValueOrDefault(),
                        CongNo = taiKhoanBenhNhanThu.CongNo.GetValueOrDefault() + tongCongNoBaoHiemTuNhan,
                        TamUng = taiKhoanBenhNhanThu.TamUng.GetValueOrDefault(),
                        SoTienPhaiThuHoacChi = tongChiPhiBNTT < (taiKhoanBenhNhanThu.TamUng.GetValueOrDefault() + taiKhoanBenhNhanThu.CongNo.GetValueOrDefault())
                                              ? (taiKhoanBenhNhanThu.TamUng.GetValueOrDefault() + taiKhoanBenhNhanThu.CongNo.GetValueOrDefault() - tongChiPhiBNTT)
                                                : taiKhoanBenhNhanThu.TienMat.GetValueOrDefault() + taiKhoanBenhNhanThu.ChuyenKhoan.GetValueOrDefault() + taiKhoanBenhNhanThu.POS.GetValueOrDefault() + tienChuyenTuTrongGoi,
                        LaPhieuChi = tongChiPhiBNTT < taiKhoanBenhNhanThu.TamUng.GetValueOrDefault() + taiKhoanBenhNhanThu.CongNo.GetValueOrDefault(),
                        NgayThu = taiKhoanBenhNhanThu.NgayThu,
                        NoiDungThu = taiKhoanBenhNhanThu.NoiDungThu,
                        DaThuHoi = taiKhoanBenhNhanThu.DaThuHoi.GetValueOrDefault(),
                        NgayThuHoi = taiKhoanBenhNhanThu.NgayThuHoi,
                        NguoiThuHoiId = taiKhoanBenhNhanThu.NhanVienThuHoiId,
                        NguoiThuHoi = taiKhoanBenhNhanThu.NhanVienThuHoi?.User.HoTen,
                        NhanVienHuyPhieu = taiKhoanBenhNhanThu.NhanVienHuy?.User.HoTen,
                        NgayHuy = taiKhoanBenhNhanThu.NgayHuy,
                        ThuTienGoiDichVu = taiKhoanBenhNhanThu.ThuTienGoiDichVu,
                        DaChuyenVoNoiTru = taiKhoanBenhNhanThu.YeuCauTiepNhan.QuyetToanTheoNoiTru
                    };

                    foreach (var taiKhoanBenhNhanChi in taiKhoanBenhNhanThu.TaiKhoanBenhNhanChis.Where(o => o.LoaiChiTienBenhNhan == Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi))
                    {
                        var chiPhiDichVu = new ChiPhiKhamChuaBenhVo
                        {
                            TaiKhoanBenhNhanChiId = taiKhoanBenhNhanChi.Id,
                            Soluong = taiKhoanBenhNhanChi.SoLuong.GetValueOrDefault(),
                            DonGia = taiKhoanBenhNhanChi.Gia.GetValueOrDefault(),
                            KhongTinhPhi = false,
                            KiemTraBHYTXacNhan = true,
                            DuocHuongBHYT = taiKhoanBenhNhanChi.MucHuongBaoHiem.GetValueOrDefault() > 0,
                            DonGiaBHYT = taiKhoanBenhNhanChi.DonGiaBaoHiem.GetValueOrDefault(),
                            TiLeBaoHiemThanhToan = taiKhoanBenhNhanChi.TiLeBaoHiemThanhToan.GetValueOrDefault(),
                            MucHuongBaoHiem = taiKhoanBenhNhanChi.MucHuongBaoHiem.GetValueOrDefault(),
                            SoTienMG = taiKhoanBenhNhanChi.SoTienMienGiam.GetValueOrDefault(),

                            DaThanhToan = taiKhoanBenhNhanChi.TienChiPhi.GetValueOrDefault(),
                            DaHoanThu = taiKhoanBenhNhanThu.DaHuy != true && taiKhoanBenhNhanChi.DaHuy == true,
                            NgayThu = taiKhoanBenhNhanThu.NgayThu,
                            DaThucHien = true
                        };
                        if (taiKhoanBenhNhanChi.YeuCauKhamBenh != null)
                        {
                            chiPhiDichVu.Id = taiKhoanBenhNhanChi.YeuCauKhamBenh.Id;
                            chiPhiDichVu.NgayPhatSinh = taiKhoanBenhNhanChi.YeuCauKhamBenh.ThoiDiemChiDinh;
                            chiPhiDichVu.DichVuBenhVienId = taiKhoanBenhNhanChi.YeuCauKhamBenh.DichVuKhamBenhBenhVienId;
                            chiPhiDichVu.LoaiNhom = NhomChiPhiKhamChuaBenh.DichVuKhamBenh;
                            chiPhiDichVu.NhomChiPhiBangKe = NhomChiPhiBangKe.KhamBenh;
                            chiPhiDichVu.Ma = taiKhoanBenhNhanChi.YeuCauKhamBenh.MaDichVu;
                            chiPhiDichVu.Nhom = NhomChiPhiKhamChuaBenh.DichVuKhamBenh.GetDescription();
                            chiPhiDichVu.TenDichVu = taiKhoanBenhNhanChi.YeuCauKhamBenh.TenDichVu;
                            chiPhiDichVu.DonViTinh = "Lần";
                            chiPhiDichVu.LoaiGia = taiKhoanBenhNhanChi.YeuCauKhamBenh.NhomGiaDichVuKhamBenhBenhVien.Ten;
                            chiPhiDichVu.DanhSachCongNoChoThus = taiKhoanBenhNhanThu
                                .CongTyBaoHiemTuNhanCongNos.Where(o => o.YeuCauKhamBenhId == taiKhoanBenhNhanChi.YeuCauKhamBenh.Id).Select(o => new DanhSachCongNoVo { CongTyBaoHiemTuNhanId = o.CongTyBaoHiemTuNhanId, SoTienCongNoChoThu = o.SoTien })
                                .ToList();
                            chiPhiDichVu.DanhSachMienGiamVos = taiKhoanBenhNhanThu.MienGiamChiPhis
                                .Where(o => o.YeuCauKhamBenhId == taiKhoanBenhNhanChi.YeuCauKhamBenh.Id).GroupBy(
                                    o => new
                                    {
                                        o.LoaiMienGiam,
                                        o.YeuCauGoiDichVuId,
                                        o.TheVoucherId,
                                        o.MaTheVoucher,
                                        o.DoiTuongUuDaiId,
                                        o.LoaiChietKhau
                                    }, o => o,
                                                                (k, v) => new DanhSachMienGiamVo
                                                                {
                                                                    LoaiMienGiam = k.LoaiMienGiam,
                                                                    YeuCauGoiDichVuId = k.YeuCauGoiDichVuId,
                                                                    LoaiChietKhau = k.LoaiChietKhau,
                                                                    TheVoucherId = k.TheVoucherId,
                                                                    MaTheVoucher = k.MaTheVoucher,
                                                                    DoiTuongUuDaiId = k.DoiTuongUuDaiId,
                                                                    TiLe = v.Select(o => o.TiLe).DefaultIfEmpty().Sum(),
                                                                    SoTien = v.Select(o => o.SoTien).DefaultIfEmpty().Sum()
                                                                }).ToList();

                            chiPhiDichVu.GhiChuMienGiamThem = taiKhoanBenhNhanChi.YeuCauKhamBenh.GhiChuMienGiamThem;
                            chiPhiDichVu.NoiDungGhiChuMiemGiamId = taiKhoanBenhNhanChi.YeuCauKhamBenh.NoiDungGhiChuMiemGiamId;

                            chiPhiDichVu.NoiThucHien = taiKhoanBenhNhanChi.YeuCauKhamBenh.NoiThucHien != null
                                                            ? $"{taiKhoanBenhNhanChi.YeuCauKhamBenh.NoiThucHien.Ma} - {taiKhoanBenhNhanChi.YeuCauKhamBenh.NoiThucHien.Ten}"
                                                            : taiKhoanBenhNhanChi.YeuCauKhamBenh.NoiDangKy != null ? $"{taiKhoanBenhNhanChi.YeuCauKhamBenh.NoiDangKy.Ma} - {taiKhoanBenhNhanChi.YeuCauKhamBenh.NoiDangKy.Ten}" : string.Empty;
                            chiPhiDichVu.Khoa = taiKhoanBenhNhanChi.YeuCauKhamBenh.NoiThucHien != null
                                ? taiKhoanBenhNhanChi.YeuCauKhamBenh.NoiThucHien.KhoaPhong.Ten
                                : taiKhoanBenhNhanChi.YeuCauKhamBenh.NoiDangKy?.KhoaPhong.Ten;
                            chiPhiDichVu.DaThucHien = taiKhoanBenhNhanChi.YeuCauKhamBenh.ThoiDiemHoanThanh != null ||
                                                      taiKhoanBenhNhanChi.YeuCauKhamBenh.TrangThai == Enums.EnumTrangThaiYeuCauKhamBenh.DaKham;
                        }
                        else if (taiKhoanBenhNhanChi.YeuCauDichVuKyThuat != null)
                        {
                            chiPhiDichVu.Id = taiKhoanBenhNhanChi.YeuCauDichVuKyThuat.Id;
                            chiPhiDichVu.NgayPhatSinh = taiKhoanBenhNhanChi.YeuCauDichVuKyThuat.ThoiDiemChiDinh;
                            chiPhiDichVu.DichVuBenhVienId = taiKhoanBenhNhanChi.YeuCauDichVuKyThuat.DichVuKyThuatBenhVienId;
                            chiPhiDichVu.LoaiNhom = NhomChiPhiKhamChuaBenh.DichVuKyThuat;


                            switch (taiKhoanBenhNhanChi.YeuCauDichVuKyThuat.LoaiDichVuKyThuat)
                            {
                                case Enums.LoaiDichVuKyThuat.XetNghiem:
                                    chiPhiDichVu.NhomChiPhiBangKe = NhomChiPhiBangKe.XetNgiem;
                                    break;
                                case Enums.LoaiDichVuKyThuat.ChuanDoanHinhAnh:
                                    chiPhiDichVu.NhomChiPhiBangKe = NhomChiPhiBangKe.ChuanDoanHinhAnh;
                                    break;
                                case Enums.LoaiDichVuKyThuat.ThamDoChucNang:
                                    chiPhiDichVu.NhomChiPhiBangKe = NhomChiPhiBangKe.ThamDoChucNang;
                                    break;
                                case Enums.LoaiDichVuKyThuat.ThuThuatPhauThuat:
                                    chiPhiDichVu.NhomChiPhiBangKe = NhomChiPhiBangKe.ThuThuatPhauThuat;
                                    break;
                                default:
                                    chiPhiDichVu.NhomChiPhiBangKe = NhomChiPhiBangKe.DichVuKhac;
                                    break;
                            }

                            chiPhiDichVu.Ma = taiKhoanBenhNhanChi.YeuCauDichVuKyThuat.MaDichVu;
                            chiPhiDichVu.Nhom = NhomChiPhiKhamChuaBenh.DichVuKyThuat.GetDescription();
                            chiPhiDichVu.TenDichVu = taiKhoanBenhNhanChi.YeuCauDichVuKyThuat.TenDichVu;
                            chiPhiDichVu.DonViTinh = "Lần";
                            chiPhiDichVu.LoaiGia = taiKhoanBenhNhanChi.YeuCauDichVuKyThuat.NhomGiaDichVuKyThuatBenhVien.Ten;
                            chiPhiDichVu.DanhSachCongNoChoThus = taiKhoanBenhNhanThu
                                .CongTyBaoHiemTuNhanCongNos.Where(o => o.YeuCauDichVuKyThuatId == taiKhoanBenhNhanChi.YeuCauDichVuKyThuat.Id).Select(o => new DanhSachCongNoVo { CongTyBaoHiemTuNhanId = o.CongTyBaoHiemTuNhanId, SoTienCongNoChoThu = o.SoTien })
                                .ToList();
                            chiPhiDichVu.DanhSachMienGiamVos = taiKhoanBenhNhanThu.MienGiamChiPhis
                                .Where(o => o.YeuCauDichVuKyThuatId == taiKhoanBenhNhanChi.YeuCauDichVuKyThuat.Id).GroupBy(
                                    o => new
                                    {
                                        o.LoaiMienGiam,
                                        o.YeuCauGoiDichVuId,
                                        o.TheVoucherId,
                                        o.MaTheVoucher,
                                        o.DoiTuongUuDaiId,
                                        o.LoaiChietKhau
                                    }, o => o,
                                                                (k, v) => new DanhSachMienGiamVo
                                                                {
                                                                    LoaiMienGiam = k.LoaiMienGiam,
                                                                    YeuCauGoiDichVuId = k.YeuCauGoiDichVuId,
                                                                    LoaiChietKhau = k.LoaiChietKhau,
                                                                    TheVoucherId = k.TheVoucherId,
                                                                    MaTheVoucher = k.MaTheVoucher,
                                                                    DoiTuongUuDaiId = k.DoiTuongUuDaiId,
                                                                    TiLe = v.Select(o => o.TiLe).DefaultIfEmpty().Sum(),
                                                                    SoTien = v.Select(o => o.SoTien).DefaultIfEmpty().Sum()
                                                                }).ToList();

                            chiPhiDichVu.GhiChuMienGiamThem = taiKhoanBenhNhanChi.YeuCauDichVuKyThuat.GhiChuMienGiamThem;
                            chiPhiDichVu.NoiDungGhiChuMiemGiamId = taiKhoanBenhNhanChi.YeuCauDichVuKyThuat.NoiDungGhiChuMiemGiamId;

                            chiPhiDichVu.NoiThucHien = taiKhoanBenhNhanChi.YeuCauDichVuKyThuat.NoiThucHien != null
                                                            ? $"{taiKhoanBenhNhanChi.YeuCauDichVuKyThuat.NoiThucHien.Ma} - {taiKhoanBenhNhanChi.YeuCauDichVuKyThuat.NoiThucHien.Ten}"
                                                            : string.Empty;
                            chiPhiDichVu.Khoa = taiKhoanBenhNhanChi.YeuCauDichVuKyThuat.NoiThucHien != null
                                ? taiKhoanBenhNhanChi.YeuCauDichVuKyThuat.NoiThucHien.KhoaPhong.Ten
                                : taiKhoanBenhNhanChi.YeuCauDichVuKyThuat.NoiChiDinh.KhoaPhong.Ten;
                            chiPhiDichVu.DaThucHien = taiKhoanBenhNhanChi.YeuCauDichVuKyThuat.ThoiDiemHoanThanh != null ||
                                                      taiKhoanBenhNhanChi.YeuCauDichVuKyThuat.TrangThai == Enums.EnumTrangThaiYeuCauDichVuKyThuat.DaThucHien;
                        }
                        else if (taiKhoanBenhNhanChi.YeuCauDuocPhamBenhVien != null)
                        {
                            chiPhiDichVu.Id = taiKhoanBenhNhanChi.YeuCauDuocPhamBenhVien.Id;
                            chiPhiDichVu.NgayPhatSinh = taiKhoanBenhNhanChi.YeuCauDuocPhamBenhVien.ThoiDiemChiDinh;
                            chiPhiDichVu.DichVuBenhVienId = taiKhoanBenhNhanChi.YeuCauDuocPhamBenhVien.DuocPhamBenhVienId;
                            chiPhiDichVu.LoaiNhom = NhomChiPhiKhamChuaBenh.DuocPham;
                            chiPhiDichVu.NhomChiPhiBangKe = NhomChiPhiBangKe.ThuocDichTruyen;
                            chiPhiDichVu.Ma = taiKhoanBenhNhanChi.YeuCauDuocPhamBenhVien.DuocPhamBenhVien.Ma;
                            chiPhiDichVu.Nhom = NhomChiPhiKhamChuaBenh.DuocPham.GetDescription();
                            chiPhiDichVu.TenDichVu = taiKhoanBenhNhanChi.YeuCauDuocPhamBenhVien.Ten;
                            chiPhiDichVu.DonViTinh = taiKhoanBenhNhanChi.YeuCauDuocPhamBenhVien.DonViTinh?.Ten;
                            chiPhiDichVu.LoaiGia = string.Empty;
                            chiPhiDichVu.DanhSachCongNoChoThus = taiKhoanBenhNhanThu
                                .CongTyBaoHiemTuNhanCongNos.Where(o => o.YeuCauDuocPhamBenhVienId == taiKhoanBenhNhanChi.YeuCauDuocPhamBenhVien.Id).Select(o => new DanhSachCongNoVo { CongTyBaoHiemTuNhanId = o.CongTyBaoHiemTuNhanId, SoTienCongNoChoThu = o.SoTien })
                                .ToList();
                            chiPhiDichVu.DanhSachMienGiamVos = taiKhoanBenhNhanThu.MienGiamChiPhis
                                .Where(o => o.YeuCauDuocPhamBenhVienId == taiKhoanBenhNhanChi.YeuCauDuocPhamBenhVien.Id).GroupBy(
                                    o => new
                                    {
                                        o.LoaiMienGiam,
                                        o.TheVoucherId,
                                        o.MaTheVoucher,
                                        o.DoiTuongUuDaiId,
                                        o.LoaiChietKhau
                                    }, o => o,
                                                                (k, v) => new DanhSachMienGiamVo
                                                                {
                                                                    LoaiMienGiam = k.LoaiMienGiam,
                                                                    LoaiChietKhau = k.LoaiChietKhau,
                                                                    TheVoucherId = k.TheVoucherId,
                                                                    MaTheVoucher = k.MaTheVoucher,
                                                                    DoiTuongUuDaiId = k.DoiTuongUuDaiId,
                                                                    TiLe = v.Select(o => o.TiLe).DefaultIfEmpty().Sum(),
                                                                    SoTien = v.Select(o => o.SoTien).DefaultIfEmpty().Sum()
                                                                }).ToList();

                            chiPhiDichVu.GhiChuMienGiamThem = taiKhoanBenhNhanChi.YeuCauDuocPhamBenhVien.GhiChuMienGiamThem;
                            chiPhiDichVu.NoiDungGhiChuMiemGiamId = taiKhoanBenhNhanChi.YeuCauDuocPhamBenhVien.NoiDungGhiChuMiemGiamId;

                            chiPhiDichVu.Khoa = taiKhoanBenhNhanChi.YeuCauDuocPhamBenhVien.NoiCapThuoc != null
                                                            ? taiKhoanBenhNhanChi.YeuCauDuocPhamBenhVien.NoiCapThuoc.KhoaPhong.Ten
                                                            : taiKhoanBenhNhanChi.YeuCauDuocPhamBenhVien.NoiChiDinh.KhoaPhong.Ten;
                            chiPhiDichVu.DaThucHien = taiKhoanBenhNhanChi.YeuCauDuocPhamBenhVien.TrangThai == Enums.EnumYeuCauDuocPhamBenhVien.DaThucHien;
                        }
                        else if (taiKhoanBenhNhanChi.YeuCauVatTuBenhVien != null)
                        {
                            chiPhiDichVu.Id = taiKhoanBenhNhanChi.YeuCauVatTuBenhVien.Id;
                            chiPhiDichVu.NgayPhatSinh = taiKhoanBenhNhanChi.YeuCauVatTuBenhVien.ThoiDiemChiDinh;
                            chiPhiDichVu.DichVuBenhVienId = taiKhoanBenhNhanChi.YeuCauVatTuBenhVien.VatTuBenhVienId;
                            chiPhiDichVu.LoaiNhom = NhomChiPhiKhamChuaBenh.VatTuTieuHao;
                            chiPhiDichVu.NhomChiPhiBangKe = taiKhoanBenhNhanChi.YeuCauVatTuBenhVien.YeuCauDichVuKyThuat?.LanThucHien != null ? NhomChiPhiBangKe.GoiVatTu : NhomChiPhiBangKe.VatTuYte;
                            chiPhiDichVu.SoThuTuGoiTrongNhomChiPhiBangKe = taiKhoanBenhNhanChi.YeuCauVatTuBenhVien.YeuCauDichVuKyThuat?.LanThucHien ?? 0;
                            chiPhiDichVu.Ma = taiKhoanBenhNhanChi.YeuCauVatTuBenhVien.Ma;
                            chiPhiDichVu.Nhom = NhomChiPhiKhamChuaBenh.VatTuTieuHao.GetDescription();
                            chiPhiDichVu.TenDichVu = taiKhoanBenhNhanChi.YeuCauVatTuBenhVien.Ten;
                            chiPhiDichVu.DonViTinh = taiKhoanBenhNhanChi.YeuCauVatTuBenhVien.DonViTinh;
                            chiPhiDichVu.LoaiGia = string.Empty;
                            chiPhiDichVu.DanhSachCongNoChoThus = taiKhoanBenhNhanThu
                                .CongTyBaoHiemTuNhanCongNos.Where(o => o.YeuCauVatTuBenhVienId == taiKhoanBenhNhanChi.YeuCauVatTuBenhVien.Id).Select(o => new DanhSachCongNoVo { CongTyBaoHiemTuNhanId = o.CongTyBaoHiemTuNhanId, SoTienCongNoChoThu = o.SoTien })
                                .ToList();
                            chiPhiDichVu.DanhSachMienGiamVos = taiKhoanBenhNhanThu.MienGiamChiPhis
                                .Where(o => o.YeuCauVatTuBenhVienId == taiKhoanBenhNhanChi.YeuCauVatTuBenhVien.Id).GroupBy(
                                    o => new
                                    {
                                        o.LoaiMienGiam,
                                        o.TheVoucherId,
                                        o.MaTheVoucher,
                                        o.DoiTuongUuDaiId,
                                        o.LoaiChietKhau
                                    }, o => o,
                                                                (k, v) => new DanhSachMienGiamVo
                                                                {
                                                                    LoaiMienGiam = k.LoaiMienGiam,
                                                                    LoaiChietKhau = k.LoaiChietKhau,
                                                                    TheVoucherId = k.TheVoucherId,
                                                                    MaTheVoucher = k.MaTheVoucher,
                                                                    DoiTuongUuDaiId = k.DoiTuongUuDaiId,
                                                                    TiLe = v.Select(o => o.TiLe).DefaultIfEmpty().Sum(),
                                                                    SoTien = v.Select(o => o.SoTien).DefaultIfEmpty().Sum()
                                                                }).ToList();

                            chiPhiDichVu.GhiChuMienGiamThem = taiKhoanBenhNhanChi.YeuCauVatTuBenhVien.GhiChuMienGiamThem;
                            chiPhiDichVu.NoiDungGhiChuMiemGiamId = taiKhoanBenhNhanChi.YeuCauVatTuBenhVien.NoiDungGhiChuMiemGiamId;

                            chiPhiDichVu.Khoa = taiKhoanBenhNhanChi.YeuCauVatTuBenhVien.NoiCapVatTu != null
                                                            ? taiKhoanBenhNhanChi.YeuCauVatTuBenhVien.NoiCapVatTu.KhoaPhong.Ten
                                                            : taiKhoanBenhNhanChi.YeuCauVatTuBenhVien.NoiChiDinh.KhoaPhong.Ten;
                            chiPhiDichVu.DaThucHien = taiKhoanBenhNhanChi.YeuCauVatTuBenhVien.TrangThai == Enums.EnumYeuCauVatTuBenhVien.DaThucHien;
                        }
                        else if (taiKhoanBenhNhanChi.DonThuocThanhToanChiTietTheoPhieuThu != null)
                        {
                            chiPhiDichVu.Id = taiKhoanBenhNhanChi.DonThuocThanhToanChiTietTheoPhieuThu.Id;
                            chiPhiDichVu.NgayPhatSinh = taiKhoanBenhNhanChi.DonThuocThanhToanChiTietTheoPhieuThu.NgayPhatSinh;
                            chiPhiDichVu.DichVuBenhVienId = taiKhoanBenhNhanChi.DonThuocThanhToanChiTietTheoPhieuThu.DuocPhamId;
                            chiPhiDichVu.LoaiNhom = NhomChiPhiKhamChuaBenh.ToaThuoc;
                            chiPhiDichVu.NhomChiPhiBangKe = NhomChiPhiBangKe.ThuocDichTruyen;
                            chiPhiDichVu.Ma = string.Empty;
                            chiPhiDichVu.Nhom = NhomChiPhiKhamChuaBenh.ToaThuoc.GetDescription();
                            chiPhiDichVu.TenDichVu = taiKhoanBenhNhanChi.DonThuocThanhToanChiTietTheoPhieuThu.Ten;
                            chiPhiDichVu.DonViTinh = taiKhoanBenhNhanChi.DonThuocThanhToanChiTietTheoPhieuThu.DonViTinh?.Ten;
                            chiPhiDichVu.LoaiGia = string.Empty;
                            chiPhiDichVu.SoTienBaoHiemTuNhanChiTra = taiKhoanBenhNhanChi.DonThuocThanhToanChiTietTheoPhieuThu.SoTienBaoHiemTuNhanChiTra.GetValueOrDefault();
                            chiPhiDichVu.SoTienMG = taiKhoanBenhNhanChi.DonThuocThanhToanChiTietTheoPhieuThu.SoTienMienGiam.GetValueOrDefault();
                            chiPhiDichVu.Khoa = "Nhà thuốc";
                        }
                        else if (taiKhoanBenhNhanChi.DonThuocThanhToanChiTiet != null)
                        {
                            chiPhiDichVu.Id = taiKhoanBenhNhanChi.DonThuocThanhToanChiTiet.Id;
                            chiPhiDichVu.NgayPhatSinh = taiKhoanBenhNhanChi.DonThuocThanhToanChiTiet.CreatedOn;
                            chiPhiDichVu.DichVuBenhVienId = taiKhoanBenhNhanChi.DonThuocThanhToanChiTiet.DuocPhamId;
                            chiPhiDichVu.LoaiNhom = NhomChiPhiKhamChuaBenh.ToaThuoc;
                            chiPhiDichVu.NhomChiPhiBangKe = NhomChiPhiBangKe.ThuocDichTruyen;
                            chiPhiDichVu.Ma = string.Empty;
                            chiPhiDichVu.Nhom = NhomChiPhiKhamChuaBenh.ToaThuoc.GetDescription();
                            chiPhiDichVu.TenDichVu = taiKhoanBenhNhanChi.DonThuocThanhToanChiTiet.Ten;
                            chiPhiDichVu.DonViTinh = taiKhoanBenhNhanChi.DonThuocThanhToanChiTiet.DonViTinh?.Ten;
                            chiPhiDichVu.LoaiGia = string.Empty;
                            chiPhiDichVu.DanhSachCongNoChoThus = taiKhoanBenhNhanThu
                                .CongTyBaoHiemTuNhanCongNos.Where(o => o.DonThuocThanhToanChiTietId == taiKhoanBenhNhanChi.DonThuocThanhToanChiTiet.Id).Select(o => new DanhSachCongNoVo { CongTyBaoHiemTuNhanId = o.CongTyBaoHiemTuNhanId, SoTienCongNoChoThu = o.SoTien })
                                .ToList();
                            chiPhiDichVu.DanhSachMienGiamVos = taiKhoanBenhNhanThu.MienGiamChiPhis
                                .Where(o => o.DonThuocThanhToanChiTietId == taiKhoanBenhNhanChi.DonThuocThanhToanChiTiet.Id).GroupBy(
                                    o => new
                                    {
                                        o.LoaiMienGiam,
                                        o.TheVoucherId,
                                        o.MaTheVoucher,
                                        o.DoiTuongUuDaiId,
                                        o.LoaiChietKhau
                                    }, o => o,
                                                                (k, v) => new DanhSachMienGiamVo
                                                                {
                                                                    LoaiMienGiam = k.LoaiMienGiam,
                                                                    LoaiChietKhau = k.LoaiChietKhau,
                                                                    TheVoucherId = k.TheVoucherId,
                                                                    MaTheVoucher = k.MaTheVoucher,
                                                                    DoiTuongUuDaiId = k.DoiTuongUuDaiId,
                                                                    TiLe = v.Select(o => o.TiLe).DefaultIfEmpty().Sum(),
                                                                    SoTien = v.Select(o => o.SoTien).DefaultIfEmpty().Sum()
                                                                }).ToList();

                            chiPhiDichVu.GhiChuMienGiamThem = taiKhoanBenhNhanChi.DonThuocThanhToanChiTiet.GhiChuMienGiamThem;
                            chiPhiDichVu.NoiDungGhiChuMiemGiamId = taiKhoanBenhNhanChi.DonThuocThanhToanChiTiet.NoiDungGhiChuMiemGiamId;
                            chiPhiDichVu.DaThucHien = true;
                            chiPhiDichVu.Khoa = "Nhà thuốc";
                        }

                        thongTinPhieuThu.ChiPhiKhamChuaBenhVos.Add(chiPhiDichVu);
                    }

                }
            }
            else if (loaiPhieu == LoaiPhieuThuChiThuNgan.PhieuChi)
            {
                var taiKhoanBenhNhanThu = _taiKhoanBenhNhanThu.TableNoTracking
                    .Include(o => o.YeuCauTiepNhan)
                    .Include(o => o.TaiKhoanBenhNhanChis)
                    .Include(o => o.TaiKhoanBenhNhanChis).ThenInclude(o => o.YeuCauKhamBenh).ThenInclude(o => o.NhomGiaDichVuKhamBenhBenhVien)
                    .Include(o => o.TaiKhoanBenhNhanChis).ThenInclude(o => o.YeuCauKhamBenh).ThenInclude(o => o.NoiThucHien).ThenInclude(o => o.KhoaPhong)
                    .Include(o => o.TaiKhoanBenhNhanChis).ThenInclude(o => o.YeuCauKhamBenh).ThenInclude(o => o.NoiChiDinh).ThenInclude(o => o.KhoaPhong)
                    .Include(o => o.TaiKhoanBenhNhanChis).ThenInclude(o => o.YeuCauKhamBenh).ThenInclude(o => o.NoiDangKy).ThenInclude(o => o.KhoaPhong)
                    .Include(o => o.TaiKhoanBenhNhanChis).ThenInclude(o => o.YeuCauDichVuKyThuat).ThenInclude(o => o.NhomGiaDichVuKyThuatBenhVien)
                    .Include(o => o.TaiKhoanBenhNhanChis).ThenInclude(o => o.YeuCauDichVuKyThuat).ThenInclude(o => o.NoiThucHien).ThenInclude(o => o.KhoaPhong)
                    .Include(o => o.TaiKhoanBenhNhanChis).ThenInclude(o => o.YeuCauDichVuKyThuat).ThenInclude(o => o.NoiChiDinh).ThenInclude(o => o.KhoaPhong)
                    .Include(o => o.MienGiamChiPhis)
                    .Include(o => o.CongTyBaoHiemTuNhanCongNos)
                    .Include(o => o.NhanVienThuHoi).ThenInclude(o => o.User)
                    .Include(o => o.NhanVienHuy).ThenInclude(o => o.User).FirstOrDefault(o => o.Id == soPhieuId);
                if (taiKhoanBenhNhanThu != null)
                {
                    var tongBHYTTT = taiKhoanBenhNhanThu.TaiKhoanBenhNhanChis.Where(o => o.LoaiChiTienBenhNhan == Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi)
                        .Select(o => (decimal)o.SoLuong.GetValueOrDefault() * o.DonGiaBaoHiem.GetValueOrDefault() * o.TiLeBaoHiemThanhToan.GetValueOrDefault() / 100 * o.MucHuongBaoHiem.GetValueOrDefault() / 100).DefaultIfEmpty().Sum();
                    var tongChiPhiBNTT = taiKhoanBenhNhanThu.TaiKhoanBenhNhanChis.Where(o => o.LoaiChiTienBenhNhan == Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi).Select(o => o.TienChiPhi.GetValueOrDefault()).DefaultIfEmpty().Sum();
                    var tongChiPhi = tongChiPhiBNTT + tongBHYTTT;

                    thongTinPhieuThu = new ThongTinPhieuThu
                    {
                        Id = taiKhoanBenhNhanThu.Id,
                        SoPhieu = taiKhoanBenhNhanThu.SoPhieuHienThi,
                        LoaiPhieuThuChiThuNgan = loaiPhieu,
                        DaHuy = taiKhoanBenhNhanThu.DaHuy,
                        TongChiPhi = tongChiPhi,
                        BHYTThanhToan = tongBHYTTT,
                        NgayThu = taiKhoanBenhNhanThu.NgayThu,
                        NoiDungThu = taiKhoanBenhNhanThu.NoiDungThu,
                        DaThuHoi = taiKhoanBenhNhanThu.DaThuHoi.GetValueOrDefault(),
                        NgayThuHoi = taiKhoanBenhNhanThu.NgayThuHoi,
                        NguoiThuHoiId = taiKhoanBenhNhanThu.NhanVienThuHoiId,
                        NguoiThuHoi = taiKhoanBenhNhanThu.NhanVienThuHoi?.User.HoTen,
                        NhanVienHuyPhieu = taiKhoanBenhNhanThu.NhanVienHuy?.User.HoTen,
                        NgayHuy = taiKhoanBenhNhanThu.NgayHuy,
                        DaChuyenVoNoiTru = taiKhoanBenhNhanThu.YeuCauTiepNhan.QuyetToanTheoNoiTru
                    };

                    foreach (var taiKhoanBenhNhanChi in taiKhoanBenhNhanThu.TaiKhoanBenhNhanChis.Where(o => o.LoaiChiTienBenhNhan == Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi))
                    {
                        var chiPhiDichVu = new ChiPhiKhamChuaBenhVo
                        {
                            TaiKhoanBenhNhanChiId = taiKhoanBenhNhanChi.Id,
                            Soluong = taiKhoanBenhNhanChi.SoLuong.GetValueOrDefault(),
                            DonGia = taiKhoanBenhNhanChi.Gia.GetValueOrDefault(),
                            KhongTinhPhi = false,
                            KiemTraBHYTXacNhan = true,
                            DuocHuongBHYT = taiKhoanBenhNhanChi.MucHuongBaoHiem.GetValueOrDefault() > 0,
                            DonGiaBHYT = taiKhoanBenhNhanChi.DonGiaBaoHiem.GetValueOrDefault(),
                            TiLeBaoHiemThanhToan = taiKhoanBenhNhanChi.TiLeBaoHiemThanhToan.GetValueOrDefault(),
                            MucHuongBaoHiem = taiKhoanBenhNhanChi.MucHuongBaoHiem.GetValueOrDefault(),
                            SoTienMG = taiKhoanBenhNhanChi.SoTienMienGiam.GetValueOrDefault(),

                            DaThanhToan = taiKhoanBenhNhanChi.TienChiPhi.GetValueOrDefault(),
                            DaHoanThu = taiKhoanBenhNhanThu.DaHuy != true && taiKhoanBenhNhanChi.DaHuy == true,
                            NgayThu = taiKhoanBenhNhanThu.NgayThu
                        };
                        if (taiKhoanBenhNhanChi.YeuCauKhamBenh != null)
                        {
                            chiPhiDichVu.Id = taiKhoanBenhNhanChi.YeuCauKhamBenh.Id;
                            chiPhiDichVu.NgayPhatSinh = taiKhoanBenhNhanChi.YeuCauKhamBenh.ThoiDiemChiDinh;
                            chiPhiDichVu.DichVuBenhVienId = taiKhoanBenhNhanChi.YeuCauKhamBenh.DichVuKhamBenhBenhVienId;
                            chiPhiDichVu.LoaiNhom = NhomChiPhiKhamChuaBenh.DichVuKhamBenh;
                            chiPhiDichVu.NhomChiPhiBangKe = NhomChiPhiBangKe.KhamBenh;
                            chiPhiDichVu.Ma = taiKhoanBenhNhanChi.YeuCauKhamBenh.MaDichVu;
                            chiPhiDichVu.Nhom = NhomChiPhiKhamChuaBenh.DichVuKhamBenh.GetDescription();
                            chiPhiDichVu.TenDichVu = taiKhoanBenhNhanChi.YeuCauKhamBenh.TenDichVu;
                            chiPhiDichVu.DonViTinh = "Lần";
                            chiPhiDichVu.LoaiGia = taiKhoanBenhNhanChi.YeuCauKhamBenh.NhomGiaDichVuKhamBenhBenhVien.Ten;

                            chiPhiDichVu.NoiThucHien = taiKhoanBenhNhanChi.YeuCauKhamBenh.NoiThucHien != null
                                                            ? $"{taiKhoanBenhNhanChi.YeuCauKhamBenh.NoiThucHien.Ma} - {taiKhoanBenhNhanChi.YeuCauKhamBenh.NoiThucHien.Ten}"
                                                            : taiKhoanBenhNhanChi.YeuCauKhamBenh.NoiDangKy != null ? $"{taiKhoanBenhNhanChi.YeuCauKhamBenh.NoiDangKy.Ma} - {taiKhoanBenhNhanChi.YeuCauKhamBenh.NoiDangKy.Ten}" : string.Empty;
                            chiPhiDichVu.Khoa = taiKhoanBenhNhanChi.YeuCauKhamBenh.NoiThucHien != null
                                ? taiKhoanBenhNhanChi.YeuCauKhamBenh.NoiThucHien.KhoaPhong.Ten
                                : taiKhoanBenhNhanChi.YeuCauKhamBenh.NoiDangKy?.KhoaPhong.Ten;
                        }
                        else if (taiKhoanBenhNhanChi.YeuCauDichVuKyThuat != null)
                        {
                            chiPhiDichVu.Id = taiKhoanBenhNhanChi.YeuCauDichVuKyThuat.Id;
                            chiPhiDichVu.NgayPhatSinh = taiKhoanBenhNhanChi.YeuCauDichVuKyThuat.ThoiDiemChiDinh;
                            chiPhiDichVu.DichVuBenhVienId = taiKhoanBenhNhanChi.YeuCauDichVuKyThuat.DichVuKyThuatBenhVienId;
                            chiPhiDichVu.LoaiNhom = NhomChiPhiKhamChuaBenh.DichVuKyThuat;

                            switch (taiKhoanBenhNhanChi.YeuCauDichVuKyThuat.LoaiDichVuKyThuat)
                            {
                                case Enums.LoaiDichVuKyThuat.XetNghiem:
                                    chiPhiDichVu.NhomChiPhiBangKe = NhomChiPhiBangKe.XetNgiem;
                                    break;
                                case Enums.LoaiDichVuKyThuat.ChuanDoanHinhAnh:
                                    chiPhiDichVu.NhomChiPhiBangKe = NhomChiPhiBangKe.ChuanDoanHinhAnh;
                                    break;
                                case Enums.LoaiDichVuKyThuat.ThamDoChucNang:
                                    chiPhiDichVu.NhomChiPhiBangKe = NhomChiPhiBangKe.ThamDoChucNang;
                                    break;
                                case Enums.LoaiDichVuKyThuat.ThuThuatPhauThuat:
                                    chiPhiDichVu.NhomChiPhiBangKe = NhomChiPhiBangKe.ThuThuatPhauThuat;
                                    break;
                                default:
                                    chiPhiDichVu.NhomChiPhiBangKe = NhomChiPhiBangKe.DichVuKhac;
                                    break;
                            }

                            chiPhiDichVu.Ma = taiKhoanBenhNhanChi.YeuCauDichVuKyThuat.MaDichVu;
                            chiPhiDichVu.Nhom = NhomChiPhiKhamChuaBenh.DichVuKyThuat.GetDescription();
                            chiPhiDichVu.TenDichVu = taiKhoanBenhNhanChi.YeuCauDichVuKyThuat.TenDichVu;
                            chiPhiDichVu.DonViTinh = "Lần";
                            chiPhiDichVu.LoaiGia = taiKhoanBenhNhanChi.YeuCauDichVuKyThuat.NhomGiaDichVuKyThuatBenhVien.Ten;
                            chiPhiDichVu.NoiThucHien = taiKhoanBenhNhanChi.YeuCauDichVuKyThuat.NoiThucHien != null
                                                            ? $"{taiKhoanBenhNhanChi.YeuCauDichVuKyThuat.NoiThucHien.Ma} - {taiKhoanBenhNhanChi.YeuCauDichVuKyThuat.NoiThucHien.Ten}"
                                                            : string.Empty;
                            chiPhiDichVu.Khoa = taiKhoanBenhNhanChi.YeuCauDichVuKyThuat.NoiThucHien != null
                                ? taiKhoanBenhNhanChi.YeuCauDichVuKyThuat.NoiThucHien.KhoaPhong.Ten
                                : taiKhoanBenhNhanChi.YeuCauDichVuKyThuat.NoiChiDinh.KhoaPhong.Ten;
                        }

                        thongTinPhieuThu.ChiPhiKhamChuaBenhVos.Add(chiPhiDichVu);
                    }

                }
            }
            return thongTinPhieuThu;
        }

        public async Task LuuTamChiPhiNgoaiTru(ThuPhiKhamChuaBenhVo thuPhiKhamChuaBenhVo)
        {
            var ycTiepNhan = BaseRepository.GetById(thuPhiKhamChuaBenhVo.Id,
                x => x.Include(o => o.TheVoucherYeuCauTiepNhans).ThenInclude(g => g.TheVoucher).ThenInclude(v => v.Voucher).ThenInclude(v => v.VoucherChiTietMienGiams)
                    .Include(o => o.YeuCauKhamBenhs).ThenInclude(g => g.CongTyBaoHiemTuNhanCongNos)
                    .Include(o => o.YeuCauDichVuKyThuats).ThenInclude(g => g.CongTyBaoHiemTuNhanCongNos)
                    .Include(o => o.YeuCauDuocPhamBenhViens).ThenInclude(g => g.CongTyBaoHiemTuNhanCongNos)
                    .Include(o => o.YeuCauVatTuBenhViens).ThenInclude(g => g.CongTyBaoHiemTuNhanCongNos)
                    .Include(o => o.DonThuocThanhToans).ThenInclude(g => g.DonThuocThanhToanChiTiets)
                    .ThenInclude(g => g.CongTyBaoHiemTuNhanCongNos)
                    .Include(o => o.BenhNhan).ThenInclude(o => o.TaiKhoanBenhNhan)
                    .Include(o => o.TaiKhoanBenhNhanThus)
                    .Include(o => o.TaiKhoanBenhNhanChis)
                    .Include(o => o.DoiTuongUuDai).ThenInclude(ud => ud.DoiTuongUuDaiDichVuKhamBenhBenhViens)
                    .Include(o => o.DoiTuongUuDai).ThenInclude(ud => ud.DoiTuongUuDaiDichVuKyThuatBenhViens)
                    .Include(o => o.MienGiamChiPhis));

            //kiem tra thong tin truoc khi luu
            var ycKhamBenhExcept = thuPhiKhamChuaBenhVo.DanhSachChiPhiKhamChuaBenhDaChons
                    .Where(o => o.LoaiNhom == NhomChiPhiKhamChuaBenh.DichVuKhamBenh).Select(o => o.Id).Except(ycTiepNhan
                        .YeuCauKhamBenhs
                        .Where(o => o.YeuCauGoiDichVuId == null && o.GoiKhamSucKhoeId == null &&
                                    (o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan ||
                                     o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                                     o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                        .Select(o => o.Id));
            var ycKyThuatExcept = thuPhiKhamChuaBenhVo.DanhSachChiPhiKhamChuaBenhDaChons
                .Where(o => o.LoaiNhom == NhomChiPhiKhamChuaBenh.DichVuKyThuat).Select(o => o.Id).Except(ycTiepNhan
                    .YeuCauDichVuKyThuats
                    .Where(o => o.YeuCauGoiDichVuId == null && o.GoiKhamSucKhoeId == null &&
                                (o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan ||
                                 o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                                 o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                    .Select(o => o.Id));
            var ycDuocPhamExcept = thuPhiKhamChuaBenhVo.DanhSachChiPhiKhamChuaBenhDaChons
                .Where(o => o.LoaiNhom == NhomChiPhiKhamChuaBenh.DuocPham).Select(o => o.Id).Except(ycTiepNhan
                    .YeuCauDuocPhamBenhViens
                    .Where(o => o.YeuCauGoiDichVuId == null &&
                                (o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan ||
                                 o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                                 o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                    .Select(o => o.Id));
            var ycVatTuExcept = thuPhiKhamChuaBenhVo.DanhSachChiPhiKhamChuaBenhDaChons
                .Where(o => o.LoaiNhom == NhomChiPhiKhamChuaBenh.VatTuTieuHao).Select(o => o.Id).Except(ycTiepNhan
                    .YeuCauVatTuBenhViens
                    .Where(o => o.YeuCauGoiDichVuId == null &&
                                (o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan ||
                                 o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                                 o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                    .Select(o => o.Id));
            var ycToaThuocExcept = thuPhiKhamChuaBenhVo.DanhSachChiPhiKhamChuaBenhDaChons
                .Where(o => o.LoaiNhom == NhomChiPhiKhamChuaBenh.ToaThuoc).Select(o => o.Id).Except(ycTiepNhan
                    .DonThuocThanhToans
                    .Where(o => o.LoaiDonThuoc == Enums.EnumLoaiDonThuoc.ThuocBHYT &&
                                (o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan ||
                                 o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                                 o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                    .SelectMany(o => o.DonThuocThanhToanChiTiets)
                    .Select(o => o.Id));

            if (ycKhamBenhExcept.Any() || ycKyThuatExcept.Any() || ycDuocPhamExcept.Any() ||
                ycVatTuExcept.Any() || ycToaThuocExcept.Any())
                throw new Exception("Thông tin dịch vụ thanh toán không hợp lệ, vui lòng tải lại trang");


            var dsChiPhi = GetDanhSachChiPhiKhamChuaBenhChuaThu(thuPhiKhamChuaBenhVo.Id);
            var dsChiPhiDaChon = thuPhiKhamChuaBenhVo.DanhSachChiPhiKhamChuaBenhDaChons;

            foreach (var chiPhiKhamChuaBenhVo in dsChiPhiDaChon)
            {
                var chiphi = dsChiPhi.FirstOrDefault(o => o.LoaiNhom == chiPhiKhamChuaBenhVo.LoaiNhom && o.Id == chiPhiKhamChuaBenhVo.Id);
                if (chiphi == null || !chiphi.ThanhTien.AlmostEqual(chiPhiKhamChuaBenhVo.ThanhTien) || !chiphi.BHYTThanhToan.AlmostEqual(chiPhiKhamChuaBenhVo.BHYTThanhToan))
                {
                    throw new Exception("Thông tin dịch vụ thanh toán không hợp lệ, vui lòng tải lại trang");
                }
                if (chiPhiKhamChuaBenhVo.TongCongNo > chiPhiKhamChuaBenhVo.ThanhTien && chiPhiKhamChuaBenhVo.TongCongNo > Math.Round(chiPhiKhamChuaBenhVo.ThanhTien, 2, MidpointRounding.AwayFromZero))
                {
                    throw new Exception("Số tiền BHTN thanh toán lớn hơn thành tiền");
                }
                var soTienTruocMienGiam = chiPhiKhamChuaBenhVo.ThanhTien - chiPhiKhamChuaBenhVo.BHYTThanhToan;

                decimal soTienMienGiamTheoDv = 0;

                foreach (var mienGiamTheoTiLe in chiPhiKhamChuaBenhVo.DanhSachMienGiamVos.Where(o => o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoTiLe))
                {
                    mienGiamTheoTiLe.SoTien = Math.Round((soTienTruocMienGiam * mienGiamTheoTiLe.TiLe.GetValueOrDefault() / 100), 2, MidpointRounding.AwayFromZero);
                    soTienMienGiamTheoDv += mienGiamTheoTiLe.SoTien;
                }
                foreach (var mienGiamTheoTiLe in chiPhiKhamChuaBenhVo.DanhSachMienGiamVos.Where(o => o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoSoTien))
                {
                    soTienMienGiamTheoDv += mienGiamTheoTiLe.SoTien;
                }
                if (soTienMienGiamTheoDv > chiPhiKhamChuaBenhVo.ThanhTien && soTienMienGiamTheoDv > Math.Round(chiPhiKhamChuaBenhVo.ThanhTien, 2, MidpointRounding.AwayFromZero))
                {
                    throw new Exception("Số tiền miễn giảm lớn hơn thành tiền");
                }
                chiPhiKhamChuaBenhVo.SoTienMG = soTienMienGiamTheoDv;
            }

            foreach (var chiphi in dsChiPhiDaChon.Where(o => o.LoaiNhom == NhomChiPhiKhamChuaBenh.DichVuKhamBenh))
            {
                var yc = ycTiepNhan.YeuCauKhamBenhs.First(o => o.Id == chiphi.Id);
                #region cong no update 02/02/2021
                foreach (var ycCongTyBaoHiemTuNhanCongNo in yc.CongTyBaoHiemTuNhanCongNos.Where(o => o.TaiKhoanBenhNhanThuId == null))
                {
                    ycCongTyBaoHiemTuNhanCongNo.WillDelete = true;
                }
                if (chiphi.TongCongNo > 0)
                {
                    foreach (var chiphiDanhSachCongNoChoThu in chiphi.DanhSachCongNoChoThus)
                    {
                        if (chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu.AlmostEqual(0))
                            continue;
                        yc.CongTyBaoHiemTuNhanCongNos.Add(new CongTyBaoHiemTuNhanCongNo
                        {
                            CongTyBaoHiemTuNhanId = chiphiDanhSachCongNoChoThu.CongTyBaoHiemTuNhanId,
                            SoTien = chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu
                        });
                    }
                }
                yc.SoTienBaoHiemTuNhanChiTra = chiphi.TongCongNo;
                #endregion
                #region mien giam update 02/02/2021
                foreach (var mienGiam in yc.MienGiamChiPhis.Where(o => o.TaiKhoanBenhNhanThuId == null))
                {
                    mienGiam.WillDelete = true;
                }
                //mien giam theo uu dai noi gioi thieu: BVHD-3882
                var mienGiamNoiGioiThieu = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.NoiGioiThieuId != null);
                if (mienGiamNoiGioiThieu != null)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                        NoiGioiThieuId = mienGiamNoiGioiThieu.NoiGioiThieuId,
                        LoaiChietKhau = mienGiamNoiGioiThieu.LoaiChietKhau,
                        TiLe = mienGiamNoiGioiThieu.TiLe,
                        SoTien = mienGiamNoiGioiThieu.SoTien
                    });
                }
                //mien giam theo uu dai
                var mienGiamUuDai = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.DoiTuongUuDaiId != null && o.TiLe != 0);
                if (mienGiamUuDai != null)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                        DoiTuongUuDaiId = mienGiamUuDai.DoiTuongUuDaiId,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                        TiLe = mienGiamUuDai.TiLe.GetValueOrDefault(),
                        SoTien = mienGiamUuDai.SoTien
                    });
                }
                //mien giam theo voucher
                var mienGiamVouchers = chiphi.DanhSachMienGiamVos.Where(o => o.TheVoucherId != null).ToList();
                foreach (var voucher in mienGiamVouchers)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.Voucher,
                        TheVoucherId = voucher.TheVoucherId,
                        LoaiChietKhau = voucher.LoaiChietKhau,
                        MaTheVoucher = voucher.MaTheVoucher,
                        TiLe = voucher.TiLe.GetValueOrDefault(),
                        SoTien = voucher.SoTien
                    });
                }
                //mien giam them theo ti le
                var mienGiamThemTiLe = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoTiLe);
                if (mienGiamThemTiLe != null && mienGiamThemTiLe.TiLe.GetValueOrDefault() != 0)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                        TiLe = mienGiamThemTiLe.TiLe,
                        SoTien = mienGiamThemTiLe.SoTien
                    });
                }
                //mien giam them theo so tien
                var mienGiamThemSoTien = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoSoTien);
                if (mienGiamThemSoTien != null && !mienGiamThemSoTien.SoTien.AlmostEqual(0))
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoSoTien,
                        SoTien = mienGiamThemSoTien.SoTien
                    });
                }

                yc.SoTienMienGiam = chiphi.SoTienMG;
                if ((mienGiamThemTiLe?.SoTien ?? 0).AlmostEqual(0) && (mienGiamThemSoTien?.SoTien ?? 0).AlmostEqual(0))
                {
                    yc.GhiChuMienGiamThem = null;
                    yc.NoiDungGhiChuMiemGiamId = null;
                }
                else
                {
                    yc.GhiChuMienGiamThem = chiphi.GhiChuMienGiamThem;
                    yc.NoiDungGhiChuMiemGiamId = chiphi.NoiDungGhiChuMiemGiamId;
                }
                #endregion
            }

            foreach (var chiphi in dsChiPhiDaChon.Where(o => o.LoaiNhom == NhomChiPhiKhamChuaBenh.DichVuKyThuat))
            {
                var yc = ycTiepNhan.YeuCauDichVuKyThuats.First(o => o.Id == chiphi.Id);
                #region cong no update 02/02/2021
                foreach (var ycCongTyBaoHiemTuNhanCongNo in yc.CongTyBaoHiemTuNhanCongNos.Where(o => o.TaiKhoanBenhNhanThuId == null))
                {
                    ycCongTyBaoHiemTuNhanCongNo.WillDelete = true;
                }
                if (chiphi.TongCongNo > 0)
                {
                    foreach (var chiphiDanhSachCongNoChoThu in chiphi.DanhSachCongNoChoThus)
                    {
                        if (chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu.AlmostEqual(0))
                            continue;
                        yc.CongTyBaoHiemTuNhanCongNos.Add(new CongTyBaoHiemTuNhanCongNo
                        {
                            CongTyBaoHiemTuNhanId = chiphiDanhSachCongNoChoThu.CongTyBaoHiemTuNhanId,
                            SoTien = chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu
                        });
                    }
                }
                yc.SoTienBaoHiemTuNhanChiTra = chiphi.TongCongNo;
                #endregion
                #region mien giam update 02/02/2021
                foreach (var mienGiam in yc.MienGiamChiPhis.Where(o => o.TaiKhoanBenhNhanThuId == null))
                {
                    mienGiam.WillDelete = true;
                }
                //mien giam theo uu dai noi gioi thieu: BVHD-3882
                var mienGiamNoiGioiThieu = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.NoiGioiThieuId != null);
                if (mienGiamNoiGioiThieu != null)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                        NoiGioiThieuId = mienGiamNoiGioiThieu.NoiGioiThieuId,
                        LoaiChietKhau = mienGiamNoiGioiThieu.LoaiChietKhau,
                        TiLe = mienGiamNoiGioiThieu.TiLe,
                        SoTien = mienGiamNoiGioiThieu.SoTien
                    });
                }
                //mien giam theo uu dai
                var mienGiamUuDai = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.DoiTuongUuDaiId != null && o.TiLe != 0);
                if (mienGiamUuDai != null)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                        DoiTuongUuDaiId = mienGiamUuDai.DoiTuongUuDaiId,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                        TiLe = mienGiamUuDai.TiLe.GetValueOrDefault(),
                        SoTien = mienGiamUuDai.SoTien
                    });
                }
                //mien giam theo voucher
                var mienGiamVouchers = chiphi.DanhSachMienGiamVos.Where(o => o.TheVoucherId != null).ToList();
                foreach (var voucher in mienGiamVouchers)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.Voucher,
                        TheVoucherId = voucher.TheVoucherId,
                        LoaiChietKhau = voucher.LoaiChietKhau,
                        MaTheVoucher = voucher.MaTheVoucher,
                        TiLe = voucher.TiLe.GetValueOrDefault(),
                        SoTien = voucher.SoTien
                    });
                }
                //mien giam them theo ti le
                var mienGiamThemTiLe = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoTiLe);
                if (mienGiamThemTiLe != null && mienGiamThemTiLe.TiLe.GetValueOrDefault() != 0)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                        TiLe = mienGiamThemTiLe.TiLe,
                        SoTien = mienGiamThemTiLe.SoTien
                    });
                }
                //mien giam them theo so tien
                var mienGiamThemSoTien = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoSoTien);
                if (mienGiamThemSoTien != null && !mienGiamThemSoTien.SoTien.AlmostEqual(0))
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoSoTien,
                        SoTien = mienGiamThemSoTien.SoTien
                    });
                }

                yc.SoTienMienGiam = chiphi.SoTienMG;
                if ((mienGiamThemTiLe?.SoTien ?? 0).AlmostEqual(0) && (mienGiamThemSoTien?.SoTien ?? 0).AlmostEqual(0))
                {
                    yc.GhiChuMienGiamThem = null;
                    yc.NoiDungGhiChuMiemGiamId = null;
                }
                else
                {
                    yc.GhiChuMienGiamThem = chiphi.GhiChuMienGiamThem;
                    yc.NoiDungGhiChuMiemGiamId = chiphi.NoiDungGhiChuMiemGiamId;
                }
                #endregion
            }

            foreach (var chiphi in dsChiPhiDaChon.Where(o => o.LoaiNhom == NhomChiPhiKhamChuaBenh.DuocPham))
            {
                var yc = ycTiepNhan.YeuCauDuocPhamBenhViens.First(o => o.Id == chiphi.Id);
                #region cong no update 02/02/2021
                foreach (var ycCongTyBaoHiemTuNhanCongNo in yc.CongTyBaoHiemTuNhanCongNos.Where(o => o.TaiKhoanBenhNhanThuId == null))
                {
                    ycCongTyBaoHiemTuNhanCongNo.WillDelete = true;
                }
                if (chiphi.TongCongNo > 0)
                {
                    foreach (var chiphiDanhSachCongNoChoThu in chiphi.DanhSachCongNoChoThus)
                    {
                        if (chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu.AlmostEqual(0))
                            continue;
                        yc.CongTyBaoHiemTuNhanCongNos.Add(new CongTyBaoHiemTuNhanCongNo
                        {
                            CongTyBaoHiemTuNhanId = chiphiDanhSachCongNoChoThu.CongTyBaoHiemTuNhanId,
                            SoTien = chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu
                        });
                    }
                }
                yc.SoTienBaoHiemTuNhanChiTra = chiphi.TongCongNo;
                #endregion
                #region mien giam update 02/02/2021
                foreach (var mienGiam in yc.MienGiamChiPhis.Where(o => o.TaiKhoanBenhNhanThuId == null))
                {
                    mienGiam.WillDelete = true;
                }
                //mien giam theo uu dai noi gioi thieu: BVHD-3882
                var mienGiamNoiGioiThieu = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.NoiGioiThieuId != null);
                if (mienGiamNoiGioiThieu != null)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                        NoiGioiThieuId = mienGiamNoiGioiThieu.NoiGioiThieuId,
                        LoaiChietKhau = mienGiamNoiGioiThieu.LoaiChietKhau,
                        TiLe = mienGiamNoiGioiThieu.TiLe,
                        SoTien = mienGiamNoiGioiThieu.SoTien
                    });
                }
                //mien giam theo uu dai
                var mienGiamUuDai = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.DoiTuongUuDaiId != null && o.TiLe != 0);
                if (mienGiamUuDai != null)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                        DoiTuongUuDaiId = mienGiamUuDai.DoiTuongUuDaiId,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                        TiLe = mienGiamUuDai.TiLe.GetValueOrDefault(),
                        SoTien = mienGiamUuDai.SoTien
                    });
                }
                //mien giam theo voucher
                var mienGiamVouchers = chiphi.DanhSachMienGiamVos.Where(o => o.TheVoucherId != null).ToList();
                foreach (var voucher in mienGiamVouchers)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.Voucher,
                        TheVoucherId = voucher.TheVoucherId,
                        LoaiChietKhau = voucher.LoaiChietKhau,
                        MaTheVoucher = voucher.MaTheVoucher,
                        TiLe = voucher.TiLe.GetValueOrDefault(),
                        SoTien = voucher.SoTien
                    });
                }
                //mien giam them theo ti le
                var mienGiamThemTiLe = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoTiLe);
                if (mienGiamThemTiLe != null && mienGiamThemTiLe.TiLe.GetValueOrDefault() != 0)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                        TiLe = mienGiamThemTiLe.TiLe,
                        SoTien = mienGiamThemTiLe.SoTien
                    });
                }
                //mien giam them theo so tien
                var mienGiamThemSoTien = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoSoTien);
                if (mienGiamThemSoTien != null && !mienGiamThemSoTien.SoTien.AlmostEqual(0))
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoSoTien,
                        SoTien = mienGiamThemSoTien.SoTien
                    });
                }

                yc.SoTienMienGiam = chiphi.SoTienMG;
                if ((mienGiamThemTiLe?.SoTien ?? 0).AlmostEqual(0) && (mienGiamThemSoTien?.SoTien ?? 0).AlmostEqual(0))
                {
                    yc.GhiChuMienGiamThem = null;
                    yc.NoiDungGhiChuMiemGiamId = null;
                }
                else
                {
                    yc.GhiChuMienGiamThem = chiphi.GhiChuMienGiamThem;
                    yc.NoiDungGhiChuMiemGiamId = chiphi.NoiDungGhiChuMiemGiamId;
                }
                #endregion
            }

            foreach (var chiphi in dsChiPhiDaChon.Where(o => o.LoaiNhom == NhomChiPhiKhamChuaBenh.VatTuTieuHao))
            {
                var yc = ycTiepNhan.YeuCauVatTuBenhViens.First(o => o.Id == chiphi.Id);
                #region cong no update 02/02/2021
                foreach (var ycCongTyBaoHiemTuNhanCongNo in yc.CongTyBaoHiemTuNhanCongNos.Where(o => o.TaiKhoanBenhNhanThuId == null))
                {
                    ycCongTyBaoHiemTuNhanCongNo.WillDelete = true;
                }
                if (chiphi.TongCongNo > 0)
                {
                    foreach (var chiphiDanhSachCongNoChoThu in chiphi.DanhSachCongNoChoThus)
                    {
                        if (chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu.AlmostEqual(0))
                            continue;
                        yc.CongTyBaoHiemTuNhanCongNos.Add(new CongTyBaoHiemTuNhanCongNo
                        {
                            CongTyBaoHiemTuNhanId = chiphiDanhSachCongNoChoThu.CongTyBaoHiemTuNhanId,
                            SoTien = chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu
                        });
                    }
                }
                yc.SoTienBaoHiemTuNhanChiTra = chiphi.TongCongNo;
                #endregion
                #region mien giam update 02/02/2021
                foreach (var mienGiam in yc.MienGiamChiPhis.Where(o => o.TaiKhoanBenhNhanThuId == null))
                {
                    mienGiam.WillDelete = true;
                }
                //mien giam theo uu dai noi gioi thieu: BVHD-3882
                var mienGiamNoiGioiThieu = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.NoiGioiThieuId != null);
                if (mienGiamNoiGioiThieu != null)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                        NoiGioiThieuId = mienGiamNoiGioiThieu.NoiGioiThieuId,
                        LoaiChietKhau = mienGiamNoiGioiThieu.LoaiChietKhau,
                        TiLe = mienGiamNoiGioiThieu.TiLe,
                        SoTien = mienGiamNoiGioiThieu.SoTien
                    });
                }
                //mien giam theo uu dai
                var mienGiamUuDai = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.DoiTuongUuDaiId != null && o.TiLe != 0);
                if (mienGiamUuDai != null)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                        DoiTuongUuDaiId = mienGiamUuDai.DoiTuongUuDaiId,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                        TiLe = mienGiamUuDai.TiLe.GetValueOrDefault(),
                        SoTien = mienGiamUuDai.SoTien
                    });
                }
                //mien giam theo voucher
                var mienGiamVouchers = chiphi.DanhSachMienGiamVos.Where(o => o.TheVoucherId != null).ToList();
                foreach (var voucher in mienGiamVouchers)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.Voucher,
                        TheVoucherId = voucher.TheVoucherId,
                        LoaiChietKhau = voucher.LoaiChietKhau,
                        MaTheVoucher = voucher.MaTheVoucher,
                        TiLe = voucher.TiLe.GetValueOrDefault(),
                        SoTien = voucher.SoTien
                    });
                }
                //mien giam them theo ti le
                var mienGiamThemTiLe = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoTiLe);
                if (mienGiamThemTiLe != null && mienGiamThemTiLe.TiLe.GetValueOrDefault() != 0)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                        TiLe = mienGiamThemTiLe.TiLe,
                        SoTien = mienGiamThemTiLe.SoTien
                    });
                }
                //mien giam them theo so tien
                var mienGiamThemSoTien = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoSoTien);
                if (mienGiamThemSoTien != null && !mienGiamThemSoTien.SoTien.AlmostEqual(0))
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoSoTien,
                        SoTien = mienGiamThemSoTien.SoTien
                    });
                }

                yc.SoTienMienGiam = chiphi.SoTienMG;
                if ((mienGiamThemTiLe?.SoTien ?? 0).AlmostEqual(0) && (mienGiamThemSoTien?.SoTien ?? 0).AlmostEqual(0))
                {
                    yc.GhiChuMienGiamThem = null;
                    yc.NoiDungGhiChuMiemGiamId = null;
                }
                else
                {
                    yc.GhiChuMienGiamThem = chiphi.GhiChuMienGiamThem;
                    yc.NoiDungGhiChuMiemGiamId = chiphi.NoiDungGhiChuMiemGiamId;
                }
                #endregion
            }

            foreach (var chiphi in dsChiPhiDaChon.Where(o => o.LoaiNhom == NhomChiPhiKhamChuaBenh.ToaThuoc))
            {
                var yc = ycTiepNhan.DonThuocThanhToans.SelectMany(o => o.DonThuocThanhToanChiTiets).First(o => o.Id == chiphi.Id);
                #region cong no update 02/02/2021
                foreach (var ycCongTyBaoHiemTuNhanCongNo in yc.CongTyBaoHiemTuNhanCongNos.Where(o => o.TaiKhoanBenhNhanThuId == null))
                {
                    ycCongTyBaoHiemTuNhanCongNo.WillDelete = true;
                }
                if (chiphi.TongCongNo > 0)
                {
                    foreach (var chiphiDanhSachCongNoChoThu in chiphi.DanhSachCongNoChoThus)
                    {
                        if (chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu.AlmostEqual(0))
                            continue;
                        yc.CongTyBaoHiemTuNhanCongNos.Add(new CongTyBaoHiemTuNhanCongNo
                        {
                            CongTyBaoHiemTuNhanId = chiphiDanhSachCongNoChoThu.CongTyBaoHiemTuNhanId,
                            SoTien = chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu
                        });
                    }
                }
                yc.SoTienBaoHiemTuNhanChiTra = chiphi.TongCongNo;
                #endregion
                #region mien giam update 02/02/2021
                foreach (var mienGiam in yc.MienGiamChiPhis.Where(o => o.TaiKhoanBenhNhanThuId == null))
                {
                    mienGiam.WillDelete = true;
                }
                //mien giam theo uu dai noi gioi thieu: BVHD-3882
                var mienGiamNoiGioiThieu = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.NoiGioiThieuId != null);
                if (mienGiamNoiGioiThieu != null)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                        NoiGioiThieuId = mienGiamNoiGioiThieu.NoiGioiThieuId,
                        LoaiChietKhau = mienGiamNoiGioiThieu.LoaiChietKhau,
                        TiLe = mienGiamNoiGioiThieu.TiLe,
                        SoTien = mienGiamNoiGioiThieu.SoTien
                    });
                }
                //mien giam theo uu dai
                var mienGiamUuDai = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.DoiTuongUuDaiId != null && o.TiLe != 0);
                if (mienGiamUuDai != null)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                        DoiTuongUuDaiId = mienGiamUuDai.DoiTuongUuDaiId,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                        TiLe = mienGiamUuDai.TiLe.GetValueOrDefault(),
                        SoTien = mienGiamUuDai.SoTien
                    });
                }
                //mien giam theo voucher
                var mienGiamVouchers = chiphi.DanhSachMienGiamVos.Where(o => o.TheVoucherId != null).ToList();
                foreach (var voucher in mienGiamVouchers)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.Voucher,
                        TheVoucherId = voucher.TheVoucherId,
                        LoaiChietKhau = voucher.LoaiChietKhau,
                        MaTheVoucher = voucher.MaTheVoucher,
                        TiLe = voucher.TiLe.GetValueOrDefault(),
                        SoTien = voucher.SoTien
                    });
                }
                //mien giam them theo ti le
                var mienGiamThemTiLe = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoTiLe);
                if (mienGiamThemTiLe != null && mienGiamThemTiLe.TiLe.GetValueOrDefault() != 0)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                        TiLe = mienGiamThemTiLe.TiLe,
                        SoTien = mienGiamThemTiLe.SoTien
                    });
                }
                //mien giam them theo so tien
                var mienGiamThemSoTien = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoSoTien);
                if (mienGiamThemSoTien != null && !mienGiamThemSoTien.SoTien.AlmostEqual(0))
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoSoTien,
                        SoTien = mienGiamThemSoTien.SoTien
                    });
                }

                yc.SoTienMienGiam = chiphi.SoTienMG;
                if ((mienGiamThemTiLe?.SoTien ?? 0).AlmostEqual(0) && (mienGiamThemSoTien?.SoTien ?? 0).AlmostEqual(0))
                {
                    yc.GhiChuMienGiamThem = null;
                    yc.NoiDungGhiChuMiemGiamId = null;
                }
                else
                {
                    yc.GhiChuMienGiamThem = chiphi.GhiChuMienGiamThem;
                    yc.NoiDungGhiChuMiemGiamId = chiphi.NoiDungGhiChuMiemGiamId;
                }
                #endregion
            }
            var soTienTamUng = _taiKhoanBenhNhanService.GetSoTienDaTamUngAsync(ycTiepNhan.Id).Result;
            BaoLanhDvNgoaiGoiMarketing(ycTiepNhan, soTienTamUng - GetSoTienCanThanhToanNgoaiTru(ycTiepNhan));
            //await BaseRepository.UpdateAsync(ycTiepNhan);
            BaseRepository.Context.SaveChanges();
        }

        public async Task ApDungMiemGiamTuNoiGioiThieu(long yeuCauTiepNhanId)
        {
            var ycTiepNhan = BaseRepository.GetById(yeuCauTiepNhanId,
                x => x
                    .Include(o => o.YeuCauKhamBenhs).ThenInclude(g => g.MienGiamChiPhis)
                    .Include(o => o.YeuCauDichVuKyThuats).ThenInclude(g => g.MienGiamChiPhis)
                    .Include(o => o.YeuCauDuocPhamBenhViens).ThenInclude(g => g.MienGiamChiPhis)
                    .Include(o => o.YeuCauVatTuBenhViens).ThenInclude(g => g.MienGiamChiPhis)
                    .Include(o => o.DonThuocThanhToans).ThenInclude(g => g.DonThuocThanhToanChiTiets).ThenInclude(g => g.MienGiamChiPhis)
                    .Include(o => o.BenhNhan).ThenInclude(o => o.TaiKhoanBenhNhan));

            var chiTietMienGiams = _noiGioiThieuChiTietMienGiamRepository.TableNoTracking.Where(o => o.NoiGioiThieuId == ycTiepNhan.NoiGioiThieuId).OrderByDescending(o=>o.Id).ToList();

            foreach (var yc in ycTiepNhan.YeuCauKhamBenhs.Where(yc => yc.YeuCauGoiDichVuId == null && yc.GoiKhamSucKhoeId == null && yc.TrangThai != Enums.EnumTrangThaiYeuCauKhamBenh.HuyKham &&
                             (yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                              yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan)))
            {                
                foreach (var mienGiam in yc.MienGiamChiPhis.Where(o => o.TaiKhoanBenhNhanThuId == null && o.NoiGioiThieuId != null))
                {
                    mienGiam.WillDelete = true;
                    yc.SoTienMienGiam = yc.SoTienMienGiam.GetValueOrDefault() - mienGiam.SoTien;
                }
                //mien giam theo uu dai noi gioi thieu: BVHD-3882
                var chiTietMienGiam = chiTietMienGiams.FirstOrDefault(o=>o.DichVuKhamBenhBenhVienId == yc.DichVuKhamBenhBenhVienId && o.NhomGiaDichVuKhamBenhBenhVienId == yc.NhomGiaDichVuKhamBenhBenhVienId);
                if (chiTietMienGiam != null)
                {
                    var mienGiamChiPhi = new MienGiamChiPhi
                    {
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                        NoiGioiThieuId = chiTietMienGiam.NoiGioiThieuId,
                        LoaiChietKhau = chiTietMienGiam.LoaiChietKhau,
                        TiLe = chiTietMienGiam.TiLeChietKhau
                    };
                    if (chiTietMienGiam.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoTiLe)
                    {
                        var soTienTruocMienGiam = (yc.KhongTinhPhi == true ? 0 : (decimal)(1 * yc.Gia)) - (yc.BaoHiemChiTra == true ? (decimal)(1 * (yc.DonGiaBaoHiem.GetValueOrDefault() * yc.TiLeBaoHiemThanhToan.GetValueOrDefault() / 100 * yc.MucHuongBaoHiem.GetValueOrDefault() / 100)) : 0);
                        var soTienMienGiamTheoTiLe = Math.Round((soTienTruocMienGiam * chiTietMienGiam.TiLeChietKhau.GetValueOrDefault() / 100), 2, MidpointRounding.AwayFromZero);

                        mienGiamChiPhi.SoTien = soTienMienGiamTheoTiLe;
                        yc.SoTienMienGiam = yc.SoTienMienGiam.GetValueOrDefault() + soTienMienGiamTheoTiLe;
                    }
                    else
                    {
                        mienGiamChiPhi.SoTien = chiTietMienGiam.SoTienChietKhau.GetValueOrDefault();
                        yc.SoTienMienGiam = yc.SoTienMienGiam.GetValueOrDefault() + chiTietMienGiam.SoTienChietKhau.GetValueOrDefault();
                    }

                    yc.MienGiamChiPhis.Add(mienGiamChiPhi);
                }
            }

            foreach (var yc in ycTiepNhan.YeuCauDichVuKyThuats.Where(yc => yc.YeuCauGoiDichVuId == null && yc.GoiKhamSucKhoeId == null && yc.TrangThai != Enums.EnumTrangThaiYeuCauDichVuKyThuat.DaHuy &&
                             (yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                              yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan)))
            {
                foreach (var mienGiam in yc.MienGiamChiPhis.Where(o => o.TaiKhoanBenhNhanThuId == null && o.NoiGioiThieuId != null))
                {
                    mienGiam.WillDelete = true;
                    yc.SoTienMienGiam = yc.SoTienMienGiam.GetValueOrDefault() - mienGiam.SoTien;
                }
                //mien giam theo uu dai noi gioi thieu: BVHD-3882
                var chiTietMienGiam = chiTietMienGiams.FirstOrDefault(o => o.DichVuKyThuatBenhVienId == yc.DichVuKyThuatBenhVienId && o.NhomGiaDichVuKyThuatBenhVienId == yc.NhomGiaDichVuKyThuatBenhVienId);
                if (chiTietMienGiam != null)
                {
                    var mienGiamChiPhi = new MienGiamChiPhi
                    {
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                        NoiGioiThieuId = chiTietMienGiam.NoiGioiThieuId,
                        LoaiChietKhau = chiTietMienGiam.LoaiChietKhau,
                        TiLe = chiTietMienGiam.TiLeChietKhau
                    };
                    if (chiTietMienGiam.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoTiLe)
                    {
                        var soTienTruocMienGiam = (yc.KhongTinhPhi == true ? 0 : (decimal)(yc.SoLan * yc.Gia)) - (yc.BaoHiemChiTra == true ? (decimal)(yc.SoLan * (yc.DonGiaBaoHiem.GetValueOrDefault() * yc.TiLeBaoHiemThanhToan.GetValueOrDefault() / 100 * yc.MucHuongBaoHiem.GetValueOrDefault() / 100)) : 0);
                        var soTienMienGiamTheoTiLe = Math.Round((soTienTruocMienGiam * chiTietMienGiam.TiLeChietKhau.GetValueOrDefault() / 100), 2, MidpointRounding.AwayFromZero);

                        mienGiamChiPhi.SoTien = soTienMienGiamTheoTiLe;
                        yc.SoTienMienGiam = yc.SoTienMienGiam.GetValueOrDefault() + soTienMienGiamTheoTiLe;
                    }
                    else
                    {
                        mienGiamChiPhi.SoTien = (yc.SoLan * chiTietMienGiam.SoTienChietKhau.GetValueOrDefault());
                        yc.SoTienMienGiam = yc.SoTienMienGiam.GetValueOrDefault() + (yc.SoLan * chiTietMienGiam.SoTienChietKhau.GetValueOrDefault());
                    }

                    yc.MienGiamChiPhis.Add(mienGiamChiPhi);
                }
            }

            foreach (var yc in ycTiepNhan.YeuCauDuocPhamBenhViens.Where(yc => yc.YeuCauGoiDichVuId == null && yc.TrangThai != Enums.EnumYeuCauDuocPhamBenhVien.DaHuy &&
                             (yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                              yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan)))
            {
                foreach (var mienGiam in yc.MienGiamChiPhis.Where(o => o.TaiKhoanBenhNhanThuId == null && o.NoiGioiThieuId != null))
                {
                    mienGiam.WillDelete = true;
                    yc.SoTienMienGiam = yc.SoTienMienGiam.GetValueOrDefault() - mienGiam.SoTien;
                }
                //mien giam theo uu dai noi gioi thieu: BVHD-3882
                var chiTietMienGiam = chiTietMienGiams.FirstOrDefault(o => o.DuocPhamBenhVienId == yc.DuocPhamBenhVienId);
                if (chiTietMienGiam != null)
                {
                    var mienGiamChiPhi = new MienGiamChiPhi
                    {
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                        NoiGioiThieuId = chiTietMienGiam.NoiGioiThieuId,
                        LoaiChietKhau = chiTietMienGiam.LoaiChietKhau,
                        TiLe = chiTietMienGiam.TiLeChietKhau
                    };
                    if (chiTietMienGiam.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoTiLe)
                    {
                        var soTienTruocMienGiam = (yc.KhongTinhPhi == true ? 0 : (decimal)((decimal)yc.SoLuong * yc.DonGiaBan)) - (yc.BaoHiemChiTra == true ? (decimal)((decimal)yc.SoLuong * (yc.DonGiaBaoHiem.GetValueOrDefault() * yc.TiLeBaoHiemThanhToan.GetValueOrDefault() / 100 * yc.MucHuongBaoHiem.GetValueOrDefault() / 100)) : 0);
                        var soTienMienGiamTheoTiLe = Math.Round((soTienTruocMienGiam * chiTietMienGiam.TiLeChietKhau.GetValueOrDefault() / 100), 2, MidpointRounding.AwayFromZero);

                        mienGiamChiPhi.SoTien = soTienMienGiamTheoTiLe;
                        yc.SoTienMienGiam = yc.SoTienMienGiam.GetValueOrDefault() + soTienMienGiamTheoTiLe;
                    }
                    else
                    {
                        mienGiamChiPhi.SoTien = (decimal)yc.SoLuong * chiTietMienGiam.SoTienChietKhau.GetValueOrDefault();
                        yc.SoTienMienGiam = yc.SoTienMienGiam.GetValueOrDefault() + ((decimal)yc.SoLuong * chiTietMienGiam.SoTienChietKhau.GetValueOrDefault());
                    }

                    yc.MienGiamChiPhis.Add(mienGiamChiPhi);
                }
            }

            foreach (var yc in ycTiepNhan.YeuCauVatTuBenhViens.Where(yc => yc.YeuCauGoiDichVuId == null && yc.TrangThai != Enums.EnumYeuCauVatTuBenhVien.DaHuy &&
                             (yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                              yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan)))
            {
                foreach (var mienGiam in yc.MienGiamChiPhis.Where(o => o.TaiKhoanBenhNhanThuId == null && o.NoiGioiThieuId != null))
                {
                    mienGiam.WillDelete = true;
                    yc.SoTienMienGiam = yc.SoTienMienGiam.GetValueOrDefault() - mienGiam.SoTien;
                }
                //mien giam theo uu dai noi gioi thieu: BVHD-3882
                var chiTietMienGiam = chiTietMienGiams.FirstOrDefault(o => o.VatTuBenhVienId == yc.VatTuBenhVienId);
                if (chiTietMienGiam != null)
                {
                    var mienGiamChiPhi = new MienGiamChiPhi
                    {
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                        NoiGioiThieuId = chiTietMienGiam.NoiGioiThieuId,
                        LoaiChietKhau = chiTietMienGiam.LoaiChietKhau,
                        TiLe = chiTietMienGiam.TiLeChietKhau
                    };
                    if (chiTietMienGiam.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoTiLe)
                    {
                        var soTienTruocMienGiam = (yc.KhongTinhPhi == true ? 0 : (decimal)((decimal)yc.SoLuong * yc.DonGiaBan)) - (yc.BaoHiemChiTra == true ? (decimal)((decimal)yc.SoLuong * (yc.DonGiaBaoHiem.GetValueOrDefault() * yc.TiLeBaoHiemThanhToan.GetValueOrDefault() / 100 * yc.MucHuongBaoHiem.GetValueOrDefault() / 100)) : 0);
                        var soTienMienGiamTheoTiLe = Math.Round((soTienTruocMienGiam * chiTietMienGiam.TiLeChietKhau.GetValueOrDefault() / 100), 2, MidpointRounding.AwayFromZero);

                        mienGiamChiPhi.SoTien = soTienMienGiamTheoTiLe;
                        yc.SoTienMienGiam = yc.SoTienMienGiam.GetValueOrDefault() + soTienMienGiamTheoTiLe;
                    }
                    else
                    {
                        mienGiamChiPhi.SoTien = (decimal)yc.SoLuong * chiTietMienGiam.SoTienChietKhau.GetValueOrDefault();
                        yc.SoTienMienGiam = yc.SoTienMienGiam.GetValueOrDefault() + ((decimal)yc.SoLuong * chiTietMienGiam.SoTienChietKhau.GetValueOrDefault());
                    }

                    yc.MienGiamChiPhis.Add(mienGiamChiPhi);
                }
            }

            foreach (var yc in ycTiepNhan.DonThuocThanhToans
                .Where(dt => dt.LoaiDonThuoc == Enums.EnumLoaiDonThuoc.ThuocBHYT && dt.TrangThai != Enums.TrangThaiDonThuocThanhToan.DaHuy &&
                    (dt.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || dt.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                     dt.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                .SelectMany(o => o.DonThuocThanhToanChiTiets))
            {
                foreach (var mienGiam in yc.MienGiamChiPhis.Where(o => o.TaiKhoanBenhNhanThuId == null && o.NoiGioiThieuId != null))
                {
                    mienGiam.WillDelete = true;
                    yc.SoTienMienGiam = yc.SoTienMienGiam.GetValueOrDefault() - mienGiam.SoTien;
                }
                //mien giam theo uu dai noi gioi thieu: BVHD-3882
                var chiTietMienGiam = chiTietMienGiams.FirstOrDefault(o => o.DuocPhamBenhVienId == yc.DuocPhamId);
                if (chiTietMienGiam != null)
                {
                    var mienGiamChiPhi = new MienGiamChiPhi
                    {
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                        NoiGioiThieuId = chiTietMienGiam.NoiGioiThieuId,
                        LoaiChietKhau = chiTietMienGiam.LoaiChietKhau,
                        TiLe = chiTietMienGiam.TiLeChietKhau
                    };
                    if (chiTietMienGiam.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoTiLe)
                    {
                        var soTienTruocMienGiam = (decimal)((decimal)yc.SoLuong * yc.DonGiaBan) - (yc.BaoHiemChiTra == true ? (decimal)((decimal)yc.SoLuong * (yc.DonGiaBaoHiem.GetValueOrDefault() * yc.TiLeBaoHiemThanhToan.GetValueOrDefault() / 100 * yc.MucHuongBaoHiem.GetValueOrDefault() / 100)) : 0);
                        var soTienMienGiamTheoTiLe = Math.Round((soTienTruocMienGiam * chiTietMienGiam.TiLeChietKhau.GetValueOrDefault() / 100), 2, MidpointRounding.AwayFromZero);

                        mienGiamChiPhi.SoTien = soTienMienGiamTheoTiLe;
                        yc.SoTienMienGiam = yc.SoTienMienGiam.GetValueOrDefault() + soTienMienGiamTheoTiLe;
                    }
                    else
                    {
                        mienGiamChiPhi.SoTien = (decimal)yc.SoLuong * chiTietMienGiam.SoTienChietKhau.GetValueOrDefault();
                        yc.SoTienMienGiam = yc.SoTienMienGiam.GetValueOrDefault() + ((decimal)yc.SoLuong * chiTietMienGiam.SoTienChietKhau.GetValueOrDefault());
                    }

                    yc.MienGiamChiPhis.Add(mienGiamChiPhi);
                }
            }
            var soTienTamUng = _taiKhoanBenhNhanService.GetSoTienDaTamUngAsync(ycTiepNhan.Id).Result;
            BaoLanhDvNgoaiGoiMarketing(ycTiepNhan, soTienTamUng - GetSoTienCanThanhToanNgoaiTru(ycTiepNhan));
            BaseRepository.Context.SaveChanges();
        }

        public async Task HuyApDungMiemGiamTuNoiGioiThieu(long yeuCauTiepNhanId)
        {
            var ycTiepNhan = BaseRepository.GetById(yeuCauTiepNhanId,
                x => x
                    .Include(o => o.YeuCauKhamBenhs).ThenInclude(g => g.MienGiamChiPhis)
                    .Include(o => o.YeuCauDichVuKyThuats).ThenInclude(g => g.MienGiamChiPhis)
                    .Include(o => o.YeuCauDuocPhamBenhViens).ThenInclude(g => g.MienGiamChiPhis)
                    .Include(o => o.YeuCauVatTuBenhViens).ThenInclude(g => g.MienGiamChiPhis)
                    .Include(o => o.DonThuocThanhToans).ThenInclude(g => g.DonThuocThanhToanChiTiets).ThenInclude(g => g.MienGiamChiPhis)
                    .Include(o => o.BenhNhan).ThenInclude(o => o.TaiKhoanBenhNhan));

            foreach (var yc in ycTiepNhan.YeuCauKhamBenhs.Where(yc => yc.YeuCauGoiDichVuId == null && yc.GoiKhamSucKhoeId == null && yc.TrangThai != Enums.EnumTrangThaiYeuCauKhamBenh.HuyKham &&
                             (yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                              yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan)))
            {
                foreach (var mienGiam in yc.MienGiamChiPhis.Where(o => o.TaiKhoanBenhNhanThuId == null && o.NoiGioiThieuId != null))
                {
                    mienGiam.WillDelete = true;
                    yc.SoTienMienGiam = yc.SoTienMienGiam.GetValueOrDefault() - mienGiam.SoTien;
                }
            }

            foreach (var yc in ycTiepNhan.YeuCauDichVuKyThuats.Where(yc => yc.YeuCauGoiDichVuId == null && yc.GoiKhamSucKhoeId == null && yc.TrangThai != Enums.EnumTrangThaiYeuCauDichVuKyThuat.DaHuy &&
                             (yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                              yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan)))
            {
                foreach (var mienGiam in yc.MienGiamChiPhis.Where(o => o.TaiKhoanBenhNhanThuId == null && o.NoiGioiThieuId != null))
                {
                    mienGiam.WillDelete = true;
                    yc.SoTienMienGiam = yc.SoTienMienGiam.GetValueOrDefault() - mienGiam.SoTien;
                }
            }

            foreach (var yc in ycTiepNhan.YeuCauDuocPhamBenhViens.Where(yc => yc.YeuCauGoiDichVuId == null && yc.TrangThai != Enums.EnumYeuCauDuocPhamBenhVien.DaHuy &&
                             (yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                              yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan)))
            {
                foreach (var mienGiam in yc.MienGiamChiPhis.Where(o => o.TaiKhoanBenhNhanThuId == null && o.NoiGioiThieuId != null))
                {
                    mienGiam.WillDelete = true;
                    yc.SoTienMienGiam = yc.SoTienMienGiam.GetValueOrDefault() - mienGiam.SoTien;
                }
            }

            foreach (var yc in ycTiepNhan.YeuCauVatTuBenhViens.Where(yc => yc.YeuCauGoiDichVuId == null && yc.TrangThai != Enums.EnumYeuCauVatTuBenhVien.DaHuy &&
                             (yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                              yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan)))
            {
                foreach (var mienGiam in yc.MienGiamChiPhis.Where(o => o.TaiKhoanBenhNhanThuId == null && o.NoiGioiThieuId != null))
                {
                    mienGiam.WillDelete = true;
                    yc.SoTienMienGiam = yc.SoTienMienGiam.GetValueOrDefault() - mienGiam.SoTien;
                }
            }

            foreach (var yc in ycTiepNhan.DonThuocThanhToans
                .Where(dt => dt.LoaiDonThuoc == Enums.EnumLoaiDonThuoc.ThuocBHYT && dt.TrangThai != Enums.TrangThaiDonThuocThanhToan.DaHuy &&
                    (dt.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || dt.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                     dt.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                .SelectMany(o => o.DonThuocThanhToanChiTiets))
            {
                foreach (var mienGiam in yc.MienGiamChiPhis.Where(o => o.TaiKhoanBenhNhanThuId == null && o.NoiGioiThieuId != null))
                {
                    mienGiam.WillDelete = true;
                    yc.SoTienMienGiam = yc.SoTienMienGiam.GetValueOrDefault() - mienGiam.SoTien;
                }
            }
            BaseRepository.Context.SaveChanges();
        }

        public void HuyPhieu(ThongTinHuyPhieuVo thongTinHuyPhieuVo)
        {
            if (thongTinHuyPhieuVo.LoaiPhieuThuChiThuNgan == LoaiPhieuThuChiThuNgan.ThuTamUng)
            {
                HuyTamUng(thongTinHuyPhieuVo);
            }
            else if (thongTinHuyPhieuVo.LoaiPhieuThuChiThuNgan == LoaiPhieuThuChiThuNgan.ThuTheoChiPhi)
            {
                HuyPhieuThu(thongTinHuyPhieuVo);
            }
            else if (thongTinHuyPhieuVo.LoaiPhieuThuChiThuNgan == LoaiPhieuThuChiThuNgan.PhieuChi)
            {
                HuyPhieuChi(thongTinHuyPhieuVo);
            }
        }
        public void CapnhatNguoiThuHoiPhieuThu(ThongTinHuyPhieuVo thongTinHuyPhieuVo)
        {
            var phieuTamUng = _taiKhoanBenhNhanThu.GetById(thongTinHuyPhieuVo.SoPhieu, o => o.Include(x => x.TaiKhoanBenhNhan));
            phieuTamUng.LyDoHuy = thongTinHuyPhieuVo.LyDo;
            phieuTamUng.DaThuHoi = thongTinHuyPhieuVo.ThoiGianThuHoi != null;
            phieuTamUng.NhanVienThuHoiId = thongTinHuyPhieuVo.NguoiThuHoiId;
            phieuTamUng.NgayThuHoi = thongTinHuyPhieuVo.ThoiGianThuHoi;

            _taiKhoanBenhNhanThu.Update(phieuTamUng);
        }
        private void HuyTamUng(ThongTinHuyPhieuVo thongTinHuyPhieuVo)
        {
            var phieuTamUng = _taiKhoanBenhNhanThu.GetById(thongTinHuyPhieuVo.SoPhieu, o => o.Include(x => x.TaiKhoanBenhNhan));
            if (phieuTamUng.PhieuHoanUngId != null)
            {
                throw new Exception("Không thể hủy phiếu tạm ứng đã được hoàn ứng");
            }
            if (phieuTamUng.DaHuy == true)
            {
                throw new Exception("Phiếu tạm ứng đã được hủy");
            }
            phieuTamUng.TaiKhoanBenhNhan.SoDuTaiKhoan -= phieuTamUng.TienMat.GetValueOrDefault() +
                                                         phieuTamUng.ChuyenKhoan.GetValueOrDefault() +
                                                         phieuTamUng.POS.GetValueOrDefault();
            phieuTamUng.DaHuy = true;
            phieuTamUng.NhanVienHuyId = _userAgentHelper.GetCurrentUserId();
            phieuTamUng.NoiHuyId = _userAgentHelper.GetCurrentNoiLLamViecId();
            phieuTamUng.NgayHuy = DateTime.Now;
            phieuTamUng.LyDoHuy = thongTinHuyPhieuVo.LyDo;
            phieuTamUng.DaThuHoi = thongTinHuyPhieuVo.ThoiGianThuHoi != null;
            phieuTamUng.NhanVienThuHoiId = thongTinHuyPhieuVo.NguoiThuHoiId;
            phieuTamUng.NgayThuHoi = thongTinHuyPhieuVo.ThoiGianThuHoi;
            _taiKhoanBenhNhanThu.Update(phieuTamUng);
        }
        private void HuyPhieuThu(ThongTinHuyPhieuVo thongTinHuyPhieuVo)
        {
            var phieuThu = _taiKhoanBenhNhanThu.GetById(thongTinHuyPhieuVo.SoPhieu,
                o => o.Include(x => x.YeuCauTiepNhan).ThenInclude(x => x.YeuCauKhamBenhs)
                    .Include(x => x.YeuCauTiepNhan).ThenInclude(x => x.YeuCauDichVuKyThuats)
                    .Include(x => x.YeuCauTiepNhan).ThenInclude(x => x.YeuCauDuocPhamBenhViens)
                    .Include(x => x.YeuCauTiepNhan).ThenInclude(x => x.YeuCauVatTuBenhViens)
                    .Include(x => x.YeuCauTiepNhan).ThenInclude(x => x.DonThuocThanhToans).ThenInclude(x => x.DonThuocThanhToanChiTiets)
                    .Include(x => x.TaiKhoanBenhNhan)
                    .Include(x => x.TaiKhoanBenhNhanChis).ThenInclude(c => c.TaiKhoanBenhNhanThus)
                    .Include(x => x.TaiKhoanBenhNhanChis).ThenInclude(c => c.YeuCauKhamBenh)
                    .Include(x => x.TaiKhoanBenhNhanChis).ThenInclude(c => c.YeuCauDichVuKyThuat)
                    .Include(x => x.TaiKhoanBenhNhanChis).ThenInclude(c => c.YeuCauDuocPhamBenhVien)
                    .Include(x => x.TaiKhoanBenhNhanChis).ThenInclude(c => c.YeuCauVatTuBenhVien)
                    .Include(x => x.TaiKhoanBenhNhanChis).ThenInclude(c => c.DonThuocThanhToanChiTiet).ThenInclude(ct => ct.DonThuocThanhToan)
                    .Include(x => x.TaiKhoanBenhNhanChis).ThenInclude(c => c.DonVTYTThanhToanChiTiet).ThenInclude(ct => ct.DonVTYTThanhToan)
                    .Include(x => x.CongTyBaoHiemTuNhanCongNos).ThenInclude(ct => ct.CongTyBaoHiemTuNhan)
                    .Include(x => x.MienGiamChiPhis));
            if (phieuThu.DaHuy == true)
            {
                throw new Exception("Phiếu thu đã được hủy");
            }
            if (phieuThu.ThuTienGoiDichVu == true)
            {
                var phieuHoanUngs = phieuThu.TaiKhoanBenhNhanChis.Where(o => o.LoaiChiTienBenhNhan == Enums.LoaiChiTienBenhNhan.HoanUng).ToList();
                foreach (var phieuHoanUng in phieuHoanUngs)
                {
                    phieuHoanUng.DaHuy = true;
                    phieuHoanUng.NgayHuy = DateTime.Now;
                    phieuHoanUng.NhanVienHuyId = _userAgentHelper.GetCurrentUserId();
                    phieuHoanUng.NoiHuyId = _userAgentHelper.GetCurrentNoiLLamViecId();
                    phieuHoanUng.LyDoHuy = thongTinHuyPhieuVo.LyDo;
                    phieuHoanUng.DaThuHoi = thongTinHuyPhieuVo.ThoiGianThuHoi != null;
                    phieuHoanUng.NhanVienThuHoiId = thongTinHuyPhieuVo.NguoiThuHoiId;
                    phieuHoanUng.NgayThuHoi = thongTinHuyPhieuVo.ThoiGianThuHoi;
                }
                foreach (var phieuThuTaiKhoanBenhNhanChi in phieuThu.TaiKhoanBenhNhanChis.Where(o => o.LoaiChiTienBenhNhan == Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi))
                {
                    phieuThuTaiKhoanBenhNhanChi.DaHuy = true;
                    phieuThuTaiKhoanBenhNhanChi.NhanVienHuyId = _userAgentHelper.GetCurrentUserId();
                    phieuThuTaiKhoanBenhNhanChi.NoiHuyId = _userAgentHelper.GetCurrentNoiLLamViecId();
                    phieuThuTaiKhoanBenhNhanChi.LyDoHuy = thongTinHuyPhieuVo.LyDo;
                    if (phieuThuTaiKhoanBenhNhanChi.YeuCauKhamBenh != null)
                    {
                        phieuThuTaiKhoanBenhNhanChi.YeuCauKhamBenh.SoTienBenhNhanDaChi = 0;
                        phieuThuTaiKhoanBenhNhanChi.YeuCauKhamBenh.SoTienBaoHiemTuNhanChiTra = 0;
                        phieuThuTaiKhoanBenhNhanChi.YeuCauKhamBenh.TrangThaiThanhToan = Enums.TrangThaiThanhToan.BaoLanhThanhToan;
                    }
                    if (phieuThuTaiKhoanBenhNhanChi.YeuCauDichVuKyThuat != null)
                    {
                        phieuThuTaiKhoanBenhNhanChi.YeuCauDichVuKyThuat.SoTienBenhNhanDaChi = 0;
                        phieuThuTaiKhoanBenhNhanChi.YeuCauDichVuKyThuat.SoTienBaoHiemTuNhanChiTra = 0;
                        phieuThuTaiKhoanBenhNhanChi.YeuCauDichVuKyThuat.TrangThaiThanhToan = Enums.TrangThaiThanhToan.BaoLanhThanhToan;
                    }
                }

                phieuThu.DaHuy = true;
                phieuThu.NhanVienHuyId = _userAgentHelper.GetCurrentUserId();
                phieuThu.NoiHuyId = _userAgentHelper.GetCurrentNoiLLamViecId();
                phieuThu.NgayHuy = DateTime.Now;
                phieuThu.LyDoHuy = thongTinHuyPhieuVo.LyDo;
                phieuThu.DaThuHoi = thongTinHuyPhieuVo.ThoiGianThuHoi != null;
                phieuThu.NhanVienThuHoiId = thongTinHuyPhieuVo.NguoiThuHoiId;
                phieuThu.NgayThuHoi = thongTinHuyPhieuVo.ThoiGianThuHoi;
                //bo duyet tu dong
                //if (phieuThu.YeuCauTiepNhan.CoBHYT == true)
                //{
                //    DuyetBHYT(phieuThu.YeuCauTiepNhan, (long)Enums.NhanVienHeThong.NhanVienDuyetBHYTTuDong, (long)Enums.PhongHeThong.PhongDuyetBHYTToanTuDong, 0);
                //}

                _taiKhoanBenhNhanThu.Update(phieuThu);
            }
            else
            {
                var soTienTamUng = _taiKhoanBenhNhanService.GetSoTienDaTamUngAsync(phieuThu.YeuCauTiepNhanId).Result;
                var phieuHoanUng = phieuThu.TaiKhoanBenhNhanChis.FirstOrDefault(o => o.LoaiChiTienBenhNhan == Enums.LoaiChiTienBenhNhan.HoanUng);
                if (phieuHoanUng != null && thongTinHuyPhieuVo.HuyPhieuHoanUng == true)
                {
                    var soTienHoanUng = phieuHoanUng.TienMat.GetValueOrDefault();
                    soTienTamUng += soTienHoanUng;
                    phieuThu.TaiKhoanBenhNhan.SoDuTaiKhoan += soTienHoanUng;
                    phieuHoanUng.DaHuy = true;
                    phieuHoanUng.NgayHuy = DateTime.Now;
                    phieuHoanUng.NhanVienHuyId = _userAgentHelper.GetCurrentUserId();
                    phieuHoanUng.NoiHuyId = _userAgentHelper.GetCurrentNoiLLamViecId();
                    phieuHoanUng.LyDoHuy = thongTinHuyPhieuVo.LyDo;
                    phieuHoanUng.DaThuHoi = thongTinHuyPhieuVo.ThoiGianThuHoi != null;
                    phieuHoanUng.NhanVienThuHoiId = thongTinHuyPhieuVo.NguoiThuHoiId;
                    phieuHoanUng.NgayThuHoi = thongTinHuyPhieuVo.ThoiGianThuHoi;
                    foreach (var taiKhoanBenhNhanThu in phieuHoanUng.TaiKhoanBenhNhanThus)
                    {
                        taiKhoanBenhNhanThu.PhieuHoanUngId = null;
                    }
                }

                foreach (var phieuThuCongTyBaoHiemTuNhanCongNo in phieuThu.CongTyBaoHiemTuNhanCongNos)
                {
                    phieuThuCongTyBaoHiemTuNhanCongNo.CongTyBaoHiemTuNhan.CongTyBaoHiemTuNhanCongNos.Add(new CongTyBaoHiemTuNhanCongNo
                    {
                        TaiKhoanBenhNhanThuId = null,
                        SoTien = phieuThuCongTyBaoHiemTuNhanCongNo.SoTien,
                        YeuCauKhamBenhId = phieuThuCongTyBaoHiemTuNhanCongNo.YeuCauKhamBenhId,
                        YeuCauDichVuKyThuatId = phieuThuCongTyBaoHiemTuNhanCongNo.YeuCauDichVuKyThuatId,
                        YeuCauDuocPhamBenhVienId = phieuThuCongTyBaoHiemTuNhanCongNo.YeuCauDuocPhamBenhVienId,
                        YeuCauVatTuBenhVienId = phieuThuCongTyBaoHiemTuNhanCongNo.YeuCauVatTuBenhVienId,
                        YeuCauDichVuGiuongBenhVienId = phieuThuCongTyBaoHiemTuNhanCongNo.YeuCauDichVuGiuongBenhVienId,
                        DonThuocThanhToanChiTietId = phieuThuCongTyBaoHiemTuNhanCongNo.DonThuocThanhToanChiTietId,
                        YeuCauGoiDichVuId = phieuThuCongTyBaoHiemTuNhanCongNo.YeuCauGoiDichVuId,
                        DonVTYTThanhToanChiTietId = phieuThuCongTyBaoHiemTuNhanCongNo.DonVTYTThanhToanChiTietId,
                        YeuCauTruyenMauId = phieuThuCongTyBaoHiemTuNhanCongNo.YeuCauTruyenMauId,
                        YeuCauDichVuGiuongBenhVienChiPhiBenhVienId = phieuThuCongTyBaoHiemTuNhanCongNo.YeuCauDichVuGiuongBenhVienChiPhiBenhVienId,
                    });
                }
                foreach (var mienGiamChiPhi in phieuThu.MienGiamChiPhis)
                {
                    phieuThu.YeuCauTiepNhan.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThuId = null,
                        LoaiMienGiam = mienGiamChiPhi.LoaiMienGiam,
                        SoTien = mienGiamChiPhi.SoTien,
                        TheVoucherId = mienGiamChiPhi.TheVoucherId,
                        YeuCauKhamBenhId = mienGiamChiPhi.YeuCauKhamBenhId,
                        YeuCauDichVuKyThuatId = mienGiamChiPhi.YeuCauDichVuKyThuatId,
                        YeuCauDuocPhamBenhVienId = mienGiamChiPhi.YeuCauDuocPhamBenhVienId,
                        YeuCauVatTuBenhVienId = mienGiamChiPhi.YeuCauVatTuBenhVienId,
                        YeuCauDichVuGiuongBenhVienId = mienGiamChiPhi.YeuCauDichVuGiuongBenhVienId,
                        YeuCauGoiDichVuId = mienGiamChiPhi.YeuCauGoiDichVuId,
                        DonThuocThanhToanChiTietId = mienGiamChiPhi.DonThuocThanhToanChiTietId,
                        DonVTYTThanhToanChiTietId = mienGiamChiPhi.DonVTYTThanhToanChiTietId,
                        LoaiChietKhau = mienGiamChiPhi.LoaiChietKhau,
                        TiLe = mienGiamChiPhi.TiLe,
                        MaTheVoucher = mienGiamChiPhi.MaTheVoucher,
                        DoiTuongUuDaiId = mienGiamChiPhi.DoiTuongUuDaiId,
                        NoiGioiThieuId = mienGiamChiPhi.NoiGioiThieuId,
                        YeuCauTruyenMauId = mienGiamChiPhi.YeuCauTruyenMauId,
                        YeuCauDichVuGiuongBenhVienChiPhiBenhVienId = mienGiamChiPhi.YeuCauDichVuGiuongBenhVienChiPhiBenhVienId
                    });
                    mienGiamChiPhi.YeuCauGoiDichVuId = null;
                }
                foreach (var phieuThuTaiKhoanBenhNhanChi in phieuThu.TaiKhoanBenhNhanChis.Where(o => o.LoaiChiTienBenhNhan == Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi))
                {
                    if (phieuThuTaiKhoanBenhNhanChi.DaHuy == true)
                    {
                        throw new Exception("Có dịch vụ đã hoàn thu");
                    }

                    phieuThuTaiKhoanBenhNhanChi.DaHuy = true;
                    phieuThuTaiKhoanBenhNhanChi.NhanVienHuyId = _userAgentHelper.GetCurrentUserId();
                    phieuThuTaiKhoanBenhNhanChi.NoiHuyId = _userAgentHelper.GetCurrentNoiLLamViecId();
                    phieuThuTaiKhoanBenhNhanChi.LyDoHuy = thongTinHuyPhieuVo.LyDo;
                    if (phieuThuTaiKhoanBenhNhanChi.YeuCauKhamBenh != null)
                    {
                        phieuThuTaiKhoanBenhNhanChi.YeuCauKhamBenh.SoTienBenhNhanDaChi = 0;
                        phieuThuTaiKhoanBenhNhanChi.YeuCauKhamBenh.TrangThaiThanhToan = Enums.TrangThaiThanhToan.CapNhatThanhToan;
                    }
                    if (phieuThuTaiKhoanBenhNhanChi.YeuCauDichVuKyThuat != null)
                    {
                        phieuThuTaiKhoanBenhNhanChi.YeuCauDichVuKyThuat.SoTienBenhNhanDaChi = 0;
                        phieuThuTaiKhoanBenhNhanChi.YeuCauDichVuKyThuat.TrangThaiThanhToan = Enums.TrangThaiThanhToan.CapNhatThanhToan;
                    }
                    if (phieuThuTaiKhoanBenhNhanChi.YeuCauDuocPhamBenhVien != null)
                    {
                        phieuThuTaiKhoanBenhNhanChi.YeuCauDuocPhamBenhVien.SoTienBenhNhanDaChi = 0;
                        phieuThuTaiKhoanBenhNhanChi.YeuCauDuocPhamBenhVien.TrangThaiThanhToan = Enums.TrangThaiThanhToan.ChuaThanhToan;
                    }
                    if (phieuThuTaiKhoanBenhNhanChi.YeuCauVatTuBenhVien != null)
                    {
                        phieuThuTaiKhoanBenhNhanChi.YeuCauVatTuBenhVien.SoTienBenhNhanDaChi = 0;
                        phieuThuTaiKhoanBenhNhanChi.YeuCauVatTuBenhVien.TrangThaiThanhToan = Enums.TrangThaiThanhToan.ChuaThanhToan;
                    }
                    if (phieuThuTaiKhoanBenhNhanChi.DonThuocThanhToanChiTiet != null)
                    {
                        phieuThuTaiKhoanBenhNhanChi.DonThuocThanhToanChiTiet.SoTienBenhNhanDaChi = 0;
                        phieuThuTaiKhoanBenhNhanChi.DonThuocThanhToanChiTiet.DonThuocThanhToan.TrangThaiThanhToan = Enums.TrangThaiThanhToan.ChuaThanhToan;
                    }
                    if (phieuThuTaiKhoanBenhNhanChi.DonVTYTThanhToanChiTiet != null)
                    {
                        phieuThuTaiKhoanBenhNhanChi.DonVTYTThanhToanChiTiet.SoTienBenhNhanDaChi = 0;
                        phieuThuTaiKhoanBenhNhanChi.DonVTYTThanhToanChiTiet.DonVTYTThanhToan.TrangThaiThanhToan = Enums.TrangThaiThanhToan.ChuaThanhToan;
                    }
                }

                phieuThu.DaHuy = true;
                phieuThu.NhanVienHuyId = _userAgentHelper.GetCurrentUserId();
                phieuThu.NoiHuyId = _userAgentHelper.GetCurrentNoiLLamViecId();
                phieuThu.NgayHuy = DateTime.Now;
                phieuThu.LyDoHuy = thongTinHuyPhieuVo.LyDo;
                phieuThu.DaThuHoi = thongTinHuyPhieuVo.ThoiGianThuHoi != null;
                phieuThu.NhanVienThuHoiId = thongTinHuyPhieuVo.NguoiThuHoiId;
                phieuThu.NgayThuHoi = thongTinHuyPhieuVo.ThoiGianThuHoi;

                //bo duyet tu dong
                //if (phieuThu.YeuCauTiepNhan.CoBHYT == true)
                //{
                //    DuyetBHYT(phieuThu.YeuCauTiepNhan, (long)Enums.NhanVienHeThong.NhanVienDuyetBHYTTuDong, (long)Enums.PhongHeThong.PhongDuyetBHYTToanTuDong, 0);
                //}
                if (thongTinHuyPhieuVo.HuyPhieuHoanUng == true)
                {
                    BaoLanhDvNgoaiGoiMarketing(phieuThu.YeuCauTiepNhan, soTienTamUng - GetSoTienCanThanhToanNgoaiTru(phieuThu.YeuCauTiepNhan));
                }
                _taiKhoanBenhNhanThu.Update(phieuThu);

                if (thongTinHuyPhieuVo.HuyPhieuHoanUng != true && thongTinHuyPhieuVo.ChuyenTienQuaTamUng == true)
                {
                    //khi chuyển vào tạm ứng hình thức thanh toán vẫn giống như lúc đầu là vừa chuyển khoản, pos, vừa tiền mặt trong trường hợp thu tiền luôn (ko có tạm ứng)
                    if (phieuThu.TamUng.GetValueOrDefault().AlmostEqual(0))
                    {
                        var thuTamUng = new TaiKhoanBenhNhanThu
                        {
                            YeuCauTiepNhanId = phieuThu.YeuCauTiepNhanId,
                            TaiKhoanBenhNhan = phieuThu.TaiKhoanBenhNhan,
                            LoaiThuTienBenhNhan = Enums.LoaiThuTienBenhNhan.ThuTamUng,
                            LoaiNoiThu = Enums.LoaiNoiThu.ThuNgan,
                            TienMat = phieuThu.TienMat,
                            ChuyenKhoan = phieuThu.ChuyenKhoan,
                            POS = phieuThu.POS,
                            NoiDungThu = Enums.LoaiThuTienBenhNhan.ThuTamUng.GetDescription(),
                            NgayThu = DateTime.Now,
                            SoPhieuHienThi = ResourceHelper.CreateSoTamUng(),
                            NhanVienThucHienId = _userAgentHelper.GetCurrentUserId(),
                            NoiThucHienId = _userAgentHelper.GetCurrentNoiLLamViecId()
                        };
                        phieuThu.TaiKhoanBenhNhan.SoDuTaiKhoan += thuTamUng.TienMat.GetValueOrDefault() + thuTamUng.ChuyenKhoan.GetValueOrDefault() + thuTamUng.POS.GetValueOrDefault();
                        _taiKhoanBenhNhanThu.Add(thuTamUng);
                    }
                    else
                    {
                        var thuTamUng = new TaiKhoanBenhNhanThu
                        {
                            YeuCauTiepNhanId = phieuThu.YeuCauTiepNhanId,
                            TaiKhoanBenhNhan = phieuThu.TaiKhoanBenhNhan,
                            LoaiThuTienBenhNhan = Enums.LoaiThuTienBenhNhan.ThuTamUng,
                            LoaiNoiThu = Enums.LoaiNoiThu.ThuNgan,
                            TienMat = phieuThu.TienMat.GetValueOrDefault() + phieuThu.ChuyenKhoan.GetValueOrDefault() + phieuThu.POS.GetValueOrDefault() + phieuThu.TamUng.GetValueOrDefault(),
                            NoiDungThu = Enums.LoaiThuTienBenhNhan.ThuTamUng.GetDescription(),
                            NgayThu = DateTime.Now,
                            SoPhieuHienThi = ResourceHelper.CreateSoTamUng(),
                            NhanVienThucHienId = _userAgentHelper.GetCurrentUserId(),
                            NoiThucHienId = _userAgentHelper.GetCurrentNoiLLamViecId()
                        };
                        phieuThu.TaiKhoanBenhNhan.SoDuTaiKhoan += thuTamUng.TienMat.GetValueOrDefault();
                        _taiKhoanBenhNhanThu.Add(thuTamUng);
                    }
                }
            }
        }
        private void HuyPhieuChi(ThongTinHuyPhieuVo thongTinHuyPhieuVo)
        {
            var phieuThu = _taiKhoanBenhNhanThu.GetById(thongTinHuyPhieuVo.SoPhieu,
                o => o.Include(x => x.YeuCauTiepNhan).ThenInclude(x => x.YeuCauKhamBenhs)
                    .Include(x => x.YeuCauTiepNhan).ThenInclude(x => x.YeuCauDichVuKyThuats)
                    .Include(x => x.TaiKhoanBenhNhan)
                    .Include(x => x.TaiKhoanBenhNhanChis).ThenInclude(c => c.TaiKhoanBenhNhanThus)
                    .Include(x => x.TaiKhoanBenhNhanChis).ThenInclude(c => c.YeuCauKhamBenh)
                    .Include(x => x.TaiKhoanBenhNhanChis).ThenInclude(c => c.YeuCauDichVuKyThuat)
                    .Include(x => x.CongTyBaoHiemTuNhanCongNos).ThenInclude(ct => ct.CongTyBaoHiemTuNhan)
                    .Include(x => x.MienGiamChiPhis));
            if (phieuThu.DaHuy == true)
            {
                throw new Exception("Phiếu thu đã được hủy");
            }

            foreach (var phieuThuTaiKhoanBenhNhanChi in phieuThu.TaiKhoanBenhNhanChis.Where(o => o.LoaiChiTienBenhNhan == Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi))
            {
                phieuThuTaiKhoanBenhNhanChi.DaHuy = true;
                phieuThuTaiKhoanBenhNhanChi.NhanVienHuyId = _userAgentHelper.GetCurrentUserId();
                phieuThuTaiKhoanBenhNhanChi.NoiHuyId = _userAgentHelper.GetCurrentNoiLLamViecId();
                phieuThuTaiKhoanBenhNhanChi.LyDoHuy = thongTinHuyPhieuVo.LyDo;
                if (phieuThuTaiKhoanBenhNhanChi.YeuCauKhamBenh != null)
                {
                    phieuThuTaiKhoanBenhNhanChi.YeuCauKhamBenh.SoTienBenhNhanDaChi = 0;
                    phieuThuTaiKhoanBenhNhanChi.YeuCauKhamBenh.TrangThaiThanhToan = Enums.TrangThaiThanhToan.BaoLanhThanhToan;
                }
                if (phieuThuTaiKhoanBenhNhanChi.YeuCauDichVuKyThuat != null)
                {
                    phieuThuTaiKhoanBenhNhanChi.YeuCauDichVuKyThuat.SoTienBenhNhanDaChi = 0;
                    phieuThuTaiKhoanBenhNhanChi.YeuCauDichVuKyThuat.TrangThaiThanhToan = Enums.TrangThaiThanhToan.BaoLanhThanhToan;
                }
            }

            phieuThu.DaHuy = true;
            phieuThu.NhanVienHuyId = _userAgentHelper.GetCurrentUserId();
            phieuThu.NoiHuyId = _userAgentHelper.GetCurrentNoiLLamViecId();
            phieuThu.NgayHuy = DateTime.Now;
            phieuThu.LyDoHuy = thongTinHuyPhieuVo.LyDo;
            phieuThu.DaThuHoi = thongTinHuyPhieuVo.ThoiGianThuHoi != null;
            phieuThu.NhanVienThuHoiId = thongTinHuyPhieuVo.NguoiThuHoiId;
            phieuThu.NgayThuHoi = thongTinHuyPhieuVo.ThoiGianThuHoi;

            _taiKhoanBenhNhanThu.Update(phieuThu);
        }
        public void ChuyenPhieuThuQuaTamUng(long taiKhoanBenhNhanThuId)
        {
            var phieuThu = _taiKhoanBenhNhanThu.GetById(taiKhoanBenhNhanThuId,
                o => o.Include(x => x.YeuCauTiepNhan).ThenInclude(x => x.YeuCauKhamBenhs)
                    .Include(x => x.YeuCauTiepNhan).ThenInclude(x => x.YeuCauDichVuKyThuats)
                    .Include(x => x.YeuCauTiepNhan).ThenInclude(x => x.YeuCauDuocPhamBenhViens)
                    .Include(x => x.YeuCauTiepNhan).ThenInclude(x => x.YeuCauVatTuBenhViens)
                    .Include(x => x.YeuCauTiepNhan).ThenInclude(x => x.DonThuocThanhToans).ThenInclude(x => x.DonThuocThanhToanChiTiets)
                    .Include(x => x.TaiKhoanBenhNhan)
                    .Include(x => x.TaiKhoanBenhNhanChis).ThenInclude(c => c.TaiKhoanBenhNhanThus)
                    .Include(x => x.TaiKhoanBenhNhanChis).ThenInclude(c => c.YeuCauKhamBenh)
                    .Include(x => x.TaiKhoanBenhNhanChis).ThenInclude(c => c.YeuCauDichVuKyThuat)
                    .Include(x => x.TaiKhoanBenhNhanChis).ThenInclude(c => c.YeuCauDuocPhamBenhVien)
                    .Include(x => x.TaiKhoanBenhNhanChis).ThenInclude(c => c.YeuCauVatTuBenhVien)
                    .Include(x => x.TaiKhoanBenhNhanChis).ThenInclude(c => c.DonThuocThanhToanChiTiet).ThenInclude(ct => ct.DonThuocThanhToan)
                    .Include(x => x.TaiKhoanBenhNhanChis).ThenInclude(c => c.DonVTYTThanhToanChiTiet).ThenInclude(ct => ct.DonVTYTThanhToan)
                    .Include(x => x.CongTyBaoHiemTuNhanCongNos).ThenInclude(ct => ct.CongTyBaoHiemTuNhan)
                    .Include(x => x.MienGiamChiPhis).ThenInclude(mg => mg.YeuCauTiepNhan));
            if (phieuThu.DaHuy == true)
            {
                throw new Exception("Phiếu thu đã được hủy");
            }
            if (phieuThu.CongNo.GetValueOrDefault() != 0)
            {
                throw new Exception("Không thể chuyển phiếu thu có công nợ");
            }

            var phieuHoanUng = phieuThu.TaiKhoanBenhNhanChis.FirstOrDefault(o => o.LoaiChiTienBenhNhan == Enums.LoaiChiTienBenhNhan.HoanUng);
            if (phieuHoanUng != null)
            {
                throw new Exception("Không thể chuyển phiếu thu có kèm hoàn ứng");
            }

            foreach (var phieuThuCongTyBaoHiemTuNhanCongNo in phieuThu.CongTyBaoHiemTuNhanCongNos)
            {
                phieuThuCongTyBaoHiemTuNhanCongNo.CongTyBaoHiemTuNhan.CongTyBaoHiemTuNhanCongNos.Add(new CongTyBaoHiemTuNhanCongNo
                {
                    TaiKhoanBenhNhanThuId = null,
                    SoTien = phieuThuCongTyBaoHiemTuNhanCongNo.SoTien,
                    YeuCauKhamBenhId = phieuThuCongTyBaoHiemTuNhanCongNo.YeuCauKhamBenhId,
                    YeuCauDichVuKyThuatId = phieuThuCongTyBaoHiemTuNhanCongNo.YeuCauDichVuKyThuatId,
                    YeuCauDuocPhamBenhVienId = phieuThuCongTyBaoHiemTuNhanCongNo.YeuCauDuocPhamBenhVienId,
                    YeuCauVatTuBenhVienId = phieuThuCongTyBaoHiemTuNhanCongNo.YeuCauVatTuBenhVienId,
                    YeuCauDichVuGiuongBenhVienId = phieuThuCongTyBaoHiemTuNhanCongNo.YeuCauDichVuGiuongBenhVienId,
                    DonThuocThanhToanChiTietId = phieuThuCongTyBaoHiemTuNhanCongNo.DonThuocThanhToanChiTietId,
                    YeuCauGoiDichVuId = phieuThuCongTyBaoHiemTuNhanCongNo.YeuCauGoiDichVuId,
                    DonVTYTThanhToanChiTietId = phieuThuCongTyBaoHiemTuNhanCongNo.DonVTYTThanhToanChiTietId,
                    YeuCauTruyenMauId = phieuThuCongTyBaoHiemTuNhanCongNo.YeuCauTruyenMauId,
                    YeuCauDichVuGiuongBenhVienChiPhiBenhVienId = phieuThuCongTyBaoHiemTuNhanCongNo.YeuCauDichVuGiuongBenhVienChiPhiBenhVienId,
                });
            }
            foreach (var mienGiamChiPhi in phieuThu.MienGiamChiPhis)
            {
                mienGiamChiPhi.YeuCauTiepNhan.MienGiamChiPhis.Add(new MienGiamChiPhi
                {
                    TaiKhoanBenhNhanThuId = null,
                    LoaiMienGiam = mienGiamChiPhi.LoaiMienGiam,
                    SoTien = mienGiamChiPhi.SoTien,
                    TheVoucherId = mienGiamChiPhi.TheVoucherId,
                    YeuCauKhamBenhId = mienGiamChiPhi.YeuCauKhamBenhId,
                    YeuCauDichVuKyThuatId = mienGiamChiPhi.YeuCauDichVuKyThuatId,
                    YeuCauDuocPhamBenhVienId = mienGiamChiPhi.YeuCauDuocPhamBenhVienId,
                    YeuCauVatTuBenhVienId = mienGiamChiPhi.YeuCauVatTuBenhVienId,
                    YeuCauDichVuGiuongBenhVienId = mienGiamChiPhi.YeuCauDichVuGiuongBenhVienId,
                    YeuCauGoiDichVuId = mienGiamChiPhi.YeuCauGoiDichVuId,
                    DonThuocThanhToanChiTietId = mienGiamChiPhi.DonThuocThanhToanChiTietId,
                    DonVTYTThanhToanChiTietId = mienGiamChiPhi.DonVTYTThanhToanChiTietId,
                    LoaiChietKhau = mienGiamChiPhi.LoaiChietKhau,
                    TiLe = mienGiamChiPhi.TiLe,
                    MaTheVoucher = mienGiamChiPhi.MaTheVoucher,
                    DoiTuongUuDaiId = mienGiamChiPhi.DoiTuongUuDaiId,
                    NoiGioiThieuId = mienGiamChiPhi.NoiGioiThieuId,
                    YeuCauTruyenMauId = mienGiamChiPhi.YeuCauTruyenMauId,
                    YeuCauDichVuGiuongBenhVienChiPhiBenhVienId = mienGiamChiPhi.YeuCauDichVuGiuongBenhVienChiPhiBenhVienId
                });
                mienGiamChiPhi.YeuCauGoiDichVuId = null;
            }
            foreach (var phieuThuTaiKhoanBenhNhanChi in phieuThu.TaiKhoanBenhNhanChis.Where(o => o.LoaiChiTienBenhNhan == Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi))
            {
                phieuThuTaiKhoanBenhNhanChi.DaHuy = true;
                phieuThuTaiKhoanBenhNhanChi.NhanVienHuyId = _userAgentHelper.GetCurrentUserId();
                phieuThuTaiKhoanBenhNhanChi.NoiHuyId = _userAgentHelper.GetCurrentNoiLLamViecId();

                if (phieuThuTaiKhoanBenhNhanChi.YeuCauKhamBenh != null)
                {
                    phieuThuTaiKhoanBenhNhanChi.YeuCauKhamBenh.SoTienBenhNhanDaChi = 0;
                    phieuThuTaiKhoanBenhNhanChi.YeuCauKhamBenh.TrangThaiThanhToan = Enums.TrangThaiThanhToan.CapNhatThanhToan;
                }
                if (phieuThuTaiKhoanBenhNhanChi.YeuCauDichVuKyThuat != null)
                {
                    phieuThuTaiKhoanBenhNhanChi.YeuCauDichVuKyThuat.SoTienBenhNhanDaChi = 0;
                    phieuThuTaiKhoanBenhNhanChi.YeuCauDichVuKyThuat.TrangThaiThanhToan = Enums.TrangThaiThanhToan.CapNhatThanhToan;
                }
                if (phieuThuTaiKhoanBenhNhanChi.YeuCauDuocPhamBenhVien != null)
                {
                    phieuThuTaiKhoanBenhNhanChi.YeuCauDuocPhamBenhVien.SoTienBenhNhanDaChi = 0;
                    phieuThuTaiKhoanBenhNhanChi.YeuCauDuocPhamBenhVien.TrangThaiThanhToan = Enums.TrangThaiThanhToan.ChuaThanhToan;
                }
                if (phieuThuTaiKhoanBenhNhanChi.YeuCauVatTuBenhVien != null)
                {
                    phieuThuTaiKhoanBenhNhanChi.YeuCauVatTuBenhVien.SoTienBenhNhanDaChi = 0;
                    phieuThuTaiKhoanBenhNhanChi.YeuCauVatTuBenhVien.TrangThaiThanhToan = Enums.TrangThaiThanhToan.ChuaThanhToan;
                }
                if (phieuThuTaiKhoanBenhNhanChi.DonThuocThanhToanChiTiet != null)
                {
                    phieuThuTaiKhoanBenhNhanChi.DonThuocThanhToanChiTiet.SoTienBenhNhanDaChi = 0;
                    phieuThuTaiKhoanBenhNhanChi.DonThuocThanhToanChiTiet.DonThuocThanhToan.TrangThaiThanhToan = Enums.TrangThaiThanhToan.ChuaThanhToan;
                }
                if (phieuThuTaiKhoanBenhNhanChi.DonVTYTThanhToanChiTiet != null)
                {
                    phieuThuTaiKhoanBenhNhanChi.DonVTYTThanhToanChiTiet.SoTienBenhNhanDaChi = 0;
                    phieuThuTaiKhoanBenhNhanChi.DonVTYTThanhToanChiTiet.DonVTYTThanhToan.TrangThaiThanhToan = Enums.TrangThaiThanhToan.ChuaThanhToan;
                }
            }

            phieuThu.DaHuy = true;
            phieuThu.NhanVienHuyId = _userAgentHelper.GetCurrentUserId();
            phieuThu.NoiHuyId = _userAgentHelper.GetCurrentNoiLLamViecId();
            phieuThu.NgayHuy = DateTime.Now;
            phieuThu.LyDoHuy = "Chuyển qua tạm ứng";

            var thuTamUng = new TaiKhoanBenhNhanThu
            {
                YeuCauTiepNhanId = phieuThu.YeuCauTiepNhanId,
                TaiKhoanBenhNhan = phieuThu.TaiKhoanBenhNhan,
                LoaiThuTienBenhNhan = Enums.LoaiThuTienBenhNhan.ThuTamUng,
                LoaiNoiThu = Enums.LoaiNoiThu.ThuNgan,
                TienMat = phieuThu.TienMat,
                ChuyenKhoan = phieuThu.ChuyenKhoan,
                POS = phieuThu.POS,
                NoiDungThu = Enums.LoaiThuTienBenhNhan.ThuTamUng.GetDescription(),
                NgayThu = DateTime.Now,
                SoPhieuHienThi = ResourceHelper.CreateSoTamUng(),
                NhanVienThucHienId = _userAgentHelper.GetCurrentUserId(),
                NoiThucHienId = _userAgentHelper.GetCurrentNoiLLamViecId()
            };
            phieuThu.TaiKhoanBenhNhan.SoDuTaiKhoan += phieuThu.TienMat.GetValueOrDefault() + phieuThu.ChuyenKhoan.GetValueOrDefault() + phieuThu.POS.GetValueOrDefault();

            //bo duyet tu dong
            //if (phieuThu.YeuCauTiepNhan.CoBHYT == true)
            //{
            //    DuyetBHYT(phieuThu.YeuCauTiepNhan, (long)Enums.NhanVienHeThong.NhanVienDuyetBHYTTuDong, (long)Enums.PhongHeThong.PhongDuyetBHYTToanTuDong, 0);
            //}

            _taiKhoanBenhNhanThu.Add(thuTamUng);
        }

        public async Task<(long, string)> HoanThuDichVu(ChiPhiKhamChuaBenhVo chiPhiKhamChuaBenhVo)
        {
            if (chiPhiKhamChuaBenhVo.TaiKhoanBenhNhanChiId.GetValueOrDefault(0) == 0)
                return (0, "Dịch vụ cần hoàn thu không đúng");
            var taiKhoanBenhNhanChi = await _taiKhoanBenhNhanChi.GetByIdAsync(
                chiPhiKhamChuaBenhVo.TaiKhoanBenhNhanChiId.Value,
                o => o.Include(x => x.TaiKhoanBenhNhanThu).ThenInclude(x => x.CongTyBaoHiemTuNhanCongNos)
                    .Include(x => x.TaiKhoanBenhNhanThu).ThenInclude(x => x.MienGiamChiPhis)
                    .Include(x => x.YeuCauKhamBenh)
                    .Include(x => x.YeuCauDichVuKyThuat)
                    .Include(x => x.YeuCauDuocPhamBenhVien).ThenInclude(x => x.XuatKhoDuocPhamChiTiet)
                    .Include(x => x.YeuCauVatTuBenhVien).ThenInclude(x => x.XuatKhoVatTuChiTiet));

            if (taiKhoanBenhNhanChi.DaHuy == true)
                return (0, "Không thể hoàn thu dịch vụ này");

            //check dv chua thuc hien
            bool daThucHien = false;

            if (taiKhoanBenhNhanChi.DonThuocThanhToanChiTietId != null)
                daThucHien = true;
            else if (taiKhoanBenhNhanChi.YeuCauKhamBenh?.ThoiDiemHoanThanh != null || taiKhoanBenhNhanChi.YeuCauKhamBenh?.TrangThai == Enums.EnumTrangThaiYeuCauKhamBenh.DaKham)
                daThucHien = true;
            else if (taiKhoanBenhNhanChi.YeuCauDichVuKyThuat?.ThoiDiemHoanThanh != null || taiKhoanBenhNhanChi.YeuCauDichVuKyThuat?.TrangThai == Enums.EnumTrangThaiYeuCauDichVuKyThuat.DaThucHien)
                daThucHien = true;
            else if (taiKhoanBenhNhanChi.YeuCauDuocPhamBenhVien?.XuatKhoDuocPhamChiTiet != null && taiKhoanBenhNhanChi.YeuCauDuocPhamBenhVien.XuatKhoDuocPhamChiTiet.NgayXuat != null)
                daThucHien = true;
            else if (taiKhoanBenhNhanChi.YeuCauVatTuBenhVien?.XuatKhoVatTuChiTiet != null && taiKhoanBenhNhanChi.YeuCauVatTuBenhVien.XuatKhoVatTuChiTiet.NgayXuat != null)
                daThucHien = true;

            if (daThucHien)
                return (0, "Không thể hoàn thu dịch vụ đã thực hiện");

            var phieuHoanThu = new TaiKhoanBenhNhanChi
            {
                TaiKhoanBenhNhanId = taiKhoanBenhNhanChi.TaiKhoanBenhNhanId,
                LoaiChiTienBenhNhan = Enums.LoaiChiTienBenhNhan.HoanThu,
                TienMat = taiKhoanBenhNhanChi.TienChiPhi,
                NoiDungChi = Enums.LoaiChiTienBenhNhan.HoanThu.GetDescription(),
                NgayChi = DateTime.Now,
                SoQuyen = taiKhoanBenhNhanChi.SoQuyen,
                SoPhieu = taiKhoanBenhNhanChi.SoPhieu,
                SoPhieuHienThi = taiKhoanBenhNhanChi.SoPhieuHienThi,
                TaiKhoanBenhNhanThuId = taiKhoanBenhNhanChi.TaiKhoanBenhNhanThuId,
                YeuCauKhamBenhId = taiKhoanBenhNhanChi.YeuCauKhamBenhId,
                YeuCauDichVuKyThuatId = taiKhoanBenhNhanChi.YeuCauDichVuKyThuatId,
                YeuCauDuocPhamBenhVienId = taiKhoanBenhNhanChi.YeuCauDuocPhamBenhVienId,
                YeuCauVatTuBenhVienId = taiKhoanBenhNhanChi.YeuCauVatTuBenhVienId,
                YeuCauDichVuGiuongBenhVienId = taiKhoanBenhNhanChi.YeuCauDichVuGiuongBenhVienId,
                YeuCauGoiDichVuId = taiKhoanBenhNhanChi.YeuCauGoiDichVuId,
                YeuCauTiepNhanId = taiKhoanBenhNhanChi.YeuCauTiepNhanId,
                NhanVienThucHienId = _userAgentHelper.GetCurrentUserId(),
                NoiThucHienId = _userAgentHelper.GetCurrentNoiLLamViecId(),
                DonThuocThanhToanChiTietId = taiKhoanBenhNhanChi.DonThuocThanhToanChiTietId,
                DonVTYTThanhToanChiTietId = taiKhoanBenhNhanChi.DonVTYTThanhToanChiTietId,
                YeuCauTruyenMauId = taiKhoanBenhNhanChi.YeuCauTruyenMauId,
                YeuCauDichVuGiuongBenhVienChiPhiBenhVienId =
                    taiKhoanBenhNhanChi.YeuCauDichVuGiuongBenhVienChiPhiBenhVienId,
                PhieuThanhToanChiPhiId = taiKhoanBenhNhanChi.Id
            };
            taiKhoanBenhNhanChi.TaiKhoanBenhNhanChis.Add(phieuHoanThu);
            taiKhoanBenhNhanChi.DaHuy = true;
            taiKhoanBenhNhanChi.NhanVienHuyId = _userAgentHelper.GetCurrentUserId();
            taiKhoanBenhNhanChi.NoiHuyId = _userAgentHelper.GetCurrentNoiLLamViecId();
            taiKhoanBenhNhanChi.NgayHuy = DateTime.Now;

            if (taiKhoanBenhNhanChi.YeuCauKhamBenh != null)
            {
                taiKhoanBenhNhanChi.YeuCauKhamBenh.SoTienBenhNhanDaChi = 0;
                taiKhoanBenhNhanChi.YeuCauKhamBenh.SoTienMienGiam = 0;
                taiKhoanBenhNhanChi.YeuCauKhamBenh.SoTienBaoHiemTuNhanChiTra = 0;
            }

            else if (taiKhoanBenhNhanChi.YeuCauDichVuKyThuat != null)
            {
                taiKhoanBenhNhanChi.YeuCauDichVuKyThuat.SoTienBenhNhanDaChi = 0;
                taiKhoanBenhNhanChi.YeuCauDichVuKyThuat.SoTienMienGiam = 0;
                taiKhoanBenhNhanChi.YeuCauDichVuKyThuat.SoTienBaoHiemTuNhanChiTra = 0;
            }
            else if (taiKhoanBenhNhanChi.YeuCauDuocPhamBenhVien != null)
            {
                taiKhoanBenhNhanChi.YeuCauDuocPhamBenhVien.SoTienBenhNhanDaChi = 0;
                taiKhoanBenhNhanChi.YeuCauDuocPhamBenhVien.SoTienMienGiam = 0;
                taiKhoanBenhNhanChi.YeuCauDuocPhamBenhVien.SoTienBaoHiemTuNhanChiTra = 0;
            }
            else if (taiKhoanBenhNhanChi.YeuCauVatTuBenhVien != null)
            {
                taiKhoanBenhNhanChi.YeuCauVatTuBenhVien.SoTienBenhNhanDaChi = 0;
                taiKhoanBenhNhanChi.YeuCauVatTuBenhVien.SoTienMienGiam = 0;
                taiKhoanBenhNhanChi.YeuCauVatTuBenhVien.SoTienBaoHiemTuNhanChiTra = 0;
            }

            foreach (var congTyBaoHiemTuNhanCongNo in taiKhoanBenhNhanChi.TaiKhoanBenhNhanThu.CongTyBaoHiemTuNhanCongNos)
            {
                if ((congTyBaoHiemTuNhanCongNo.DonThuocThanhToanChiTietId != null &&
                    congTyBaoHiemTuNhanCongNo.DonThuocThanhToanChiTietId ==
                     taiKhoanBenhNhanChi.DonThuocThanhToanChiTietId) ||
                    (congTyBaoHiemTuNhanCongNo.YeuCauKhamBenhId != null &&
                     congTyBaoHiemTuNhanCongNo.YeuCauKhamBenhId ==
                     taiKhoanBenhNhanChi.YeuCauKhamBenhId) ||
                    (congTyBaoHiemTuNhanCongNo.YeuCauDichVuKyThuatId != null &&
                     congTyBaoHiemTuNhanCongNo.YeuCauDichVuKyThuatId ==
                     taiKhoanBenhNhanChi.YeuCauDichVuKyThuatId) ||
                    (congTyBaoHiemTuNhanCongNo.YeuCauDuocPhamBenhVienId != null &&
                     congTyBaoHiemTuNhanCongNo.YeuCauDuocPhamBenhVienId ==
                     taiKhoanBenhNhanChi.YeuCauDuocPhamBenhVienId) ||
                    (congTyBaoHiemTuNhanCongNo.YeuCauVatTuBenhVienId != null &&
                     congTyBaoHiemTuNhanCongNo.YeuCauVatTuBenhVienId ==
                     taiKhoanBenhNhanChi.YeuCauVatTuBenhVienId) ||
                    (congTyBaoHiemTuNhanCongNo.YeuCauGoiDichVuId != null &&
                     congTyBaoHiemTuNhanCongNo.YeuCauGoiDichVuId ==
                     taiKhoanBenhNhanChi.YeuCauGoiDichVuId) ||
                    (congTyBaoHiemTuNhanCongNo.DonVTYTThanhToanChiTietId != null &&
                     congTyBaoHiemTuNhanCongNo.DonVTYTThanhToanChiTietId ==
                     taiKhoanBenhNhanChi.DonVTYTThanhToanChiTietId) ||
                    (congTyBaoHiemTuNhanCongNo.YeuCauTruyenMauId != null &&
                     congTyBaoHiemTuNhanCongNo.YeuCauTruyenMauId ==
                     taiKhoanBenhNhanChi.YeuCauTruyenMauId) ||
                    (congTyBaoHiemTuNhanCongNo.YeuCauDichVuGiuongBenhVienChiPhiBenhVienId != null &&
                     congTyBaoHiemTuNhanCongNo.YeuCauDichVuGiuongBenhVienChiPhiBenhVienId ==
                     taiKhoanBenhNhanChi.YeuCauDichVuGiuongBenhVienChiPhiBenhVienId))
                {
                    congTyBaoHiemTuNhanCongNo.DaHuy = true;
                }
            }

            foreach (var mienGiamChiPhi in taiKhoanBenhNhanChi.TaiKhoanBenhNhanThu.MienGiamChiPhis)
            {
                if ((mienGiamChiPhi.DonThuocThanhToanChiTietId != null &&
                    mienGiamChiPhi.DonThuocThanhToanChiTietId ==
                     taiKhoanBenhNhanChi.DonThuocThanhToanChiTietId) ||
                    (mienGiamChiPhi.YeuCauKhamBenhId != null &&
                     mienGiamChiPhi.YeuCauKhamBenhId ==
                     taiKhoanBenhNhanChi.YeuCauKhamBenhId) ||
                    (mienGiamChiPhi.YeuCauDichVuKyThuatId != null &&
                     mienGiamChiPhi.YeuCauDichVuKyThuatId ==
                     taiKhoanBenhNhanChi.YeuCauDichVuKyThuatId) ||
                    (mienGiamChiPhi.YeuCauDuocPhamBenhVienId != null &&
                     mienGiamChiPhi.YeuCauDuocPhamBenhVienId ==
                     taiKhoanBenhNhanChi.YeuCauDuocPhamBenhVienId) ||
                    (mienGiamChiPhi.YeuCauVatTuBenhVienId != null &&
                     mienGiamChiPhi.YeuCauVatTuBenhVienId ==
                     taiKhoanBenhNhanChi.YeuCauVatTuBenhVienId) ||
                    (mienGiamChiPhi.YeuCauGoiDichVuId != null &&
                     mienGiamChiPhi.YeuCauGoiDichVuId ==
                     taiKhoanBenhNhanChi.YeuCauGoiDichVuId) ||
                    (mienGiamChiPhi.DonVTYTThanhToanChiTietId != null &&
                     mienGiamChiPhi.DonVTYTThanhToanChiTietId ==
                     taiKhoanBenhNhanChi.DonVTYTThanhToanChiTietId) ||
                    (mienGiamChiPhi.YeuCauTruyenMauId != null &&
                     mienGiamChiPhi.YeuCauTruyenMauId ==
                     taiKhoanBenhNhanChi.YeuCauTruyenMauId) ||
                    (mienGiamChiPhi.YeuCauDichVuGiuongBenhVienChiPhiBenhVienId != null &&
                     mienGiamChiPhi.YeuCauDichVuGiuongBenhVienChiPhiBenhVienId ==
                     taiKhoanBenhNhanChi.YeuCauDichVuGiuongBenhVienChiPhiBenhVienId))
                {
                    mienGiamChiPhi.DaHuy = true;
                }
            }

            //await _taiKhoanBenhNhanChi.UpdateAsync(taiKhoanBenhNhanChi);
            BaseRepository.Context.SaveChanges();
            return (phieuHoanThu.Id, string.Empty);
        }

        public string GetHtmlPhieuThuChiNgoaiTru(long taiKhoanThuId, string hostingName)
        {
            var currentUserId = _userAgentHelper.GetCurrentUserId();
            var nguoiLapPhieu = _useRepository.GetById(currentUserId).HoTen;
            var cauHinhPhieuThu = _cauHinhService.LoadSetting<CauHinhPhieuThu>();
            var result = _templateRepository.TableNoTracking
                .FirstOrDefault(x => x.Name.Equals("PhieuThuChiNoiTru"));
            var taiKhoanBenhNhanThu = _taiKhoanBenhNhanThu.TableNoTracking.Where(c =>
                    c.Id == taiKhoanThuId && c.LoaiThuTienBenhNhan == Enums.LoaiThuTienBenhNhan.ThuTheoChiPhi).Include(cc => cc.YeuCauTiepNhan)
                                                                                                              .ThenInclude(cc => cc.PhuongXa)
                                                                                                              .Include(cc => cc.YeuCauTiepNhan)
                                                                                                              .ThenInclude(cc => cc.QuanHuyen)
                                                                                                              .Include(cc => cc.YeuCauTiepNhan)
                                                                                                              .ThenInclude(cc => cc.TinhThanh)
                                                                                                              .Include(cc => cc.YeuCauTiepNhan)
                                                                                                              .ThenInclude(cc => cc.BenhNhan)
                                                                                                              .Include(ccc => ccc.TaiKhoanBenhNhanChis)
                                                                                                              .Include(cc => cc.YeuCauTiepNhan)
                                                                                                              .ThenInclude(cc => cc.BenhNhan)
                                                                                                              .Include(dt => dt.CongTyBaoHiemTuNhanCongNos).FirstOrDefault();

            var dsChiPhi = GetThongTinPhieuThu(taiKhoanThuId, LoaiPhieuThuChiThuNgan.ThuTheoChiPhi);
            var diaChi = taiKhoanBenhNhanThu?.YeuCauTiepNhan.DiaChiDayDu;
            var trongGoi = taiKhoanBenhNhanThu.ThuTienGoiDichVu == true ? "<b style='color:red'>(Trong gói)</b>" : string.Empty;
            var data = new
            {
                cauHinhPhieuThu.TaiKhoanCo,
                cauHinhPhieuThu.TaiKhoanNo,
                LoaiPhieu = LoaiPhieuThuChiThuNgan.ThuTheoChiPhi.GetDescription().ToUpper() + trongGoi,
                LoaiNguoiNopTien = dsChiPhi.LaPhieuChi ? "Người nhận tiền" : "Người nộp tiền",
                LogoUrl = hostingName + "/assets/img/logo-bacha-full.png",
                NguoiNopTien = taiKhoanBenhNhanThu?.YeuCauTiepNhan.HoTen,
                //taiKhoanBenhNhanThu?.YeuCauTiepNhan.NamSinh,

                NamSinh = DateHelper.DOBFormat(taiKhoanBenhNhanThu?.YeuCauTiepNhan?.NgaySinh, taiKhoanBenhNhanThu?.YeuCauTiepNhan?.ThangSinh, taiKhoanBenhNhanThu?.YeuCauTiepNhan?.NamSinh),


                GioiTinh = taiKhoanBenhNhanThu?.YeuCauTiepNhan.GioiTinh.GetDescription(),
                DiaChi = diaChi,
                NoiDung = taiKhoanBenhNhanThu?.NoiDungThu,
                taiKhoanBenhNhanThu?.SoQuyen,
                SoPhieu = taiKhoanBenhNhanThu?.SoPhieuHienThi,
                //update 21/06/2022 làm tròn tiền trên phiếu thu ApplyFormatMoneyToDouble -> RoundAndApplyFormatMoney
                TongChiPhi = Convert.ToDouble(dsChiPhi.TongChiPhi).RoundAndApplyFormatMoney(),
                BHYTT = Convert.ToDouble(dsChiPhi.BHYTThanhToan).RoundAndApplyFormatMoney(),
                MiemGiam = Convert.ToDouble(dsChiPhi.MienGiam).RoundAndApplyFormatMoney(),
                nguoiLapPhieu,
                BenhNhanTT = Convert.ToDouble(dsChiPhi.BenhNhanThanhToan).RoundAndApplyFormatMoney(),
                //ngay dưới phiếu thu là ngày thu(update 07/10/2021)
                NgayThu = dsChiPhi.NgayThu.ToString("HH:mm") + " ngày " + dsChiPhi.NgayThu.Day + " tháng " + dsChiPhi.NgayThu.Month + " năm " + dsChiPhi.NgayThu.Year,
                ngayThangHientai = "Ngày " + DateTime.Now.Day + " tháng " + DateTime.Now.Month + " năm " + DateTime.Now.Year,
                TienMat = Convert.ToDouble(dsChiPhi.TienMat).RoundAndApplyFormatMoney(),
                ChuyenKhoan = Convert.ToDouble(dsChiPhi.ChuyenKhoan).RoundAndApplyFormatMoney(),
                Pos = Convert.ToDouble(dsChiPhi.Pos).RoundAndApplyFormatMoney(),
                tongCongNo = Convert.ToDouble(dsChiPhi.CongNo).RoundAndApplyFormatMoney(),
                GoiHienTai = DateTime.Now.Hour + ":" + DateTime.Now.Minute + ":" + DateTime.Now.Second,
                SoTienThuChi = dsChiPhi.LaPhieuChi ? "Số tiền phải trả BN" : "Số tiền phải thu của BN",
                ThanhTien = Convert.ToDouble(dsChiPhi.SoTienPhaiThuHoacChi).RoundAndApplyFormatMoney(),
                TamUng = Convert.ToDouble(dsChiPhi.TamUng).RoundAndApplyFormatMoney(),
                SoTienBangChu = NumberHelper.ChuyenSoRaText(Math.Round(Convert.ToDouble(dsChiPhi.SoTienPhaiThuHoacChi), MidpointRounding.AwayFromZero)),
                KemTheo = "Chứng từ gốc",
                ChungTu = "Chứng từ gốc",

                MaNB = taiKhoanBenhNhanThu?.YeuCauTiepNhan.BenhNhan.MaBN
            };

            var content = TemplateHelpper.FormatTemplateWithContentTemplate(result.Body, data);
            return content;
        }

        public string GetHtmlBaoCaoToaThuoc(long taiKhoanThuId, string hostingName)
        {
            var result = _templateRepository.TableNoTracking
                .FirstOrDefault(x => x.Name.Equals("BangInTienThuocThuTien"));
            var taiKhoanBenhNhanThus = _taiKhoanBenhNhanThu.TableNoTracking.Where(c => c.Id == taiKhoanThuId)
                .Include(cc => cc.YeuCauTiepNhan)
                .ThenInclude(cc => cc.PhuongXa)
                .Include(cc => cc.YeuCauTiepNhan)
                .ThenInclude(cc => cc.QuanHuyen)
                .Include(cc => cc.YeuCauTiepNhan)
                .ThenInclude(cc => cc.TinhThanh)
                .Include(ccc => ccc.TaiKhoanBenhNhanChis)
                .ThenInclude(dt => dt.DonThuocThanhToanChiTiet).ThenInclude(dt => dt.DonThuocThanhToan)
                .ThenInclude(vv => vv.DonThuocThanhToanChiTiets).ThenInclude(cc => cc.DonViTinh).FirstOrDefault();
            var keToaThuoc = string.Empty;
            decimal tongTienPhaiTra = 0;
            if (taiKhoanBenhNhanThus != null && taiKhoanBenhNhanThus.TaiKhoanBenhNhanChis.Any())
            {
                var idex = 1;
                foreach (var thuocThanhToanChiTiet in taiKhoanBenhNhanThus.TaiKhoanBenhNhanChis.Select(cc => cc.DonThuocThanhToanChiTiet))
                {
                    if (thuocThanhToanChiTiet != null)
                    {
                        keToaThuoc = keToaThuoc + "<tr style='border: 1px solid #020000;'>"
                               + "<td style=''border: 1px solid #020000;text-align: center;'>" +
                               idex++
                               + "<td style = 'border: 1px solid #020000;text-align: left;'>" +
                               thuocThanhToanChiTiet.Ten
                               + "<td style = 'border: 1px solid #020000;text-align: left;'>" +
                               thuocThanhToanChiTiet.DonViTinh.Ten
                               + "<td style = 'border: 1px solid #020000;text-align: right;'>" +
                               thuocThanhToanChiTiet.SoLuong
                               + "<td style = 'border: 1px solid #020000;text-align: right;'>" +
                                Convert.ToDouble(thuocThanhToanChiTiet.DonGiaBan).ApplyFormatMoneyToDouble()
                               + "<td style = 'border: 1px solid #020000;text-align: right;'>" +
                                 Convert.ToDouble((decimal)thuocThanhToanChiTiet.SoLuong *
                               thuocThanhToanChiTiet.DonGiaBan).ApplyFormatMoneyToDouble()
                               + "</tr>";
                        tongTienPhaiTra += (decimal)thuocThanhToanChiTiet.SoLuong *
                                           thuocThanhToanChiTiet.DonGiaBan;
                    }

                }
            }


            var diaChi = taiKhoanBenhNhanThus?.YeuCauTiepNhan.DiaChiDayDu;

            var data = new
            {
                LogoUrl = hostingName + "/assets/img/logo-bacha-full.png",
                NguoiNopTien = taiKhoanBenhNhanThus?.YeuCauTiepNhan.HoTen,
                //taiKhoanBenhNhanThus?.YeuCauTiepNhan.NamSinh,
                NamSinh = DateHelper.DOBFormat(taiKhoanBenhNhanThus?.YeuCauTiepNhan?.NgaySinh, taiKhoanBenhNhanThus?.YeuCauTiepNhan?.ThangSinh, taiKhoanBenhNhanThus?.YeuCauTiepNhan?.NamSinh),

                GioiTinh = taiKhoanBenhNhanThus?.YeuCauTiepNhan.GioiTinh.GetDescription(),
                DienDai = taiKhoanBenhNhanThus?.NoiDungThu,
                DiaChi = diaChi,
                ngayThangHientai = "Ngày " + DateTime.Now.Day + " tháng " + DateTime.Now.Month + " năm " +
                                   DateTime.Now.Year,
                TongTienPhaiTra = Convert.ToDouble(tongTienPhaiTra).ApplyFormatMoneyToDouble(),
                keToaThuoc,
                SoTienBangChu = NumberHelper.ChuyenSoRaText(Convert.ToDouble(tongTienPhaiTra)),
                KemTheo = "Chứng từ gốc",
                ChungTu = "Chứng từ gốc"
            };

            var content = TemplateHelpper.FormatTemplateWithContentTemplate(result.Body, data);
            return content;
        }

        public string GetHtmlBangKeNgoaiTruTrongGoiDv(long yeuCauTiepNhanId, string hostingName, bool xemTruoc = false)
        {
            var yeuCauTiepNhan = BaseRepository.TableNoTracking.Where(c => c.Id == yeuCauTiepNhanId)
                .Include(xx => xx.BenhNhan)
                .Include(xx => xx.YeuCauKhamBenhs).ThenInclude(o => o.NoiThucHien)
                .Include(xx => xx.YeuCauKhamBenhs).ThenInclude(o => o.BenhVienChuyenVien)
                .Include(xx => xx.YeuCauKhamBenhs).ThenInclude(o => o.Icdchinh)
                .Include(xx => xx.YeuCauKhamBenhs).ThenInclude(o => o.YeuCauKhamBenhICDKhacs).ThenInclude(o => o.ICD)
                .Include(cc => cc.PhuongXa)
                .Include(cc => cc.QuanHuyen)
                .Include(cc => cc.TinhThanh)
                .Include(cc => cc.NoiChuyen).FirstOrDefault();

            var result = _templateRepository.TableNoTracking.FirstOrDefault(x => x.Name.Equals("BangKeChiPhiGoiKhamChuaBenh"));

            if (yeuCauTiepNhan == null)
                return string.Empty;

            var benhVien = new Core.Domain.Entities.BenhVien.BenhVien();

            string maBHYT = string.Empty;
            string bHYTTuNgay = string.Empty;
            string bHYTDenNgay = string.Empty;
            string mucHuong = string.Empty;
            string NoiDKKCBBanDau = string.Empty;
            string MaKCBBanDau = string.Empty;


            string maICDKemTheo = string.Empty;
            string tenICDKemTheo = string.Empty;

            var yeuCauKhamBenh = yeuCauTiepNhan.YeuCauKhamBenhs.Where(cc => cc.IcdchinhId != null).OrderBy(cc => cc.ThoiDiemHoanThanh).LastOrDefault();

            if (yeuCauKhamBenh != null)
            {
                maICDKemTheo = yeuCauKhamBenh.YeuCauKhamBenhICDKhacs.FirstOrDefault()?.ICD.Ma;
                tenICDKemTheo = yeuCauKhamBenh.YeuCauKhamBenhICDKhacs.FirstOrDefault()?.GhiChu;
            }

            if (yeuCauTiepNhan.CoBHYT == true)
            {
                if (!String.IsNullOrEmpty(yeuCauTiepNhan.BHYTMaDKBD))
                {
                    benhVien = _benhVienRepository.TableNoTracking.FirstOrDefault(p => p.Ma.Equals(yeuCauTiepNhan.BHYTMaDKBD));
                }
                maBHYT = yeuCauTiepNhan.BHYTMaSoThe;
                bHYTTuNgay = yeuCauTiepNhan.BHYTNgayHieuLuc?.ApplyFormatDate();
                bHYTDenNgay = yeuCauTiepNhan.BHYTNgayHetHan?.ApplyFormatDate();
                mucHuong = yeuCauTiepNhan.BHYTMucHuong.ToString() + "%";
                NoiDKKCBBanDau = benhVien != null ? benhVien?.Ten : "Chưa xác định";
                MaKCBBanDau = yeuCauTiepNhan.BHYTMaDKBD;
            }
            else
            {
                maBHYT = "";
                bHYTTuNgay = "";
                bHYTDenNgay = "";
                mucHuong = "0%";
                NoiDKKCBBanDau = "Chưa xác định";
                MaKCBBanDau = "Chưa xác định";
            }
            List<ChiPhiKhamChuaBenhVo> chiPhis;
            if (xemTruoc)
            {
                chiPhis = GetTatCaDichVuKhamChuaBenh(yeuCauTiepNhanId).Result.Where(o => o.YeuCauGoiDichVuId != null).ToList();
            }
            else
            {
                chiPhis = GetTatCaDichVuKhamChuaBenh(yeuCauTiepNhanId).Result.Where(o => o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.DaThanhToan && o.YeuCauGoiDichVuId != null).ToList();
            }

            if (chiPhis.Count == 0)
            {
                return string.Empty;
            }
            var dsChiPhiBangKe = new List<BangKeKhamBenhBenhVienVo>();
            var dateItemChiPhis = string.Empty;
            int indexItem = 1;

            dateItemChiPhis += "<table style='width: 100 %; '>" +
                                "<tbody>" +
                                "<tr>" +
                                    $"<td style='padding-left:-5px; width: 40 %; '>Mã thẻ BHYT: <b>{maBHYT}</b> " +
                                    $"<span style='padding-left:20px'>Giá trị từ: <b>{bHYTTuNgay}</b> đến <b>{bHYTDenNgay}</b></span>" +
                                    $"<span style='padding-left:20px'>Mức hưởng: <b>{mucHuong}</b></span></td>" +
                                    "</tr>" +
                                "</tbody>" +
                                "</table>" +
                                "</br>" +
                                "<table style='width:100%;border: 1px solid #020000; border-collapse: collapse;'>" +
                                    "<tr style='border: 1px solid black;  border-collapse: collapse;'>" +
                                    "<th style='border: 1px solid #020000; border-collapse: collapse;text-align: center;' rowspan='2'>" +
                                            "STT </th>" +
                                        "<th style='border: 1px solid #020000; border-collapse: collapse;width:35%;text-align: center;' rowspan='2'>" +
                                            "Nội dung </th>" +
                                        "<th style='border: 1px solid #020000; border-collapse: collapse;width:5%;text-align: center;' rowspan='2'>" +
                                            "Đơn vị tính</th>" +
                                        "<th style='border: 1px solid #020000; border-collapse: collapse;width:3%; text-align: center;' rowspan='2'>" +
                                            "Số lượng</th>" +
                                        "<th style='border: 1px solid #020000; border-collapse: collapse;width:3%; text-align: center;' rowspan='2'>" +
                                            "Đơn giá BV <span style='font-weight: 100;'>(đồng)</span></th>" +
                                        "<th style='border: 1px solid #020000; border-collapse: collapse;width:3%; text-align: center;' rowspan='2'>" +
                                            "Đơn giá BH  <span style='font-weight: 100;'>(đồng)</span></th>" +
                                        "<th style='border: 1px solid #020000; border-collapse: collapse;width:200px; text-align: center;'" +
                                            "rowspan='2'>" +
                                            "Tỉ lệ thanh toán theo dich vụ   <span style='font-weight: 100;'>(%)</span></th>" +
                                        "<th style='border: 1px solid #020000; border-collapse: collapse;width:8%;text-align: center;' rowspan='2'>" +
                                            "Thành tiền BV  <span style='font-weight: 100;'>(đồng)</span>" +
                                        "</th>" +
                                        "<th style='border: 1px solid #020000; border-collapse: collapse;width:200px; text-align: center;'" +
                                            "rowspan='2'>" +
                                            "Tỷ lệ thanh toán BHYT <span style='font-weight: 100;'>(%)</span>" +
                                        "</th>" +

                                        "<th style='border: 1px solid #020000; border-collapse: collapse;width:8%;text-align: center;' rowspan='2'>" +
                                            "Thành tiền BH  <span style='font-weight: 100;'>(đồng)</span>" +
                                        "</th>" +
                                        "<th style='border: 1px solid #020000; border-collapse: collapse;width:35%;text-align: center;' colspan='4'>" +
                                            "Nguồn thanh toán  <span style='font-weight: 100;'>(đồng)</span></th>" +
                                    "</tr>" +
                                    "<tr style='border: 1px solid #020000; border-collapse: collapse;'>" +
                                        "<td style='border: 1px solid #020000; border-collapse: collapse;text-align: center;'><b>Quỹ BHYT</b></td>" +
                                        "<td style=' border: 1px solid #020000; border-collapse: collapse;width:80px;text-align: center;'>" +
                                            "<b>Người bệnh cùng chi" +
                                            " trả</b> (đồng)</td>" +
                                        "<td style=' border: 1px solid #020000; border-collapse: collapse;text-align: center;'><b>Khác</b> (đồng)</td>" +
                                        "<td style='border: 1px solid #020000; border-collapse: collapse;text-align: center;width: 90px;'>" +
                                            "<b>Người bệnh" +
                                            "tự trả </b>(đồng)" +
                                        "</td>" +
                                    "</tr>" +
                                    "<tr style=' border: 1px solid #020000; '>" +
                                        "<td style='border: 1px solid #020000;text-align: center;'><b> </b> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: center;'><b>(1)</b> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: center;'><b>(2)</b> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: center;'><b>(3)</b> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: center;'><b>(4)</b> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: center;'><b>(5)</b> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: center;'><b>(6)</b> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: center;'><b>(7)</b> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: center;'><b>(8)</b> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: center;'><b>(9)</b> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: center;'><b>(10)</b> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: center;'><b>(11)</b> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: center;'><b>(12)</b> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: center;'><b>(13)</b> </td>" +
                                    "</tr>";


            foreach (var chiPhi in chiPhis)
            {
                var chiphiBangKe = new BangKeKhamBenhBenhVienVo
                {
                    Nhom = chiPhi.NhomChiPhiBangKe,
                    Id = chiPhi.Id,
                    NoiDung = chiPhi.TenDichVu,
                    DonViTinh = chiPhi.DonViTinh,
                    SoLuong = (decimal)chiPhi.Soluong,
                    DuocHuongBaoHiem = chiPhi.DuocHuongBHYT,
                    DonGiaBH = chiPhi.DuocHuongBHYT ? chiPhi.DonGiaBHYT : 0,
                    MucHuongBaoHiem = chiPhi.MucHuongBaoHiem,
                    TiLeThanhToanTheoDV = chiPhi.TiLeBaoHiemThanhToan,
                    BaoHiemChiTra = true,
                    DonGiaBV = chiPhi.DonGia
                };

                if (chiPhi.KhongTinhPhi == true || chiPhi.YeuCauGoiDichVuId != null)
                {
                    chiphiBangKe.Khac = chiPhi.MucHuongBaoHiem > 0
                        ? (chiphiBangKe.ThanhTienBV.GetValueOrDefault() - chiphiBangKe.ThanhTienBH.GetValueOrDefault())
                        : chiphiBangKe.ThanhTienBV.GetValueOrDefault();
                }
                else
                {
                    chiphiBangKe.Khac = chiPhi.SoTienMG;
                }
                dsChiPhiBangKe.Add(chiphiBangKe);
            }
            var groupChiPhiBangKes = dsChiPhiBangKe.GroupBy(x => x.Nhom).OrderBy(o => (int)o.Key * (o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay || o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriNoiTru ? 1 : 10));
            foreach (var groupChiPhiBangKe in groupChiPhiBangKes)
            {
                if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay)
                {

                    dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                        "<td style='border: 1px solid #020000;' colspan='7'>" +
                                        "<span style='float:left;'><b>2. Ngày giường:  </b></span>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                        "</tr>";
                    dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                        "<td style='border: 1px solid #020000;' colspan='7'>" +
                                        "<span style='float:left;'><b>2.1." + groupChiPhiBangKe.Key.GetDescription() + "  </b></span>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'><b> " + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true) + "</b> </td>" +
                                        "</tr>";
                }
                else if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.NgayGiuongDieuTriNoiTru)
                {
                    if (!groupChiPhiBangKes.Any(o => o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay))
                    {
                        dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                            "<td style='border: 1px solid #020000;' colspan='7'>" +
                                            "<span style='float:left;'><b>2. Ngày giường:  </b></span>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                            "</tr>";
                    }
                    dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                        "<td style='border: 1px solid #020000;' colspan='7'>" +
                                        "<span style='float:left;'><b>2.2." + groupChiPhiBangKe.Key.GetDescription() + "  </b></span>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'><b> " + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true) + "</b> </td>" +
                                        "</tr>";
                }
                else
                {
                    dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                        "<td style='border: 1px solid #020000;' colspan='7'>" +
                                        "<span style='float:left;'><b>" + (int)groupChiPhiBangKe.Key + "." + groupChiPhiBangKe.Key.GetDescription() + "  </b></span>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'><b> " + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true) + "</b> </td>" +
                                        "</tr>";
                }
                if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.GoiVatTu)
                {
                    var groupGoiVatTus = groupChiPhiBangKe.ToList().GroupBy(o => o.SoGoiVatTu.GetValueOrDefault()).OrderBy(o => o.Key);
                    int sttGoiVatTu = 1;
                    foreach (var groupGoiVatTu in groupGoiVatTus)
                    {
                        dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                            "<td style='border: 1px solid #020000;' colspan='7'>" +
                                            "<span style='float:left;'><b>10." + sttGoiVatTu + ". " + groupChiPhiBangKe.Key.GetDescription() + " " + sttGoiVatTu + "  </b></span>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.Khac)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b> " + Convert.ToDouble(groupGoiVatTu.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true) + "</b> </td>" +
                                            "</tr>";
                        foreach (var chiPhiBangKe in groupGoiVatTu)
                        {
                            dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                            "<td style='border: 1px solid #020000; text-align: center;'> " + indexItem + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: left;'> " + chiPhiBangKe.NoiDung + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'>  " + chiPhiBangKe.DonViTinh + " </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'> " + chiPhiBangKe.SoLuong + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'> " + Convert.ToDouble(chiPhiBangKe.DonGiaBV).ApplyFormatMoneyToDouble() + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'> " + Convert.ToDouble(chiPhiBangKe.DonGiaBH).ApplyFormatMoneyToDouble() + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.TiLeThanhToanTheoDV).ApplyFormatMoneyToDouble() + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.ThanhTienBV).ApplyFormatMoneyToDouble() + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.MucHuongBaoHiem > 0 ? 100 : 0).ApplyFormatMoneyToDouble() + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.ThanhTienBH).ApplyFormatMoneyToDouble() + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.QuyBHYT).ApplyFormatMoneyToDouble() + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.NguoiBenhCungChiTra).ApplyFormatMoneyToDouble() + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.Khac).ApplyFormatMoneyToDouble() + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.NguoiBenhTuTra).ApplyFormatMoneyToDouble(true) + "</td>" +
                                            "</tr>";
                            indexItem++;
                        }
                    }
                }
                else
                {
                    foreach (var chiPhiBangKe in groupChiPhiBangKe)
                    {
                        dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                        "<td style='border: 1px solid #020000; text-align: center;'> " + indexItem + "</td>" +
                                        "<td style='border: 1px solid #020000;text-align: left;'> " + chiPhiBangKe.NoiDung + "</td>" +
                                        "<td style='border: 1px solid #020000;text-align: center;'>  " + chiPhiBangKe.DonViTinh + " </td>" +
                                        "<td style='border: 1px solid #020000;text-align: center;'> " + chiPhiBangKe.SoLuong + "</td>" +
                                        "<td style='border: 1px solid #020000;text-align: center;'> " + Convert.ToDouble(chiPhiBangKe.DonGiaBV).ApplyFormatMoneyToDouble() + "</td>" +
                                        "<td style='border: 1px solid #020000;text-align: center;'> " + Convert.ToDouble(chiPhiBangKe.DonGiaBH).ApplyFormatMoneyToDouble() + "</td>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.TiLeThanhToanTheoDV).ApplyFormatMoneyToDouble() + "</td>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.ThanhTienBV).ApplyFormatMoneyToDouble() + "</td>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.MucHuongBaoHiem > 0 ? 100 : 0).ApplyFormatMoneyToDouble() + "</td>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.ThanhTienBH).ApplyFormatMoneyToDouble() + "</td>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.QuyBHYT).ApplyFormatMoneyToDouble() + "</td>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.NguoiBenhCungChiTra).ApplyFormatMoneyToDouble() + "</td>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.Khac).ApplyFormatMoneyToDouble() + "</td>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.NguoiBenhTuTra).ApplyFormatMoneyToDouble(true) + "</td>" +
                                        "</tr>";
                        indexItem++;
                    }
                }

            }

            dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                "<td style='border: 1px solid #020000;' colspan='7'></span>" +
                                "<span style='float:right;padding-right: 50px;'><b>Tổng Cộng</b></span>" +
                                "</td>" +
                                $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                $"<td style='border: 1px solid #020000;text-align: right;'><b></b> </td>" +
                                $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true)}</b> </td>" +
                                "</tr>" +
                                "</table>";

            var checkedLyDoVaoVien = "<input id='demo_box_2' class='css - checkbox' type='checkbox' checked  disabled='true'/>";
            var unCheckedLyDoVaoVien = "<input id='demo_box_2' class='css - checkbox' type='checkbox' disabled='true' />";
            var data = new
            {
                TitleBangKe = "KHÁM BỆNH",
                SoBangKe = "1",
                yeuCauTiepNhan.BenhNhan.MaBN,
                MaTN = yeuCauTiepNhan.MaYeuCauTiepNhan,
                SoBenhAn = "",
                yeuCauTiepNhan.HoTen,
                DiaChi = yeuCauTiepNhan.DiaChiDayDu,
                BarCodeImgBase64 = !string.IsNullOrEmpty(yeuCauTiepNhan.MaYeuCauTiepNhan) ? BarcodeHelper.GenerateBarCode(yeuCauTiepNhan.MaYeuCauTiepNhan) : "",
                NamSinh = DateHelper.DOBFormat(yeuCauTiepNhan.NgaySinh, yeuCauTiepNhan.ThangSinh, yeuCauTiepNhan.NamSinh),
                GioiTinh = yeuCauTiepNhan.GioiTinh != null ? yeuCauTiepNhan.GioiTinh.GetDescription() : "",
                TenKhoa = yeuCauKhamBenh?.NoiThucHien?.KhoaPhong?.Ten,
                MaKhoa = yeuCauKhamBenh?.NoiThucHien?.KhoaPhong?.Ma,
                MaBHYT = maBHYT,
                BHYTTuNgay = bHYTTuNgay,
                BHYTDenNgay = bHYTDenNgay,
                NoiDKKCBBanDau,
                MaKCBBanDau,
                NgayDenKham = yeuCauTiepNhan.ThoiDiemTiepNhan.ApplyFormatGioPhutNgay(),
                DieuTriKNT = "",
                KetThucKhamNgoaiTru = yeuCauKhamBenh?.ThoiDiemHoanThanh?.ApplyFormatGioPhutNgay(),
                SoNgayDTri = "",
                TinhTrangRaVien = 1,
                MucHuong = mucHuong,
                NoiChuyenDen = yeuCauTiepNhan.NoiChuyen?.Ten,
                NoiChuyenDi = yeuCauKhamBenh?.BenhVienChuyenVien?.Ten,
                MKV = yeuCauTiepNhan.BHYTMaKhuVuc,
                NgayMiemCungTC = yeuCauTiepNhan.BHYTNgayDuocMienCungChiTra?.ApplyFormatDate(),
                ThoiGian5Nam = yeuCauTiepNhan.BHYTNgayDu5Nam?.ApplyFormatDate(),
                CoCapCuu = yeuCauTiepNhan.LyDoVaoVien == Enums.EnumLyDoVaoVien.CapCuu ? checkedLyDoVaoVien : unCheckedLyDoVaoVien,
                CoDungTuyen = yeuCauTiepNhan.LyDoVaoVien == Enums.EnumLyDoVaoVien.DungTuyen ? checkedLyDoVaoVien : unCheckedLyDoVaoVien,
                CoThongTuyen = yeuCauTiepNhan.LyDoVaoVien == Enums.EnumLyDoVaoVien.ThongTuyen ? checkedLyDoVaoVien : unCheckedLyDoVaoVien,
                CoTraiTuyen = yeuCauTiepNhan.LyDoVaoVien == Enums.EnumLyDoVaoVien.TraiTuyen ? checkedLyDoVaoVien : unCheckedLyDoVaoVien,

                ChuanDoanXacDinh = yeuCauKhamBenh?.GhiChuICDChinh,
                MaICD10 = yeuCauKhamBenh?.Icdchinh?.Ma,
                BenhKemTheo = tenICDKemTheo,
                ICDKemTheo10 = maICDKemTheo,

                DateItemChiPhis = dateItemChiPhis,

                TTDV = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble(),
                TTTTBHYT = "",

                TTTienBH = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble(),
                TQBHYT = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble(),
                TNCCTra = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble(),
                TongSoKhac = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble(),
                TNBTuTra = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true),

                TongChiPhi = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble(),
                SoTienBangChu = NumberHelper.ChuyenSoRaText(Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBV))),

                NguoiBenhPhaiTra = (Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)) + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhTuTra))).ApplyFormatMoneyToDouble(),

                TTQuyTT = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble(),
                BHYTChiTra = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble(),
                CacKhoanTraKhac = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true),
                SoTienKhac = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble(),
                NgayHienTai = DateTime.Now.ApplyFormatNgayThangNam()
            };

            var content = TemplateHelpper.FormatTemplateWithContentTemplate(result?.Body, data);
            return content;
        }

        public string GetHtmlBangKeNgoaiTru(long yeuCauTiepNhanId, string hostingName, bool xemTruoc = false)
        {
            var yeuCauTiepNhan = BaseRepository.TableNoTracking.Where(c => c.Id == yeuCauTiepNhanId)
                .Include(xx => xx.BenhNhan)
                .Include(xx => xx.YeuCauKhamBenhs).ThenInclude(o => o.NoiThucHien)
                .Include(xx => xx.YeuCauKhamBenhs).ThenInclude(o => o.BenhVienChuyenVien)
                .Include(xx => xx.YeuCauKhamBenhs).ThenInclude(o => o.Icdchinh)
                .Include(xx => xx.YeuCauKhamBenhs).ThenInclude(o => o.YeuCauKhamBenhICDKhacs).ThenInclude(o => o.ICD)
                .Include(cc => cc.PhuongXa)
                .Include(cc => cc.QuanHuyen)
                .Include(cc => cc.TinhThanh)
                .Include(cc => cc.NoiChuyen).FirstOrDefault();

            var result = _templateRepository.TableNoTracking.FirstOrDefault(x => x.Name.Equals("BangKeKhamBenhBHYTVaBenhVien"));

            if (yeuCauTiepNhan == null)
                return string.Empty;

            var benhVien = new Core.Domain.Entities.BenhVien.BenhVien();

            string maBHYT = string.Empty;
            string bHYTTuNgay = string.Empty;
            string bHYTDenNgay = string.Empty;
            string mucHuong = string.Empty;
            string NoiDKKCBBanDau = string.Empty;
            string MaKCBBanDau = string.Empty;


            string maICDKemTheo = string.Empty;
            string tenICDKemTheo = string.Empty;

            var yeuCauKhamBenh = yeuCauTiepNhan.YeuCauKhamBenhs.Where(cc => cc.IcdchinhId != null).OrderBy(cc => cc.ThoiDiemHoanThanh).LastOrDefault();

            if (yeuCauKhamBenh != null)
            {
                var maKemTheos = yeuCauKhamBenh.YeuCauKhamBenhICDKhacs.Select(c => c.ICD.Ma).ToList();
                var chuGhiKemTheos = yeuCauKhamBenh.YeuCauKhamBenhICDKhacs.Select(c => c.GhiChu).ToList();

                maICDKemTheo = string.Join(", ", maKemTheos);
                tenICDKemTheo = string.Join(", ", chuGhiKemTheos);
            }

            if (yeuCauTiepNhan.CoBHYT == true)
            {
                if (!String.IsNullOrEmpty(yeuCauTiepNhan.BHYTMaDKBD))
                {
                    benhVien = _benhVienRepository.TableNoTracking.FirstOrDefault(p => p.Ma.Equals(yeuCauTiepNhan.BHYTMaDKBD));
                }
                maBHYT = yeuCauTiepNhan.BHYTMaSoThe;
                bHYTTuNgay = yeuCauTiepNhan.BHYTNgayHieuLuc?.ApplyFormatDate();
                bHYTDenNgay = yeuCauTiepNhan.BHYTNgayHetHan?.ApplyFormatDate();
                mucHuong = yeuCauTiepNhan.BHYTMucHuong.ToString() + "%";
                NoiDKKCBBanDau = benhVien != null ? benhVien?.Ten : "Chưa xác định";
                MaKCBBanDau = yeuCauTiepNhan.BHYTMaDKBD;
            }
            else
            {
                maBHYT = "";
                bHYTTuNgay = "";
                bHYTDenNgay = "";
                mucHuong = "0%";
                NoiDKKCBBanDau = "Chưa xác định";
                MaKCBBanDau = "Chưa xác định";
            }
            List<ChiPhiKhamChuaBenhVo> chiPhis;
            if (xemTruoc)
            {
                chiPhis = GetTatCaDichVuKhamChuaBenh(yeuCauTiepNhanId).Result.Where(o => o.YeuCauGoiDichVuId == null).ToList();
            }
            else
            {
                chiPhis = GetTatCaDichVuKhamChuaBenh(yeuCauTiepNhanId).Result.Where(o => o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.DaThanhToan && o.YeuCauGoiDichVuId == null).ToList();
            }

            if (chiPhis.Count == 0)
            {
                return string.Empty;
            }
            var dsChiPhiBangKe = new List<BangKeKhamBenhBenhVienVo>();
            var dateItemChiPhis = string.Empty;
            int indexItem = 1;

            dateItemChiPhis += "<table style='width: 100 %; '>" +
                                "<tbody>" +
                                "<tr>" +
                                    $"<td style='padding-left:-5px; width: 40 %; '>Mã thẻ BHYT: <b>{maBHYT}</b> " +
                                    $"<span style='padding-left:20px'>Giá trị từ: <b>{bHYTTuNgay}</b> đến <b>{bHYTDenNgay}</b></span>" +
                                    $"<span style='padding-left:20px'>Mức hưởng: <b>{mucHuong}</b></span></td>" +
                                    "</tr>" +
                                "</tbody>" +
                                "</table>" +
                                "</br>" +
                                "<table style='width:100%;border: 1px solid #020000; border-collapse: collapse;'>" +
                                    "<tr style='border: 1px solid black;  border-collapse: collapse;'>" +
                                    "<th style='border: 1px solid #020000; border-collapse: collapse;text-align: center;' rowspan='2'>" +
                                            "STT </th>" +
                                        "<th style='border: 1px solid #020000; border-collapse: collapse;width:35%;text-align: center;' rowspan='2'>" +
                                            "Nội dung </th>" +
                                        "<th style='border: 1px solid #020000; border-collapse: collapse;width:5%;text-align: center;' rowspan='2'>" +
                                            "Đơn vị tính</th>" +
                                        "<th style='border: 1px solid #020000; border-collapse: collapse;width:3%; text-align: center;' rowspan='2'>" +
                                            "Số lượng</th>" +
                                        "<th style='border: 1px solid #020000; border-collapse: collapse;width:3%; text-align: center;' rowspan='2'>" +
                                            "Đơn giá BV <span style='font-weight: 100;'>(đồng)</span></th>" +
                                        "<th style='border: 1px solid #020000; border-collapse: collapse;width:3%; text-align: center;' rowspan='2'>" +
                                            "Đơn giá BH  <span style='font-weight: 100;'>(đồng)</span></th>" +
                                        "<th style='border: 1px solid #020000; border-collapse: collapse;width:200px; text-align: center;'" +
                                            "rowspan='2'>" +
                                            "Tỉ lệ thanh toán theo dich vụ   <span style='font-weight: 100;'>(%)</span></th>" +
                                        "<th style='border: 1px solid #020000; border-collapse: collapse;width:8%;text-align: center;' rowspan='2'>" +
                                            "Thành tiền BV  <span style='font-weight: 100;'>(đồng)</span>" +
                                        "</th>" +
                                        "<th style='border: 1px solid #020000; border-collapse: collapse;width:200px; text-align: center;'" +
                                            "rowspan='2'>" +
                                            "Tỷ lệ thanh toán BHYT <span style='font-weight: 100;'>(%)</span>" +
                                        "</th>" +
                                        "<th style='border: 1px solid #020000; border-collapse: collapse;width:8%;text-align: center;' rowspan='2'>" +
                                            "Thành tiền BH  <span style='font-weight: 100;'>(đồng)</span>" +
                                        "</th>" +
                                        "<th style='border: 1px solid #020000; border-collapse: collapse;width:35%;text-align: center;' colspan='4'>" +
                                            "Nguồn thanh toán  <span style='font-weight: 100;'>(đồng)</span></th>" +
                                    "</tr>" +
                                    "<tr style='border: 1px solid #020000; border-collapse: collapse;'>" +
                                        "<td style='border: 1px solid #020000; border-collapse: collapse;text-align: center;'><b>Quỹ BHYT</b></td>" +
                                        "<td style=' border: 1px solid #020000; border-collapse: collapse;width:80px;text-align: center;'>" +
                                            "<b>Người bệnh cùng chi" +
                                            " trả</b> (đồng)</td>" +
                                        "<td style=' border: 1px solid #020000; border-collapse: collapse;text-align: center;'><b>Khác</b> (đồng)</td>" +
                                        "<td style='border: 1px solid #020000; border-collapse: collapse;text-align: center;width: 90px;'>" +
                                            "<b>Người bệnh" +
                                            "tự trả </b>(đồng)" +
                                        "</td>" +
                                    "</tr>" +
                                    "<tr style=' border: 1px solid #020000; '>" +
                                        "<td style='border: 1px solid #020000;text-align: center;'><b> </b> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: center;'><b>(1)</b> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: center;'><b>(2)</b> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: center;'><b>(3)</b> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: center;'><b>(4)</b> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: center;'><b>(5)</b> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: center;'><b>(6)</b> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: center;'><b>(7)</b> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: center;'><b>(8)</b> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: center;'><b>(9)</b> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: center;'><b>(10)</b> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: center;'><b>(11)</b> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: center;'><b>(12)</b> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: center;'><b>(13)</b> </td>" +
                                    "</tr>";


            foreach (var chiPhi in chiPhis)
            {
                var chiphiBangKe = new BangKeKhamBenhBenhVienVo
                {
                    Nhom = chiPhi.NhomChiPhiBangKe,
                    Id = chiPhi.Id,
                    NoiDung = chiPhi.TenDichVu,
                    DonViTinh = chiPhi.DonViTinh,
                    SoLuong = (decimal)chiPhi.Soluong,
                    DuocHuongBaoHiem = chiPhi.DuocHuongBHYT,
                    DonGiaBH = chiPhi.DuocHuongBHYT ? chiPhi.DonGiaBHYT : 0,
                    MucHuongBaoHiem = chiPhi.MucHuongBaoHiem,
                    TiLeThanhToanTheoDV = chiPhi.TiLeBaoHiemThanhToan,
                    BaoHiemChiTra = true,
                    DonGiaBV = chiPhi.DonGia
                };
                if (chiPhi.KhongTinhPhi == true || chiPhi.YeuCauGoiDichVuId != null)
                {
                    chiphiBangKe.Khac = chiPhi.MucHuongBaoHiem > 0
                        ? (chiphiBangKe.ThanhTienBV.GetValueOrDefault() - chiphiBangKe.ThanhTienBH.GetValueOrDefault())
                        : chiphiBangKe.ThanhTienBV.GetValueOrDefault();
                }
                else
                {
                    chiphiBangKe.Khac = chiPhi.SoTienMG;
                }
                dsChiPhiBangKe.Add(chiphiBangKe);
            }
            var groupChiPhiBangKes = dsChiPhiBangKe.GroupBy(x => x.Nhom).OrderBy(o => (int)o.Key * (o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay || o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriNoiTru ? 1 : 10));
            foreach (var groupChiPhiBangKe in groupChiPhiBangKes)
            {
                if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay)
                {

                    dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                        "<td style='border: 1px solid #020000;' colspan='7'>" +
                                        "<span style='float:left;'><b>2. Ngày giường:  </b></span>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                        "</tr>";
                    dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                        "<td style='border: 1px solid #020000;' colspan='7'>" +
                                        "<span style='float:left;'><b>2.1." + groupChiPhiBangKe.Key.GetDescription() + "  </b></span>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'><b> " + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true) + "</b> </td>" +
                                        "</tr>";
                }
                else if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.NgayGiuongDieuTriNoiTru)
                {
                    if (!groupChiPhiBangKes.Any(o => o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay))
                    {
                        dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                            "<td style='border: 1px solid #020000;' colspan='7'>" +
                                            "<span style='float:left;'><b>2. Ngày giường:  </b></span>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                            "</tr>";
                    }
                    dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                        "<td style='border: 1px solid #020000;' colspan='7'>" +
                                        "<span style='float:left;'><b>2.2." + groupChiPhiBangKe.Key.GetDescription() + "  </b></span>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'><b> " + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true) + "</b> </td>" +
                                        "</tr>";
                }
                else
                {
                    dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                        "<td style='border: 1px solid #020000;' colspan='7'>" +
                                        "<span style='float:left;'><b>" + (int)groupChiPhiBangKe.Key + "." + groupChiPhiBangKe.Key.GetDescription() + "  </b></span>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'><b> " + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true) + "</b> </td>" +
                                        "</tr>";
                }
                if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.GoiVatTu)
                {
                    var groupGoiVatTus = groupChiPhiBangKe.ToList().GroupBy(o => o.SoGoiVatTu.GetValueOrDefault()).OrderBy(o => o.Key);
                    int sttGoiVatTu = 1;
                    foreach (var groupGoiVatTu in groupGoiVatTus)
                    {
                        dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                            "<td style='border: 1px solid #020000;' colspan='7'>" +
                                            "<span style='float:left;'><b>10." + sttGoiVatTu + ". " + groupChiPhiBangKe.Key.GetDescription() + " " + sttGoiVatTu + "  </b></span>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.Khac)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b> " + Convert.ToDouble(groupGoiVatTu.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true) + "</b> </td>" +
                                            "</tr>";
                        foreach (var chiPhiBangKe in groupGoiVatTu)
                        {
                            dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                            "<td style='border: 1px solid #020000; text-align: center;'> " + indexItem + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: left;'> " + chiPhiBangKe.NoiDung + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'>  " + chiPhiBangKe.DonViTinh + " </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'> " + chiPhiBangKe.SoLuong + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'> " + Convert.ToDouble(chiPhiBangKe.DonGiaBV).ApplyFormatMoneyToDouble() + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'> " + Convert.ToDouble(chiPhiBangKe.DonGiaBH).ApplyFormatMoneyToDouble() + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.TiLeThanhToanTheoDV).ApplyFormatMoneyToDouble() + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.ThanhTienBV).ApplyFormatMoneyToDouble() + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.MucHuongBaoHiem > 0 ? 100 : 0).ApplyFormatMoneyToDouble() + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.ThanhTienBH).ApplyFormatMoneyToDouble() + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.QuyBHYT).ApplyFormatMoneyToDouble() + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.NguoiBenhCungChiTra).ApplyFormatMoneyToDouble() + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.Khac).ApplyFormatMoneyToDouble() + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.NguoiBenhTuTra).ApplyFormatMoneyToDouble(true) + "</td>" +
                                            "</tr>";
                            indexItem++;
                        }
                    }
                }
                else
                {
                    foreach (var chiPhiBangKe in groupChiPhiBangKe)
                    {
                        dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                        "<td style='border: 1px solid #020000; text-align: center;'> " + indexItem + "</td>" +
                                        "<td style='border: 1px solid #020000;text-align: left;'> " + chiPhiBangKe.NoiDung + "</td>" +
                                        "<td style='border: 1px solid #020000;text-align: center;'>  " + chiPhiBangKe.DonViTinh + " </td>" +
                                        "<td style='border: 1px solid #020000;text-align: center;'> " + chiPhiBangKe.SoLuong + "</td>" +
                                        "<td style='border: 1px solid #020000;text-align: center;'> " + Convert.ToDouble(chiPhiBangKe.DonGiaBV).ApplyFormatMoneyToDouble() + "</td>" +
                                        "<td style='border: 1px solid #020000;text-align: center;'> " + Convert.ToDouble(chiPhiBangKe.DonGiaBH).ApplyFormatMoneyToDouble() + "</td>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.TiLeThanhToanTheoDV).ApplyFormatMoneyToDouble() + "</td>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.ThanhTienBV).ApplyFormatMoneyToDouble() + "</td>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.MucHuongBaoHiem > 0 ? 100 : 0).ApplyFormatMoneyToDouble() + "</td>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.ThanhTienBH).ApplyFormatMoneyToDouble() + "</td>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.QuyBHYT).ApplyFormatMoneyToDouble() + "</td>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.NguoiBenhCungChiTra).ApplyFormatMoneyToDouble() + "</td>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.Khac).ApplyFormatMoneyToDouble() + "</td>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.NguoiBenhTuTra).ApplyFormatMoneyToDouble(true) + "</td>" +
                                        "</tr>";
                        indexItem++;
                    }
                }

            }

            dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                "<td style='border: 1px solid #020000;' colspan='7'></span>" +
                                "<span style='float:right;padding-right: 50px;'><b>Tổng Cộng</b></span>" +
                                "</td>" +
                                $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                $"<td style='border: 1px solid #020000;text-align: right;'><b></b> </td>" +
                                $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true)}</b> </td>" +
                                "</tr>" +
                                "</table>";

            var checkedLyDoVaoVien = "<input id='demo_box_2' class='css - checkbox' type='checkbox' checked  disabled='true'/>";
            var unCheckedLyDoVaoVien = "<input id='demo_box_2' class='css - checkbox' type='checkbox' disabled='true' />";
            var data = new
            {
                TitleBangKe = "KHÁM BỆNH",
                SoBangKe = "1",
                yeuCauTiepNhan.BenhNhan.MaBN,
                MaTN = yeuCauTiepNhan.MaYeuCauTiepNhan,
                SoBenhAn = "",
                yeuCauTiepNhan.HoTen,
                DiaChi = yeuCauTiepNhan.DiaChiDayDu,
                BarCodeImgBase64 = !string.IsNullOrEmpty(yeuCauTiepNhan.MaYeuCauTiepNhan) ? BarcodeHelper.GenerateBarCode(yeuCauTiepNhan.MaYeuCauTiepNhan) : "",
                NamSinh = DateHelper.DOBFormat(yeuCauTiepNhan.NgaySinh, yeuCauTiepNhan.ThangSinh, yeuCauTiepNhan.NamSinh),
                GioiTinh = yeuCauTiepNhan.GioiTinh != null ? yeuCauTiepNhan.GioiTinh.GetDescription() : "",
                TenKhoa = yeuCauKhamBenh?.NoiThucHien?.KhoaPhong?.Ten,
                MaKhoa = yeuCauKhamBenh?.NoiThucHien?.KhoaPhong?.Ma,
                MaBHYT = maBHYT,
                BHYTTuNgay = bHYTTuNgay,
                BHYTDenNgay = bHYTDenNgay,
                NoiDKKCBBanDau,
                MaKCBBanDau,
                NgayDenKham = yeuCauTiepNhan.ThoiDiemTiepNhan.ApplyFormatGioPhutNgay(),
                DieuTriKNT = "",
                KetThucKhamNgoaiTru = yeuCauKhamBenh?.ThoiDiemHoanThanh?.ApplyFormatGioPhutNgay(),
                SoNgayDTri = "",
                TinhTrangRaVien = 1,
                MucHuong = mucHuong,
                NoiChuyenDen = yeuCauTiepNhan.NoiChuyen?.Ten,
                NoiChuyenDi = yeuCauKhamBenh?.BenhVienChuyenVien?.Ten,
                MKV = yeuCauTiepNhan.BHYTMaKhuVuc,
                NgayMiemCungTC = yeuCauTiepNhan.BHYTNgayDuocMienCungChiTra?.ApplyFormatDate(),
                ThoiGian5Nam = yeuCauTiepNhan.BHYTNgayDu5Nam?.ApplyFormatDate(),
                CoCapCuu = yeuCauTiepNhan.LyDoVaoVien == Enums.EnumLyDoVaoVien.CapCuu ? checkedLyDoVaoVien : unCheckedLyDoVaoVien,
                CoDungTuyen = yeuCauTiepNhan.LyDoVaoVien == Enums.EnumLyDoVaoVien.DungTuyen ? checkedLyDoVaoVien : unCheckedLyDoVaoVien,
                CoThongTuyen = yeuCauTiepNhan.LyDoVaoVien == Enums.EnumLyDoVaoVien.ThongTuyen ? checkedLyDoVaoVien : unCheckedLyDoVaoVien,
                CoTraiTuyen = yeuCauTiepNhan.LyDoVaoVien == Enums.EnumLyDoVaoVien.TraiTuyen ? checkedLyDoVaoVien : unCheckedLyDoVaoVien,

                ChuanDoanXacDinh = yeuCauKhamBenh?.GhiChuICDChinh,
                MaICD10 = yeuCauKhamBenh?.Icdchinh?.Ma,
                BenhKemTheo = tenICDKemTheo,
                ICDKemTheo10 = maICDKemTheo,

                DateItemChiPhis = dateItemChiPhis,

                TTDV = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble(),
                TTTTBHYT = "",

                TTTienBH = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble(),
                TQBHYT = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble(),
                TNCCTra = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble(),
                TongSoKhac = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble(),
                TNBTuTra = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true),

                TongChiPhi = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble(),
                SoTienBangChu = NumberHelper.ChuyenSoRaText(Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBV))),

                NguoiBenhPhaiTra = (Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)) + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhTuTra))).ApplyFormatMoneyToDouble(),

                TTQuyTT = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble(),
                BHYTChiTra = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble(),
                CacKhoanTraKhac = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true),
                SoTienKhac = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble(),
                NgayHienTai = DateTime.Now.ApplyFormatNgayThangNam()
            };

            var content = TemplateHelpper.FormatTemplateWithContentTemplate(result?.Body, data);
            return content;
        }

        public string GetHtmlBangKeNgoaiTruCoBHYT(long yeuCauTiepNhanId, string hostingName, bool xemTruoc = false)
        {
            var yeuCauTiepNhan = BaseRepository.TableNoTracking.Where(c => c.Id == yeuCauTiepNhanId)
                .Include(xx => xx.BenhNhan)
                .Include(xx => xx.YeuCauKhamBenhs).ThenInclude(o => o.NoiThucHien)
                .Include(xx => xx.YeuCauKhamBenhs).ThenInclude(o => o.BenhVienChuyenVien)
                .Include(xx => xx.YeuCauKhamBenhs).ThenInclude(o => o.Icdchinh)
                .Include(xx => xx.YeuCauKhamBenhs).ThenInclude(o => o.YeuCauKhamBenhICDKhacs).ThenInclude(o => o.ICD)
                .Include(cc => cc.PhuongXa)
                .Include(cc => cc.QuanHuyen)
                .Include(cc => cc.TinhThanh)
                .Include(cc => cc.NoiChuyen).FirstOrDefault();

            var result = _templateRepository.TableNoTracking.FirstOrDefault(x => x.Name.Equals("BangKeKhamBenhBHYTVaBenhVien"));

            if (yeuCauTiepNhan == null)
                return string.Empty;

            var benhVien = new Core.Domain.Entities.BenhVien.BenhVien();

            string maBHYT = string.Empty;
            string bHYTTuNgay = string.Empty;
            string bHYTDenNgay = string.Empty;
            string mucHuong = string.Empty;
            string NoiDKKCBBanDau = string.Empty;
            string MaKCBBanDau = string.Empty;


            string maICDKemTheo = string.Empty;
            string tenICDKemTheo = string.Empty;

            var yeuCauKhamBenh = yeuCauTiepNhan.YeuCauKhamBenhs.Where(cc => cc.IcdchinhId != null).OrderBy(cc => cc.ThoiDiemHoanThanh).LastOrDefault();

            if (yeuCauKhamBenh != null)
            {
                var maKemTheos = yeuCauKhamBenh.YeuCauKhamBenhICDKhacs.Select(c => c.ICD.Ma).ToList();
                var chuGhiKemTheos = yeuCauKhamBenh.YeuCauKhamBenhICDKhacs.Select(c => c.GhiChu).ToList();

                maICDKemTheo = string.Join(", ", maKemTheos);
                tenICDKemTheo = string.Join(", ", chuGhiKemTheos);
            }

            if (yeuCauTiepNhan.CoBHYT == true)
            {
                if (!String.IsNullOrEmpty(yeuCauTiepNhan.BHYTMaDKBD))
                {
                    benhVien = _benhVienRepository.TableNoTracking.FirstOrDefault(p => p.Ma.Equals(yeuCauTiepNhan.BHYTMaDKBD));
                }
                maBHYT = yeuCauTiepNhan.BHYTMaSoThe;
                bHYTTuNgay = yeuCauTiepNhan.BHYTNgayHieuLuc?.ApplyFormatDate();
                bHYTDenNgay = yeuCauTiepNhan.BHYTNgayHetHan?.ApplyFormatDate();
                mucHuong = yeuCauTiepNhan.BHYTMucHuong.ToString() + "%";
                NoiDKKCBBanDau = benhVien != null ? benhVien?.Ten : "Chưa xác định";
                MaKCBBanDau = yeuCauTiepNhan.BHYTMaDKBD;
            }
            else
            {
                maBHYT = "";
                bHYTTuNgay = "";
                bHYTDenNgay = "";
                mucHuong = "0%";
                NoiDKKCBBanDau = "Chưa xác định";
                MaKCBBanDau = "Chưa xác định";
            }

            //var chiPhis = xemTruoc ? GetTatCaDichVuKhamChuaBenh(yeuCauTiepNhanId).Result.Where(o => o.KhongTinhPhi != true && o.DuocHuongBHYT && o.MucHuongBaoHiem > 0).ToList() : GetThongTinChiPhi(yeuCauTiepNhanId).Where(o => o.KhongTinhPhi != true && o.DuocHuongBHYT && o.MucHuongBaoHiem > 0).ToList();
            List<ChiPhiKhamChuaBenhVo> chiPhis;
            if (xemTruoc)
            {
                chiPhis = GetTatCaDichVuKhamChuaBenh(yeuCauTiepNhanId).Result.Where(o => o.KhongTinhPhi != true && o.DuocHuongBHYT && o.MucHuongBaoHiem > 0).ToList();
            }
            else
            {
                chiPhis = GetTatCaDichVuKhamChuaBenh(yeuCauTiepNhanId).Result.Where(o => o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.DaThanhToan && o.KhongTinhPhi != true && o.DuocHuongBHYT && o.MucHuongBaoHiem > 0).ToList();
            }

            if (chiPhis.Count == 0)
            {
                return string.Empty;
            }
            var dsChiPhiBangKe = new List<BangKeKhamBenhCoBHYTVo>();
            var dateItemChiPhis = string.Empty;
            int indexItem = 1;

            dateItemChiPhis += "<table style='width: 100 %; '>" +
                                "<tbody>" +
                                "<tr>" +
                                    $"<td style='padding-left:-5px; width: 40 %; '>Mã thẻ BHYT: <b>{maBHYT}</b> " +
                                    $"<span style='padding-left:20px'>Giá trị từ: <b>{bHYTTuNgay}</b> đến <b>{bHYTDenNgay}</b></span>" +
                                    $"<span style='padding-left:20px'>Mức hưởng: <b>{mucHuong}</b></span></td>" +
                                    "</tr>" +
                                "</tbody>" +
                                "</table>" +
                                "</br>" +
                                "<table style='width:100%;border: 1px solid #020000; border-collapse: collapse;'>" +
                                    "<tr style='border: 1px solid black;  border-collapse: collapse;'>" +
                                    "<th style='border: 1px solid #020000; border-collapse: collapse;text-align: center;' rowspan='2'>" +
                                            "STT </th>" +
                                        "<th style='border: 1px solid #020000; border-collapse: collapse;width:35%;text-align: center;' rowspan='2'>" +
                                            "Nội dung </th>" +
                                        "<th style='border: 1px solid #020000; border-collapse: collapse;width:5%;text-align: center;' rowspan='2'>" +
                                            "Đơn vị tính</th>" +
                                        "<th style='border: 1px solid #020000; border-collapse: collapse;width:3%; text-align: center;' rowspan='2'>" +
                                            "Số lượng</th>" +
                                        "<th style='border: 1px solid #020000; border-collapse: collapse;width:3%; text-align: center;' rowspan='2'>" +
                                            "Đơn giá BV <span style='font-weight: 100;'>(đồng)</span></th>" +
                                        "<th style='border: 1px solid #020000; border-collapse: collapse;width:3%; text-align: center;' rowspan='2'>" +
                                            "Đơn giá BH  <span style='font-weight: 100;'>(đồng)</span></th>" +
                                        "<th style='border: 1px solid #020000; border-collapse: collapse;width:200px; text-align: center;'" +
                                            "rowspan='2'>" +
                                            "Tỉ lệ thanh toán theo dich vụ   <span style='font-weight: 100;'>(%)</span></th>" +
                                        "<th style='border: 1px solid #020000; border-collapse: collapse;width:8%;text-align: center;' rowspan='2'>" +
                                            "Thành tiền BV  <span style='font-weight: 100;'>(đồng)</span>" +
                                        "</th>" +
                                        "<th style='border: 1px solid #020000; border-collapse: collapse;width:200px; text-align: center;'" +
                                            "rowspan='2'>" +
                                            "Tỷ lệ thanh toán BHYT <span style='font-weight: 100;'>(%)</span>" +
                                        "</th>" +
                                        "<th style='border: 1px solid #020000; border-collapse: collapse;width:8%;text-align: center;' rowspan='2'>" +
                                            "Thành tiền BH  <span style='font-weight: 100;'>(đồng)</span>" +
                                        "</th>" +
                                        "<th style='border: 1px solid #020000; border-collapse: collapse;width:35%;text-align: center;' colspan='4'>" +
                                            "Nguồn thanh toán  <span style='font-weight: 100;'>(đồng)</span></th>" +
                                    "</tr>" +
                                    "<tr style='border: 1px solid #020000; border-collapse: collapse;'>" +
                                        "<td style='border: 1px solid #020000; border-collapse: collapse;text-align: center;'><b>Quỹ BHYT</b></td>" +
                                        "<td style=' border: 1px solid #020000; border-collapse: collapse;width:80px;text-align: center;'>" +
                                            "<b>Người bệnh cùng chi" +
                                            " trả</b> (đồng)</td>" +
                                        "<td style=' border: 1px solid #020000; border-collapse: collapse;text-align: center;'><b>Khác</b> (đồng)</td>" +
                                        "<td style='border: 1px solid #020000; border-collapse: collapse;text-align: center;width: 90px;'>" +
                                            "<b>Người bệnh" +
                                            "tự trả </b>(đồng)" +
                                        "</td>" +
                                    "</tr>" +
                                    "<tr style=' border: 1px solid #020000; '>" +
                                        "<td style='border: 1px solid #020000;text-align: center;'><b> </b> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: center;'><b>(1)</b> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: center;'><b>(2)</b> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: center;'><b>(3)</b> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: center;'><b>(4)</b> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: center;'><b>(5)</b> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: center;'><b>(6)</b> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: center;'><b>(7)</b> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: center;'><b>(8)</b> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: center;'><b>(9)</b> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: center;'><b>(10)</b> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: center;'><b>(11)</b> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: center;'><b>(12)</b> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: center;'><b>(13)</b> </td>" +
                                    "</tr>";


            foreach (var chiPhi in chiPhis)
            {
                dsChiPhiBangKe.Add(new BangKeKhamBenhCoBHYTVo
                {
                    Nhom = chiPhi.NhomChiPhiBangKe,
                    Id = chiPhi.Id,
                    NoiDung = chiPhi.TenDichVu,
                    DonViTinh = chiPhi.DonViTinh,
                    SoLuong = (decimal)chiPhi.Soluong,
                    DuocHuongBaoHiem = chiPhi.DuocHuongBHYT,
                    DonGiaBH = chiPhi.DonGiaBHYT,
                    DonGiaTheoBV = chiPhi.DonGia,
                    MucHuongBaoHiem = chiPhi.MucHuongBaoHiem,
                    TiLeThanhToanTheoDV = chiPhi.TiLeBaoHiemThanhToan,
                    BaoHiemChiTra = true
                });
            }
            var groupChiPhiBangKes = dsChiPhiBangKe.GroupBy(x => x.Nhom).OrderBy(o => (int)o.Key * (o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay || o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriNoiTru ? 1 : 10));
            foreach (var groupChiPhiBangKe in groupChiPhiBangKes)
            {
                if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay)
                {

                    dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                        "<td style='border: 1px solid #020000;' colspan='7'>" +
                                        "<span style='float:left;'><b>2. Ngày giường:  </b></span>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                        "</tr>";
                    dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                        "<td style='border: 1px solid #020000;' colspan='7'>" +
                                        "<span style='float:left;'><b>2.1." + groupChiPhiBangKe.Key.GetDescription() + "  </b></span>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'><b> " + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true) + "</b> </td>" +
                                        "</tr>";
                }
                else if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.NgayGiuongDieuTriNoiTru)
                {
                    if (!groupChiPhiBangKes.Any(o => o.Key == NhomChiPhiBangKe.NgayGiuongDieuTriBanNgay))
                    {
                        dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                            "<td style='border: 1px solid #020000;' colspan='7'>" +
                                            "<span style='float:left;'><b>2. Ngày giường:  </b></span>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                            "</tr>";
                    }
                    dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                        "<td style='border: 1px solid #020000;' colspan='7'>" +
                                        "<span style='float:left;'><b>2.2." + groupChiPhiBangKe.Key.GetDescription() + "  </b></span>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'><b> " + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true) + "</b> </td>" +
                                        "</tr>";
                }
                else
                {
                    dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                        "<td style='border: 1px solid #020000;' colspan='7'>" +
                                        "<span style='float:left;'><b>" + (int)groupChiPhiBangKe.Key + "." + groupChiPhiBangKe.Key.GetDescription() + "  </b></span>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'><b> " + Convert.ToDouble(groupChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true) + "</b> </td>" +
                                        "</tr>";
                }
                if (groupChiPhiBangKe.Key == NhomChiPhiBangKe.GoiVatTu)
                {
                    var groupGoiVatTus = groupChiPhiBangKe.ToList().GroupBy(o => o.SoGoiVatTu.GetValueOrDefault()).OrderBy(o => o.Key);
                    int sttGoiVatTu = 1;
                    foreach (var groupGoiVatTu in groupGoiVatTus)
                    {
                        dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                            "<td style='border: 1px solid #020000;' colspan='7'>" +
                                            "<span style='float:left;'><b>10." + sttGoiVatTu + ". " + groupChiPhiBangKe.Key.GetDescription() + " " + sttGoiVatTu + "  </b></span>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupGoiVatTu.Sum(o => o.Khac)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'><b> " + Convert.ToDouble(groupGoiVatTu.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true) + "</b> </td>" +
                                            "</tr>";
                        foreach (var chiPhiBangKe in groupGoiVatTu)
                        {
                            dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                            "<td style='border: 1px solid #020000; text-align: center;'> " + indexItem + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: left;'> " + chiPhiBangKe.NoiDung + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'>  " + chiPhiBangKe.DonViTinh + " </td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'> " + chiPhiBangKe.SoLuong + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'> " + Convert.ToDouble(chiPhiBangKe.DonGiaBV).ApplyFormatMoneyToDouble() + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: center;'> " + Convert.ToDouble(chiPhiBangKe.DonGiaBH).ApplyFormatMoneyToDouble() + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.TiLeThanhToanTheoDV).ApplyFormatMoneyToDouble() + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.ThanhTienBV).ApplyFormatMoneyToDouble() + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.MucHuongBaoHiem > 0 ? 100 : 0).ApplyFormatMoneyToDouble() + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.ThanhTienBH).ApplyFormatMoneyToDouble() + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.QuyBHYT).ApplyFormatMoneyToDouble() + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.NguoiBenhCungChiTra).ApplyFormatMoneyToDouble() + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.Khac).ApplyFormatMoneyToDouble() + "</td>" +
                                            "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.NguoiBenhTuTra).ApplyFormatMoneyToDouble(true) + "</td>" +
                                            "</tr>";
                            indexItem++;
                        }
                    }
                }
                else
                {
                    foreach (var chiPhiBangKe in groupChiPhiBangKe)
                    {
                        dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                        "<td style='border: 1px solid #020000; text-align: center;'> " + indexItem + "</td>" +
                                        "<td style='border: 1px solid #020000;text-align: left;'> " + chiPhiBangKe.NoiDung + "</td>" +
                                        "<td style='border: 1px solid #020000;text-align: center;'>  " + chiPhiBangKe.DonViTinh + " </td>" +
                                        "<td style='border: 1px solid #020000;text-align: center;'> " + chiPhiBangKe.SoLuong + "</td>" +
                                        "<td style='border: 1px solid #020000;text-align: center;'> " + Convert.ToDouble(chiPhiBangKe.DonGiaBV).ApplyFormatMoneyToDouble() + "</td>" +
                                        "<td style='border: 1px solid #020000;text-align: center;'> " + Convert.ToDouble(chiPhiBangKe.DonGiaBH).ApplyFormatMoneyToDouble() + "</td>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.TiLeThanhToanTheoDV).ApplyFormatMoneyToDouble() + "</td>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.ThanhTienBV).ApplyFormatMoneyToDouble() + "</td>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(chiPhiBangKe.MucHuongBaoHiem > 0 ? 100 : 0).ApplyFormatMoneyToDouble() + "</td>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.ThanhTienBH).ApplyFormatMoneyToDouble() + "</td>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.QuyBHYT).ApplyFormatMoneyToDouble() + "</td>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.NguoiBenhCungChiTra).ApplyFormatMoneyToDouble() + "</td>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.Khac).ApplyFormatMoneyToDouble() + "</td>" +
                                        "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(chiPhiBangKe.NguoiBenhTuTra).ApplyFormatMoneyToDouble(true) + "</td>" +
                                        "</tr>";
                        indexItem++;
                    }
                }

            }

            dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                "<td style='border: 1px solid #020000;' colspan='7'></span>" +
                                "<span style='float:right;padding-right: 50px;'><b>Tổng Cộng</b></span>" +
                                "</td>" +
                                $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                $"<td style='border: 1px solid #020000;text-align: right;'><b></b> </td>" +
                                $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble()}</b> </td>" +
                                $"<td style='border: 1px solid #020000;text-align: right;'><b>{Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true)}</b> </td>" +
                                "</tr>" +
                                "</table>";

            var checkedLyDoVaoVien = "<input id='demo_box_2' class='css - checkbox' type='checkbox' checked  disabled='true'/>";
            var unCheckedLyDoVaoVien = "<input id='demo_box_2' class='css - checkbox' type='checkbox' disabled='true' />";
            var data = new
            {
                TitleBangKe = "KHÁM BỆNH",
                SoBangKe = "1",
                yeuCauTiepNhan.BenhNhan.MaBN,
                MaTN = yeuCauTiepNhan.MaYeuCauTiepNhan,
                SoBenhAn = "",
                yeuCauTiepNhan.HoTen,
                DiaChi = yeuCauTiepNhan.DiaChiDayDu,
                BarCodeImgBase64 = !string.IsNullOrEmpty(yeuCauTiepNhan.MaYeuCauTiepNhan) ? BarcodeHelper.GenerateBarCode(yeuCauTiepNhan.MaYeuCauTiepNhan) : "",
                NamSinh = DateHelper.DOBFormat(yeuCauTiepNhan.NgaySinh, yeuCauTiepNhan.ThangSinh, yeuCauTiepNhan.NamSinh),
                GioiTinh = yeuCauTiepNhan.GioiTinh != null ? yeuCauTiepNhan.GioiTinh.GetDescription() : "",
                TenKhoa = yeuCauKhamBenh?.NoiThucHien?.KhoaPhong?.Ten,
                MaKhoa = yeuCauKhamBenh?.NoiThucHien?.KhoaPhong?.Ma,
                MaBHYT = maBHYT,
                BHYTTuNgay = bHYTTuNgay,
                BHYTDenNgay = bHYTDenNgay,
                NoiDKKCBBanDau,
                MaKCBBanDau,
                NgayDenKham = yeuCauTiepNhan.ThoiDiemTiepNhan.ApplyFormatGioPhutNgay(),
                DieuTriKNT = "",
                KetThucKhamNgoaiTru = yeuCauKhamBenh?.ThoiDiemHoanThanh?.ApplyFormatGioPhutNgay(),
                SoNgayDTri = "",
                TinhTrangRaVien = 1,
                MucHuong = mucHuong,
                NoiChuyenDen = yeuCauTiepNhan.NoiChuyen?.Ten,
                NoiChuyenDi = yeuCauKhamBenh?.BenhVienChuyenVien?.Ten,
                MKV = yeuCauTiepNhan.BHYTMaKhuVuc,
                NgayMiemCungTC = yeuCauTiepNhan.BHYTNgayDuocMienCungChiTra?.ApplyFormatDate(),
                ThoiGian5Nam = yeuCauTiepNhan.BHYTNgayDu5Nam?.ApplyFormatDate(),
                CoCapCuu = yeuCauTiepNhan.LyDoVaoVien == Enums.EnumLyDoVaoVien.CapCuu ? checkedLyDoVaoVien : unCheckedLyDoVaoVien,
                CoDungTuyen = yeuCauTiepNhan.LyDoVaoVien == Enums.EnumLyDoVaoVien.DungTuyen ? checkedLyDoVaoVien : unCheckedLyDoVaoVien,
                CoThongTuyen = yeuCauTiepNhan.LyDoVaoVien == Enums.EnumLyDoVaoVien.ThongTuyen ? checkedLyDoVaoVien : unCheckedLyDoVaoVien,
                CoTraiTuyen = yeuCauTiepNhan.LyDoVaoVien == Enums.EnumLyDoVaoVien.TraiTuyen ? checkedLyDoVaoVien : unCheckedLyDoVaoVien,

                ChuanDoanXacDinh = yeuCauKhamBenh?.GhiChuICDChinh,
                MaICD10 = yeuCauKhamBenh?.Icdchinh?.Ma,
                BenhKemTheo = tenICDKemTheo,
                ICDKemTheo10 = maICDKemTheo,

                DateItemChiPhis = dateItemChiPhis,

                TTDV = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble(),
                TTTTBHYT = "",

                TTTienBH = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble(),
                TQBHYT = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble(),
                TNCCTra = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble(),
                TongSoKhac = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble(),
                TNBTuTra = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true),

                TongChiPhi = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble(),
                SoTienBangChu = NumberHelper.ChuyenSoRaText(Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.ThanhTienBH))),

                NguoiBenhPhaiTra = (Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)) + Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhTuTra))).ApplyFormatMoneyToDouble(),

                TTQuyTT = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble(),
                BHYTChiTra = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble(),
                CacKhoanTraKhac = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true),
                SoTienKhac = Convert.ToDouble(dsChiPhiBangKe.Sum(o => o.Khac)).ApplyFormatMoneyToDouble(),
                NgayHienTai = DateTime.Now.ApplyFormatNgayThangNam()
            };

            var content = TemplateHelpper.FormatTemplateWithContentTemplate(result?.Body, data);
            return content;
        }

        public string GetHtmlPhieuThuTamUng(long id, string hostingName)
        {
            var currentUserId = _userAgentHelper.GetCurrentUserId();
            var nguoiLapPhieu = _useRepository.GetById(currentUserId).HoTen;

            var result = _templateRepository.TableNoTracking
                .FirstOrDefault(x => x.Name.Equals("PhieuTamUng"));

            var taiKhoanBenhNhanThu = _taiKhoanBenhNhanThu.TableNoTracking.Where(c =>
                    c.Id == id && c.LoaiThuTienBenhNhan == Enums.LoaiThuTienBenhNhan.ThuTamUng)
                .Include(cc => cc.YeuCauTiepNhan)
                .ThenInclude(cc => cc.PhuongXa)
                .Include(cc => cc.YeuCauTiepNhan)
                .ThenInclude(cc => cc.QuanHuyen)
                .Include(cc => cc.YeuCauTiepNhan)
                .ThenInclude(cc => cc.TinhThanh)
                .Include(cc => cc.YeuCauTiepNhan).ThenInclude(c => c.BenhNhan)
                .Include(ccc => ccc.TaiKhoanBenhNhanChis).FirstOrDefault();

            var soTienTamUng = taiKhoanBenhNhanThu?.ChuyenKhoan + taiKhoanBenhNhanThu?.POS +
                               taiKhoanBenhNhanThu?.TienMat;

            string hinhThucThanhToan = string.Empty;

            if (taiKhoanBenhNhanThu?.TienMat != null && taiKhoanBenhNhanThu?.TienMat != 0)
            {
                hinhThucThanhToan = "Tiền mặt";
            }

            if (taiKhoanBenhNhanThu?.ChuyenKhoan != null && taiKhoanBenhNhanThu?.ChuyenKhoan != 0)
            {
                hinhThucThanhToan += !String.IsNullOrEmpty(hinhThucThanhToan) ? ";Chuyển khoản" : "Chuyển khoản";
            }

            if (taiKhoanBenhNhanThu?.POS != null && taiKhoanBenhNhanThu?.POS != 0)
            {
                hinhThucThanhToan += !String.IsNullOrEmpty(hinhThucThanhToan) ? ";POS" : "POS";
            }

            var diaChi = taiKhoanBenhNhanThu?.YeuCauTiepNhan.DiaChiDayDu;

            var data = new
            {
                TilteTamUng = (taiKhoanBenhNhanThu.YeuCauTiepNhan.LoaiYeuCauTiepNhan == Enums.EnumLoaiYeuCauTiepNhan.KhamChuaBenhNgoaiTru || taiKhoanBenhNhanThu.YeuCauTiepNhan.LoaiYeuCauTiepNhan == Enums.EnumLoaiYeuCauTiepNhan.KhamSucKhoe)
                ? "PHIẾU THU TẠM ỨNG KHÁM CHỮA BỆNH NGOẠI TRÚ" : "PHIẾU THU TẠM ỨNG KHÁM CHỮA BỆNH NỘI TRÚ",

                LogoUrl = hostingName + "/assets/img/logo-bacha-full.png",
                NguoiNopTien = taiKhoanBenhNhanThu?.YeuCauTiepNhan.HoTen,

                MaBN = taiKhoanBenhNhanThu?.YeuCauTiepNhan.BenhNhan.MaBN,
                NamSinh = DateHelper.DOBFormat(taiKhoanBenhNhanThu?.YeuCauTiepNhan?.NgaySinh, taiKhoanBenhNhanThu?.YeuCauTiepNhan?.ThangSinh, taiKhoanBenhNhanThu?.YeuCauTiepNhan?.NamSinh),

                GioiTinh = taiKhoanBenhNhanThu?.YeuCauTiepNhan.GioiTinh.GetDescription(),
                DiaChi = diaChi,
                DienDai = taiKhoanBenhNhanThu?.NoiDungThu,
                SoQuyen = taiKhoanBenhNhanThu?.SoQuyen,
                SoPhieu = taiKhoanBenhNhanThu?.SoPhieuHienThi,
                //ngay dưới phiếu thu là ngày thu(update 07/10/2021)
                NgayThu = taiKhoanBenhNhanThu.NgayThu.ToString("HH:mm") + " ngày " + taiKhoanBenhNhanThu.NgayThu.Day + " tháng " + taiKhoanBenhNhanThu.NgayThu.Month + " năm " + taiKhoanBenhNhanThu.NgayThu.Year,
                ngayThangHientai = "Ngày " + DateTime.Now.Day + " tháng " + DateTime.Now.Month + " năm " +
                                   DateTime.Now.Year,
                //SoTien = soTienTamUng?.ToString("0,00"),
                SoTien = Convert.ToDouble(soTienTamUng).ApplyFormatMoneyToDouble(),
                KemTheo = "Chứng từ gốc",
                ChungTu = "Chứng từ gốc",
                NguoiLapPhieu = nguoiLapPhieu,
                GoiHienTai = DateTime.Now.Hour + ":" + DateTime.Now.Minute + ":" +
                             DateTime.Now.Second,

                HinhThucTT = hinhThucThanhToan,

                TienMat = Convert.ToDouble(taiKhoanBenhNhanThu?.TienMat).ApplyFormatMoneyToDouble(),
                TienChuyenKhoan = Convert.ToDouble(taiKhoanBenhNhanThu?.ChuyenKhoan).ApplyFormatMoneyToDouble(),
                TienPos = Convert.ToDouble(taiKhoanBenhNhanThu?.POS).ApplyFormatMoneyToDouble(),

                SoTienBangChu = NumberHelper.ChuyenSoRaText(Convert.ToDouble(soTienTamUng))
            };

            var content = TemplateHelpper.FormatTemplateWithContentTemplate(result?.Body, data);
            return content;
        }

        public string GetHtmlPhieuHoanUngNgoaiTru(long taiKhoanChiId, string hostingName)
        {
            var currentUserId = _userAgentHelper.GetCurrentUserId();
            var nguoiLapPhieu = _useRepository.GetById(currentUserId).HoTen;
            var result = _templateRepository.TableNoTracking.FirstOrDefault(x => x.Name.Equals("PhieuChiHoanUng"));
            var taiKhoanBenhNhanChi = _taiKhoanBenhNhanChi.TableNoTracking.Include(o => o.NhanVienThuHoi).ThenInclude(o => o.User)
                                                                    .Include(o => o.YeuCauTiepNhan).ThenInclude(o => o.NoiTruBenhAn).FirstOrDefault(o => o.Id == taiKhoanChiId);
            var dsChiPhi = GetThongTinPhieuThu(taiKhoanChiId, LoaiPhieuThuChiThuNgan.HoanUng);
            var diaChi = taiKhoanBenhNhanChi?.YeuCauTiepNhan.DiaChiDayDu;

            var data = new
            {
                LogoUrl = hostingName + "/assets/img/logo-bacha-full.png",
                NguoiNhan = taiKhoanBenhNhanChi?.YeuCauTiepNhan.HoTen,
                SoVaoVien = taiKhoanBenhNhanChi?.YeuCauTiepNhan.MaYeuCauTiepNhan,
                DiaChi = diaChi,
                SoQuyen = taiKhoanBenhNhanChi?.SoQuyen,
                SoPhieu = taiKhoanBenhNhanChi?.SoPhieuHienThi,
                LyDoChi = taiKhoanBenhNhanChi?.NoiDungChi,
                SoTien = Convert.ToDouble(dsChiPhi.TienMat).ApplyFormatMoneyToDouble(),
                SoTienBangChu = NumberHelper.ChuyenSoRaText(Convert.ToDouble(dsChiPhi.TienMat)),
                GoiHienTai = DateTime.Now.Hour + ":" + DateTime.Now.Minute + ":" + DateTime.Now.Second,
                KemTheo = "Chứng từ gốc",
                ChungTu = "Chứng từ gốc"
            };

            var content = TemplateHelpper.FormatTemplateWithContentTemplate(result.Body, data);
            return content;
        }

        public string GetHtmlPhieuHoanThuNgoaiTru(long taiKhoanChiId, string hostingName)
        {
            var currentUserId = _userAgentHelper.GetCurrentUserId();
            var nguoiLapPhieu = _useRepository.GetById(currentUserId).HoTen;
            var result = _templateRepository.TableNoTracking.FirstOrDefault(x => x.Name.Equals("PhieuHoanThu"));
            var taiKhoanBenhNhanChi = _taiKhoanBenhNhanChi.TableNoTracking.Include(o => o.NhanVienThuHoi).ThenInclude(o => o.User)
                                                                    .Include(o => o.YeuCauTiepNhan).ThenInclude(o => o.NoiTruBenhAn).FirstOrDefault(o => o.Id == taiKhoanChiId);
            var dsChiPhi = GetThongTinPhieuThu(taiKhoanChiId, LoaiPhieuThuChiThuNgan.HoanThu);
            var diaChi = taiKhoanBenhNhanChi?.YeuCauTiepNhan.DiaChiDayDu;

            var data = new
            {
                LogoUrl = hostingName + "/assets/img/logo-bacha-full.png",
                NguoiNhan = taiKhoanBenhNhanChi?.YeuCauTiepNhan.HoTen,
                SoVaoVien = taiKhoanBenhNhanChi?.YeuCauTiepNhan.MaYeuCauTiepNhan,
                DiaChi = diaChi,
                SoQuyen = taiKhoanBenhNhanChi?.SoQuyen,
                SoPhieu = taiKhoanBenhNhanChi?.SoPhieuHienThi,
                LyDoChi = taiKhoanBenhNhanChi?.NoiDungChi,
                SoTien = Convert.ToDouble(dsChiPhi.TienMat).ApplyFormatMoneyToDouble(),
                SoTienBangChu = NumberHelper.ChuyenSoRaText(Convert.ToDouble(dsChiPhi.TienMat)),
                GoiHienTai = DateTime.Now.Hour + ":" + DateTime.Now.Minute + ":" + DateTime.Now.Second,
                KemTheo = "Chứng từ gốc",
                ChungTu = "Chứng từ gốc"
            };

            var content = TemplateHelpper.FormatTemplateWithContentTemplate(result.Body, data);
            return content;
        }

        public (long, string) KiemTraPhieuThuCoBHYT(long yeuCauYeuCauId)
        {
            //khong can kiem tra
            //var yeuCauTiepNhan = BaseRepository.TableNoTracking.Where(c => c.Id == yeuCauYeuCauId && c.CoBHYT == true);
            //if (yeuCauTiepNhan.Any())
            //{
            //    var phieuThu = yeuCauTiepNhan.SelectMany(c => c.TaiKhoanBenhNhanThus.Where(cc => cc.LoaiThuTienBenhNhan == Enums.LoaiThuTienBenhNhan.ThuTheoChiPhi
            //                                                                                && cc.LoaiNoiThu == Enums.LoaiNoiThu.ThuNgan
            //                                                                                && cc.DaHuy != true
            //                                                                                && cc.ThuTienGoiDichVu != true)).FirstOrDefault();
            //    return phieuThu != null ? (phieuThu.Id, phieuThu.SoPhieuHienThi) : (0, "");
            //}
            return (0, "");
        }

        public (long, string) KiemTraPhieuThuGoiCoBHYT(long yeuCauYeuCauId)
        {
            //khong can kiem tra
            //var yeuCauTiepNhan = BaseRepository.TableNoTracking.Where(c => c.Id == yeuCauYeuCauId && c.CoBHYT == true);
            //if (yeuCauTiepNhan.Any())
            //{
            //    var phieuThu = yeuCauTiepNhan.SelectMany(c => c.TaiKhoanBenhNhanThus.Where(cc => cc.LoaiThuTienBenhNhan == Enums.LoaiThuTienBenhNhan.ThuTheoChiPhi
            //                                                                                     && cc.LoaiNoiThu == Enums.LoaiNoiThu.ThuNgan
            //                                                                                     && cc.DaHuy != true && cc.ThuTienGoiDichVu == true))
            //                                                                        .FirstOrDefault();

            //    return phieuThu != null ? (phieuThu.Id, phieuThu.SoPhieuHienThi) : (0, "");
            //}
            return (0, "");
        }

        public string GetHtmlPhieuChiDichVuTrongGoiCoBHYT(long taiKhoanThuId, string hostingName)
        {
            var currentUserId = _userAgentHelper.GetCurrentUserId();
            var nguoiLapPhieu = _useRepository.GetById(currentUserId).HoTen;

            var result = _templateRepository.TableNoTracking.FirstOrDefault(x => x.Name.Equals("PhieuChiDichVuGoiCoBHYT"));
            var taiKhoanBenhNhanChi = _taiKhoanBenhNhanThu.TableNoTracking.Where(c => c.Id == taiKhoanThuId)
                                                           .Include(cc => cc.YeuCauTiepNhan)
                                                           .ThenInclude(cc => cc.PhuongXa)
                                                           .Include(cc => cc.YeuCauTiepNhan)
                                                           .ThenInclude(cc => cc.QuanHuyen)
                                                           .Include(cc => cc.YeuCauTiepNhan)
                                                           .FirstOrDefault();

            var dsChiPhi = GetThongTinPhieuThu(taiKhoanThuId, LoaiPhieuThuChiThuNgan.PhieuChi);
            var diaChi = taiKhoanBenhNhanChi?.YeuCauTiepNhan.DiaChiDayDu;

            var data = new
            {
                LogoUrl = hostingName + "/assets/img/logo-bacha-full.png",
                NguoiNhanTien = taiKhoanBenhNhanChi?.YeuCauTiepNhan.HoTen,
                //taiKhoanBenhNhanChi?.YeuCauTiepNhan.NamSinh,

                NamSinh = DateHelper.DOBFormat(taiKhoanBenhNhanChi?.YeuCauTiepNhan?.NgaySinh, taiKhoanBenhNhanChi?.YeuCauTiepNhan?.ThangSinh, taiKhoanBenhNhanChi?.YeuCauTiepNhan?.NamSinh),

                GioiTinh = taiKhoanBenhNhanChi?.YeuCauTiepNhan.GioiTinh.GetDescription(),
                DiaChi = diaChi,
                DienDai = taiKhoanBenhNhanChi.TaiKhoanBenhNhanChis.FirstOrDefault()?.NoiDungChi,
                SoPhieuChi = taiKhoanBenhNhanChi.SoPhieuHienThi,
                ngayThangHientai = "Ngày " + DateTime.Now.Day + " tháng " + DateTime.Now.Month + " năm " + DateTime.Now.Year,
                TongChiPhi = Convert.ToDouble(dsChiPhi.TongChiPhi).ApplyFormatMoneyToDouble(),
                BHYTT = Convert.ToDouble(dsChiPhi.BHYTThanhToan).ApplyFormatMoneyToDouble(),
                ThanhTien = Convert.ToDouble(dsChiPhi.BHYTThanhToan).ApplyFormatMoneyToDouble(),
                KemTheo = "Chứng từ gốc",
                NguoiLapPhieu = nguoiLapPhieu,
                GoiHienTai = DateTime.Now.Hour + ":" + DateTime.Now.Minute + ":" + DateTime.Now.Second,
                SoTienBangChu = NumberHelper.ChuyenSoRaText(Convert.ToDouble(dsChiPhi.BHYTThanhToan)),
            };

            var content = TemplateHelpper.FormatTemplateWithContentTemplate(result.Body, data);
            return content;
        }

        #endregion

        #region update

        public async Task<GridDataSource> GetDataForGridThuNganAsync(ThuNganQueryInfo queryInfo, bool isAllData)
        {
            ReplaceDisplayValueSortExpression(queryInfo);
            var sreachString = JsonConvert.DeserializeObject<DanhSachBenhNhanChoThuNganGridVo>(queryInfo.AdditionalSearchString);

            //Build Default Sort
            if (queryInfo.Sort == null || queryInfo.Sort.Count == 0)
            {
                queryInfo.Sort = new List<Sort> { new Sort { Field = "ChuaThu", Dir = "desc" }, new Sort { Field = "CongNo", Dir = "desc" }, new Sort { Field = "HoanUng", Dir = "desc" }, new Sort { Field = "Id", Dir = "asc" } };
            }
            var queryTheoDanhSach = BaseRepository.TableNoTracking.Where(o => o.QuyetToanTheoNoiTru != true && (o.LoaiYeuCauTiepNhan == Enums.EnumLoaiYeuCauTiepNhan.KhamChuaBenhNgoaiTru || o.LoaiYeuCauTiepNhan == Enums.EnumLoaiYeuCauTiepNhan.DangKyGoiMarketing)
                                                                        && ((o.TrangThaiYeuCauTiepNhan == Enums.EnumTrangThaiYeuCauTiepNhan.DangThucHien
                                                                                && (o.YeuCauKhamBenhs.Any(k => k.YeuCauGoiDichVuId == null && k.GoiKhamSucKhoeId == null && k.TrangThai != Enums.EnumTrangThaiYeuCauKhamBenh.HuyKham)
                                                                                    || o.YeuCauDichVuKyThuats.Any(k => k.YeuCauGoiDichVuId == null && k.GoiKhamSucKhoeId == null && k.TrangThai != Enums.EnumTrangThaiYeuCauDichVuKyThuat.DaHuy)
                                                                                    || o.YeuCauDichVuGiuongBenhViens.Any(k => k.YeuCauGoiDichVuId == null && k.TrangThai != Enums.EnumTrangThaiGiuongBenh.DaHuy)
                                                                                    || o.YeuCauDuocPhamBenhViens.Any(k => k.YeuCauGoiDichVuId == null && k.TrangThai != Enums.EnumYeuCauDuocPhamBenhVien.DaHuy)
                                                                                    || o.YeuCauVatTuBenhViens.Any(k => k.YeuCauGoiDichVuId == null && k.TrangThai != Enums.EnumYeuCauVatTuBenhVien.DaHuy)
                                                                                    || o.BenhNhan.YeuCauGoiDichVus.Any(k => k.TrangThai != Enums.EnumTrangThaiYeuCauGoiDichVu.DaHuy)
                                                                                    || o.DonThuocThanhToans.Any(k => k.LoaiDonThuoc == Enums.EnumLoaiDonThuoc.ThuocBHYT && k.TrangThai != Enums.TrangThaiDonThuocThanhToan.DaHuy)))
                                                                            || (o.BenhNhan != null && o.BenhNhan.TaiKhoanBenhNhan != null && Math.Round(o.BenhNhan.TaiKhoanBenhNhan.SoDuTaiKhoan) != 0) /*&& o.Id == o.BenhNhan.YeuCauTiepNhans.Last().Id*/));


            var query = queryTheoDanhSach.Select(s => new DanhSachBenhNhanChoThuNganGridVo
            {
                Id = s.Id,
                MaTN = s.MaYeuCauTiepNhan,
                HoTen = s.HoTen,
                DienThoaiStr = s.SoDienThoaiDisplay,
                DienThoai = s.SoDienThoai,
                GioiTinh = s.GioiTinh,
                MaBN = s.BenhNhan != null ? s.BenhNhan.MaBN : "",
                NamSinh = s.NamSinh,

                ThoiDiemTiepNhanDisplay = s.ThoiDiemTiepNhan.ApplyFormatDateTimeSACH(),
                ThoiDiemTiepNhan = s.ThoiDiemTiepNhan,

                DoiTuong = s.CoBHYT != true ? "Viện phí" : "BHYT (" + s.BHYTMucHuong.ToString() + "%)",
                SoTienDuTaiKhoan = s.BenhNhan != null && s.BenhNhan.TaiKhoanBenhNhan != null ? Math.Round(s.BenhNhan.TaiKhoanBenhNhan.SoDuTaiKhoan) : 0,
                CongNo = s.BenhNhan != null && s.BenhNhan.TaiKhoanBenhNhan != null && Math.Round(s.BenhNhan.TaiKhoanBenhNhan.SoDuTaiKhoan) < 0,
                HoanUng = s.BenhNhan != null && s.BenhNhan.TaiKhoanBenhNhan != null && Math.Round(s.BenhNhan.TaiKhoanBenhNhan.SoDuTaiKhoan) > 0,
                ChuaThu = s.YeuCauKhamBenhs.Any(k =>
                               k.YeuCauGoiDichVuId == null && k.GoiKhamSucKhoeId == null && (k.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || k.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan || k.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                           || s.YeuCauDichVuKyThuats.Any(k =>
                               k.YeuCauGoiDichVuId == null && k.GoiKhamSucKhoeId == null && (k.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || k.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan || k.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                           || s.YeuCauDichVuGiuongBenhViens.Any(k =>
                               k.YeuCauGoiDichVuId == null && (k.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || k.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan || k.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                           || s.YeuCauDuocPhamBenhViens.Any(k =>
                               k.YeuCauGoiDichVuId == null && (k.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || k.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan || k.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                           || s.YeuCauVatTuBenhViens.Any(k =>
                               k.YeuCauGoiDichVuId == null && (k.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || k.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan || k.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                           || s.BenhNhan.YeuCauGoiDichVus.Any(k => (k.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || k.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan || k.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                           || s.DonThuocThanhToans.Any(k => k.LoaiDonThuoc == Enums.EnumLoaiDonThuoc.ThuocBHYT && (k.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || k.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan || k.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
            }).Where(o => (queryInfo.ChuaThu && o.ChuaThu) || (queryInfo.CongNo && o.CongNo && !o.ChuaThu) || (queryInfo.HoanUng && o.HoanUng && !o.ChuaThu) || (queryInfo.DaThu && !o.HoanUng && !o.CongNo && !o.ChuaThu));

            if (!string.IsNullOrEmpty(queryInfo.AdditionalSearchString))
            {
                var queryString = JsonConvert.DeserializeObject<DanhSachBenhNhanChoThuNganGridVo>(queryInfo.AdditionalSearchString);
                if (!string.IsNullOrEmpty(queryString.FromDate) || !string.IsNullOrEmpty(queryString.ToDate))
                {
                    DateTime denNgay;
                    queryString.FromDate.TryParseExactCustom(out var tuNgay);
                    //DateTime.TryParseExact(queryString.FromDate, "dd/MM/yyyy hh:mm tt", null, DateTimeStyles.None,
                    //    out var tuNgay);
                    if (string.IsNullOrEmpty(queryString.ToDate))
                    {
                        denNgay = DateTime.Now;
                    }
                    else
                    {
                        queryString.ToDate.TryParseExactCustom(out denNgay);
                        //DateTime.TryParseExact(queryString.ToDate, "dd/MM/yyyy hh:mm tt", null, DateTimeStyles.None, out denNgay);
                    }
                    denNgay = denNgay.AddSeconds(59).AddMilliseconds(999);
                    query = query.Where(p => p.ThoiDiemTiepNhan >= tuNgay && p.ThoiDiemTiepNhan <= denNgay);
                }

                if (!string.IsNullOrEmpty(queryString.MaTN))
                    query = query.Where(p => p.MaTN.Contains(queryString.MaTN.Trim()));
                if (!string.IsNullOrEmpty(queryString.MaBN))
                    query = query.Where(p => p.MaBN.Contains(queryString.MaBN.Trim()));
                if (!string.IsNullOrEmpty(queryString.HoTen))
                    query = query.Where(p => p.HoTen.Contains(queryString.HoTen.Trim()));
                if (queryString.NamSinh.GetValueOrDefault() != 0)
                    query = query.Where(p => p.NamSinh == queryString.NamSinh);
                if (!string.IsNullOrEmpty(queryString.DienThoaiStr))
                    query = query.Where(p => p.DienThoaiStr.Contains(queryString.DienThoaiStr.Trim()));
            }
            if (!string.IsNullOrEmpty(sreachString.SearchString))
            {
                query = query.ApplyLike(sreachString.SearchString.Trim(),
                   g => g.MaBN,
                   g => g.HoTen,
                   g => g.DienThoai, g => g.DienThoaiStr,
                   g => g.MaTN);
            }

            var queryResult = isAllData == true ? await query.OrderBy(queryInfo.SortString).ToArrayAsync()
                : await query.OrderBy(queryInfo.SortString).Skip(queryInfo.Skip).Take(queryInfo.Take).ToArrayAsync();

            if (queryResult.Length > 0)
            {
                var danhSachChiPhiDichVus = await BaseRepository.TableNoTracking.Where(tn => queryResult.Select(o => o.Id).Contains(tn.Id)).Select(tn =>
                    new DanhSachChiPhiDichVuVo
                    {
                        YeuCauTiepNhanId = tn.Id,
                        ChiPhiDichVuKhamBenh = tn.YeuCauKhamBenhs.Where(o => o.YeuCauGoiDichVuId == null && o.GoiKhamSucKhoeId == null && o.TrangThai != Enums.EnumTrangThaiYeuCauKhamBenh.HuyKham).Select(yc => new ChiPhiDichVuVo
                        {
                            Soluong = 1,
                            DonGia = yc.Gia,
                            KhongTinhPhi = yc.KhongTinhPhi,
                            DuocHuongBHYT = yc.DuocHuongBaoHiem,
                            DonGiaBHYT = yc.DonGiaBaoHiem.GetValueOrDefault(),
                            TiLeBaoHiemThanhToan = yc.TiLeBaoHiemThanhToan.GetValueOrDefault(),
                            MucHuongBaoHiem = yc.MucHuongBaoHiem.GetValueOrDefault(),
                            SoTienMG = yc.SoTienMienGiam.GetValueOrDefault(),
                            DaThanhToan = yc.SoTienBenhNhanDaChi.GetValueOrDefault(),
                            TongCongNo = yc.CongTyBaoHiemTuNhanCongNos.Select(o => o.SoTien).DefaultIfEmpty(0).Sum()
                        }).ToList(),
                        ChiPhiDichVuKyThuat = tn.YeuCauDichVuKyThuats.Where(o => o.YeuCauGoiDichVuId == null && o.GoiKhamSucKhoeId == null && o.TrangThai != Enums.EnumTrangThaiYeuCauDichVuKyThuat.DaHuy).Select(yc => new ChiPhiDichVuVo
                        {
                            Soluong = yc.SoLan,
                            DonGia = yc.Gia,
                            KhongTinhPhi = yc.KhongTinhPhi,
                            DuocHuongBHYT = yc.DuocHuongBaoHiem,
                            DonGiaBHYT = yc.DonGiaBaoHiem.GetValueOrDefault(),
                            TiLeBaoHiemThanhToan = yc.TiLeBaoHiemThanhToan.GetValueOrDefault(),
                            MucHuongBaoHiem = yc.MucHuongBaoHiem.GetValueOrDefault(),
                            SoTienMG = yc.SoTienMienGiam.GetValueOrDefault(),
                            DaThanhToan = yc.SoTienBenhNhanDaChi.GetValueOrDefault(),
                            TongCongNo = yc.CongTyBaoHiemTuNhanCongNos.Select(o => o.SoTien).DefaultIfEmpty(0).Sum()
                        }).ToList(),
                        ChiPhiDichVuGiuong = tn.YeuCauDichVuGiuongBenhViens.Where(o => o.YeuCauGoiDichVuId == null && o.TrangThai != Enums.EnumTrangThaiGiuongBenh.DaHuy).Select(yc => new ChiPhiDichVuVo
                        {
                            Soluong = 1,
                            DonGia = yc.Gia.GetValueOrDefault(),
                            KhongTinhPhi = yc.KhongTinhPhi,
                            DuocHuongBHYT = yc.DuocHuongBaoHiem,
                            DonGiaBHYT = yc.DonGiaBaoHiem.GetValueOrDefault(),
                            TiLeBaoHiemThanhToan = yc.TiLeBaoHiemThanhToan.GetValueOrDefault(),
                            MucHuongBaoHiem = yc.MucHuongBaoHiem.GetValueOrDefault(),
                            SoTienMG = yc.SoTienMienGiam.GetValueOrDefault(),
                            DaThanhToan = yc.SoTienBenhNhanDaChi.GetValueOrDefault(),
                            TongCongNo = yc.CongTyBaoHiemTuNhanCongNos.Select(o => o.SoTien).DefaultIfEmpty(0).Sum()
                        }).ToList(),
                        ChiPhiDuocPham = tn.YeuCauDuocPhamBenhViens.Where(o => o.YeuCauGoiDichVuId == null && o.TrangThai != Enums.EnumYeuCauDuocPhamBenhVien.DaHuy).Select(yc => new ChiPhiDichVuVo
                        {
                            Soluong = yc.SoLuong,
                            DonGia = yc.DonGiaBan,
                            KhongTinhPhi = yc.KhongTinhPhi,
                            DuocHuongBHYT = yc.DuocHuongBaoHiem,
                            DonGiaBHYT = yc.DonGiaBaoHiem.GetValueOrDefault(),
                            TiLeBaoHiemThanhToan = yc.TiLeBaoHiemThanhToan.GetValueOrDefault(),
                            MucHuongBaoHiem = yc.MucHuongBaoHiem.GetValueOrDefault(),
                            SoTienMG = yc.SoTienMienGiam.GetValueOrDefault(),
                            DaThanhToan = yc.SoTienBenhNhanDaChi.GetValueOrDefault(),
                            TongCongNo = yc.CongTyBaoHiemTuNhanCongNos.Select(o => o.SoTien).DefaultIfEmpty(0).Sum()
                        }).ToList(),
                        ChiPhiVatTu = tn.YeuCauVatTuBenhViens.Where(o => o.YeuCauGoiDichVuId == null && o.TrangThai != Enums.EnumYeuCauVatTuBenhVien.DaHuy).Select(yc => new ChiPhiDichVuVo
                        {
                            Soluong = yc.SoLuong,
                            DonGia = yc.DonGiaBan,
                            KhongTinhPhi = yc.KhongTinhPhi,
                            DuocHuongBHYT = yc.DuocHuongBaoHiem,
                            DonGiaBHYT = yc.DonGiaBaoHiem.GetValueOrDefault(),
                            TiLeBaoHiemThanhToan = yc.TiLeBaoHiemThanhToan.GetValueOrDefault(),
                            MucHuongBaoHiem = yc.MucHuongBaoHiem.GetValueOrDefault(),
                            SoTienMG = yc.SoTienMienGiam.GetValueOrDefault(),
                            DaThanhToan = yc.SoTienBenhNhanDaChi.GetValueOrDefault(),
                            TongCongNo = yc.CongTyBaoHiemTuNhanCongNos.Select(o => o.SoTien).DefaultIfEmpty(0).Sum()
                        }).ToList(),
                        ChiPhiToaThuoc = tn.DonThuocThanhToans.Where(o => o.LoaiDonThuoc == Enums.EnumLoaiDonThuoc.ThuocBHYT && o.TrangThai != Enums.TrangThaiDonThuocThanhToan.DaHuy).SelectMany(o => o.DonThuocThanhToanChiTiets).Select(yc => new ChiPhiDichVuVo
                        {
                            Soluong = yc.SoLuong,
                            DonGia = yc.DonGiaBan,
                            KhongTinhPhi = false,
                            DuocHuongBHYT = yc.DuocHuongBaoHiem,
                            DonGiaBHYT = yc.DonGiaBaoHiem.GetValueOrDefault(),
                            TiLeBaoHiemThanhToan = yc.TiLeBaoHiemThanhToan.GetValueOrDefault(),
                            MucHuongBaoHiem = yc.MucHuongBaoHiem.GetValueOrDefault(),
                            SoTienMG = yc.SoTienMienGiam.GetValueOrDefault(),
                            DaThanhToan = yc.SoTienBenhNhanDaChi.GetValueOrDefault(),
                            TongCongNo = yc.CongTyBaoHiemTuNhanCongNos.Select(o => o.SoTien).DefaultIfEmpty(0).Sum()
                        }),
                        ChiPhiGoiDichVu = tn.BenhNhan.YeuCauGoiDichVus
                            .Where(yc => yc.TrangThai != Enums.EnumTrangThaiYeuCauGoiDichVu.DaHuy).Select(yc =>
                                new ChiPhiDichVuVo
                                {
                                    Soluong = 1,
                                    DonGia = yc.GiaSauChietKhau,
                                    KhongTinhPhi = false,
                                    DuocHuongBHYT = false,
                                    DonGiaBHYT = 0,
                                    TiLeBaoHiemThanhToan = 0,
                                    MucHuongBaoHiem = 0,
                                    SoTienMG = yc.SoTienMienGiam.GetValueOrDefault(),
                                    DaThanhToan = yc.SoTienBenhNhanDaChi.GetValueOrDefault(),
                                    TongCongNo =
                                        yc.CongTyBaoHiemTuNhanCongNos.Select(o => o.SoTien).DefaultIfEmpty(0).Sum()
                                }).ToList()
                    }
                ).ToListAsync();
                var danhSachThuTamUng = await BaseRepository.TableNoTracking.Where(tn => queryResult.Select(o => o.Id).Contains(tn.Id)).Select(tn =>
                    new
                    {
                        YeuCauTiepNhanId = tn.Id,
                        TienTamUng = tn.TaiKhoanBenhNhanThus.Where(o => o.DaHuy != true && o.LoaiThuTienBenhNhan == Enums.LoaiThuTienBenhNhan.ThuTamUng && o.ThuTienGoiDichVu != true && o.PhieuHoanUngId == null).Select(o => o.TienMat.GetValueOrDefault() + o.ChuyenKhoan.GetValueOrDefault() + o.POS.GetValueOrDefault()).DefaultIfEmpty().Sum()
                    }
                ).ToListAsync();

                foreach (var danhSachBenhNhanChoThuNganGridVo in queryResult)
                {
                    danhSachBenhNhanChoThuNganGridVo.DanhSachChiPhiDichVu = danhSachChiPhiDichVus.FirstOrDefault(o => o.YeuCauTiepNhanId == danhSachBenhNhanChoThuNganGridVo.Id);
                    danhSachBenhNhanChoThuNganGridVo.SoTienTamUng = danhSachThuTamUng.FirstOrDefault(o => o.YeuCauTiepNhanId == danhSachBenhNhanChoThuNganGridVo.Id)?.TienTamUng ?? 0;
                }
            }

            return new GridDataSource { Data = queryResult };

        }

        public async Task<GridDataSource> GetTotalPageForGridDanhSachThuNganAsync(ThuNganQueryInfo queryInfo)
        {
            //Build Default Sort
            if (queryInfo.Sort == null || queryInfo.Sort.Count == 0)
            {
                queryInfo.Sort = new List<Sort> { new Sort { Field = "ChuaThu", Dir = "desc" }, new Sort { Field = "CongNo", Dir = "desc" }, new Sort { Field = "HoanUng", Dir = "desc" }, new Sort { Field = "Id", Dir = "asc" } };
            }
            var queryTheoDanhSach = BaseRepository.TableNoTracking.Where(o => o.QuyetToanTheoNoiTru != true && (o.LoaiYeuCauTiepNhan == Enums.EnumLoaiYeuCauTiepNhan.KhamChuaBenhNgoaiTru || o.LoaiYeuCauTiepNhan == Enums.EnumLoaiYeuCauTiepNhan.DangKyGoiMarketing)
                                                                        && ((o.TrangThaiYeuCauTiepNhan == Enums.EnumTrangThaiYeuCauTiepNhan.DangThucHien
                                                                                && (o.YeuCauKhamBenhs.Any(k => k.YeuCauGoiDichVuId == null && k.GoiKhamSucKhoeId == null && k.TrangThai != Enums.EnumTrangThaiYeuCauKhamBenh.HuyKham)
                                                                                    || o.YeuCauDichVuKyThuats.Any(k => k.YeuCauGoiDichVuId == null && k.GoiKhamSucKhoeId == null && k.TrangThai != Enums.EnumTrangThaiYeuCauDichVuKyThuat.DaHuy)
                                                                                    || o.YeuCauDichVuGiuongBenhViens.Any(k => k.YeuCauGoiDichVuId == null && k.TrangThai != Enums.EnumTrangThaiGiuongBenh.DaHuy)
                                                                                    || o.YeuCauDuocPhamBenhViens.Any(k => k.YeuCauGoiDichVuId == null && k.TrangThai != Enums.EnumYeuCauDuocPhamBenhVien.DaHuy)
                                                                                    || o.YeuCauVatTuBenhViens.Any(k => k.YeuCauGoiDichVuId == null && k.TrangThai != Enums.EnumYeuCauVatTuBenhVien.DaHuy)
                                                                                    || o.BenhNhan.YeuCauGoiDichVus.Any(k => k.TrangThai != Enums.EnumTrangThaiYeuCauGoiDichVu.DaHuy)
                                                                                    || o.DonThuocThanhToans.Any(k => k.LoaiDonThuoc == Enums.EnumLoaiDonThuoc.ThuocBHYT && k.TrangThai != Enums.TrangThaiDonThuocThanhToan.DaHuy)))
                                                                            || (o.BenhNhan != null && o.BenhNhan.TaiKhoanBenhNhan != null && Math.Round(o.BenhNhan.TaiKhoanBenhNhan.SoDuTaiKhoan) != 0) /*&& o.Id == o.BenhNhan.YeuCauTiepNhans.Last().Id*/));


            var query = queryTheoDanhSach.Select(s => new DanhSachBenhNhanChoThuNganGridVo
            {
                Id = s.Id,
                MaTN = s.MaYeuCauTiepNhan,
                HoTen = s.HoTen,
                DienThoaiStr = s.SoDienThoaiDisplay,
                DienThoai = s.SoDienThoai,
                GioiTinh = s.GioiTinh,
                MaBN = s.BenhNhan != null ? s.BenhNhan.MaBN : "",
                NamSinh = s.NamSinh,

                ThoiDiemTiepNhanDisplay = s.ThoiDiemTiepNhan.ApplyFormatDateTimeSACH(),
                ThoiDiemTiepNhan = s.ThoiDiemTiepNhan,

                DoiTuong = s.CoBHYT != true ? "Viện phí" : "BHYT (" + s.BHYTMucHuong.ToString() + "%)",
                SoTienDuTaiKhoan = s.BenhNhan != null && s.BenhNhan.TaiKhoanBenhNhan != null ? Math.Round(s.BenhNhan.TaiKhoanBenhNhan.SoDuTaiKhoan) : 0,
                CongNo = s.BenhNhan != null && s.BenhNhan.TaiKhoanBenhNhan != null && Math.Round(s.BenhNhan.TaiKhoanBenhNhan.SoDuTaiKhoan) < 0,
                HoanUng = s.BenhNhan != null && s.BenhNhan.TaiKhoanBenhNhan != null && Math.Round(s.BenhNhan.TaiKhoanBenhNhan.SoDuTaiKhoan) > 0,
                ChuaThu = s.YeuCauKhamBenhs.Any(k =>
                               k.YeuCauGoiDichVuId == null && k.GoiKhamSucKhoeId == null && (k.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || k.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan || k.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                           || s.YeuCauDichVuKyThuats.Any(k =>
                               k.YeuCauGoiDichVuId == null && k.GoiKhamSucKhoeId == null && (k.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || k.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan || k.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                           || s.YeuCauDichVuGiuongBenhViens.Any(k =>
                               k.YeuCauGoiDichVuId == null && (k.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || k.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan || k.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                           || s.YeuCauDuocPhamBenhViens.Any(k =>
                               k.YeuCauGoiDichVuId == null && (k.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || k.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan || k.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                           || s.YeuCauVatTuBenhViens.Any(k =>
                               k.YeuCauGoiDichVuId == null && (k.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || k.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan || k.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                           || s.BenhNhan.YeuCauGoiDichVus.Any(k => (k.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || k.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan || k.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                           || s.DonThuocThanhToans.Any(k => k.LoaiDonThuoc == Enums.EnumLoaiDonThuoc.ThuocBHYT && (k.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || k.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan || k.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
            }).Where(o => (queryInfo.ChuaThu && o.ChuaThu) || (queryInfo.CongNo && o.CongNo && !o.ChuaThu) || (queryInfo.HoanUng && o.HoanUng && !o.ChuaThu) || (queryInfo.DaThu && !o.HoanUng && !o.CongNo && !o.ChuaThu));

            if (!string.IsNullOrEmpty(queryInfo.AdditionalSearchString))
            {
                var queryString = JsonConvert.DeserializeObject<DanhSachBenhNhanChoThuNganGridVo>(queryInfo.AdditionalSearchString);

                if (!string.IsNullOrEmpty(queryString.FromDate) || !string.IsNullOrEmpty(queryString.ToDate))
                {
                    DateTime denNgay;
                    queryString.FromDate.TryParseExactCustom(out var tuNgay);
                    //DateTime.TryParseExact(queryString.FromDate, "dd/MM/yyyy hh:mm tt", null, DateTimeStyles.None,
                    //    out var tuNgay);
                    if (string.IsNullOrEmpty(queryString.ToDate))
                    {
                        denNgay = DateTime.Now;
                    }
                    else
                    {
                        queryString.ToDate.TryParseExactCustom(out denNgay);
                        //DateTime.TryParseExact(queryString.ToDate, "dd/MM/yyyy hh:mm tt", null, DateTimeStyles.None, out denNgay);
                    }
                    denNgay = denNgay.AddSeconds(59).AddMilliseconds(999);
                    query = query.Where(p => p.ThoiDiemTiepNhan >= tuNgay && p.ThoiDiemTiepNhan <= denNgay);
                }


                if (!string.IsNullOrEmpty(queryString.MaTN))
                    query = query.Where(p => p.MaTN.Contains(queryString.MaTN.Trim()));
                if (!string.IsNullOrEmpty(queryString.MaBN))
                    query = query.Where(p => p.MaBN.Contains(queryString.MaBN.Trim()));
                if (!string.IsNullOrEmpty(queryString.HoTen))
                    query = query.Where(p => p.HoTen.Contains(queryString.HoTen.Trim()));
                if (queryString.NamSinh.GetValueOrDefault() != 0)
                    query = query.Where(p => p.NamSinh == queryString.NamSinh);
                if (!string.IsNullOrEmpty(queryString.DienThoaiStr))
                    query = query.Where(p => p.DienThoaiStr.Contains(queryString.DienThoaiStr.Trim()));
            }
            if (!string.IsNullOrEmpty(queryInfo.SearchTerms))
            {
                query = query.ApplyLike(queryInfo.SearchTerms,
                   g => g.MaBN,
                   g => g.HoTen,
                   g => g.DienThoai, g => g.DienThoaiStr,
                   g => g.MaTN);
            }

            var totalRow = await query.CountAsync();
            return new GridDataSource { TotalRowCount = totalRow };
        }

        #endregion
        /*
        #region Thu tiền phí khám bệnh

        public async Task<(long, string)> ThuPhiKhamChuaBenh(ThuPhiKhamChuaBenhVo thuPhiKhamChuaBenhVo)
        {
            var ycTiepNhan = await BaseRepository.GetByIdAsync(thuPhiKhamChuaBenhVo.Id,
                x => x.Include(o => o.TheVoucherYeuCauTiepNhans).ThenInclude(g => g.TheVoucher).ThenInclude(v => v.Voucher).ThenInclude(v => v.VoucherChiTietMienGiams)
                    .Include(o => o.YeuCauKhamBenhs).ThenInclude(g => g.CongTyBaoHiemTuNhanCongNos)
                    .Include(o => o.YeuCauKhamBenhs).ThenInclude(g => g.YeuCauNhapViens).ThenInclude(g => g.YeuCauTiepNhans)
                    .Include(o => o.YeuCauDichVuKyThuats).ThenInclude(g => g.CongTyBaoHiemTuNhanCongNos)
                    .Include(o => o.YeuCauDuocPhamBenhViens).ThenInclude(g => g.CongTyBaoHiemTuNhanCongNos)
                    .Include(o => o.YeuCauVatTuBenhViens).ThenInclude(g => g.CongTyBaoHiemTuNhanCongNos)
                    .Include(o => o.YeuCauDichVuGiuongBenhViens).ThenInclude(g => g.CongTyBaoHiemTuNhanCongNos)
                    .Include(o => o.DonThuocThanhToans).ThenInclude(g => g.DonThuocThanhToanChiTiets)
                    .ThenInclude(g => g.CongTyBaoHiemTuNhanCongNos)
                    .Include(o => o.BenhNhan).ThenInclude(o => o.YeuCauGoiDichVus).ThenInclude(g => g.CongTyBaoHiemTuNhanCongNos)
                    .Include(o => o.BenhNhan).ThenInclude(o => o.YeuCauGoiDichVus).ThenInclude(g => g.YeuCauDichVuKyThuats)
                    .Include(o => o.BenhNhan).ThenInclude(o => o.YeuCauGoiDichVus).ThenInclude(g => g.YeuCauKhamBenhs)
                    .Include(o => o.BenhNhan).ThenInclude(o => o.YeuCauGoiDichVus).ThenInclude(g => g.MienGiamChiPhis)
                    .Include(o => o.BenhNhan).ThenInclude(o => o.TaiKhoanBenhNhan)
                    .Include(o => o.DoiTuongUuDai).ThenInclude(ud => ud.DoiTuongUuDaiDichVuKhamBenhBenhViens)
                    .Include(o => o.DoiTuongUuDai).ThenInclude(ud => ud.DoiTuongUuDaiDichVuKyThuatBenhViens)
                    .Include(o => o.MienGiamChiPhis));

            var thongTinMienGiam = await GetThongTinMienGiam(thuPhiKhamChuaBenhVo.Id);

            if (ycTiepNhan.BenhNhan == null)
                return (0, "Không có người bệnh");

            //kiem tra thong tin truoc khi thanh toan
            var ycKhamBenhExcept = thuPhiKhamChuaBenhVo.DanhSachChiPhiKhamChuaBenhDaChons
                .Where(o => o.LoaiNhom == NhomChiPhiKhamChuaBenh.DichVuKhamBenh).Select(o => o.Id).Except(ycTiepNhan
                    .YeuCauKhamBenhs
                    .Where(o => o.YeuCauGoiDichVuId == null && (!o.DuocHuongBaoHiem || o.BaoHiemChiTra != null) &&
                                (o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                                 o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                    .Select(o => o.Id));
            var ycKyThuatExcept = thuPhiKhamChuaBenhVo.DanhSachChiPhiKhamChuaBenhDaChons
                .Where(o => o.LoaiNhom == NhomChiPhiKhamChuaBenh.DichVuKyThuat).Select(o => o.Id).Except(ycTiepNhan
                    .YeuCauDichVuKyThuats
                    .Where(o => o.YeuCauGoiDichVuId == null && (!o.DuocHuongBaoHiem || o.BaoHiemChiTra != null) &&
                                (o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                                 o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                    .Select(o => o.Id));
            var ycGiuongExcept = thuPhiKhamChuaBenhVo.DanhSachChiPhiKhamChuaBenhDaChons
                .Where(o => o.LoaiNhom == NhomChiPhiKhamChuaBenh.DichVuGiuong).Select(o => o.Id).Except(ycTiepNhan
                    .YeuCauDichVuGiuongBenhViens
                    .Where(o => o.YeuCauGoiDichVuId == null && (!o.DuocHuongBaoHiem || o.BaoHiemChiTra != null) &&
                                (o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                                 o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                    .Select(o => o.Id));
            var ycDuocPhamExcept = thuPhiKhamChuaBenhVo.DanhSachChiPhiKhamChuaBenhDaChons
                .Where(o => o.LoaiNhom == NhomChiPhiKhamChuaBenh.DuocPham).Select(o => o.Id).Except(ycTiepNhan
                    .YeuCauDuocPhamBenhViens
                    .Where(o => o.YeuCauGoiDichVuId == null && (!o.DuocHuongBaoHiem || o.BaoHiemChiTra != null) &&
                                (o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                                 o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                    .Select(o => o.Id));
            var ycVatTuExcept = thuPhiKhamChuaBenhVo.DanhSachChiPhiKhamChuaBenhDaChons
                .Where(o => o.LoaiNhom == NhomChiPhiKhamChuaBenh.VatTuTieuHao).Select(o => o.Id).Except(ycTiepNhan
                    .YeuCauVatTuBenhViens
                    .Where(o => o.YeuCauGoiDichVuId == null && (!o.DuocHuongBaoHiem || o.BaoHiemChiTra != null) &&
                                (o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                                 o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                    .Select(o => o.Id));
            var ycToaThuocExcept = thuPhiKhamChuaBenhVo.DanhSachChiPhiKhamChuaBenhDaChons
                .Where(o => o.LoaiNhom == NhomChiPhiKhamChuaBenh.ToaThuoc).Select(o => o.Id).Except(ycTiepNhan
                    .DonThuocThanhToans
                    .Where(o => o.LoaiDonThuoc == Enums.EnumLoaiDonThuoc.ThuocBHYT &&
                                (o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                                 o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                    .SelectMany(o => o.DonThuocThanhToanChiTiets).Where(o => o.BaoHiemChiTra != null)
                    .Select(o => o.Id));

            var ycGoiDvExcept = thuPhiKhamChuaBenhVo.DanhSachChiPhiKhamChuaBenhDaChons
                .Where(o => o.LoaiNhom == NhomChiPhiKhamChuaBenh.GoiDichVu).Select(o => o.Id).Except(ycTiepNhan.BenhNhan.YeuCauGoiDichVus
                    .Where(o => o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan ||
                                o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan)
                    .Select(o => o.Id));

            if (ycKhamBenhExcept.Any() || ycKyThuatExcept.Any() || ycGiuongExcept.Any() || ycDuocPhamExcept.Any() || ycVatTuExcept.Any() ||
                ycToaThuocExcept.Any() || ycGoiDvExcept.Any()) return (0, "Thông tin dịch vụ thanh toán không hợp lệ, vui lòng tải lại trang");

            var tongThu = thuPhiKhamChuaBenhVo.TienMat.GetValueOrDefault() +
                          thuPhiKhamChuaBenhVo.ChuyenKhoan.GetValueOrDefault() +
                          thuPhiKhamChuaBenhVo.POS.GetValueOrDefault() + thuPhiKhamChuaBenhVo.SoTienCongNo.GetValueOrDefault() + thuPhiKhamChuaBenhVo.SoTienHoanLaiThanhToan.GetValueOrDefault();

            var dsChiPhi = await GetDanhSachChiPhiKhamChuaBenhChuaThu(thuPhiKhamChuaBenhVo.Id);
            var dsChiPhiDaChon = thuPhiKhamChuaBenhVo.DanhSachChiPhiKhamChuaBenhDaChons;

            foreach (var chiPhiKhamChuaBenhVo in dsChiPhiDaChon)
            {
                var chiphi = dsChiPhi.FirstOrDefault(o => o.LoaiNhom == chiPhiKhamChuaBenhVo.LoaiNhom && o.Id == chiPhiKhamChuaBenhVo.Id);
                if (chiphi == null || !chiphi.ThanhTien.AlmostEqual(chiPhiKhamChuaBenhVo.ThanhTien) || !chiphi.BHYTThanhToan.AlmostEqual(chiPhiKhamChuaBenhVo.BHYTThanhToan) || chiPhiKhamChuaBenhVo.TongCongNo > chiPhiKhamChuaBenhVo.ThanhTien - chiPhiKhamChuaBenhVo.BHYTThanhToan)
                {
                    return (0, "Thông tin dịch vụ thanh toán không hợp lệ, vui lòng tải lại trang");
                }
                var soTienTruocMienGiam = chiPhiKhamChuaBenhVo.ThanhTien - chiPhiKhamChuaBenhVo.BHYTThanhToan;

                decimal soTienMienGiamTheoDv = 0;

                foreach (var mienGiamTheoTiLe in chiPhiKhamChuaBenhVo.DanhSachMienGiamVos.Where(o => o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoTiLe))
                {
                    mienGiamTheoTiLe.SoTien = Math.Round((soTienTruocMienGiam * mienGiamTheoTiLe.TiLe.GetValueOrDefault() / 100), 2, MidpointRounding.AwayFromZero);
                    soTienMienGiamTheoDv += mienGiamTheoTiLe.SoTien;
                }
                foreach (var mienGiamTheoTiLe in chiPhiKhamChuaBenhVo.DanhSachMienGiamVos.Where(o => o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoSoTien))
                {
                    soTienMienGiamTheoDv += mienGiamTheoTiLe.SoTien;
                }
                if (soTienMienGiamTheoDv > soTienTruocMienGiam)
                {
                    return (0, "Thông tin dịch vụ thanh toán không hợp lệ, vui lòng tải lại trang");
                }
                chiPhiKhamChuaBenhVo.SoTienMG = soTienMienGiamTheoDv;
            }

            var soDuTk = ycTiepNhan.BenhNhan.TaiKhoanBenhNhan?.SoDuTaiKhoan ?? 0;
            var soTienCanThu = Math.Round(dsChiPhiDaChon.Sum(o => o.BNConPhaiThanhToan), MidpointRounding.AwayFromZero);
            if ((!soTienCanThu.SoTienTuongDuong(tongThu) && soTienCanThu <= 0)
                || (!soTienCanThu.SoTienTuongDuong(tongThu) && soDuTk <= 0)
                || (!soTienCanThu.SoTienTuongDuong(tongThu + soDuTk) && soDuTk > 0 && soDuTk < soTienCanThu && soTienCanThu >= 0)
                || (!tongThu.SoTienTuongDuong(0) && soDuTk >= soTienCanThu && soTienCanThu >= 0))
                return (0, "Số tiền thanh toán không hợp lệ");
            var soTienMienGiam = dsChiPhiDaChon.Sum(o => o.SoTienMG);

            var tk = ycTiepNhan.BenhNhan.TaiKhoanBenhNhan ?? new TaiKhoanBenhNhan
            {
                BenhNhan = ycTiepNhan.BenhNhan
            };

            var thuPhi = new TaiKhoanBenhNhanThu
            {
                TaiKhoanBenhNhan = tk,
                LoaiThuTienBenhNhan = Enums.LoaiThuTienBenhNhan.ThuTheoChiPhi,
                LoaiNoiThu = Enums.LoaiNoiThu.ThuNgan,
                TienMat = thuPhiKhamChuaBenhVo.TienMat,
                ChuyenKhoan = thuPhiKhamChuaBenhVo.ChuyenKhoan,
                POS = thuPhiKhamChuaBenhVo.POS,
                CongNo = thuPhiKhamChuaBenhVo.SoTienCongNo,
                NoiDungThu = thuPhiKhamChuaBenhVo.NoiDungThu,
                NgayThu = thuPhiKhamChuaBenhVo.NgayThu,
                SoQuyen = 1,
                NhanVienThucHienId = _userAgentHelper.GetCurrentUserId(),
                NoiThucHienId = _userAgentHelper.GetCurrentNoiLLamViecId()
            };

            foreach (var chiphi in dsChiPhiDaChon.Where(o => o.LoaiNhom == NhomChiPhiKhamChuaBenh.DichVuKhamBenh))
            {
                var yc = ycTiepNhan.YeuCauKhamBenhs.First(o => o.Id == chiphi.Id);
                if (yc.NoiDangKyId != null && yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan)
                {
                    yc.PhongBenhVienHangDois.Add(XepVaoHangDoi(ycTiepNhan, yc.NoiDangKyId.Value));
                }
                #region cong no
                //them cong no
                if (chiphi.TongCongNo > 0)
                {
                    foreach (var chiphiDanhSachCongNoChoThu in chiphi.DanhSachCongNoChoThus)
                    {
                        var congNoTruoc = yc.CongTyBaoHiemTuNhanCongNos.Where(o =>
                                o.CongTyBaoHiemTuNhanId == chiphiDanhSachCongNoChoThu.CongTyBaoHiemTuNhanId)
                            .Sum(o => o.SoTien);
                        if (!congNoTruoc.AlmostEqual(chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu))
                        {
                            yc.CongTyBaoHiemTuNhanCongNos.Add(new CongTyBaoHiemTuNhanCongNo
                            {
                                TaiKhoanBenhNhanThu = thuPhi,
                                CongTyBaoHiemTuNhanId = chiphiDanhSachCongNoChoThu.CongTyBaoHiemTuNhanId,
                                SoTien = chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu - congNoTruoc
                            });
                        }
                    }
                }
                else if (!yc.CongTyBaoHiemTuNhanCongNos.Sum(o => o.SoTien).AlmostEqual(0))
                {
                    foreach (var ycCongTyBaoHiemTuNhanCongNo in yc.CongTyBaoHiemTuNhanCongNos.Where(o => o.CreatedOn != null))
                    {
                        yc.CongTyBaoHiemTuNhanCongNos.Add(new CongTyBaoHiemTuNhanCongNo
                        {
                            TaiKhoanBenhNhanThu = thuPhi,
                            CongTyBaoHiemTuNhanId = ycCongTyBaoHiemTuNhanCongNo.CongTyBaoHiemTuNhanId,
                            SoTien = ycCongTyBaoHiemTuNhanCongNo.SoTien * (-1)
                        });
                    }
                }
                yc.SoTienBaoHiemTuNhanChiTra = chiphi.TongCongNo;
                #endregion
                #region mien giam
                //mien giam theo uu dai
                var uuDai = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.DoiTuongUuDaiId != null && o.TiLe != 0);
                var mienGiamChiPhiTruoc = ycTiepNhan.MienGiamChiPhis.Where(o => o.YeuCauKhamBenhId == yc.Id).ToList();
                var mienGiamTheoUuDaiGroups = mienGiamChiPhiTruoc.Where(o => o.DoiTuongUuDaiId != null).GroupBy(o => o.DoiTuongUuDaiId.Value);
                bool daMienGiamUuDai = false;
                foreach (var mienGiamTheoUuDaiGroup in mienGiamTheoUuDaiGroups)
                {
                    if (mienGiamTheoUuDaiGroup.Key != uuDai?.DoiTuongUuDaiId)
                    {
                        yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                        {
                            TaiKhoanBenhNhanThu = thuPhi,
                            YeuCauTiepNhanId = ycTiepNhan.Id,
                            LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                            DoiTuongUuDaiId = mienGiamTheoUuDaiGroup.Key,
                            LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                            TiLe = 0 - mienGiamTheoUuDaiGroup.Sum(o => o.TiLe.GetValueOrDefault()),
                            SoTien = 0 - mienGiamTheoUuDaiGroup.Sum(o => o.SoTien)
                        });
                    }
                    else
                    {
                        daMienGiamUuDai = true;
                        if (uuDai.TiLe.GetValueOrDefault() != mienGiamTheoUuDaiGroup.Sum(o => o.TiLe.GetValueOrDefault()) || !uuDai.SoTien.AlmostEqual(mienGiamTheoUuDaiGroup.Sum(o => o.SoTien)))
                        {
                            yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                            {
                                TaiKhoanBenhNhanThu = thuPhi,
                                YeuCauTiepNhanId = ycTiepNhan.Id,
                                LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                                DoiTuongUuDaiId = mienGiamTheoUuDaiGroup.Key,
                                LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                                TiLe = uuDai.TiLe.GetValueOrDefault() - mienGiamTheoUuDaiGroup.Sum(o => o.TiLe.GetValueOrDefault()),
                                SoTien = uuDai.SoTien - mienGiamTheoUuDaiGroup.Sum(o => o.SoTien)
                            });
                        }
                    }
                }
                if (!daMienGiamUuDai && uuDai != null)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                        DoiTuongUuDaiId = uuDai.DoiTuongUuDaiId,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                        TiLe = uuDai.TiLe.GetValueOrDefault(),
                        SoTien = uuDai.SoTien
                    });
                }

                //mien giam theo voucher
                var vouchers = chiphi.DanhSachMienGiamVos.Where(o => o.TheVoucherId != null).ToList();
                var mienGiamTheoVoucherGroups = mienGiamChiPhiTruoc.Where(o => o.TheVoucherId != null).GroupBy(o => o.TheVoucherId.Value).ToList();

                foreach (var mienGiamTheoVoucherGroup in mienGiamTheoVoucherGroups)
                {
                    if (!vouchers.Select(o => o.TheVoucherId).Contains(mienGiamTheoVoucherGroup.Key))
                    {
                        yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                        {
                            TaiKhoanBenhNhanThu = thuPhi,
                            YeuCauTiepNhanId = ycTiepNhan.Id,
                            LoaiMienGiam = Enums.LoaiMienGiam.Voucher,
                            TheVoucherId = mienGiamTheoVoucherGroup.Key,
                            LoaiChietKhau = mienGiamTheoVoucherGroup.First().LoaiChietKhau,
                            MaTheVoucher = mienGiamTheoVoucherGroup.First().MaTheVoucher,
                            TiLe = 0 - mienGiamTheoVoucherGroup.Sum(o => o.TiLe.GetValueOrDefault()),
                            SoTien = 0 - mienGiamTheoVoucherGroup.Sum(o => o.SoTien)
                        });
                    }
                }

                foreach (var voucher in vouchers)
                {
                    var mienGiamTheoVoucherGroup = mienGiamTheoVoucherGroups.FirstOrDefault(o => o.Key == voucher.TheVoucherId);
                    if (mienGiamTheoVoucherGroup != null)
                    {
                        if (voucher.TiLe.GetValueOrDefault() != mienGiamTheoVoucherGroup.Sum(o => o.TiLe.GetValueOrDefault()) || !voucher.SoTien.AlmostEqual(mienGiamTheoVoucherGroup.Sum(o => o.SoTien)))
                        {
                            yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                            {
                                TaiKhoanBenhNhanThu = thuPhi,
                                YeuCauTiepNhanId = ycTiepNhan.Id,
                                LoaiMienGiam = Enums.LoaiMienGiam.Voucher,
                                TheVoucherId = voucher.TheVoucherId,
                                LoaiChietKhau = voucher.LoaiChietKhau,
                                MaTheVoucher = voucher.MaTheVoucher,
                                TiLe = voucher.TiLe.GetValueOrDefault() - mienGiamTheoVoucherGroup.Sum(o => o.TiLe.GetValueOrDefault()),
                                SoTien = voucher.SoTien - mienGiamTheoVoucherGroup.Sum(o => o.SoTien)
                            });
                        }
                    }
                    else
                    {
                        yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                        {
                            TaiKhoanBenhNhanThu = thuPhi,
                            YeuCauTiepNhanId = ycTiepNhan.Id,
                            LoaiMienGiam = Enums.LoaiMienGiam.Voucher,
                            TheVoucherId = voucher.TheVoucherId,
                            LoaiChietKhau = voucher.LoaiChietKhau,
                            MaTheVoucher = voucher.MaTheVoucher,
                            TiLe = voucher.TiLe.GetValueOrDefault(),
                            SoTien = voucher.SoTien
                        });
                    }
                }

                //mien giam them theo ti le
                var mienGiamThemTiLeTruoc = mienGiamChiPhiTruoc.Where(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoTiLe).ToList();
                var mienGiamThemTiLe = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoTiLe);
                if (mienGiamThemTiLeTruoc.Any())
                {
                    if (mienGiamThemTiLe == null ||
                        (mienGiamThemTiLe.TiLe.GetValueOrDefault() != mienGiamThemTiLeTruoc.Sum(o => o.TiLe.GetValueOrDefault()) || !mienGiamThemTiLe.SoTien.AlmostEqual(mienGiamThemTiLeTruoc.Sum(o => o.SoTien))))
                    {
                        yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                        {
                            TaiKhoanBenhNhanThu = thuPhi,
                            YeuCauTiepNhanId = ycTiepNhan.Id,
                            LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                            LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                            TiLe = (mienGiamThemTiLe?.TiLe ?? 0) - mienGiamThemTiLeTruoc.Sum(o => o.TiLe.GetValueOrDefault()),
                            SoTien = (mienGiamThemTiLe?.SoTien ?? 0) - mienGiamThemTiLeTruoc.Sum(o => o.SoTien)
                        });
                    }
                }
                else if (mienGiamThemTiLe != null && mienGiamThemTiLe.TiLe.GetValueOrDefault() != 0)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                        TiLe = mienGiamThemTiLe.TiLe,
                        SoTien = mienGiamThemTiLe.SoTien
                    });
                }

                //mien giam them theo so tien
                var mienGiamThemSoTienTruoc = mienGiamChiPhiTruoc.Where(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoSoTien).ToList();
                var mienGiamThemSoTien = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoSoTien);
                if (mienGiamThemSoTienTruoc.Any())
                {
                    if (mienGiamThemSoTien == null || !mienGiamThemSoTien.SoTien.AlmostEqual(mienGiamThemSoTienTruoc.Sum(o => o.SoTien)))
                    {
                        yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                        {
                            TaiKhoanBenhNhanThu = thuPhi,
                            YeuCauTiepNhanId = ycTiepNhan.Id,
                            LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                            LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoSoTien,
                            SoTien = (mienGiamThemSoTien?.SoTien ?? 0) - mienGiamThemSoTienTruoc.Sum(o => o.SoTien)
                        });
                    }
                }
                else if (mienGiamThemSoTien != null && !mienGiamThemSoTien.SoTien.AlmostEqual(0))
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoSoTien,
                        SoTien = mienGiamThemSoTien.SoTien
                    });
                }
                yc.SoTienMienGiam = chiphi.SoTienMG;

                if ((mienGiamThemTiLe?.SoTien ?? 0).AlmostEqual(0) && (mienGiamThemSoTien?.SoTien ?? 0).AlmostEqual(0))
                {
                    yc.GhiChuMienGiamThem = null;
                }
                else
                {
                    yc.GhiChuMienGiamThem = chiphi.GhiChuMienGiamThem;
                }

                #endregion
                yc.SoTienBenhNhanDaChi = yc.SoTienBenhNhanDaChi.GetValueOrDefault() + chiphi.BNConPhaiThanhToan;
                yc.TrangThaiThanhToan = Enums.TrangThaiThanhToan.DaThanhToan;
                thuPhi.TaiKhoanBenhNhanChis.Add(new TaiKhoanBenhNhanChi
                {
                    TaiKhoanBenhNhan = tk,
                    LoaiChiTienBenhNhan = Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi,
                    TienChiPhi = chiphi.BNConPhaiThanhToan,
                    NoiDungChi = Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi.GetDescription(),
                    NgayChi = DateTime.Now,
                    SoQuyen = 1,
                    YeuCauKhamBenh = yc,
                    YeuCauTiepNhanId = ycTiepNhan.Id,
                    NhanVienThucHienId = _userAgentHelper.GetCurrentUserId(),
                    NoiThucHienId = _userAgentHelper.GetCurrentNoiLLamViecId()
                });
            }

            foreach (var chiphi in dsChiPhiDaChon.Where(o => o.LoaiNhom == NhomChiPhiKhamChuaBenh.DichVuKyThuat))
            {
                var yc = ycTiepNhan.YeuCauDichVuKyThuats.First(o => o.Id == chiphi.Id);
                if (yc.NoiThucHienId != null && yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan)
                {
                    yc.PhongBenhVienHangDois.Add(XepVaoHangDoi(ycTiepNhan, yc.NoiThucHienId.Value));
                }
                #region cap nhat cong no
                //them cong no
                if (chiphi.TongCongNo > 0)
                {
                    foreach (var chiphiDanhSachCongNoChoThu in chiphi.DanhSachCongNoChoThus)
                    {
                        var congNoTruoc = yc.CongTyBaoHiemTuNhanCongNos.Where(o =>
                                o.CongTyBaoHiemTuNhanId == chiphiDanhSachCongNoChoThu.CongTyBaoHiemTuNhanId)
                            .Sum(o => o.SoTien);
                        if (!congNoTruoc.AlmostEqual(chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu))
                        {
                            yc.CongTyBaoHiemTuNhanCongNos.Add(new CongTyBaoHiemTuNhanCongNo
                            {
                                TaiKhoanBenhNhanThu = thuPhi,
                                CongTyBaoHiemTuNhanId = chiphiDanhSachCongNoChoThu.CongTyBaoHiemTuNhanId,
                                SoTien = chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu - congNoTruoc
                            });
                        }
                    }
                }
                else if (!yc.CongTyBaoHiemTuNhanCongNos.Sum(o => o.SoTien).AlmostEqual(0))
                {
                    foreach (var ycCongTyBaoHiemTuNhanCongNo in yc.CongTyBaoHiemTuNhanCongNos.Where(o => o.CreatedOn != null))
                    {
                        yc.CongTyBaoHiemTuNhanCongNos.Add(new CongTyBaoHiemTuNhanCongNo
                        {
                            TaiKhoanBenhNhanThu = thuPhi,
                            CongTyBaoHiemTuNhanId = ycCongTyBaoHiemTuNhanCongNo.CongTyBaoHiemTuNhanId,
                            SoTien = ycCongTyBaoHiemTuNhanCongNo.SoTien * (-1)
                        });
                    }
                }
                yc.SoTienBaoHiemTuNhanChiTra = chiphi.TongCongNo;
                #endregion
                #region mien giam
                //mien giam theo uu dai
                var uuDai = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.DoiTuongUuDaiId != null && o.TiLe != 0);
                var mienGiamChiPhiTruoc = ycTiepNhan.MienGiamChiPhis.Where(o => o.YeuCauDichVuKyThuatId == yc.Id).ToList();
                var mienGiamTheoUuDaiGroups = mienGiamChiPhiTruoc.Where(o => o.DoiTuongUuDaiId != null).GroupBy(o => o.DoiTuongUuDaiId.Value);
                bool daMienGiamUuDai = false;
                foreach (var mienGiamTheoUuDaiGroup in mienGiamTheoUuDaiGroups)
                {
                    if (mienGiamTheoUuDaiGroup.Key != uuDai?.DoiTuongUuDaiId)
                    {
                        yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                        {
                            TaiKhoanBenhNhanThu = thuPhi,
                            YeuCauTiepNhanId = ycTiepNhan.Id,
                            LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                            DoiTuongUuDaiId = mienGiamTheoUuDaiGroup.Key,
                            LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                            TiLe = 0 - mienGiamTheoUuDaiGroup.Sum(o => o.TiLe.GetValueOrDefault()),
                            SoTien = 0 - mienGiamTheoUuDaiGroup.Sum(o => o.SoTien)
                        });
                    }
                    else
                    {
                        daMienGiamUuDai = true;
                        if (uuDai.TiLe.GetValueOrDefault() != mienGiamTheoUuDaiGroup.Sum(o => o.TiLe.GetValueOrDefault()) || !uuDai.SoTien.AlmostEqual(mienGiamTheoUuDaiGroup.Sum(o => o.SoTien)))
                        {
                            yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                            {
                                TaiKhoanBenhNhanThu = thuPhi,
                                YeuCauTiepNhanId = ycTiepNhan.Id,
                                LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                                DoiTuongUuDaiId = mienGiamTheoUuDaiGroup.Key,
                                LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                                TiLe = uuDai.TiLe.GetValueOrDefault() - mienGiamTheoUuDaiGroup.Sum(o => o.TiLe.GetValueOrDefault()),
                                SoTien = uuDai.SoTien - mienGiamTheoUuDaiGroup.Sum(o => o.SoTien)
                            });
                        }
                    }
                }
                if (!daMienGiamUuDai && uuDai != null)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                        DoiTuongUuDaiId = uuDai.DoiTuongUuDaiId,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                        TiLe = uuDai.TiLe.GetValueOrDefault(),
                        SoTien = uuDai.SoTien
                    });
                }

                //mien giam theo voucher
                var vouchers = chiphi.DanhSachMienGiamVos.Where(o => o.TheVoucherId != null).ToList();
                var mienGiamTheoVoucherGroups = mienGiamChiPhiTruoc.Where(o => o.TheVoucherId != null).GroupBy(o => o.TheVoucherId.Value).ToList();

                foreach (var mienGiamTheoVoucherGroup in mienGiamTheoVoucherGroups)
                {
                    if (!vouchers.Select(o => o.TheVoucherId).Contains(mienGiamTheoVoucherGroup.Key))
                    {
                        yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                        {
                            TaiKhoanBenhNhanThu = thuPhi,
                            YeuCauTiepNhanId = ycTiepNhan.Id,
                            LoaiMienGiam = Enums.LoaiMienGiam.Voucher,
                            TheVoucherId = mienGiamTheoVoucherGroup.Key,
                            LoaiChietKhau = mienGiamTheoVoucherGroup.First().LoaiChietKhau,
                            MaTheVoucher = mienGiamTheoVoucherGroup.First().MaTheVoucher,
                            TiLe = 0 - mienGiamTheoVoucherGroup.Sum(o => o.TiLe.GetValueOrDefault()),
                            SoTien = 0 - mienGiamTheoVoucherGroup.Sum(o => o.SoTien)
                        });
                    }
                }

                foreach (var voucher in vouchers)
                {
                    var mienGiamTheoVoucherGroup = mienGiamTheoVoucherGroups.FirstOrDefault(o => o.Key == voucher.TheVoucherId);
                    if (mienGiamTheoVoucherGroup != null)
                    {
                        if (voucher.TiLe.GetValueOrDefault() != mienGiamTheoVoucherGroup.Sum(o => o.TiLe.GetValueOrDefault()) || !voucher.SoTien.AlmostEqual(mienGiamTheoVoucherGroup.Sum(o => o.SoTien)))
                        {
                            yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                            {
                                TaiKhoanBenhNhanThu = thuPhi,
                                YeuCauTiepNhanId = ycTiepNhan.Id,
                                LoaiMienGiam = Enums.LoaiMienGiam.Voucher,
                                TheVoucherId = voucher.TheVoucherId,
                                LoaiChietKhau = voucher.LoaiChietKhau,
                                MaTheVoucher = voucher.MaTheVoucher,
                                TiLe = voucher.TiLe.GetValueOrDefault() - mienGiamTheoVoucherGroup.Sum(o => o.TiLe.GetValueOrDefault()),
                                SoTien = voucher.SoTien - mienGiamTheoVoucherGroup.Sum(o => o.SoTien)
                            });
                        }
                    }
                    else
                    {
                        yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                        {
                            TaiKhoanBenhNhanThu = thuPhi,
                            YeuCauTiepNhanId = ycTiepNhan.Id,
                            LoaiMienGiam = Enums.LoaiMienGiam.Voucher,
                            TheVoucherId = voucher.TheVoucherId,
                            LoaiChietKhau = voucher.LoaiChietKhau,
                            MaTheVoucher = voucher.MaTheVoucher,
                            TiLe = voucher.TiLe.GetValueOrDefault(),
                            SoTien = voucher.SoTien
                        });
                    }
                }

                //mien giam them theo ti le
                var mienGiamThemTiLeTruoc = mienGiamChiPhiTruoc.Where(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoTiLe).ToList();
                var mienGiamThemTiLe = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoTiLe);
                if (mienGiamThemTiLeTruoc.Any())
                {
                    if (mienGiamThemTiLe == null ||
                        (mienGiamThemTiLe.TiLe.GetValueOrDefault() != mienGiamThemTiLeTruoc.Sum(o => o.TiLe.GetValueOrDefault()) || !mienGiamThemTiLe.SoTien.AlmostEqual(mienGiamThemTiLeTruoc.Sum(o => o.SoTien))))
                    {
                        yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                        {
                            TaiKhoanBenhNhanThu = thuPhi,
                            YeuCauTiepNhanId = ycTiepNhan.Id,
                            LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                            LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                            TiLe = (mienGiamThemTiLe?.TiLe ?? 0) - mienGiamThemTiLeTruoc.Sum(o => o.TiLe.GetValueOrDefault()),
                            SoTien = (mienGiamThemTiLe?.SoTien ?? 0) - mienGiamThemTiLeTruoc.Sum(o => o.SoTien)
                        });
                    }
                }
                else if (mienGiamThemTiLe != null && mienGiamThemTiLe.TiLe.GetValueOrDefault() != 0)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                        TiLe = mienGiamThemTiLe.TiLe,
                        SoTien = mienGiamThemTiLe.SoTien
                    });
                }

                //mien giam them theo so tien
                var mienGiamThemSoTienTruoc = mienGiamChiPhiTruoc.Where(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoSoTien).ToList();
                var mienGiamThemSoTien = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoSoTien);
                if (mienGiamThemSoTienTruoc.Any())
                {
                    if (mienGiamThemSoTien == null || !mienGiamThemSoTien.SoTien.AlmostEqual(mienGiamThemSoTienTruoc.Sum(o => o.SoTien)))
                    {
                        yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                        {
                            TaiKhoanBenhNhanThu = thuPhi,
                            YeuCauTiepNhanId = ycTiepNhan.Id,
                            LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                            LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoSoTien,
                            SoTien = (mienGiamThemSoTien?.SoTien ?? 0) - mienGiamThemSoTienTruoc.Sum(o => o.SoTien)
                        });
                    }
                }
                else if (mienGiamThemSoTien != null && !mienGiamThemSoTien.SoTien.AlmostEqual(0))
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoSoTien,
                        SoTien = mienGiamThemSoTien.SoTien
                    });
                }
                yc.SoTienMienGiam = chiphi.SoTienMG;

                if ((mienGiamThemTiLe?.SoTien ?? 0).AlmostEqual(0) && (mienGiamThemSoTien?.SoTien ?? 0).AlmostEqual(0))
                {
                    yc.GhiChuMienGiamThem = null;
                }
                else
                {
                    yc.GhiChuMienGiamThem = chiphi.GhiChuMienGiamThem;
                }
                #endregion
                yc.SoTienBenhNhanDaChi = yc.SoTienBenhNhanDaChi.GetValueOrDefault() + chiphi.BNConPhaiThanhToan;
                yc.TrangThaiThanhToan = Enums.TrangThaiThanhToan.DaThanhToan;
                thuPhi.TaiKhoanBenhNhanChis.Add(new TaiKhoanBenhNhanChi
                {
                    TaiKhoanBenhNhan = tk,
                    LoaiChiTienBenhNhan = Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi,
                    TienChiPhi = chiphi.BNConPhaiThanhToan,
                    NoiDungChi = Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi.GetDescription(),
                    NgayChi = DateTime.Now,
                    SoQuyen = 1,
                    YeuCauDichVuKyThuat = yc,
                    YeuCauTiepNhanId = ycTiepNhan.Id,
                    NhanVienThucHienId = _userAgentHelper.GetCurrentUserId(),
                    NoiThucHienId = _userAgentHelper.GetCurrentNoiLLamViecId()
                });
            }

            foreach (var chiphi in dsChiPhiDaChon.Where(o => o.LoaiNhom == NhomChiPhiKhamChuaBenh.DichVuGiuong))
            {
                var yc = ycTiepNhan.YeuCauDichVuGiuongBenhViens.First(o => o.Id == chiphi.Id);
                #region cap nhat cong no va mien giam
                //them cong no
                if (chiphi.TongCongNo > 0)
                {
                    foreach (var chiphiDanhSachCongNoChoThu in chiphi.DanhSachCongNoChoThus)
                    {
                        var congNoTruoc = yc.CongTyBaoHiemTuNhanCongNos.Where(o =>
                                o.CongTyBaoHiemTuNhanId == chiphiDanhSachCongNoChoThu.CongTyBaoHiemTuNhanId)
                            .Sum(o => o.SoTien);
                        if (!congNoTruoc.AlmostEqual(chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu))
                        {
                            yc.CongTyBaoHiemTuNhanCongNos.Add(new CongTyBaoHiemTuNhanCongNo
                            {
                                TaiKhoanBenhNhanThu = thuPhi,
                                CongTyBaoHiemTuNhanId = chiphiDanhSachCongNoChoThu.CongTyBaoHiemTuNhanId,
                                SoTien = chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu - congNoTruoc
                            });
                        }
                    }
                }
                else if (!yc.CongTyBaoHiemTuNhanCongNos.Sum(o => o.SoTien).AlmostEqual(0))
                {
                    foreach (var ycCongTyBaoHiemTuNhanCongNo in yc.CongTyBaoHiemTuNhanCongNos.Where(o => o.CreatedOn != null))
                    {
                        yc.CongTyBaoHiemTuNhanCongNos.Add(new CongTyBaoHiemTuNhanCongNo
                        {
                            TaiKhoanBenhNhanThu = thuPhi,
                            CongTyBaoHiemTuNhanId = ycCongTyBaoHiemTuNhanCongNo.CongTyBaoHiemTuNhanId,
                            SoTien = ycCongTyBaoHiemTuNhanCongNo.SoTien * (-1)
                        });
                    }
                }
                yc.SoTienBaoHiemTuNhanChiTra = chiphi.TongCongNo;
                #endregion
                #region mien giam
                //mien giam theo uu dai
                var uuDai = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.DoiTuongUuDaiId != null && o.TiLe != 0);
                var mienGiamChiPhiTruoc = ycTiepNhan.MienGiamChiPhis.Where(o => o.YeuCauDichVuGiuongBenhVienId == yc.Id).ToList();
                var mienGiamTheoUuDaiGroups = mienGiamChiPhiTruoc.Where(o => o.DoiTuongUuDaiId != null).GroupBy(o => o.DoiTuongUuDaiId.Value);
                bool daMienGiamUuDai = false;
                foreach (var mienGiamTheoUuDaiGroup in mienGiamTheoUuDaiGroups)
                {
                    if (mienGiamTheoUuDaiGroup.Key != uuDai?.DoiTuongUuDaiId)
                    {
                        yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                        {
                            TaiKhoanBenhNhanThu = thuPhi,
                            YeuCauTiepNhanId = ycTiepNhan.Id,
                            LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                            DoiTuongUuDaiId = mienGiamTheoUuDaiGroup.Key,
                            LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                            TiLe = 0 - mienGiamTheoUuDaiGroup.Sum(o => o.TiLe.GetValueOrDefault()),
                            SoTien = 0 - mienGiamTheoUuDaiGroup.Sum(o => o.SoTien)
                        });
                    }
                    else
                    {
                        daMienGiamUuDai = true;
                        if (uuDai.TiLe.GetValueOrDefault() != mienGiamTheoUuDaiGroup.Sum(o => o.TiLe.GetValueOrDefault()) || !uuDai.SoTien.AlmostEqual(mienGiamTheoUuDaiGroup.Sum(o => o.SoTien)))
                        {
                            yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                            {
                                TaiKhoanBenhNhanThu = thuPhi,
                                YeuCauTiepNhanId = ycTiepNhan.Id,
                                LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                                DoiTuongUuDaiId = mienGiamTheoUuDaiGroup.Key,
                                LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                                TiLe = uuDai.TiLe.GetValueOrDefault() - mienGiamTheoUuDaiGroup.Sum(o => o.TiLe.GetValueOrDefault()),
                                SoTien = uuDai.SoTien - mienGiamTheoUuDaiGroup.Sum(o => o.SoTien)
                            });
                        }
                    }
                }
                if (!daMienGiamUuDai && uuDai != null)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                        DoiTuongUuDaiId = uuDai.DoiTuongUuDaiId,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                        TiLe = uuDai.TiLe.GetValueOrDefault(),
                        SoTien = uuDai.SoTien
                    });
                }

                //mien giam theo voucher
                var vouchers = chiphi.DanhSachMienGiamVos.Where(o => o.TheVoucherId != null).ToList();
                var mienGiamTheoVoucherGroups = mienGiamChiPhiTruoc.Where(o => o.TheVoucherId != null).GroupBy(o => o.TheVoucherId.Value).ToList();

                foreach (var mienGiamTheoVoucherGroup in mienGiamTheoVoucherGroups)
                {
                    if (!vouchers.Select(o => o.TheVoucherId).Contains(mienGiamTheoVoucherGroup.Key))
                    {
                        yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                        {
                            TaiKhoanBenhNhanThu = thuPhi,
                            YeuCauTiepNhanId = ycTiepNhan.Id,
                            LoaiMienGiam = Enums.LoaiMienGiam.Voucher,
                            TheVoucherId = mienGiamTheoVoucherGroup.Key,
                            LoaiChietKhau = mienGiamTheoVoucherGroup.First().LoaiChietKhau,
                            MaTheVoucher = mienGiamTheoVoucherGroup.First().MaTheVoucher,
                            TiLe = 0 - mienGiamTheoVoucherGroup.Sum(o => o.TiLe.GetValueOrDefault()),
                            SoTien = 0 - mienGiamTheoVoucherGroup.Sum(o => o.SoTien)
                        });
                    }
                }

                foreach (var voucher in vouchers)
                {
                    var mienGiamTheoVoucherGroup = mienGiamTheoVoucherGroups.FirstOrDefault(o => o.Key == voucher.TheVoucherId);
                    if (mienGiamTheoVoucherGroup != null)
                    {
                        if (voucher.TiLe.GetValueOrDefault() != mienGiamTheoVoucherGroup.Sum(o => o.TiLe.GetValueOrDefault()) || !voucher.SoTien.AlmostEqual(mienGiamTheoVoucherGroup.Sum(o => o.SoTien)))
                        {
                            yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                            {
                                TaiKhoanBenhNhanThu = thuPhi,
                                YeuCauTiepNhanId = ycTiepNhan.Id,
                                LoaiMienGiam = Enums.LoaiMienGiam.Voucher,
                                TheVoucherId = voucher.TheVoucherId,
                                LoaiChietKhau = voucher.LoaiChietKhau,
                                MaTheVoucher = voucher.MaTheVoucher,
                                TiLe = voucher.TiLe.GetValueOrDefault() - mienGiamTheoVoucherGroup.Sum(o => o.TiLe.GetValueOrDefault()),
                                SoTien = voucher.SoTien - mienGiamTheoVoucherGroup.Sum(o => o.SoTien)
                            });
                        }
                    }
                    else
                    {
                        yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                        {
                            TaiKhoanBenhNhanThu = thuPhi,
                            YeuCauTiepNhanId = ycTiepNhan.Id,
                            LoaiMienGiam = Enums.LoaiMienGiam.Voucher,
                            TheVoucherId = voucher.TheVoucherId,
                            LoaiChietKhau = voucher.LoaiChietKhau,
                            MaTheVoucher = voucher.MaTheVoucher,
                            TiLe = voucher.TiLe.GetValueOrDefault(),
                            SoTien = voucher.SoTien
                        });
                    }
                }

                //mien giam them theo ti le
                var mienGiamThemTiLeTruoc = mienGiamChiPhiTruoc.Where(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoTiLe).ToList();
                var mienGiamThemTiLe = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoTiLe);
                if (mienGiamThemTiLeTruoc.Any())
                {
                    if (mienGiamThemTiLe == null ||
                        (mienGiamThemTiLe.TiLe.GetValueOrDefault() != mienGiamThemTiLeTruoc.Sum(o => o.TiLe.GetValueOrDefault()) || !mienGiamThemTiLe.SoTien.AlmostEqual(mienGiamThemTiLeTruoc.Sum(o => o.SoTien))))
                    {
                        yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                        {
                            TaiKhoanBenhNhanThu = thuPhi,
                            YeuCauTiepNhanId = ycTiepNhan.Id,
                            LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                            LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                            TiLe = (mienGiamThemTiLe?.TiLe ?? 0) - mienGiamThemTiLeTruoc.Sum(o => o.TiLe.GetValueOrDefault()),
                            SoTien = (mienGiamThemTiLe?.SoTien ?? 0) - mienGiamThemTiLeTruoc.Sum(o => o.SoTien)
                        });
                    }
                }
                else if (mienGiamThemTiLe != null && mienGiamThemTiLe.TiLe.GetValueOrDefault() != 0)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                        TiLe = mienGiamThemTiLe.TiLe,
                        SoTien = mienGiamThemTiLe.SoTien
                    });
                }

                //mien giam them theo so tien
                var mienGiamThemSoTienTruoc = mienGiamChiPhiTruoc.Where(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoSoTien).ToList();
                var mienGiamThemSoTien = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoSoTien);
                if (mienGiamThemSoTienTruoc.Any())
                {
                    if (mienGiamThemSoTien == null || !mienGiamThemSoTien.SoTien.AlmostEqual(mienGiamThemSoTienTruoc.Sum(o => o.SoTien)))
                    {
                        yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                        {
                            TaiKhoanBenhNhanThu = thuPhi,
                            YeuCauTiepNhanId = ycTiepNhan.Id,
                            LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                            LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoSoTien,
                            SoTien = (mienGiamThemSoTien?.SoTien ?? 0) - mienGiamThemSoTienTruoc.Sum(o => o.SoTien)
                        });
                    }
                }
                else if (mienGiamThemSoTien != null && !mienGiamThemSoTien.SoTien.AlmostEqual(0))
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoSoTien,
                        SoTien = mienGiamThemSoTien.SoTien
                    });
                }
                yc.SoTienMienGiam = chiphi.SoTienMG;

                if ((mienGiamThemTiLe?.SoTien ?? 0).AlmostEqual(0) && (mienGiamThemSoTien?.SoTien ?? 0).AlmostEqual(0))
                {
                    yc.GhiChuMienGiamThem = null;
                }
                else
                {
                    yc.GhiChuMienGiamThem = chiphi.GhiChuMienGiamThem;
                }
                #endregion
                yc.SoTienBenhNhanDaChi = yc.SoTienBenhNhanDaChi.GetValueOrDefault() + chiphi.BNConPhaiThanhToan;
                yc.TrangThaiThanhToan = Enums.TrangThaiThanhToan.DaThanhToan;
                thuPhi.TaiKhoanBenhNhanChis.Add(new TaiKhoanBenhNhanChi
                {
                    TaiKhoanBenhNhan = tk,
                    LoaiChiTienBenhNhan = Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi,
                    TienChiPhi = chiphi.BNConPhaiThanhToan,
                    NoiDungChi = Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi.GetDescription(),
                    NgayChi = DateTime.Now,
                    SoQuyen = 1,
                    YeuCauDichVuGiuongBenhVien = yc,
                    YeuCauTiepNhanId = ycTiepNhan.Id,
                    NhanVienThucHienId = _userAgentHelper.GetCurrentUserId(),
                    NoiThucHienId = _userAgentHelper.GetCurrentNoiLLamViecId()
                });
            }

            foreach (var chiphi in dsChiPhiDaChon.Where(o => o.LoaiNhom == NhomChiPhiKhamChuaBenh.DuocPham))
            {
                var yc = ycTiepNhan.YeuCauDuocPhamBenhViens.First(o => o.Id == chiphi.Id);
                #region cap nhat cong no va mien giam
                //them cong no
                if (chiphi.TongCongNo > 0)
                {
                    foreach (var chiphiDanhSachCongNoChoThu in chiphi.DanhSachCongNoChoThus)
                    {
                        var congNoTruoc = yc.CongTyBaoHiemTuNhanCongNos.Where(o =>
                                o.CongTyBaoHiemTuNhanId == chiphiDanhSachCongNoChoThu.CongTyBaoHiemTuNhanId)
                            .Sum(o => o.SoTien);
                        if (!congNoTruoc.AlmostEqual(chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu))
                        {
                            yc.CongTyBaoHiemTuNhanCongNos.Add(new CongTyBaoHiemTuNhanCongNo
                            {
                                TaiKhoanBenhNhanThu = thuPhi,
                                CongTyBaoHiemTuNhanId = chiphiDanhSachCongNoChoThu.CongTyBaoHiemTuNhanId,
                                SoTien = chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu - congNoTruoc
                            });
                        }
                    }
                }
                else if (!yc.CongTyBaoHiemTuNhanCongNos.Sum(o => o.SoTien).AlmostEqual(0))
                {
                    foreach (var ycCongTyBaoHiemTuNhanCongNo in yc.CongTyBaoHiemTuNhanCongNos.Where(o => o.CreatedOn != null))
                    {
                        yc.CongTyBaoHiemTuNhanCongNos.Add(new CongTyBaoHiemTuNhanCongNo
                        {
                            TaiKhoanBenhNhanThu = thuPhi,
                            CongTyBaoHiemTuNhanId = ycCongTyBaoHiemTuNhanCongNo.CongTyBaoHiemTuNhanId,
                            SoTien = ycCongTyBaoHiemTuNhanCongNo.SoTien * (-1)
                        });
                    }
                }
                yc.SoTienBaoHiemTuNhanChiTra = chiphi.TongCongNo;
                #endregion
                #region mien giam
                //mien giam theo uu dai
                var uuDai = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.DoiTuongUuDaiId != null && o.TiLe != 0);
                var mienGiamChiPhiTruoc = ycTiepNhan.MienGiamChiPhis.Where(o => o.YeuCauDuocPhamBenhVienId == yc.Id).ToList();
                var mienGiamTheoUuDaiGroups = mienGiamChiPhiTruoc.Where(o => o.DoiTuongUuDaiId != null).GroupBy(o => o.DoiTuongUuDaiId.Value);
                bool daMienGiamUuDai = false;
                foreach (var mienGiamTheoUuDaiGroup in mienGiamTheoUuDaiGroups)
                {
                    if (mienGiamTheoUuDaiGroup.Key != uuDai?.DoiTuongUuDaiId)
                    {
                        yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                        {
                            TaiKhoanBenhNhanThu = thuPhi,
                            YeuCauTiepNhanId = ycTiepNhan.Id,
                            LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                            DoiTuongUuDaiId = mienGiamTheoUuDaiGroup.Key,
                            LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                            TiLe = 0 - mienGiamTheoUuDaiGroup.Sum(o => o.TiLe.GetValueOrDefault()),
                            SoTien = 0 - mienGiamTheoUuDaiGroup.Sum(o => o.SoTien)
                        });
                    }
                    else
                    {
                        daMienGiamUuDai = true;
                        if (uuDai.TiLe.GetValueOrDefault() != mienGiamTheoUuDaiGroup.Sum(o => o.TiLe.GetValueOrDefault()) || !uuDai.SoTien.AlmostEqual(mienGiamTheoUuDaiGroup.Sum(o => o.SoTien)))
                        {
                            yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                            {
                                TaiKhoanBenhNhanThu = thuPhi,
                                YeuCauTiepNhanId = ycTiepNhan.Id,
                                LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                                DoiTuongUuDaiId = mienGiamTheoUuDaiGroup.Key,
                                LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                                TiLe = uuDai.TiLe.GetValueOrDefault() - mienGiamTheoUuDaiGroup.Sum(o => o.TiLe.GetValueOrDefault()),
                                SoTien = uuDai.SoTien - mienGiamTheoUuDaiGroup.Sum(o => o.SoTien)
                            });
                        }
                    }
                }
                if (!daMienGiamUuDai && uuDai != null)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                        DoiTuongUuDaiId = uuDai.DoiTuongUuDaiId,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                        TiLe = uuDai.TiLe.GetValueOrDefault(),
                        SoTien = uuDai.SoTien
                    });
                }

                //mien giam theo voucher
                var vouchers = chiphi.DanhSachMienGiamVos.Where(o => o.TheVoucherId != null).ToList();
                var mienGiamTheoVoucherGroups = mienGiamChiPhiTruoc.Where(o => o.TheVoucherId != null).GroupBy(o => o.TheVoucherId.Value).ToList();

                foreach (var mienGiamTheoVoucherGroup in mienGiamTheoVoucherGroups)
                {
                    if (!vouchers.Select(o => o.TheVoucherId).Contains(mienGiamTheoVoucherGroup.Key))
                    {
                        yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                        {
                            TaiKhoanBenhNhanThu = thuPhi,
                            YeuCauTiepNhanId = ycTiepNhan.Id,
                            LoaiMienGiam = Enums.LoaiMienGiam.Voucher,
                            TheVoucherId = mienGiamTheoVoucherGroup.Key,
                            LoaiChietKhau = mienGiamTheoVoucherGroup.First().LoaiChietKhau,
                            MaTheVoucher = mienGiamTheoVoucherGroup.First().MaTheVoucher,
                            TiLe = 0 - mienGiamTheoVoucherGroup.Sum(o => o.TiLe.GetValueOrDefault()),
                            SoTien = 0 - mienGiamTheoVoucherGroup.Sum(o => o.SoTien)
                        });
                    }
                }

                foreach (var voucher in vouchers)
                {
                    var mienGiamTheoVoucherGroup = mienGiamTheoVoucherGroups.FirstOrDefault(o => o.Key == voucher.TheVoucherId);
                    if (mienGiamTheoVoucherGroup != null)
                    {
                        if (voucher.TiLe.GetValueOrDefault() != mienGiamTheoVoucherGroup.Sum(o => o.TiLe.GetValueOrDefault()) || !voucher.SoTien.AlmostEqual(mienGiamTheoVoucherGroup.Sum(o => o.SoTien)))
                        {
                            yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                            {
                                TaiKhoanBenhNhanThu = thuPhi,
                                YeuCauTiepNhanId = ycTiepNhan.Id,
                                LoaiMienGiam = Enums.LoaiMienGiam.Voucher,
                                TheVoucherId = voucher.TheVoucherId,
                                LoaiChietKhau = voucher.LoaiChietKhau,
                                MaTheVoucher = voucher.MaTheVoucher,
                                TiLe = voucher.TiLe.GetValueOrDefault() - mienGiamTheoVoucherGroup.Sum(o => o.TiLe.GetValueOrDefault()),
                                SoTien = voucher.SoTien - mienGiamTheoVoucherGroup.Sum(o => o.SoTien)
                            });
                        }
                    }
                    else
                    {
                        yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                        {
                            TaiKhoanBenhNhanThu = thuPhi,
                            YeuCauTiepNhanId = ycTiepNhan.Id,
                            LoaiMienGiam = Enums.LoaiMienGiam.Voucher,
                            TheVoucherId = voucher.TheVoucherId,
                            LoaiChietKhau = voucher.LoaiChietKhau,
                            MaTheVoucher = voucher.MaTheVoucher,
                            TiLe = voucher.TiLe.GetValueOrDefault(),
                            SoTien = voucher.SoTien
                        });
                    }
                }

                //mien giam them theo ti le
                var mienGiamThemTiLeTruoc = mienGiamChiPhiTruoc.Where(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoTiLe).ToList();
                var mienGiamThemTiLe = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoTiLe);
                if (mienGiamThemTiLeTruoc.Any())
                {
                    if (mienGiamThemTiLe == null ||
                        (mienGiamThemTiLe.TiLe.GetValueOrDefault() != mienGiamThemTiLeTruoc.Sum(o => o.TiLe.GetValueOrDefault()) || !mienGiamThemTiLe.SoTien.AlmostEqual(mienGiamThemTiLeTruoc.Sum(o => o.SoTien))))
                    {
                        yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                        {
                            TaiKhoanBenhNhanThu = thuPhi,
                            YeuCauTiepNhanId = ycTiepNhan.Id,
                            LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                            LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                            TiLe = (mienGiamThemTiLe?.TiLe ?? 0) - mienGiamThemTiLeTruoc.Sum(o => o.TiLe.GetValueOrDefault()),
                            SoTien = (mienGiamThemTiLe?.SoTien ?? 0) - mienGiamThemTiLeTruoc.Sum(o => o.SoTien)
                        });
                    }
                }
                else if (mienGiamThemTiLe != null && mienGiamThemTiLe.TiLe.GetValueOrDefault() != 0)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                        TiLe = mienGiamThemTiLe.TiLe,
                        SoTien = mienGiamThemTiLe.SoTien
                    });
                }

                //mien giam them theo so tien
                var mienGiamThemSoTienTruoc = mienGiamChiPhiTruoc.Where(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoSoTien).ToList();
                var mienGiamThemSoTien = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoSoTien);
                if (mienGiamThemSoTienTruoc.Any())
                {
                    if (mienGiamThemSoTien == null || !mienGiamThemSoTien.SoTien.AlmostEqual(mienGiamThemSoTienTruoc.Sum(o => o.SoTien)))
                    {
                        yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                        {
                            TaiKhoanBenhNhanThu = thuPhi,
                            YeuCauTiepNhanId = ycTiepNhan.Id,
                            LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                            LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoSoTien,
                            SoTien = (mienGiamThemSoTien?.SoTien ?? 0) - mienGiamThemSoTienTruoc.Sum(o => o.SoTien)
                        });
                    }
                }
                else if (mienGiamThemSoTien != null && !mienGiamThemSoTien.SoTien.AlmostEqual(0))
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoSoTien,
                        SoTien = mienGiamThemSoTien.SoTien
                    });
                }
                yc.SoTienMienGiam = chiphi.SoTienMG;

                if ((mienGiamThemTiLe?.SoTien ?? 0).AlmostEqual(0) && (mienGiamThemSoTien?.SoTien ?? 0).AlmostEqual(0))
                {
                    yc.GhiChuMienGiamThem = null;
                }
                else
                {
                    yc.GhiChuMienGiamThem = chiphi.GhiChuMienGiamThem;
                }
                #endregion
                yc.SoTienBenhNhanDaChi = yc.SoTienBenhNhanDaChi.GetValueOrDefault() + chiphi.BNConPhaiThanhToan;
                yc.TrangThaiThanhToan = Enums.TrangThaiThanhToan.DaThanhToan;
                thuPhi.TaiKhoanBenhNhanChis.Add(new TaiKhoanBenhNhanChi
                {
                    TaiKhoanBenhNhan = tk,
                    LoaiChiTienBenhNhan = Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi,
                    TienChiPhi = chiphi.BNConPhaiThanhToan,
                    NoiDungChi = Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi.GetDescription(),
                    NgayChi = DateTime.Now,
                    SoQuyen = 1,
                    YeuCauDuocPhamBenhVien = yc,
                    YeuCauTiepNhanId = ycTiepNhan.Id,
                    NhanVienThucHienId = _userAgentHelper.GetCurrentUserId(),
                    NoiThucHienId = _userAgentHelper.GetCurrentNoiLLamViecId()
                });
            }

            foreach (var chiphi in dsChiPhiDaChon.Where(o => o.LoaiNhom == NhomChiPhiKhamChuaBenh.VatTuTieuHao))
            {
                var yc = ycTiepNhan.YeuCauVatTuBenhViens.First(o => o.Id == chiphi.Id);
                #region cap nhat cong no va mien giam
                //them cong no
                if (chiphi.TongCongNo > 0)
                {
                    foreach (var chiphiDanhSachCongNoChoThu in chiphi.DanhSachCongNoChoThus)
                    {
                        var congNoTruoc = yc.CongTyBaoHiemTuNhanCongNos.Where(o =>
                                o.CongTyBaoHiemTuNhanId == chiphiDanhSachCongNoChoThu.CongTyBaoHiemTuNhanId)
                            .Sum(o => o.SoTien);
                        if (!congNoTruoc.AlmostEqual(chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu))
                        {
                            yc.CongTyBaoHiemTuNhanCongNos.Add(new CongTyBaoHiemTuNhanCongNo
                            {
                                TaiKhoanBenhNhanThu = thuPhi,
                                CongTyBaoHiemTuNhanId = chiphiDanhSachCongNoChoThu.CongTyBaoHiemTuNhanId,
                                SoTien = chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu - congNoTruoc
                            });
                        }
                    }
                }
                else if (!yc.CongTyBaoHiemTuNhanCongNos.Sum(o => o.SoTien).AlmostEqual(0))
                {
                    foreach (var ycCongTyBaoHiemTuNhanCongNo in yc.CongTyBaoHiemTuNhanCongNos.Where(o => o.CreatedOn != null))
                    {
                        yc.CongTyBaoHiemTuNhanCongNos.Add(new CongTyBaoHiemTuNhanCongNo
                        {
                            TaiKhoanBenhNhanThu = thuPhi,
                            CongTyBaoHiemTuNhanId = ycCongTyBaoHiemTuNhanCongNo.CongTyBaoHiemTuNhanId,
                            SoTien = ycCongTyBaoHiemTuNhanCongNo.SoTien * (-1)
                        });
                    }
                }
                yc.SoTienBaoHiemTuNhanChiTra = chiphi.TongCongNo;
                #endregion
                #region mien giam
                //mien giam theo uu dai
                var uuDai = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.DoiTuongUuDaiId != null && o.TiLe != 0);
                var mienGiamChiPhiTruoc = ycTiepNhan.MienGiamChiPhis.Where(o => o.YeuCauVatTuBenhVienId == yc.Id).ToList();
                var mienGiamTheoUuDaiGroups = mienGiamChiPhiTruoc.Where(o => o.DoiTuongUuDaiId != null).GroupBy(o => o.DoiTuongUuDaiId.Value);
                bool daMienGiamUuDai = false;
                foreach (var mienGiamTheoUuDaiGroup in mienGiamTheoUuDaiGroups)
                {
                    if (mienGiamTheoUuDaiGroup.Key != uuDai?.DoiTuongUuDaiId)
                    {
                        yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                        {
                            TaiKhoanBenhNhanThu = thuPhi,
                            YeuCauTiepNhanId = ycTiepNhan.Id,
                            LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                            DoiTuongUuDaiId = mienGiamTheoUuDaiGroup.Key,
                            LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                            TiLe = 0 - mienGiamTheoUuDaiGroup.Sum(o => o.TiLe.GetValueOrDefault()),
                            SoTien = 0 - mienGiamTheoUuDaiGroup.Sum(o => o.SoTien)
                        });
                    }
                    else
                    {
                        daMienGiamUuDai = true;
                        if (uuDai.TiLe.GetValueOrDefault() != mienGiamTheoUuDaiGroup.Sum(o => o.TiLe.GetValueOrDefault()) || !uuDai.SoTien.AlmostEqual(mienGiamTheoUuDaiGroup.Sum(o => o.SoTien)))
                        {
                            yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                            {
                                TaiKhoanBenhNhanThu = thuPhi,
                                YeuCauTiepNhanId = ycTiepNhan.Id,
                                LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                                DoiTuongUuDaiId = mienGiamTheoUuDaiGroup.Key,
                                LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                                TiLe = uuDai.TiLe.GetValueOrDefault() - mienGiamTheoUuDaiGroup.Sum(o => o.TiLe.GetValueOrDefault()),
                                SoTien = uuDai.SoTien - mienGiamTheoUuDaiGroup.Sum(o => o.SoTien)
                            });
                        }
                    }
                }
                if (!daMienGiamUuDai && uuDai != null)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                        DoiTuongUuDaiId = uuDai.DoiTuongUuDaiId,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                        TiLe = uuDai.TiLe.GetValueOrDefault(),
                        SoTien = uuDai.SoTien
                    });
                }

                //mien giam theo voucher
                var vouchers = chiphi.DanhSachMienGiamVos.Where(o => o.TheVoucherId != null).ToList();
                var mienGiamTheoVoucherGroups = mienGiamChiPhiTruoc.Where(o => o.TheVoucherId != null).GroupBy(o => o.TheVoucherId.Value).ToList();

                foreach (var mienGiamTheoVoucherGroup in mienGiamTheoVoucherGroups)
                {
                    if (!vouchers.Select(o => o.TheVoucherId).Contains(mienGiamTheoVoucherGroup.Key))
                    {
                        yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                        {
                            TaiKhoanBenhNhanThu = thuPhi,
                            YeuCauTiepNhanId = ycTiepNhan.Id,
                            LoaiMienGiam = Enums.LoaiMienGiam.Voucher,
                            TheVoucherId = mienGiamTheoVoucherGroup.Key,
                            LoaiChietKhau = mienGiamTheoVoucherGroup.First().LoaiChietKhau,
                            MaTheVoucher = mienGiamTheoVoucherGroup.First().MaTheVoucher,
                            TiLe = 0 - mienGiamTheoVoucherGroup.Sum(o => o.TiLe.GetValueOrDefault()),
                            SoTien = 0 - mienGiamTheoVoucherGroup.Sum(o => o.SoTien)
                        });
                    }
                }

                foreach (var voucher in vouchers)
                {
                    var mienGiamTheoVoucherGroup = mienGiamTheoVoucherGroups.FirstOrDefault(o => o.Key == voucher.TheVoucherId);
                    if (mienGiamTheoVoucherGroup != null)
                    {
                        if (voucher.TiLe.GetValueOrDefault() != mienGiamTheoVoucherGroup.Sum(o => o.TiLe.GetValueOrDefault()) || !voucher.SoTien.AlmostEqual(mienGiamTheoVoucherGroup.Sum(o => o.SoTien)))
                        {
                            yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                            {
                                TaiKhoanBenhNhanThu = thuPhi,
                                YeuCauTiepNhanId = ycTiepNhan.Id,
                                LoaiMienGiam = Enums.LoaiMienGiam.Voucher,
                                TheVoucherId = voucher.TheVoucherId,
                                LoaiChietKhau = voucher.LoaiChietKhau,
                                MaTheVoucher = voucher.MaTheVoucher,
                                TiLe = voucher.TiLe.GetValueOrDefault() - mienGiamTheoVoucherGroup.Sum(o => o.TiLe.GetValueOrDefault()),
                                SoTien = voucher.SoTien - mienGiamTheoVoucherGroup.Sum(o => o.SoTien)
                            });
                        }
                    }
                    else
                    {
                        yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                        {
                            TaiKhoanBenhNhanThu = thuPhi,
                            YeuCauTiepNhanId = ycTiepNhan.Id,
                            LoaiMienGiam = Enums.LoaiMienGiam.Voucher,
                            TheVoucherId = voucher.TheVoucherId,
                            LoaiChietKhau = voucher.LoaiChietKhau,
                            MaTheVoucher = voucher.MaTheVoucher,
                            TiLe = voucher.TiLe.GetValueOrDefault(),
                            SoTien = voucher.SoTien
                        });
                    }
                }

                //mien giam them theo ti le
                var mienGiamThemTiLeTruoc = mienGiamChiPhiTruoc.Where(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoTiLe).ToList();
                var mienGiamThemTiLe = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoTiLe);
                if (mienGiamThemTiLeTruoc.Any())
                {
                    if (mienGiamThemTiLe == null ||
                        (mienGiamThemTiLe.TiLe.GetValueOrDefault() != mienGiamThemTiLeTruoc.Sum(o => o.TiLe.GetValueOrDefault()) || !mienGiamThemTiLe.SoTien.AlmostEqual(mienGiamThemTiLeTruoc.Sum(o => o.SoTien))))
                    {
                        yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                        {
                            TaiKhoanBenhNhanThu = thuPhi,
                            YeuCauTiepNhanId = ycTiepNhan.Id,
                            LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                            LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                            TiLe = (mienGiamThemTiLe?.TiLe ?? 0) - mienGiamThemTiLeTruoc.Sum(o => o.TiLe.GetValueOrDefault()),
                            SoTien = (mienGiamThemTiLe?.SoTien ?? 0) - mienGiamThemTiLeTruoc.Sum(o => o.SoTien)
                        });
                    }
                }
                else if (mienGiamThemTiLe != null && mienGiamThemTiLe.TiLe.GetValueOrDefault() != 0)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                        TiLe = mienGiamThemTiLe.TiLe,
                        SoTien = mienGiamThemTiLe.SoTien
                    });
                }

                //mien giam them theo so tien
                var mienGiamThemSoTienTruoc = mienGiamChiPhiTruoc.Where(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoSoTien).ToList();
                var mienGiamThemSoTien = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoSoTien);
                if (mienGiamThemSoTienTruoc.Any())
                {
                    if (mienGiamThemSoTien == null || !mienGiamThemSoTien.SoTien.AlmostEqual(mienGiamThemSoTienTruoc.Sum(o => o.SoTien)))
                    {
                        yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                        {
                            TaiKhoanBenhNhanThu = thuPhi,
                            YeuCauTiepNhanId = ycTiepNhan.Id,
                            LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                            LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoSoTien,
                            SoTien = (mienGiamThemSoTien?.SoTien ?? 0) - mienGiamThemSoTienTruoc.Sum(o => o.SoTien)
                        });
                    }
                }
                else if (mienGiamThemSoTien != null && !mienGiamThemSoTien.SoTien.AlmostEqual(0))
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoSoTien,
                        SoTien = mienGiamThemSoTien.SoTien
                    });
                }
                yc.SoTienMienGiam = chiphi.SoTienMG;

                if ((mienGiamThemTiLe?.SoTien ?? 0).AlmostEqual(0) && (mienGiamThemSoTien?.SoTien ?? 0).AlmostEqual(0))
                {
                    yc.GhiChuMienGiamThem = null;
                }
                else
                {
                    yc.GhiChuMienGiamThem = chiphi.GhiChuMienGiamThem;
                }
                #endregion
                yc.SoTienBenhNhanDaChi = yc.SoTienBenhNhanDaChi.GetValueOrDefault() + chiphi.BNConPhaiThanhToan;
                yc.TrangThaiThanhToan = Enums.TrangThaiThanhToan.DaThanhToan;
                thuPhi.TaiKhoanBenhNhanChis.Add(new TaiKhoanBenhNhanChi
                {
                    TaiKhoanBenhNhan = tk,
                    LoaiChiTienBenhNhan = Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi,
                    TienChiPhi = chiphi.BNConPhaiThanhToan,
                    NoiDungChi = Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi.GetDescription(),
                    NgayChi = DateTime.Now,
                    SoQuyen = 1,
                    YeuCauVatTuBenhVien = yc,
                    YeuCauTiepNhanId = ycTiepNhan.Id,
                    NhanVienThucHienId = _userAgentHelper.GetCurrentUserId(),
                    NoiThucHienId = _userAgentHelper.GetCurrentNoiLLamViecId()
                });
            }

            foreach (var chiphi in dsChiPhiDaChon.Where(o => o.LoaiNhom == NhomChiPhiKhamChuaBenh.GoiDichVu))
            {
                var yc = ycTiepNhan.BenhNhan.YeuCauGoiDichVus.First(o => o.Id == chiphi.Id);
                if (yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan)
                {
                    foreach (var ycKhamBenh in yc.YeuCauKhamBenhs.Where(o => o.YeuCauTiepNhanId == ycTiepNhan.Id && o.TrangThai != Enums.EnumTrangThaiYeuCauKhamBenh.HuyKham))
                    {
                        if (ycKhamBenh.NoiDangKyId != null && ycKhamBenh.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan)
                        {
                            ycKhamBenh.PhongBenhVienHangDois.Add(XepVaoHangDoi(ycTiepNhan, ycKhamBenh.NoiDangKyId.Value));
                        }
                        ycKhamBenh.TrangThaiThanhToan = Enums.TrangThaiThanhToan.DaThanhToan;
                    }
                    foreach (var ycDichVuKyThuat in yc.YeuCauDichVuKyThuats.Where(o => o.YeuCauTiepNhanId == ycTiepNhan.Id && o.TrangThai != Enums.EnumTrangThaiYeuCauDichVuKyThuat.DaHuy))
                    {
                        if (ycDichVuKyThuat.NoiThucHienId != null && ycDichVuKyThuat.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan)
                        {
                            ycDichVuKyThuat.PhongBenhVienHangDois.Add(XepVaoHangDoi(ycTiepNhan, ycDichVuKyThuat.NoiThucHienId.Value));
                        }
                        ycDichVuKyThuat.TrangThaiThanhToan = Enums.TrangThaiThanhToan.DaThanhToan;
                    }
                }

                #region cap nhat cong no va mien giam
                //them cong no
                if (chiphi.TongCongNo > 0)
                {
                    foreach (var chiphiDanhSachCongNoChoThu in chiphi.DanhSachCongNoChoThus)
                    {
                        var congNoTruoc = yc.CongTyBaoHiemTuNhanCongNos.Where(o =>
                                o.CongTyBaoHiemTuNhanId == chiphiDanhSachCongNoChoThu.CongTyBaoHiemTuNhanId)
                            .Sum(o => o.SoTien);
                        if (!congNoTruoc.AlmostEqual(chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu))
                        {
                            yc.CongTyBaoHiemTuNhanCongNos.Add(new CongTyBaoHiemTuNhanCongNo
                            {
                                TaiKhoanBenhNhanThu = thuPhi,
                                CongTyBaoHiemTuNhanId = chiphiDanhSachCongNoChoThu.CongTyBaoHiemTuNhanId,
                                SoTien = chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu - congNoTruoc
                            });
                        }
                    }
                }
                else if (!yc.CongTyBaoHiemTuNhanCongNos.Sum(o => o.SoTien).AlmostEqual(0))
                {
                    foreach (var ycCongTyBaoHiemTuNhanCongNo in yc.CongTyBaoHiemTuNhanCongNos.Where(o => o.CreatedOn != null))
                    {
                        yc.CongTyBaoHiemTuNhanCongNos.Add(new CongTyBaoHiemTuNhanCongNo
                        {
                            TaiKhoanBenhNhanThu = thuPhi,
                            CongTyBaoHiemTuNhanId = ycCongTyBaoHiemTuNhanCongNo.CongTyBaoHiemTuNhanId,
                            SoTien = ycCongTyBaoHiemTuNhanCongNo.SoTien * (-1)
                        });
                    }
                }
                yc.SoTienBaoHiemTuNhanChiTra = chiphi.TongCongNo;
                #endregion
                #region mien giam
                //mien giam theo uu dai
                var uuDai = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.DoiTuongUuDaiId != null && o.TiLe != 0);
                var mienGiamChiPhiTruoc = yc.MienGiamChiPhis.ToList();
                var mienGiamTheoUuDaiGroups = mienGiamChiPhiTruoc.Where(o => o.DoiTuongUuDaiId != null).GroupBy(o => o.DoiTuongUuDaiId.Value);
                bool daMienGiamUuDai = false;
                foreach (var mienGiamTheoUuDaiGroup in mienGiamTheoUuDaiGroups)
                {
                    if (mienGiamTheoUuDaiGroup.Key != uuDai?.DoiTuongUuDaiId)
                    {
                        yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                        {
                            TaiKhoanBenhNhanThu = thuPhi,
                            YeuCauTiepNhanId = ycTiepNhan.Id,
                            LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                            DoiTuongUuDaiId = mienGiamTheoUuDaiGroup.Key,
                            LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                            TiLe = 0 - mienGiamTheoUuDaiGroup.Sum(o => o.TiLe.GetValueOrDefault()),
                            SoTien = 0 - mienGiamTheoUuDaiGroup.Sum(o => o.SoTien)
                        });
                    }
                    else
                    {
                        daMienGiamUuDai = true;
                        if (uuDai.TiLe.GetValueOrDefault() != mienGiamTheoUuDaiGroup.Sum(o => o.TiLe.GetValueOrDefault()) || !uuDai.SoTien.AlmostEqual(mienGiamTheoUuDaiGroup.Sum(o => o.SoTien)))
                        {
                            yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                            {
                                TaiKhoanBenhNhanThu = thuPhi,
                                YeuCauTiepNhanId = ycTiepNhan.Id,
                                LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                                DoiTuongUuDaiId = mienGiamTheoUuDaiGroup.Key,
                                LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                                TiLe = uuDai.TiLe.GetValueOrDefault() - mienGiamTheoUuDaiGroup.Sum(o => o.TiLe.GetValueOrDefault()),
                                SoTien = uuDai.SoTien - mienGiamTheoUuDaiGroup.Sum(o => o.SoTien)
                            });
                        }
                    }
                }
                if (!daMienGiamUuDai && uuDai != null)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                        DoiTuongUuDaiId = uuDai.DoiTuongUuDaiId,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                        TiLe = uuDai.TiLe.GetValueOrDefault(),
                        SoTien = uuDai.SoTien
                    });
                }

                //mien giam theo voucher
                var vouchers = chiphi.DanhSachMienGiamVos.Where(o => o.TheVoucherId != null).ToList();
                var mienGiamTheoVoucherGroups = mienGiamChiPhiTruoc.Where(o => o.TheVoucherId != null).GroupBy(o => o.TheVoucherId.Value).ToList();

                foreach (var mienGiamTheoVoucherGroup in mienGiamTheoVoucherGroups)
                {
                    if (!vouchers.Select(o => o.TheVoucherId).Contains(mienGiamTheoVoucherGroup.Key))
                    {
                        yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                        {
                            TaiKhoanBenhNhanThu = thuPhi,
                            YeuCauTiepNhanId = ycTiepNhan.Id,
                            LoaiMienGiam = Enums.LoaiMienGiam.Voucher,
                            TheVoucherId = mienGiamTheoVoucherGroup.Key,
                            LoaiChietKhau = mienGiamTheoVoucherGroup.First().LoaiChietKhau,
                            MaTheVoucher = mienGiamTheoVoucherGroup.First().MaTheVoucher,
                            TiLe = 0 - mienGiamTheoVoucherGroup.Sum(o => o.TiLe.GetValueOrDefault()),
                            SoTien = 0 - mienGiamTheoVoucherGroup.Sum(o => o.SoTien)
                        });
                    }
                }

                foreach (var voucher in vouchers)
                {
                    var mienGiamTheoVoucherGroup = mienGiamTheoVoucherGroups.FirstOrDefault(o => o.Key == voucher.TheVoucherId);
                    if (mienGiamTheoVoucherGroup != null)
                    {
                        if (voucher.TiLe.GetValueOrDefault() != mienGiamTheoVoucherGroup.Sum(o => o.TiLe.GetValueOrDefault()) || !voucher.SoTien.AlmostEqual(mienGiamTheoVoucherGroup.Sum(o => o.SoTien)))
                        {
                            yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                            {
                                TaiKhoanBenhNhanThu = thuPhi,
                                YeuCauTiepNhanId = ycTiepNhan.Id,
                                LoaiMienGiam = Enums.LoaiMienGiam.Voucher,
                                TheVoucherId = voucher.TheVoucherId,
                                LoaiChietKhau = voucher.LoaiChietKhau,
                                MaTheVoucher = voucher.MaTheVoucher,
                                TiLe = voucher.TiLe.GetValueOrDefault() - mienGiamTheoVoucherGroup.Sum(o => o.TiLe.GetValueOrDefault()),
                                SoTien = voucher.SoTien - mienGiamTheoVoucherGroup.Sum(o => o.SoTien)
                            });
                        }
                    }
                    else
                    {
                        yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                        {
                            TaiKhoanBenhNhanThu = thuPhi,
                            YeuCauTiepNhanId = ycTiepNhan.Id,
                            LoaiMienGiam = Enums.LoaiMienGiam.Voucher,
                            TheVoucherId = voucher.TheVoucherId,
                            LoaiChietKhau = voucher.LoaiChietKhau,
                            MaTheVoucher = voucher.MaTheVoucher,
                            TiLe = voucher.TiLe.GetValueOrDefault(),
                            SoTien = voucher.SoTien
                        });
                    }
                }

                //mien giam them theo ti le
                var mienGiamThemTiLeTruoc = mienGiamChiPhiTruoc.Where(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoTiLe).ToList();
                var mienGiamThemTiLe = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoTiLe);
                if (mienGiamThemTiLeTruoc.Any())
                {
                    if (mienGiamThemTiLe == null ||
                        (mienGiamThemTiLe.TiLe.GetValueOrDefault() != mienGiamThemTiLeTruoc.Sum(o => o.TiLe.GetValueOrDefault()) || !mienGiamThemTiLe.SoTien.AlmostEqual(mienGiamThemTiLeTruoc.Sum(o => o.SoTien))))
                    {
                        yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                        {
                            TaiKhoanBenhNhanThu = thuPhi,
                            YeuCauTiepNhanId = ycTiepNhan.Id,
                            LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                            LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                            TiLe = (mienGiamThemTiLe?.TiLe ?? 0) - mienGiamThemTiLeTruoc.Sum(o => o.TiLe.GetValueOrDefault()),
                            SoTien = (mienGiamThemTiLe?.SoTien ?? 0) - mienGiamThemTiLeTruoc.Sum(o => o.SoTien)
                        });
                    }
                }
                else if (mienGiamThemTiLe != null && mienGiamThemTiLe.TiLe.GetValueOrDefault() != 0)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                        TiLe = mienGiamThemTiLe.TiLe,
                        SoTien = mienGiamThemTiLe.SoTien
                    });
                }

                //mien giam them theo so tien
                var mienGiamThemSoTienTruoc = mienGiamChiPhiTruoc.Where(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoSoTien).ToList();
                var mienGiamThemSoTien = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoSoTien);
                if (mienGiamThemSoTienTruoc.Any())
                {
                    if (mienGiamThemSoTien == null || !mienGiamThemSoTien.SoTien.AlmostEqual(mienGiamThemSoTienTruoc.Sum(o => o.SoTien)))
                    {
                        yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                        {
                            TaiKhoanBenhNhanThu = thuPhi,
                            YeuCauTiepNhanId = ycTiepNhan.Id,
                            LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                            LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoSoTien,
                            SoTien = (mienGiamThemSoTien?.SoTien ?? 0) - mienGiamThemSoTienTruoc.Sum(o => o.SoTien)
                        });
                    }
                }
                else if (mienGiamThemSoTien != null && !mienGiamThemSoTien.SoTien.AlmostEqual(0))
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoSoTien,
                        SoTien = mienGiamThemSoTien.SoTien
                    });
                }
                yc.SoTienMienGiam = chiphi.SoTienMG;

                if ((mienGiamThemTiLe?.SoTien ?? 0).AlmostEqual(0) && (mienGiamThemSoTien?.SoTien ?? 0).AlmostEqual(0))
                {
                    yc.GhiChuMienGiamThem = null;
                }
                else
                {
                    yc.GhiChuMienGiamThem = chiphi.GhiChuMienGiamThem;
                }
                #endregion
                yc.SoTienBenhNhanDaChi = yc.SoTienBenhNhanDaChi.GetValueOrDefault() + chiphi.BNConPhaiThanhToan;
                yc.TrangThaiThanhToan = Enums.TrangThaiThanhToan.DaThanhToan;
                if (yc.TrangThai == Enums.EnumTrangThaiYeuCauGoiDichVu.ChuaThucHien)
                {
                    yc.TrangThai = Enums.EnumTrangThaiYeuCauGoiDichVu.DangThucHien;
                }
                thuPhi.TaiKhoanBenhNhanChis.Add(new TaiKhoanBenhNhanChi
                {
                    TaiKhoanBenhNhan = tk,
                    LoaiChiTienBenhNhan = Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi,
                    TienChiPhi = chiphi.BNConPhaiThanhToan,
                    NoiDungChi = Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi.GetDescription(),
                    NgayChi = DateTime.Now,
                    SoQuyen = 1,
                    YeuCauGoiDichVu = yc,
                    YeuCauTiepNhanId = ycTiepNhan.Id,
                    NhanVienThucHienId = _userAgentHelper.GetCurrentUserId(),
                    NoiThucHienId = _userAgentHelper.GetCurrentNoiLLamViecId()
                });

            }

            foreach (var chiphi in dsChiPhiDaChon.Where(o => o.LoaiNhom == NhomChiPhiKhamChuaBenh.ToaThuoc))
            {
                var yc = ycTiepNhan.DonThuocThanhToans.SelectMany(o => o.DonThuocThanhToanChiTiets).First(o => o.Id == chiphi.Id);
                #region cap nhat cong no va mien giam
                //them cong no
                if (chiphi.TongCongNo > 0)
                {
                    foreach (var chiphiDanhSachCongNoChoThu in chiphi.DanhSachCongNoChoThus)
                    {
                        var congNoTruoc = yc.CongTyBaoHiemTuNhanCongNos.Where(o =>
                                o.CongTyBaoHiemTuNhanId == chiphiDanhSachCongNoChoThu.CongTyBaoHiemTuNhanId)
                            .Sum(o => o.SoTien);
                        if (!congNoTruoc.AlmostEqual(chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu))
                        {
                            yc.CongTyBaoHiemTuNhanCongNos.Add(new CongTyBaoHiemTuNhanCongNo
                            {
                                TaiKhoanBenhNhanThu = thuPhi,
                                CongTyBaoHiemTuNhanId = chiphiDanhSachCongNoChoThu.CongTyBaoHiemTuNhanId,
                                SoTien = chiphiDanhSachCongNoChoThu.SoTienCongNoChoThu - congNoTruoc
                            });
                        }
                    }
                }
                else if (!yc.CongTyBaoHiemTuNhanCongNos.Sum(o => o.SoTien).AlmostEqual(0))
                {
                    foreach (var ycCongTyBaoHiemTuNhanCongNo in yc.CongTyBaoHiemTuNhanCongNos.Where(o => o.CreatedOn != null))
                    {
                        yc.CongTyBaoHiemTuNhanCongNos.Add(new CongTyBaoHiemTuNhanCongNo
                        {
                            TaiKhoanBenhNhanThu = thuPhi,
                            CongTyBaoHiemTuNhanId = ycCongTyBaoHiemTuNhanCongNo.CongTyBaoHiemTuNhanId,
                            SoTien = ycCongTyBaoHiemTuNhanCongNo.SoTien * (-1)
                        });
                    }
                }
                yc.SoTienBaoHiemTuNhanChiTra = chiphi.TongCongNo;
                #endregion
                #region mien giam
                //mien giam theo uu dai
                var uuDai = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.DoiTuongUuDaiId != null && o.TiLe != 0);
                var mienGiamChiPhiTruoc = ycTiepNhan.MienGiamChiPhis.Where(o => o.DonThuocThanhToanChiTietId == yc.Id).ToList();
                var mienGiamTheoUuDaiGroups = mienGiamChiPhiTruoc.Where(o => o.DoiTuongUuDaiId != null).GroupBy(o => o.DoiTuongUuDaiId.Value);
                bool daMienGiamUuDai = false;
                foreach (var mienGiamTheoUuDaiGroup in mienGiamTheoUuDaiGroups)
                {
                    if (mienGiamTheoUuDaiGroup.Key != uuDai?.DoiTuongUuDaiId)
                    {
                        yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                        {
                            TaiKhoanBenhNhanThu = thuPhi,
                            YeuCauTiepNhanId = ycTiepNhan.Id,
                            LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                            DoiTuongUuDaiId = mienGiamTheoUuDaiGroup.Key,
                            LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                            TiLe = 0 - mienGiamTheoUuDaiGroup.Sum(o => o.TiLe.GetValueOrDefault()),
                            SoTien = 0 - mienGiamTheoUuDaiGroup.Sum(o => o.SoTien)
                        });
                    }
                    else
                    {
                        daMienGiamUuDai = true;
                        if (uuDai.TiLe.GetValueOrDefault() != mienGiamTheoUuDaiGroup.Sum(o => o.TiLe.GetValueOrDefault()) || !uuDai.SoTien.AlmostEqual(mienGiamTheoUuDaiGroup.Sum(o => o.SoTien)))
                        {
                            yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                            {
                                TaiKhoanBenhNhanThu = thuPhi,
                                YeuCauTiepNhanId = ycTiepNhan.Id,
                                LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                                DoiTuongUuDaiId = mienGiamTheoUuDaiGroup.Key,
                                LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                                TiLe = uuDai.TiLe.GetValueOrDefault() - mienGiamTheoUuDaiGroup.Sum(o => o.TiLe.GetValueOrDefault()),
                                SoTien = uuDai.SoTien - mienGiamTheoUuDaiGroup.Sum(o => o.SoTien)
                            });
                        }
                    }
                }
                if (!daMienGiamUuDai && uuDai != null)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.UuDai,
                        DoiTuongUuDaiId = uuDai.DoiTuongUuDaiId,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                        TiLe = uuDai.TiLe.GetValueOrDefault(),
                        SoTien = uuDai.SoTien
                    });
                }

                //mien giam theo voucher
                var vouchers = chiphi.DanhSachMienGiamVos.Where(o => o.TheVoucherId != null).ToList();
                var mienGiamTheoVoucherGroups = mienGiamChiPhiTruoc.Where(o => o.TheVoucherId != null).GroupBy(o => o.TheVoucherId.Value).ToList();

                foreach (var mienGiamTheoVoucherGroup in mienGiamTheoVoucherGroups)
                {
                    if (!vouchers.Select(o => o.TheVoucherId).Contains(mienGiamTheoVoucherGroup.Key))
                    {
                        yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                        {
                            TaiKhoanBenhNhanThu = thuPhi,
                            YeuCauTiepNhanId = ycTiepNhan.Id,
                            LoaiMienGiam = Enums.LoaiMienGiam.Voucher,
                            TheVoucherId = mienGiamTheoVoucherGroup.Key,
                            LoaiChietKhau = mienGiamTheoVoucherGroup.First().LoaiChietKhau,
                            MaTheVoucher = mienGiamTheoVoucherGroup.First().MaTheVoucher,
                            TiLe = 0 - mienGiamTheoVoucherGroup.Sum(o => o.TiLe.GetValueOrDefault()),
                            SoTien = 0 - mienGiamTheoVoucherGroup.Sum(o => o.SoTien)
                        });
                    }
                }

                foreach (var voucher in vouchers)
                {
                    var mienGiamTheoVoucherGroup = mienGiamTheoVoucherGroups.FirstOrDefault(o => o.Key == voucher.TheVoucherId);
                    if (mienGiamTheoVoucherGroup != null)
                    {
                        if (voucher.TiLe.GetValueOrDefault() != mienGiamTheoVoucherGroup.Sum(o => o.TiLe.GetValueOrDefault()) || !voucher.SoTien.AlmostEqual(mienGiamTheoVoucherGroup.Sum(o => o.SoTien)))
                        {
                            yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                            {
                                TaiKhoanBenhNhanThu = thuPhi,
                                YeuCauTiepNhanId = ycTiepNhan.Id,
                                LoaiMienGiam = Enums.LoaiMienGiam.Voucher,
                                TheVoucherId = voucher.TheVoucherId,
                                LoaiChietKhau = voucher.LoaiChietKhau,
                                MaTheVoucher = voucher.MaTheVoucher,
                                TiLe = voucher.TiLe.GetValueOrDefault() - mienGiamTheoVoucherGroup.Sum(o => o.TiLe.GetValueOrDefault()),
                                SoTien = voucher.SoTien - mienGiamTheoVoucherGroup.Sum(o => o.SoTien)
                            });
                        }
                    }
                    else
                    {
                        yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                        {
                            TaiKhoanBenhNhanThu = thuPhi,
                            YeuCauTiepNhanId = ycTiepNhan.Id,
                            LoaiMienGiam = Enums.LoaiMienGiam.Voucher,
                            TheVoucherId = voucher.TheVoucherId,
                            LoaiChietKhau = voucher.LoaiChietKhau,
                            MaTheVoucher = voucher.MaTheVoucher,
                            TiLe = voucher.TiLe.GetValueOrDefault(),
                            SoTien = voucher.SoTien
                        });
                    }
                }

                //mien giam them theo ti le
                var mienGiamThemTiLeTruoc = mienGiamChiPhiTruoc.Where(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoTiLe).ToList();
                var mienGiamThemTiLe = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoTiLe);
                if (mienGiamThemTiLeTruoc.Any())
                {
                    if (mienGiamThemTiLe == null ||
                        (mienGiamThemTiLe.TiLe.GetValueOrDefault() != mienGiamThemTiLeTruoc.Sum(o => o.TiLe.GetValueOrDefault()) || !mienGiamThemTiLe.SoTien.AlmostEqual(mienGiamThemTiLeTruoc.Sum(o => o.SoTien))))
                    {
                        yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                        {
                            TaiKhoanBenhNhanThu = thuPhi,
                            YeuCauTiepNhanId = ycTiepNhan.Id,
                            LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                            LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                            TiLe = (mienGiamThemTiLe?.TiLe ?? 0) - mienGiamThemTiLeTruoc.Sum(o => o.TiLe.GetValueOrDefault()),
                            SoTien = (mienGiamThemTiLe?.SoTien ?? 0) - mienGiamThemTiLeTruoc.Sum(o => o.SoTien)
                        });
                    }
                }
                else if (mienGiamThemTiLe != null && mienGiamThemTiLe.TiLe.GetValueOrDefault() != 0)
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoTiLe,
                        TiLe = mienGiamThemTiLe.TiLe,
                        SoTien = mienGiamThemTiLe.SoTien
                    });
                }

                //mien giam them theo so tien
                var mienGiamThemSoTienTruoc = mienGiamChiPhiTruoc.Where(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoSoTien).ToList();
                var mienGiamThemSoTien = chiphi.DanhSachMienGiamVos.FirstOrDefault(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem && o.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoSoTien);
                if (mienGiamThemSoTienTruoc.Any())
                {
                    if (mienGiamThemSoTien == null || !mienGiamThemSoTien.SoTien.AlmostEqual(mienGiamThemSoTienTruoc.Sum(o => o.SoTien)))
                    {
                        yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                        {
                            TaiKhoanBenhNhanThu = thuPhi,
                            YeuCauTiepNhanId = ycTiepNhan.Id,
                            LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                            LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoSoTien,
                            SoTien = (mienGiamThemSoTien?.SoTien ?? 0) - mienGiamThemSoTienTruoc.Sum(o => o.SoTien)
                        });
                    }
                }
                else if (mienGiamThemSoTien != null && !mienGiamThemSoTien.SoTien.AlmostEqual(0))
                {
                    yc.MienGiamChiPhis.Add(new MienGiamChiPhi
                    {
                        TaiKhoanBenhNhanThu = thuPhi,
                        YeuCauTiepNhanId = ycTiepNhan.Id,
                        LoaiMienGiam = Enums.LoaiMienGiam.MienGiamThem,
                        LoaiChietKhau = Enums.LoaiChietKhau.ChietKhauTheoSoTien,
                        SoTien = mienGiamThemSoTien.SoTien
                    });
                }
                yc.SoTienMienGiam = chiphi.SoTienMG;

                if ((mienGiamThemTiLe?.SoTien ?? 0).AlmostEqual(0) && (mienGiamThemSoTien?.SoTien ?? 0).AlmostEqual(0))
                {
                    yc.GhiChuMienGiamThem = null;
                }
                else
                {
                    yc.GhiChuMienGiamThem = chiphi.GhiChuMienGiamThem;
                }
                #endregion
                yc.SoTienBenhNhanDaChi = yc.SoTienBenhNhanDaChi.GetValueOrDefault() + chiphi.BNConPhaiThanhToan;
                yc.DonThuocThanhToan.TrangThaiThanhToan = Enums.TrangThaiThanhToan.DaThanhToan;
                thuPhi.TaiKhoanBenhNhanChis.Add(new TaiKhoanBenhNhanChi
                {
                    TaiKhoanBenhNhan = tk,
                    LoaiChiTienBenhNhan = Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi,
                    TienChiPhi = chiphi.BNConPhaiThanhToan,
                    NoiDungChi = Enums.LoaiChiTienBenhNhan.ThanhToanChiPhi.GetDescription(),
                    NgayChi = DateTime.Now,
                    SoQuyen = 1,
                    DonThuocThanhToanChiTiet = yc,
                    YeuCauTiepNhanId = ycTiepNhan.Id,
                    NhanVienThucHienId = _userAgentHelper.GetCurrentUserId(),
                    NoiThucHienId = _userAgentHelper.GetCurrentNoiLLamViecId()
                });
            }
            tk.SoDuTaiKhoan = tk.SoDuTaiKhoan + ((thuPhiKhamChuaBenhVo.TienMat.GetValueOrDefault() + thuPhiKhamChuaBenhVo.ChuyenKhoan.GetValueOrDefault() + thuPhiKhamChuaBenhVo.POS.GetValueOrDefault()) - soTienCanThu);
            ycTiepNhan.TaiKhoanBenhNhanThus.Add(thuPhi);

            foreach (var yeuCauKhamBenh in ycTiepNhan.YeuCauKhamBenhs)
            {
                var yeuCauNhapVien = yeuCauKhamBenh.YeuCauNhapViens.FirstOrDefault(o => !o.YeuCauTiepNhans.Any());
                if (yeuCauNhapVien != null)
                {
                    var yeuCauTiepNhanNoiTru = GetYeuCauTiepNhanNoiTru(ycTiepNhan, yeuCauNhapVien);
                    yeuCauTiepNhanNoiTru.YeuCauTiepNhanNgoaiTruCanQuyetToanId = ycTiepNhan.Id;
                    ycTiepNhan.QuyetToanTheoNoiTru = true;
                    await BaseRepository.AddAsync(yeuCauTiepNhanNoiTru);
                    return (thuPhi.Id, string.Empty);
                }
            }
            await BaseRepository.UpdateAsync(ycTiepNhan);
            return (thuPhi.Id, string.Empty);
        }

        #endregion
        */
        #region Danh sach da thu

        //todo: need check
        public async Task<GridDataSource> GetTotalPageForGridDanhSachDaThuAsync(QueryInfo queryInfo)
        {
            var queryDichVuKhamBenh = BaseRepository.TableNoTracking
                 .SelectMany(o => o.YeuCauKhamBenhs)
                 .Include(cc => cc.TaiKhoanBenhNhanChis)
                 .Where(yc => yc.YeuCauGoiDichVuId == null && yc.GoiKhamSucKhoeId == null &&
                              (yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.DaThanhToan
                             )).Select(s => new ChiPhiDaThanhToanKhamChuaBenhVo
                             {
                                 Id = s.Id
                             }).ToListAsync();

            var queryDichVuKyThuat = BaseRepository.TableNoTracking
                .SelectMany(o => o.YeuCauDichVuKyThuats).Include(cc => cc.TaiKhoanBenhNhanChis)
                .Where(yc => yc.YeuCauGoiDichVuId == null && yc.GoiKhamSucKhoeId == null &&
                             (yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.DaThanhToan))

                .Select(s => new ChiPhiDaThanhToanKhamChuaBenhVo
                {
                    Id = s.Id
                }).ToListAsync();

            var queryDichVuGiuong = BaseRepository.TableNoTracking

                .SelectMany(o => o.YeuCauDichVuGiuongBenhViens).Include(cc => cc.TaiKhoanBenhNhanChis)
                .Where(yc => yc.YeuCauGoiDichVuId == null &&
                             (yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.DaThanhToan))
                .Select(s => new ChiPhiDaThanhToanKhamChuaBenhVo
                {
                    Id = s.Id
                }).ToListAsync();

            var queryDuocPham = BaseRepository.TableNoTracking

                .SelectMany(o => o.YeuCauDuocPhamBenhViens).Include(cc => cc.TaiKhoanBenhNhanChis)
                .Where(yc => yc.YeuCauGoiDichVuId == null &&
                             (yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.DaThanhToan))

                .Select(s => new ChiPhiDaThanhToanKhamChuaBenhVo
                {
                    Id = s.Id
                }).ToListAsync();

            var queryVatTu = BaseRepository.TableNoTracking

                .SelectMany(o => o.YeuCauVatTuBenhViens).Include(cc => cc.TaiKhoanBenhNhanChis)
                .Where(yc => yc.YeuCauGoiDichVuId == null &&
                             (yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.DaThanhToan))

                .Select(s => new ChiPhiDaThanhToanKhamChuaBenhVo
                {
                    Id = s.Id
                }).ToListAsync();

            var queryToaThuoc = BaseRepository.TableNoTracking
                .SelectMany(o => o.DonThuocThanhToans)
                .Where(dt =>
                    dt.LoaiDonThuoc == Enums.EnumLoaiDonThuoc.ThuocBHYT &&
                    (dt.TrangThaiThanhToan == Enums.TrangThaiThanhToan.DaThanhToan))
                .Select(s => new ChiPhiDaThanhToanKhamChuaBenhVo
                {
                    Id = s.Id
                }).ToListAsync();

            //var queryGoiDichVu = BaseRepository.TableNoTracking

            //    .SelectMany(o => o.YeuCauGoiDichVus).Include(cc => cc.TaiKhoanBenhNhanChis)
            //    .Where(dt =>
            //        dt.TrangThaiThanhToan == Enums.TrangThaiThanhToan.DaThanhToan)
            //    .Select(s => new ChiPhiDaThanhToanKhamChuaBenhVo
            //    {
            //        Id = s.Id
            //    }).ToListAsync();

            await Task.WhenAll(queryDichVuKhamBenh, queryDichVuKyThuat, queryDichVuGiuong, queryDuocPham, queryVatTu, queryToaThuoc/*, queryGoiDichVu*/);

            var result = new List<ChiPhiDaThanhToanKhamChuaBenhVo>();
            result.AddRange(queryDichVuKhamBenh.Result);
            result.AddRange(queryDichVuKyThuat.Result);
            result.AddRange(queryDichVuGiuong.Result);
            result.AddRange(queryDuocPham.Result);
            result.AddRange(queryVatTu.Result);
            result.AddRange(queryToaThuoc.Result);
            //result.AddRange(queryGoiDichVu.Result);

            var query = result.AsQueryable();
            var countTask = queryInfo.LazyLoadPage == true ? 0 : query.Count();
            return new GridDataSource { TotalRowCount = countTask };
        }

        //câp nhật 04/11/2020 cho em câp nhât cái nay em show toottip cho phần miễm giảm nha anh
        public async Task<List<ChiPhiDaThanhToanKhamChuaBenhVo>> GetDanhSachChiPhiKhamBenhDaThu(long yeuCauTiepNhanId)
        {
            var nguoiThus = _useRepository.TableNoTracking.ToDictionary(c => c.Id, c => c);
            var queryDichVuKhamBenh = BaseRepository.TableNoTracking.Where(o => o.Id == yeuCauTiepNhanId)
                 .SelectMany(o => o.YeuCauKhamBenhs).Include(cc => cc.MienGiamChiPhis).ThenInclude(cc => cc.DoiTuongUuDai)
                 .Include(cc => cc.NoiDangKy).Include(cc => cc.BacSiDangKy).ThenInclude(cc => cc.User)
                 .Include(cc => cc.TaiKhoanBenhNhanChis)
                 .Where(yc => yc.YeuCauGoiDichVuId == null && yc.GoiKhamSucKhoeId == null &&
                              (yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.DaThanhToan
                             )).Select(s => new ChiPhiDaThanhToanKhamChuaBenhVo
                             {
                                 Id = s.Id,
                                 LoaiNhom = NhomChiPhiKhamChuaBenh.DichVuKhamBenh,
                                 Ma = s.DichVuKhamBenhBenhVien.Ma,
                                 TenDichVu = s.DichVuKhamBenhBenhVien.Ten,
                                 LoaiGia = s.NhomGiaDichVuKhamBenhBenhVien.Ten,
                                 Soluong = 1,
                                 DonGia = s.Gia,
                                 KhongTinhPhi = s.KhongTinhPhi,
                                 KiemTraBHYTXacNhan = s.BaoHiemChiTra != null,
                                 DuocHuongBHYT = s.DuocHuongBaoHiem,
                                 DonGiaBHYT = s.DonGiaBaoHiem.GetValueOrDefault(),
                                 TiLeBaoHiemThanhToan = s.TiLeBaoHiemThanhToan.GetValueOrDefault(),
                                 MucHuongBaoHiem = s.MucHuongBaoHiem.GetValueOrDefault(),
                                 SoTienMG = s.SoTienMienGiam.GetValueOrDefault(),
                                 TongCongNo = s.SoTienBaoHiemTuNhanChiTra.GetValueOrDefault(),
                                 DaThanhToan = s.SoTienBenhNhanDaChi.GetValueOrDefault(),
                                 NoiThucHien = (s.NoiDangKy != null ? $"{s.NoiDangKy.Ma}" : "") + (s.BacSiDangKy != null && s.BacSiDangKy.User.HoTen != null ? " - " + $"{s.BacSiDangKy.User.HoTen}" : ""),
                                 CheckedDefault = true,
                                 KiemTraHuy = s.TrangThai != Enums.EnumTrangThaiYeuCauKhamBenh.ChuaKham,
                                 TrangThai = s.TrangThai.GetDescription(),

                                 DanhSachMienGiamVos = s.MienGiamChiPhis.Count == 0 ? new List<DanhSachMienGiamVo>() : s.MienGiamChiPhis.GroupBy(o => new { o.LoaiMienGiam, o.YeuCauGoiDichVuId, o.TheVoucherId, o.MaTheVoucher, o.DoiTuongUuDaiId, o.LoaiChietKhau, o.DoiTuongUuDai.Ten }, o => o,
                                                                                                        (k, v) => new DanhSachMienGiamVo
                                                                                                        {
                                                                                                            LoaiMienGiam = k.LoaiMienGiam,
                                                                                                            YeuCauGoiDichVuId = k.YeuCauGoiDichVuId,
                                                                                                            LoaiChietKhau = k.LoaiChietKhau,
                                                                                                            TheVoucherId = k.TheVoucherId,
                                                                                                            MaTheVoucher = k.MaTheVoucher,
                                                                                                            DoiTuongUuDaiId = k.DoiTuongUuDaiId,
                                                                                                            DoiTuongUuDai = k.Ten,
                                                                                                            TiLe = v.Select(o => o.TiLe).DefaultIfEmpty().Sum(),
                                                                                                            SoTien = v.Select(o => o.SoTien).DefaultIfEmpty().Sum()
                                                                                                        }).Where(o => o.SoTien != 0),
                                 GhiChuMienGiamThem = s.GhiChuMienGiamThem,
                                 NoiDungGhiChuMiemGiamId = s.NoiDungGhiChuMiemGiamId,

                                 TaiKhoanBenhNhanChiDetails = s.TaiKhoanBenhNhanChis.Select(t => new TaiKhoanBenhNhanChiDetail
                                 {
                                     NguoiThu = t != null && t.NhanVienThucHienId != null ? nguoiThus[t.NhanVienThucHienId ?? 0].HoTen : string.Empty,
                                     ThoiGianThuStr = t.NgayChi.ApplyFormatDate(),
                                     SoPhieu = t != null ? t.SoPhieu.HasValue ? int.Parse(t.SoPhieu.ToString()) : int.Parse(t.Id.ToString()) : 1,
                                 }).ToList()
                             }).OrderBy(o => o.Id).ToListAsync();

            var queryDichVuKyThuat = BaseRepository.TableNoTracking.Where(o => o.Id == yeuCauTiepNhanId)
                .SelectMany(o => o.YeuCauDichVuKyThuats).Include(cc => cc.TaiKhoanBenhNhanChis).Include(cc => cc.MienGiamChiPhis)
                .Where(yc => yc.YeuCauGoiDichVuId == null && yc.GoiKhamSucKhoeId == null &&
                             (yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.DaThanhToan))

                .Select(s => new ChiPhiDaThanhToanKhamChuaBenhVo
                {
                    Id = s.Id,
                    LoaiNhom = NhomChiPhiKhamChuaBenh.DichVuKyThuat,
                    Ma = s.DichVuKyThuatBenhVien.Ma,
                    TenDichVu = s.DichVuKyThuatBenhVien.Ten,
                    LoaiGia = s.NhomGiaDichVuKyThuatBenhVien.Ten,
                    Soluong = s.SoLan,
                    DonGia = s.Gia,
                    KhongTinhPhi = s.KhongTinhPhi,
                    KiemTraBHYTXacNhan = s.BaoHiemChiTra != null,
                    DuocHuongBHYT = s.DuocHuongBaoHiem,
                    DonGiaBHYT = s.DonGiaBaoHiem.GetValueOrDefault(),
                    TiLeBaoHiemThanhToan = s.TiLeBaoHiemThanhToan.GetValueOrDefault(),
                    MucHuongBaoHiem = s.MucHuongBaoHiem.GetValueOrDefault(),
                    SoTienMG = s.SoTienMienGiam.GetValueOrDefault(),
                    TongCongNo = s.SoTienBaoHiemTuNhanChiTra.GetValueOrDefault(),
                    DaThanhToan = s.SoTienBenhNhanDaChi.GetValueOrDefault(),
                    NoiThucHien = s.NoiThucHien != null
                        ? $"{s.NoiThucHien.Ma} - {s.NoiThucHien.Ten}"
                        : string.Empty,
                    CheckedDefault = true,
                    KiemTraHuy = s.TrangThai != Enums.EnumTrangThaiYeuCauDichVuKyThuat.ChuaThucHien,
                    TrangThai = s.TrangThai.GetDescription(),

                    DanhSachMienGiamVos = s.MienGiamChiPhis.Count == 0 ? new List<DanhSachMienGiamVo>() : s.MienGiamChiPhis.GroupBy(o => new { o.LoaiMienGiam, o.YeuCauGoiDichVuId, o.TheVoucherId, o.MaTheVoucher, o.DoiTuongUuDaiId, o.LoaiChietKhau }, o => o,
                                                                                                        (k, v) => new DanhSachMienGiamVo
                                                                                                        {
                                                                                                            LoaiMienGiam = k.LoaiMienGiam,
                                                                                                            YeuCauGoiDichVuId = k.YeuCauGoiDichVuId,
                                                                                                            LoaiChietKhau = k.LoaiChietKhau,
                                                                                                            TheVoucherId = k.TheVoucherId,
                                                                                                            MaTheVoucher = k.MaTheVoucher,
                                                                                                            DoiTuongUuDaiId = k.DoiTuongUuDaiId,
                                                                                                            TiLe = v.Select(o => o.TiLe).DefaultIfEmpty().Sum(),
                                                                                                            SoTien = v.Select(o => o.SoTien).DefaultIfEmpty().Sum()
                                                                                                        }).Where(o => o.SoTien != 0),
                    GhiChuMienGiamThem = s.GhiChuMienGiamThem,
                    NoiDungGhiChuMiemGiamId = s.NoiDungGhiChuMiemGiamId,

                    TaiKhoanBenhNhanChiDetails = s.TaiKhoanBenhNhanChis.Select(t => new TaiKhoanBenhNhanChiDetail
                    {
                        NguoiThu = t != null && t.NhanVienThucHienId != null ? nguoiThus[t.NhanVienThucHienId ?? 0].HoTen : string.Empty,
                        ThoiGianThuStr = t.NgayChi.ApplyFormatDate(),
                        SoPhieu = t != null ? t.SoPhieu.HasValue ? int.Parse(t.SoPhieu.ToString()) : int.Parse(t.Id.ToString()) : 1,
                    }).ToList()
                }).ToListAsync();

            var queryDichVuGiuong = BaseRepository.TableNoTracking.Where(o => o.Id == yeuCauTiepNhanId)
                .SelectMany(o => o.YeuCauDichVuGiuongBenhViens).Include(cc => cc.TaiKhoanBenhNhanChis).Include(cc => cc.MienGiamChiPhis)
                .Where(yc => yc.YeuCauGoiDichVuId == null &&
                             (yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.DaThanhToan))
                .Select(s => new ChiPhiDaThanhToanKhamChuaBenhVo
                {
                    Id = s.Id,
                    LoaiNhom = NhomChiPhiKhamChuaBenh.DichVuGiuong,
                    Ma = s.DichVuGiuongBenhVien.Ma,
                    TenDichVu = s.DichVuGiuongBenhVien.Ten,
                    LoaiGia = s.NhomGiaDichVuGiuongBenhVien.Ten,
                    Soluong = 1,
                    DonGia = s.Gia.GetValueOrDefault(),
                    KhongTinhPhi = s.KhongTinhPhi,
                    KiemTraBHYTXacNhan = s.BaoHiemChiTra != null,
                    DuocHuongBHYT = s.DuocHuongBaoHiem,
                    DonGiaBHYT = s.DonGiaBaoHiem.GetValueOrDefault(),
                    TiLeBaoHiemThanhToan = s.TiLeBaoHiemThanhToan.GetValueOrDefault(),
                    MucHuongBaoHiem = s.MucHuongBaoHiem.GetValueOrDefault(),
                    SoTienMG = s.SoTienMienGiam.GetValueOrDefault(),
                    TongCongNo = s.SoTienBaoHiemTuNhanChiTra.GetValueOrDefault(),
                    DaThanhToan = s.SoTienBenhNhanDaChi.GetValueOrDefault(),
                    NoiThucHien = s.NoiThucHien != null
                        ? $"{s.NoiThucHien.Ma} - {s.NoiThucHien.Ten}"
                        : string.Empty,
                    CheckedDefault = true,
                    KiemTraHuy = s.TrangThai != Enums.EnumTrangThaiGiuongBenh.ChuaThucHien,
                    TrangThai = s.TrangThai.GetDescription(),


                    DanhSachMienGiamVos = s.MienGiamChiPhis.Count == 0 ? new List<DanhSachMienGiamVo>() : s.MienGiamChiPhis.GroupBy(o => new { o.LoaiMienGiam, o.TheVoucherId, o.MaTheVoucher, o.DoiTuongUuDaiId, o.LoaiChietKhau }, o => o,
                                                                                                        (k, v) => new DanhSachMienGiamVo
                                                                                                        {
                                                                                                            LoaiMienGiam = k.LoaiMienGiam,
                                                                                                            LoaiChietKhau = k.LoaiChietKhau,
                                                                                                            TheVoucherId = k.TheVoucherId,
                                                                                                            MaTheVoucher = k.MaTheVoucher,
                                                                                                            DoiTuongUuDaiId = k.DoiTuongUuDaiId,
                                                                                                            TiLe = v.Select(o => o.TiLe).DefaultIfEmpty().Sum(),
                                                                                                            SoTien = v.Select(o => o.SoTien).DefaultIfEmpty().Sum()
                                                                                                        }).Where(o => o.SoTien != 0),
                    GhiChuMienGiamThem = s.GhiChuMienGiamThem,
                    NoiDungGhiChuMiemGiamId = s.NoiDungGhiChuMiemGiamId,

                    TaiKhoanBenhNhanChiDetails = s.TaiKhoanBenhNhanChis.Select(t => new TaiKhoanBenhNhanChiDetail
                    {
                        NguoiThu = t != null && t.NhanVienThucHienId != null ? nguoiThus[t.NhanVienThucHienId ?? 0].HoTen : string.Empty,
                        ThoiGianThuStr = t.NgayChi.ApplyFormatDate(),
                        SoPhieu = t != null ? t.SoPhieu.HasValue ? int.Parse(t.SoPhieu.ToString()) : int.Parse(t.Id.ToString()) : 1,
                    }).ToList()

                }).ToListAsync();

            var queryDuocPham = BaseRepository.TableNoTracking.Where(o => o.Id == yeuCauTiepNhanId)
                .SelectMany(o => o.YeuCauDuocPhamBenhViens).Include(cc => cc.TaiKhoanBenhNhanChis)
                                                           .Include(cc => cc.MienGiamChiPhis)
                .Where(yc => yc.YeuCauGoiDichVuId == null &&
                             (yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.DaThanhToan))

                .Select(s => new ChiPhiDaThanhToanKhamChuaBenhVo
                {
                    Id = s.Id,
                    LoaiNhom = NhomChiPhiKhamChuaBenh.DuocPham,
                    Ma = s.DuocPhamBenhVien.Ma,
                    TenDichVu = s.DuocPhamBenhVien.DuocPham.Ten,
                    LoaiGia = string.Empty,
                    Soluong = s.SoLuong,
                    DonGia = s.DonGiaBan,
                    KhongTinhPhi = s.KhongTinhPhi,
                    KiemTraBHYTXacNhan = s.BaoHiemChiTra != null,
                    DuocHuongBHYT = s.DuocHuongBaoHiem,
                    DonGiaBHYT = s.DonGiaBaoHiem.GetValueOrDefault(),
                    TiLeBaoHiemThanhToan = s.TiLeBaoHiemThanhToan.GetValueOrDefault(),
                    MucHuongBaoHiem = s.MucHuongBaoHiem.GetValueOrDefault(),
                    SoTienMG = s.SoTienMienGiam.GetValueOrDefault(),
                    TongCongNo = s.SoTienBaoHiemTuNhanChiTra.GetValueOrDefault(),
                    DaThanhToan = s.SoTienBenhNhanDaChi.GetValueOrDefault(),
                    NoiThucHien = string.Empty,
                    CheckedDefault = true,
                    KiemTraHuy = s.TrangThai != Enums.EnumYeuCauDuocPhamBenhVien.ChuaThucHien,
                    TrangThai = s.TrangThai.GetDescription(),


                    DanhSachMienGiamVos = s.MienGiamChiPhis.Count == 0 ? new List<DanhSachMienGiamVo>() : s.MienGiamChiPhis.GroupBy(o => new { o.LoaiMienGiam, o.TheVoucherId, o.MaTheVoucher, o.DoiTuongUuDaiId, o.LoaiChietKhau }, o => o,
                                                                                                        (k, v) => new DanhSachMienGiamVo
                                                                                                        {
                                                                                                            LoaiMienGiam = k.LoaiMienGiam,
                                                                                                            LoaiChietKhau = k.LoaiChietKhau,
                                                                                                            TheVoucherId = k.TheVoucherId,
                                                                                                            MaTheVoucher = k.MaTheVoucher,
                                                                                                            DoiTuongUuDaiId = k.DoiTuongUuDaiId,
                                                                                                            TiLe = v.Select(o => o.TiLe).DefaultIfEmpty().Sum(),
                                                                                                            SoTien = v.Select(o => o.SoTien).DefaultIfEmpty().Sum()
                                                                                                        }).Where(o => o.SoTien != 0),
                    GhiChuMienGiamThem = s.GhiChuMienGiamThem,
                    NoiDungGhiChuMiemGiamId = s.NoiDungGhiChuMiemGiamId,

                    TaiKhoanBenhNhanChiDetails = s.TaiKhoanBenhNhanChis.Select(t => new TaiKhoanBenhNhanChiDetail
                    {
                        NguoiThu = t != null && t.NhanVienThucHienId != null ? nguoiThus[t.NhanVienThucHienId ?? 0].HoTen : string.Empty,
                        ThoiGianThuStr = t.NgayChi.ApplyFormatDate(),
                        SoPhieu = t != null ? t.SoPhieu.HasValue ? int.Parse(t.SoPhieu.ToString()) : int.Parse(t.Id.ToString()) : 1,
                    }).ToList()
                }).ToListAsync();

            var queryVatTu = BaseRepository.TableNoTracking.Where(o => o.Id == yeuCauTiepNhanId)
                .SelectMany(o => o.YeuCauVatTuBenhViens)
                                            .Include(cc => cc.TaiKhoanBenhNhanChis)
                                            .Include(cc => cc.MienGiamChiPhis)
                .Where(yc => yc.YeuCauGoiDichVuId == null &&
                             (yc.TrangThaiThanhToan == Enums.TrangThaiThanhToan.DaThanhToan))

                .Select(s => new ChiPhiDaThanhToanKhamChuaBenhVo
                {
                    Id = s.Id,
                    LoaiNhom = NhomChiPhiKhamChuaBenh.VatTuTieuHao,
                    Ma = s.VatTuBenhVien.Ma,
                    TenDichVu = s.VatTuBenhVien.VatTus.Ten,
                    LoaiGia = string.Empty,
                    Soluong = s.SoLuong,
                    DonGia = s.DonGiaBan,
                    KhongTinhPhi = s.KhongTinhPhi,
                    KiemTraBHYTXacNhan = s.BaoHiemChiTra != null,
                    DuocHuongBHYT = s.DuocHuongBaoHiem,
                    DonGiaBHYT = s.DonGiaBaoHiem.GetValueOrDefault(),
                    TiLeBaoHiemThanhToan = s.TiLeBaoHiemThanhToan.GetValueOrDefault(),
                    MucHuongBaoHiem = s.MucHuongBaoHiem.GetValueOrDefault(),
                    SoTienMG = s.SoTienMienGiam.GetValueOrDefault(),
                    TongCongNo = s.SoTienBaoHiemTuNhanChiTra.GetValueOrDefault(),
                    DaThanhToan = s.SoTienBenhNhanDaChi.GetValueOrDefault(),
                    NoiThucHien = string.Empty,
                    CheckedDefault = true,
                    KiemTraHuy = s.TrangThai != Enums.EnumYeuCauVatTuBenhVien.ChuaThucHien,
                    TrangThai = s.TrangThai.GetDescription(),


                    DanhSachMienGiamVos = s.MienGiamChiPhis.Count == 0 ? new List<DanhSachMienGiamVo>() : s.MienGiamChiPhis.GroupBy(o => new { o.LoaiMienGiam, o.TheVoucherId, o.MaTheVoucher, o.DoiTuongUuDaiId, o.LoaiChietKhau }, o => o,
                                                                                                        (k, v) => new DanhSachMienGiamVo
                                                                                                        {
                                                                                                            LoaiMienGiam = k.LoaiMienGiam,
                                                                                                            LoaiChietKhau = k.LoaiChietKhau,
                                                                                                            TheVoucherId = k.TheVoucherId,
                                                                                                            MaTheVoucher = k.MaTheVoucher,
                                                                                                            DoiTuongUuDaiId = k.DoiTuongUuDaiId,
                                                                                                            TiLe = v.Select(o => o.TiLe).DefaultIfEmpty().Sum(),
                                                                                                            SoTien = v.Select(o => o.SoTien).DefaultIfEmpty().Sum()
                                                                                                        }).Where(o => o.SoTien != 0),
                    GhiChuMienGiamThem = s.GhiChuMienGiamThem,
                    NoiDungGhiChuMiemGiamId = s.NoiDungGhiChuMiemGiamId,

                    TaiKhoanBenhNhanChiDetails = s.TaiKhoanBenhNhanChis.Select(t => new TaiKhoanBenhNhanChiDetail
                    {
                        NguoiThu = t != null && t.NhanVienThucHienId != null ? nguoiThus[t.NhanVienThucHienId ?? 0].HoTen : string.Empty,
                        ThoiGianThuStr = t.NgayChi.ApplyFormatDate(),
                        SoPhieu = t != null ? t.SoPhieu.HasValue ? int.Parse(t.SoPhieu.ToString()) : int.Parse(t.Id.ToString()) : 1,
                    }).ToList()
                }).ToListAsync();




            var queryToaThuoc = BaseRepository.TableNoTracking.Where(o => o.Id == yeuCauTiepNhanId)
                .SelectMany(o => o.DonThuocThanhToans)
                .Where(dt =>
                    dt.LoaiDonThuoc == Enums.EnumLoaiDonThuoc.ThuocBHYT &&
                    (dt.TrangThaiThanhToan == Enums.TrangThaiThanhToan.DaThanhToan))
                .Select(s => new ChiPhiDaThanhToanKhamChuaBenhVo
                {
                    Id = s.Id,
                    LoaiNhom = NhomChiPhiKhamChuaBenh.ToaThuoc,
                    Ma = string.Empty,
                    TenDichVu = s.YeuCauKhamBenhDonThuoc.YeuCauKhamBenh.TenDichVu,
                    LoaiGia = string.Empty,
                    Soluong = 1,
                    DonGia = s.DonThuocThanhToanChiTiets.Sum(ct => ct.GiaBan),
                    KiemTraBHYTXacNhan = s.DonThuocThanhToanChiTiets.Any(ct => ct.BaoHiemChiTra != null),
                    DuocHuongBHYT = s.DonThuocThanhToanChiTiets.Any(ct => ct.DuocHuongBaoHiem),
                    DonGiaBHYT = s.DonThuocThanhToanChiTiets.Sum(ct =>
                        ct.DonGiaBaoHiem.GetValueOrDefault() * ct.TiLeBaoHiemThanhToan.GetValueOrDefault() / 100 * ct.MucHuongBaoHiem.GetValueOrDefault() / 100 * Convert.ToDecimal(ct.SoLuong)),
                    TiLeBaoHiemThanhToan = 100,
                    MucHuongBaoHiem = 100,
                    SoTienMG = s.DonThuocThanhToanChiTiets.Sum(ct => ct.SoTienMienGiam.GetValueOrDefault()),
                    TongCongNo = s.DonThuocThanhToanChiTiets.Sum(ct => ct.SoTienBaoHiemTuNhanChiTra.GetValueOrDefault()),
                    DaThanhToan = s.DonThuocThanhToanChiTiets.Sum(ct => ct.SoTienBenhNhanDaChi.GetValueOrDefault()),
                    NoiThucHien = string.Empty,
                    CheckedDefault = true,
                    KiemTraHuy = s.TrangThai != Enums.TrangThaiDonThuocThanhToan.ChuaXuatThuoc,
                    TrangThai = s.TrangThai.GetDescription(),


                    DanhSachMienGiamVos = (s.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || s.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan) ? new List<DanhSachMienGiamVo>() :
                        s.DonThuocThanhToanChiTiets.SelectMany(c => c.MienGiamChiPhis).Count() == 0 ? new List<DanhSachMienGiamVo>() : s.DonThuocThanhToanChiTiets.SelectMany(c => c.MienGiamChiPhis).GroupBy(o => new { o.LoaiMienGiam, o.TheVoucherId, o.MaTheVoucher, o.DoiTuongUuDaiId, o.LoaiChietKhau }, o => o,
                            (k, v) => new DanhSachMienGiamVo
                            {
                                LoaiMienGiam = k.LoaiMienGiam,
                                LoaiChietKhau = k.LoaiChietKhau,
                                TheVoucherId = k.TheVoucherId,
                                MaTheVoucher = k.MaTheVoucher,
                                DoiTuongUuDaiId = k.DoiTuongUuDaiId,
                                TiLe = v.Select(o => o.TiLe).DefaultIfEmpty().Sum(),
                                SoTien = v.Select(o => o.SoTien).DefaultIfEmpty().Sum()
                            }).Where(o => o.SoTien != 0),

                    TaiKhoanBenhNhanChiDetails = s.DonThuocThanhToanChiTiets.SelectMany(o => o.TaiKhoanBenhNhanChis).Select(t => new TaiKhoanBenhNhanChiDetail
                    {
                        NguoiThu = t != null && t.NhanVienThucHienId != null ? nguoiThus[t.NhanVienThucHienId ?? 0].HoTen : string.Empty,
                        ThoiGianThuStr = t.NgayChi.ApplyFormatDate(),
                        SoPhieu = t != null ? t.SoPhieu.HasValue ? int.Parse(t.SoPhieu.ToString()) : int.Parse(t.Id.ToString()) : 1,
                    }).Distinct().ToList()
                }).ToListAsync();
            var queryGoiDichVu = BaseRepository.TableNoTracking.Where(o => o.Id == yeuCauTiepNhanId)
                .SelectMany(o => o.BenhNhan.YeuCauGoiDichVus).Include(cc => cc.TaiKhoanBenhNhanChis)
                .Where(dt => dt.TaiKhoanBenhNhanChis.Any(o => o.YeuCauTiepNhanId == yeuCauTiepNhanId) &&
                    dt.TrangThaiThanhToan == Enums.TrangThaiThanhToan.DaThanhToan)
                .Select(s => new ChiPhiDaThanhToanKhamChuaBenhVo
                {
                    Id = s.Id,
                    LoaiNhom = NhomChiPhiKhamChuaBenh.GoiDichVu,
                    Ma = string.Empty,
                    TenDichVu = s.TenChuongTrinh + " - " + s.TenGoiDichVu,
                    LoaiGia = string.Empty,
                    Soluong = 1,
                    DonGia = s.GiaSauChietKhau,
                    KiemTraBHYTXacNhan = false,
                    DuocHuongBHYT = false,
                    DonGiaBHYT = 0,
                    TiLeBaoHiemThanhToan = 0,
                    MucHuongBaoHiem = 0,
                    SoTienMG = s.SoTienMienGiam.GetValueOrDefault(),
                    TongCongNo = s.SoTienBaoHiemTuNhanChiTra.GetValueOrDefault(),
                    DaThanhToan = s.SoTienBenhNhanDaChi.GetValueOrDefault(),
                    NoiThucHien = string.Empty,
                    CheckedDefault = true,
                    KiemTraHuy = s.TrangThai == Enums.EnumTrangThaiYeuCauGoiDichVu.DaThucHien || s.TrangThai == Enums.EnumTrangThaiYeuCauGoiDichVu.DaHuy,
                    TrangThai = s.TrangThai.GetDescription(),

                    DanhSachMienGiamVos = (s.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || s.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan) ? new List<DanhSachMienGiamVo>() :
                        s.MienGiamChiPhis.Count == 0 ? new List<DanhSachMienGiamVo>() : s.MienGiamChiPhis.GroupBy(o => new { o.LoaiMienGiam, o.TheVoucherId, o.MaTheVoucher, o.DoiTuongUuDaiId, o.LoaiChietKhau }, o => o,
                            (k, v) => new DanhSachMienGiamVo
                            {
                                LoaiMienGiam = k.LoaiMienGiam,
                                LoaiChietKhau = k.LoaiChietKhau,
                                TheVoucherId = k.TheVoucherId,
                                MaTheVoucher = k.MaTheVoucher,
                                DoiTuongUuDaiId = k.DoiTuongUuDaiId,
                                TiLe = v.Select(o => o.TiLe).DefaultIfEmpty().Sum(),
                                SoTien = v.Select(o => o.SoTien).DefaultIfEmpty().Sum()
                            }).Where(o => o.SoTien != 0),
                    GhiChuMienGiamThem = s.GhiChuMienGiamThem,
                    NoiDungGhiChuMiemGiamId = s.NoiDungGhiChuMiemGiamId,
                    TaiKhoanBenhNhanChiDetails = s.TaiKhoanBenhNhanChis.Select(t => new TaiKhoanBenhNhanChiDetail
                    {
                        NguoiThu = t != null && t.NhanVienThucHienId != null ? nguoiThus[t.NhanVienThucHienId ?? 0].HoTen : string.Empty,
                        ThoiGianThuStr = t.NgayChi.ApplyFormatDate(),
                        SoPhieu = t != null ? t.SoPhieu.HasValue ? int.Parse(t.SoPhieu.ToString()) : int.Parse(t.Id.ToString()) : 1,
                    }).ToList()
                }).ToListAsync();

            await Task.WhenAll(queryDichVuKhamBenh, queryDichVuKyThuat, queryDichVuGiuong, queryDuocPham, queryVatTu, queryToaThuoc/*, queryGoiDichVu*/);
            var result = new List<ChiPhiDaThanhToanKhamChuaBenhVo>();
            result.AddRange(queryDichVuKhamBenh.Result);
            result.AddRange(queryDichVuKyThuat.Result);
            result.AddRange(queryDichVuGiuong.Result);
            result.AddRange(queryDuocPham.Result);
            result.AddRange(queryVatTu.Result);
            result.AddRange(queryToaThuoc.Result);
            result.AddRange(queryGoiDichVu.Result);
            return result;

        }

        #endregion

        #region In báo cáo cho phần thu ngân


        public string GetHtmlPhieuThuBenhNhanTraTien(long id, string hostingName)
        {
            var currentUserId = _userAgentHelper.GetCurrentUserId();
            var nguoiLapPhieu = _useRepository.GetById(currentUserId).HoTen;

            var result = _templateRepository.TableNoTracking
                .FirstOrDefault(x => x.Name.Equals("PhieuThuBenhNhanTraTien"));

            var taiKhoanBenhNhanThu = _taiKhoanBenhNhanThu.TableNoTracking.Where(c =>
                    c.Id == id && c.LoaiThuTienBenhNhan == Enums.LoaiThuTienBenhNhan.ThuNo)
                .Include(cc => cc.YeuCauTiepNhan)
                .ThenInclude(cc => cc.PhuongXa)
                .Include(cc => cc.YeuCauTiepNhan)
                .ThenInclude(cc => cc.QuanHuyen)
                .Include(cc => cc.YeuCauTiepNhan)
                .ThenInclude(cc => cc.TinhThanh).FirstOrDefault();

            var soTienThu = taiKhoanBenhNhanThu?.ChuyenKhoan + taiKhoanBenhNhanThu?.POS +
                               taiKhoanBenhNhanThu?.TienMat;


            var diaChi = taiKhoanBenhNhanThu?.YeuCauTiepNhan.DiaChiDayDu;


            var data = new
            {
                LogoUrl = hostingName + "/assets/img/logo-bacha-full.png",
                NguoiNopTien = taiKhoanBenhNhanThu?.YeuCauTiepNhan.HoTen,
                NamSinh = DateHelper.DOBFormat(taiKhoanBenhNhanThu?.YeuCauTiepNhan?.NgaySinh, taiKhoanBenhNhanThu?.YeuCauTiepNhan?.ThangSinh, taiKhoanBenhNhanThu?.YeuCauTiepNhan?.NamSinh),
                GioiTinh = taiKhoanBenhNhanThu?.YeuCauTiepNhan.GioiTinh.GetDescription(),
                DiaChi = diaChi,
                DienDai = taiKhoanBenhNhanThu?.NoiDungThu,
                SoQuyen = taiKhoanBenhNhanThu?.SoQuyen,
                SoPhieu = taiKhoanBenhNhanThu?.SoPhieuHienThi,
                ngayThangHientai = "Ngày " + DateTime.Now.Day + " tháng " + DateTime.Now.Month + " năm " +
                                   DateTime.Now.Year,

                SoTien = Convert.ToDouble(soTienThu).ApplyFormatMoneyToDouble(),
                ChungTu = "Cố định",
                NguoiLapPhieu = nguoiLapPhieu,
                GoiHienTai = DateTime.Now.Hour + ":" + DateTime.Now.Minute + ":" +
                             DateTime.Now.Second,
                SoTienBangChu = NumberHelper.ChuyenSoRaText(Convert.ToDouble(soTienThu))
            };

            var content = TemplateHelpper.FormatTemplateWithContentTemplate(result?.Body, data);
            return content;
        }

        public string GetHtmlPhieuChi(long id, string hostingName)
        {
            var currentUserId = _userAgentHelper.GetCurrentUserId();
            var nguoiLapPhieu = _useRepository.GetById(currentUserId).HoTen;

            var result = _templateRepository.TableNoTracking
                .FirstOrDefault(x => x.Name.Equals("PhieuChi"));
            var taiKhoanBenhNhanChi = _taiKhoanBenhNhanChi.TableNoTracking.Where(c => c.Id == id)
                .Include(cc => cc.YeuCauTiepNhan)
                .ThenInclude(cc => cc.PhuongXa)
                .Include(cc => cc.YeuCauTiepNhan)
                .ThenInclude(cc => cc.QuanHuyen)
                .Include(cc => cc.YeuCauTiepNhan)
                .ThenInclude(cc => cc.TinhThanh).Include(cc => cc.TaiKhoanBenhNhanThu).FirstOrDefault();

            var soTienChi = taiKhoanBenhNhanChi?.ChuyenKhoan + taiKhoanBenhNhanChi?.TienMat;

            var diaChi = taiKhoanBenhNhanChi?.YeuCauTiepNhan.DiaChiDayDu;
            var data = new
            {
                LogoUrl = hostingName + "/assets/img/logo-bacha-full.png",
                NguoiNopTien = taiKhoanBenhNhanChi?.YeuCauTiepNhan.HoTen,
                NamSinh = DateHelper.DOBFormat(taiKhoanBenhNhanChi?.YeuCauTiepNhan?.NgaySinh, taiKhoanBenhNhanChi?.YeuCauTiepNhan?.ThangSinh, taiKhoanBenhNhanChi?.YeuCauTiepNhan?.NamSinh),
                GioiTinh = taiKhoanBenhNhanChi?.YeuCauTiepNhan.GioiTinh.GetDescription(),
                DiaChi = diaChi,
                DienDai = taiKhoanBenhNhanChi?.NoiDungChi,
                SoQuyen = taiKhoanBenhNhanChi?.SoQuyen,
                SoPhieu = taiKhoanBenhNhanChi?.SoPhieuHienThi,
                ngayThangHientai = "Ngày " + DateTime.Now.Day + " tháng " + DateTime.Now.Month + " năm " +
                                   DateTime.Now.Year,

                //SoTien = soTienChi?.ToString("0,00"),

                SoTienPhaiChi = Convert.ToDouble(soTienChi).ApplyFormatMoneyToDouble(),
                TienMat = Convert.ToDouble(taiKhoanBenhNhanChi?.TienMat).ApplyFormatMoneyToDouble(),
                ChuyenKhoan = Convert.ToDouble(taiKhoanBenhNhanChi?.ChuyenKhoan).ApplyFormatMoneyToDouble(),
                ChungTu = "Cố định",
                NguoiLapPhieu = nguoiLapPhieu,
                GoiHienTai = DateTime.Now.Hour + ":" + DateTime.Now.Minute + ":" +
                             DateTime.Now.Second,
                SoTienBangChu = NumberHelper.ChuyenSoRaText(Convert.ToDouble(soTienChi))
            };

            var content = TemplateHelpper.FormatTemplateWithContentTemplate(result.Body, data);
            return content;
        }


        #endregion

        #region Phiếu In Tổng hợp

        public string GetHtmlPhieuChiPhiKhamBenhCoBHYT(long yeuCauTiepNhanId, string hostingName)
        {
            var yeuCauTiepNhanThongTin = BaseRepository.TableNoTracking.Where(cc =>
                                      cc.Id == yeuCauTiepNhanId &&
                                 (cc.YeuCauKhamBenhs.Any(o =>
                                   (o.TrangThaiThanhToan != Enums.TrangThaiThanhToan.HuyThanhToan))
                                  || cc.YeuCauDichVuKyThuats.Any(o =>
                                      (o.TrangThaiThanhToan != Enums.TrangThaiThanhToan.HuyThanhToan))
                                  || cc.YeuCauDichVuGiuongBenhViens.Any(o =>
                                      (o.TrangThaiThanhToan != Enums.TrangThaiThanhToan.HuyThanhToan))
                                  || cc.YeuCauDuocPhamBenhViens.Any(o =>
                                      (o.TrangThaiThanhToan != Enums.TrangThaiThanhToan.HuyThanhToan))
                                  //TODO: need update goi dv
                                  //|| cc.YeuCauGoiDichVus.Any(o =>
                                  //    (o.TrangThaiThanhToan != Enums.TrangThaiThanhToan.HuyThanhToan))
                                  || cc.DonThuocThanhToans.Any(o => o.LoaiDonThuoc == Enums.EnumLoaiDonThuoc.ThuocBHYT &&
                                      (o.TrangThaiThanhToan != Enums.TrangThaiThanhToan.HuyThanhToan))
                                 ))
                                 .Include(cc => cc.PhuongXa)
                                 .Include(cc => cc.QuanHuyen)
                                 .Include(cc => cc.TinhThanh)
                                 .Include(cc => cc.NoiChuyen)
                                 .Include(cc => cc.BenhNhan)
                                 .Include(cc => cc.YeuCauKhamBenhs).ThenInclude(c => c.BenhVienChuyenVien)
                                 .Include(cc => cc.YeuCauKhamBenhs).ThenInclude(c => c.Icdchinh)
                                 .Include(cc => cc.YeuCauKhamBenhs).ThenInclude(c => c.YeuCauKhamBenhICDKhacs).ThenInclude(c => c.ICD)
                                 .Include(cc => cc.YeuCauKhamBenhs).ThenInclude(c => c.NhomGiaDichVuKhamBenhBenhVien)
                                 .Include(cc => cc.YeuCauKhamBenhs).ThenInclude(cc => cc.DichVuKhamBenhBenhVien).ThenInclude(cc => cc.DichVuKhamBenhBenhVienGiaBaoHiems)
                                 .Include(cc => cc.YeuCauDichVuKyThuats).ThenInclude(c => c.NhomGiaDichVuKyThuatBenhVien)
                                 .Include(cc => cc.YeuCauDichVuKyThuats).ThenInclude(cc => cc.DichVuKyThuatBenhVien).ThenInclude(cc => cc.DichVuKyThuatBenhVienGiaBaoHiems)
                                 .Include(cc => cc.YeuCauDichVuGiuongBenhViens).ThenInclude(c => c.NhomGiaDichVuGiuongBenhVien)
                                 .Include(cc => cc.YeuCauDichVuGiuongBenhViens).ThenInclude(cc => cc.DichVuGiuongBenhVien).ThenInclude(cc => cc.DichVuGiuongBenhVienGiaBaoHiems)
                                 .Include(cc => cc.YeuCauDuocPhamBenhViens).ThenInclude(cc => cc.DuocPhamBenhVien).ThenInclude(cc => cc.DuocPham)
                                 //TODO: need update goi dv
                                 //.Include(cc => cc.YeuCauGoiDichVus).ThenInclude(cc => cc.GoiDichVu)
                                 .Include(cc => cc.DonThuocThanhToans).ThenInclude(cc => cc.DonThuocThanhToanChiTiets).ThenInclude(o => o.DuocPham).ThenInclude(o => o.DuocPhamBenhVien)
                                 .FirstOrDefault();

            var result = _templateRepository.TableNoTracking
                .FirstOrDefault(x => x.Name.Equals("TongHopPhieuKhamChiPhiKhamBenh"));

            if (yeuCauTiepNhanThongTin == null)
                return string.Empty;

            var benhVien = new Core.Domain.Entities.BenhVien.BenhVien();
            if (!String.IsNullOrEmpty(yeuCauTiepNhanThongTin.BHYTMaDKBD))
            {
                benhVien = _benhVienRepository.TableNoTracking
                  .FirstOrDefault(p => p.Ma.Equals(yeuCauTiepNhanThongTin.BHYTMaDKBD));
            }


            string coBhyt = string.Empty;
            string maBHYT = string.Empty;
            string bHYTTuNgay = string.Empty;
            string bHYTDenNgay = string.Empty;
            string mucHuong = string.Empty;
            string NoiDKKCBBanDau = string.Empty;
            string MaKCBBanDau = string.Empty;

            string icdchinh = string.Empty;
            string tenicdchinh = string.Empty;
            string icdKemTheos = string.Empty;
            string tenIcdKemTheos = string.Empty;

            if (yeuCauTiepNhanThongTin != null && yeuCauTiepNhanThongTin.CoBHYT != null && yeuCauTiepNhanThongTin.CoBHYT.Value)
            {
                maBHYT = yeuCauTiepNhanThongTin.BHYTMaSoThe;
                bHYTTuNgay = yeuCauTiepNhanThongTin.BHYTNgayHieuLuc?.ApplyFormatDate();
                bHYTDenNgay = yeuCauTiepNhanThongTin.BHYTNgayHetHan?.ApplyFormatDate();
                mucHuong = yeuCauTiepNhanThongTin.BHYTMucHuong.ToString() + "%";
                NoiDKKCBBanDau = benhVien != null ? benhVien?.Ten : "Chưa xác định";
                MaKCBBanDau = benhVien != null ? benhVien?.Ma : "Chưa xác định";

            }
            else
            {
                maBHYT = "";
                bHYTTuNgay = "";
                bHYTDenNgay = "";
                mucHuong = "0%";
                NoiDKKCBBanDau = "Chưa xác định";
                MaKCBBanDau = "Chưa xác định";
            }
            var yeuCauKhamBenh = yeuCauTiepNhanThongTin?.YeuCauKhamBenhs.Where(cc => cc.IcdchinhId != null).OrderBy(cc => cc.ThoiDiemHoanThanh).LastOrDefault();
            if (yeuCauKhamBenh != null)
            {
                icdchinh = yeuCauKhamBenh.Icdchinh.Ma;
                tenicdchinh = yeuCauKhamBenh.GhiChuICDChinh;

                var yeuCauKhamBenhICDKhacs = yeuCauKhamBenh.YeuCauKhamBenhICDKhacs.Select(c => c.ICD.Ma).ToList();
                var tenicdKemTheos = yeuCauKhamBenh.YeuCauKhamBenhICDKhacs.Select(c => c.GhiChu).ToList();

                icdKemTheos = string.Join(",", yeuCauKhamBenhICDKhacs);
                tenIcdKemTheos = string.Join(",", tenicdKemTheos);
            }


            var ycDieuTri = yeuCauTiepNhanThongTin?.YeuCauDichVuKyThuats.Where(cc => cc.DieuTriNgoaiTru == true).OrderBy(o => o.ThoiDiemBatDauDieuTri).FirstOrDefault();

            var yeuCauTiepNhanList = BaseRepository.TableNoTracking
                .Include(p => p.YeuCauKhamBenhs).ThenInclude(p => p.DichVuKhamBenhBenhVien).ThenInclude(p => p.DichVuKhamBenh)
                .Include(p => p.YeuCauKhamBenhs).ThenInclude(p => p.NhomGiaDichVuKhamBenhBenhVien)
                .Include(p => p.YeuCauKhamBenhs).ThenInclude(p => p.DichVuKhamBenhBenhVien).ThenInclude(p => p.DichVuKhamBenhBenhVienGiaBaoHiems)

                .Include(p => p.YeuCauDichVuKyThuats).ThenInclude(p => p.DichVuKyThuatBenhVien).ThenInclude(p => p.DichVuKyThuat)
                .Include(p => p.YeuCauDichVuKyThuats).ThenInclude(p => p.NhomGiaDichVuKyThuatBenhVien)
                .Include(p => p.YeuCauDichVuKyThuats).ThenInclude(p => p.DichVuKyThuatBenhVien).ThenInclude(p => p.DichVuKyThuatBenhVienGiaBaoHiems)

                .Include(p => p.YeuCauDuocPhamBenhViens).ThenInclude(p => p.DuocPhamBenhVien).ThenInclude(p => p.DuocPham)
                .Include(p => p.YeuCauDichVuGiuongBenhViens).ThenInclude(p => p.DichVuGiuongBenhVien).ThenInclude(p => p.DichVuGiuong)
                .Include(p => p.YeuCauDichVuGiuongBenhViens).ThenInclude(p => p.NhomGiaDichVuGiuongBenhVien)
                .Include(p => p.YeuCauDichVuGiuongBenhViens).ThenInclude(p => p.DichVuGiuongBenhVien).ThenInclude(p => p.DichVuGiuongBenhVienGiaBenhViens)
                .Include(p => p.YeuCauDichVuGiuongBenhViens).ThenInclude(p => p.DichVuGiuongBenhVien).ThenInclude(p => p.DichVuGiuongBenhVienGiaBaoHiems)
                .Include(p => p.DonThuocThanhToans).ThenInclude(p => p.DonThuocThanhToanChiTiets).ThenInclude(p => p.DuocPham).ThenInclude(p => p.DuocPhamBenhVien)
                .Include(p => p.DonThuocThanhToans).ThenInclude(p => p.DonThuocThanhToanChiTiets).ThenInclude(p => p.DonViTinh)
                .Where(p => p.Id == yeuCauTiepNhanId &&
                            p.CoBHYT == true && p.TrangThaiYeuCauTiepNhan != Enums.EnumTrangThaiYeuCauTiepNhan.DaHuy).FirstOrDefault();

            var listXacNhanBHYT = new List<ThongTinChiTietKhamChuaBenhCoBHYTVo>();
            if (yeuCauTiepNhanList == null)
                return String.Empty;
            var sttKham = 0;
            foreach (var yeuCau in yeuCauTiepNhanList?.YeuCauKhamBenhs.Where(p => p.DuocHuongBaoHiem == true && p.BaoHiemChiTra != false && p.YeuCauGoiDichVuId == null && p.GoiKhamSucKhoeId == null && p.TrangThai != Enums.EnumTrangThaiYeuCauKhamBenh.HuyKham).OrderBy(o => o.Id))
            {
                var dgbh = yeuCau.DichVuKhamBenhBenhVien?.DichVuKhamBenhBenhVienGiaBaoHiems
                               .Where(x => x.TuNgay <= DateTime.Now && (x.DenNgay >= DateTime.Now || x.DenNgay == null))
                               .LastOrDefault();
                var thongTinYeuCauKhamBenh = new ThongTinChiTietKhamChuaBenhCoBHYTVo
                {
                    Id = yeuCau.Id,
                    NoiDung = yeuCau.DichVuKhamBenhBenhVien?.Ten,
                    DonViTinh = "Lần",
                    SoLuong = 1,
                    Nhom = NhomChiPhiKhamChuaBenh.DichVuKhamBenh,
                    DonGiaBH = yeuCau.DonGiaBaoHiem.GetValueOrDefault(),
                    TiLeThanhToanBHYT = yeuCau.MucHuongBaoHiem.GetValueOrDefault(),
                    TiLeThanhToanTheoDV = yeuCau.TiLeBaoHiemThanhToan.GetValueOrDefault(),
                    QuyBHYT = yeuCau.DonGiaBaoHiem.GetValueOrDefault() * yeuCau.TiLeBaoHiemThanhToan.GetValueOrDefault() / 100 * yeuCau.MucHuongBaoHiem.GetValueOrDefault() / 100,
                    BaoHiemChiTra = yeuCau.BaoHiemChiTra,
                    DuocHuongBaoHiem = yeuCau.DuocHuongBaoHiem,
                    YeuCauGoiDichVuId = yeuCau.YeuCauGoiDichVuId,
                    TrangThaiKhamBenh = yeuCau.TrangThai
                };
                listXacNhanBHYT.Add(thongTinYeuCauKhamBenh);
                sttKham++;
            }


            foreach (var yeuCau in yeuCauTiepNhanList?.YeuCauDichVuKyThuats.Where(p => p.DuocHuongBaoHiem == true && p.BaoHiemChiTra != false && p.YeuCauGoiDichVuId == null && p.GoiKhamSucKhoeId == null && p.TrangThai != Enums.EnumTrangThaiYeuCauDichVuKyThuat.DaHuy).OrderBy(o => o.Id))
            {
                var dgbh = yeuCau.DichVuKyThuatBenhVien?.DichVuKyThuatBenhVienGiaBaoHiems
                               .Where(x => x.TuNgay <= DateTime.Now && (x.DenNgay >= DateTime.Now || x.DenNgay == null))
                               .LastOrDefault();
                var thongTinYeuCauKhamBenh = new ThongTinChiTietKhamChuaBenhCoBHYTVo
                {
                    Id = yeuCau.Id,
                    NoiDung = yeuCau.DichVuKyThuatBenhVien?.Ten,
                    DonViTinh = "Lần",
                    SoLuong = yeuCau.SoLan,
                    Nhom = NhomChiPhiKhamChuaBenh.DichVuKyThuat,
                    DonGiaBH = yeuCau.DonGiaBaoHiem.GetValueOrDefault(),
                    TiLeThanhToanBHYT = yeuCau.MucHuongBaoHiem.GetValueOrDefault(),
                    TiLeThanhToanTheoDV = yeuCau.TiLeBaoHiemThanhToan.GetValueOrDefault(),
                    QuyBHYT = yeuCau.DonGiaBaoHiem.GetValueOrDefault() * yeuCau.TiLeBaoHiemThanhToan.GetValueOrDefault() / 100 * yeuCau.MucHuongBaoHiem.GetValueOrDefault() / 100 * yeuCau.SoLan,
                    BaoHiemChiTra = yeuCau.BaoHiemChiTra,
                    DuocHuongBaoHiem = yeuCau.DuocHuongBaoHiem
                };
                listXacNhanBHYT.Add(thongTinYeuCauKhamBenh);
            }


            foreach (var yeuCau in yeuCauTiepNhanList?.YeuCauDuocPhamBenhViens.Where(p => p.DuocHuongBaoHiem == true && p.BaoHiemChiTra != false && p.YeuCauGoiDichVuId == null && p.TrangThai != Enums.EnumYeuCauDuocPhamBenhVien.DaHuy).OrderBy(o => o.Id))
            {
                var thongTinYeuCauKhamBenh = new ThongTinChiTietKhamChuaBenhCoBHYTVo
                {
                    Id = yeuCau.Id,
                    NoiDung = yeuCau.DuocPhamBenhVien?.DuocPham.Ten,
                    DonViTinh = "Lần",
                    SoLuong = (decimal)yeuCau.SoLuong,
                    Nhom = NhomChiPhiKhamChuaBenh.DuocPham,
                    DonGiaBH = yeuCau.DonGiaBaoHiem.GetValueOrDefault(),
                    TiLeThanhToanBHYT = yeuCau.MucHuongBaoHiem.GetValueOrDefault(),
                    TiLeThanhToanTheoDV = yeuCau.TiLeBaoHiemThanhToan.GetValueOrDefault(),
                    QuyBHYT = yeuCau.DonGiaBaoHiem.GetValueOrDefault() * yeuCau.TiLeBaoHiemThanhToan.GetValueOrDefault() / 100 * yeuCau.MucHuongBaoHiem.GetValueOrDefault() / 100 * (decimal)yeuCau.SoLuong,
                    BaoHiemChiTra = yeuCau.BaoHiemChiTra,
                    DuocHuongBaoHiem = yeuCau.DuocHuongBaoHiem
                };
                listXacNhanBHYT.Add(thongTinYeuCauKhamBenh);
            }

            foreach (var yeuCau in yeuCauTiepNhanList?.YeuCauVatTuBenhViens.Where(p => p.DuocHuongBaoHiem == true && p.BaoHiemChiTra != false && p.YeuCauGoiDichVuId == null && p.TrangThai != Enums.EnumYeuCauVatTuBenhVien.DaHuy).OrderBy(o => o.Id))
            {
                var thongTinYeuCauKhamBenh = new ThongTinChiTietKhamChuaBenhCoBHYTVo
                {
                    Id = yeuCau.Id,
                    NoiDung = yeuCau.VatTuBenhVien?.VatTus.Ten,
                    DonViTinh = "Lần",
                    SoLuong = (decimal)yeuCau.SoLuong,
                    Nhom = NhomChiPhiKhamChuaBenh.VatTuTieuHao,
                    DonGiaBH = yeuCau.DonGiaBaoHiem.GetValueOrDefault(),
                    TiLeThanhToanBHYT = yeuCau.MucHuongBaoHiem.GetValueOrDefault(),
                    TiLeThanhToanTheoDV = yeuCau.TiLeBaoHiemThanhToan.GetValueOrDefault(),
                    QuyBHYT = yeuCau.DonGiaBaoHiem.GetValueOrDefault() * yeuCau.TiLeBaoHiemThanhToan.GetValueOrDefault() / 100 * yeuCau.MucHuongBaoHiem.GetValueOrDefault() / 100 * (decimal)yeuCau.SoLuong,
                    BaoHiemChiTra = yeuCau.BaoHiemChiTra,
                    DuocHuongBaoHiem = yeuCau.DuocHuongBaoHiem
                };
                listXacNhanBHYT.Add(thongTinYeuCauKhamBenh);
            }

            foreach (var yeuCau in yeuCauTiepNhanList?.YeuCauDichVuGiuongBenhViens.Where(p => p.DuocHuongBaoHiem == true && p.BaoHiemChiTra != false && p.YeuCauGoiDichVuId == null && p.TrangThai != Enums.EnumTrangThaiGiuongBenh.DaHuy).OrderBy(o => o.Id))
            {
                var dgbh = yeuCau.DichVuGiuongBenhVien?.DichVuGiuongBenhVienGiaBaoHiems
                               .Where(x => x.TuNgay <= DateTime.Now && (x.DenNgay >= DateTime.Now || x.DenNgay == null))
                               .LastOrDefault();
                var thongTinYeuCauKhamBenh = new ThongTinChiTietKhamChuaBenhCoBHYTVo
                {
                    Id = yeuCau.Id,
                    NoiDung = yeuCau.DichVuGiuongBenhVien?.Ten,
                    DonViTinh = "Lần",
                    SoLuong = 1,
                    Nhom = NhomChiPhiKhamChuaBenh.DichVuGiuong,
                    DonGiaBH = yeuCau.DonGiaBaoHiem.GetValueOrDefault(),
                    TiLeThanhToanBHYT = yeuCau.MucHuongBaoHiem.GetValueOrDefault(),
                    TiLeThanhToanTheoDV = yeuCau.TiLeBaoHiemThanhToan.GetValueOrDefault(),
                    QuyBHYT = yeuCau.DonGiaBaoHiem.GetValueOrDefault() * yeuCau.TiLeBaoHiemThanhToan.GetValueOrDefault() / 100 * yeuCau.MucHuongBaoHiem.GetValueOrDefault() / 100,
                    BaoHiemChiTra = yeuCau.BaoHiemChiTra,
                    DuocHuongBaoHiem = yeuCau.DuocHuongBaoHiem,
                };
                listXacNhanBHYT.Add(thongTinYeuCauKhamBenh);
            }


            foreach (var yeuCau in yeuCauTiepNhanList?.DonThuocThanhToans.Where(o => o.TrangThai != Enums.TrangThaiDonThuocThanhToan.DaHuy).SelectMany(cc => cc.DonThuocThanhToanChiTiets).Where(p => p.DuocHuongBaoHiem == true && p.BaoHiemChiTra != false).OrderBy(o => o.Id))
            {
                var thongTinYeuCauKhamBenh = new ThongTinChiTietKhamChuaBenhCoBHYTVo
                {
                    Id = yeuCau.Id,
                    NoiDung = yeuCau?.Ten,
                    DonViTinh = yeuCau.DonViTinh.Ten,
                    SoLuong = (decimal)yeuCau.SoLuong,
                    Nhom = NhomChiPhiKhamChuaBenh.ToaThuoc,
                    DonGiaBH = yeuCau.DonGiaBaoHiem.GetValueOrDefault(),
                    TiLeThanhToanBHYT = yeuCau.MucHuongBaoHiem.GetValueOrDefault(),
                    TiLeThanhToanTheoDV = yeuCau.TiLeBaoHiemThanhToan.GetValueOrDefault(),
                    QuyBHYT = yeuCau.DonGiaBaoHiem.GetValueOrDefault() * yeuCau.TiLeBaoHiemThanhToan.GetValueOrDefault() / 100 * yeuCau.MucHuongBaoHiem.GetValueOrDefault() / 100 * (decimal)yeuCau.SoLuong,
                    BaoHiemChiTra = yeuCau.BaoHiemChiTra,
                    DuocHuongBaoHiem = yeuCau.DuocHuongBaoHiem
                };
                listXacNhanBHYT.Add(thongTinYeuCauKhamBenh);
            }


            var dateItemChiPhis = string.Empty;
            //Bind yêu cầu khám bệnh lên html
            int index = 1;
            int indexItem = 1;

            var xacNhanBhytGroup = listXacNhanBHYT.GroupBy(x => x.Nhom);
            var checkDataBHYT = false;
            foreach (var xacNhanBhyt in xacNhanBhytGroup)
            {
                dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                   "<td style='border: 1px solid #020000;' colspan='6'>" +
                                   "<span style='float:left;'><b>" + index + "." + xacNhanBhyt.Key.GetDescription() + "  </b></span>" +
                                   "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(xacNhanBhyt.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                   "<td style='border: 1px solid #020000;text-align: right;'> </td>" +
                                   "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(xacNhanBhyt.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                   "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(xacNhanBhyt.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                   "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(xacNhanBhyt.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                   "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(xacNhanBhyt.Sum(o => o.Khac)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                   "<td style='border: 1px solid #020000;text-align: right;'><b> " + Convert.ToDouble(xacNhanBhyt.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true) + "</b> </td>" +
                                   "</tr>";
                foreach (var groupYeuCauKhamBenh in xacNhanBhyt)
                {
                    checkDataBHYT = true;
                    dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                          "<td style='border: 1px solid #020000;text-align: left;'>- " + groupYeuCauKhamBenh.NoiDung + "</td>" +
                                          "<td style='border: 1px solid #020000;text-align: center;'>  " + groupYeuCauKhamBenh.DonViTinh + " </td>" +
                                          "<td style='border: 1px solid #020000;text-align: center;'> " + groupYeuCauKhamBenh.SoLuong + "</td>" +
                                          "<td style='border: 1px solid #020000;text-align: center;'> " + Convert.ToDouble(groupYeuCauKhamBenh.DonGiaBV).ApplyFormatMoneyToDouble() + "</td>" +
                                          "<td style='border: 1px solid #020000;text-align: center;'> " + Convert.ToDouble(groupYeuCauKhamBenh.DonGiaBH).ApplyFormatMoneyToDouble() + "</td>" +
                                          "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(groupYeuCauKhamBenh.TiLeThanhToanTheoDV).ApplyFormatMoneyToDouble() + "</td>" +
                                          "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(groupYeuCauKhamBenh.ThanhTienBV).ApplyFormatMoneyToDouble() + "</td>" +
                                          "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(groupYeuCauKhamBenh.TiLeThanhToanBHYT).ApplyFormatMoneyToDouble() + "</td>" +
                                          "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(groupYeuCauKhamBenh.ThanhTienBH).ApplyFormatMoneyToDouble() + "</td>" +
                                          "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(groupYeuCauKhamBenh.QuyBHYT).ApplyFormatMoneyToDouble() + "</td>" +
                                          "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(groupYeuCauKhamBenh.NguoiBenhCungChiTra).ApplyFormatMoneyToDouble() + "</td>" +
                                          "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(groupYeuCauKhamBenh.Khac).ApplyFormatMoneyToDouble() + "</td>" +
                                          "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(groupYeuCauKhamBenh.NguoiBenhTuTra).ApplyFormatMoneyToDouble(true) + "</td>" +
                                          "</tr>";
                    indexItem++;
                }
                index++;
            }



            var diaChi = yeuCauTiepNhanThongTin.DiaChiDayDu;

            if (yeuCauTiepNhanThongTin != null)
            {

                var checkedLyDoVaoVien = "<input id='demo_box_2' class='css - checkbox' type='checkbox' checked  disabled='true'/>";
                var unCheckedLyDoVaoVien = "<input id='demo_box_2' class='css - checkbox' type='checkbox' disabled='true' />";
                var data = new
                {
                    MaBN = yeuCauTiepNhanThongTin.BenhNhan.MaBN,
                    MaTN = yeuCauTiepNhanThongTin.MaYeuCauTiepNhan,
                    HoTen = yeuCauTiepNhanThongTin.HoTen,
                    DiaChi = diaChi,
                    BarCodeImgBase64 = !string.IsNullOrEmpty(yeuCauTiepNhanThongTin.MaYeuCauTiepNhan) ? BarcodeHelper.GenerateBarCode(yeuCauTiepNhanThongTin.MaYeuCauTiepNhan) : "",
                    NamSinh = DateHelper.DOBFormat(yeuCauTiepNhanThongTin.NgaySinh, yeuCauTiepNhanThongTin.ThangSinh, yeuCauTiepNhanThongTin.NamSinh),
                    GioiTinh = yeuCauTiepNhanThongTin.GioiTinh != null ? yeuCauTiepNhanThongTin.GioiTinh.GetDescription() : "",
                    CoBHYT = coBhyt,
                    BHYTTuNgay = bHYTTuNgay,
                    BHYTDenNgay = bHYTDenNgay,
                    NoiDKKCBBanDau = NoiDKKCBBanDau,
                    MaKCBBanDau = MaKCBBanDau,
                    TinhTrangRaVien = 1,
                    MucHuong = mucHuong,
                    NgayDenKham = yeuCauTiepNhanThongTin.CreatedOn.Value.Hour + " giờ " + yeuCauTiepNhanThongTin.CreatedOn.Value.Minute + " phút " + ", ngày " + yeuCauTiepNhanThongTin.CreatedOn.Value.ApplyFormatDate(),
                    KetThucKhamNgoaiTru = yeuCauTiepNhanThongTin.TrangThaiYeuCauTiepNhan == Enums.EnumTrangThaiYeuCauTiepNhan.DaHoanTat ? yeuCauTiepNhanThongTin.ThoiDiemCapNhatTrangThai.ApplyFormatDate() : "",
                    MaBHYT = yeuCauTiepNhanThongTin.BHYTMaSoThe,
                    LyDoVaoVien = yeuCauTiepNhanThongTin.LyDoVaoVien.GetDescription(),
                    TongSoNgayDieuTri = 1,

                    SoNgayDTri = Math.Round((yeuCauTiepNhanThongTin.TrangThaiYeuCauTiepNhan != Enums.EnumTrangThaiYeuCauTiepNhan.DaHoanTat ? DateTime.Now.Date - yeuCauTiepNhanThongTin.CreatedOn.Value.Date :
                    yeuCauTiepNhanThongTin.ThoiDiemCapNhatTrangThai - yeuCauTiepNhanThongTin.CreatedOn.Value.Date).TotalDays) == 0 ? 1 :
                    Math.Round((yeuCauTiepNhanThongTin.TrangThaiYeuCauTiepNhan != Enums.EnumTrangThaiYeuCauTiepNhan.DaHoanTat ? DateTime.Now.Date - yeuCauTiepNhanThongTin.CreatedOn.Value.Date :
                    yeuCauTiepNhanThongTin.ThoiDiemCapNhatTrangThai - yeuCauTiepNhanThongTin.CreatedOn.Value.Date).TotalDays),

                    NoiChuyenDen = yeuCauTiepNhanThongTin.NoiChuyen?.Ten,
                    MKV = yeuCauTiepNhanThongTin.BHYTMaKhuVuc,
                    ChuanDoanXacDinh = tenicdchinh,
                    MaICD10 = icdchinh,
                    BenhKemTheo = tenIcdKemTheos,
                    ICDKemTheo10 = icdKemTheos,
                    DateItemChiPhis = dateItemChiPhis,
                    TTDV = Convert.ToDouble(listXacNhanBHYT.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble(),
                    DieuTriKNT = ycDieuTri?.ThoiDiemBatDauDieuTri?.ApplyFormatDate(),
                    TTTTBHYT = "",
                    NoiChuyenDi = yeuCauKhamBenh != null ? yeuCauKhamBenh.BenhVienChuyenVien?.Ten : string.Empty,
                    TTTienBH = Convert.ToDouble(listXacNhanBHYT.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble(),
                    TQBHYT = Convert.ToDouble(listXacNhanBHYT.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble(),
                    TNCCTra = Convert.ToDouble(listXacNhanBHYT.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble(),
                    TongSoKhac = Convert.ToDouble(listXacNhanBHYT.Sum(o => o.Khac)).ApplyFormatMoneyToDouble(),
                    TNBTuTra = Convert.ToDouble(listXacNhanBHYT.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(),
                    NgayMiemCungTC = yeuCauTiepNhanThongTin.BHYTNgayDuocMienCungChiTra != null ? yeuCauTiepNhanThongTin.BHYTNgayDuocMienCungChiTra.Value.ApplyFormatDate() : "",
                    CoCapCuu = yeuCauTiepNhanThongTin.LyDoVaoVien == Enums.EnumLyDoVaoVien.CapCuu ? checkedLyDoVaoVien : unCheckedLyDoVaoVien,
                    CoDungTuyen = yeuCauTiepNhanThongTin.LyDoVaoVien == Enums.EnumLyDoVaoVien.DungTuyen ? checkedLyDoVaoVien : unCheckedLyDoVaoVien,
                    CoThongTuyen = yeuCauTiepNhanThongTin.LyDoVaoVien == Enums.EnumLyDoVaoVien.ThongTuyen ? checkedLyDoVaoVien : unCheckedLyDoVaoVien,
                    CoTraiTuyen = yeuCauTiepNhanThongTin.LyDoVaoVien == Enums.EnumLyDoVaoVien.TraiTuyen ? checkedLyDoVaoVien : unCheckedLyDoVaoVien,
                    ThoiGian5Nam = yeuCauTiepNhanThongTin.BHYTNgayDu5Nam != null ? yeuCauTiepNhanThongTin.BHYTNgayDu5Nam.Value.ApplyFormatDate() : "",
                    TongChiPhi = Convert.ToDouble(listXacNhanBHYT.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble(),
                    NguoiBenhPhaiTra = (Convert.ToDouble(listXacNhanBHYT.Sum(o => o.NguoiBenhCungChiTra)) +
                     Convert.ToDouble(listXacNhanBHYT.Sum(o => o.Khac))).ApplyFormatMoneyToDouble(),
                    SoTienBangChu = NumberHelper.ChuyenSoRaText(Convert.ToDouble(listXacNhanBHYT.Sum(o => o.ThanhTienBV))),
                    TTQuyTT = Convert.ToDouble(listXacNhanBHYT.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble(),
                    BHYTChiTra = Convert.ToDouble(listXacNhanBHYT.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble(),
                    CacKhoanTraKhac = Convert.ToDouble(listXacNhanBHYT.Sum(o => o.Khac)).ApplyFormatMoneyToDouble(),
                    SoTienKhac = 0
                };
                if (checkDataBHYT)
                {
                    var content = TemplateHelpper.FormatTemplateWithContentTemplate(result?.Body, data);
                    return content;
                }
                else
                {
                    return String.Empty;
                }
            }
            return String.Empty;
        }

        public string GetHtmlPhieuChiPhiKhamBenh(long yeuCauTiepNhanId, string hostingName)
        {
            var yeuCauTiepNhan = BaseRepository.TableNoTracking.Where(cc => cc.Id == yeuCauTiepNhanId &&
                                 (cc.YeuCauKhamBenhs.Any(o =>
                                      (o.TrangThaiThanhToan != Enums.TrangThaiThanhToan.HuyThanhToan))
                                  || cc.YeuCauDichVuKyThuats.Any(o =>
                                      (o.TrangThaiThanhToan != Enums.TrangThaiThanhToan.HuyThanhToan))
                                  || cc.YeuCauDichVuGiuongBenhViens.Any(o =>
                                      (o.TrangThaiThanhToan != Enums.TrangThaiThanhToan.HuyThanhToan))
                                  || cc.YeuCauDuocPhamBenhViens.Any(o =>
                                      (o.TrangThaiThanhToan != Enums.TrangThaiThanhToan.HuyThanhToan))
                                  //TODO: need update goi dv
                                  //|| cc.YeuCauGoiDichVus.Any(o =>
                                  //    (o.TrangThaiThanhToan != Enums.TrangThaiThanhToan.HuyThanhToan))
                                  || cc.DonThuocThanhToans.Any(o => o.LoaiDonThuoc == Enums.EnumLoaiDonThuoc.ThuocBHYT &&
                                      (o.TrangThaiThanhToan != Enums.TrangThaiThanhToan.HuyThanhToan))
                                 ))
                                  .Include(cc => cc.PhuongXa)
                                 .Include(cc => cc.QuanHuyen)
                                 .Include(cc => cc.TinhThanh)
                                 .Include(cc => cc.NoiChuyen)
                                 .Include(cc => cc.BenhNhan)
                                 .Include(cc => cc.YeuCauKhamBenhs).ThenInclude(c => c.BenhVienChuyenVien)
                                 .Include(cc => cc.YeuCauKhamBenhs).ThenInclude(c => c.Icdchinh)
                                 .Include(cc => cc.YeuCauKhamBenhs).ThenInclude(c => c.YeuCauKhamBenhICDKhacs).ThenInclude(c => c.ICD)
                                 .Include(cc => cc.YeuCauKhamBenhs).ThenInclude(c => c.NhomGiaDichVuKhamBenhBenhVien)
                                 .Include(cc => cc.YeuCauKhamBenhs).ThenInclude(cc => cc.DichVuKhamBenhBenhVien).ThenInclude(cc => cc.DichVuKhamBenhBenhVienGiaBaoHiems)
                                 .Include(cc => cc.YeuCauDichVuKyThuats).ThenInclude(c => c.NhomGiaDichVuKyThuatBenhVien)
                                 .Include(cc => cc.YeuCauDichVuKyThuats).ThenInclude(cc => cc.DichVuKyThuatBenhVien).ThenInclude(cc => cc.DichVuKyThuatBenhVienGiaBaoHiems)
                                 .Include(cc => cc.YeuCauDichVuGiuongBenhViens).ThenInclude(c => c.NhomGiaDichVuGiuongBenhVien)
                                 .Include(cc => cc.YeuCauDichVuGiuongBenhViens).ThenInclude(cc => cc.DichVuGiuongBenhVien).ThenInclude(cc => cc.DichVuGiuongBenhVienGiaBaoHiems)
                                 .Include(cc => cc.YeuCauDuocPhamBenhViens).ThenInclude(cc => cc.DuocPhamBenhVien).ThenInclude(cc => cc.DuocPham)
                                 //TODO: need update goi dv
                                 //.Include(cc => cc.YeuCauGoiDichVus).ThenInclude(cc => cc.GoiDichVu)
                                 .Include(cc => cc.DonThuocThanhToans).ThenInclude(cc => cc.DonThuocThanhToanChiTiets).ThenInclude(o => o.DuocPham).ThenInclude(o => o.DuocPhamBenhVien)
                                 .Include(cc => cc.DonThuocThanhToans).ThenInclude(cc => cc.DonThuocThanhToanChiTiets).ThenInclude(o => o.DonViTinh)
                                 .FirstOrDefault();

            var result = _templateRepository.TableNoTracking
                .FirstOrDefault(x => x.Name.Equals("TongHopPhieuKhamChiPhiKhamBenh"));
            if (yeuCauTiepNhan == null)
                return string.Empty;

            var benhVien = new Core.Domain.Entities.BenhVien.BenhVien();
            if (!String.IsNullOrEmpty(yeuCauTiepNhan.BHYTMaDKBD))
            {
                benhVien = _benhVienRepository.TableNoTracking
                  .FirstOrDefault(p => p.Ma.Equals(yeuCauTiepNhan.BHYTMaDKBD));
            }

            string coBhyt = string.Empty;
            string maBHYT = string.Empty;
            string bHYTTuNgay = string.Empty;
            string bHYTDenNgay = string.Empty;
            string mucHuong = string.Empty;
            string NoiDKKCBBanDau = string.Empty;
            string MaKCBBanDau = string.Empty;
            string icdchinh = string.Empty;
            string tenicdchinh = string.Empty;
            string icdKemTheos = string.Empty;
            string tenIcdKemTheos = string.Empty;

            if (yeuCauTiepNhan != null && yeuCauTiepNhan.CoBHYT != null && yeuCauTiepNhan.CoBHYT.Value)
            {
                maBHYT = yeuCauTiepNhan.BHYTMaSoThe;
                bHYTTuNgay = yeuCauTiepNhan.BHYTNgayHieuLuc?.ApplyFormatDate();
                bHYTDenNgay = yeuCauTiepNhan.BHYTNgayHetHan?.ApplyFormatDate();
                mucHuong = yeuCauTiepNhan.BHYTMucHuong.ToString() + "%";
                NoiDKKCBBanDau = benhVien != null ? benhVien?.Ten : "Chưa xác định";
                MaKCBBanDau = benhVien != null ? benhVien?.Ma : "Chưa xác định";

            }
            else
            {
                maBHYT = "";
                bHYTTuNgay = "";
                bHYTDenNgay = "";
                mucHuong = "0%";
                NoiDKKCBBanDau = "Chưa xác định";
                MaKCBBanDau = "Chưa xác định";
            }

            var yeuCauKhamBenhICD = yeuCauTiepNhan?.YeuCauKhamBenhs.Where(cc => cc.Icdchinh != null).OrderBy(cc => cc.ThoiDiemHoanThanh).LastOrDefault();
            if (yeuCauKhamBenhICD != null)
            {
                icdchinh = yeuCauKhamBenhICD.Icdchinh.Ma;
                tenicdchinh = yeuCauKhamBenhICD.GhiChuICDChinh;

                var yeuCauKhamBenhICDKhacs = yeuCauKhamBenhICD.YeuCauKhamBenhICDKhacs.Select(c => c.ICD.Ma).ToList();
                var tenicdKemTheos = yeuCauKhamBenhICD.YeuCauKhamBenhICDKhacs.Select(c => c.GhiChu).ToList();

                icdKemTheos = string.Join(",", yeuCauKhamBenhICDKhacs);
                tenIcdKemTheos = string.Join(",", tenicdKemTheos);
            }

            var ycDieuTri = yeuCauTiepNhan?.YeuCauDichVuKyThuats.Where(cc => cc.DieuTriNgoaiTru == true).OrderBy(o => o.ThoiDiemBatDauDieuTri).FirstOrDefault();

            //thông tin cho tung dich vu khám bệnh
            var allData = new List<ThongTinChiTietKhamChuaBenhVo>();
            var yeuCauKhamBenhs = new List<ThongTinChiTietKhamChuaBenhVo>();
            var yeuCauDichVuKyThuats = new List<ThongTinChiTietKhamChuaBenhVo>();
            var yeuCauDichVuGiuongBenhViens = new List<ThongTinChiTietKhamChuaBenhVo>();
            var yeuCauDuocPhamBenhViens = new List<ThongTinChiTietKhamChuaBenhVo>();
            var yeuCauGoiDichVus = new List<ThongTinChiTietKhamChuaBenhVo>();
            var donThuocThanhToans = new List<ThongTinChiTietKhamChuaBenhVo>();


            var sttKham = 0;
            foreach (var yeuCau in yeuCauTiepNhan?.YeuCauKhamBenhs.Where(p => p.YeuCauGoiDichVuId == null && p.GoiKhamSucKhoeId == null && p.TrangThai != Enums.EnumTrangThaiYeuCauKhamBenh.HuyKham).OrderBy(o => o.Id))
            {
                DichVuKhamBenhBenhVienGiaBaoHiem dgbh = null;
                if (yeuCau.DuocHuongBaoHiem && yeuCau.BaoHiemChiTra != false)
                {
                    dgbh = yeuCau.DichVuKhamBenhBenhVien?.DichVuKhamBenhBenhVienGiaBaoHiems
                                                  .Where(x => x.TuNgay <= DateTime.Now && (x.DenNgay >= DateTime.Now || x.DenNgay == null))
                                                  .LastOrDefault();
                }

                var thongTinYeuCauKhamBenh = new ThongTinChiTietKhamChuaBenhVo
                {
                    Id = yeuCau.Id,
                    NoiDung = yeuCau.DichVuKhamBenhBenhVien?.Ten,
                    DonViTinh = "Lần",
                    SoLuong = 1,
                    Nhom = NhomChiPhiKhamChuaBenh.DichVuKhamBenh,
                    DuocHuongBaoHiem = yeuCau.DuocHuongBaoHiem,
                    YeuCauGoiDichVuId = yeuCau.YeuCauGoiDichVuId,
                };

                if (yeuCau.KhongTinhPhi == true)
                {
                    thongTinYeuCauKhamBenh.DonGiaBV = yeuCau.Gia;
                }
                else if (yeuCau.DuocHuongBaoHiem && yeuCau.BaoHiemChiTra != false)
                {
                    thongTinYeuCauKhamBenh.DonGiaBH = yeuCau.DonGiaBaoHiem;
                    thongTinYeuCauKhamBenh.TiLeThanhToanBHYT = yeuCau.MucHuongBaoHiem.GetValueOrDefault();
                    thongTinYeuCauKhamBenh.TiLeThanhToanTheoDV = yeuCau.TiLeBaoHiemThanhToan.GetValueOrDefault();
                    thongTinYeuCauKhamBenh.QuyBHYT = yeuCau.DonGiaBaoHiem.GetValueOrDefault() * yeuCau.TiLeBaoHiemThanhToan.GetValueOrDefault() / 100 * yeuCau.MucHuongBaoHiem.GetValueOrDefault() / 100;
                    thongTinYeuCauKhamBenh.BaoHiemChiTra = yeuCau.BaoHiemChiTra;
                    thongTinYeuCauKhamBenh.DonGiaBV = yeuCau.Gia;
                    thongTinYeuCauKhamBenh.ThanhTienBV = thongTinYeuCauKhamBenh.DonGiaBV * thongTinYeuCauKhamBenh.SoLuong;
                    sttKham++;
                }
                else
                {
                    thongTinYeuCauKhamBenh.DonGiaBV = yeuCau.Gia;
                    thongTinYeuCauKhamBenh.ThanhTienBV = thongTinYeuCauKhamBenh.DonGiaBV * thongTinYeuCauKhamBenh.SoLuong;
                }

                yeuCauKhamBenhs.Add(thongTinYeuCauKhamBenh);

            }

            foreach (var yeuCau in yeuCauTiepNhan?.YeuCauDichVuKyThuats.Where(p => p.YeuCauGoiDichVuId == null && p.GoiKhamSucKhoeId == null && p.TrangThai != Enums.EnumTrangThaiYeuCauDichVuKyThuat.DaHuy).OrderBy(o => o.Id))
            {
                DichVuKyThuatBenhVienGiaBaoHiem dgbh = null;
                if (yeuCau.DuocHuongBaoHiem && yeuCau.BaoHiemChiTra != false)
                {
                    dgbh = yeuCau.DichVuKyThuatBenhVien?.DichVuKyThuatBenhVienGiaBaoHiems
                                                  .Where(x => x.TuNgay <= DateTime.Now && (x.DenNgay >= DateTime.Now || x.DenNgay == null))
                                                  .LastOrDefault();
                }

                var thongTinYeuCauKhamBenh = new ThongTinChiTietKhamChuaBenhVo
                {
                    Id = yeuCau.Id,
                    NoiDung = yeuCau.DichVuKyThuatBenhVien?.Ten,
                    DonViTinh = "Lần",
                    SoLuong = yeuCau.SoLan,
                    Nhom = NhomChiPhiKhamChuaBenh.DichVuKyThuat,
                    DuocHuongBaoHiem = yeuCau.DuocHuongBaoHiem,
                    YeuCauGoiDichVuId = yeuCau.YeuCauGoiDichVuId,
                };

                if (yeuCau.DuocHuongBaoHiem && yeuCau.BaoHiemChiTra != false)
                {
                    thongTinYeuCauKhamBenh.DonGiaBH = yeuCau.DonGiaBaoHiem;
                    thongTinYeuCauKhamBenh.TiLeThanhToanBHYT = yeuCau.MucHuongBaoHiem.GetValueOrDefault();
                    thongTinYeuCauKhamBenh.TiLeThanhToanTheoDV = yeuCau.TiLeBaoHiemThanhToan.GetValueOrDefault();
                    thongTinYeuCauKhamBenh.QuyBHYT = yeuCau.DonGiaBaoHiem.GetValueOrDefault() * yeuCau.TiLeBaoHiemThanhToan.GetValueOrDefault() / 100 * yeuCau.MucHuongBaoHiem.GetValueOrDefault() / 100 * yeuCau.SoLan;
                    thongTinYeuCauKhamBenh.BaoHiemChiTra = yeuCau.BaoHiemChiTra;
                    thongTinYeuCauKhamBenh.DonGiaBV = yeuCau.Gia;
                    thongTinYeuCauKhamBenh.ThanhTienBV = thongTinYeuCauKhamBenh.DonGiaBV * thongTinYeuCauKhamBenh.SoLuong;
                }
                else
                {
                    thongTinYeuCauKhamBenh.DonGiaBV = yeuCau.Gia;
                    thongTinYeuCauKhamBenh.ThanhTienBV = thongTinYeuCauKhamBenh.DonGiaBV * thongTinYeuCauKhamBenh.SoLuong;

                }

                yeuCauKhamBenhs.Add(thongTinYeuCauKhamBenh);

            }

            foreach (var yeuCau in yeuCauTiepNhan?.YeuCauDichVuGiuongBenhViens.Where(p => p.YeuCauGoiDichVuId == null && p.TrangThai != Enums.EnumTrangThaiGiuongBenh.DaHuy).OrderBy(o => o.Id))
            {
                DichVuGiuongBenhVienGiaBaoHiem dgbh = null;
                if (yeuCau.DuocHuongBaoHiem && yeuCau.BaoHiemChiTra != false)
                {
                    dgbh = yeuCau.DichVuGiuongBenhVien?.DichVuGiuongBenhVienGiaBaoHiems
                                                  .Where(x => x.TuNgay <= DateTime.Now && (x.DenNgay >= DateTime.Now || x.DenNgay == null))
                                                  .LastOrDefault();
                }

                var thongTinYeuCauKhamBenh = new ThongTinChiTietKhamChuaBenhVo
                {
                    Id = yeuCau.Id,
                    NoiDung = yeuCau.DichVuGiuongBenhVien?.Ten,
                    DonViTinh = "Lần",
                    SoLuong = 1,
                    Nhom = NhomChiPhiKhamChuaBenh.DichVuGiuong,
                    DuocHuongBaoHiem = yeuCau.DuocHuongBaoHiem,
                    YeuCauGoiDichVuId = yeuCau.YeuCauGoiDichVuId,
                };

                if (yeuCau.DuocHuongBaoHiem && yeuCau.BaoHiemChiTra != false)
                {
                    thongTinYeuCauKhamBenh.DonGiaBH = yeuCau.DonGiaBaoHiem;
                    thongTinYeuCauKhamBenh.TiLeThanhToanBHYT = yeuCau.MucHuongBaoHiem.GetValueOrDefault();
                    thongTinYeuCauKhamBenh.TiLeThanhToanTheoDV = yeuCau.TiLeBaoHiemThanhToan.GetValueOrDefault();
                    thongTinYeuCauKhamBenh.QuyBHYT = yeuCau.DonGiaBaoHiem.GetValueOrDefault() * yeuCau.TiLeBaoHiemThanhToan.GetValueOrDefault() / 100 * yeuCau.MucHuongBaoHiem.GetValueOrDefault() / 100;
                    thongTinYeuCauKhamBenh.BaoHiemChiTra = yeuCau.BaoHiemChiTra;
                    thongTinYeuCauKhamBenh.DonGiaBV = yeuCau.Gia;
                    thongTinYeuCauKhamBenh.ThanhTienBV = thongTinYeuCauKhamBenh.DonGiaBV * thongTinYeuCauKhamBenh.SoLuong;
                }
                else
                {
                    thongTinYeuCauKhamBenh.DonGiaBV = yeuCau.Gia;
                    thongTinYeuCauKhamBenh.ThanhTienBV = thongTinYeuCauKhamBenh.DonGiaBV * thongTinYeuCauKhamBenh.SoLuong;

                }

                yeuCauKhamBenhs.Add(thongTinYeuCauKhamBenh);

            }

            foreach (var yeuCau in yeuCauTiepNhan?.YeuCauDuocPhamBenhViens.Where(p => p.YeuCauGoiDichVuId == null && p.TrangThai != Enums.EnumYeuCauDuocPhamBenhVien.DaHuy).OrderBy(o => o.Id))
            {
                var thongTinYeuCauKhamBenh = new ThongTinChiTietKhamChuaBenhVo
                {
                    Id = yeuCau.Id,
                    NoiDung = yeuCau.DuocPhamBenhVien?.DuocPham?.Ten,
                    DonViTinh = "Lần",
                    SoLuong = (decimal)yeuCau.SoLuong,
                    Nhom = NhomChiPhiKhamChuaBenh.DuocPham,
                    DuocHuongBaoHiem = yeuCau.DuocHuongBaoHiem,
                    YeuCauGoiDichVuId = yeuCau.YeuCauGoiDichVuId,
                };

                if (yeuCau.DuocHuongBaoHiem && yeuCau.BaoHiemChiTra != false)
                {
                    thongTinYeuCauKhamBenh.DonGiaBH = yeuCau.DonGiaBaoHiem;
                    thongTinYeuCauKhamBenh.TiLeThanhToanBHYT = yeuCau.MucHuongBaoHiem.GetValueOrDefault();
                    thongTinYeuCauKhamBenh.TiLeThanhToanTheoDV = yeuCau.TiLeBaoHiemThanhToan.GetValueOrDefault();
                    thongTinYeuCauKhamBenh.QuyBHYT = yeuCau.DonGiaBaoHiem.GetValueOrDefault() * yeuCau.TiLeBaoHiemThanhToan.GetValueOrDefault() / 100 * yeuCau.MucHuongBaoHiem.GetValueOrDefault() / 100 * (decimal)yeuCau.SoLuong;
                    thongTinYeuCauKhamBenh.BaoHiemChiTra = yeuCau.BaoHiemChiTra;
                    thongTinYeuCauKhamBenh.DonGiaBV = yeuCau.DonGiaBan;
                    thongTinYeuCauKhamBenh.ThanhTienBV = thongTinYeuCauKhamBenh.DonGiaBV * thongTinYeuCauKhamBenh.SoLuong;
                }
                else
                {
                    thongTinYeuCauKhamBenh.DonGiaBV = yeuCau.DonGiaBan;
                    thongTinYeuCauKhamBenh.ThanhTienBV = thongTinYeuCauKhamBenh.DonGiaBV * thongTinYeuCauKhamBenh.SoLuong;

                }

                yeuCauKhamBenhs.Add(thongTinYeuCauKhamBenh);

            }

            foreach (var yeuCau in yeuCauTiepNhan?.YeuCauVatTuBenhViens.Where(p => p.YeuCauGoiDichVuId == null && p.TrangThai != Enums.EnumYeuCauVatTuBenhVien.DaHuy).OrderBy(o => o.Id))
            {
                var thongTinYeuCauKhamBenh = new ThongTinChiTietKhamChuaBenhVo
                {
                    Id = yeuCau.Id,
                    NoiDung = yeuCau.VatTuBenhVien?.VatTus?.Ten,
                    DonViTinh = "Lần",
                    SoLuong = (decimal)yeuCau.SoLuong,
                    Nhom = NhomChiPhiKhamChuaBenh.VatTuTieuHao,
                    DuocHuongBaoHiem = yeuCau.DuocHuongBaoHiem,
                    YeuCauGoiDichVuId = yeuCau.YeuCauGoiDichVuId,
                };

                if (yeuCau.DuocHuongBaoHiem && yeuCau.BaoHiemChiTra != false)
                {
                    thongTinYeuCauKhamBenh.DonGiaBH = yeuCau.DonGiaBaoHiem;
                    thongTinYeuCauKhamBenh.TiLeThanhToanBHYT = yeuCau.MucHuongBaoHiem.GetValueOrDefault();
                    thongTinYeuCauKhamBenh.TiLeThanhToanTheoDV = yeuCau.TiLeBaoHiemThanhToan.GetValueOrDefault();
                    thongTinYeuCauKhamBenh.QuyBHYT = yeuCau.DonGiaBaoHiem.GetValueOrDefault() * yeuCau.TiLeBaoHiemThanhToan.GetValueOrDefault() / 100 * yeuCau.MucHuongBaoHiem.GetValueOrDefault() / 100 * (decimal)yeuCau.SoLuong;
                    thongTinYeuCauKhamBenh.BaoHiemChiTra = yeuCau.BaoHiemChiTra;
                    thongTinYeuCauKhamBenh.DonGiaBV = yeuCau.DonGiaBan;
                    thongTinYeuCauKhamBenh.ThanhTienBV = thongTinYeuCauKhamBenh.DonGiaBV * thongTinYeuCauKhamBenh.SoLuong;
                }
                else
                {
                    thongTinYeuCauKhamBenh.DonGiaBV = yeuCau.DonGiaBan;
                    thongTinYeuCauKhamBenh.ThanhTienBV = thongTinYeuCauKhamBenh.DonGiaBV * thongTinYeuCauKhamBenh.SoLuong;

                }

                yeuCauKhamBenhs.Add(thongTinYeuCauKhamBenh);

            }

            //TODO: need update goi dv
            //foreach (var yeuCau in yeuCauTiepNhan?.YeuCauGoiDichVus.Where(p => p.TrangThai != Enums.EnumTrangThaiYeuCauGoiDichVu.DaHuy).OrderBy(o => o.Id))
            //{
            //    var thongTinYeuCauKhamBenh = new ThongTinChiTietKhamChuaBenhVo
            //    {
            //        Id = yeuCau.Id,
            //        NoiDung = yeuCau.GoiDichVu?.Ten,
            //        DonViTinh = "Lần",
            //        SoLuong = 1,
            //        Nhom = NhomChiPhiKhamChuaBenh.GoiDichVu,
            //        DonGiaBV = yeuCau.ChiPhiGoiDichVu,
            //        YeuCauGoiDichVuId = yeuCau.ChiPhiGoiDichVu,
            //        DonGiaBH = 0,
            //        TiLeThanhToanBHYT = 0,
            //        QuyBHYT = 0
            //    };
            //    yeuCauKhamBenhs.Add(thongTinYeuCauKhamBenh);

            //}

            foreach (var yeuCau in yeuCauTiepNhan?.DonThuocThanhToans.Where(o => o.TrangThai != Enums.TrangThaiDonThuocThanhToan.DaHuy).SelectMany(cc => cc.DonThuocThanhToanChiTiets).OrderBy(o => o.Id))
            {
                var thongTinYeuCauKhamBenh = new ThongTinChiTietKhamChuaBenhVo
                {
                    Id = yeuCau.Id,
                    NoiDung = yeuCau.Ten,
                    DonViTinh = yeuCau.DonViTinh.Ten,
                    SoLuong = (decimal)yeuCau.SoLuong,
                    Nhom = NhomChiPhiKhamChuaBenh.ToaThuoc,
                    DuocHuongBaoHiem = yeuCau.DuocHuongBaoHiem,
                };

                if (yeuCau.DuocHuongBaoHiem && yeuCau.BaoHiemChiTra != false)
                {
                    thongTinYeuCauKhamBenh.DonGiaBH = yeuCau.DonGiaBaoHiem;
                    thongTinYeuCauKhamBenh.TiLeThanhToanBHYT = yeuCau.MucHuongBaoHiem.GetValueOrDefault();
                    thongTinYeuCauKhamBenh.TiLeThanhToanTheoDV = yeuCau.TiLeBaoHiemThanhToan.GetValueOrDefault();
                    thongTinYeuCauKhamBenh.QuyBHYT = yeuCau.DonGiaBaoHiem.GetValueOrDefault() * yeuCau.TiLeBaoHiemThanhToan.GetValueOrDefault() / 100 * yeuCau.MucHuongBaoHiem.GetValueOrDefault() / 100 * (decimal)yeuCau.SoLuong;
                    thongTinYeuCauKhamBenh.BaoHiemChiTra = yeuCau.BaoHiemChiTra;
                    thongTinYeuCauKhamBenh.DonGiaBV = yeuCau.DonGiaBan;
                    thongTinYeuCauKhamBenh.ThanhTienBV = thongTinYeuCauKhamBenh.DonGiaBV * thongTinYeuCauKhamBenh.SoLuong;
                }
                else
                {
                    thongTinYeuCauKhamBenh.DonGiaBV = yeuCau.DonGiaBan;
                    thongTinYeuCauKhamBenh.ThanhTienBV = thongTinYeuCauKhamBenh.DonGiaBV * thongTinYeuCauKhamBenh.SoLuong;

                }
                yeuCauKhamBenhs.Add(thongTinYeuCauKhamBenh);

            }

            allData.AddRange(yeuCauKhamBenhs);
            allData.AddRange(yeuCauDichVuKyThuats);
            allData.AddRange(yeuCauDichVuGiuongBenhViens);
            allData.AddRange(yeuCauDuocPhamBenhViens);
            allData.AddRange(yeuCauGoiDichVus);
            allData.AddRange(donThuocThanhToans);


            var groupDataTheoNhomDichVus = allData.GroupBy(cc => cc.Nhom);

            var dateItemChiPhis = string.Empty;
            //Bind yêu cầu khám bệnh lên html
            int index = 1;
            int indexItem = 1;

            foreach (var groupDataTheoNhomDichVu in groupDataTheoNhomDichVus)
            {
                dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                           "<td style='border: 1px solid #020000;' colspan='6'>" +
                                           "<span style='float:left;'><b>" + index + "." + groupDataTheoNhomDichVu.Key.GetDescription() + " </b></span>" +
                                           "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupDataTheoNhomDichVu.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                           "<td style='border: 1px solid #020000;text-align: right;'></td>" +
                                           "<td style='border: 1px solid #020000;text-align: right;'><b>" + Convert.ToDouble(groupDataTheoNhomDichVu.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble() + "</b> </td>" +
                                           "<td style='border: 1px solid #020000;text-align: right;'><b> " + Convert.ToDouble(groupDataTheoNhomDichVu.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble() + "</b></td>" +
                                           "<td style='border: 1px solid #020000;text-align: right;'> <b>" + Convert.ToDouble(groupDataTheoNhomDichVu.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble() + "</b></td>" +
                                           "<td style='border: 1px solid #020000;text-align: right;'> <b>" + Convert.ToDouble(groupDataTheoNhomDichVu.Sum(o => o.Khac)).ApplyFormatMoneyToDouble() + "</b></td>" +
                                           "<td style='border: 1px solid #020000;text-align: right;'> <b>" + Convert.ToDouble(groupDataTheoNhomDichVu.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(true) + "</b></td>" +
                                           "</tr>";

                foreach (var groupYeuCauKhamBenh in groupDataTheoNhomDichVu)
                {

                    dateItemChiPhis += "<tr style=' border: 1px solid #020000; '>" +
                                          "<td style='border: 1px solid #020000;text-align: left;'>- " + groupYeuCauKhamBenh.NoiDung + "</td>" +
                                          "<td style='border: 1px solid #020000;text-align: center;'>  " + groupYeuCauKhamBenh.DonViTinh + " </td>" +
                                          "<td style='border: 1px solid #020000;text-align: center;'> " + groupYeuCauKhamBenh.SoLuong + "</td>" +
                                          "<td style='border: 1px solid #020000;text-align: center;'> " + Convert.ToDouble(groupYeuCauKhamBenh.DonGiaBV).ApplyFormatMoneyToDouble() + "</td>" +
                                          "<td style='border: 1px solid #020000;text-align: center;'> " + Convert.ToDouble(groupYeuCauKhamBenh.DonGiaBH).ApplyFormatMoneyToDouble() + "</td>" +
                                          "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(groupYeuCauKhamBenh.TiLeThanhToanTheoDV).ApplyFormatMoneyToDouble() + "</td>" +
                                          "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(groupYeuCauKhamBenh.ThanhTienBV).ApplyFormatMoneyToDouble() + "</td>" +
                                          "<td style='border: 1px solid #020000;text-align: right;'> " + Convert.ToDouble(groupYeuCauKhamBenh.TiLeThanhToanBHYT).ApplyFormatMoneyToDouble() + "</td>" +
                                          "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(groupYeuCauKhamBenh.ThanhTienBH).ApplyFormatMoneyToDouble() + "</td>" +
                                          "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(groupYeuCauKhamBenh.QuyBHYT).ApplyFormatMoneyToDouble() + "</td>" +
                                          "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(groupYeuCauKhamBenh.NguoiBenhCungChiTra).ApplyFormatMoneyToDouble() + "</td>" +
                                          "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(groupYeuCauKhamBenh.Khac).ApplyFormatMoneyToDouble() + "</td>" +
                                          "<td style='border: 1px solid #020000;text-align: right;'>  " + Convert.ToDouble(groupYeuCauKhamBenh.NguoiBenhTuTra).ApplyFormatMoneyToDouble(true) + "</td>" +
                                          "</tr>";
                    indexItem++;

                }
                index++;
            }




            var diaChi = yeuCauTiepNhan.DiaChiDayDu;

            if (yeuCauTiepNhan != null)
            {
                var checkedLyDoVaoVien = "<input id='demo_box_2' class='css - checkbox' type='checkbox' checked  disabled='true'/>";
                var unCheckedLyDoVaoVien = "<input id='demo_box_2' class='css - checkbox' type='checkbox' disabled='true' />";

                var data = new
                {
                    MaBN = yeuCauTiepNhan.BenhNhan.MaBN,
                    MaTN = yeuCauTiepNhan.MaYeuCauTiepNhan,
                    HoTen = yeuCauTiepNhan.HoTen,
                    DiaChi = diaChi,
                    BarCodeImgBase64 = !string.IsNullOrEmpty(yeuCauTiepNhan.MaYeuCauTiepNhan) ? BarcodeHelper.GenerateBarCode(yeuCauTiepNhan.MaYeuCauTiepNhan) : "",
                    NamSinh = DateHelper.DOBFormat(yeuCauTiepNhan.NgaySinh, yeuCauTiepNhan.ThangSinh, yeuCauTiepNhan.NamSinh),
                    GioiTinh = yeuCauTiepNhan.GioiTinh != null ? yeuCauTiepNhan.GioiTinh.GetDescription() : "",
                    CoBHYT = coBhyt,
                    MucHuong = mucHuong,
                    BHYTTuNgay = bHYTTuNgay,
                    BHYTDenNgay = bHYTDenNgay,
                    NoiDKKCBBanDau = NoiDKKCBBanDau,
                    MaKCBBanDau = MaKCBBanDau,
                    TinhTrangRaVien = 1,
                    NgayDenKham = yeuCauTiepNhan.CreatedOn.Value.Hour + " giờ " + yeuCauTiepNhan.CreatedOn.Value.Minute + " phút " + ", ngày " + yeuCauTiepNhan.CreatedOn.Value.ApplyFormatDate(),
                    KetThucKhamNgoaiTru = yeuCauTiepNhan.TrangThaiYeuCauTiepNhan == Enums.EnumTrangThaiYeuCauTiepNhan.DaHoanTat ? yeuCauTiepNhan.ThoiDiemCapNhatTrangThai.ApplyFormatDate() : "",


                    SoNgayDTri = Math.Round((yeuCauTiepNhan.TrangThaiYeuCauTiepNhan != Enums.EnumTrangThaiYeuCauTiepNhan.DaHoanTat ? DateTime.Now.Date - yeuCauTiepNhan.CreatedOn.Value.Date :
                    yeuCauTiepNhan.ThoiDiemCapNhatTrangThai - yeuCauTiepNhan.CreatedOn.Value.Date).TotalDays) == 0 ? 1 :
                    Math.Round((yeuCauTiepNhan.TrangThaiYeuCauTiepNhan != Enums.EnumTrangThaiYeuCauTiepNhan.DaHoanTat ? DateTime.Now.Date - yeuCauTiepNhan.CreatedOn.Value.Date :
                    yeuCauTiepNhan.ThoiDiemCapNhatTrangThai - yeuCauTiepNhan.CreatedOn.Value.Date).TotalDays),

                    MaBHYT = yeuCauTiepNhan.BHYTMaSoThe,
                    LyDoVaoVien = yeuCauTiepNhan.LyDoVaoVien.GetDescription(),
                    TongSoNgayDieuTri = 1,
                    NoiChuyenDen = yeuCauTiepNhan.NoiChuyen?.Ten,
                    NoiChuyenDi = yeuCauKhamBenhICD != null ? yeuCauKhamBenhICD.BenhVienChuyenVien?.Ten : string.Empty,
                    DieuTriKNT = ycDieuTri?.ThoiDiemBatDauDieuTri?.ApplyFormatDate(),
                    ChuanDoanXacDinh = tenicdchinh,
                    MaICD10 = icdchinh,
                    BenhKemTheo = tenIcdKemTheos,
                    ICDKemTheo10 = icdKemTheos,
                    MKV = yeuCauTiepNhan.BHYTMaKhuVuc,
                    DateItemChiPhis = dateItemChiPhis,
                    NgayMiemCungTC = yeuCauTiepNhan.BHYTNgayDuocMienCungChiTra != null ? yeuCauTiepNhan.BHYTNgayDuocMienCungChiTra.Value.ApplyFormatDate() : "",
                    TTDV = Convert.ToDouble(allData.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble(),
                    TTTTBHYT = "",
                    TTTienBH = Convert.ToDouble(allData.Sum(o => o.ThanhTienBH)).ApplyFormatMoneyToDouble(),
                    TQBHYT = Convert.ToDouble(allData.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble(),
                    TNCCTra = Convert.ToDouble(allData.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble(),
                    TongSoKhac = Convert.ToDouble(allData.Sum(o => o.Khac)).ApplyFormatMoneyToDouble(),
                    TNBTuTra = Convert.ToDouble(allData.Sum(o => o.NguoiBenhTuTra)).ApplyFormatMoneyToDouble(),
                    ThoiGian5Nam = yeuCauTiepNhan.BHYTNgayDu5Nam != null ? yeuCauTiepNhan.BHYTNgayDu5Nam.Value.ApplyFormatDate() : "",

                    CoCapCuu = yeuCauTiepNhan.LyDoVaoVien == Enums.EnumLyDoVaoVien.CapCuu ? checkedLyDoVaoVien : unCheckedLyDoVaoVien,
                    CoDungTuyen = yeuCauTiepNhan.LyDoVaoVien == Enums.EnumLyDoVaoVien.DungTuyen ? checkedLyDoVaoVien : unCheckedLyDoVaoVien,
                    CoThongTuyen = yeuCauTiepNhan.LyDoVaoVien == Enums.EnumLyDoVaoVien.ThongTuyen ? checkedLyDoVaoVien : unCheckedLyDoVaoVien,
                    CoTraiTuyen = yeuCauTiepNhan.LyDoVaoVien == Enums.EnumLyDoVaoVien.TraiTuyen ? checkedLyDoVaoVien : unCheckedLyDoVaoVien,


                    TongChiPhi = Convert.ToDouble(allData.Sum(o => o.ThanhTienBV)).ApplyFormatMoneyToDouble(),
                    SoTienBangChu = NumberHelper.ChuyenSoRaText(Convert.ToDouble(allData.Sum(o => o.ThanhTienBV))),
                    TTQuyTT = Convert.ToDouble(allData.Sum(o => o.QuyBHYT)).ApplyFormatMoneyToDouble(),
                    NguoiBenhPhaiTra = (Convert.ToDouble(allData.Sum(o => o.NguoiBenhCungChiTra)) +
                Convert.ToDouble(allData.Sum(o => o.Khac))).ApplyFormatMoneyToDouble(),
                    BHYTChiTra = Convert.ToDouble(allData.Sum(o => o.NguoiBenhCungChiTra)).ApplyFormatMoneyToDouble(),
                    CacKhoanTraKhac = Convert.ToDouble(allData.Sum(o => o.Khac)).ApplyFormatMoneyToDouble(),
                    SoTienKhac = 0
                };
                var content = TemplateHelpper.FormatTemplateWithContentTemplate(result?.Body, data);
                return content;
            }

            return String.Empty;
        }

        #endregion

        #region lấy danh sách thông tin miễm giảm và danh sách thông tin voucher

        public List<ThongTinVoucherVo> GetThongTinVouchers(long yeucauTiepNhanId)
        {

            var theVoucherYeuCauTiepNhans = _theVoucherYeuCauTiepNhan.TableNoTracking.Include(cc => cc.TheVoucher)
                                                    .Where(cc => cc.YeuCauTiepNhanId == yeucauTiepNhanId);
            var thongTinVoucherVos = new List<ThongTinVoucherVo>();

            var theVouchers = theVoucherYeuCauTiepNhans.Select(cc => cc.TheVoucher).Include(cc => cc.Voucher);

            foreach (var theVoucher in theVouchers)
            {
                var thongTinVoucher = new ThongTinVoucherVo();
                thongTinVoucher.KeyId = theVoucher.Voucher.Id;
                thongTinVoucher.DisplayName = theVoucher.Ma;
                thongTinVoucherVos.Add(thongTinVoucher);
            }
            return thongTinVoucherVos;
        }

        public (bool, string) KiemTraTheVoucherSuDung(ThongTinVoucherTheoYeuCauTiepNhan model)
        {
            var theVoucher = _theVoucher.TableNoTracking.Where(cc => cc.Ma == model.TheVoucher).FirstOrDefault();
            if (theVoucher == null) return (false, string.Empty);

            var daSuDungVoucher = _mienGiamChiPhiRepository.TableNoTracking.Where(cc => cc.TheVoucherId == theVoucher.Id).Any();
            if (daSuDungVoucher)
            {
                return (true, "Mã Voucher đã được sử dụng trong hệ thống");
            }
            else
            {
                return (false, string.Empty);
            }
        }

        public (bool, string) DeleteVouchers(ThongTinVoucherTheoYeuCauTiepNhan model)
        {
            var theVoucher = _theVoucher.TableNoTracking.Where(cc => cc.Ma == model.TheVoucher).FirstOrDefault();
            if (theVoucher == null) return (false, string.Empty);

            var daSuDungVoucher = _mienGiamChiPhiRepository.TableNoTracking
                .Where(cc => cc.TheVoucherId == theVoucher.Id && ((cc.YeuCauKhamBenh != null && cc.YeuCauKhamBenh.TrangThaiThanhToan == Enums.TrangThaiThanhToan.DaThanhToan)
                                                                || (cc.YeuCauDichVuKyThuat != null && cc.YeuCauDichVuKyThuat.TrangThaiThanhToan == Enums.TrangThaiThanhToan.DaThanhToan))).Any();
            if (daSuDungVoucher)
            {
                return (true, "Mã Voucher đã được sử dụng trong hệ thống");
            }
            else
            {
                var theVoucherYeuCauTiepNhan = _theVoucherYeuCauTiepNhan.Table
                    .Where(cc => cc.TheVoucherId == theVoucher.Id && cc.YeuCauTiepNhanId == model.YeucauTiepNhanId)
                    .Include(cc => cc.TheVoucher).ThenInclude(o => o.MienGiamChiPhis).ThenInclude(o => o.YeuCauDichVuKyThuat)
                    .Include(cc => cc.TheVoucher).ThenInclude(o => o.MienGiamChiPhis).ThenInclude(o => o.YeuCauKhamBenh)
                    .ToList();

                if (theVoucherYeuCauTiepNhan.Count > 0)
                {
                    var theVCs = theVoucherYeuCauTiepNhan.Select(cc => cc.TheVoucher);
                    foreach (var item in theVCs)
                    {
                        item.WillDelete = true;
                        foreach (var mg in item.MienGiamChiPhis)
                        {
                            mg.WillDelete = true;
                            if (mg.YeuCauKhamBenh != null)
                            {
                                mg.YeuCauKhamBenh.SoTienMienGiam = (mg.YeuCauKhamBenh.SoTienMienGiam.GetValueOrDefault() - mg.SoTien) < 0 ? 0 : (mg.YeuCauKhamBenh.SoTienMienGiam.GetValueOrDefault() - mg.SoTien);
                            }
                            else if (mg.YeuCauDichVuKyThuat != null)
                            {
                                mg.YeuCauDichVuKyThuat.SoTienMienGiam = (mg.YeuCauDichVuKyThuat.SoTienMienGiam.GetValueOrDefault() - mg.SoTien) < 0 ? 0 : (mg.YeuCauDichVuKyThuat.SoTienMienGiam.GetValueOrDefault() - mg.SoTien);
                            }
                        }
                    }
                    _theVoucherYeuCauTiepNhan.Delete(theVoucherYeuCauTiepNhan);



                    //xóa hêt voucher câp nhật lại nó ko còn được ưu đãi
                    var yeuCauTiepNhan = BaseRepository.Table.Where(cc => cc.Id == model.YeucauTiepNhanId).Include(cc => cc.TheVoucherYeuCauTiepNhans)
                                             .Include(cc => cc.DoiTuongUuDai).FirstOrDefault();

                    //xóa hêt voucher câp nhật lại nó ko còn được ưu đãi
                    if (!yeuCauTiepNhan.TheVoucherYeuCauTiepNhans.Any() && yeuCauTiepNhan.DoiTuongUuDai == null)
                    {
                        yeuCauTiepNhan.DuocUuDai = false;
                        BaseRepository.Update(yeuCauTiepNhan);
                    }

                    return (false, "Đã xóa mã voucher thành công");
                }
                else
                {
                    return (false, string.Empty);
                }

            }
        }

        public ThongTinMienGiamVo GetThongTinMienGiam(long yeuCauTiepNhanId)
        {
            var thongTinMienGiamVo = new ThongTinMienGiamVo();

            var yeuCauTiepNhan = BaseRepository.GetById(yeuCauTiepNhanId,
                x => x
                    //.Include(o => o.MienGiamChiPhis)
                    //.Include(o => o.YeuCauKhamBenhs)
                    //.Include(o => o.YeuCauDichVuKyThuats)
                    //.Include(o => o.YeuCauDichVuGiuongBenhViens)
                    //.Include(o => o.YeuCauDuocPhamBenhViens)
                    //.Include(o => o.YeuCauVatTuBenhViens)
                    //.Include(o => o.DonThuocThanhToans).ThenInclude(dt => dt.DonThuocThanhToanChiTiets)
                    .Include(o => o.CongTyUuDai)
                    .Include(o => o.DoiTuongUuDai).ThenInclude(ud => ud.DoiTuongUuDaiDichVuKhamBenhBenhViens)
                    .Include(o => o.DoiTuongUuDai).ThenInclude(ud => ud.DoiTuongUuDaiDichVuKyThuatBenhViens)
                    .Include(o => o.GiayMienGiamThem)
                    .Include(o => o.NhanVienDuyetMienGiamThem).ThenInclude(v => v.User)
                    .Include(o => o.TheVoucherYeuCauTiepNhans).ThenInclude(v => v.TheVoucher).ThenInclude(v => v.Voucher));
            thongTinMienGiamVo.KhachVangLaiMuaThuoc = yeuCauTiepNhan.LoaiYeuCauTiepNhan == Enums.EnumLoaiYeuCauTiepNhan.MuaThuoc;
            //Thông tin đối tượng ưu đãi
            if (yeuCauTiepNhan.DoiTuongUuDai != null)
            {
                var thongTinMienGiamTheoDoiTuongUuDaiVo = new ThongTinMienGiamTheoDoiTuongUuDaiVo
                {
                    CongTyUudai = yeuCauTiepNhan.CongTyUuDai?.Ten,
                    DoiTuongUuDai = yeuCauTiepNhan.DoiTuongUuDai.Ten,
                    //DichVuMiemGiamTheoTiLes = new List<DichVuMiemGiamTheoTiLe>()
                };

                thongTinMienGiamVo.ThongTinMienGiamTheoDoiTuongUuDaiVo = thongTinMienGiamTheoDoiTuongUuDaiVo;
            }

            //Thông tin miễm giảm thêm
            if (yeuCauTiepNhan.CoMienGiamThem == true)
            {
                //decimal soTienDaMienGiam = 0;
                //foreach (var mienGiamChiPhi in yeuCauTiepNhan.MienGiamChiPhis.Where(o => o.LoaiMienGiam == Enums.LoaiMienGiam.MienGiamThem))
                //{
                //    if (mienGiamChiPhi.YeuCauKhamBenhId != null && yeuCauTiepNhan.YeuCauKhamBenhs.Any(o => o.Id == mienGiamChiPhi.YeuCauKhamBenhId && o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.DaThanhToan))
                //    {
                //        soTienDaMienGiam += mienGiamChiPhi.SoTien;
                //    }
                //    if (mienGiamChiPhi.YeuCauDichVuKyThuatId != null && yeuCauTiepNhan.YeuCauDichVuKyThuats.Any(o => o.Id == mienGiamChiPhi.YeuCauDichVuKyThuatId && o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.DaThanhToan))
                //    {
                //        soTienDaMienGiam += mienGiamChiPhi.SoTien;
                //    }
                //    if (mienGiamChiPhi.YeuCauDichVuGiuongBenhVienId != null && yeuCauTiepNhan.YeuCauDichVuGiuongBenhViens.Any(o => o.Id == mienGiamChiPhi.YeuCauDichVuGiuongBenhVienId && o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.DaThanhToan))
                //    {
                //        soTienDaMienGiam += mienGiamChiPhi.SoTien;
                //    }
                //    if (mienGiamChiPhi.YeuCauDuocPhamBenhVienId != null && yeuCauTiepNhan.YeuCauDuocPhamBenhViens.Any(o => o.Id == mienGiamChiPhi.YeuCauDuocPhamBenhVienId && o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.DaThanhToan))
                //    {
                //        soTienDaMienGiam += mienGiamChiPhi.SoTien;
                //    }
                //    if (mienGiamChiPhi.YeuCauVatTuBenhVienId != null && yeuCauTiepNhan.YeuCauVatTuBenhViens.Any(o => o.Id == mienGiamChiPhi.YeuCauVatTuBenhVienId && o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.DaThanhToan))
                //    {
                //        soTienDaMienGiam += mienGiamChiPhi.SoTien;
                //    }
                //    if (mienGiamChiPhi.DonThuocThanhToanChiTietId != null && yeuCauTiepNhan.DonThuocThanhToans.Any(o => o.DonThuocThanhToanChiTiets.Any(ct => ct.Id == mienGiamChiPhi.DonThuocThanhToanChiTietId) && o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.DaThanhToan))
                //    {
                //        soTienDaMienGiam += mienGiamChiPhi.SoTien;
                //    }
                //}
                //thông tin giấy miễm giảm thêm
                if (yeuCauTiepNhan.GiayMienGiamThemId != null)
                {
                    thongTinMienGiamVo.ThongTinMienGiamThemVo = new ThongTinMienGiamThemVo
                    {
                        LyDoMiemGiam = yeuCauTiepNhan.LyDoMienGiamThem,
                        NhanVienDuyetMienGiamThemId = yeuCauTiepNhan.NhanVienDuyetMienGiamThemId,
                        TenNhanVienDuyet = yeuCauTiepNhan.NhanVienDuyetMienGiamThem?.User.HoTen,
                        TaiLieuDinhKemGiayMiemGiam = new TaiLieuDinhKemGiayMiemGiam
                        {
                            Ten = yeuCauTiepNhan.GiayMienGiamThem.Ten,
                            Id = yeuCauTiepNhan.GiayMienGiamThem.Id,
                            Ma = yeuCauTiepNhan.GiayMienGiamThem.Ma,
                            DuongDan = yeuCauTiepNhan.GiayMienGiamThem.DuongDan,
                            TenGuid = yeuCauTiepNhan.GiayMienGiamThem.TenGuid,
                            KichThuoc = yeuCauTiepNhan.GiayMienGiamThem.KichThuoc,
                            LoaiTapTin = (int)yeuCauTiepNhan.GiayMienGiamThem.LoaiTapTin
                        }
                    };
                }

            }

            //Thông tin miễm giảm theo voucher
            if (yeuCauTiepNhan.TheVoucherYeuCauTiepNhans.Any())
            {
                var thongTinMienGiamVoucherVo = new ThongTinMienGiamVoucherVo
                {
                    MaVouchers = yeuCauTiepNhan.TheVoucherYeuCauTiepNhans.Select(o => new LookupItemVo { DisplayName = o.TheVoucher.Ma, KeyId = o.TheVoucher.Id }).ToList(),
                    DuocPhamMienGiamTheoTiLes = new List<DuocPhamMienGiamTheoTiLe>(),
                    DichVuMiemGiamTheoTiLes = new List<DichVuMiemGiamTheoTiLe>()
                };

                thongTinMienGiamVo.ThongTinMienGiamVoucherVo = thongTinMienGiamVoucherVo;
            }
            return thongTinMienGiamVo;
        }

        public bool ThemThongTinVoucher(long yeuCauTiepNhanId, long benhNhanId, List<long> theVoucherIds)
        {
            var theVoucherYeuCauTiepNhans = _theVoucherYeuCauTiepNhan.TableNoTracking.Where(cc => cc.YeuCauTiepNhanId == yeuCauTiepNhanId).ToList();
            if (theVoucherYeuCauTiepNhans != null && theVoucherIds.Count > 0)
            {
                if (theVoucherYeuCauTiepNhans.Count > 0)
                {
                    var existVouchers = theVoucherYeuCauTiepNhans.Select(c => c.TheVoucherId);
                    var newvoucherIds = theVoucherIds.Where(c => !existVouchers.Contains(c)).ToList();
                    if (newvoucherIds.Count > 0)
                    {
                        foreach (var theVoucherId in newvoucherIds)
                        {
                            _theVoucherYeuCauTiepNhan.Add(new TheVoucherYeuCauTiepNhan
                            {
                                BenhNhanId = benhNhanId,
                                YeuCauTiepNhanId = yeuCauTiepNhanId,
                                TheVoucherId = theVoucherId

                            });
                        }
                    }
                }
                else
                {
                    foreach (var theVoucherId in theVoucherIds)
                    {
                        _theVoucherYeuCauTiepNhan.Add(new TheVoucherYeuCauTiepNhan
                        {
                            BenhNhanId = benhNhanId,
                            YeuCauTiepNhanId = yeuCauTiepNhanId,
                            TheVoucherId = theVoucherId

                        });
                    }
                    return true;
                }

            }
            return false;
        }

        public (bool, string) KiemTraThongTinVoucher(string maVocher, long yeuCauTiepNhanId, long benhNhanId)
        {

            //kiểm tra thẻ voucher hay không   
            var ktVoucher = maVocher.Where(c => c == '-').Any();
            if (!ktVoucher) return (true, "Thẻ voucher nhập không hợp lệ.");

            var maVocherArr = maVocher.Split("-");

            //var locMaVoucher = maVocher.Split("-")[0];
            var locMaVoucher = string.Join('-', maVocherArr.Take(maVocherArr.Length - 1));
            var voucher = _voucherRepository.TableNoTracking.Include(o => o.VoucherChiTietMienGiams).Where(c => c.Ma == locMaVoucher).ToList();
            if (!voucher.Any()) return (true, "Thẻ voucher nhập không hợp lệ.");

            //kiểm tra số phiếu có đúng số lượng đã phát không
            //var maSoVoucher = (maVocher.Split("-")[1]).ToString();
            var maSoVoucher = maVocherArr[maVocherArr.Length - 1];
            var kiemTraSoVoucher = maSoVoucher.Where(c => c == '.').Any();

            var lenghtVOucherPhatHanh = voucher.FirstOrDefault().SoLuongPhatHanh.ToString().Length;
            var lenghtVOucher = maSoVoucher.Length;

            if (lenghtVOucher != lenghtVOucherPhatHanh || kiemTraSoVoucher || !(maSoVoucher.IsNumberFraction()))
                return (true, "Thẻ voucher nhập không hợp lệ.");

            //var soPhieuPhatHanh = Int32.Parse(maVocher.Split("-")[1]);
            var soPhieuPhatHanh = Int32.Parse(maSoVoucher);
            var solluongPhieuBanHanh = voucher.FirstOrDefault().SoLuongPhatHanh;
            if (soPhieuPhatHanh == 0 || soPhieuPhatHanh > solluongPhieuBanHanh) return (true, "Thẻ voucher nhập không hợp lệ.");


            var theVoucher = _theVoucher.TableNoTracking.Where(cc => cc.Ma == maVocher)
                                                        .Include(cc => cc.MienGiamChiPhis)
                                                        .ToList();



            var voucherKhoangCach = voucher.Where(cc => cc.TuNgay.Date >= DateTime.Now);
            if (voucherKhoangCach.Any())
            {
                return (true, "Thẻ voucher " + maVocher + " chưa đến hạn sử dụng.");
            }

            var hanSuDungVoucher = voucher.Where(cc => cc.TuNgay.Date <= DateTime.Now && (cc.DenNgay == null || cc.DenNgay.Value.Date >= DateTime.Now.Date));
            if (!hanSuDungVoucher.Any())
            {
                return (true, "Thẻ voucher " + maVocher + " đã hết hạn sử dụng.");
            }

            if (!theVoucher.Any())
            {
                //Lưu thông tin mã thẻ voucher
                var newTheVocuher = new TheVoucher()
                {
                    Ma = maVocher,
                    TuNgay = hanSuDungVoucher.First().TuNgay,
                    DenNgay = hanSuDungVoucher.First().DenNgay,
                    VoucherId = hanSuDungVoucher.First().Id
                };
                _theVoucher.Add(newTheVocuher);

                //thỏa mãm điều kiên trên lưu lại
                var theVoucherYeuCauTiepNhan = _theVoucherYeuCauTiepNhan.TableNoTracking.Where(cc => cc.TheVoucherId == newTheVocuher.Id && cc.YeuCauTiepNhanId == yeuCauTiepNhanId).Any();
                if (!theVoucherYeuCauTiepNhan)
                {
                    var themTheVocherYCTN = new TheVoucherYeuCauTiepNhan() { TheVoucherId = newTheVocuher.Id, YeuCauTiepNhanId = yeuCauTiepNhanId, BenhNhanId = benhNhanId };
                    _theVoucherYeuCauTiepNhan.Add(themTheVocherYCTN);

                    //nếu thêm xong voucher cập nhật nó lai có Dược uu đãi
                    var yeuCauTiepNhan = BaseRepository.Table.Where(cc => cc.Id == yeuCauTiepNhanId).Include(o => o.YeuCauKhamBenhs)
                        .Include(o => o.YeuCauDichVuKyThuats).Include(o => o.YeuCauDuocPhamBenhViens).Include(o => o.YeuCauVatTuBenhViens)
                        .Include(o => o.DonThuocThanhToans).ThenInclude(o => o.DonThuocThanhToanChiTiets)
                        .FirstOrDefault();
                    yeuCauTiepNhan.DuocUuDai = true;

                    //luu mien giam theo voucher                   

                    var voucherHopLe = hanSuDungVoucher.First();
                    foreach (var ycKhamBenh in yeuCauTiepNhan.YeuCauKhamBenhs.Where(o => o.KhongTinhPhi != true && o.TrangThaiThanhToan != Enums.TrangThaiThanhToan.DaThanhToan && o.TrangThaiThanhToan != Enums.TrangThaiThanhToan.HuyThanhToan))
                    {
                        decimal soTienTruocMienGiam = (ycKhamBenh.Gia) - (ycKhamBenh.BaoHiemChiTra != true ? 0 : (ycKhamBenh.DonGiaBaoHiem.GetValueOrDefault() * ycKhamBenh.TiLeBaoHiemThanhToan.GetValueOrDefault() / 100 * ycKhamBenh.MucHuongBaoHiem.GetValueOrDefault() / 100));
                        decimal soTienMiemGiam = 0;
                        if (voucherHopLe.ChietKhauTatCaDichVu == true)
                        {

                            if (voucherHopLe.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoTiLe)
                            {
                                soTienMiemGiam = Math.Round((soTienTruocMienGiam * voucherHopLe.TiLeChietKhau.GetValueOrDefault() / 100), 2, MidpointRounding.AwayFromZero);
                            }
                            else
                            {
                                soTienMiemGiam = voucherHopLe.SoTienChietKhau.GetValueOrDefault();
                            }
                            ycKhamBenh.MienGiamChiPhis.Add(new MienGiamChiPhi
                            {
                                YeuCauTiepNhanId = ycKhamBenh.YeuCauTiepNhanId,
                                LoaiMienGiam = Enums.LoaiMienGiam.Voucher,
                                TheVoucher = newTheVocuher,
                                LoaiChietKhau = voucherHopLe.LoaiChietKhau.Value,
                                MaTheVoucher = newTheVocuher.Ma,
                                TiLe = voucherHopLe.TiLeChietKhau,
                                SoTien = soTienMiemGiam
                            });
                        }
                        else
                        {
                            var voucherKhamBenh = voucherHopLe.VoucherChiTietMienGiams.FirstOrDefault(o => o.NhomDichVuKhamBenh == true || (o.DichVuKhamBenhBenhVienId == ycKhamBenh.DichVuKhamBenhBenhVienId && o.NhomGiaDichVuKhamBenhBenhVienId == ycKhamBenh.NhomGiaDichVuKhamBenhBenhVienId));

                            if (voucherKhamBenh != null)
                            {
                                if (voucherKhamBenh.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoTiLe)
                                {
                                    soTienMiemGiam = Math.Round((soTienTruocMienGiam * voucherKhamBenh.TiLeChietKhau.GetValueOrDefault() / 100), 2, MidpointRounding.AwayFromZero);
                                }
                                else
                                {
                                    soTienMiemGiam = voucherKhamBenh.SoTienChietKhau.GetValueOrDefault();
                                }
                                ycKhamBenh.MienGiamChiPhis.Add(new MienGiamChiPhi
                                {
                                    YeuCauTiepNhanId = ycKhamBenh.YeuCauTiepNhanId,
                                    LoaiMienGiam = Enums.LoaiMienGiam.Voucher,
                                    TheVoucher = newTheVocuher,
                                    MaTheVoucher = newTheVocuher.Ma,
                                    LoaiChietKhau = voucherKhamBenh.LoaiChietKhau,
                                    TiLe = voucherKhamBenh.TiLeChietKhau,
                                    SoTien = voucherKhamBenh.SoTienChietKhau.GetValueOrDefault()
                                });
                            }
                        }
                        ycKhamBenh.SoTienMienGiam = ycKhamBenh.SoTienMienGiam.GetValueOrDefault() + soTienMiemGiam;
                    }
                    foreach (var ycDichVuKyThuat in yeuCauTiepNhan.YeuCauDichVuKyThuats.Where(o => o.KhongTinhPhi != true && o.TrangThaiThanhToan != Enums.TrangThaiThanhToan.DaThanhToan && o.TrangThaiThanhToan != Enums.TrangThaiThanhToan.HuyThanhToan))
                    {
                        decimal soTienTruocMienGiam = (ycDichVuKyThuat.Gia * ycDichVuKyThuat.SoLan) - (ycDichVuKyThuat.BaoHiemChiTra != true ? 0 : (ycDichVuKyThuat.DonGiaBaoHiem.GetValueOrDefault() * ycDichVuKyThuat.TiLeBaoHiemThanhToan.GetValueOrDefault() / 100 * ycDichVuKyThuat.MucHuongBaoHiem.GetValueOrDefault() / 100 * ycDichVuKyThuat.SoLan));
                        decimal soTienMiemGiam = 0;
                        if (voucherHopLe.ChietKhauTatCaDichVu == true)
                        {

                            if (voucherHopLe.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoTiLe)
                            {
                                soTienMiemGiam = Math.Round((soTienTruocMienGiam * voucherHopLe.TiLeChietKhau.GetValueOrDefault() / 100), 2, MidpointRounding.AwayFromZero);
                            }
                            else
                            {
                                soTienMiemGiam = voucherHopLe.SoTienChietKhau.GetValueOrDefault();
                            }
                            ycDichVuKyThuat.MienGiamChiPhis.Add(new MienGiamChiPhi
                            {
                                YeuCauTiepNhanId = ycDichVuKyThuat.YeuCauTiepNhanId,
                                LoaiMienGiam = Enums.LoaiMienGiam.Voucher,
                                TheVoucher = newTheVocuher,
                                LoaiChietKhau = voucherHopLe.LoaiChietKhau.Value,
                                MaTheVoucher = newTheVocuher.Ma,
                                TiLe = voucherHopLe.TiLeChietKhau,
                                SoTien = soTienMiemGiam
                            });
                        }
                        else
                        {
                            var voucherDichVuKyThuat = voucherHopLe.VoucherChiTietMienGiams.FirstOrDefault(o => (o.NhomDichVuBenhVienId != null && o.NhomDichVuBenhVienId == ycDichVuKyThuat.NhomDichVuBenhVienId)
                                                                                            || (o.DichVuKyThuatBenhVienId == ycDichVuKyThuat.DichVuKyThuatBenhVienId && o.NhomGiaDichVuKyThuatBenhVienId == ycDichVuKyThuat.NhomGiaDichVuKyThuatBenhVienId));

                            if (voucherDichVuKyThuat != null)
                            {
                                if (voucherDichVuKyThuat.LoaiChietKhau == Enums.LoaiChietKhau.ChietKhauTheoTiLe)
                                {
                                    soTienMiemGiam = Math.Round((soTienTruocMienGiam * voucherDichVuKyThuat.TiLeChietKhau.GetValueOrDefault() / 100), 2, MidpointRounding.AwayFromZero);
                                }
                                else
                                {
                                    soTienMiemGiam = voucherDichVuKyThuat.SoTienChietKhau.GetValueOrDefault();
                                }
                                ycDichVuKyThuat.MienGiamChiPhis.Add(new MienGiamChiPhi
                                {
                                    YeuCauTiepNhanId = ycDichVuKyThuat.YeuCauTiepNhanId,
                                    LoaiMienGiam = Enums.LoaiMienGiam.Voucher,
                                    TheVoucher = newTheVocuher,
                                    MaTheVoucher = newTheVocuher.Ma,
                                    LoaiChietKhau = voucherDichVuKyThuat.LoaiChietKhau,
                                    TiLe = voucherDichVuKyThuat.TiLeChietKhau,
                                    SoTien = voucherDichVuKyThuat.SoTienChietKhau.GetValueOrDefault()
                                });
                            }
                        }
                        ycDichVuKyThuat.SoTienMienGiam = ycDichVuKyThuat.SoTienMienGiam.GetValueOrDefault() + soTienMiemGiam;
                    }

                    var soTienTamUng = _taiKhoanBenhNhanService.GetSoTienDaTamUngAsync(yeuCauTiepNhan.Id).Result;
                    BaoLanhDvNgoaiGoiMarketing(yeuCauTiepNhan, soTienTamUng - GetSoTienCanThanhToanNgoaiTru(yeuCauTiepNhan));
                    BaseRepository.Update(yeuCauTiepNhan);

                    return (false, "Thẻ voucher " + maVocher + " áp dụng thành công.");
                }
                else
                {
                    return (false, string.Empty);
                }
            }
            else
            {
                return (true, "Thẻ voucher " + maVocher + " đã được sử dụng.");

            }
        }

        public (long, string) KiemTraVoucherHopLe(string maVocher)
        {

            //kiểm tra thẻ voucher hay không   
            var ktVoucher = maVocher.Where(c => c == '-').Any();
            if (!ktVoucher) return (0, "Thẻ voucher nhập không hợp lệ.");
            var maVocherArr = maVocher.Split("-");

            //var locMaVoucher = maVocher.Split("-")[0];
            var locMaVoucher = string.Join('-', maVocherArr.Take(maVocherArr.Length - 1));
            var voucher = _voucherRepository.TableNoTracking.Where(c => c.Ma == locMaVoucher).ToList();
            if (!voucher.Any()) return (0, "Thẻ voucher nhập không hợp lệ.");

            //kiểm tra số phiếu có đúng số lượng đã phát không
            //var maSoVoucher = (maVocher.Split("-")[1]).ToString();
            var maSoVoucher = maVocherArr[maVocherArr.Length - 1];

            var kiemTraSoVoucher = maSoVoucher.Where(c => c == '.').Any();

            var lenghtVOucherPhatHanh = voucher.FirstOrDefault().SoLuongPhatHanh.ToString().Length;
            var lenghtVOucher = maSoVoucher.Length;

            if (lenghtVOucher != lenghtVOucherPhatHanh || kiemTraSoVoucher || !(maSoVoucher.IsNumberFraction()))
                return (0, "Thẻ voucher nhập không hợp lệ.");

            //var soPhieuPhatHanh = Int32.Parse(maVocher.Split("-")[1]);
            var soPhieuPhatHanh = Int32.Parse(maSoVoucher);
            var solluongPhieuBanHanh = voucher.FirstOrDefault().SoLuongPhatHanh;
            if (soPhieuPhatHanh == 0 || soPhieuPhatHanh > solluongPhieuBanHanh) return (0, "Thẻ voucher nhập không hợp lệ.");


            var theVoucher = _theVoucher.TableNoTracking.Where(cc => cc.Ma == maVocher)
                                                        .Include(cc => cc.MienGiamChiPhis)
                                                        .ToList();



            var voucherKhoangCach = voucher.Where(cc => cc.TuNgay.Date >= DateTime.Now);
            if (voucherKhoangCach.Any())
            {
                return (0, "Thẻ voucher " + maVocher + " chưa đến hạn sử dụng.");
            }

            var hanSuDungVoucher = voucher.Where(cc => cc.TuNgay.Date <= DateTime.Now && (cc.DenNgay == null || cc.DenNgay.Value.Date >= DateTime.Now.Date));
            if (!hanSuDungVoucher.Any())
            {
                return (0, "Thẻ voucher " + maVocher + " đã hết hạn sử dụng.");
            }

            if (theVoucher.Any())
            {
                return (0, "Thẻ voucher " + maVocher + " đã được sử dụng.");
            }

            return (voucher.FirstOrDefault().Id, "Thẻ voucher " + maVocher + " áp dụng thành công.");
        }

        #endregion

        #region Danh Sách Lịch Sử Thu Ngân

        public GridDataSource GetDataForGridDanhSachLichSuThuNganAsync(QueryInfo queryInfo, bool isAllData, long yeuCauTiepNhanId = 0)
        {
            ReplaceDisplayValueSortExpression(queryInfo);

            var phieuThuDataQuery = yeuCauTiepNhanId == 0 ? _taiKhoanBenhNhanThu.TableNoTracking
                                                .Where(o => o.LoaiNoiThu == Enums.LoaiNoiThu.ThuNgan && (o.LoaiThuTienBenhNhan == Enums.LoaiThuTienBenhNhan.ThuTheoChiPhi
                                                 || o.LoaiThuTienBenhNhan == Enums.LoaiThuTienBenhNhan.ThuTamUng)
                                                 )
                                                .ApplyLike(queryInfo.SearchTerms.RemoveUniKeyAndToLower(),
                                                    g => g.Id.ToString().RemoveUniKeyAndToLower(),
                                                    g => g.NgayThu.ToString().RemoveUniKeyAndToLower(),
                                                    g => g.NhanVienThucHien.User.HoTen.RemoveUniKeyAndToLower(),
                                                    g => g.YeuCauTiepNhan.BenhNhan.MaBN,
                                                    g => g.YeuCauTiepNhan.BenhNhan.HoTen.RemoveUniKeyAndToLower()
                                                    ) :
                                                _taiKhoanBenhNhanThu.TableNoTracking.Where(cc => cc.YeuCauTiepNhanId == yeuCauTiepNhanId)
                                                .Where(o => o.LoaiNoiThu == Enums.LoaiNoiThu.ThuNgan && (o.LoaiThuTienBenhNhan == Enums.LoaiThuTienBenhNhan.ThuTheoChiPhi
                                                 || o.LoaiThuTienBenhNhan == Enums.LoaiThuTienBenhNhan.ThuTamUng)
                                                 )
                                                .ApplyLike(queryInfo.SearchTerms.RemoveUniKeyAndToLower(),
                                                    g => g.Id.ToString().RemoveUniKeyAndToLower(),
                                                    g => g.NgayThu.ToString().RemoveUniKeyAndToLower(),
                                                    g => g.NhanVienThucHien.User.HoTen.RemoveUniKeyAndToLower(),
                                                    g => g.YeuCauTiepNhan.BenhNhan.MaBN,
                                                    g => g.YeuCauTiepNhan.BenhNhan.HoTen.RemoveUniKeyAndToLower()
                                                    );

            var phieuChiDataQuery = yeuCauTiepNhanId == 0 ? _taiKhoanBenhNhanChi.TableNoTracking
                                                 .Where(o => o.LoaiChiTienBenhNhan == Enums.LoaiChiTienBenhNhan.TraLaiBenhNhan
                                                   )
                                            .ApplyLike(queryInfo.SearchTerms.RemoveUniKeyAndToLower(),
                                                   g => g.Id.ToString().RemoveUniKeyAndToLower(),
                                                    g => g.NgayChi.ToString().RemoveUniKeyAndToLower(),
                                                    g => g.NhanVienThucHien.User.HoTen.RemoveUniKeyAndToLower(),
                                                    g => g.YeuCauTiepNhan.BenhNhan.MaBN,
                                                    g => g.YeuCauTiepNhan.BenhNhan.HoTen.RemoveUniKeyAndToLower()
                                                    ) :
                                                    _taiKhoanBenhNhanChi.TableNoTracking.Where(cc => cc.YeuCauTiepNhanId == yeuCauTiepNhanId)
                                                 .Where(o => o.LoaiChiTienBenhNhan == Enums.LoaiChiTienBenhNhan.TraLaiBenhNhan
                                                   )
                                                  .ApplyLike(queryInfo.SearchTerms.RemoveUniKeyAndToLower(),
                                                   g => g.Id.ToString().RemoveUniKeyAndToLower(),
                                                    g => g.NgayChi.ToString().RemoveUniKeyAndToLower(),
                                                    g => g.NhanVienThucHien.User.HoTen.RemoveUniKeyAndToLower(),
                                                    g => g.YeuCauTiepNhan.BenhNhan.MaBN,
                                                    g => g.YeuCauTiepNhan.BenhNhan.HoTen.RemoveUniKeyAndToLower()
                                                    );

            var dataHuy = yeuCauTiepNhanId == 0 ? _taiKhoanBenhNhanHuyDichVu.TableNoTracking.Include(cc => cc.TaiKhoanBenhNhanThus)
                                                .ApplyLike(queryInfo.SearchTerms.RemoveUniKeyAndToLower(),
                                                 g => g.Id.ToString().RemoveUniKeyAndToLower(),
                                                  g => g.NgayHuy.ToString().RemoveUniKeyAndToLower(),
                                                  g => g.NhanVienThucHien.User.HoTen.RemoveUniKeyAndToLower(),
                                                  g => g.YeuCauTiepNhan.BenhNhan.MaBN,
                                                  g => g.YeuCauTiepNhan.BenhNhan.HoTen.RemoveUniKeyAndToLower(),
                                                  g => g.LyDoHuy.RemoveUniKeyAndToLower()
                                                  ) :
                                                   _taiKhoanBenhNhanHuyDichVu.TableNoTracking.Where(cc => cc.YeuCauTiepNhanId == yeuCauTiepNhanId)
                                                   .Include(cc => cc.TaiKhoanBenhNhanThus)
                                                .ApplyLike(queryInfo.SearchTerms.RemoveUniKeyAndToLower(),
                                                 g => g.Id.ToString().RemoveUniKeyAndToLower(),
                                                  g => g.NgayHuy.ToString().RemoveUniKeyAndToLower(),
                                                  g => g.NhanVienThucHien.User.HoTen.RemoveUniKeyAndToLower(),
                                                  g => g.YeuCauTiepNhan.BenhNhan.MaBN,
                                                  g => g.YeuCauTiepNhan.BenhNhan.HoTen.RemoveUniKeyAndToLower(),
                                                  g => g.LyDoHuy.RemoveUniKeyAndToLower()
                                                  );

            var phieuThu = phieuThuDataQuery.Select(o => new DanhSachLichSuThuNganGridVo
            {
                YeuCauTiepNhanId = o.YeuCauTiepNhan.Id,
                MaBN = o.YeuCauTiepNhan.BenhNhan != null ? o.YeuCauTiepNhan.BenhNhan.MaBN : "",
                NgayThu = o.NgayThu,
                DiaChi = o.YeuCauTiepNhan.DiaChiDayDu,
                GioiTinhStr = o.YeuCauTiepNhan.BenhNhan.GioiTinh.GetDescription(),
                HoTen = o.YeuCauTiepNhan.BenhNhan.HoTen,
                NamSinh = o.YeuCauTiepNhan.BenhNhan.NamSinh,
                SoBLHD = o.SoPhieu.ToString() ?? o.Id.ToString(),
                SoTienThu = o.TienMat.GetValueOrDefault() + o.ChuyenKhoan.GetValueOrDefault() + o.POS.GetValueOrDefault(),
                ThuChiTienBenhNhanStr = o.LoaiThuTienBenhNhan.GetDescription(),
                LoaiPhieu = (int)Enums.LoaiPhieuThuChi.PhieuThu,
                NguoiThu = o.NhanVienThucHien.User.HoTen,

                TienMat = o.TienMat.GetValueOrDefault(),
                ChuyenKhoan = o.ChuyenKhoan.GetValueOrDefault(),
                Pos = o.POS.GetValueOrDefault(),
            });

            var phieuChi = phieuChiDataQuery.Select(o => new DanhSachLichSuThuNganGridVo
            {
                YeuCauTiepNhanId = o.YeuCauTiepNhan.Id,
                MaBN = o.YeuCauTiepNhan.BenhNhan != null ? o.YeuCauTiepNhan.BenhNhan.MaBN : "",
                NgayThu = o.NgayChi,
                GioiTinhStr = o.YeuCauTiepNhan.BenhNhan.GioiTinh.GetDescription(),
                DiaChi = o.YeuCauTiepNhan.DiaChiDayDu,
                NamSinh = o.YeuCauTiepNhan.BenhNhan.NamSinh,
                HoTen = o.YeuCauTiepNhan.BenhNhan.HoTen,
                SoBLHD = o.SoPhieu.ToString() ?? o.Id.ToString(),
                LoaiPhieu = (int)Enums.LoaiPhieuThuChi.PhieuChi,
                SoTienThu = (o.TienMat.GetValueOrDefault() + o.ChuyenKhoan.GetValueOrDefault()) * -1,
                ThuChiTienBenhNhanStr = o.LoaiChiTienBenhNhan.GetDescription(),
                NguoiThu = o.NhanVienThucHien.User.HoTen,
                TienMat = -(o.TienMat.GetValueOrDefault()),
                ChuyenKhoan = -(o.ChuyenKhoan.GetValueOrDefault()),
                Pos = 0
            });


            var phieuHuy = dataHuy.Select(o => new DanhSachLichSuThuNganGridVo
            {
                YeuCauTiepNhanId = o.YeuCauTiepNhan.Id,
                MaBN = o.YeuCauTiepNhan.BenhNhan != null ? o.YeuCauTiepNhan.BenhNhan.MaBN : "",
                NgayThu = o.NgayHuy,
                DiaChi = o.YeuCauTiepNhan.DiaChiDayDu,
                GioiTinhStr = o.YeuCauTiepNhan.BenhNhan.GioiTinh.GetDescription(),
                HoTen = o.YeuCauTiepNhan.BenhNhan.HoTen,
                NamSinh = o.YeuCauTiepNhan.BenhNhan.NamSinh,
                SoBLHD = o.Id.ToString(),
                SoTienThu = o.TaiKhoanBenhNhanThus.Select(oo => oo.TienMat.GetValueOrDefault() + oo.ChuyenKhoan.GetValueOrDefault() + oo.POS.GetValueOrDefault()).Sum(),
                ThuChiTienBenhNhanStr = "Huỷ thanh toán",
                LoaiPhieu = 0,
                NguoiThu = o.NhanVienThucHien.User.HoTen,
                LyDoHuy = o.LyDoHuy,
                TienMat = 0,
                ChuyenKhoan = 0,
                Pos = 0
            });



            if (!string.IsNullOrEmpty(queryInfo.AdditionalSearchString))
            {
                var queryString =
                    JsonConvert.DeserializeObject<DanhSachLichSuThuNganGridVo>(queryInfo.AdditionalSearchString);
                if (!string.IsNullOrEmpty(queryString.FromDate) || !string.IsNullOrEmpty(queryString.ToDate))
                {
                    DateTime denNgay;
                    queryString.FromDate.TryParseExactCustom(out var tuNgay);
                    //DateTime.TryParseExact(queryString.FromDate, "dd/MM/yyyy hh:mm tt", null, DateTimeStyles.None,
                    //    out var tuNgay);
                    if (string.IsNullOrEmpty(queryString.ToDate))
                    {
                        denNgay = DateTime.Now;
                    }
                    else
                    {
                        queryString.ToDate.TryParseExactCustom(out denNgay);
                        //DateTime.TryParseExact(queryString.ToDate, "dd/MM/yyyy hh:mm tt", null, DateTimeStyles.None, out denNgay);
                    }
                    phieuThu = phieuThu.Where(p => p.NgayThu >= tuNgay && p.NgayThu <= denNgay.AddSeconds(59).AddMilliseconds(999));
                    phieuChi = phieuChi.Where(p => p.NgayThu >= tuNgay && p.NgayThu <= denNgay.AddSeconds(59).AddMilliseconds(999));
                    phieuHuy = phieuHuy.Where(p => p.NgayThu >= tuNgay && p.NgayThu <= denNgay.AddSeconds(59).AddMilliseconds(999));
                }
            }

            var allData = new List<DanhSachLichSuThuNganGridVo>();
            allData.AddRange(phieuThu);
            allData.AddRange(phieuChi);
            allData.AddRange(phieuHuy);

            var dataOrderBy = allData.AsQueryable().OrderBy(queryInfo.SortString);
            var thuNgan = isAllData == true ? dataOrderBy.ToArray() : dataOrderBy.Skip(queryInfo.Skip).Take(queryInfo.Take).ToArray();
            var countTask = dataOrderBy.Count();

            return new GridDataSource { Data = thuNgan, TotalRowCount = countTask };
        }

        public GridDataSource GetTotalPageForGridDanhSachLichSuThuNganNganAsync(QueryInfo queryInfo, long yeuCauTiepNhanId = 0)
        {
            ReplaceDisplayValueSortExpression(queryInfo);

            var phieuThuDataQuery = yeuCauTiepNhanId == 0 ? _taiKhoanBenhNhanThu.TableNoTracking
                                               .Where(o => o.LoaiNoiThu == Enums.LoaiNoiThu.ThuNgan && (o.LoaiThuTienBenhNhan == Enums.LoaiThuTienBenhNhan.ThuTheoChiPhi
                                                || o.LoaiThuTienBenhNhan == Enums.LoaiThuTienBenhNhan.ThuTamUng)
                                                )
                                               .ApplyLike(queryInfo.SearchTerms.RemoveUniKeyAndToLower(),
                                                   g => g.Id.ToString().RemoveUniKeyAndToLower(),
                                                   g => g.NgayThu.ToString().RemoveUniKeyAndToLower(),
                                                   g => g.NhanVienThucHien.User.HoTen.RemoveUniKeyAndToLower(),
                                                   g => g.YeuCauTiepNhan.BenhNhan.MaBN,
                                                   g => g.YeuCauTiepNhan.BenhNhan.HoTen.RemoveUniKeyAndToLower()
                                                   ) :
                                               _taiKhoanBenhNhanThu.TableNoTracking.Where(cc => cc.YeuCauTiepNhanId == yeuCauTiepNhanId)
                                               .Where(o => o.LoaiNoiThu == Enums.LoaiNoiThu.ThuNgan && (o.LoaiThuTienBenhNhan == Enums.LoaiThuTienBenhNhan.ThuTheoChiPhi
                                                || o.LoaiThuTienBenhNhan == Enums.LoaiThuTienBenhNhan.ThuTamUng)
                                                )
                                               .ApplyLike(queryInfo.SearchTerms.RemoveUniKeyAndToLower(),
                                                   g => g.Id.ToString().RemoveUniKeyAndToLower(),
                                                   g => g.NgayThu.ToString().RemoveUniKeyAndToLower(),
                                                   g => g.NhanVienThucHien.User.HoTen.RemoveUniKeyAndToLower(),
                                                   g => g.YeuCauTiepNhan.BenhNhan.MaBN,
                                                   g => g.YeuCauTiepNhan.BenhNhan.HoTen.RemoveUniKeyAndToLower()
                                                   );

            var phieuChiDataQuery = yeuCauTiepNhanId == 0 ? _taiKhoanBenhNhanChi.TableNoTracking
                                                 .Where(o => o.LoaiChiTienBenhNhan == Enums.LoaiChiTienBenhNhan.TraLaiBenhNhan
                                                   )
                                            .ApplyLike(queryInfo.SearchTerms.RemoveUniKeyAndToLower(),
                                                   g => g.Id.ToString().RemoveUniKeyAndToLower(),
                                                    g => g.NgayChi.ToString().RemoveUniKeyAndToLower(),
                                                    g => g.NhanVienThucHien.User.HoTen.RemoveUniKeyAndToLower(),
                                                    g => g.YeuCauTiepNhan.BenhNhan.MaBN,
                                                    g => g.YeuCauTiepNhan.BenhNhan.HoTen.RemoveUniKeyAndToLower()
                                                    ) :
                                                    _taiKhoanBenhNhanChi.TableNoTracking.Where(cc => cc.YeuCauTiepNhanId == yeuCauTiepNhanId)
                                                 .Where(o => o.LoaiChiTienBenhNhan == Enums.LoaiChiTienBenhNhan.TraLaiBenhNhan
                                                   )
                                                  .ApplyLike(queryInfo.SearchTerms.RemoveUniKeyAndToLower(),
                                                   g => g.Id.ToString().RemoveUniKeyAndToLower(),
                                                    g => g.NgayChi.ToString().RemoveUniKeyAndToLower(),
                                                    g => g.NhanVienThucHien.User.HoTen.RemoveUniKeyAndToLower(),
                                                    g => g.YeuCauTiepNhan.BenhNhan.MaBN,
                                                    g => g.YeuCauTiepNhan.BenhNhan.HoTen.RemoveUniKeyAndToLower()
                                                    );

            var dataHuy = yeuCauTiepNhanId == 0 ? _taiKhoanBenhNhanHuyDichVu.TableNoTracking.Include(cc => cc.TaiKhoanBenhNhanThus)
                                                .ApplyLike(queryInfo.SearchTerms.RemoveUniKeyAndToLower(),
                                                 g => g.Id.ToString().RemoveUniKeyAndToLower(),
                                                  g => g.NgayHuy.ToString().RemoveUniKeyAndToLower(),
                                                  g => g.NhanVienThucHien.User.HoTen.RemoveUniKeyAndToLower(),
                                                  g => g.YeuCauTiepNhan.BenhNhan.MaBN,
                                                  g => g.YeuCauTiepNhan.BenhNhan.HoTen.RemoveUniKeyAndToLower(),
                                                  g => g.LyDoHuy.RemoveUniKeyAndToLower()
                                                  ) :
                                                   _taiKhoanBenhNhanHuyDichVu.TableNoTracking.Where(cc => cc.YeuCauTiepNhanId == yeuCauTiepNhanId)
                                                   .Include(cc => cc.TaiKhoanBenhNhanThus)
                                                .ApplyLike(queryInfo.SearchTerms.RemoveUniKeyAndToLower(),
                                                 g => g.Id.ToString().RemoveUniKeyAndToLower(),
                                                  g => g.NgayHuy.ToString().RemoveUniKeyAndToLower(),
                                                  g => g.NhanVienThucHien.User.HoTen.RemoveUniKeyAndToLower(),
                                                  g => g.YeuCauTiepNhan.BenhNhan.MaBN,
                                                  g => g.YeuCauTiepNhan.BenhNhan.HoTen.RemoveUniKeyAndToLower(),
                                                  g => g.LyDoHuy.RemoveUniKeyAndToLower()
                                                  );

            var phieuThu = phieuThuDataQuery.Select(o => new DanhSachLichSuThuNganGridVo
            {
                YeuCauTiepNhanId = o.YeuCauTiepNhan.Id,
                MaBN = o.YeuCauTiepNhan.BenhNhan != null ? o.YeuCauTiepNhan.BenhNhan.MaBN : "",
                NgayThu = o.NgayThu,
                DiaChi = o.YeuCauTiepNhan.DiaChiDayDu,
                GioiTinhStr = o.YeuCauTiepNhan.BenhNhan.GioiTinh.GetDescription(),
                HoTen = o.YeuCauTiepNhan.BenhNhan.HoTen,
                NamSinh = o.YeuCauTiepNhan.BenhNhan.NamSinh,
                SoBLHD = o.SoPhieu.ToString() ?? o.Id.ToString(),
                SoTienThu = o.TienMat.GetValueOrDefault() + o.ChuyenKhoan.GetValueOrDefault() + o.POS.GetValueOrDefault(),
                ThuChiTienBenhNhanStr = o.LoaiThuTienBenhNhan.GetDescription(),
                LoaiPhieu = (int)Enums.LoaiPhieuThuChi.PhieuThu,
                NguoiThu = o.NhanVienThucHien.User.HoTen,

                TienMat = o.TienMat.GetValueOrDefault(),
                ChuyenKhoan = o.ChuyenKhoan.GetValueOrDefault(),
                Pos = o.POS.GetValueOrDefault(),
            });

            var phieuChi = phieuChiDataQuery.Select(o => new DanhSachLichSuThuNganGridVo
            {
                YeuCauTiepNhanId = o.YeuCauTiepNhan.Id,
                MaBN = o.YeuCauTiepNhan.BenhNhan != null ? o.YeuCauTiepNhan.BenhNhan.MaBN : "",
                NgayThu = o.NgayChi,
                GioiTinhStr = o.YeuCauTiepNhan.BenhNhan.GioiTinh.GetDescription(),
                DiaChi = o.YeuCauTiepNhan.DiaChiDayDu,
                NamSinh = o.YeuCauTiepNhan.BenhNhan.NamSinh,
                HoTen = o.YeuCauTiepNhan.BenhNhan.HoTen,
                SoBLHD = o.SoPhieu.ToString() ?? o.Id.ToString(),
                LoaiPhieu = (int)Enums.LoaiPhieuThuChi.PhieuChi,
                SoTienThu = (o.TienMat.GetValueOrDefault() + o.ChuyenKhoan.GetValueOrDefault()) * -1,
                ThuChiTienBenhNhanStr = o.LoaiChiTienBenhNhan.GetDescription(),
                NguoiThu = o.NhanVienThucHien.User.HoTen,
                TienMat = -(o.TienMat.GetValueOrDefault()),
                ChuyenKhoan = -(o.ChuyenKhoan.GetValueOrDefault()),
                Pos = 0
            });


            var phieuHuy = dataHuy.Select(o => new DanhSachLichSuThuNganGridVo
            {
                YeuCauTiepNhanId = o.YeuCauTiepNhan.Id,
                MaBN = o.YeuCauTiepNhan.BenhNhan != null ? o.YeuCauTiepNhan.BenhNhan.MaBN : "",
                NgayThu = o.NgayHuy,
                DiaChi = o.YeuCauTiepNhan.DiaChiDayDu,
                GioiTinhStr = o.YeuCauTiepNhan.BenhNhan.GioiTinh.GetDescription(),
                HoTen = o.YeuCauTiepNhan.BenhNhan.HoTen,
                NamSinh = o.YeuCauTiepNhan.BenhNhan.NamSinh,
                SoBLHD = o.Id.ToString(),
                SoTienThu = o.TaiKhoanBenhNhanThus.Select(oo => oo.TienMat.GetValueOrDefault() + oo.ChuyenKhoan.GetValueOrDefault() + oo.POS.GetValueOrDefault()).Sum(),
                ThuChiTienBenhNhanStr = "Huỷ thanh toán",
                LoaiPhieu = 0,
                NguoiThu = o.NhanVienThucHien.User.HoTen,
                LyDoHuy = o.LyDoHuy,
                TienMat = 0,
                ChuyenKhoan = 0,
                Pos = 0
            });



            if (!string.IsNullOrEmpty(queryInfo.AdditionalSearchString))
            {
                var queryString =
                    JsonConvert.DeserializeObject<DanhSachLichSuThuNganGridVo>(queryInfo.AdditionalSearchString);
                if (!string.IsNullOrEmpty(queryString.FromDate) || !string.IsNullOrEmpty(queryString.ToDate))
                {
                    DateTime denNgay;
                    queryString.FromDate.TryParseExactCustom(out var tuNgay);
                    //DateTime.TryParseExact(queryString.FromDate, "dd/MM/yyyy hh:mm tt", null, DateTimeStyles.None,
                    //    out var tuNgay);
                    if (string.IsNullOrEmpty(queryString.ToDate))
                    {
                        denNgay = DateTime.Now;
                    }
                    else
                    {
                        queryString.ToDate.TryParseExactCustom(out denNgay);
                        //DateTime.TryParseExact(queryString.ToDate, "dd/MM/yyyy hh:mm tt", null, DateTimeStyles.None, out denNgay);
                    }
                    phieuThu = phieuThu.Where(p => p.NgayThu >= tuNgay && p.NgayThu <= denNgay.AddSeconds(59).AddMilliseconds(999));
                    phieuChi = phieuChi.Where(p => p.NgayThu >= tuNgay && p.NgayThu <= denNgay.AddSeconds(59).AddMilliseconds(999));
                    phieuHuy = phieuHuy.Where(p => p.NgayThu >= tuNgay && p.NgayThu <= denNgay.AddSeconds(59).AddMilliseconds(999));
                }
            }

            var allData = new List<DanhSachLichSuThuNganGridVo>();
            allData.AddRange(phieuThu);
            allData.AddRange(phieuChi);
            allData.AddRange(phieuHuy);

            var dataOrderBy = allData.AsQueryable().OrderBy(queryInfo.SortString);
            var countTask = dataOrderBy.Count();

            return new GridDataSource { TotalRowCount = countTask };
        }
        //todo: need update or remove
        public async Task<ThongTinThanhToanThuChiVo> GetThongTinThanhToanThuChiVo(long taiKhoanBenhNhanThuId, int loaiPhieu)
        {
            var queryDichVuKhamBenh = _taiKhoanBenhNhanChi.TableNoTracking.Where(o => o.TaiKhoanBenhNhanThuId == taiKhoanBenhNhanThuId)
                .Include(c => c.YeuCauKhamBenh)
                .ThenInclude(cc => cc.CongTyBaoHiemTuNhanCongNos)
                .Where(yc => yc.YeuCauKhamBenh != null && yc.YeuCauKhamBenh.YeuCauGoiDichVuId == null && yc.YeuCauKhamBenh.GoiKhamSucKhoeId == null && yc.YeuCauKhamBenh.TrangThaiThanhToan == Enums.TrangThaiThanhToan.DaThanhToan)
                .Select(s => new ChiPhiKhamChuaBenhVo
                {
                    DanhSachCongNoChoThus = s.TaiKhoanBenhNhanThu.CongTyBaoHiemTuNhanCongNos.Select(o => new DanhSachCongNoVo { CongTyBaoHiemTuNhanId = o.CongTyBaoHiemTuNhanId, SoTienCongNoChoThu = o.SoTien }),
                    SoTienMG = s.YeuCauKhamBenh.SoTienMienGiam.GetValueOrDefault(),
                }).ToListAsync();

            var queryDichVuKyThuat = _taiKhoanBenhNhanChi.TableNoTracking.Where(o => o.TaiKhoanBenhNhanThuId == taiKhoanBenhNhanThuId).Include(c => c.YeuCauDichVuKyThuat).ThenInclude(cc => cc.CongTyBaoHiemTuNhanCongNos)
                .Where(yc => yc.YeuCauDichVuKyThuat != null && yc.YeuCauDichVuKyThuat.YeuCauGoiDichVuId == null && yc.YeuCauDichVuKyThuat.GoiKhamSucKhoeId == null && yc.YeuCauDichVuKyThuat.TrangThaiThanhToan == Enums.TrangThaiThanhToan.DaThanhToan)
                .Select(s => new ChiPhiKhamChuaBenhVo
                {
                    DanhSachCongNoChoThus = s.TaiKhoanBenhNhanThu.CongTyBaoHiemTuNhanCongNos.Select(o => new DanhSachCongNoVo { CongTyBaoHiemTuNhanId = o.CongTyBaoHiemTuNhanId, SoTienCongNoChoThu = o.SoTien }),
                    SoTienMG = s.YeuCauDichVuKyThuat.SoTienMienGiam.GetValueOrDefault(),
                }).ToListAsync();

            var queryDichVuGiuong = _taiKhoanBenhNhanChi.TableNoTracking.Where(o => o.TaiKhoanBenhNhanThuId == taiKhoanBenhNhanThuId).Include(c => c.YeuCauDichVuGiuongBenhVien).ThenInclude(cc => cc.CongTyBaoHiemTuNhanCongNos)
                .Where(yc => yc.YeuCauDichVuGiuongBenhVien != null && yc.YeuCauDichVuGiuongBenhVien.YeuCauGoiDichVuId == null && yc.YeuCauDichVuGiuongBenhVien.TrangThaiThanhToan == Enums.TrangThaiThanhToan.DaThanhToan)
                .Select(s => new ChiPhiKhamChuaBenhVo
                {
                    DanhSachCongNoChoThus = s.TaiKhoanBenhNhanThu.CongTyBaoHiemTuNhanCongNos.Select(o => new DanhSachCongNoVo { CongTyBaoHiemTuNhanId = o.CongTyBaoHiemTuNhanId, SoTienCongNoChoThu = o.SoTien }),
                    SoTienMG = s.YeuCauDichVuGiuongBenhVien.SoTienMienGiam.GetValueOrDefault(),
                }).ToListAsync();

            var queryDuocPham = _taiKhoanBenhNhanChi.TableNoTracking.Where(o => o.TaiKhoanBenhNhanThuId == taiKhoanBenhNhanThuId).Include(c => c.YeuCauDuocPhamBenhVien).ThenInclude(cc => cc.CongTyBaoHiemTuNhanCongNos)
                .Where(yc => yc.YeuCauDuocPhamBenhVien != null && yc.YeuCauDuocPhamBenhVien.YeuCauGoiDichVuId == null && yc.YeuCauDuocPhamBenhVien.TrangThaiThanhToan == Enums.TrangThaiThanhToan.DaThanhToan)
                .Select(s => new ChiPhiKhamChuaBenhVo
                {
                    DanhSachCongNoChoThus = s.TaiKhoanBenhNhanThu.CongTyBaoHiemTuNhanCongNos.Select(o => new DanhSachCongNoVo { CongTyBaoHiemTuNhanId = o.CongTyBaoHiemTuNhanId, SoTienCongNoChoThu = o.SoTien }),
                    SoTienMG = s.YeuCauDuocPhamBenhVien.SoTienMienGiam.GetValueOrDefault(),
                }).ToListAsync();

            var queryVatTu = _taiKhoanBenhNhanChi.TableNoTracking.Where(o => o.TaiKhoanBenhNhanThuId == taiKhoanBenhNhanThuId).Include(c => c.YeuCauVatTuBenhVien).ThenInclude(cc => cc.CongTyBaoHiemTuNhanCongNos)
                .Where(yc => yc.YeuCauVatTuBenhVien != null && yc.YeuCauVatTuBenhVien.YeuCauGoiDichVuId == null && yc.YeuCauVatTuBenhVien.TrangThaiThanhToan == Enums.TrangThaiThanhToan.DaThanhToan)
                .Select(s => new ChiPhiKhamChuaBenhVo
                {
                    DanhSachCongNoChoThus = s.TaiKhoanBenhNhanThu.CongTyBaoHiemTuNhanCongNos.Select(o => new DanhSachCongNoVo { CongTyBaoHiemTuNhanId = o.CongTyBaoHiemTuNhanId, SoTienCongNoChoThu = o.SoTien }),
                    SoTienMG = s.YeuCauVatTuBenhVien.SoTienMienGiam.GetValueOrDefault(),
                }).ToListAsync();

            var queryToaThuoc = _taiKhoanBenhNhanChi.TableNoTracking.Where(o => o.TaiKhoanBenhNhanThuId == taiKhoanBenhNhanThuId).Include(c => c.DonThuocThanhToanChiTiet).ThenInclude(cc => cc.CongTyBaoHiemTuNhanCongNos)
                .Where(yc => yc.DonThuocThanhToanChiTiet != null && yc.DonThuocThanhToanChiTiet.DonThuocThanhToan.LoaiDonThuoc == Enums.EnumLoaiDonThuoc.ThuocBHYT && yc.DonThuocThanhToanChiTiet.DonThuocThanhToan.TrangThaiThanhToan == Enums.TrangThaiThanhToan.DaThanhToan)
                .Select(s => new ChiPhiKhamChuaBenhVo
                {
                    DanhSachCongNoChoThus = s.TaiKhoanBenhNhanThu.CongTyBaoHiemTuNhanCongNos.Select(o => new DanhSachCongNoVo { CongTyBaoHiemTuNhanId = o.CongTyBaoHiemTuNhanId, SoTienCongNoChoThu = o.SoTien }),
                    SoTienMG = s.DonThuocThanhToanChiTiet.SoTienMienGiam.GetValueOrDefault(),
                }).ToListAsync();

            var queryGoiDichVu = _taiKhoanBenhNhanChi.TableNoTracking.Where(o => o.TaiKhoanBenhNhanThuId == taiKhoanBenhNhanThuId).Include(c => c.YeuCauGoiDichVu).ThenInclude(cc => cc.CongTyBaoHiemTuNhanCongNos)
                .Where(yc => yc.YeuCauGoiDichVu != null && yc.YeuCauGoiDichVu.TrangThaiThanhToan == Enums.TrangThaiThanhToan.DaThanhToan)
                .Select(s => new ChiPhiKhamChuaBenhVo
                {
                    DanhSachCongNoChoThus = s.TaiKhoanBenhNhanThu.CongTyBaoHiemTuNhanCongNos.Select(o => new DanhSachCongNoVo { CongTyBaoHiemTuNhanId = o.CongTyBaoHiemTuNhanId, SoTienCongNoChoThu = o.SoTien }),
                    SoTienMG = s.YeuCauGoiDichVu.SoTienMienGiam.GetValueOrDefault(),
                }).ToListAsync();

            await Task.WhenAll(queryDichVuKhamBenh, queryDichVuKyThuat, queryDichVuGiuong, queryDuocPham, queryVatTu, queryToaThuoc, queryGoiDichVu);
            var result = new List<ChiPhiKhamChuaBenhVo>();
            result.AddRange(queryDichVuKhamBenh.Result);
            result.AddRange(queryDichVuKyThuat.Result);
            result.AddRange(queryDichVuGiuong.Result);
            result.AddRange(queryDuocPham.Result);
            result.AddRange(queryVatTu.Result);
            result.AddRange(queryToaThuoc.Result);
            result.AddRange(queryGoiDichVu.Result);

            if ((int)Enums.LoaiPhieuThuChi.PhieuThu == loaiPhieu)
            {
                var taiKhoanBenhNhanThu = _taiKhoanBenhNhanThu.TableNoTracking.Where(o => o.Id == taiKhoanBenhNhanThuId)
              .Select(s => new ThongTinThanhToanThuChiVo
              {
                  ThuChiTienBenhNhanStr = s.LoaiThuTienBenhNhan.GetDescription(),
                  TienMat = s.TienMat,
                  ChuyenKhoan = s.ChuyenKhoan,
                  NgayThuStr = s.NgayThu.ApplyFormatDateTimeSACH(),
                  POS = s.POS,
                  NoiDungThu = s.NoiDungThu,
                  SoTienCongNo = result.SelectMany(cc => cc.DanhSachCongNoChoThus).Select(cc => cc.SoTienCongNoChoThu).Sum(),
                  SoTienGiam = result.Select(cc => cc.SoTienMG).Sum(),
              }).FirstOrDefault();
                return taiKhoanBenhNhanThu;
            }
            else if ((int)Enums.LoaiPhieuThuChi.PhieuChi == loaiPhieu)
            {
                var taiKhoanBenhNhanThu = _taiKhoanBenhNhanChi.TableNoTracking.Where(o => o.Id == taiKhoanBenhNhanThuId)
                 .Select(s => new ThongTinThanhToanThuChiVo
                 {
                     ThuChiTienBenhNhanStr = s.LoaiChiTienBenhNhan.GetDescription(),
                     TienMat = s.TienMat,
                     ChuyenKhoan = s.ChuyenKhoan,
                     NgayThuStr = s.NgayChi.ApplyFormatDateTimeSACH(),
                     POS = 0,
                     NoiDungThu = s.NoiDungChi,
                     SoTienCongNo = result.SelectMany(cc => cc.DanhSachCongNoChoThus).Select(cc => cc.SoTienCongNoChoThu).Sum(),
                     SoTienGiam = result.Select(cc => cc.SoTienMG).Sum(),
                 }).FirstOrDefault();
                return taiKhoanBenhNhanThu;

            }
            else
            {
                var taiKhoanBenhNhanHuyDichVu = _taiKhoanBenhNhanHuyDichVu.TableNoTracking.Where(o => o.Id == taiKhoanBenhNhanThuId);
                var taiKhoanBenhNhanThu = taiKhoanBenhNhanHuyDichVu.Select(s => new ThongTinThanhToanThuChiVo
                {
                    ThuChiTienBenhNhanStr = string.Empty,
                    NoiDungThu = s.LyDoHuy,
                    TienMat = 0,
                    ChuyenKhoan = 0,
                    NgayThuStr = s.NgayHuy.ApplyFormatDateTimeSACH(),
                    POS = 0,
                    SoTienCongNo = result.SelectMany(cc => cc.DanhSachCongNoChoThus).Select(cc => cc.SoTienCongNoChoThu).Sum(),
                    SoTienGiam = result.Select(cc => cc.SoTienMG).Sum(),
                }).FirstOrDefault();

                return taiKhoanBenhNhanThu;
            }

        }

        //todo: need update or remove
        //Danh sách lich sử thu theo chi phí
        public async Task<List<ChiPhiKhamChuaBenhVo>> GetDanhSachLichSuDaThu(long taiKhoanBenhNhanThuId)
        {
            var nguoiThus = _useRepository.TableNoTracking.ToDictionary(c => c.Id, c => c);
            var queryDichVuKhamBenh = _taiKhoanBenhNhanChi.TableNoTracking.Where(o => o.TaiKhoanBenhNhanThuId == taiKhoanBenhNhanThuId)
                .Include(c => c.YeuCauKhamBenh).ThenInclude(cc => cc.SoTienBaoHiemTuNhanChiTra)
                .Include(c => c.YeuCauKhamBenh).ThenInclude(cc => cc.CongTyBaoHiemTuNhanCongNos)
                .Include(cc => cc.TaiKhoanBenhNhanThu).ThenInclude(cc => cc.MienGiamChiPhis)
                .Include(c => c.YeuCauKhamBenh).ThenInclude(cc => cc.NoiDangKy).Include(c => c.YeuCauKhamBenh).ThenInclude(cc => cc.BacSiDangKy).ThenInclude(cc => cc.User)
                .Where(yc => yc.YeuCauKhamBenh != null && yc.YeuCauKhamBenh.YeuCauGoiDichVuId == null && yc.YeuCauKhamBenh.GoiKhamSucKhoeId == null)
                .Select(s => new ChiPhiKhamChuaBenhVo
                {
                    Id = s.YeuCauKhamBenh.Id,
                    LoaiNhom = NhomChiPhiKhamChuaBenh.DichVuKhamBenh,
                    Nhom = NhomChiPhiKhamChuaBenh.DichVuKhamBenh.GetDescription(),
                    Ma = s.YeuCauKhamBenh.DichVuKhamBenhBenhVien.Ma,
                    TenDichVu = s.YeuCauKhamBenh.DichVuKhamBenhBenhVien.Ten,
                    LoaiGia = s.YeuCauKhamBenh.NhomGiaDichVuKhamBenhBenhVien.Ten,
                    Soluong = 1,
                    DonGia = s.YeuCauKhamBenh.Gia,
                    KhongTinhPhi = s.YeuCauKhamBenh.KhongTinhPhi,
                    KiemTraBHYTXacNhan = s.YeuCauKhamBenh.BaoHiemChiTra != null,
                    DuocHuongBHYT = s.YeuCauKhamBenh.DuocHuongBaoHiem,
                    DonGiaBHYT = s.YeuCauKhamBenh.DonGiaBaoHiem.GetValueOrDefault(),
                    TiLeBaoHiemThanhToan = s.YeuCauKhamBenh.TiLeBaoHiemThanhToan.GetValueOrDefault(),
                    MucHuongBaoHiem = s.YeuCauKhamBenh.MucHuongBaoHiem.GetValueOrDefault(),

                    DanhSachCongNoChoThus = s.TaiKhoanBenhNhanThu.CongTyBaoHiemTuNhanCongNos.Select(o => new DanhSachCongNoVo { CongTyBaoHiemTuNhanId = o.CongTyBaoHiemTuNhanId, SoTienCongNoChoThu = o.SoTien }),


                    DaThanhToan = s.TienChiPhi.GetValueOrDefault(),
                    NoiThucHien = (s.YeuCauKhamBenh.NoiDangKy != null ? $"{s.YeuCauKhamBenh.NoiDangKy.Ma}" : "") + (s.YeuCauKhamBenh.BacSiDangKy != null && s.YeuCauKhamBenh.BacSiDangKy.User.HoTen != null ? " - " + $"{s.YeuCauKhamBenh.BacSiDangKy.User.HoTen}" : ""),
                    NguoiThu = s != null && s.NhanVienThucHienId != null ? nguoiThus[s.NhanVienThucHienId ?? 0].HoTen : string.Empty,
                    ThoiGianThuStr = s.NgayChi.ApplyFormatDate(),
                    SoPhieu = s.SoPhieu ?? 1,
                    HuyDichVu = s.YeuCauKhamBenh.TrangThai == Enums.EnumTrangThaiYeuCauKhamBenh.HuyKham,
                    CheckedDefault = true,

                    //update 04/11/2020
                    SoTienMG = s.YeuCauKhamBenh.SoTienMienGiam.GetValueOrDefault(),
                    DanhSachMienGiamVos = s.YeuCauKhamBenh.MienGiamChiPhis.Count == 0 ? new List<DanhSachMienGiamVo>() : s.YeuCauKhamBenh.MienGiamChiPhis.GroupBy(o => new { o.LoaiMienGiam, o.TheVoucherId, o.MaTheVoucher, o.DoiTuongUuDaiId, o.LoaiChietKhau, o.DoiTuongUuDai.Ten }, o => o,
                                                                                                        (k, v) => new DanhSachMienGiamVo
                                                                                                        {
                                                                                                            LoaiMienGiam = k.LoaiMienGiam,
                                                                                                            LoaiChietKhau = k.LoaiChietKhau,
                                                                                                            TheVoucherId = k.TheVoucherId,
                                                                                                            MaTheVoucher = k.MaTheVoucher,
                                                                                                            DoiTuongUuDaiId = k.DoiTuongUuDaiId,
                                                                                                            DoiTuongUuDai = k.Ten,
                                                                                                            TiLe = v.Select(o => o.TiLe).DefaultIfEmpty().Sum(),
                                                                                                            SoTien = v.Select(o => o.SoTien).DefaultIfEmpty().Sum()
                                                                                                        }).Where(o => o.SoTien != 0),
                    GhiChuMienGiamThem = s.YeuCauKhamBenh.GhiChuMienGiamThem,
                    NoiDungGhiChuMiemGiamId = s.YeuCauKhamBenh.NoiDungGhiChuMiemGiamId,

                    SoTienCongNo = s.YeuCauKhamBenh.SoTienBaoHiemTuNhanChiTra.GetValueOrDefault(),
                }).OrderBy(o => o.Id).ToListAsync();

            var queryDichVuKyThuat = _taiKhoanBenhNhanChi.TableNoTracking.Where(o => o.TaiKhoanBenhNhanThuId == taiKhoanBenhNhanThuId)
                .Include(c => c.YeuCauDichVuKyThuat).ThenInclude(cc => cc.SoTienBaoHiemTuNhanChiTra)
                .Include(c => c.YeuCauDichVuKyThuat).ThenInclude(cc => cc.CongTyBaoHiemTuNhanCongNos)
                .Include(c => c.YeuCauDichVuKyThuat).ThenInclude(cc => cc.NoiThucHien)
                .Include(cc => cc.TaiKhoanBenhNhanThu).ThenInclude(cc => cc.MienGiamChiPhis)
                .Where(yc => yc.YeuCauDichVuKyThuat != null && yc.YeuCauDichVuKyThuat.YeuCauGoiDichVuId == null && yc.YeuCauDichVuKyThuat.GoiKhamSucKhoeId == null)
                .Select(s => new ChiPhiKhamChuaBenhVo
                {
                    Id = s.YeuCauDichVuKyThuat.Id,
                    LoaiNhom = NhomChiPhiKhamChuaBenh.DichVuKyThuat,
                    Nhom = NhomChiPhiKhamChuaBenh.DichVuKyThuat.GetDescription(),
                    Ma = s.YeuCauDichVuKyThuat.DichVuKyThuatBenhVien.Ma,
                    TenDichVu = s.YeuCauDichVuKyThuat.DichVuKyThuatBenhVien.Ten,
                    LoaiGia = s.YeuCauDichVuKyThuat.NhomGiaDichVuKyThuatBenhVien.Ten,
                    Soluong = s.YeuCauDichVuKyThuat.SoLan,
                    DonGia = s.YeuCauDichVuKyThuat.Gia,
                    KhongTinhPhi = s.YeuCauDichVuKyThuat.KhongTinhPhi,
                    KiemTraBHYTXacNhan = s.YeuCauDichVuKyThuat.BaoHiemChiTra != null,
                    DuocHuongBHYT = s.YeuCauDichVuKyThuat.DuocHuongBaoHiem,
                    DonGiaBHYT = s.YeuCauDichVuKyThuat.DonGiaBaoHiem.GetValueOrDefault(),
                    TiLeBaoHiemThanhToan = s.YeuCauDichVuKyThuat.TiLeBaoHiemThanhToan.GetValueOrDefault(),
                    MucHuongBaoHiem = s.YeuCauDichVuKyThuat.MucHuongBaoHiem.GetValueOrDefault(),
                    DanhSachCongNoChoThus = s.TaiKhoanBenhNhanThu.CongTyBaoHiemTuNhanCongNos.Select(o => new DanhSachCongNoVo { CongTyBaoHiemTuNhanId = o.CongTyBaoHiemTuNhanId, SoTienCongNoChoThu = o.SoTien }),

                    DaThanhToan = s.YeuCauDichVuKyThuat.SoTienBenhNhanDaChi.GetValueOrDefault(),
                    NoiThucHien = s.NoiThucHien != null
                        ? $"{s.NoiThucHien.Ma} - {s.NoiThucHien.Ten}"
                        : string.Empty,
                    NguoiThu = s != null && s.NhanVienThucHienId != null ? nguoiThus[s.NhanVienThucHienId ?? 0].HoTen : string.Empty,
                    ThoiGianThuStr = s.NgayChi.ApplyFormatDate(),
                    SoPhieu = s.SoPhieu ?? 1,
                    HuyDichVu = s.YeuCauDichVuKyThuat.TrangThai == Enums.EnumTrangThaiYeuCauDichVuKyThuat.DaHuy,
                    CheckedDefault = true,


                    //update 04/11/2020
                    SoTienMG = s.YeuCauDichVuKyThuat.SoTienMienGiam.GetValueOrDefault(),
                    DanhSachMienGiamVos = s.YeuCauDichVuKyThuat.MienGiamChiPhis.Count == 0 ? new List<DanhSachMienGiamVo>() : s.YeuCauDichVuKyThuat.MienGiamChiPhis.GroupBy(o => new { o.LoaiMienGiam, o.TheVoucherId, o.MaTheVoucher, o.DoiTuongUuDaiId, o.LoaiChietKhau, o.DoiTuongUuDai.Ten }, o => o,
                                                                                                        (k, v) => new DanhSachMienGiamVo
                                                                                                        {
                                                                                                            LoaiMienGiam = k.LoaiMienGiam,
                                                                                                            LoaiChietKhau = k.LoaiChietKhau,
                                                                                                            TheVoucherId = k.TheVoucherId,
                                                                                                            MaTheVoucher = k.MaTheVoucher,
                                                                                                            DoiTuongUuDaiId = k.DoiTuongUuDaiId,
                                                                                                            DoiTuongUuDai = k.Ten,
                                                                                                            TiLe = v.Select(o => o.TiLe).DefaultIfEmpty().Sum(),
                                                                                                            SoTien = v.Select(o => o.SoTien).DefaultIfEmpty().Sum()
                                                                                                        }).Where(o => o.SoTien != 0),
                    GhiChuMienGiamThem = s.YeuCauDichVuKyThuat.GhiChuMienGiamThem,
                    NoiDungGhiChuMiemGiamId = s.YeuCauDichVuKyThuat.NoiDungGhiChuMiemGiamId,

                    SoTienCongNo = s.YeuCauDichVuKyThuat.SoTienBaoHiemTuNhanChiTra.GetValueOrDefault(),

                }).ToListAsync();

            var queryDichVuGiuong = _taiKhoanBenhNhanChi.TableNoTracking.Where(o => o.TaiKhoanBenhNhanThuId == taiKhoanBenhNhanThuId)
                .Include(c => c.YeuCauDichVuGiuongBenhVien).ThenInclude(cc => cc.SoTienBaoHiemTuNhanChiTra)
                .Include(c => c.YeuCauDichVuGiuongBenhVien).ThenInclude(cc => cc.CongTyBaoHiemTuNhanCongNos)
                .Include(cc => cc.TaiKhoanBenhNhanThu).ThenInclude(cc => cc.MienGiamChiPhis)
                .Where(yc => yc.YeuCauDichVuGiuongBenhVien != null && yc.YeuCauDichVuGiuongBenhVien.YeuCauGoiDichVuId == null)
                .Select(s => new ChiPhiKhamChuaBenhVo
                {
                    Id = s.YeuCauDichVuGiuongBenhVien.Id,
                    LoaiNhom = NhomChiPhiKhamChuaBenh.DichVuGiuong,
                    Nhom = NhomChiPhiKhamChuaBenh.DichVuGiuong.GetDescription(),
                    Ma = s.YeuCauDichVuGiuongBenhVien.DichVuGiuongBenhVien.Ma,
                    TenDichVu = s.YeuCauDichVuGiuongBenhVien.DichVuGiuongBenhVien.Ten,
                    LoaiGia = s.YeuCauDichVuGiuongBenhVien.NhomGiaDichVuGiuongBenhVien.Ten,
                    Soluong = 1,
                    DonGia = s.YeuCauDichVuGiuongBenhVien.Gia.GetValueOrDefault(),
                    KhongTinhPhi = s.YeuCauDichVuGiuongBenhVien.KhongTinhPhi,
                    KiemTraBHYTXacNhan = s.YeuCauDichVuGiuongBenhVien.BaoHiemChiTra != null,
                    DuocHuongBHYT = s.YeuCauDichVuGiuongBenhVien.DuocHuongBaoHiem,
                    DonGiaBHYT = s.YeuCauDichVuGiuongBenhVien.DonGiaBaoHiem.GetValueOrDefault(),
                    TiLeBaoHiemThanhToan = s.YeuCauDichVuGiuongBenhVien.TiLeBaoHiemThanhToan.GetValueOrDefault(),
                    MucHuongBaoHiem = s.YeuCauDichVuGiuongBenhVien.MucHuongBaoHiem.GetValueOrDefault(),
                    DanhSachCongNoChoThus = s.TaiKhoanBenhNhanThu.CongTyBaoHiemTuNhanCongNos.Select(o => new DanhSachCongNoVo { CongTyBaoHiemTuNhanId = o.CongTyBaoHiemTuNhanId, SoTienCongNoChoThu = o.SoTien }),
                    //SoTienMG = s.TaiKhoanBenhNhanThu.MienGiamChiPhis.Select(cc => cc.SoTien).DefaultIfEmpty(0).Sum(),
                    DaThanhToan = s.YeuCauDichVuGiuongBenhVien.SoTienBenhNhanDaChi.GetValueOrDefault(),
                    NoiThucHien = s.NoiThucHien != null
                        ? $"{s.NoiThucHien.Ma} - {s.NoiThucHien.Ten}"
                        : string.Empty,
                    NguoiThu = s != null && s.NhanVienThucHienId != null ? nguoiThus[s.NhanVienThucHienId ?? 0].HoTen : string.Empty,
                    ThoiGianThuStr = s.NgayChi.ApplyFormatDate(),
                    SoPhieu = s.SoPhieu ?? 1,
                    HuyDichVu = s.YeuCauDichVuGiuongBenhVien.TrangThai == Enums.EnumTrangThaiGiuongBenh.DaHuy,
                    CheckedDefault = true,


                    //update 04/11/2020
                    SoTienMG = s.YeuCauDichVuGiuongBenhVien.SoTienMienGiam.GetValueOrDefault(),
                    DanhSachMienGiamVos = s.YeuCauDichVuGiuongBenhVien.MienGiamChiPhis.Count == 0 ? new List<DanhSachMienGiamVo>() : s.YeuCauDichVuGiuongBenhVien.MienGiamChiPhis.GroupBy(o => new { o.LoaiMienGiam, o.TheVoucherId, o.MaTheVoucher, o.DoiTuongUuDaiId, o.LoaiChietKhau, o.DoiTuongUuDai.Ten }, o => o,
                                                                                                        (k, v) => new DanhSachMienGiamVo
                                                                                                        {
                                                                                                            LoaiMienGiam = k.LoaiMienGiam,
                                                                                                            LoaiChietKhau = k.LoaiChietKhau,
                                                                                                            TheVoucherId = k.TheVoucherId,
                                                                                                            MaTheVoucher = k.MaTheVoucher,
                                                                                                            DoiTuongUuDaiId = k.DoiTuongUuDaiId,
                                                                                                            DoiTuongUuDai = k.Ten,
                                                                                                            TiLe = v.Select(o => o.TiLe).DefaultIfEmpty().Sum(),
                                                                                                            SoTien = v.Select(o => o.SoTien).DefaultIfEmpty().Sum()
                                                                                                        }).Where(o => o.SoTien != 0),
                    GhiChuMienGiamThem = s.YeuCauDichVuGiuongBenhVien.GhiChuMienGiamThem,
                    NoiDungGhiChuMiemGiamId = s.YeuCauDichVuGiuongBenhVien.NoiDungGhiChuMiemGiamId,

                    SoTienCongNo = s.YeuCauDichVuGiuongBenhVien.SoTienBaoHiemTuNhanChiTra.GetValueOrDefault(),

                }).ToListAsync();

            var queryDuocPham = _taiKhoanBenhNhanChi.TableNoTracking.Where(o => o.TaiKhoanBenhNhanThuId == taiKhoanBenhNhanThuId)
                .Include(cc => cc.TaiKhoanBenhNhanThu).ThenInclude(cc => cc.MienGiamChiPhis)
                .Include(c => c.YeuCauDuocPhamBenhVien).ThenInclude(cc => cc.SoTienBaoHiemTuNhanChiTra)
                .Include(c => c.YeuCauDuocPhamBenhVien).ThenInclude(cc => cc.CongTyBaoHiemTuNhanCongNos)
                .Where(yc => yc.YeuCauDuocPhamBenhVien != null && yc.YeuCauDuocPhamBenhVien.YeuCauGoiDichVuId == null)
                .Select(s => new ChiPhiKhamChuaBenhVo
                {
                    Id = s.YeuCauDuocPhamBenhVien.Id,
                    LoaiNhom = NhomChiPhiKhamChuaBenh.DuocPham,
                    Nhom = NhomChiPhiKhamChuaBenh.DuocPham.GetDescription(),
                    Ma = s.YeuCauDuocPhamBenhVien.DuocPhamBenhVien.Ma,
                    TenDichVu = s.YeuCauDuocPhamBenhVien.DuocPhamBenhVien.DuocPham.Ten,
                    LoaiGia = string.Empty,
                    Soluong = s.YeuCauDuocPhamBenhVien.SoLuong,
                    DonGia = s.YeuCauDuocPhamBenhVien.DonGiaBan,
                    KiemTraBHYTXacNhan = s.YeuCauDuocPhamBenhVien.BaoHiemChiTra != null,
                    DuocHuongBHYT = s.YeuCauDuocPhamBenhVien.DuocHuongBaoHiem,
                    DonGiaBHYT = s.YeuCauDuocPhamBenhVien.DonGiaBaoHiem.GetValueOrDefault(),
                    TiLeBaoHiemThanhToan = s.YeuCauDuocPhamBenhVien.TiLeBaoHiemThanhToan.GetValueOrDefault(),
                    MucHuongBaoHiem = s.YeuCauDuocPhamBenhVien.MucHuongBaoHiem.GetValueOrDefault(),
                    DanhSachCongNoChoThus = s.TaiKhoanBenhNhanThu.CongTyBaoHiemTuNhanCongNos.Select(o => new DanhSachCongNoVo { CongTyBaoHiemTuNhanId = o.CongTyBaoHiemTuNhanId, SoTienCongNoChoThu = o.SoTien }),

                    DaThanhToan = s.YeuCauDuocPhamBenhVien.SoTienBenhNhanDaChi.GetValueOrDefault(),
                    NoiThucHien = string.Empty,
                    NguoiThu = s != null && s.NhanVienThucHienId != null ? nguoiThus[s.NhanVienThucHienId ?? 0].HoTen : string.Empty,
                    ThoiGianThuStr = s.NgayChi.ApplyFormatDate(),
                    SoPhieu = s.SoPhieu ?? 1,
                    HuyDichVu = s.YeuCauDuocPhamBenhVien.TrangThai == Enums.EnumYeuCauDuocPhamBenhVien.DaHuy,
                    CheckedDefault = true,

                    //update 04/11/2020
                    SoTienMG = s.YeuCauDuocPhamBenhVien.SoTienMienGiam.GetValueOrDefault(),
                    DanhSachMienGiamVos = s.YeuCauDuocPhamBenhVien.MienGiamChiPhis.Count == 0 ? new List<DanhSachMienGiamVo>() : s.YeuCauDuocPhamBenhVien.MienGiamChiPhis.GroupBy(o => new { o.LoaiMienGiam, o.TheVoucherId, o.MaTheVoucher, o.DoiTuongUuDaiId, o.LoaiChietKhau, o.DoiTuongUuDai.Ten }, o => o,
                                                                                                        (k, v) => new DanhSachMienGiamVo
                                                                                                        {
                                                                                                            LoaiMienGiam = k.LoaiMienGiam,
                                                                                                            LoaiChietKhau = k.LoaiChietKhau,
                                                                                                            TheVoucherId = k.TheVoucherId,
                                                                                                            MaTheVoucher = k.MaTheVoucher,
                                                                                                            DoiTuongUuDaiId = k.DoiTuongUuDaiId,
                                                                                                            DoiTuongUuDai = k.Ten,
                                                                                                            TiLe = v.Select(o => o.TiLe).DefaultIfEmpty().Sum(),
                                                                                                            SoTien = v.Select(o => o.SoTien).DefaultIfEmpty().Sum()
                                                                                                        }).Where(o => o.SoTien != 0),
                    GhiChuMienGiamThem = s.YeuCauDuocPhamBenhVien.GhiChuMienGiamThem,
                    NoiDungGhiChuMiemGiamId = s.YeuCauDuocPhamBenhVien.NoiDungGhiChuMiemGiamId,

                    SoTienCongNo = s.YeuCauDuocPhamBenhVien.SoTienBaoHiemTuNhanChiTra.GetValueOrDefault(),

                }).ToListAsync();

            var queryVatTu = _taiKhoanBenhNhanChi.TableNoTracking.Where(o => o.TaiKhoanBenhNhanThuId == taiKhoanBenhNhanThuId)
                .Include(cc => cc.TaiKhoanBenhNhanThu).ThenInclude(cc => cc.MienGiamChiPhis)
                .Include(c => c.YeuCauVatTuBenhVien).ThenInclude(cc => cc.SoTienBaoHiemTuNhanChiTra)
                .Include(c => c.YeuCauVatTuBenhVien).ThenInclude(cc => cc.CongTyBaoHiemTuNhanCongNos)
                .Where(yc => yc.YeuCauVatTuBenhVien != null && yc.YeuCauVatTuBenhVien.YeuCauGoiDichVuId == null)
                .Select(s => new ChiPhiKhamChuaBenhVo
                {
                    Id = s.YeuCauVatTuBenhVien.Id,
                    LoaiNhom = NhomChiPhiKhamChuaBenh.VatTuTieuHao,
                    Nhom = NhomChiPhiKhamChuaBenh.VatTuTieuHao.GetDescription(),
                    Ma = s.YeuCauVatTuBenhVien.VatTuBenhVien.Ma,
                    TenDichVu = s.YeuCauVatTuBenhVien.VatTuBenhVien.VatTus.Ten,
                    LoaiGia = string.Empty,
                    Soluong = s.YeuCauVatTuBenhVien.SoLuong,
                    DonGia = s.YeuCauVatTuBenhVien.DonGiaBan,
                    KiemTraBHYTXacNhan = s.YeuCauVatTuBenhVien.BaoHiemChiTra != null,
                    DuocHuongBHYT = s.YeuCauVatTuBenhVien.DuocHuongBaoHiem,
                    DonGiaBHYT = s.YeuCauVatTuBenhVien.DonGiaBaoHiem.GetValueOrDefault(),
                    TiLeBaoHiemThanhToan = s.YeuCauVatTuBenhVien.TiLeBaoHiemThanhToan.GetValueOrDefault(),
                    MucHuongBaoHiem = s.YeuCauVatTuBenhVien.MucHuongBaoHiem.GetValueOrDefault(),
                    DanhSachCongNoChoThus = s.TaiKhoanBenhNhanThu.CongTyBaoHiemTuNhanCongNos.Select(o => new DanhSachCongNoVo { CongTyBaoHiemTuNhanId = o.CongTyBaoHiemTuNhanId, SoTienCongNoChoThu = o.SoTien }),

                    DaThanhToan = s.YeuCauVatTuBenhVien.SoTienBenhNhanDaChi.GetValueOrDefault(),
                    NoiThucHien = string.Empty,
                    NguoiThu = s != null && s.NhanVienThucHienId != null ? nguoiThus[s.NhanVienThucHienId ?? 0].HoTen : string.Empty,
                    ThoiGianThuStr = s.NgayChi.ApplyFormatDate(),
                    SoPhieu = s.SoPhieu ?? 1,
                    HuyDichVu = s.YeuCauVatTuBenhVien.TrangThai == Enums.EnumYeuCauVatTuBenhVien.DaHuy,
                    CheckedDefault = true,

                    SoTienMG = s.YeuCauVatTuBenhVien.SoTienMienGiam.GetValueOrDefault(),
                    DanhSachMienGiamVos = s.YeuCauVatTuBenhVien.MienGiamChiPhis.Count == 0 ? new List<DanhSachMienGiamVo>() : s.YeuCauVatTuBenhVien.MienGiamChiPhis.GroupBy(o => new { o.LoaiMienGiam, o.TheVoucherId, o.MaTheVoucher, o.DoiTuongUuDaiId, o.LoaiChietKhau, o.DoiTuongUuDai.Ten }, o => o,
                                                                                                        (k, v) => new DanhSachMienGiamVo
                                                                                                        {
                                                                                                            LoaiMienGiam = k.LoaiMienGiam,
                                                                                                            LoaiChietKhau = k.LoaiChietKhau,
                                                                                                            TheVoucherId = k.TheVoucherId,
                                                                                                            MaTheVoucher = k.MaTheVoucher,
                                                                                                            DoiTuongUuDaiId = k.DoiTuongUuDaiId,
                                                                                                            DoiTuongUuDai = k.Ten,
                                                                                                            TiLe = v.Select(o => o.TiLe).DefaultIfEmpty().Sum(),
                                                                                                            SoTien = v.Select(o => o.SoTien).DefaultIfEmpty().Sum()
                                                                                                        }).Where(o => o.SoTien != 0),
                    GhiChuMienGiamThem = s.YeuCauVatTuBenhVien.GhiChuMienGiamThem,
                    NoiDungGhiChuMiemGiamId = s.YeuCauVatTuBenhVien.NoiDungGhiChuMiemGiamId,

                    SoTienCongNo = s.YeuCauVatTuBenhVien.SoTienBaoHiemTuNhanChiTra.GetValueOrDefault(),

                }).ToListAsync();

            var queryToaThuoc = _taiKhoanBenhNhanChi.TableNoTracking.Where(o => o.TaiKhoanBenhNhanThuId == taiKhoanBenhNhanThuId)
                .Include(cc => cc.TaiKhoanBenhNhanThu).ThenInclude(cc => cc.MienGiamChiPhis)
                .Include(c => c.DonThuocThanhToanChiTiet).ThenInclude(cc => cc.SoTienBaoHiemTuNhanChiTra)
                .Include(c => c.DonThuocThanhToanChiTiet).ThenInclude(cc => cc.CongTyBaoHiemTuNhanCongNos)
                .Where(yc => yc.DonThuocThanhToanChiTiet != null)
                .Select(s => new ChiPhiKhamChuaBenhVo
                {
                    Id = s.DonThuocThanhToanChiTiet.Id,
                    LoaiNhom = NhomChiPhiKhamChuaBenh.ToaThuoc,
                    Nhom = $"{NhomChiPhiKhamChuaBenh.ToaThuoc.GetDescription()}: {s.DonThuocThanhToanChiTiet.DonThuocThanhToan.YeuCauKhamBenhDonThuoc.YeuCauKhamBenh.TenDichVu}",
                    Ma = string.Empty,
                    TenDichVu = s.DonThuocThanhToanChiTiet.Ten,
                    LoaiGia = string.Empty,
                    Soluong = s.DonThuocThanhToanChiTiet.SoLuong,
                    DonGia = s.DonThuocThanhToanChiTiet.DonGiaBan,
                    KiemTraBHYTXacNhan = s.DonThuocThanhToanChiTiet.BaoHiemChiTra != null,
                    DuocHuongBHYT = s.DonThuocThanhToanChiTiet.DuocHuongBaoHiem,
                    DonGiaBHYT = s.DonThuocThanhToanChiTiet.DonGiaBaoHiem.GetValueOrDefault(),
                    TiLeBaoHiemThanhToan = s.DonThuocThanhToanChiTiet.TiLeBaoHiemThanhToan.GetValueOrDefault(),
                    MucHuongBaoHiem = s.DonThuocThanhToanChiTiet.MucHuongBaoHiem.GetValueOrDefault(),
                    DanhSachCongNoChoThus = s.TaiKhoanBenhNhanThu.CongTyBaoHiemTuNhanCongNos.Select(o => new DanhSachCongNoVo { CongTyBaoHiemTuNhanId = o.CongTyBaoHiemTuNhanId, SoTienCongNoChoThu = o.SoTien }),

                    DaThanhToan = s.DonThuocThanhToanChiTiet.SoTienBenhNhanDaChi.GetValueOrDefault(),
                    NoiThucHien = string.Empty,
                    NguoiThu = s != null && s.NhanVienThucHienId != null ? nguoiThus[s.NhanVienThucHienId ?? 0].HoTen : string.Empty,
                    ThoiGianThuStr = s.NgayChi.ApplyFormatDate(),
                    SoPhieu = s.SoPhieu ?? 1,
                    HuyDichVu = false,
                    CheckedDefault = true,

                    SoTienMG = s.DonThuocThanhToanChiTiet.SoTienMienGiam.GetValueOrDefault(),
                    DanhSachMienGiamVos = s.DonThuocThanhToanChiTiet.MienGiamChiPhis.Count == 0 ? new List<DanhSachMienGiamVo>() : s.DonThuocThanhToanChiTiet.MienGiamChiPhis.GroupBy(o => new { o.LoaiMienGiam, o.TheVoucherId, o.MaTheVoucher, o.DoiTuongUuDaiId, o.LoaiChietKhau, o.DoiTuongUuDai.Ten }, o => o,
                                                                                                        (k, v) => new DanhSachMienGiamVo
                                                                                                        {
                                                                                                            LoaiMienGiam = k.LoaiMienGiam,
                                                                                                            LoaiChietKhau = k.LoaiChietKhau,
                                                                                                            TheVoucherId = k.TheVoucherId,
                                                                                                            MaTheVoucher = k.MaTheVoucher,
                                                                                                            DoiTuongUuDaiId = k.DoiTuongUuDaiId,
                                                                                                            DoiTuongUuDai = k.Ten,
                                                                                                            TiLe = v.Select(o => o.TiLe).DefaultIfEmpty().Sum(),
                                                                                                            SoTien = v.Select(o => o.SoTien).DefaultIfEmpty().Sum()
                                                                                                        }).Where(o => o.SoTien != 0),
                    GhiChuMienGiamThem = s.DonThuocThanhToanChiTiet.GhiChuMienGiamThem,
                    NoiDungGhiChuMiemGiamId = s.DonThuocThanhToanChiTiet.NoiDungGhiChuMiemGiamId,

                    SoTienCongNo = s.DonThuocThanhToanChiTiet.SoTienBaoHiemTuNhanChiTra.GetValueOrDefault(),
                }).ToListAsync();

            var queryGoiDichVu = _taiKhoanBenhNhanChi.TableNoTracking.Where(o => o.TaiKhoanBenhNhanThuId == taiKhoanBenhNhanThuId)
                .Include(cc => cc.TaiKhoanBenhNhanThu).ThenInclude(cc => cc.MienGiamChiPhis)
                .Include(c => c.YeuCauGoiDichVu).ThenInclude(cc => cc.SoTienBaoHiemTuNhanChiTra)
                .Include(c => c.YeuCauGoiDichVu).ThenInclude(cc => cc.CongTyBaoHiemTuNhanCongNos)
                .Where(yc => yc.YeuCauGoiDichVu != null)
                .Select(s => new ChiPhiKhamChuaBenhVo
                {
                    Id = s.YeuCauGoiDichVu.Id,
                    LoaiNhom = NhomChiPhiKhamChuaBenh.GoiDichVu,
                    Nhom = NhomChiPhiKhamChuaBenh.GoiDichVu.GetDescription(),
                    Ma = string.Empty,
                    TenDichVu = s.YeuCauGoiDichVu.TenChuongTrinh + " - " + s.YeuCauGoiDichVu.TenGoiDichVu,
                    LoaiGia = string.Empty,
                    Soluong = 1,
                    DonGia = s.YeuCauGoiDichVu.GiaSauChietKhau,
                    KiemTraBHYTXacNhan = false,
                    DuocHuongBHYT = false,
                    DonGiaBHYT = 0,
                    TiLeBaoHiemThanhToan = 0,
                    MucHuongBaoHiem = 0,
                    DanhSachCongNoChoThus = s.YeuCauGoiDichVu.CongTyBaoHiemTuNhanCongNos.Select(o => new DanhSachCongNoVo { CongTyBaoHiemTuNhanId = o.CongTyBaoHiemTuNhanId, SoTienCongNoChoThu = o.SoTien }),

                    DaThanhToan = s.YeuCauGoiDichVu.SoTienBenhNhanDaChi.GetValueOrDefault(),
                    NoiThucHien = string.Empty,
                    NguoiThu = s != null && s.NhanVienThucHienId != null ? nguoiThus[s.NhanVienThucHienId ?? 0].HoTen : string.Empty,
                    ThoiGianThuStr = s.NgayChi.ApplyFormatDate(),
                    SoPhieu = s.SoPhieu ?? 1,
                    HuyDichVu = s.YeuCauGoiDichVu.TrangThai == Enums.EnumTrangThaiYeuCauGoiDichVu.DaHuy,
                    CheckedDefault = true,

                    SoTienMG = s.YeuCauGoiDichVu.SoTienMienGiam.GetValueOrDefault(),
                    DanhSachMienGiamVos = s.YeuCauGoiDichVu.MienGiamChiPhis.Count == 0 ? new List<DanhSachMienGiamVo>() : s.YeuCauGoiDichVu.MienGiamChiPhis.GroupBy(o => new { o.LoaiMienGiam, o.TheVoucherId, o.MaTheVoucher, o.DoiTuongUuDaiId, o.LoaiChietKhau, o.DoiTuongUuDai.Ten }, o => o,
                                                                                                        (k, v) => new DanhSachMienGiamVo
                                                                                                        {
                                                                                                            LoaiMienGiam = k.LoaiMienGiam,
                                                                                                            LoaiChietKhau = k.LoaiChietKhau,
                                                                                                            TheVoucherId = k.TheVoucherId,
                                                                                                            MaTheVoucher = k.MaTheVoucher,
                                                                                                            DoiTuongUuDaiId = k.DoiTuongUuDaiId,
                                                                                                            DoiTuongUuDai = k.Ten,
                                                                                                            TiLe = v.Select(o => o.TiLe).DefaultIfEmpty().Sum(),
                                                                                                            SoTien = v.Select(o => o.SoTien).DefaultIfEmpty().Sum()
                                                                                                        }).Where(o => o.SoTien != 0),
                    GhiChuMienGiamThem = s.YeuCauGoiDichVu.GhiChuMienGiamThem,
                    NoiDungGhiChuMiemGiamId = s.YeuCauGoiDichVu.NoiDungGhiChuMiemGiamId,

                    SoTienCongNo = s.YeuCauGoiDichVu.SoTienBaoHiemTuNhanChiTra.GetValueOrDefault(),
                }).ToListAsync();

            await Task.WhenAll(queryDichVuKhamBenh, queryDichVuKyThuat, queryDichVuGiuong, queryDuocPham, queryVatTu, queryToaThuoc, queryGoiDichVu);
            var result = new List<ChiPhiKhamChuaBenhVo>();
            result.AddRange(queryDichVuKhamBenh.Result);
            result.AddRange(queryDichVuKyThuat.Result);
            result.AddRange(queryDichVuGiuong.Result);
            result.AddRange(queryDuocPham.Result);
            result.AddRange(queryVatTu.Result);
            result.AddRange(queryToaThuoc.Result);
            result.AddRange(queryGoiDichVu.Result);
            return result;
        }
        //todo: need update or remove
        public async Task<List<ChiPhiKhamChuaBenhVo>> GetDanhSachHuyThuNgan(long taiKhoanHuyId)
        {
            var taiKhoanBenhNhanThus = _taiKhoanBenhNhanThu.TableNoTracking.Where(cc => cc.TaiKhoanBenhNhanHuyDichVuId == taiKhoanHuyId).Select(cc => cc.Id);
            var nguoiThus = _useRepository.TableNoTracking.ToDictionary(c => c.Id, c => c);
            var queryDichVuKhamBenh = _taiKhoanBenhNhanChi.TableNoTracking.Where(o => taiKhoanBenhNhanThus.Contains(o.TaiKhoanBenhNhanThuId.GetValueOrDefault()))
                .Include(c => c.YeuCauKhamBenh).ThenInclude(cc => cc.CongTyBaoHiemTuNhanCongNos)
                .Include(c => c.YeuCauKhamBenh).ThenInclude(cc => cc.NoiDangKy).Include(c => c.YeuCauKhamBenh).ThenInclude(cc => cc.BacSiDangKy).ThenInclude(cc => cc.User)
                .Where(yc => yc.YeuCauKhamBenh != null && yc.YeuCauKhamBenh.YeuCauGoiDichVuId == null && yc.YeuCauKhamBenh.GoiKhamSucKhoeId == null)
                .Select(s => new ChiPhiKhamChuaBenhVo
                {
                    Id = s.YeuCauKhamBenh.Id,
                    LoaiNhom = NhomChiPhiKhamChuaBenh.DichVuKhamBenh,
                    Nhom = NhomChiPhiKhamChuaBenh.DichVuKhamBenh.GetDescription(),
                    Ma = s.YeuCauKhamBenh.DichVuKhamBenhBenhVien.Ma,
                    TenDichVu = s.YeuCauKhamBenh.DichVuKhamBenhBenhVien.Ten,
                    LoaiGia = s.YeuCauKhamBenh.NhomGiaDichVuKhamBenhBenhVien.Ten,
                    Soluong = 1,
                    DonGia = s.YeuCauKhamBenh.Gia,
                    KhongTinhPhi = s.YeuCauKhamBenh.KhongTinhPhi,
                    KiemTraBHYTXacNhan = s.YeuCauKhamBenh.BaoHiemChiTra != null,
                    DuocHuongBHYT = s.YeuCauKhamBenh.DuocHuongBaoHiem,
                    DonGiaBHYT = s.YeuCauKhamBenh.DonGiaBaoHiem.GetValueOrDefault(),
                    TiLeBaoHiemThanhToan = s.YeuCauKhamBenh.TiLeBaoHiemThanhToan.GetValueOrDefault(),
                    MucHuongBaoHiem = s.YeuCauKhamBenh.MucHuongBaoHiem.GetValueOrDefault(),
                    DanhSachCongNoChoThus = s.TaiKhoanBenhNhanThu.CongTyBaoHiemTuNhanCongNos.Select(o => new DanhSachCongNoVo { CongTyBaoHiemTuNhanId = o.CongTyBaoHiemTuNhanId, SoTienCongNoChoThu = o.SoTien }),
                    SoTienMG = s.TaiKhoanBenhNhanThu.MienGiamChiPhis.Select(cc => cc.SoTien).DefaultIfEmpty(0).Sum(),
                    DaThanhToan = s.YeuCauKhamBenh.SoTienBenhNhanDaChi.GetValueOrDefault(),
                    NoiThucHien = (s.YeuCauKhamBenh.NoiDangKy != null ? $"{s.YeuCauKhamBenh.NoiDangKy.Ma}" : "") + (s.YeuCauKhamBenh.BacSiDangKy != null && s.YeuCauKhamBenh.BacSiDangKy.User.HoTen != null ? " - " + $"{s.YeuCauKhamBenh.BacSiDangKy.User.HoTen}" : ""),
                    NguoiThu = s != null && s.NhanVienThucHienId != null ? nguoiThus[s.NhanVienThucHienId ?? 0].HoTen : string.Empty,
                    ThoiGianThuStr = s.NgayChi.ApplyFormatDate(),
                    SoPhieu = s.SoPhieu ?? 1,
                    HuyDichVu = s.YeuCauKhamBenh.TrangThai == Enums.EnumTrangThaiYeuCauKhamBenh.HuyKham,
                    CheckedDefault = true
                }).ToListAsync();

            var queryDichVuKyThuat = _taiKhoanBenhNhanChi.TableNoTracking.Where(o => taiKhoanBenhNhanThus.Contains(o.TaiKhoanBenhNhanThuId.GetValueOrDefault()))
                .Include(c => c.YeuCauDichVuKyThuat).ThenInclude(cc => cc.CongTyBaoHiemTuNhanCongNos)
                .Include(c => c.YeuCauDichVuKyThuat).ThenInclude(cc => cc.NoiThucHien)
                .Where(yc => yc.YeuCauDichVuKyThuat != null && yc.YeuCauDichVuKyThuat.YeuCauGoiDichVuId == null && yc.YeuCauDichVuKyThuat.GoiKhamSucKhoeId == null)
                .Select(s => new ChiPhiKhamChuaBenhVo
                {
                    Id = s.YeuCauDichVuKyThuat.Id,
                    LoaiNhom = NhomChiPhiKhamChuaBenh.DichVuKyThuat,
                    Nhom = NhomChiPhiKhamChuaBenh.DichVuKyThuat.GetDescription(),
                    Ma = s.YeuCauDichVuKyThuat.DichVuKyThuatBenhVien.Ma,
                    TenDichVu = s.YeuCauDichVuKyThuat.DichVuKyThuatBenhVien.Ten,
                    LoaiGia = s.YeuCauDichVuKyThuat.NhomGiaDichVuKyThuatBenhVien.Ten,
                    Soluong = s.YeuCauDichVuKyThuat.SoLan,
                    DonGia = s.YeuCauDichVuKyThuat.Gia,
                    KhongTinhPhi = s.YeuCauDichVuKyThuat.KhongTinhPhi,
                    KiemTraBHYTXacNhan = s.YeuCauDichVuKyThuat.BaoHiemChiTra != null,
                    DuocHuongBHYT = s.YeuCauDichVuKyThuat.DuocHuongBaoHiem,
                    DonGiaBHYT = s.YeuCauDichVuKyThuat.DonGiaBaoHiem.GetValueOrDefault(),
                    TiLeBaoHiemThanhToan = s.YeuCauDichVuKyThuat.TiLeBaoHiemThanhToan.GetValueOrDefault(),
                    MucHuongBaoHiem = s.YeuCauDichVuKyThuat.MucHuongBaoHiem.GetValueOrDefault(),
                    DanhSachCongNoChoThus = s.TaiKhoanBenhNhanThu.CongTyBaoHiemTuNhanCongNos.Select(o => new DanhSachCongNoVo { CongTyBaoHiemTuNhanId = o.CongTyBaoHiemTuNhanId, SoTienCongNoChoThu = o.SoTien }),
                    SoTienMG = s.TaiKhoanBenhNhanThu.MienGiamChiPhis.Select(cc => cc.SoTien).DefaultIfEmpty(0).Sum(),
                    DaThanhToan = s.YeuCauDichVuKyThuat.SoTienBenhNhanDaChi.GetValueOrDefault(),
                    NoiThucHien = s.NoiThucHien != null
                        ? $"{s.NoiThucHien.Ma} - {s.NoiThucHien.Ten}"
                        : string.Empty,
                    NguoiThu = s != null && s.NhanVienThucHienId != null ? nguoiThus[s.NhanVienThucHienId ?? 0].HoTen : string.Empty,
                    ThoiGianThuStr = s.NgayChi.ApplyFormatDate(),
                    SoPhieu = s.SoPhieu ?? 1,
                    HuyDichVu = s.YeuCauDichVuKyThuat.TrangThai == Enums.EnumTrangThaiYeuCauDichVuKyThuat.DaHuy,
                    CheckedDefault = true
                }).ToListAsync();

            var queryDichVuGiuong = _taiKhoanBenhNhanChi.TableNoTracking.Where(o => taiKhoanBenhNhanThus.Contains(o.TaiKhoanBenhNhanThuId.GetValueOrDefault()))
                .Include(c => c.YeuCauDichVuGiuongBenhVien).ThenInclude(cc => cc.CongTyBaoHiemTuNhanCongNos)
                .Where(yc => yc.YeuCauDichVuGiuongBenhVien != null && yc.YeuCauDichVuGiuongBenhVien.YeuCauGoiDichVuId == null)
                .Select(s => new ChiPhiKhamChuaBenhVo
                {
                    Id = s.YeuCauDichVuGiuongBenhVien.Id,
                    LoaiNhom = NhomChiPhiKhamChuaBenh.DichVuGiuong,
                    Nhom = NhomChiPhiKhamChuaBenh.DichVuGiuong.GetDescription(),
                    Ma = s.YeuCauDichVuGiuongBenhVien.DichVuGiuongBenhVien.Ma,
                    TenDichVu = s.YeuCauDichVuGiuongBenhVien.DichVuGiuongBenhVien.Ten,
                    LoaiGia = s.YeuCauDichVuGiuongBenhVien.NhomGiaDichVuGiuongBenhVien.Ten,
                    Soluong = 1,
                    DonGia = s.YeuCauDichVuGiuongBenhVien.Gia.GetValueOrDefault(),
                    KhongTinhPhi = s.YeuCauDichVuGiuongBenhVien.KhongTinhPhi,
                    KiemTraBHYTXacNhan = s.YeuCauDichVuGiuongBenhVien.BaoHiemChiTra != null,
                    DuocHuongBHYT = s.YeuCauDichVuGiuongBenhVien.DuocHuongBaoHiem,
                    DonGiaBHYT = s.YeuCauDichVuGiuongBenhVien.DonGiaBaoHiem.GetValueOrDefault(),
                    TiLeBaoHiemThanhToan = s.YeuCauDichVuGiuongBenhVien.TiLeBaoHiemThanhToan.GetValueOrDefault(),
                    MucHuongBaoHiem = s.YeuCauDichVuGiuongBenhVien.MucHuongBaoHiem.GetValueOrDefault(),
                    DanhSachCongNoChoThus = s.TaiKhoanBenhNhanThu.CongTyBaoHiemTuNhanCongNos.Select(o => new DanhSachCongNoVo { CongTyBaoHiemTuNhanId = o.CongTyBaoHiemTuNhanId, SoTienCongNoChoThu = o.SoTien }),
                    SoTienMG = s.TaiKhoanBenhNhanThu.MienGiamChiPhis.Select(cc => cc.SoTien).DefaultIfEmpty(0).Sum(),
                    DaThanhToan = s.YeuCauDichVuGiuongBenhVien.SoTienBenhNhanDaChi.GetValueOrDefault(),
                    NoiThucHien = s.NoiThucHien != null
                        ? $"{s.NoiThucHien.Ma} - {s.NoiThucHien.Ten}"
                        : string.Empty,
                    NguoiThu = s != null && s.NhanVienThucHienId != null ? nguoiThus[s.NhanVienThucHienId ?? 0].HoTen : string.Empty,
                    ThoiGianThuStr = s.NgayChi.ApplyFormatDate(),
                    SoPhieu = s.SoPhieu ?? 1,
                    HuyDichVu = s.YeuCauDichVuGiuongBenhVien.TrangThai == Enums.EnumTrangThaiGiuongBenh.DaHuy,
                    CheckedDefault = true
                }).ToListAsync();

            var queryDuocPham = _taiKhoanBenhNhanChi.TableNoTracking.Where(o => taiKhoanBenhNhanThus.Contains(o.TaiKhoanBenhNhanThuId.GetValueOrDefault())).Include(c => c.YeuCauDuocPhamBenhVien).ThenInclude(cc => cc.CongTyBaoHiemTuNhanCongNos)
                .Where(yc => yc.YeuCauDuocPhamBenhVien != null && yc.YeuCauDuocPhamBenhVien.YeuCauGoiDichVuId == null)
                .Select(s => new ChiPhiKhamChuaBenhVo
                {
                    Id = s.YeuCauDuocPhamBenhVien.Id,
                    LoaiNhom = NhomChiPhiKhamChuaBenh.DuocPham,
                    Nhom = NhomChiPhiKhamChuaBenh.DuocPham.GetDescription(),
                    Ma = s.YeuCauDuocPhamBenhVien.DuocPhamBenhVien.Ma,
                    TenDichVu = s.YeuCauDuocPhamBenhVien.DuocPhamBenhVien.DuocPham.Ten,
                    LoaiGia = string.Empty,
                    Soluong = s.YeuCauDuocPhamBenhVien.SoLuong,
                    DonGia = s.YeuCauDuocPhamBenhVien.DonGiaBan,
                    KhongTinhPhi = s.YeuCauDuocPhamBenhVien.KhongTinhPhi,
                    KiemTraBHYTXacNhan = s.YeuCauDuocPhamBenhVien.BaoHiemChiTra != null,
                    DuocHuongBHYT = s.YeuCauDuocPhamBenhVien.DuocHuongBaoHiem,
                    DonGiaBHYT = s.YeuCauDuocPhamBenhVien.DonGiaBaoHiem.GetValueOrDefault(),
                    TiLeBaoHiemThanhToan = s.YeuCauDuocPhamBenhVien.TiLeBaoHiemThanhToan.GetValueOrDefault(),
                    MucHuongBaoHiem = s.YeuCauDuocPhamBenhVien.MucHuongBaoHiem.GetValueOrDefault(),
                    DanhSachCongNoChoThus = s.TaiKhoanBenhNhanThu.CongTyBaoHiemTuNhanCongNos.Select(o => new DanhSachCongNoVo { CongTyBaoHiemTuNhanId = o.CongTyBaoHiemTuNhanId, SoTienCongNoChoThu = o.SoTien }),
                    SoTienMG = s.TaiKhoanBenhNhanThu.MienGiamChiPhis.Select(cc => cc.SoTien).DefaultIfEmpty(0).Sum(),
                    DaThanhToan = s.YeuCauDuocPhamBenhVien.SoTienBenhNhanDaChi.GetValueOrDefault(),
                    NoiThucHien = string.Empty,
                    NguoiThu = s != null && s.NhanVienThucHienId != null ? nguoiThus[s.NhanVienThucHienId ?? 0].HoTen : string.Empty,
                    ThoiGianThuStr = s.NgayChi.ApplyFormatDate(),
                    SoPhieu = s.SoPhieu ?? 1,
                    HuyDichVu = s.YeuCauDuocPhamBenhVien.TrangThai == Enums.EnumYeuCauDuocPhamBenhVien.DaHuy,
                    CheckedDefault = true
                }).ToListAsync();

            var queryVatTu = _taiKhoanBenhNhanChi.TableNoTracking.Where(o => taiKhoanBenhNhanThus.Contains(o.TaiKhoanBenhNhanThuId.GetValueOrDefault())).Include(c => c.YeuCauVatTuBenhVien).ThenInclude(cc => cc.CongTyBaoHiemTuNhanCongNos)
                .Where(yc => yc.YeuCauVatTuBenhVien != null && yc.YeuCauVatTuBenhVien.YeuCauGoiDichVuId == null)
                .Select(s => new ChiPhiKhamChuaBenhVo
                {
                    Id = s.YeuCauVatTuBenhVien.Id,
                    LoaiNhom = NhomChiPhiKhamChuaBenh.VatTuTieuHao,
                    Nhom = NhomChiPhiKhamChuaBenh.VatTuTieuHao.GetDescription(),
                    Ma = s.YeuCauVatTuBenhVien.VatTuBenhVien.Ma,
                    TenDichVu = s.YeuCauVatTuBenhVien.VatTuBenhVien.VatTus.Ten,
                    LoaiGia = string.Empty,
                    Soluong = s.YeuCauVatTuBenhVien.SoLuong,
                    DonGia = s.YeuCauVatTuBenhVien.DonGiaBan,
                    KhongTinhPhi = s.YeuCauVatTuBenhVien.KhongTinhPhi,
                    KiemTraBHYTXacNhan = s.YeuCauVatTuBenhVien.BaoHiemChiTra != null,
                    DuocHuongBHYT = s.YeuCauVatTuBenhVien.DuocHuongBaoHiem,
                    DonGiaBHYT = s.YeuCauVatTuBenhVien.DonGiaBaoHiem.GetValueOrDefault(),
                    TiLeBaoHiemThanhToan = s.YeuCauVatTuBenhVien.TiLeBaoHiemThanhToan.GetValueOrDefault(),
                    MucHuongBaoHiem = s.YeuCauVatTuBenhVien.MucHuongBaoHiem.GetValueOrDefault(),
                    DanhSachCongNoChoThus = s.TaiKhoanBenhNhanThu.CongTyBaoHiemTuNhanCongNos.Select(o => new DanhSachCongNoVo { CongTyBaoHiemTuNhanId = o.CongTyBaoHiemTuNhanId, SoTienCongNoChoThu = o.SoTien }),
                    SoTienMG = s.TaiKhoanBenhNhanThu.MienGiamChiPhis.Select(cc => cc.SoTien).DefaultIfEmpty(0).Sum(),
                    DaThanhToan = s.YeuCauVatTuBenhVien.SoTienBenhNhanDaChi.GetValueOrDefault(),
                    NoiThucHien = string.Empty,
                    NguoiThu = s != null && s.NhanVienThucHienId != null ? nguoiThus[s.NhanVienThucHienId ?? 0].HoTen : string.Empty,
                    ThoiGianThuStr = s.NgayChi.ApplyFormatDate(),
                    SoPhieu = s.SoPhieu ?? 1,
                    HuyDichVu = s.YeuCauVatTuBenhVien.TrangThai == Enums.EnumYeuCauVatTuBenhVien.DaHuy,
                    CheckedDefault = true
                }).ToListAsync();

            var queryToaThuoc = _taiKhoanBenhNhanChi.TableNoTracking.Where(o => taiKhoanBenhNhanThus.Contains(o.TaiKhoanBenhNhanThuId.GetValueOrDefault())).Include(c => c.DonThuocThanhToanChiTiet).ThenInclude(cc => cc.CongTyBaoHiemTuNhanCongNos)
                .Where(yc => yc.DonThuocThanhToanChiTiet != null)
                .Select(s => new ChiPhiKhamChuaBenhVo
                {
                    Id = s.DonThuocThanhToanChiTiet.Id,
                    LoaiNhom = NhomChiPhiKhamChuaBenh.ToaThuoc,
                    Nhom = $"{NhomChiPhiKhamChuaBenh.ToaThuoc.GetDescription()}: {s.DonThuocThanhToanChiTiet.DonThuocThanhToan.YeuCauKhamBenhDonThuoc.YeuCauKhamBenh.TenDichVu}",
                    Ma = string.Empty,
                    TenDichVu = s.DonThuocThanhToanChiTiet.Ten,
                    LoaiGia = string.Empty,
                    Soluong = s.DonThuocThanhToanChiTiet.SoLuong,
                    DonGia = s.DonThuocThanhToanChiTiet.DonGiaBan,
                    KiemTraBHYTXacNhan = s.DonThuocThanhToanChiTiet.BaoHiemChiTra != null,
                    DuocHuongBHYT = s.DonThuocThanhToanChiTiet.DuocHuongBaoHiem,
                    DonGiaBHYT = s.DonThuocThanhToanChiTiet.DonGiaBaoHiem.GetValueOrDefault(),
                    TiLeBaoHiemThanhToan = s.DonThuocThanhToanChiTiet.TiLeBaoHiemThanhToan.GetValueOrDefault(),
                    MucHuongBaoHiem = s.DonThuocThanhToanChiTiet.MucHuongBaoHiem.GetValueOrDefault(),
                    DanhSachCongNoChoThus = s.TaiKhoanBenhNhanThu.CongTyBaoHiemTuNhanCongNos.Select(o => new DanhSachCongNoVo { CongTyBaoHiemTuNhanId = o.CongTyBaoHiemTuNhanId, SoTienCongNoChoThu = o.SoTien }),
                    SoTienMG = s.TaiKhoanBenhNhanThu.MienGiamChiPhis.Select(cc => cc.SoTien).DefaultIfEmpty(0).Sum(),
                    DaThanhToan = s.DonThuocThanhToanChiTiet.SoTienBenhNhanDaChi.GetValueOrDefault(),
                    NoiThucHien = string.Empty,
                    NguoiThu = s != null && s.NhanVienThucHienId != null ? nguoiThus[s.NhanVienThucHienId ?? 0].HoTen : string.Empty,
                    ThoiGianThuStr = s.NgayChi.ApplyFormatDate(),
                    SoPhieu = s.SoPhieu ?? 1,
                    HuyDichVu = false,
                    CheckedDefault = true
                }).ToListAsync();

            var queryGoiDichVu = _taiKhoanBenhNhanChi.TableNoTracking.Where(o => taiKhoanBenhNhanThus.Contains(o.TaiKhoanBenhNhanThuId.GetValueOrDefault())).Include(c => c.YeuCauGoiDichVu).ThenInclude(cc => cc.CongTyBaoHiemTuNhanCongNos)
                .Where(yc => yc.YeuCauGoiDichVu != null)
                .Select(s => new ChiPhiKhamChuaBenhVo
                {
                    Id = s.YeuCauGoiDichVu.Id,
                    LoaiNhom = NhomChiPhiKhamChuaBenh.GoiDichVu,
                    Nhom = NhomChiPhiKhamChuaBenh.GoiDichVu.GetDescription(),
                    Ma = string.Empty,
                    TenDichVu = s.YeuCauGoiDichVu.TenChuongTrinh + " - " + s.YeuCauGoiDichVu.TenGoiDichVu,
                    LoaiGia = string.Empty,
                    Soluong = 1,
                    DonGia = s.YeuCauGoiDichVu.GiaSauChietKhau,
                    KiemTraBHYTXacNhan = false,
                    DuocHuongBHYT = false,
                    DonGiaBHYT = 0,
                    TiLeBaoHiemThanhToan = 0,
                    MucHuongBaoHiem = 0,
                    DanhSachCongNoChoThus = s.TaiKhoanBenhNhanThu.CongTyBaoHiemTuNhanCongNos.Select(o => new DanhSachCongNoVo { CongTyBaoHiemTuNhanId = o.CongTyBaoHiemTuNhanId, SoTienCongNoChoThu = o.SoTien }),
                    SoTienMG = s.TaiKhoanBenhNhanThu.MienGiamChiPhis.Select(cc => cc.SoTien).DefaultIfEmpty(0).Sum(),
                    DaThanhToan = s.YeuCauGoiDichVu.SoTienBenhNhanDaChi.GetValueOrDefault(),
                    NoiThucHien = string.Empty,
                    NguoiThu = s != null && s.NhanVienThucHienId != null ? nguoiThus[s.NhanVienThucHienId ?? 0].HoTen : string.Empty,
                    ThoiGianThuStr = s.NgayChi.ApplyFormatDate(),
                    SoPhieu = s.SoPhieu ?? 1,
                    HuyDichVu = s.YeuCauGoiDichVu.TrangThai == Enums.EnumTrangThaiYeuCauGoiDichVu.DaHuy,
                    CheckedDefault = true
                }).ToListAsync();

            await Task.WhenAll(queryDichVuKhamBenh, queryDichVuKyThuat, queryDichVuGiuong, queryDuocPham, queryVatTu, queryToaThuoc, queryGoiDichVu);
            var result = new List<ChiPhiKhamChuaBenhVo>();
            result.AddRange(queryDichVuKhamBenh.Result);
            result.AddRange(queryDichVuKyThuat.Result);
            result.AddRange(queryDichVuGiuong.Result);
            result.AddRange(queryDuocPham.Result);
            result.AddRange(queryVatTu.Result);
            result.AddRange(queryToaThuoc.Result);
            result.AddRange(queryGoiDichVu.Result);
            return result;
        }

        #region Danh Sách Đã Hoàn Thành

        public async Task<GridDataSource> GetDataThuChiTienForThuNganAsync(QueryInfo queryInfo)
        {

            var phieuThuDataQuery = _taiKhoanBenhNhanThu.TableNoTracking.Where(p => p.YeuCauTiepNhanId == Convert.ToDouble(queryInfo.AdditionalSearchString) && p.LoaiNoiThu == Enums.LoaiNoiThu.ThuNgan)
                                               .Where(o => (o.LoaiThuTienBenhNhan == Enums.LoaiThuTienBenhNhan.ThuTheoChiPhi || o.LoaiThuTienBenhNhan == Enums.LoaiThuTienBenhNhan.ThuTamUng));

            var phieuChiDataQuery = _taiKhoanBenhNhanChi.TableNoTracking.Where(cc => cc.YeuCauTiepNhanId == Convert.ToDouble(queryInfo.AdditionalSearchString))
                                                 .Where(o => o.LoaiChiTienBenhNhan == Enums.LoaiChiTienBenhNhan.TraLaiBenhNhan);

            var dataHuy = _taiKhoanBenhNhanHuyDichVu.TableNoTracking.Where(cc => cc.YeuCauTiepNhanId == Convert.ToDouble(queryInfo.AdditionalSearchString))
                                                   .Include(cc => cc.TaiKhoanBenhNhanThus);

            var phieuThu = phieuThuDataQuery.Select(o => new DanhSachLichSuThuNganGridVo
            {
                YeuCauTiepNhanId = o.YeuCauTiepNhan.Id,
                MaBN = o.YeuCauTiepNhan.BenhNhan != null ? o.YeuCauTiepNhan.BenhNhan.MaBN : "",
                NgayThu = o.NgayThu,
                DiaChi = o.YeuCauTiepNhan.DiaChiDayDu,
                GioiTinhStr = o.YeuCauTiepNhan.BenhNhan.GioiTinh.GetDescription(),
                HoTen = o.YeuCauTiepNhan.BenhNhan.HoTen,
                NamSinh = o.YeuCauTiepNhan.BenhNhan.NamSinh,
                SoBLHD = o.SoPhieu.ToString() ?? o.Id.ToString(),
                SoTienThu = o.TienMat.GetValueOrDefault() + o.ChuyenKhoan.GetValueOrDefault() + o.POS.GetValueOrDefault(),
                ThuChiTienBenhNhanStr = o.LoaiThuTienBenhNhan.GetDescription(),
                LoaiPhieu = (int)Enums.LoaiPhieuThuChi.PhieuThu,
                NguoiThu = o.NhanVienThucHien.User.HoTen,
                SoTienMiemGiam = o.MienGiamChiPhis.Select(cc => cc.SoTien).DefaultIfEmpty(0).Sum(),
                SoTienCongNo = o.CongNo,
                TienMat = o.TienMat.GetValueOrDefault(),
                ChuyenKhoan = o.ChuyenKhoan.GetValueOrDefault(),
                Pos = o.POS.GetValueOrDefault(),
            });

            var phieuChi = phieuChiDataQuery.Select(o => new DanhSachLichSuThuNganGridVo
            {
                YeuCauTiepNhanId = o.YeuCauTiepNhan.Id,
                MaBN = o.YeuCauTiepNhan.BenhNhan != null ? o.YeuCauTiepNhan.BenhNhan.MaBN : "",
                NgayThu = o.NgayChi,
                GioiTinhStr = o.YeuCauTiepNhan.BenhNhan.GioiTinh.GetDescription(),
                DiaChi = o.YeuCauTiepNhan.DiaChiDayDu,
                NamSinh = o.YeuCauTiepNhan.BenhNhan.NamSinh,
                HoTen = o.YeuCauTiepNhan.BenhNhan.HoTen,
                SoBLHD = o.SoPhieu.ToString() ?? o.Id.ToString(),
                LoaiPhieu = (int)Enums.LoaiPhieuThuChi.PhieuChi,
                SoTienThu = (o.TienMat.GetValueOrDefault() + o.ChuyenKhoan.GetValueOrDefault()) * -1,
                ThuChiTienBenhNhanStr = o.LoaiChiTienBenhNhan.GetDescription(),
                NguoiThu = o.NhanVienThucHien.User.HoTen,
                TienMat = -(o.TienMat.GetValueOrDefault()),
                ChuyenKhoan = -(o.ChuyenKhoan.GetValueOrDefault()),
                Pos = 0,

                SoTienMiemGiam = 0,
                SoTienCongNo = 0,
            });


            var phieuHuy = dataHuy.Select(o => new DanhSachLichSuThuNganGridVo
            {
                YeuCauTiepNhanId = o.YeuCauTiepNhan.Id,
                MaBN = o.YeuCauTiepNhan.BenhNhan != null ? o.YeuCauTiepNhan.BenhNhan.MaBN : "",
                NgayThu = o.NgayHuy,
                DiaChi = o.YeuCauTiepNhan.DiaChiDayDu,
                GioiTinhStr = o.YeuCauTiepNhan.BenhNhan.GioiTinh.GetDescription(),
                HoTen = o.YeuCauTiepNhan.BenhNhan.HoTen,
                NamSinh = o.YeuCauTiepNhan.BenhNhan.NamSinh,
                SoBLHD = o.Id.ToString(),
                SoTienThu = o.TaiKhoanBenhNhanThus.Select(oo => oo.TienMat.GetValueOrDefault() + oo.ChuyenKhoan.GetValueOrDefault() + oo.POS.GetValueOrDefault()).Sum(),
                ThuChiTienBenhNhanStr = "Huỷ thanh toán",
                LoaiPhieu = 0,
                NguoiThu = o.NhanVienThucHien.User.HoTen,
                LyDoHuy = o.LyDoHuy,
                TienMat = 0,
                ChuyenKhoan = 0,
                Pos = 0,

                SoTienMiemGiam = 0,
                SoTienCongNo = 0,
            });

            var allData = new List<DanhSachLichSuThuNganGridVo>();
            allData.AddRange(phieuThu);
            allData.AddRange(phieuChi);
            allData.AddRange(phieuHuy);

            var dataOrderBy = allData.AsQueryable();
            var thuNgan = dataOrderBy.Skip(queryInfo.Skip).Take(queryInfo.Take).ToArray();
            var countTask = dataOrderBy.Count();
            return new GridDataSource
            {
                Data = thuNgan,
                TotalRowCount = countTask
            };
        }
        //todo: need update or remove
        //update 11/05/2020
        public async Task<GridDataSource> GetDataDanhSachDaThuTheoSoHDAsync(QueryInfo queryInfo)
        {

            var nguoiThus = _useRepository.TableNoTracking.ToDictionary(c => c.Id, c => c);
            var queryDichVuKhamBenh = _taiKhoanBenhNhanChi.TableNoTracking.Where(o => o.TaiKhoanBenhNhanThuId == Convert.ToDouble(queryInfo.AdditionalSearchString)).
                Include(c => c.YeuCauKhamBenh).ThenInclude(cc => cc.CongTyBaoHiemTuNhanCongNos)
                 .Include(c => c.YeuCauKhamBenh).ThenInclude(cc => cc.NoiDangKy).Include(c => c.YeuCauKhamBenh).ThenInclude(cc => cc.BacSiDangKy).ThenInclude(cc => cc.User)
                .Where(yc => yc.YeuCauKhamBenh != null && yc.YeuCauKhamBenh.YeuCauGoiDichVuId == null)
                .Select(s => new ChiPhiKhamChuaBenhVo
                {
                    Id = s.YeuCauKhamBenh.Id,
                    LoaiNhom = NhomChiPhiKhamChuaBenh.DichVuKhamBenh,
                    Nhom = NhomChiPhiKhamChuaBenh.DichVuKhamBenh.GetDescription(),
                    Ma = s.YeuCauKhamBenh.DichVuKhamBenhBenhVien.Ma,
                    TenDichVu = s.YeuCauKhamBenh.DichVuKhamBenhBenhVien.Ten,
                    LoaiGia = s.YeuCauKhamBenh.NhomGiaDichVuKhamBenhBenhVien.Ten,
                    Soluong = 1,
                    DonGia = s.YeuCauKhamBenh.Gia,
                    KhongTinhPhi = s.YeuCauKhamBenh.KhongTinhPhi,
                    KiemTraBHYTXacNhan = s.YeuCauKhamBenh.BaoHiemChiTra != null,
                    DuocHuongBHYT = s.YeuCauKhamBenh.DuocHuongBaoHiem,
                    DonGiaBHYT = s.YeuCauKhamBenh.DonGiaBaoHiem.GetValueOrDefault(),
                    TiLeBaoHiemThanhToan = s.YeuCauKhamBenh.TiLeBaoHiemThanhToan.GetValueOrDefault(),
                    MucHuongBaoHiem = s.YeuCauKhamBenh.MucHuongBaoHiem.GetValueOrDefault(),
                    DanhSachCongNoChoThus = s.YeuCauKhamBenh.CongTyBaoHiemTuNhanCongNos.Select(o => new DanhSachCongNoVo { CongTyBaoHiemTuNhanId = o.CongTyBaoHiemTuNhanId, SoTienCongNoChoThu = o.SoTien }),

                    DaThanhToan = s.YeuCauKhamBenh.SoTienBenhNhanDaChi.GetValueOrDefault(),
                    NoiThucHien = (s.YeuCauKhamBenh.NoiDangKy != null ? $"{s.YeuCauKhamBenh.NoiDangKy.Ma}" : "") + (s.YeuCauKhamBenh.BacSiDangKy != null && s.YeuCauKhamBenh.BacSiDangKy.User.HoTen != null ? " - " + $"{s.YeuCauKhamBenh.BacSiDangKy.User.HoTen}" : ""),
                    NguoiThu = s != null && s.NhanVienThucHienId != null ? nguoiThus[s.NhanVienThucHienId ?? 0].HoTen : string.Empty,
                    ThoiGianThuStr = s.NgayChi.ApplyFormatDate(),
                    SoPhieu = s.SoPhieu ?? 1,
                    DonViTinh = "Lần",
                    CheckedDefault = true,

                    SoTienMG = s.YeuCauKhamBenh.SoTienMienGiam.GetValueOrDefault(),
                    DanhSachMienGiamVos = s.YeuCauKhamBenh.MienGiamChiPhis.Count == 0 ? new List<DanhSachMienGiamVo>() : s.YeuCauKhamBenh.MienGiamChiPhis.GroupBy(o => new { o.LoaiMienGiam, o.TheVoucherId, o.MaTheVoucher, o.DoiTuongUuDaiId, o.LoaiChietKhau, o.DoiTuongUuDai.Ten }, o => o,
                                                                                                        (k, v) => new DanhSachMienGiamVo
                                                                                                        {
                                                                                                            LoaiMienGiam = k.LoaiMienGiam,
                                                                                                            LoaiChietKhau = k.LoaiChietKhau,
                                                                                                            TheVoucherId = k.TheVoucherId,
                                                                                                            MaTheVoucher = k.MaTheVoucher,
                                                                                                            DoiTuongUuDaiId = k.DoiTuongUuDaiId,
                                                                                                            DoiTuongUuDai = k.Ten,
                                                                                                            TiLe = v.Select(o => o.TiLe).DefaultIfEmpty().Sum(),
                                                                                                            SoTien = v.Select(o => o.SoTien).DefaultIfEmpty().Sum()
                                                                                                        }).Where(o => o.SoTien != 0),
                    GhiChuMienGiamThem = s.YeuCauKhamBenh.GhiChuMienGiamThem,
                    NoiDungGhiChuMiemGiamId = s.YeuCauKhamBenh.NoiDungGhiChuMiemGiamId,

                }).OrderBy(o => o.Id).ToListAsync();

            var queryDichVuKyThuat = _taiKhoanBenhNhanChi.TableNoTracking.Where(o => o.TaiKhoanBenhNhanThuId == Convert.ToDouble(queryInfo.AdditionalSearchString))
                .Include(c => c.YeuCauDichVuKyThuat).ThenInclude(cc => cc.CongTyBaoHiemTuNhanCongNos)
                .Include(c => c.YeuCauDichVuKyThuat).ThenInclude(cc => cc.NoiThucHien)
                .Where(yc => yc.YeuCauDichVuKyThuat != null && yc.YeuCauDichVuKyThuat.YeuCauGoiDichVuId == null)
                .Select(s => new ChiPhiKhamChuaBenhVo
                {
                    Id = s.YeuCauDichVuKyThuat.Id,
                    LoaiNhom = NhomChiPhiKhamChuaBenh.DichVuKyThuat,
                    Nhom = NhomChiPhiKhamChuaBenh.DichVuKyThuat.GetDescription(),
                    Ma = s.YeuCauDichVuKyThuat.DichVuKyThuatBenhVien.Ma,
                    TenDichVu = s.YeuCauDichVuKyThuat.DichVuKyThuatBenhVien.Ten,
                    LoaiGia = s.YeuCauDichVuKyThuat.NhomGiaDichVuKyThuatBenhVien.Ten,
                    Soluong = s.YeuCauDichVuKyThuat.SoLan,
                    DonGia = s.YeuCauDichVuKyThuat.Gia,
                    KhongTinhPhi = s.YeuCauDichVuKyThuat.KhongTinhPhi,
                    KiemTraBHYTXacNhan = s.YeuCauDichVuKyThuat.BaoHiemChiTra != null,
                    DuocHuongBHYT = s.YeuCauDichVuKyThuat.DuocHuongBaoHiem,
                    DonGiaBHYT = s.YeuCauDichVuKyThuat.DonGiaBaoHiem.GetValueOrDefault(),
                    TiLeBaoHiemThanhToan = s.YeuCauDichVuKyThuat.TiLeBaoHiemThanhToan.GetValueOrDefault(),
                    MucHuongBaoHiem = s.YeuCauDichVuKyThuat.MucHuongBaoHiem.GetValueOrDefault(),
                    DanhSachCongNoChoThus = s.YeuCauDichVuKyThuat.CongTyBaoHiemTuNhanCongNos.Select(o => new DanhSachCongNoVo { CongTyBaoHiemTuNhanId = o.CongTyBaoHiemTuNhanId, SoTienCongNoChoThu = o.SoTien }),

                    DaThanhToan = s.YeuCauDichVuKyThuat.SoTienBenhNhanDaChi.GetValueOrDefault(),
                    NoiThucHien = s.NoiThucHien != null
                        ? $"{s.NoiThucHien.Ma} - {s.NoiThucHien.Ten}"
                        : string.Empty,
                    NguoiThu = s != null && s.NhanVienThucHienId != null ? nguoiThus[s.NhanVienThucHienId ?? 0].HoTen : string.Empty,
                    ThoiGianThuStr = s.NgayChi.ApplyFormatDate(),
                    SoPhieu = s.SoPhieu ?? 1,
                    CheckedDefault = true,
                    DonViTinh = "Lần",

                    SoTienMG = s.YeuCauDichVuKyThuat.SoTienMienGiam.GetValueOrDefault(),
                    DanhSachMienGiamVos = s.YeuCauDichVuKyThuat.MienGiamChiPhis.Count == 0 ? new List<DanhSachMienGiamVo>() : s.YeuCauDichVuKyThuat.MienGiamChiPhis.GroupBy(o => new { o.LoaiMienGiam, o.TheVoucherId, o.MaTheVoucher, o.DoiTuongUuDaiId, o.LoaiChietKhau, o.DoiTuongUuDai.Ten }, o => o,
                                                                                                        (k, v) => new DanhSachMienGiamVo
                                                                                                        {
                                                                                                            LoaiMienGiam = k.LoaiMienGiam,
                                                                                                            LoaiChietKhau = k.LoaiChietKhau,
                                                                                                            TheVoucherId = k.TheVoucherId,
                                                                                                            MaTheVoucher = k.MaTheVoucher,
                                                                                                            DoiTuongUuDaiId = k.DoiTuongUuDaiId,
                                                                                                            DoiTuongUuDai = k.Ten,
                                                                                                            TiLe = v.Select(o => o.TiLe).DefaultIfEmpty().Sum(),
                                                                                                            SoTien = v.Select(o => o.SoTien).DefaultIfEmpty().Sum()
                                                                                                        }).Where(o => o.SoTien != 0),
                    GhiChuMienGiamThem = s.YeuCauDichVuKyThuat.GhiChuMienGiamThem,
                    NoiDungGhiChuMiemGiamId = s.YeuCauDichVuKyThuat.NoiDungGhiChuMiemGiamId,

                }).ToListAsync();

            var queryDichVuGiuong = _taiKhoanBenhNhanChi.TableNoTracking.Where(o => o.TaiKhoanBenhNhanThuId == Convert.ToDouble(queryInfo.AdditionalSearchString))
                .Include(c => c.YeuCauDichVuGiuongBenhVien).ThenInclude(cc => cc.CongTyBaoHiemTuNhanCongNos)
                .Where(yc => yc.YeuCauDichVuGiuongBenhVien != null && yc.YeuCauDichVuGiuongBenhVien.YeuCauGoiDichVuId == null)
                .Select(s => new ChiPhiKhamChuaBenhVo
                {
                    Id = s.YeuCauDichVuGiuongBenhVien.Id,
                    LoaiNhom = NhomChiPhiKhamChuaBenh.DichVuGiuong,
                    Nhom = NhomChiPhiKhamChuaBenh.DichVuGiuong.GetDescription(),
                    Ma = s.YeuCauDichVuGiuongBenhVien.DichVuGiuongBenhVien.Ma,
                    TenDichVu = s.YeuCauDichVuGiuongBenhVien.DichVuGiuongBenhVien.Ten,
                    LoaiGia = s.YeuCauDichVuGiuongBenhVien.NhomGiaDichVuGiuongBenhVien.Ten,
                    Soluong = 1,
                    DonGia = s.YeuCauDichVuGiuongBenhVien.Gia.GetValueOrDefault(),
                    KhongTinhPhi = s.YeuCauDichVuGiuongBenhVien.KhongTinhPhi,
                    KiemTraBHYTXacNhan = s.YeuCauDichVuGiuongBenhVien.BaoHiemChiTra != null,
                    DuocHuongBHYT = s.YeuCauDichVuGiuongBenhVien.DuocHuongBaoHiem,
                    DonGiaBHYT = s.YeuCauDichVuGiuongBenhVien.DonGiaBaoHiem.GetValueOrDefault(),
                    TiLeBaoHiemThanhToan = s.YeuCauDichVuGiuongBenhVien.TiLeBaoHiemThanhToan.GetValueOrDefault(),
                    MucHuongBaoHiem = s.YeuCauDichVuGiuongBenhVien.MucHuongBaoHiem.GetValueOrDefault(),
                    DanhSachCongNoChoThus = s.YeuCauDichVuGiuongBenhVien.CongTyBaoHiemTuNhanCongNos.Select(o => new DanhSachCongNoVo { CongTyBaoHiemTuNhanId = o.CongTyBaoHiemTuNhanId, SoTienCongNoChoThu = o.SoTien }),

                    DaThanhToan = s.YeuCauDichVuGiuongBenhVien.SoTienBenhNhanDaChi.GetValueOrDefault(),
                    NoiThucHien = s.NoiThucHien != null
                        ? $"{s.NoiThucHien.Ma} - {s.NoiThucHien.Ten}"
                        : string.Empty,
                    NguoiThu = s != null && s.NhanVienThucHienId != null ? nguoiThus[s.NhanVienThucHienId ?? 0].HoTen : string.Empty,
                    ThoiGianThuStr = s.NgayChi.ApplyFormatDate(),
                    SoPhieu = s.SoPhieu ?? 1,
                    CheckedDefault = true,
                    DonViTinh = "Lần",

                    SoTienMG = s.YeuCauDichVuGiuongBenhVien.SoTienMienGiam.GetValueOrDefault(),
                    DanhSachMienGiamVos = s.YeuCauDichVuGiuongBenhVien.MienGiamChiPhis.Count == 0 ? new List<DanhSachMienGiamVo>() : s.YeuCauDichVuGiuongBenhVien.MienGiamChiPhis.GroupBy(o => new { o.LoaiMienGiam, o.TheVoucherId, o.MaTheVoucher, o.DoiTuongUuDaiId, o.LoaiChietKhau, o.DoiTuongUuDai.Ten }, o => o,
                                                                                                        (k, v) => new DanhSachMienGiamVo
                                                                                                        {
                                                                                                            LoaiMienGiam = k.LoaiMienGiam,
                                                                                                            LoaiChietKhau = k.LoaiChietKhau,
                                                                                                            TheVoucherId = k.TheVoucherId,
                                                                                                            MaTheVoucher = k.MaTheVoucher,
                                                                                                            DoiTuongUuDaiId = k.DoiTuongUuDaiId,
                                                                                                            DoiTuongUuDai = k.Ten,
                                                                                                            TiLe = v.Select(o => o.TiLe).DefaultIfEmpty().Sum(),
                                                                                                            SoTien = v.Select(o => o.SoTien).DefaultIfEmpty().Sum()
                                                                                                        }).Where(o => o.SoTien != 0),
                    GhiChuMienGiamThem = s.YeuCauDichVuGiuongBenhVien.GhiChuMienGiamThem,
                    NoiDungGhiChuMiemGiamId = s.YeuCauDichVuGiuongBenhVien.NoiDungGhiChuMiemGiamId,

                }).ToListAsync();

            var queryDuocPham = _taiKhoanBenhNhanChi.TableNoTracking.Where(o => o.TaiKhoanBenhNhanThuId == Convert.ToDouble(queryInfo.AdditionalSearchString)).Include(c => c.YeuCauDuocPhamBenhVien).ThenInclude(cc => cc.CongTyBaoHiemTuNhanCongNos)
                .Where(yc => yc.YeuCauDuocPhamBenhVien != null && yc.YeuCauDuocPhamBenhVien.YeuCauGoiDichVuId == null)
                .Select(s => new ChiPhiKhamChuaBenhVo
                {
                    Id = s.YeuCauDuocPhamBenhVien.Id,
                    LoaiNhom = NhomChiPhiKhamChuaBenh.DuocPham,
                    Nhom = NhomChiPhiKhamChuaBenh.DuocPham.GetDescription(),
                    Ma = s.YeuCauDuocPhamBenhVien.DuocPhamBenhVien.Ma,
                    TenDichVu = s.YeuCauDuocPhamBenhVien.DuocPhamBenhVien.DuocPham.Ten,
                    LoaiGia = string.Empty,
                    Soluong = s.YeuCauDuocPhamBenhVien.SoLuong,
                    DonGia = s.YeuCauDuocPhamBenhVien.DonGiaBan,
                    KhongTinhPhi = s.YeuCauDuocPhamBenhVien.KhongTinhPhi,
                    KiemTraBHYTXacNhan = s.YeuCauDuocPhamBenhVien.BaoHiemChiTra != null,
                    DuocHuongBHYT = s.YeuCauDuocPhamBenhVien.DuocHuongBaoHiem,
                    DonGiaBHYT = s.YeuCauDuocPhamBenhVien.DonGiaBaoHiem.GetValueOrDefault(),
                    TiLeBaoHiemThanhToan = s.YeuCauDuocPhamBenhVien.TiLeBaoHiemThanhToan.GetValueOrDefault(),
                    MucHuongBaoHiem = s.YeuCauDuocPhamBenhVien.MucHuongBaoHiem.GetValueOrDefault(),
                    DanhSachCongNoChoThus = s.YeuCauDuocPhamBenhVien.CongTyBaoHiemTuNhanCongNos.Select(o => new DanhSachCongNoVo { CongTyBaoHiemTuNhanId = o.CongTyBaoHiemTuNhanId, SoTienCongNoChoThu = o.SoTien }),

                    DaThanhToan = s.YeuCauDuocPhamBenhVien.SoTienBenhNhanDaChi.GetValueOrDefault(),
                    NoiThucHien = string.Empty,
                    NguoiThu = s != null && s.NhanVienThucHienId != null ? nguoiThus[s.NhanVienThucHienId ?? 0].HoTen : string.Empty,
                    ThoiGianThuStr = s.NgayChi.ApplyFormatDate(),
                    SoPhieu = s.SoPhieu ?? 1,
                    CheckedDefault = true,
                    DonViTinh = "Lần",

                    SoTienMG = s.YeuCauKhamBenh.SoTienMienGiam.GetValueOrDefault(),
                    DanhSachMienGiamVos = s.YeuCauKhamBenh.MienGiamChiPhis.Count == 0 ? new List<DanhSachMienGiamVo>() : s.YeuCauKhamBenh.MienGiamChiPhis.GroupBy(o => new { o.LoaiMienGiam, o.TheVoucherId, o.MaTheVoucher, o.DoiTuongUuDaiId, o.LoaiChietKhau, o.DoiTuongUuDai.Ten }, o => o,
                                                                                                        (k, v) => new DanhSachMienGiamVo
                                                                                                        {
                                                                                                            LoaiMienGiam = k.LoaiMienGiam,
                                                                                                            LoaiChietKhau = k.LoaiChietKhau,
                                                                                                            TheVoucherId = k.TheVoucherId,
                                                                                                            MaTheVoucher = k.MaTheVoucher,
                                                                                                            DoiTuongUuDaiId = k.DoiTuongUuDaiId,
                                                                                                            DoiTuongUuDai = k.Ten,
                                                                                                            TiLe = v.Select(o => o.TiLe).DefaultIfEmpty().Sum(),
                                                                                                            SoTien = v.Select(o => o.SoTien).DefaultIfEmpty().Sum()
                                                                                                        }).Where(o => o.SoTien != 0),
                    GhiChuMienGiamThem = s.YeuCauKhamBenh.GhiChuMienGiamThem,
                    NoiDungGhiChuMiemGiamId = s.YeuCauKhamBenh.NoiDungGhiChuMiemGiamId,

                }).ToListAsync();

            var queryVatTu = _taiKhoanBenhNhanChi.TableNoTracking.Where(o => o.TaiKhoanBenhNhanThuId == Convert.ToDouble(queryInfo.AdditionalSearchString)).Include(c => c.YeuCauVatTuBenhVien).ThenInclude(cc => cc.CongTyBaoHiemTuNhanCongNos)
                .Where(yc => yc.YeuCauVatTuBenhVien != null && yc.YeuCauVatTuBenhVien.YeuCauGoiDichVuId == null)
                .Select(s => new ChiPhiKhamChuaBenhVo
                {
                    Id = s.YeuCauVatTuBenhVien.Id,
                    LoaiNhom = NhomChiPhiKhamChuaBenh.VatTuTieuHao,
                    Nhom = NhomChiPhiKhamChuaBenh.VatTuTieuHao.GetDescription(),
                    Ma = s.YeuCauVatTuBenhVien.VatTuBenhVien.Ma,
                    TenDichVu = s.YeuCauVatTuBenhVien.VatTuBenhVien.VatTus.Ten,
                    LoaiGia = string.Empty,
                    Soluong = s.YeuCauVatTuBenhVien.SoLuong,
                    DonGia = s.YeuCauVatTuBenhVien.DonGiaBan,
                    KhongTinhPhi = s.YeuCauVatTuBenhVien.KhongTinhPhi,
                    KiemTraBHYTXacNhan = s.YeuCauVatTuBenhVien.BaoHiemChiTra != null,
                    DuocHuongBHYT = s.YeuCauVatTuBenhVien.DuocHuongBaoHiem,
                    DonGiaBHYT = s.YeuCauVatTuBenhVien.DonGiaBaoHiem.GetValueOrDefault(),
                    TiLeBaoHiemThanhToan = s.YeuCauVatTuBenhVien.TiLeBaoHiemThanhToan.GetValueOrDefault(),
                    MucHuongBaoHiem = s.YeuCauVatTuBenhVien.MucHuongBaoHiem.GetValueOrDefault(),
                    DanhSachCongNoChoThus = s.YeuCauVatTuBenhVien.CongTyBaoHiemTuNhanCongNos.Select(o => new DanhSachCongNoVo { CongTyBaoHiemTuNhanId = o.CongTyBaoHiemTuNhanId, SoTienCongNoChoThu = o.SoTien }),

                    DaThanhToan = s.YeuCauVatTuBenhVien.SoTienBenhNhanDaChi.GetValueOrDefault(),
                    NoiThucHien = string.Empty,
                    NguoiThu = s != null && s.NhanVienThucHienId != null ? nguoiThus[s.NhanVienThucHienId ?? 0].HoTen : string.Empty,
                    ThoiGianThuStr = s.NgayChi.ApplyFormatDate(),
                    SoPhieu = s.SoPhieu ?? 1,
                    CheckedDefault = true,
                    DonViTinh = "Lần",

                    SoTienMG = s.YeuCauVatTuBenhVien.SoTienMienGiam.GetValueOrDefault(),
                    DanhSachMienGiamVos = s.YeuCauVatTuBenhVien.MienGiamChiPhis.Count == 0 ? new List<DanhSachMienGiamVo>() : s.YeuCauVatTuBenhVien.MienGiamChiPhis.GroupBy(o => new { o.LoaiMienGiam, o.TheVoucherId, o.MaTheVoucher, o.DoiTuongUuDaiId, o.LoaiChietKhau, o.DoiTuongUuDai.Ten }, o => o,
                                                                                                        (k, v) => new DanhSachMienGiamVo
                                                                                                        {
                                                                                                            LoaiMienGiam = k.LoaiMienGiam,
                                                                                                            LoaiChietKhau = k.LoaiChietKhau,
                                                                                                            TheVoucherId = k.TheVoucherId,
                                                                                                            MaTheVoucher = k.MaTheVoucher,
                                                                                                            DoiTuongUuDaiId = k.DoiTuongUuDaiId,
                                                                                                            DoiTuongUuDai = k.Ten,
                                                                                                            TiLe = v.Select(o => o.TiLe).DefaultIfEmpty().Sum(),
                                                                                                            SoTien = v.Select(o => o.SoTien).DefaultIfEmpty().Sum()
                                                                                                        }).Where(o => o.SoTien != 0),
                    GhiChuMienGiamThem = s.YeuCauVatTuBenhVien.GhiChuMienGiamThem,
                    NoiDungGhiChuMiemGiamId = s.YeuCauVatTuBenhVien.NoiDungGhiChuMiemGiamId,

                }).ToListAsync();

            var queryToaThuoc = _taiKhoanBenhNhanChi.TableNoTracking.Where(o => o.TaiKhoanBenhNhanThuId == Convert.ToDouble(queryInfo.AdditionalSearchString)).Include(c => c.DonThuocThanhToanChiTiet).ThenInclude(cc => cc.CongTyBaoHiemTuNhanCongNos)
                .Include(c => c.DonThuocThanhToanChiTiet).ThenInclude(cc => cc.DonViTinh)
                .Where(yc => yc.DonThuocThanhToanChiTiet != null && yc.DonThuocThanhToanChiTiet.DonThuocThanhToan.LoaiDonThuoc == Enums.EnumLoaiDonThuoc.ThuocBHYT)
                .Select(s => new ChiPhiKhamChuaBenhVo
                {
                    Id = s.DonThuocThanhToanChiTiet.Id,
                    LoaiNhom = NhomChiPhiKhamChuaBenh.ToaThuoc,
                    Nhom = $"{NhomChiPhiKhamChuaBenh.ToaThuoc.GetDescription()}: {s.DonThuocThanhToanChiTiet.DonThuocThanhToan.YeuCauKhamBenhDonThuoc.YeuCauKhamBenh.TenDichVu}",
                    Ma = string.Empty,
                    TenDichVu = s.DonThuocThanhToanChiTiet.Ten,
                    LoaiGia = string.Empty,
                    Soluong = s.DonThuocThanhToanChiTiet.SoLuong,
                    DonGia = s.DonThuocThanhToanChiTiet.DonGiaBan,
                    KiemTraBHYTXacNhan = s.DonThuocThanhToanChiTiet.BaoHiemChiTra != null,
                    DuocHuongBHYT = s.DonThuocThanhToanChiTiet.DuocHuongBaoHiem,
                    DonGiaBHYT = s.DonThuocThanhToanChiTiet.DonGiaBaoHiem.GetValueOrDefault(),
                    TiLeBaoHiemThanhToan = s.DonThuocThanhToanChiTiet.TiLeBaoHiemThanhToan.GetValueOrDefault(),
                    MucHuongBaoHiem = s.DonThuocThanhToanChiTiet.MucHuongBaoHiem.GetValueOrDefault(),
                    DanhSachCongNoChoThus = s.DonThuocThanhToanChiTiet.CongTyBaoHiemTuNhanCongNos.Select(o => new DanhSachCongNoVo { CongTyBaoHiemTuNhanId = o.CongTyBaoHiemTuNhanId, SoTienCongNoChoThu = o.SoTien }),

                    DaThanhToan = s.DonThuocThanhToanChiTiet.SoTienBenhNhanDaChi.GetValueOrDefault(),
                    NoiThucHien = string.Empty,
                    NguoiThu = s != null && s.NhanVienThucHienId != null ? nguoiThus[s.NhanVienThucHienId ?? 0].HoTen : string.Empty,
                    ThoiGianThuStr = s.NgayChi.ApplyFormatDate(),
                    SoPhieu = s.SoPhieu ?? 1,
                    CheckedDefault = true,
                    DonViTinh = s.DonThuocThanhToanChiTiet.DonViTinh.Ten,

                    SoTienMG = s.DonThuocThanhToanChiTiet.SoTienMienGiam.GetValueOrDefault(),
                    DanhSachMienGiamVos = s.DonThuocThanhToanChiTiet.MienGiamChiPhis.Count == 0 ? new List<DanhSachMienGiamVo>() : s.DonThuocThanhToanChiTiet.MienGiamChiPhis.GroupBy(o => new { o.LoaiMienGiam, o.TheVoucherId, o.MaTheVoucher, o.DoiTuongUuDaiId, o.LoaiChietKhau, o.DoiTuongUuDai.Ten }, o => o,
                                                                                                        (k, v) => new DanhSachMienGiamVo
                                                                                                        {
                                                                                                            LoaiMienGiam = k.LoaiMienGiam,
                                                                                                            LoaiChietKhau = k.LoaiChietKhau,
                                                                                                            TheVoucherId = k.TheVoucherId,
                                                                                                            MaTheVoucher = k.MaTheVoucher,
                                                                                                            DoiTuongUuDaiId = k.DoiTuongUuDaiId,
                                                                                                            DoiTuongUuDai = k.Ten,
                                                                                                            TiLe = v.Select(o => o.TiLe).DefaultIfEmpty().Sum(),
                                                                                                            SoTien = v.Select(o => o.SoTien).DefaultIfEmpty().Sum()
                                                                                                        }).Where(o => o.SoTien != 0),
                    GhiChuMienGiamThem = s.DonThuocThanhToanChiTiet.GhiChuMienGiamThem,
                    NoiDungGhiChuMiemGiamId = s.DonThuocThanhToanChiTiet.NoiDungGhiChuMiemGiamId,
                }).ToListAsync();

            var queryGoiDichVu = _taiKhoanBenhNhanChi.TableNoTracking.Where(o => o.TaiKhoanBenhNhanThuId == Convert.ToDouble(queryInfo.AdditionalSearchString)).Include(c => c.YeuCauGoiDichVu).ThenInclude(cc => cc.CongTyBaoHiemTuNhanCongNos)
                .Where(yc => yc.YeuCauGoiDichVu != null)
                .Select(s => new ChiPhiKhamChuaBenhVo
                {
                    Id = s.YeuCauGoiDichVu.Id,
                    LoaiNhom = NhomChiPhiKhamChuaBenh.GoiDichVu,
                    Nhom = NhomChiPhiKhamChuaBenh.GoiDichVu.GetDescription(),
                    Ma = string.Empty,
                    TenDichVu = s.YeuCauGoiDichVu.TenChuongTrinh + " - " + s.YeuCauGoiDichVu.TenGoiDichVu,
                    LoaiGia = string.Empty,
                    Soluong = 1,
                    DonGia = s.YeuCauGoiDichVu.GiaSauChietKhau,
                    KiemTraBHYTXacNhan = false,
                    DuocHuongBHYT = false,
                    DonGiaBHYT = 0,
                    TiLeBaoHiemThanhToan = 0,
                    MucHuongBaoHiem = 0,
                    DanhSachCongNoChoThus = s.YeuCauGoiDichVu.CongTyBaoHiemTuNhanCongNos.Select(o => new DanhSachCongNoVo { CongTyBaoHiemTuNhanId = o.CongTyBaoHiemTuNhanId, SoTienCongNoChoThu = o.SoTien }),

                    DaThanhToan = s.YeuCauGoiDichVu.SoTienBenhNhanDaChi.GetValueOrDefault(),
                    NoiThucHien = string.Empty,
                    NguoiThu = s != null && s.NhanVienThucHienId != null ? nguoiThus[s.NhanVienThucHienId ?? 0].HoTen : string.Empty,
                    ThoiGianThuStr = s.NgayChi.ApplyFormatDate(),
                    SoPhieu = s.SoPhieu ?? 1,
                    CheckedDefault = true,
                    DonViTinh = "Lần",

                    SoTienMG = s.YeuCauGoiDichVu.SoTienMienGiam.GetValueOrDefault(),
                    DanhSachMienGiamVos = s.YeuCauGoiDichVu.MienGiamChiPhis.Count == 0 ? new List<DanhSachMienGiamVo>() : s.YeuCauGoiDichVu.MienGiamChiPhis.GroupBy(o => new { o.LoaiMienGiam, o.TheVoucherId, o.MaTheVoucher, o.DoiTuongUuDaiId, o.LoaiChietKhau, o.DoiTuongUuDai.Ten }, o => o,
                                                                                                        (k, v) => new DanhSachMienGiamVo
                                                                                                        {
                                                                                                            LoaiMienGiam = k.LoaiMienGiam,
                                                                                                            LoaiChietKhau = k.LoaiChietKhau,
                                                                                                            TheVoucherId = k.TheVoucherId,
                                                                                                            MaTheVoucher = k.MaTheVoucher,
                                                                                                            DoiTuongUuDaiId = k.DoiTuongUuDaiId,
                                                                                                            DoiTuongUuDai = k.Ten,
                                                                                                            TiLe = v.Select(o => o.TiLe).DefaultIfEmpty().Sum(),
                                                                                                            SoTien = v.Select(o => o.SoTien).DefaultIfEmpty().Sum()
                                                                                                        }).Where(o => o.SoTien != 0),
                    GhiChuMienGiamThem = s.YeuCauGoiDichVu.GhiChuMienGiamThem,
                    NoiDungGhiChuMiemGiamId = s.YeuCauGoiDichVu.NoiDungGhiChuMiemGiamId

                }).ToListAsync();

            await Task.WhenAll(queryDichVuKhamBenh, queryDichVuKyThuat, queryDichVuGiuong, queryDuocPham, queryVatTu, queryToaThuoc, queryGoiDichVu);

            var result = new List<ChiPhiKhamChuaBenhVo>();
            result.AddRange(queryDichVuKhamBenh.Result);
            result.AddRange(queryDichVuKyThuat.Result);
            result.AddRange(queryDichVuGiuong.Result);
            result.AddRange(queryDuocPham.Result);
            result.AddRange(queryVatTu.Result);
            result.AddRange(queryToaThuoc.Result);
            result.AddRange(queryGoiDichVu.Result);

            var dataOrderBy = result.AsQueryable();
            var thuNgan = dataOrderBy.Skip(queryInfo.Skip).Take(queryInfo.Take).ToArray();
            var countTask = dataOrderBy.Count();

            return new GridDataSource
            {
                Data = thuNgan,
                TotalRowCount = countTask
            };
        }

        #endregion

        #region tất cả danh sách đã thu tiền hoàn thành

        public async Task<GridDataSource> GetDataForGridDanhSachThuNganDaHoanThanhAsync(QueryInfo queryInfo, bool isAllData)
        {
            BuildDefaultSortExpression(queryInfo);
            var queryTheoDanhSachDaThu = BaseRepository.TableNoTracking.Where(cc =>
                 cc.TrangThaiYeuCauTiepNhan == Enums.EnumTrangThaiYeuCauTiepNhan.DaHoanTat
                 && (cc.LoaiYeuCauTiepNhan == Enums.EnumLoaiYeuCauTiepNhan.KhamChuaBenhNgoaiTru || cc.LoaiYeuCauTiepNhan == Enums.EnumLoaiYeuCauTiepNhan.DangKyGoiMarketing) &&
                 (cc.YeuCauKhamBenhs.Any(o => o.YeuCauGoiDichVuId == null && o.GoiKhamSucKhoeId == null && o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.DaThanhToan)
                  || cc.YeuCauDichVuKyThuats.Any(o =>
                      o.YeuCauGoiDichVuId == null && o.GoiKhamSucKhoeId == null &&
                      o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.DaThanhToan)
                  || cc.YeuCauDichVuGiuongBenhViens.Any(o =>
                      o.YeuCauGoiDichVuId == null &&
                      o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.DaThanhToan)
                  || cc.YeuCauDuocPhamBenhViens.Any(o =>
                      o.YeuCauGoiDichVuId == null &&
                      o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.DaThanhToan)
                  || cc.YeuCauVatTuBenhViens.Any(o =>
                      o.YeuCauGoiDichVuId == null &&
                      o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.DaThanhToan)
                  || cc.TaiKhoanBenhNhanChis.Any(o => o.YeuCauGoiDichVu != null && o.YeuCauGoiDichVu.TrangThaiThanhToan == Enums.TrangThaiThanhToan.DaThanhToan)
                  || cc.DonThuocThanhToans.Any(o => o.LoaiDonThuoc == Enums.EnumLoaiDonThuoc.ThuocBHYT &&
                      o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.DaThanhToan)
                 ) &&
                 !(cc.YeuCauKhamBenhs.Any(o =>
                   o.YeuCauGoiDichVuId == null && o.GoiKhamSucKhoeId == null &&
                   (o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan ||
                    o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan))
               || cc.YeuCauDichVuKyThuats.Any(o =>
                   o.YeuCauGoiDichVuId == null && o.GoiKhamSucKhoeId == null &&
                   (o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan ||
                    o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan))
               || cc.YeuCauDichVuGiuongBenhViens.Any(o =>
                   o.YeuCauGoiDichVuId == null &&
                   (o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan ||
                    o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan))
               || cc.YeuCauDuocPhamBenhViens.Any(o =>
                   o.YeuCauGoiDichVuId == null &&
                   (o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan ||
                    o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan))
                || cc.YeuCauVatTuBenhViens.Any(o =>
                    o.YeuCauGoiDichVuId == null &&
                    (o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan ||
                    o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan))
               || cc.DonThuocThanhToans.Any(o => o.LoaiDonThuoc == Enums.EnumLoaiDonThuoc.ThuocBHYT &&
                   (o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan ||
                    o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan))
              ));


            var query = queryTheoDanhSachDaThu.Select(s => new DanhSachBenhNhanChoThuNganGridVo
            {
                Id = s.Id,
                MaTN = s.MaYeuCauTiepNhan,
                HoTen = s.HoTen,
                DienThoaiStr = s.SoDienThoai,
                GioiTinh = s.GioiTinh,
                MaBN = s.BenhNhan != null ? s.BenhNhan.MaBN : "",
                NamSinh = s.NamSinh,
                DoiTuong = s.CoBHYT != true ? "Viện phí" : "BHYT (" + s.BHYTMucHuong.ToString() + "%)",
            });

            if (!string.IsNullOrEmpty(queryInfo.AdditionalSearchString))
            {
                var queryString = JsonConvert.DeserializeObject<DanhSachBenhNhanChoThuNganGridVo>(queryInfo.AdditionalSearchString);
                if (!string.IsNullOrEmpty(queryString.MaTN))
                    query = query.Where(p => p.MaTN.Contains(queryString.MaTN.TrimEnd().TrimStart()));
                if (!string.IsNullOrEmpty(queryString.MaBN))
                    query = query.Where(p => p.MaBN.ToString().Contains(queryString.MaBN.ToString().TrimEnd().TrimStart()));
                if (!string.IsNullOrEmpty(queryString.HoTen))
                    query = query.Where(p => p.HoTen.Contains(queryString.HoTen.TrimEnd().TrimStart()));
                if (!string.IsNullOrEmpty(queryString.NamSinh.ToString()))
                    query = query.Where(p =>
                        p.NamSinh.ToString().Contains(queryString.NamSinh.ToString().TrimEnd().TrimStart()));
                if (!string.IsNullOrEmpty(queryString.DienThoaiStr))
                    query = query.Where(p => p.DienThoaiStr.Contains(queryString.DienThoaiStr.TrimEnd().TrimStart()));
            }
            if (!string.IsNullOrEmpty(queryInfo.SearchTerms))
            {
                query = query.ApplyLike(queryInfo.SearchTerms,
                   g => g.MaBN.ToString(),
                   g => g.HoTen,
                   g => g.HoTenRemoveDiacritics,
                   g => g.NamSinh.ToString(),
                   g => g.DienThoaiStr,
                   g => g.MaTN);
            }

            var queryResult = isAllData == true ?
                   await query.OrderBy(queryInfo.SortString).ToArrayAsync()
                : await query.OrderBy(queryInfo.SortString).Skip(queryInfo.Skip).Take(queryInfo.Take).ToArrayAsync();
            if (queryResult.Length > 0)
            {
                var danhSachChiPhiDichVus = await BaseRepository.TableNoTracking.Where(tn => queryResult.Select(o => o.Id).Contains(tn.Id)).Select(tn =>
                    new DanhSachChiPhiDichVuVo
                    {
                        YeuCauTiepNhanId = tn.Id,
                        ChiPhiDichVuKhamBenh = tn.YeuCauKhamBenhs.Where(o => o.YeuCauGoiDichVuId == null && o.GoiKhamSucKhoeId == null && o.TrangThaiThanhToan != Enums.TrangThaiThanhToan.HuyThanhToan).Select(yc => new ChiPhiDichVuVo
                        {
                            Soluong = 1,
                            DonGia = yc.Gia,
                            KhongTinhPhi = yc.KhongTinhPhi,
                            DuocHuongBHYT = yc.DuocHuongBaoHiem,
                            DonGiaBHYT = yc.DonGiaBaoHiem.GetValueOrDefault(),
                            TiLeBaoHiemThanhToan = yc.TiLeBaoHiemThanhToan.GetValueOrDefault(),
                            MucHuongBaoHiem = yc.MucHuongBaoHiem.GetValueOrDefault(),
                            SoTienMG = yc.SoTienMienGiam.GetValueOrDefault(),
                            DaThanhToan = yc.SoTienBenhNhanDaChi.GetValueOrDefault(),
                            TongCongNo = yc.CongTyBaoHiemTuNhanCongNos.Select(o => o.SoTien).DefaultIfEmpty(0).Sum()
                        }),
                        ChiPhiDichVuKyThuat = tn.YeuCauDichVuKyThuats.Where(o => o.YeuCauGoiDichVuId == null && o.GoiKhamSucKhoeId == null && o.TrangThaiThanhToan != Enums.TrangThaiThanhToan.HuyThanhToan).Select(yc => new ChiPhiDichVuVo
                        {
                            Soluong = yc.SoLan,
                            DonGia = yc.Gia,
                            KhongTinhPhi = yc.KhongTinhPhi,
                            DuocHuongBHYT = yc.DuocHuongBaoHiem,
                            DonGiaBHYT = yc.DonGiaBaoHiem.GetValueOrDefault(),
                            TiLeBaoHiemThanhToan = yc.TiLeBaoHiemThanhToan.GetValueOrDefault(),
                            MucHuongBaoHiem = yc.MucHuongBaoHiem.GetValueOrDefault(),
                            SoTienMG = yc.SoTienMienGiam.GetValueOrDefault(),
                            DaThanhToan = yc.SoTienBenhNhanDaChi.GetValueOrDefault(),
                            TongCongNo = yc.CongTyBaoHiemTuNhanCongNos.Select(o => o.SoTien).DefaultIfEmpty(0).Sum()
                        }),
                        ChiPhiDichVuGiuong = tn.YeuCauDichVuGiuongBenhViens.Where(o => o.YeuCauGoiDichVuId == null && o.TrangThaiThanhToan != Enums.TrangThaiThanhToan.HuyThanhToan).Select(yc => new ChiPhiDichVuVo
                        {
                            Soluong = 1,
                            DonGia = yc.Gia.GetValueOrDefault(),
                            KhongTinhPhi = yc.KhongTinhPhi,
                            DuocHuongBHYT = yc.DuocHuongBaoHiem,
                            DonGiaBHYT = yc.DonGiaBaoHiem.GetValueOrDefault(),
                            TiLeBaoHiemThanhToan = yc.TiLeBaoHiemThanhToan.GetValueOrDefault(),
                            MucHuongBaoHiem = yc.MucHuongBaoHiem.GetValueOrDefault(),
                            SoTienMG = yc.SoTienMienGiam.GetValueOrDefault(),
                            DaThanhToan = yc.SoTienBenhNhanDaChi.GetValueOrDefault(),
                            TongCongNo = yc.CongTyBaoHiemTuNhanCongNos.Select(o => o.SoTien).DefaultIfEmpty(0).Sum()
                        }),
                        ChiPhiDuocPham = tn.YeuCauDuocPhamBenhViens.Where(o => o.YeuCauGoiDichVuId == null && o.TrangThaiThanhToan != Enums.TrangThaiThanhToan.HuyThanhToan).Select(yc => new ChiPhiDichVuVo
                        {
                            Soluong = yc.SoLuong,
                            DonGia = yc.DonGiaBan,
                            KhongTinhPhi = yc.KhongTinhPhi,
                            DuocHuongBHYT = yc.DuocHuongBaoHiem,
                            DonGiaBHYT = yc.DonGiaBaoHiem.GetValueOrDefault(),
                            TiLeBaoHiemThanhToan = yc.TiLeBaoHiemThanhToan.GetValueOrDefault(),
                            MucHuongBaoHiem = yc.MucHuongBaoHiem.GetValueOrDefault(),
                            SoTienMG = yc.SoTienMienGiam.GetValueOrDefault(),
                            DaThanhToan = yc.SoTienBenhNhanDaChi.GetValueOrDefault(),
                            TongCongNo = yc.CongTyBaoHiemTuNhanCongNos.Select(o => o.SoTien).DefaultIfEmpty(0).Sum()
                        }),
                        ChiPhiVatTu = tn.YeuCauVatTuBenhViens.Where(o => o.YeuCauGoiDichVuId == null && o.TrangThaiThanhToan != Enums.TrangThaiThanhToan.HuyThanhToan).Select(yc => new ChiPhiDichVuVo
                        {
                            Soluong = yc.SoLuong,
                            DonGia = yc.DonGiaBan,
                            KhongTinhPhi = yc.KhongTinhPhi,
                            DuocHuongBHYT = yc.DuocHuongBaoHiem,
                            DonGiaBHYT = yc.DonGiaBaoHiem.GetValueOrDefault(),
                            TiLeBaoHiemThanhToan = yc.TiLeBaoHiemThanhToan.GetValueOrDefault(),
                            MucHuongBaoHiem = yc.MucHuongBaoHiem.GetValueOrDefault(),
                            SoTienMG = yc.SoTienMienGiam.GetValueOrDefault(),
                            DaThanhToan = yc.SoTienBenhNhanDaChi.GetValueOrDefault(),
                            TongCongNo = yc.CongTyBaoHiemTuNhanCongNos.Select(o => o.SoTien).DefaultIfEmpty(0).Sum()
                        }),
                        ChiPhiToaThuoc = tn.DonThuocThanhToans.Where(o => o.LoaiDonThuoc == Enums.EnumLoaiDonThuoc.ThuocBHYT && o.TrangThaiThanhToan != Enums.TrangThaiThanhToan.HuyThanhToan).SelectMany(o => o.DonThuocThanhToanChiTiets).Select(yc => new ChiPhiDichVuVo
                        {
                            Soluong = yc.SoLuong,
                            DonGia = yc.DonGiaBan,
                            KhongTinhPhi = false,
                            DuocHuongBHYT = yc.DuocHuongBaoHiem,
                            DonGiaBHYT = yc.DonGiaBaoHiem.GetValueOrDefault(),
                            TiLeBaoHiemThanhToan = yc.TiLeBaoHiemThanhToan.GetValueOrDefault(),
                            MucHuongBaoHiem = yc.MucHuongBaoHiem.GetValueOrDefault(),
                            SoTienMG = yc.SoTienMienGiam.GetValueOrDefault(),
                            DaThanhToan = yc.SoTienBenhNhanDaChi.GetValueOrDefault(),
                            TongCongNo = yc.CongTyBaoHiemTuNhanCongNos.Select(o => o.SoTien).DefaultIfEmpty(0).Sum()
                        }),
                        ChiPhiGoiDichVu = tn.TaiKhoanBenhNhanChis
                            .Where(c => c.YeuCauGoiDichVu != null && c.YeuCauGoiDichVu.TrangThaiThanhToan != Enums.TrangThaiThanhToan.HuyThanhToan).Select(c =>
                                new ChiPhiDichVuVo
                                {
                                    Soluong = 1,
                                    DonGia = c.YeuCauGoiDichVu.GiaSauChietKhau,
                                    KhongTinhPhi = false,
                                    DuocHuongBHYT = false,
                                    SoTienMG = c.YeuCauGoiDichVu.SoTienMienGiam.GetValueOrDefault(),
                                    DaThanhToan = c.YeuCauGoiDichVu.SoTienBenhNhanDaChi.GetValueOrDefault(),
                                    TongCongNo = c.YeuCauGoiDichVu.CongTyBaoHiemTuNhanCongNos.Select(o => o.SoTien).DefaultIfEmpty(0).Sum()
                                })
                    }
                ).ToListAsync();
                foreach (var danhSachBenhNhanChoThuNganGridVo in queryResult)
                {
                    danhSachBenhNhanChoThuNganGridVo.DanhSachChiPhiDichVu = danhSachChiPhiDichVus.FirstOrDefault(o => o.YeuCauTiepNhanId == danhSachBenhNhanChoThuNganGridVo.Id);
                }
            }

            return new GridDataSource { Data = queryResult };

        }
        public async Task<GridDataSource> GetTotalPageForGridDanhSachThuNganDaHoanThanhAsync(QueryInfo queryInfo)
        {
            var queryTheoDanhSachDaThu = BaseRepository.TableNoTracking.Where(cc =>
                 cc.TrangThaiYeuCauTiepNhan == Enums.EnumTrangThaiYeuCauTiepNhan.DaHoanTat
                 && (cc.LoaiYeuCauTiepNhan == Enums.EnumLoaiYeuCauTiepNhan.KhamChuaBenhNgoaiTru || cc.LoaiYeuCauTiepNhan == Enums.EnumLoaiYeuCauTiepNhan.DangKyGoiMarketing) &&
                 (cc.YeuCauKhamBenhs.Any(o => o.YeuCauGoiDichVuId == null && o.GoiKhamSucKhoeId == null && o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.DaThanhToan)
                  || cc.YeuCauDichVuKyThuats.Any(o =>
                      o.YeuCauGoiDichVuId == null && o.GoiKhamSucKhoeId == null &&
                      o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.DaThanhToan)
                  || cc.YeuCauDichVuGiuongBenhViens.Any(o =>
                      o.YeuCauGoiDichVuId == null &&
                      o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.DaThanhToan)
                  || cc.YeuCauDuocPhamBenhViens.Any(o =>
                      o.YeuCauGoiDichVuId == null &&
                      o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.DaThanhToan)
                  //TODO: need update goi dv
                  //|| cc.YeuCauGoiDichVus.Any(o =>
                  //    o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.DaThanhToan)
                  || cc.DonThuocThanhToans.Any(o => o.LoaiDonThuoc == Enums.EnumLoaiDonThuoc.ThuocBHYT &&
                      o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.DaThanhToan)
                 ) &&
                 !(cc.YeuCauKhamBenhs.Any(o =>
                   o.YeuCauGoiDichVuId == null &&
                   (o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan ||
                    o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan))
               || cc.YeuCauDichVuKyThuats.Any(o =>
                   o.YeuCauGoiDichVuId == null &&
                   (o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan ||
                    o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan))
               || cc.YeuCauDichVuGiuongBenhViens.Any(o =>
                   o.YeuCauGoiDichVuId == null &&
                   (o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan ||
                    o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan))
               || cc.YeuCauDuocPhamBenhViens.Any(o =>
                   o.YeuCauGoiDichVuId == null &&
                   (o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan ||
                    o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan))
               //TODO: need update goi dv
               //|| cc.YeuCauGoiDichVus.Any(o =>
               //    (o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan ||
               //     o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan))
               || cc.DonThuocThanhToans.Any(o => o.LoaiDonThuoc == Enums.EnumLoaiDonThuoc.ThuocBHYT &&
                   (o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan ||
                    o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan))
              ));


            var query = queryTheoDanhSachDaThu.Select(s => new DanhSachBenhNhanChoThuNganGridVo
            {
                Id = s.Id,
                MaTN = s.MaYeuCauTiepNhan,
                HoTen = s.HoTen,
                DienThoaiStr = s.SoDienThoai,
                GioiTinh = s.GioiTinh,
                MaBN = s.BenhNhan != null ? s.BenhNhan.MaBN : "",
                NamSinh = s.NamSinh,
            });

            if (!string.IsNullOrEmpty(queryInfo.AdditionalSearchString))
            {
                var queryString = JsonConvert.DeserializeObject<DanhSachBenhNhanChoThuNganGridVo>(queryInfo.AdditionalSearchString);
                if (!string.IsNullOrEmpty(queryString.MaTN))
                    query = query.Where(p => p.MaTN.Contains(queryString.MaTN.TrimEnd().TrimStart()));
                if (!string.IsNullOrEmpty(queryString.MaBN))
                    query = query.Where(p => p.MaBN.ToString().Contains(queryString.MaBN.ToString().TrimEnd().TrimStart()));
                if (!string.IsNullOrEmpty(queryString.HoTen))
                    query = query.Where(p => p.HoTen.Contains(queryString.HoTen.TrimEnd().TrimStart()));
                if (!string.IsNullOrEmpty(queryString.NamSinh.ToString()))
                    query = query.Where(p =>
                        p.NamSinh.ToString().Contains(queryString.NamSinh.ToString().TrimEnd().TrimStart()));
                if (!string.IsNullOrEmpty(queryString.DienThoaiStr))
                    query = query.Where(p => p.DienThoaiStr.Contains(queryString.DienThoaiStr.TrimEnd().TrimStart()));
            }
            if (!string.IsNullOrEmpty(queryInfo.SearchTerms))
            {
                query = query.ApplyLike(queryInfo.SearchTerms,
                   g => g.MaBN.ToString(),
                   g => g.HoTen,
                   g => g.HoTenRemoveDiacritics,
                   g => g.NamSinh.ToString(),
                   g => g.DienThoaiStr,
                   g => g.MaTN);
            }
            var totalRow = await query.CountAsync();

            return new GridDataSource { TotalRowCount = totalRow };
        }

        #endregion

        public async Task<List<ChiPhiKhamChuaBenhVo>> GetDanhSachChiPhiKhamChuaBenhDaThu(long taiKhoanBenhNhanThuId)
        {
            var nguoiThus = _useRepository.TableNoTracking.ToDictionary(c => c.Id, c => c);
            var queryDichVuKhamBenh = _taiKhoanBenhNhanChi.TableNoTracking.Where(o => o.TaiKhoanBenhNhanThuId == taiKhoanBenhNhanThuId).
                Include(c => c.YeuCauKhamBenh).ThenInclude(cc => cc.CongTyBaoHiemTuNhanCongNos)
                 .Include(c => c.YeuCauKhamBenh).ThenInclude(cc => cc.NoiDangKy).Include(c => c.YeuCauKhamBenh).ThenInclude(cc => cc.BacSiDangKy).ThenInclude(cc => cc.User)
                .Where(yc => yc.YeuCauKhamBenh != null && yc.YeuCauKhamBenh.YeuCauGoiDichVuId == null && yc.YeuCauKhamBenh.TrangThaiThanhToan == Enums.TrangThaiThanhToan.DaThanhToan)
                .Select(s => new ChiPhiKhamChuaBenhVo
                {
                    Id = s.YeuCauKhamBenh.Id,
                    LoaiNhom = NhomChiPhiKhamChuaBenh.DichVuKhamBenh,
                    Nhom = NhomChiPhiKhamChuaBenh.DichVuKhamBenh.GetDescription(),
                    Ma = s.YeuCauKhamBenh.DichVuKhamBenhBenhVien.Ma,
                    TenDichVu = s.YeuCauKhamBenh.DichVuKhamBenhBenhVien.Ten,
                    LoaiGia = s.YeuCauKhamBenh.NhomGiaDichVuKhamBenhBenhVien.Ten,
                    Soluong = 1,
                    DonGia = s.YeuCauKhamBenh.Gia,
                    KhongTinhPhi = s.YeuCauKhamBenh.KhongTinhPhi,
                    KiemTraBHYTXacNhan = s.YeuCauKhamBenh.BaoHiemChiTra != null,
                    DuocHuongBHYT = s.YeuCauKhamBenh.DuocHuongBaoHiem,
                    DonGiaBHYT = s.YeuCauKhamBenh.DonGiaBaoHiem.GetValueOrDefault(),
                    TiLeBaoHiemThanhToan = s.YeuCauKhamBenh.TiLeBaoHiemThanhToan.GetValueOrDefault(),
                    MucHuongBaoHiem = s.YeuCauKhamBenh.MucHuongBaoHiem.GetValueOrDefault(),
                    DanhSachCongNoChoThus = s.YeuCauKhamBenh.CongTyBaoHiemTuNhanCongNos.Select(o => new DanhSachCongNoVo { CongTyBaoHiemTuNhanId = o.CongTyBaoHiemTuNhanId, SoTienCongNoChoThu = o.SoTien }),
                    SoTienMG = s.YeuCauKhamBenh.SoTienMienGiam.GetValueOrDefault(),
                    DaThanhToan = s.YeuCauKhamBenh.SoTienBenhNhanDaChi.GetValueOrDefault(),
                    NoiThucHien = (s.YeuCauKhamBenh.NoiDangKy != null ? $"{s.YeuCauKhamBenh.NoiDangKy.Ma}" : "") + (s.YeuCauKhamBenh.BacSiDangKy != null && s.YeuCauKhamBenh.BacSiDangKy.User.HoTen != null ? " - " + $"{s.YeuCauKhamBenh.BacSiDangKy.User.HoTen}" : ""),
                    NguoiThu = s != null && s.NhanVienThucHienId != null ? nguoiThus[s.NhanVienThucHienId ?? 0].HoTen : string.Empty,
                    ThoiGianThuStr = s.NgayChi.ApplyFormatDate(),
                    SoPhieu = s.SoPhieu ?? 1,
                    DonViTinh = "Lần",
                    CheckedDefault = true
                }).OrderBy(o => o.Id).ToListAsync();

            var queryDichVuKyThuat = _taiKhoanBenhNhanChi.TableNoTracking.Where(o => o.TaiKhoanBenhNhanThuId == taiKhoanBenhNhanThuId)
                .Include(c => c.YeuCauDichVuKyThuat).ThenInclude(cc => cc.CongTyBaoHiemTuNhanCongNos)
                .Include(c => c.YeuCauDichVuKyThuat).ThenInclude(cc => cc.NoiThucHien)
                .Where(yc => yc.YeuCauDichVuKyThuat != null && yc.YeuCauDichVuKyThuat.YeuCauGoiDichVuId == null && yc.YeuCauDichVuKyThuat.TrangThaiThanhToan == Enums.TrangThaiThanhToan.DaThanhToan)
                .Select(s => new ChiPhiKhamChuaBenhVo
                {
                    Id = s.YeuCauDichVuKyThuat.Id,
                    LoaiNhom = NhomChiPhiKhamChuaBenh.DichVuKyThuat,
                    Nhom = NhomChiPhiKhamChuaBenh.DichVuKyThuat.GetDescription(),
                    Ma = s.YeuCauDichVuKyThuat.DichVuKyThuatBenhVien.Ma,
                    TenDichVu = s.YeuCauDichVuKyThuat.DichVuKyThuatBenhVien.Ten,
                    LoaiGia = s.YeuCauDichVuKyThuat.NhomGiaDichVuKyThuatBenhVien.Ten,
                    Soluong = s.YeuCauDichVuKyThuat.SoLan,
                    DonGia = s.YeuCauDichVuKyThuat.Gia,
                    KhongTinhPhi = s.YeuCauDichVuKyThuat.KhongTinhPhi,
                    KiemTraBHYTXacNhan = s.YeuCauDichVuKyThuat.BaoHiemChiTra != null,
                    DuocHuongBHYT = s.YeuCauDichVuKyThuat.DuocHuongBaoHiem,
                    DonGiaBHYT = s.YeuCauDichVuKyThuat.DonGiaBaoHiem.GetValueOrDefault(),
                    TiLeBaoHiemThanhToan = s.YeuCauDichVuKyThuat.TiLeBaoHiemThanhToan.GetValueOrDefault(),
                    MucHuongBaoHiem = s.YeuCauDichVuKyThuat.MucHuongBaoHiem.GetValueOrDefault(),
                    DanhSachCongNoChoThus = s.YeuCauDichVuKyThuat.CongTyBaoHiemTuNhanCongNos.Select(o => new DanhSachCongNoVo { CongTyBaoHiemTuNhanId = o.CongTyBaoHiemTuNhanId, SoTienCongNoChoThu = o.SoTien }),
                    SoTienMG = s.YeuCauDichVuKyThuat.SoTienMienGiam.GetValueOrDefault(),
                    DaThanhToan = s.YeuCauDichVuKyThuat.SoTienBenhNhanDaChi.GetValueOrDefault(),
                    NoiThucHien = s.NoiThucHien != null
                        ? $"{s.NoiThucHien.Ma} - {s.NoiThucHien.Ten}"
                        : string.Empty,
                    NguoiThu = s != null && s.NhanVienThucHienId != null ? nguoiThus[s.NhanVienThucHienId ?? 0].HoTen : string.Empty,
                    ThoiGianThuStr = s.NgayChi.ApplyFormatDate(),
                    SoPhieu = s.SoPhieu ?? 1,
                    CheckedDefault = true,
                    DonViTinh = "Lần",
                }).ToListAsync();

            var queryDichVuGiuong = _taiKhoanBenhNhanChi.TableNoTracking.Where(o => o.TaiKhoanBenhNhanThuId == taiKhoanBenhNhanThuId)
                .Include(c => c.YeuCauDichVuGiuongBenhVien).ThenInclude(cc => cc.CongTyBaoHiemTuNhanCongNos)
                .Where(yc => yc.YeuCauDichVuGiuongBenhVien != null && yc.YeuCauDichVuGiuongBenhVien.YeuCauGoiDichVuId == null && yc.YeuCauDichVuGiuongBenhVien.TrangThaiThanhToan == Enums.TrangThaiThanhToan.DaThanhToan)
                .Select(s => new ChiPhiKhamChuaBenhVo
                {
                    Id = s.YeuCauDichVuGiuongBenhVien.Id,
                    LoaiNhom = NhomChiPhiKhamChuaBenh.DichVuGiuong,
                    Nhom = NhomChiPhiKhamChuaBenh.DichVuGiuong.GetDescription(),
                    Ma = s.YeuCauDichVuGiuongBenhVien.DichVuGiuongBenhVien.Ma,
                    TenDichVu = s.YeuCauDichVuGiuongBenhVien.DichVuGiuongBenhVien.Ten,
                    LoaiGia = s.YeuCauDichVuGiuongBenhVien.NhomGiaDichVuGiuongBenhVien.Ten,
                    Soluong = 1,
                    DonGia = s.YeuCauDichVuGiuongBenhVien.Gia.GetValueOrDefault(),
                    KhongTinhPhi = s.YeuCauDichVuGiuongBenhVien.KhongTinhPhi,
                    KiemTraBHYTXacNhan = s.YeuCauDichVuGiuongBenhVien.BaoHiemChiTra != null,
                    DuocHuongBHYT = s.YeuCauDichVuGiuongBenhVien.DuocHuongBaoHiem,
                    DonGiaBHYT = s.YeuCauDichVuGiuongBenhVien.DonGiaBaoHiem.GetValueOrDefault(),
                    TiLeBaoHiemThanhToan = s.YeuCauDichVuGiuongBenhVien.TiLeBaoHiemThanhToan.GetValueOrDefault(),
                    MucHuongBaoHiem = s.YeuCauDichVuGiuongBenhVien.MucHuongBaoHiem.GetValueOrDefault(),
                    DanhSachCongNoChoThus = s.YeuCauDichVuGiuongBenhVien.CongTyBaoHiemTuNhanCongNos.Select(o => new DanhSachCongNoVo { CongTyBaoHiemTuNhanId = o.CongTyBaoHiemTuNhanId, SoTienCongNoChoThu = o.SoTien }),
                    SoTienMG = s.YeuCauDichVuGiuongBenhVien.SoTienMienGiam.GetValueOrDefault(),
                    DaThanhToan = s.YeuCauDichVuGiuongBenhVien.SoTienBenhNhanDaChi.GetValueOrDefault(),
                    NoiThucHien = s.NoiThucHien != null
                        ? $"{s.NoiThucHien.Ma} - {s.NoiThucHien.Ten}"
                        : string.Empty,
                    NguoiThu = s != null && s.NhanVienThucHienId != null ? nguoiThus[s.NhanVienThucHienId ?? 0].HoTen : string.Empty,
                    ThoiGianThuStr = s.NgayChi.ApplyFormatDate(),
                    SoPhieu = s.SoPhieu ?? 1,
                    CheckedDefault = true,
                    DonViTinh = "Lần",
                }).ToListAsync();

            var queryDuocPham = _taiKhoanBenhNhanChi.TableNoTracking.Where(o => o.TaiKhoanBenhNhanThuId == taiKhoanBenhNhanThuId).Include(c => c.YeuCauDuocPhamBenhVien).ThenInclude(cc => cc.CongTyBaoHiemTuNhanCongNos)
                .Where(yc => yc.YeuCauDuocPhamBenhVien != null && yc.YeuCauDuocPhamBenhVien.YeuCauGoiDichVuId == null && yc.YeuCauDuocPhamBenhVien.TrangThaiThanhToan == Enums.TrangThaiThanhToan.DaThanhToan)
                .Select(s => new ChiPhiKhamChuaBenhVo
                {
                    Id = s.YeuCauDuocPhamBenhVien.Id,
                    LoaiNhom = NhomChiPhiKhamChuaBenh.DuocPham,
                    Nhom = NhomChiPhiKhamChuaBenh.DuocPham.GetDescription(),
                    Ma = s.YeuCauDuocPhamBenhVien.DuocPhamBenhVien.Ma,
                    TenDichVu = s.YeuCauDuocPhamBenhVien.DuocPhamBenhVien.DuocPham.Ten,
                    LoaiGia = string.Empty,
                    Soluong = s.YeuCauDuocPhamBenhVien.SoLuong,
                    DonGia = s.YeuCauDuocPhamBenhVien.DonGiaBan,
                    KhongTinhPhi = s.YeuCauDuocPhamBenhVien.KhongTinhPhi,
                    KiemTraBHYTXacNhan = s.YeuCauDuocPhamBenhVien.BaoHiemChiTra != null,
                    DuocHuongBHYT = s.YeuCauDuocPhamBenhVien.DuocHuongBaoHiem,
                    DonGiaBHYT = s.YeuCauDuocPhamBenhVien.DonGiaBaoHiem.GetValueOrDefault(),
                    TiLeBaoHiemThanhToan = s.YeuCauDuocPhamBenhVien.TiLeBaoHiemThanhToan.GetValueOrDefault(),
                    MucHuongBaoHiem = s.YeuCauDuocPhamBenhVien.MucHuongBaoHiem.GetValueOrDefault(),
                    DanhSachCongNoChoThus = s.YeuCauDuocPhamBenhVien.CongTyBaoHiemTuNhanCongNos.Select(o => new DanhSachCongNoVo { CongTyBaoHiemTuNhanId = o.CongTyBaoHiemTuNhanId, SoTienCongNoChoThu = o.SoTien }),
                    SoTienMG = s.YeuCauDuocPhamBenhVien.SoTienMienGiam.GetValueOrDefault(),
                    DaThanhToan = s.YeuCauDuocPhamBenhVien.SoTienBenhNhanDaChi.GetValueOrDefault(),
                    NoiThucHien = string.Empty,
                    NguoiThu = s != null && s.NhanVienThucHienId != null ? nguoiThus[s.NhanVienThucHienId ?? 0].HoTen : string.Empty,
                    ThoiGianThuStr = s.NgayChi.ApplyFormatDate(),
                    SoPhieu = s.SoPhieu ?? 1,
                    CheckedDefault = true,
                    DonViTinh = s.YeuCauDuocPhamBenhVien.DonViTinh.Ten,
                }).ToListAsync();

            var queryVatTu = _taiKhoanBenhNhanChi.TableNoTracking.Where(o => o.TaiKhoanBenhNhanThuId == taiKhoanBenhNhanThuId).Include(c => c.YeuCauVatTuBenhVien).ThenInclude(cc => cc.CongTyBaoHiemTuNhanCongNos)
                .Where(yc => yc.YeuCauVatTuBenhVien != null && yc.YeuCauVatTuBenhVien.YeuCauGoiDichVuId == null && yc.YeuCauVatTuBenhVien.TrangThaiThanhToan == Enums.TrangThaiThanhToan.DaThanhToan)
                .Select(s => new ChiPhiKhamChuaBenhVo
                {
                    Id = s.YeuCauVatTuBenhVien.Id,
                    LoaiNhom = NhomChiPhiKhamChuaBenh.VatTuTieuHao,
                    Nhom = NhomChiPhiKhamChuaBenh.VatTuTieuHao.GetDescription(),
                    Ma = s.YeuCauVatTuBenhVien.Ma,
                    TenDichVu = s.YeuCauVatTuBenhVien.Ten,
                    LoaiGia = string.Empty,
                    Soluong = s.YeuCauVatTuBenhVien.SoLuong,
                    DonGia = s.YeuCauVatTuBenhVien.DonGiaBan,
                    KhongTinhPhi = s.YeuCauVatTuBenhVien.KhongTinhPhi,
                    KiemTraBHYTXacNhan = s.YeuCauVatTuBenhVien.BaoHiemChiTra != null,
                    DuocHuongBHYT = s.YeuCauVatTuBenhVien.DuocHuongBaoHiem,
                    DonGiaBHYT = s.YeuCauVatTuBenhVien.DonGiaBaoHiem.GetValueOrDefault(),
                    TiLeBaoHiemThanhToan = s.YeuCauVatTuBenhVien.TiLeBaoHiemThanhToan.GetValueOrDefault(),
                    MucHuongBaoHiem = s.YeuCauVatTuBenhVien.MucHuongBaoHiem.GetValueOrDefault(),
                    DanhSachCongNoChoThus = s.YeuCauVatTuBenhVien.CongTyBaoHiemTuNhanCongNos.Select(o => new DanhSachCongNoVo { CongTyBaoHiemTuNhanId = o.CongTyBaoHiemTuNhanId, SoTienCongNoChoThu = o.SoTien }),
                    SoTienMG = s.YeuCauVatTuBenhVien.SoTienMienGiam.GetValueOrDefault(),
                    DaThanhToan = s.YeuCauVatTuBenhVien.SoTienBenhNhanDaChi.GetValueOrDefault(),
                    NoiThucHien = string.Empty,
                    NguoiThu = s != null && s.NhanVienThucHienId != null ? nguoiThus[s.NhanVienThucHienId ?? 0].HoTen : string.Empty,
                    ThoiGianThuStr = s.NgayChi.ApplyFormatDate(),
                    SoPhieu = s.SoPhieu ?? 1,
                    CheckedDefault = true,
                    DonViTinh = s.YeuCauVatTuBenhVien.DonViTinh,
                }).ToListAsync();

            var queryToaThuoc = _taiKhoanBenhNhanChi.TableNoTracking.Where(o => o.TaiKhoanBenhNhanThuId == taiKhoanBenhNhanThuId).Include(c => c.DonThuocThanhToanChiTiet).ThenInclude(cc => cc.CongTyBaoHiemTuNhanCongNos)
                .Include(c => c.DonThuocThanhToanChiTiet).ThenInclude(cc => cc.DonViTinh)
                .Where(yc => yc.DonThuocThanhToanChiTiet != null && yc.DonThuocThanhToanChiTiet.DonThuocThanhToan.LoaiDonThuoc == Enums.EnumLoaiDonThuoc.ThuocBHYT && yc.DonThuocThanhToanChiTiet.DonThuocThanhToan.TrangThaiThanhToan == Enums.TrangThaiThanhToan.DaThanhToan)
                .Select(s => new ChiPhiKhamChuaBenhVo
                {
                    Id = s.DonThuocThanhToanChiTiet.Id,
                    LoaiNhom = NhomChiPhiKhamChuaBenh.ToaThuoc,
                    Nhom = $"{NhomChiPhiKhamChuaBenh.ToaThuoc.GetDescription()}: {s.DonThuocThanhToanChiTiet.DonThuocThanhToan.YeuCauKhamBenhDonThuoc.YeuCauKhamBenh.TenDichVu}",
                    Ma = string.Empty,
                    TenDichVu = s.DonThuocThanhToanChiTiet.Ten,
                    LoaiGia = string.Empty,
                    Soluong = s.DonThuocThanhToanChiTiet.SoLuong,
                    DonGia = s.DonThuocThanhToanChiTiet.DonGiaBan,
                    KiemTraBHYTXacNhan = s.DonThuocThanhToanChiTiet.BaoHiemChiTra != null,
                    DuocHuongBHYT = s.DonThuocThanhToanChiTiet.DuocHuongBaoHiem,
                    DonGiaBHYT = s.DonThuocThanhToanChiTiet.DonGiaBaoHiem.GetValueOrDefault(),
                    TiLeBaoHiemThanhToan = s.DonThuocThanhToanChiTiet.TiLeBaoHiemThanhToan.GetValueOrDefault(),
                    MucHuongBaoHiem = s.DonThuocThanhToanChiTiet.MucHuongBaoHiem.GetValueOrDefault(),
                    DanhSachCongNoChoThus = s.DonThuocThanhToanChiTiet.CongTyBaoHiemTuNhanCongNos.Select(o => new DanhSachCongNoVo { CongTyBaoHiemTuNhanId = o.CongTyBaoHiemTuNhanId, SoTienCongNoChoThu = o.SoTien }),
                    SoTienMG = s.DonThuocThanhToanChiTiet.SoTienMienGiam.GetValueOrDefault(),
                    DaThanhToan = s.DonThuocThanhToanChiTiet.SoTienBenhNhanDaChi.GetValueOrDefault(),
                    NoiThucHien = string.Empty,
                    NguoiThu = s != null && s.NhanVienThucHienId != null ? nguoiThus[s.NhanVienThucHienId ?? 0].HoTen : string.Empty,
                    ThoiGianThuStr = s.NgayChi.ApplyFormatDate(),
                    SoPhieu = s.SoPhieu ?? 1,
                    CheckedDefault = true,
                    DonViTinh = s.DonThuocThanhToanChiTiet.DonViTinh.Ten,
                }).ToListAsync();
            var queryGoiDichVu = _taiKhoanBenhNhanChi.TableNoTracking.Where(o => o.TaiKhoanBenhNhanThuId == taiKhoanBenhNhanThuId).Include(c => c.YeuCauGoiDichVu).ThenInclude(cc => cc.CongTyBaoHiemTuNhanCongNos)
                .Where(yc => yc.YeuCauGoiDichVu != null && yc.YeuCauGoiDichVu.TrangThaiThanhToan == Enums.TrangThaiThanhToan.DaThanhToan)
                .Select(s => new ChiPhiKhamChuaBenhVo
                {
                    Id = s.YeuCauGoiDichVu.Id,
                    LoaiNhom = NhomChiPhiKhamChuaBenh.GoiDichVu,
                    Nhom = NhomChiPhiKhamChuaBenh.GoiDichVu.GetDescription(),
                    Ma = string.Empty,
                    TenDichVu = s.YeuCauGoiDichVu.TenChuongTrinh + " - " + s.YeuCauGoiDichVu.TenGoiDichVu,
                    LoaiGia = string.Empty,
                    Soluong = 1,
                    DonGia = s.YeuCauGoiDichVu.GiaSauChietKhau,
                    KiemTraBHYTXacNhan = false,
                    DuocHuongBHYT = false,
                    DonGiaBHYT = 0,
                    TiLeBaoHiemThanhToan = 0,
                    MucHuongBaoHiem = 0,
                    DanhSachCongNoChoThus = s.YeuCauGoiDichVu.CongTyBaoHiemTuNhanCongNos.Select(o => new DanhSachCongNoVo { CongTyBaoHiemTuNhanId = o.CongTyBaoHiemTuNhanId, SoTienCongNoChoThu = o.SoTien }),
                    SoTienMG = s.YeuCauGoiDichVu.SoTienMienGiam.GetValueOrDefault(),
                    DaThanhToan = s.YeuCauGoiDichVu.SoTienBenhNhanDaChi.GetValueOrDefault(),
                    NoiThucHien = string.Empty,
                    NguoiThu = s != null && s.NhanVienThucHienId != null ? nguoiThus[s.NhanVienThucHienId ?? 0].HoTen : string.Empty,
                    ThoiGianThuStr = s.NgayChi.ApplyFormatDate(),
                    SoPhieu = s.SoPhieu ?? 1,
                    CheckedDefault = true,
                    DonViTinh = "Lần",
                }).ToListAsync();

            await Task.WhenAll(queryDichVuKhamBenh, queryDichVuKyThuat, queryDichVuGiuong, queryDuocPham, queryVatTu, queryToaThuoc/*, queryGoiDichVu*/);
            var result = new List<ChiPhiKhamChuaBenhVo>();
            result.AddRange(queryDichVuKhamBenh.Result);
            result.AddRange(queryDichVuKyThuat.Result);
            result.AddRange(queryDichVuGiuong.Result);
            result.AddRange(queryDuocPham.Result);
            result.AddRange(queryVatTu.Result);
            result.AddRange(queryToaThuoc.Result);
            result.AddRange(queryGoiDichVu.Result);
            return result;
        }

        #endregion

        public bool kiemTraTheVoucher(string maVoucher)
        {
            return _theVoucher.TableNoTracking.Where(cc => cc.Ma == maVoucher).Any();
        }
        public Camino.Core.Domain.Entities.Vouchers.Voucher getThongTinVoucher(long voucherId)
        {
            var vocuher = _voucherRepository.TableNoTracking.Where(cc => cc.Id == voucherId).FirstOrDefault();
            return vocuher;
        }

        private decimal LamTronSoTienTienCanTamUngTheoChiPhi(decimal chiPhi)
        {
            var n = 1;
            while (100000 * n <= chiPhi)
            {
                n++;
            }
            return 100000 * n;
        }

        public async Task<SoTienTamUngVo> SoTienTamUng(long idYeuCauTiepNhan)
        {
            var khoaPhongs = await _khoaPhongRepository.TableNoTracking.ToListAsync();

            var ycTiepNhan = BaseRepository.GetById(idYeuCauTiepNhan,
                x => x.Include(o => o.YeuCauKhamBenhs).ThenInclude(yck => yck.DichVuKhamBenhBenhVien).ThenInclude(yck => yck.DichVuKhamBenhBenhVienNoiThucHiens)
                    .Include(o => o.YeuCauDichVuKyThuats).ThenInclude(yckt => yckt.DichVuKyThuatBenhVien).ThenInclude(yckt => yckt.DichVuKyThuatBenhVienNoiThucHiens)
                    .Include(o => o.YeuCauDuocPhamBenhViens).Include(o => o.YeuCauDichVuGiuongBenhViens)
                    .Include(o => o.DonThuocThanhToans)
                    .Include(o => o.BenhNhan).ThenInclude(o => o.TaiKhoanBenhNhan));

            if (ycTiepNhan.BenhNhan == null)
                return new SoTienTamUngVo { SoTienTamUng = 0, SoTienTamUngToiThieu = 0 };

            var khoaPhongKhams = ycTiepNhan.YeuCauKhamBenhs
                .Where(o => o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan).SelectMany(o => o.DichVuKhamBenhBenhVien.DichVuKhamBenhBenhVienNoiThucHiens)
                .Where(o => o.KhoaPhongId != null).Select(o => o.KhoaPhongId).ToList();
            var khoaPhongKt = ycTiepNhan.YeuCauDichVuKyThuats
                .Where(o => o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan).SelectMany(o => o.DichVuKyThuatBenhVien.DichVuKyThuatBenhVienNoiThucHiens)
                .Where(o => o.KhoaPhongId != null).Select(o => o.KhoaPhongId).ToList();

            var soTienTamUng = khoaPhongs.Where(o => khoaPhongKhams.Contains(o.Id) || khoaPhongKt.Contains(o.Id)).Sum(o => o.SoTienThuTamUng.GetValueOrDefault());

            var chiphi = GetDanhSachChiPhiKhamChuaBenhChuaThu(idYeuCauTiepNhan);
            chiphi.ForEach(o => o.SoTienMG = o.DanhSachMienGiamVos?.Sum(mg => mg.SoTien) ?? 0);
            var tienBNPhaiTT = chiphi.Sum(o => o.BNConPhaiThanhToan);
            var soTienDaTamUng = await GetSoTienDaTamUngAsync(idYeuCauTiepNhan);

            if (soTienDaTamUng > 0)
            {
                if (soTienDaTamUng < tienBNPhaiTT)
                    return new SoTienTamUngVo { SoTienTamUng = LamTronSoTienTienCanTamUngTheoChiPhi(tienBNPhaiTT - soTienDaTamUng), SoTienTamUngToiThieu = Math.Floor(tienBNPhaiTT - soTienDaTamUng) };
                else
                    return new SoTienTamUngVo { SoTienTamUng = 0, SoTienTamUngToiThieu = 0 };
            }
            else
            {
                if (soTienTamUng > tienBNPhaiTT)
                    return new SoTienTamUngVo { SoTienTamUng = soTienTamUng, SoTienTamUngToiThieu = Math.Floor(tienBNPhaiTT) };
                else
                    return new SoTienTamUngVo { SoTienTamUng = LamTronSoTienTienCanTamUngTheoChiPhi(tienBNPhaiTT), SoTienTamUngToiThieu = Math.Floor(tienBNPhaiTT) };
            }
        }

        public async Task<(long, string)> ThuNo(BenhNhanTraLaiTien benhNhanTraLaiTienVo)
        {
            var ycTiepNhan = BaseRepository.GetById(benhNhanTraLaiTienVo.Id,
                x => x.Include(o => o.BenhNhan).ThenInclude(o => o.TaiKhoanBenhNhan));

            if (ycTiepNhan.BenhNhan == null)
                return (0, "Không có người bệnh");

            var tongThu = benhNhanTraLaiTienVo.TienMat.GetValueOrDefault() +
                          benhNhanTraLaiTienVo.ChuyenKhoan.GetValueOrDefault() +
                          benhNhanTraLaiTienVo.Pos.GetValueOrDefault();


            if (tongThu < 0)
                return (0, "Số tiền thanh toán không hợp lệ");

            var tk = ycTiepNhan.BenhNhan.TaiKhoanBenhNhan ?? new TaiKhoanBenhNhan
            {
                BenhNhan = ycTiepNhan.BenhNhan
            };

            var thuPhi = new TaiKhoanBenhNhanThu
            {
                TaiKhoanBenhNhan = tk,
                LoaiThuTienBenhNhan = Enums.LoaiThuTienBenhNhan.ThuNo,
                LoaiNoiThu = Enums.LoaiNoiThu.ThuNgan,
                TienMat = benhNhanTraLaiTienVo.TienMat,
                ChuyenKhoan = benhNhanTraLaiTienVo.ChuyenKhoan,
                POS = benhNhanTraLaiTienVo.Pos,
                NoiDungThu = benhNhanTraLaiTienVo.NoiDungBenhNhanDuaTien,
                NgayThu = benhNhanTraLaiTienVo.NgayTraTien,
                SoQuyen = 1,
                NhanVienThucHienId = _userAgentHelper.GetCurrentUserId(),
                NoiThucHienId = _userAgentHelper.GetCurrentNoiLLamViecId()
            };

            if (tk.SoDuTaiKhoan.SoTienTuongDuong(-1 * tongThu))
            {
                tk.SoDuTaiKhoan = 0;
            }
            else
            {
                tk.SoDuTaiKhoan += tongThu;
            }
            ycTiepNhan.TaiKhoanBenhNhanThus.Add(thuPhi);
            //await BaseRepository.UpdateAsync(ycTiepNhan);
            BaseRepository.Context.SaveChanges();
            return (thuPhi.Id, string.Empty);
        }

        public async Task<(long, string)> TraTienBenhNhan(ChiTienLaiBenhNhanVo thuPhiTamUnghVo)
        {
            var ycTiepNhan = BaseRepository.GetById(thuPhiTamUnghVo.Id,
                x => x.Include(o => o.BenhNhan).ThenInclude(o => o.TaiKhoanBenhNhan));
            if (ycTiepNhan.BenhNhan == null || ycTiepNhan.BenhNhan.TaiKhoanBenhNhan == null)
                return (0, "Không có tài khoản người bệnh");
            var soDuTk = Math.Round(ycTiepNhan.BenhNhan.TaiKhoanBenhNhan.SoDuTaiKhoan, MidpointRounding.AwayFromZero);
            if ((thuPhiTamUnghVo.ChuyenKhoan.GetValueOrDefault() + thuPhiTamUnghVo.TienMat.GetValueOrDefault()) > soDuTk)
                return (0, "Số tiền thanh toán không hợp lệ");

            var chiTra = new TaiKhoanBenhNhanChi
            {
                LoaiChiTienBenhNhan = Enums.LoaiChiTienBenhNhan.TraLaiBenhNhan,
                TienMat = thuPhiTamUnghVo.TienMat,
                ChuyenKhoan = thuPhiTamUnghVo.ChuyenKhoan,
                NoiDungChi = thuPhiTamUnghVo.NoiDungChiTien,
                NgayChi = DateTime.Now,
                SoQuyen = 1,
                YeuCauTiepNhanId = ycTiepNhan.Id,
                NhanVienThucHienId = _userAgentHelper.GetCurrentUserId(),
                NoiThucHienId = _userAgentHelper.GetCurrentNoiLLamViecId()
            };
            if (soDuTk.SoTienTuongDuong(thuPhiTamUnghVo.ChuyenKhoan.GetValueOrDefault() + thuPhiTamUnghVo.TienMat.GetValueOrDefault()))
            {
                ycTiepNhan.BenhNhan.TaiKhoanBenhNhan.SoDuTaiKhoan = 0;
            }
            else
            {
                ycTiepNhan.BenhNhan.TaiKhoanBenhNhan.SoDuTaiKhoan -= thuPhiTamUnghVo.ChuyenKhoan.GetValueOrDefault() + thuPhiTamUnghVo.TienMat.GetValueOrDefault();
            }
            ycTiepNhan.BenhNhan.TaiKhoanBenhNhan.TaiKhoanBenhNhanChis.Add(chiTra);
            //await BaseRepository.UpdateAsync(ycTiepNhan);
            BaseRepository.Context.SaveChanges();
            return (chiTra.Id, string.Empty);
        }

        public async Task<bool> IsTrungLoaiVoucher(long[] vouchers)
        {
            bool voucherI = false;
            bool voucherII = false;

            foreach (var voucherId in vouchers)
            {
                //TODO: need update MiemGiam
                //var loaiVoucher = await _theVoucher.TableNoTracking.Include(p => p.Voucher)
                //    .Where(w => w.Id == voucherId).Select(p => p.Voucher.LoaiVoucher).FirstOrDefaultAsync();

                //if (loaiVoucher == Enums.LoaiVoucher.DungMotLan)
                //{
                //    voucherI = true;
                //}

                //if (loaiVoucher == Enums.LoaiVoucher.DungNhieuLan)
                //{
                //    voucherII = true;
                //}

                //if (voucherI && voucherII)
                //{
                //    return false; //fail
                //}
            }

            return true; //pass
        }

        public KetQuaCLS GetThuNganByMaBNVaMaTT(TimKiemThongTinBenhNhan TimKiemThongTinBenhNhan)
        {
            KetQuaCLS ketQuaCLS = new KetQuaCLS();
            var queryTheoDanhSach = BaseRepository.TableNoTracking.Where(cc =>
                  cc.TrangThaiYeuCauTiepNhan == Enums.EnumTrangThaiYeuCauTiepNhan.DangThucHien && (cc.LoaiYeuCauTiepNhan == Enums.EnumLoaiYeuCauTiepNhan.KhamChuaBenhNgoaiTru || cc.LoaiYeuCauTiepNhan == Enums.EnumLoaiYeuCauTiepNhan.DangKyGoiMarketing) &&
                  (cc.YeuCauKhamBenhs.Any(o =>
                       o.YeuCauGoiDichVuId == null && o.GoiKhamSucKhoeId == null && o.TrangThai != Enums.EnumTrangThaiYeuCauKhamBenh.HuyKham)
                   || cc.YeuCauDichVuKyThuats.Any(o =>
                       o.YeuCauGoiDichVuId == null && o.GoiKhamSucKhoeId == null && o.TrangThai != Enums.EnumTrangThaiYeuCauDichVuKyThuat.DaHuy)
                   || cc.YeuCauDichVuGiuongBenhViens.Any(o =>
                       o.YeuCauGoiDichVuId == null && o.TrangThai != Enums.EnumTrangThaiGiuongBenh.DaHuy)
                   || cc.YeuCauDuocPhamBenhViens.Any(o =>
                       o.YeuCauGoiDichVuId == null && o.TrangThai != Enums.EnumYeuCauDuocPhamBenhVien.DaHuy)
                   || cc.YeuCauVatTuBenhViens.Any(o =>
                       o.YeuCauGoiDichVuId == null && o.TrangThai != Enums.EnumYeuCauVatTuBenhVien.DaHuy)
                   || cc.BenhNhan.YeuCauGoiDichVus.Any(o => o.TrangThai != Enums.EnumTrangThaiYeuCauGoiDichVu.DaHuy)
                   || cc.DonThuocThanhToans.Any(o => o.LoaiDonThuoc == Enums.EnumLoaiDonThuoc.ThuocBHYT && o.TrangThai != Enums.TrangThaiDonThuocThanhToan.DaHuy))).Include(cc => cc.BenhNhan);

            ketQuaCLS = queryTheoDanhSach.Where(cc => cc.MaYeuCauTiepNhan.Contains(TimKiemThongTinBenhNhan.TimKiemMaBNVaMaTN) || cc.BenhNhan.MaBN.ToString().Contains(TimKiemThongTinBenhNhan.TimKiemMaBNVaMaTN))
               .Select(s => new KetQuaCLS
               {

                   Id = s.Id,
                   Type = s.YeuCauKhamBenhs.Any(o => o.YeuCauGoiDichVuId == null && o.GoiKhamSucKhoeId == null && (o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan || o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                            || s.YeuCauDichVuKyThuats.Any(o => o.YeuCauGoiDichVuId == null && o.GoiKhamSucKhoeId == null && (o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan || o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                            || s.YeuCauDichVuGiuongBenhViens.Any(o => o.YeuCauGoiDichVuId == null && (o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan || o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                            || s.YeuCauDuocPhamBenhViens.Any(o => o.YeuCauGoiDichVuId == null && (o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan || o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                            || s.YeuCauVatTuBenhViens.Any(o => o.YeuCauGoiDichVuId == null && (o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan || o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
                            || s.BenhNhan.YeuCauGoiDichVus.Any(o => o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan || o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan)
                            || s.DonThuocThanhToans.Any(o => o.LoaiDonThuoc == Enums.EnumLoaiDonThuoc.ThuocBHYT && (o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan || o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.BaoLanhThanhToan || o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.CapNhatThanhToan))
               }).FirstOrDefault();

            return ketQuaCLS;
        }

        #region Kiểm tra yêu khám bệnh có cái nào nhập viện chưa

        public async Task<bool> KiemTraYeuCauNhapVien(long yeuCauTiepNhanId)
        {
            var ycTiepNhan = BaseRepository.GetById(yeuCauTiepNhanId,
                     x => x.Include(o => o.YeuCauKhamBenhs).ThenInclude(g => g.YeuCauNhapViens).ThenInclude(g => g.YeuCauTiepNhans));
            foreach (var yeuCauKhamBenh in ycTiepNhan.YeuCauKhamBenhs)
            {
                if (yeuCauKhamBenh.YeuCauNhapViens.Any(o => !o.YeuCauTiepNhans.Any()))
                {
                    return true;
                }
            }
            return false;
        }
        public long? KiemTraSuDungGoi(long yeuCauTiepNhanId)
        {
            var ycGoiDichVu = _yeuCauGoiDichVuRepository.TableNoTracking.FirstOrDefault(o => o.YeuCauKhamBenhs.Any(yc => yc.YeuCauTiepNhanId == yeuCauTiepNhanId && yc.TrangThai != Enums.EnumTrangThaiYeuCauKhamBenh.HuyKham)
                || o.YeuCauDichVuKyThuats.Any(yc => yc.YeuCauTiepNhanId == yeuCauTiepNhanId && yc.TrangThai != Enums.EnumTrangThaiYeuCauDichVuKyThuat.DaHuy));

            return ycGoiDichVu?.BenhNhanId;
        }

        public async Task<bool> ChuyenVaoNoiTru(long yeuCauTiepNhanId)
        {
            var ycTiepNhan = BaseRepository.GetById(yeuCauTiepNhanId, x => x.Include(o => o.YeuCauTiepNhanCongTyBaoHiemTuNhans).Include(o => o.YeuCauDichVuKyThuats).Include(o => o.YeuCauKhamBenhs).ThenInclude(g => g.YeuCauNhapViens).ThenInclude(g => g.YeuCauTiepNhans));
            if (ycTiepNhan.QuyetToanTheoNoiTru == true)
                return false;
            foreach (var yeuCauKhamBenh in ycTiepNhan.YeuCauKhamBenhs)
            {
                var yeuCauNhapVien = yeuCauKhamBenh.YeuCauNhapViens.FirstOrDefault(o => !o.YeuCauTiepNhans.Any());
                if (yeuCauNhapVien != null)
                {
                    var yeuCauTiepNhanNoiTru = GetYeuCauTiepNhanNoiTru(ycTiepNhan, yeuCauNhapVien);
                    yeuCauTiepNhanNoiTru.YeuCauTiepNhanNgoaiTruCanQuyetToanId = ycTiepNhan.Id;
                    ycTiepNhan.QuyetToanTheoNoiTru = true;

                    //bao lanh cho di lam dv
                    foreach (var yeuCauKhamBenhCanBaoLanh in ycTiepNhan.YeuCauKhamBenhs.Where(o => o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan))
                    {
                        yeuCauKhamBenhCanBaoLanh.TrangThaiThanhToan = Enums.TrangThaiThanhToan.BaoLanhThanhToan;
                        if (yeuCauKhamBenhCanBaoLanh.NoiDangKyId != null)
                        {
                            yeuCauKhamBenhCanBaoLanh.PhongBenhVienHangDois.Add(XepVaoHangDoi(ycTiepNhan, yeuCauKhamBenhCanBaoLanh.NoiDangKyId.Value));
                        }
                    }
                    foreach (var yeuCauDichVuKyThuatCanBaoLanh in ycTiepNhan.YeuCauDichVuKyThuats.Where(o => o.TrangThaiThanhToan == Enums.TrangThaiThanhToan.ChuaThanhToan))
                    {
                        yeuCauDichVuKyThuatCanBaoLanh.TrangThaiThanhToan = Enums.TrangThaiThanhToan.BaoLanhThanhToan;
                        if (yeuCauDichVuKyThuatCanBaoLanh.NoiThucHienId != null)
                        {
                            yeuCauDichVuKyThuatCanBaoLanh.PhongBenhVienHangDois.Add(XepVaoHangDoi(ycTiepNhan, yeuCauDichVuKyThuatCanBaoLanh.NoiThucHienId.Value));
                        }
                    }

                    await BaseRepository.AddAsync(yeuCauTiepNhanNoiTru);
                    return true;
                }
            }
            return false;
        }

        #endregion

        public bool KiemTraNgoaiTruCoDieuTriNoiTru(long yeuCauTiepNhanId)
        {
            return BaseRepository.TableNoTracking.Any(o => o.YeuCauTiepNhanNgoaiTruCanQuyetToanId == yeuCauTiepNhanId && o.NoiTruBenhAn != null);
        }
    }
}